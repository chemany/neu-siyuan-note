# æ€æºç¬”è®°åŸç”Ÿè®¾ç½®é¡µé¢é›†æˆç»Ÿä¸€æ³¨å†ŒæœåŠ¡ - å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. ä¿®æ”¹äº†æ€æºç¬”è®°åŸç”Ÿè´¦æˆ·è®¾ç½®é¡µé¢

**æ–‡ä»¶**: `/home/jason/code/siyuan/app/src/config/account.ts`

**ä¸»è¦ä¿®æ”¹**:

1. **æ·»åŠ äº†`getCookie`è¾…åŠ©å‡½æ•°** (ç¬¬16-26è¡Œ)
   - ç”¨äºä»Cookieä¸­è¯»å–token

2. **ä¿®æ”¹äº†`genHTML`å‡½æ•°** (ç¬¬84-169è¡Œ)
   - æ£€æµ‹Webæ¨¡å¼ä¸‹çš„JWT token (localStorageæˆ–Cookie)
   - å¦‚æœå­˜åœ¨Web token,æ˜¾ç¤ºç»Ÿä¸€æ³¨å†ŒæœåŠ¡çš„è´¦æˆ·ä¿¡æ¯
   - åŒ…å«ç”¨æˆ·åã€é‚®ç®±ã€å·¥ä½œç©ºé—´è·¯å¾„ã€è®¤è¯æ–¹å¼ç­‰ä¿¡æ¯
   - ä¿ç•™äº†åŸæœ‰æ€æºäº‘æœåŠ¡çš„æ˜¾ç¤ºé€»è¾‘ä½œä¸ºåå¤‡

3. **ä¿®æ”¹äº†`bindEvent`å‡½æ•°** (ç¬¬343-391è¡Œ)
   - æ·»åŠ äº†Webæ¨¡å¼ç™»å‡ºæŒ‰é’®(`#logoutWeb`)çš„äº‹ä»¶å¤„ç†
   - æ·»åŠ äº†Webæ¨¡å¼åˆ·æ–°æŒ‰é’®(`#refreshWebProfile`)çš„äº‹ä»¶å¤„ç†
   - ç™»å‡ºæ—¶æ¸…é™¤tokenå¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢

### 2. è´¦æˆ·é¡µé¢æ˜¾ç¤ºå†…å®¹

å½“ç”¨æˆ·é€šè¿‡ç»Ÿä¸€æ³¨å†ŒæœåŠ¡ç™»å½•å,åœ¨æ€æºç¬”è®°è®¾ç½®ä¸­ç‚¹å‡»"è´¦æˆ·"é€‰é¡¹,å°†çœ‹åˆ°:

#### è´¦æˆ·ä¿¡æ¯åŒºåŸŸ:
- **å¤´åƒ**: æ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯(ç´«è‰²æ¸å˜èƒŒæ™¯)
- **ç”¨æˆ·å**: æ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·å
- **æ ‡è¯†**: "ç»Ÿä¸€æ³¨å†ŒæœåŠ¡"
- **åˆ·æ–°ä¿¡æ¯æŒ‰é’®**: ä»æœåŠ¡å™¨é‡æ–°è·å–æœ€æ–°è´¦æˆ·ä¿¡æ¯
- **é€€å‡ºç™»å½•æŒ‰é’®**: æ¸…é™¤æœ¬åœ°token,è¿”å›ç™»å½•é¡µ

#### è¯¦ç»†ä¿¡æ¯:
- **ç”¨æˆ·å**: å½“å‰ç”¨æˆ·çš„ç”¨æˆ·å
- **é‚®ç®±**: æ³¨å†Œé‚®ç®±
- **å·¥ä½œç©ºé—´**: æ˜¾ç¤ºNASå­˜å‚¨è·¯å¾„ (`/mnt/nas-sata12/MindOcean/user-data/notes/{username}`)
- **è®¤è¯æ–¹å¼**: æ˜¾ç¤º"ç»Ÿä¸€æ³¨å†ŒæœåŠ¡"å¾½ç« 

#### è¯´æ˜ä¿¡æ¯:
```
æ‚¨çš„è´¦æˆ·ç”±ç»Ÿä¸€æ³¨å†ŒæœåŠ¡ç®¡ç†ï¼Œå¯ä»¥åœ¨å¤šä¸ªåº”ç”¨ï¼ˆæ€æºç¬”è®°ã€æ™ºèƒ½æ—¥å†ç­‰ï¼‰ä¹‹é—´å…±äº«ã€‚
é€€å‡ºç™»å½•åï¼Œæ‚¨å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–è´¦æˆ·ç™»å½•ã€‚
```

### 3. å‰ç«¯ç¼–è¯‘å’Œéƒ¨ç½²

1. ç¼–è¯‘desktopç‰ˆæœ¬: `npm run build:desktop`
2. å¤åˆ¶åˆ°kernel: `cp -r /home/jason/code/siyuan/app/stage/build /home/jason/code/siyuan/kernel/stage/`

### 4. åˆ›å»ºäº†ä¾¿æ·è„šæœ¬

**é‡å¯è„šæœ¬**: `/home/jason/code/siyuan/restart-siyuan-web.sh`
- è‡ªåŠ¨åœæ­¢ç°æœ‰æœåŠ¡
- è®¾ç½®æ‰€æœ‰å¿…è¦çš„ç¯å¢ƒå˜é‡
- é‡æ–°å¯åŠ¨æœåŠ¡
- æ£€æŸ¥å¯åŠ¨çŠ¶æ€

ä½¿ç”¨æ–¹æ³•:
```bash
/home/jason/code/siyuan/restart-siyuan-web.sh
```

## ğŸ¯ ä½¿ç”¨æµç¨‹

### ç”¨æˆ·ç™»å½•å:
1. æ‰“å¼€æ€æºç¬”è®° (http://localhost:6806)
2. ç‚¹å‡»å³ä¸Šè§’è®¾ç½®å›¾æ ‡
3. ç‚¹å‡»å·¦ä¾§èœå•çš„"è´¦æˆ·"é€‰é¡¹
4. çœ‹åˆ°ç»Ÿä¸€æ³¨å†ŒæœåŠ¡çš„è´¦æˆ·ä¿¡æ¯é¡µé¢

### åŠŸèƒ½æµ‹è¯•:
- âœ… ç‚¹å‡»"åˆ·æ–°ä¿¡æ¯"æŒ‰é’®,é‡æ–°åŠ è½½è´¦æˆ·æ•°æ®
- âœ… ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®,æ¸…é™¤tokenå¹¶è¿”å›ç™»å½•é¡µ
- âœ… é‡æ–°ç™»å½•å,è´¦æˆ·ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

### åˆ‡æ¢è´¦æˆ·:
1. åœ¨è´¦æˆ·é¡µé¢ç‚¹å‡»"é€€å‡ºç™»å½•"
2. è·³è½¬åˆ°ç™»å½•é¡µé¢
3. ä½¿ç”¨å…¶ä»–è´¦æˆ·ç™»å½•
4. æŸ¥çœ‹æ–°è´¦æˆ·çš„ä¿¡æ¯

## ğŸ“Š æŠ€æœ¯å®ç°ç»†èŠ‚

### Tokenæ£€æµ‹é€»è¾‘:
```typescript
const webToken = localStorage.getItem('siyuan_token') || getCookie('siyuan_token');
if (webToken) {
    // æ˜¾ç¤ºç»Ÿä¸€æ³¨å†ŒæœåŠ¡UI
}
```

### ç”¨æˆ·æ•°æ®æ¥æº:
```typescript
const storedUser = localStorage.getItem('siyuan_user');
const webUserData = JSON.parse(storedUser);
```

### ç™»å‡ºAPIè°ƒç”¨:
```typescript
fetchPost("/api/web/auth/logout", {}, () => {
    localStorage.removeItem('siyuan_token');
    localStorage.removeItem('siyuan_user');
    document.cookie = 'siyuan_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    window.location.href = '/stage/login.html';
});
```

### åˆ·æ–°APIè°ƒç”¨:
```typescript
fetchPost("/api/web/auth/profile", {}, (response) => {
    if (response.code === 0 && response.data) {
        localStorage.setItem('siyuan_user', JSON.stringify(response.data));
        // é‡æ–°æ¸²æŸ“é¡µé¢
    }
});
```

## ğŸ”„ ä¸åŸæœ‰åŠŸèƒ½çš„å…¼å®¹æ€§

- âœ… ä¿ç•™äº†æ€æºäº‘æœåŠ¡çš„è´¦æˆ·æ˜¾ç¤ºé€»è¾‘
- âœ… Webæ¨¡å¼å’Œä¼ ç»Ÿæ¨¡å¼å¯ä»¥å…±å­˜
- âœ… æœªç™»å½•æ—¶æ˜¾ç¤ºåŸæœ‰çš„ç™»å½•è¡¨å•
- âœ… æ€æºäº‘ç”¨æˆ·ä¸å—å½±å“

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‰ç«¯ä¿®æ”¹åéœ€è¦é‡æ–°ç¼–è¯‘**: æ¯æ¬¡ä¿®æ”¹`account.ts`åéœ€è¦è¿è¡Œ`npm run build:desktop`
2. **å¤åˆ¶æ„å»ºæ–‡ä»¶**: ç¼–è¯‘åéœ€è¦å¤åˆ¶åˆ°`kernel/stage/build`
3. **é‡å¯æœåŠ¡**: ä½¿ç”¨`restart-siyuan-web.sh`é‡å¯æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹
4. **æ¸…é™¤ç¼“å­˜**: æµè§ˆå™¨å¯èƒ½éœ€è¦æ¸…é™¤ç¼“å­˜æˆ–ç¡¬åˆ·æ–° (Ctrl+Shift+R)

## ğŸ‰ å®ŒæˆçŠ¶æ€

âœ… **ç›®æ ‡å·²è¾¾æˆ**: æ€æºç¬”è®°åŸç”Ÿè®¾ç½®é¡µé¢çš„"è´¦æˆ·"éƒ¨åˆ†å·²æˆåŠŸæ˜¾ç¤ºç»Ÿä¸€æ³¨å†ŒæœåŠ¡çš„è´¦æˆ·ä¿¡æ¯!

---

**ä¸‹æ¬¡å¯åŠ¨æœåŠ¡**:
```bash
/home/jason/code/siyuan/restart-siyuan-web.sh
```

**è®¿é—®åœ°å€**: http://localhost:6806

**æŸ¥çœ‹æ—¥å¿—**: `tail -f /tmp/siyuan.log`
