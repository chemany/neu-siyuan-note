(()=>{var rD=Object.defineProperty,cD=Object.defineProperties;var dD=Object.getOwnPropertyDescriptors;var zS=Object.getOwnPropertySymbols;var uD=Object.prototype.hasOwnProperty,fD=Object.prototype.propertyIsEnumerable;var GS=Math.pow,$y=(ut,tt,Ue)=>tt in ut?rD(ut,tt,{enumerable:!0,configurable:!0,writable:!0,value:Ue}):ut[tt]=Ue,aa=(ut,tt)=>{for(var Ue in tt||(tt={}))uD.call(tt,Ue)&&$y(ut,Ue,tt[Ue]);if(zS)for(var Ue of zS(tt))fD.call(tt,Ue)&&$y(ut,Ue,tt[Ue]);return ut},ml=(ut,tt)=>cD(ut,dD(tt));var bf=(ut,tt,Ue)=>($y(ut,typeof tt!="symbol"?tt+"":tt,Ue),Ue),My=(ut,tt,Ue)=>{if(!tt.has(ut))throw TypeError("Cannot "+Ue)};var x=(ut,tt,Ue)=>(My(ut,tt,"read from private field"),Ue?Ue.call(ut):tt.get(ut)),O=(ut,tt,Ue)=>{if(tt.has(ut))throw TypeError("Cannot add the same private member more than once");tt instanceof WeakSet?tt.add(ut):tt.set(ut,Ue)},z=(ut,tt,Ue,bl)=>(My(ut,tt,"write to private field"),bl?bl.call(ut,Ue):tt.set(ut,Ue),Ue);var Tm=(ut,tt,Ue,bl)=>({set _(vt){z(ut,tt,vt,Ue)},get _(){return x(ut,tt,bl)}}),H=(ut,tt,Ue)=>(My(ut,tt,"access private method"),Ue);var se=(ut,tt,Ue)=>new Promise((bl,vt)=>{var lt=fn=>{try{In(Ue.next(fn))}catch(Y){vt(Y)}},Ft=fn=>{try{In(Ue.throw(fn))}catch(Y){vt(Y)}},In=fn=>fn.done?bl(fn.value):Promise.resolve(fn.value).then(lt,Ft);In((Ue=Ue.apply(ut,tt)).next())});(()=>{var ut={119:vt=>{"use strict";vt.exports=window.pdfjsLib},353:function(vt){(function(lt,Ft){vt.exports=Ft()})(this,function(){"use strict";var lt=1e3,Ft=6e4,In=36e5,fn="millisecond",Y="second",re="minute",ie="hour",ue="day",Se="week",xe="month",ye="quarter",Ie="year",Ne="date",pn="Invalid Date",wn=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Lt=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Ja={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(Le){var j=["th","st","nd","rd"],U=Le%100;return"["+Le+(j[(U-20)%10]||j[U]||j[0])+"]"}},rn=function(Le,j,U){var T=String(Le);return!T||T.length>=j?Le:""+Array(j+1-T.length).join(U)+Le},Ma={s:rn,z:function(Le){var j=-Le.utcOffset(),U=Math.abs(j),T=Math.floor(U/60),B=U%60;return(j<=0?"+":"-")+rn(T,2,"0")+":"+rn(B,2,"0")},m:function Le(j,U){if(j.date()<U.date())return-Le(U,j);var T=12*(U.year()-j.year())+(U.month()-j.month()),B=j.clone().add(T,xe),G=U-B<0,je=j.clone().add(T+(G?-1:1),xe);return+(-(T+(U-B)/(G?B-je:je-B))||0)},a:function(Le){return Le<0?Math.ceil(Le)||0:Math.floor(Le)},p:function(Le){return{M:xe,y:Ie,w:Se,d:ue,D:Ne,h:ie,m:re,s:Y,ms:fn,Q:ye}[Le]||String(Le||"").toLowerCase().replace(/s$/,"")},u:function(Le){return Le===void 0}},Vi="en",Pa={};Pa[Vi]=Ja;var zt="$isDayjsObject",yl=function(Le){return Le instanceof He||!(!Le||!Le[zt])},P=function Le(j,U,T){var B;if(!j)return Vi;if(typeof j=="string"){var G=j.toLowerCase();Pa[G]&&(B=G),U&&(Pa[G]=U,B=G);var je=j.split("-");if(!B&&je.length>1)return Le(je[0])}else{var Qe=j.name;Pa[Qe]=j,B=Qe}return!T&&B&&(Vi=B),B||!T&&Vi},p=function(Le,j){if(yl(Le))return Le.clone();var U=typeof j=="object"?j:{};return U.date=Le,U.args=arguments,new He(U)},ee=Ma;ee.l=P,ee.i=yl,ee.w=function(Le,j){return p(Le,{locale:j.$L,utc:j.$u,x:j.$x,$offset:j.$offset})};var He=function(){function Le(U){this.$L=P(U.locale,null,!0),this.parse(U),this.$x=this.$x||U.x||{},this[zt]=!0}var j=Le.prototype;return j.parse=function(U){this.$d=function(T){var B=T.date,G=T.utc;if(B===null)return new Date(NaN);if(ee.u(B))return new Date;if(B instanceof Date)return new Date(B);if(typeof B=="string"&&!/Z$/i.test(B)){var je=B.match(wn);if(je){var Qe=je[2]-1||0,$t=(je[7]||"0").substring(0,3);return G?new Date(Date.UTC(je[1],Qe,je[3]||1,je[4]||0,je[5]||0,je[6]||0,$t)):new Date(je[1],Qe,je[3]||1,je[4]||0,je[5]||0,je[6]||0,$t)}}return new Date(B)}(U),this.init()},j.init=function(){var U=this.$d;this.$y=U.getFullYear(),this.$M=U.getMonth(),this.$D=U.getDate(),this.$W=U.getDay(),this.$H=U.getHours(),this.$m=U.getMinutes(),this.$s=U.getSeconds(),this.$ms=U.getMilliseconds()},j.$utils=function(){return ee},j.isValid=function(){return this.$d.toString()!==pn},j.isSame=function(U,T){var B=p(U);return this.startOf(T)<=B&&B<=this.endOf(T)},j.isAfter=function(U,T){return p(U)<this.startOf(T)},j.isBefore=function(U,T){return this.endOf(T)<p(U)},j.$g=function(U,T,B){return ee.u(U)?this[T]:this.set(B,U)},j.unix=function(){return Math.floor(this.valueOf()/1e3)},j.valueOf=function(){return this.$d.getTime()},j.startOf=function(U,T){var B=this,G=!!ee.u(T)||T,je=ee.p(U),Qe=function(Et,Ge){var Na=ee.w(B.$u?Date.UTC(B.$y,Ge,Et):new Date(B.$y,Ge,Et),B);return G?Na:Na.endOf(ue)},$t=function(Et,Ge){return ee.w(B.toDate()[Et].apply(B.toDate("s"),(G?[0,0,0,0]:[23,59,59,999]).slice(Ge)),B)},Ut=this.$W,mt=this.$M,Ln=this.$D,fe="set"+(this.$u?"UTC":"");switch(je){case Ie:return G?Qe(1,0):Qe(31,11);case xe:return G?Qe(1,mt):Qe(0,mt+1);case Se:var An=this.$locale().weekStart||0,ys=(Ut<An?Ut+7:Ut)-An;return Qe(G?Ln-ys:Ln+(6-ys),mt);case ue:case Ne:return $t(fe+"Hours",0);case ie:return $t(fe+"Minutes",1);case re:return $t(fe+"Seconds",2);case Y:return $t(fe+"Milliseconds",3);default:return this.clone()}},j.endOf=function(U){return this.startOf(U,!1)},j.$set=function(U,T){var B,G=ee.p(U),je="set"+(this.$u?"UTC":""),Qe=(B={},B[ue]=je+"Date",B[Ne]=je+"Date",B[xe]=je+"Month",B[Ie]=je+"FullYear",B[ie]=je+"Hours",B[re]=je+"Minutes",B[Y]=je+"Seconds",B[fn]=je+"Milliseconds",B)[G],$t=G===ue?this.$D+(T-this.$W):T;if(G===xe||G===Ie){var Ut=this.clone().set(Ne,1);Ut.$d[Qe]($t),Ut.init(),this.$d=Ut.set(Ne,Math.min(this.$D,Ut.daysInMonth())).$d}else Qe&&this.$d[Qe]($t);return this.init(),this},j.set=function(U,T){return this.clone().$set(U,T)},j.get=function(U){return this[ee.p(U)]()},j.add=function(U,T){var B,G=this;U=Number(U);var je=ee.p(T),Qe=function(mt){var Ln=p(G);return ee.w(Ln.date(Ln.date()+Math.round(mt*U)),G)};if(je===xe)return this.set(xe,this.$M+U);if(je===Ie)return this.set(Ie,this.$y+U);if(je===ue)return Qe(1);if(je===Se)return Qe(7);var $t=(B={},B[re]=Ft,B[ie]=In,B[Y]=lt,B)[je]||1,Ut=this.$d.getTime()+U*$t;return ee.w(Ut,this)},j.subtract=function(U,T){return this.add(-1*U,T)},j.format=function(U){var T=this,B=this.$locale();if(!this.isValid())return B.invalidDate||pn;var G=U||"YYYY-MM-DDTHH:mm:ssZ",je=ee.z(this),Qe=this.$H,$t=this.$m,Ut=this.$M,mt=B.weekdays,Ln=B.months,fe=B.meridiem,An=function(Ge,Na,pt,_l){return Ge&&(Ge[Na]||Ge(T,G))||pt[Na].slice(0,_l)},ys=function(Ge){return ee.s(Qe%12||12,Ge,"0")},Et=fe||function(Ge,Na,pt){var _l=Ge<12?"AM":"PM";return pt?_l.toLowerCase():_l};return G.replace(Lt,function(Ge,Na){return Na||function(pt){switch(pt){case"YY":return String(T.$y).slice(-2);case"YYYY":return ee.s(T.$y,4,"0");case"M":return Ut+1;case"MM":return ee.s(Ut+1,2,"0");case"MMM":return An(B.monthsShort,Ut,Ln,3);case"MMMM":return An(Ln,Ut);case"D":return T.$D;case"DD":return ee.s(T.$D,2,"0");case"d":return String(T.$W);case"dd":return An(B.weekdaysMin,T.$W,mt,2);case"ddd":return An(B.weekdaysShort,T.$W,mt,3);case"dddd":return mt[T.$W];case"H":return String(Qe);case"HH":return ee.s(Qe,2,"0");case"h":return ys(1);case"hh":return ys(2);case"a":return Et(Qe,$t,!0);case"A":return Et(Qe,$t,!1);case"m":return String($t);case"mm":return ee.s($t,2,"0");case"s":return String(T.$s);case"ss":return ee.s(T.$s,2,"0");case"SSS":return ee.s(T.$ms,3,"0");case"Z":return je}return null}(Ge)||je.replace(":","")})},j.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},j.diff=function(U,T,B){var G,je=this,Qe=ee.p(T),$t=p(U),Ut=($t.utcOffset()-this.utcOffset())*Ft,mt=this-$t,Ln=function(){return ee.m(je,$t)};switch(Qe){case Ie:G=Ln()/12;break;case xe:G=Ln();break;case ye:G=Ln()/3;break;case Se:G=(mt-Ut)/6048e5;break;case ue:G=(mt-Ut)/864e5;break;case ie:G=mt/In;break;case re:G=mt/Ft;break;case Y:G=mt/lt;break;default:G=mt}return B?G:ee.a(G)},j.daysInMonth=function(){return this.endOf(xe).$D},j.$locale=function(){return Pa[this.$L]},j.locale=function(U,T){if(!U)return this.$L;var B=this.clone(),G=P(U,T,!0);return G&&(B.$L=G),B},j.clone=function(){return ee.w(this.$d,this)},j.toDate=function(){return new Date(this.valueOf())},j.toJSON=function(){return this.isValid()?this.toISOString():null},j.toISOString=function(){return this.$d.toISOString()},j.toString=function(){return this.$d.toUTCString()},Le}(),ot=He.prototype;return p.prototype=ot,[["$ms",fn],["$s",Y],["$m",re],["$H",ie],["$W",ue],["$M",xe],["$y",Ie],["$D",Ne]].forEach(function(Le){ot[Le[1]]=function(j){return this.$g(j,Le[0],Le[1])}}),p.extend=function(Le,j){return Le.$i||(Le(j,He,p),Le.$i=!0),p},p.locale=P,p.isDayjs=yl,p.unix=function(Le){return p(1e3*Le)},p.en=Pa[Vi],p.Ls=Pa,p.p={},p})},843:vt=>{function lt(Ft){return Promise.resolve().then(()=>{var In=new Error("Cannot find module '"+Ft+"'");throw In.code="MODULE_NOT_FOUND",In})}lt.keys=()=>[],lt.resolve=lt,lt.id=843,vt.exports=lt},922:function(vt,lt,Ft){var In;(function(fn){"use strict";function Y(P,p){var ee=(P&65535)+(p&65535),He=(P>>16)+(p>>16)+(ee>>16);return He<<16|ee&65535}function re(P,p){return P<<p|P>>>32-p}function ie(P,p,ee,He,ot,Le){return Y(re(Y(Y(p,P),Y(He,Le)),ot),ee)}function ue(P,p,ee,He,ot,Le,j){return ie(p&ee|~p&He,P,p,ot,Le,j)}function Se(P,p,ee,He,ot,Le,j){return ie(p&He|ee&~He,P,p,ot,Le,j)}function xe(P,p,ee,He,ot,Le,j){return ie(p^ee^He,P,p,ot,Le,j)}function ye(P,p,ee,He,ot,Le,j){return ie(ee^(p|~He),P,p,ot,Le,j)}function Ie(P,p){P[p>>5]|=128<<p%32,P[(p+64>>>9<<4)+14]=p;var ee,He,ot,Le,j,U=1732584193,T=-271733879,B=-1732584194,G=271733878;for(ee=0;ee<P.length;ee+=16)He=U,ot=T,Le=B,j=G,U=ue(U,T,B,G,P[ee],7,-680876936),G=ue(G,U,T,B,P[ee+1],12,-389564586),B=ue(B,G,U,T,P[ee+2],17,606105819),T=ue(T,B,G,U,P[ee+3],22,-1044525330),U=ue(U,T,B,G,P[ee+4],7,-176418897),G=ue(G,U,T,B,P[ee+5],12,1200080426),B=ue(B,G,U,T,P[ee+6],17,-1473231341),T=ue(T,B,G,U,P[ee+7],22,-45705983),U=ue(U,T,B,G,P[ee+8],7,1770035416),G=ue(G,U,T,B,P[ee+9],12,-1958414417),B=ue(B,G,U,T,P[ee+10],17,-42063),T=ue(T,B,G,U,P[ee+11],22,-1990404162),U=ue(U,T,B,G,P[ee+12],7,1804603682),G=ue(G,U,T,B,P[ee+13],12,-40341101),B=ue(B,G,U,T,P[ee+14],17,-1502002290),T=ue(T,B,G,U,P[ee+15],22,1236535329),U=Se(U,T,B,G,P[ee+1],5,-165796510),G=Se(G,U,T,B,P[ee+6],9,-1069501632),B=Se(B,G,U,T,P[ee+11],14,643717713),T=Se(T,B,G,U,P[ee],20,-373897302),U=Se(U,T,B,G,P[ee+5],5,-701558691),G=Se(G,U,T,B,P[ee+10],9,38016083),B=Se(B,G,U,T,P[ee+15],14,-660478335),T=Se(T,B,G,U,P[ee+4],20,-405537848),U=Se(U,T,B,G,P[ee+9],5,568446438),G=Se(G,U,T,B,P[ee+14],9,-1019803690),B=Se(B,G,U,T,P[ee+3],14,-187363961),T=Se(T,B,G,U,P[ee+8],20,1163531501),U=Se(U,T,B,G,P[ee+13],5,-1444681467),G=Se(G,U,T,B,P[ee+2],9,-51403784),B=Se(B,G,U,T,P[ee+7],14,1735328473),T=Se(T,B,G,U,P[ee+12],20,-1926607734),U=xe(U,T,B,G,P[ee+5],4,-378558),G=xe(G,U,T,B,P[ee+8],11,-2022574463),B=xe(B,G,U,T,P[ee+11],16,1839030562),T=xe(T,B,G,U,P[ee+14],23,-35309556),U=xe(U,T,B,G,P[ee+1],4,-1530992060),G=xe(G,U,T,B,P[ee+4],11,1272893353),B=xe(B,G,U,T,P[ee+7],16,-155497632),T=xe(T,B,G,U,P[ee+10],23,-1094730640),U=xe(U,T,B,G,P[ee+13],4,681279174),G=xe(G,U,T,B,P[ee],11,-358537222),B=xe(B,G,U,T,P[ee+3],16,-722521979),T=xe(T,B,G,U,P[ee+6],23,76029189),U=xe(U,T,B,G,P[ee+9],4,-640364487),G=xe(G,U,T,B,P[ee+12],11,-421815835),B=xe(B,G,U,T,P[ee+15],16,530742520),T=xe(T,B,G,U,P[ee+2],23,-995338651),U=ye(U,T,B,G,P[ee],6,-198630844),G=ye(G,U,T,B,P[ee+7],10,1126891415),B=ye(B,G,U,T,P[ee+14],15,-1416354905),T=ye(T,B,G,U,P[ee+5],21,-57434055),U=ye(U,T,B,G,P[ee+12],6,1700485571),G=ye(G,U,T,B,P[ee+3],10,-1894986606),B=ye(B,G,U,T,P[ee+10],15,-1051523),T=ye(T,B,G,U,P[ee+1],21,-2054922799),U=ye(U,T,B,G,P[ee+8],6,1873313359),G=ye(G,U,T,B,P[ee+15],10,-30611744),B=ye(B,G,U,T,P[ee+6],15,-1560198380),T=ye(T,B,G,U,P[ee+13],21,1309151649),U=ye(U,T,B,G,P[ee+4],6,-145523070),G=ye(G,U,T,B,P[ee+11],10,-1120210379),B=ye(B,G,U,T,P[ee+2],15,718787259),T=ye(T,B,G,U,P[ee+9],21,-343485551),U=Y(U,He),T=Y(T,ot),B=Y(B,Le),G=Y(G,j);return[U,T,B,G]}function Ne(P){var p,ee="",He=P.length*32;for(p=0;p<He;p+=8)ee+=String.fromCharCode(P[p>>5]>>>p%32&255);return ee}function pn(P){var p,ee=[];for(ee[(P.length>>2)-1]=void 0,p=0;p<ee.length;p+=1)ee[p]=0;var He=P.length*8;for(p=0;p<He;p+=8)ee[p>>5]|=(P.charCodeAt(p/8)&255)<<p%32;return ee}function wn(P){return Ne(Ie(pn(P),P.length*8))}function Lt(P,p){var ee,He=pn(P),ot=[],Le=[],j;for(ot[15]=Le[15]=void 0,He.length>16&&(He=Ie(He,P.length*8)),ee=0;ee<16;ee+=1)ot[ee]=He[ee]^909522486,Le[ee]=He[ee]^1549556828;return j=Ie(ot.concat(pn(p)),512+p.length*8),Ne(Ie(Le.concat(j),640))}function Ja(P){var p="0123456789abcdef",ee="",He,ot;for(ot=0;ot<P.length;ot+=1)He=P.charCodeAt(ot),ee+=p.charAt(He>>>4&15)+p.charAt(He&15);return ee}function rn(P){return unescape(encodeURIComponent(P))}function Ma(P){return wn(rn(P))}function Vi(P){return Ja(Ma(P))}function Pa(P,p){return Lt(rn(P),rn(p))}function zt(P,p){return Ja(Pa(P,p))}function yl(P,p,ee){return p?ee?Pa(p,P):zt(p,P):ee?Ma(P):Vi(P)}In=function(){return yl}.call(lt,Ft,lt,vt),In!==void 0&&(vt.exports=In)})(this)},975:vt=>{"use strict";function lt(Y){if(typeof Y!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(Y))}function Ft(Y,re){for(var ie="",ue=0,Se=-1,xe=0,ye,Ie=0;Ie<=Y.length;++Ie){if(Ie<Y.length)ye=Y.charCodeAt(Ie);else{if(ye===47)break;ye=47}if(ye===47){if(!(Se===Ie-1||xe===1))if(Se!==Ie-1&&xe===2){if(ie.length<2||ue!==2||ie.charCodeAt(ie.length-1)!==46||ie.charCodeAt(ie.length-2)!==46){if(ie.length>2){var Ne=ie.lastIndexOf("/");if(Ne!==ie.length-1){Ne===-1?(ie="",ue=0):(ie=ie.slice(0,Ne),ue=ie.length-1-ie.lastIndexOf("/")),Se=Ie,xe=0;continue}}else if(ie.length===2||ie.length===1){ie="",ue=0,Se=Ie,xe=0;continue}}re&&(ie.length>0?ie+="/..":ie="..",ue=2)}else ie.length>0?ie+="/"+Y.slice(Se+1,Ie):ie=Y.slice(Se+1,Ie),ue=Ie-Se-1;Se=Ie,xe=0}else ye===46&&xe!==-1?++xe:xe=-1}return ie}function In(Y,re){var ie=re.dir||re.root,ue=re.base||(re.name||"")+(re.ext||"");return ie?ie===re.root?ie+ue:ie+Y+ue:ue}var fn={resolve:function(){for(var re="",ie=!1,ue,Se=arguments.length-1;Se>=-1&&!ie;Se--){var xe;Se>=0?xe=arguments[Se]:(ue===void 0&&(ue=process.cwd()),xe=ue),lt(xe),xe.length!==0&&(re=xe+"/"+re,ie=xe.charCodeAt(0)===47)}return re=Ft(re,!ie),ie?re.length>0?"/"+re:"/":re.length>0?re:"."},normalize:function(re){if(lt(re),re.length===0)return".";var ie=re.charCodeAt(0)===47,ue=re.charCodeAt(re.length-1)===47;return re=Ft(re,!ie),re.length===0&&!ie&&(re="."),re.length>0&&ue&&(re+="/"),ie?"/"+re:re},isAbsolute:function(re){return lt(re),re.length>0&&re.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var re,ie=0;ie<arguments.length;++ie){var ue=arguments[ie];lt(ue),ue.length>0&&(re===void 0?re=ue:re+="/"+ue)}return re===void 0?".":fn.normalize(re)},relative:function(re,ie){if(lt(re),lt(ie),re===ie||(re=fn.resolve(re),ie=fn.resolve(ie),re===ie))return"";for(var ue=1;ue<re.length&&re.charCodeAt(ue)===47;++ue);for(var Se=re.length,xe=Se-ue,ye=1;ye<ie.length&&ie.charCodeAt(ye)===47;++ye);for(var Ie=ie.length,Ne=Ie-ye,pn=xe<Ne?xe:Ne,wn=-1,Lt=0;Lt<=pn;++Lt){if(Lt===pn){if(Ne>pn){if(ie.charCodeAt(ye+Lt)===47)return ie.slice(ye+Lt+1);if(Lt===0)return ie.slice(ye+Lt)}else xe>pn&&(re.charCodeAt(ue+Lt)===47?wn=Lt:Lt===0&&(wn=0));break}var Ja=re.charCodeAt(ue+Lt),rn=ie.charCodeAt(ye+Lt);if(Ja!==rn)break;Ja===47&&(wn=Lt)}var Ma="";for(Lt=ue+wn+1;Lt<=Se;++Lt)(Lt===Se||re.charCodeAt(Lt)===47)&&(Ma.length===0?Ma+="..":Ma+="/..");return Ma.length>0?Ma+ie.slice(ye+wn):(ye+=wn,ie.charCodeAt(ye)===47&&++ye,ie.slice(ye))},_makeLong:function(re){return re},dirname:function(re){if(lt(re),re.length===0)return".";for(var ie=re.charCodeAt(0),ue=ie===47,Se=-1,xe=!0,ye=re.length-1;ye>=1;--ye)if(ie=re.charCodeAt(ye),ie===47){if(!xe){Se=ye;break}}else xe=!1;return Se===-1?ue?"/":".":ue&&Se===1?"//":re.slice(0,Se)},basename:function(re,ie){if(ie!==void 0&&typeof ie!="string")throw new TypeError('"ext" argument must be a string');lt(re);var ue=0,Se=-1,xe=!0,ye;if(ie!==void 0&&ie.length>0&&ie.length<=re.length){if(ie.length===re.length&&ie===re)return"";var Ie=ie.length-1,Ne=-1;for(ye=re.length-1;ye>=0;--ye){var pn=re.charCodeAt(ye);if(pn===47){if(!xe){ue=ye+1;break}}else Ne===-1&&(xe=!1,Ne=ye+1),Ie>=0&&(pn===ie.charCodeAt(Ie)?--Ie===-1&&(Se=ye):(Ie=-1,Se=Ne))}return ue===Se?Se=Ne:Se===-1&&(Se=re.length),re.slice(ue,Se)}else{for(ye=re.length-1;ye>=0;--ye)if(re.charCodeAt(ye)===47){if(!xe){ue=ye+1;break}}else Se===-1&&(xe=!1,Se=ye+1);return Se===-1?"":re.slice(ue,Se)}},extname:function(re){lt(re);for(var ie=-1,ue=0,Se=-1,xe=!0,ye=0,Ie=re.length-1;Ie>=0;--Ie){var Ne=re.charCodeAt(Ie);if(Ne===47){if(!xe){ue=Ie+1;break}continue}Se===-1&&(xe=!1,Se=Ie+1),Ne===46?ie===-1?ie=Ie:ye!==1&&(ye=1):ie!==-1&&(ye=-1)}return ie===-1||Se===-1||ye===0||ye===1&&ie===Se-1&&ie===ue+1?"":re.slice(ie,Se)},format:function(re){if(re===null||typeof re!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof re);return In("/",re)},parse:function(re){lt(re);var ie={root:"",dir:"",base:"",ext:"",name:""};if(re.length===0)return ie;var ue=re.charCodeAt(0),Se=ue===47,xe;Se?(ie.root="/",xe=1):xe=0;for(var ye=-1,Ie=0,Ne=-1,pn=!0,wn=re.length-1,Lt=0;wn>=xe;--wn){if(ue=re.charCodeAt(wn),ue===47){if(!pn){Ie=wn+1;break}continue}Ne===-1&&(pn=!1,Ne=wn+1),ue===46?ye===-1?ye=wn:Lt!==1&&(Lt=1):ye!==-1&&(Lt=-1)}return ye===-1||Ne===-1||Lt===0||Lt===1&&ye===Ne-1&&ye===Ie+1?Ne!==-1&&(Ie===0&&Se?ie.base=ie.name=re.slice(1,Ne):ie.base=ie.name=re.slice(Ie,Ne)):(Ie===0&&Se?(ie.name=re.slice(1,ye),ie.base=re.slice(1,Ne)):(ie.name=re.slice(Ie,ye),ie.base=re.slice(Ie,Ne)),ie.ext=re.slice(ye,Ne)),Ie>0?ie.dir=re.slice(0,Ie-1):Se&&(ie.dir="/"),ie},sep:"/",delimiter:":",win32:null,posix:null};fn.posix=fn,vt.exports=fn}},tt={};function Ue(vt){var lt=tt[vt];if(lt!==void 0)return lt.exports;var Ft=tt[vt]={exports:{}};return ut[vt].call(Ft.exports,Ft,Ft.exports,Ue),Ft.exports}Ue.d=(vt,lt)=>{for(var Ft in lt)Ue.o(lt,Ft)&&!Ue.o(vt,Ft)&&Object.defineProperty(vt,Ft,{enumerable:!0,get:lt[Ft]})},Ue.o=(vt,lt)=>Object.prototype.hasOwnProperty.call(vt,lt),Ue.r=vt=>{typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(vt,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(vt,"__esModule",{value:!0})};var bl={};(()=>{"use strict";var Os,Jl,Bs,_r,Xl,Rs,ug,jS,wr,Sd,Ld,Ad,Ql,ls,xd,vr,Er,wa,pg,KS,gg,ZS,Cd,Td,yn,Dd,Id,Pi,$d,eo,to,Sr,qs,Ta,Md,Pd,Lr,Ar,Ya,xr,Cr,Nd,Fs,Da,Hd,un,no,os,Ho,Tr,Dm,ao,yf,mg,JS,Od,Py,za,Wi,hg,XS,Bd,Ny,bg,QS,yg,eL,Dr,Im,Rd,Hy,_g,tL,io,Ni,so,lo,Ir,Us,Ws,qd,oo,_f,Fd,Oy,Ud,By,Wd,Ry,Vs,dc,wg,nL,vg,aL,Vd,$r,Yd,zd,qy,Gd,Fy,Eg,iL,jd,Uy,Kd,Wy,Zd,Vy,ro,wf,kg,sL,Mr,Ys,Ga,rs,co,Xd,Qd,Yy,Sg,lL,eu,zy,Lg,oL,Ag,rL,xg,cL,Cg,dL,zs,Hi,Pr,$m,Tg,uL,ja,tu,Gy,uo,vf,nu,jy,Dg,fL,au,Ky,Ig,pL,Dn,Nr,fo,$g,gL,iu,Zy,su,Jy,Mg,mL,Pg,hL,lu,Xy,Ng,bL,Hg,yL,Hr,Mm,po,Ef,Gs,uc,Og,_L,ou,Qy,ru,e_,Or,Pm,Bg,wL,cu,t_,du,n_,go,kf,uu,Br,Rg,vL,js,hi,bs,Rr,Nm,qr,Hm,Ks,fc,Fr,Om,fu,a_,qg,EL,Fg,kL,pu,i_,Ug,SL,Wg,LL,gu,s_,Ur,Wn,Zs,Js,Vg,AL,mo,Sf,Yg,xL,zg,CL,Gg,TL,jg,DL,mu,l_,Kg,IL,ho,Lf,Zg,$L,Jg,ML,Xg,PL,Qg,NL,hu,o_,Oi,bo,bu,yo,_o,yu,na,cs,Wr,_n,Ka,em,HL,Vr,Bm,_u,r_,tm,OL,wo,Af,wu,vo,vu,Xs,Qs,pc,nm,BL,Eu,c_,am,RL,Yr,Rm,im,qL,ku,d_,zr,Su,u_,Lu,f_,Au,p_,xu,g_,sm,FL,ds,Oo,lm,UL,Cu,m_,Tu,h_,om,WL,rm,VL,cm,YL,Du,Iu,$u,Mu,Pu,Gr,Nu,el,Hu,b_,Bi,jr,bi,Kr,Zr,Jr,tl,Ou,y_,dm,zL,Bu,__,us,Za,fs,nl,Xr,qm,Ru,w_,al,qu,Fu,Eo,Ri,va,il,um,GL,fm,jL,pm,KL,ko,Uu,So,Wu,sl,ll,Vu,Yu,zu,Lo,ec,tc,gs,Ao,ol,rl,gc,nc,Fm,xo,xf,Gu,v_,ju,E_,Ku,k_,Zu,S_,Ju,L_,gm,ZL,mm,JL,Xu,A_,ms,Co,Qu,x_,cl,ef,tf,qi,Ia,To,nf,af,sf,lf,of,rf,dl,Do,Io,$o,ac,ul,ic,cf,sc,Mo,fl,lc,hm,XL,bm,QL,ym,eA,Po,Cf,oc,Um,_m,tA,df,C_,wm,nA,Fi,hl,uf,T_,vm,aA,Em,iA,km,sA,ff,D_,Sm,lA,rc,Wm,yi,cc,Vm,Lm,oA,Am,rA,pf,I_,gf,$_,pl,mf,M_,xm,cA,Cm,dA,hf,P_,No,Tf,YS;var vt={};Ue.r(vt),Ue.d(vt,{copyPlainText:()=>Yi,encodeBase64:()=>zm,exportByMobile:()=>O_,getEventName:()=>bc,getLocalStorage:()=>U_,getScreenWidth:()=>q_,getTextSiyuanFromTextHTML:()=>mc,isDisabledFeature:()=>fA,isHuawei:()=>Df,isIPad:()=>Ha,isIPhone:()=>If,isInAndroid:()=>ht,isInHarmony:()=>bt,isInIOS:()=>$n,isMac:()=>Mt,isNotCtrl:()=>et,isOnlyMeta:()=>Wt,isSafari:()=>B_,isWin11:()=>R_,isWindows:()=>F_,openByMobile:()=>nn,readClipboard:()=>hc,readText:()=>Bo,setStorageVal:()=>Ee,updateHotkeyAfterTip:()=>Pt,updateHotkeyTip:()=>pe,writeText:()=>Be});const lt=new Set(["docker","ios","android","harmony"]),Ft=new Set(["ios","android","harmony"]),In=()=>lt.has(window.siyuan.config.system.container),fn=()=>Ft.has(window.siyuan.config.system.container),Y=()=>!!document.getElementById("sidebar"),re=()=>In()?window.siyuan.config.system.container:window.siyuan.config.system.os,ie=()=>window.navigator.userAgent.startsWith("SiYuan/")?ue()?"desktop-window":"desktop":"browser-desktop",ue=()=>!document.getElementById("toolbar"),Se=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,xe=(t,e)=>t.length===e.length&&t.every(n=>e.includes(n)),ye=(t,e)=>Math.floor(Math.random()*(e-t+1))+t,Ie=(t,e=window.location.search)=>{const n=e.substring(e.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(t)},Ne=()=>!0,pn=t=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(t),wn=t=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(t),Lt=t=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(t),Ja=t=>Function(`"use strict";return (${t})`)(),rn=(t,e)=>{if(t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e))return!0;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if(!t||!e||typeof t!="object"&&typeof e!="object")return t===e;if(t.prototype!==e.prototype)return!1;const n=Object.keys(t);return n.length!==Object.keys(e).length?!1:n.every(a=>rn(t[a],e[a]))},Ma=t=>{if(!t)return"";const e=t.match(/^(.*) \((\d+)\)$/);return e?t=`${e[1]} (${parseInt(e[2])+1})`:t=`${t} (1)`,t},Vi="3.4.0",Pa="production",zt=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",yl=()=>{const t={};for(let e=1;e<=32;e++)t[e+111]="F"+e;return t},P=class{};P.SIYUAN_VERSION=Vi,P.NODE_ENV=Pa,P.SIYUAN_APPID=Math.random().toString(36).substring(8),P.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",P.PROTYLE_CDN="/stage/protyle",P.UPLOAD_ADDRESS="/upload",P.SERVICE_WORKER_PATH="/service-worker.js",P.SIYUAN_DROP_FILE="application/siyuan-file",P.SIYUAN_DROP_GUTTER="application/siyuan-gutter",P.SIYUAN_DROP_TAB="application/siyuan-tab",P.SIYUAN_DROP_EDITOR="application/siyuan-editor",P.SIYUAN_CMD="siyuan-cmd",P.SIYUAN_GET="siyuan-get",P.SIYUAN_EVENT="siyuan-event",P.SIYUAN_CONFIG_TRAY="siyuan-config-tray",P.SIYUAN_QUIT="siyuan-quit",P.SIYUAN_HOTKEY="siyuan-hotkey",P.SIYUAN_INIT="siyuan-init",P.SIYUAN_SEND_WINDOWS="siyuan-send-windows",P.SIYUAN_SAVE_CLOSE="siyuan-save-close",P.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",P.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",P.SIYUAN_OPEN_URL="siyuan-open-url",P.SIYUAN_OPEN_WINDOW="siyuan-open-window",P.SIYUAN_OPEN_FILE="siyuan-open-file",P.SIYUAN_EXPORT_PDF="siyuan-export-pdf",P.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",P.SIYUAN_CONTEXT_MENU="siyuan-context-menu",P.SIYUAN_SHOW_WINDOW="siyuan-show-window",P.SIYUAN_RELOAD_WINDOW="siyuan-reload-window",P.CUSTOM_SY_READONLY="custom-sy-readonly",P.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",P.CUSTOM_SY_AV_VIEW="custom-sy-av-view",P.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",P.CUSTOM_RIFF_DECKS="custom-riff-decks",P.SIZE_DATABASE_MAZ_SIZE=102400,P.SIZE_SCROLL_TB=24,P.SIZE_SCROLL_STEP=256,P.SIZE_LINK_TEXT_MAX=64,P.SIZE_TOOLBAR_HEIGHT=Y()?0:32,P.SIZE_GET_MAX=102400,P.SIZE_UNDO=64,P.SIZE_TITLE=512,P.SIZE_EDITOR_WIDTH=760,P.SIZE_ZOOM=[{zoom:.67,position:{x:0,y:2}},{zoom:.75,position:{x:1,y:4}},{zoom:.8,position:{x:2,y:4}},{zoom:.9,position:{x:5,y:6}},{zoom:1,position:{x:8,y:8}},{zoom:1.1,position:{x:12,y:9}},{zoom:1.25,position:{x:18,y:12}},{zoom:1.5,position:{x:27,y:16}},{zoom:1.75,position:{x:36,y:20}},{zoom:2,position:{x:45,y:23}},{zoom:2.5,position:{x:63,y:31}},{zoom:3,position:{x:80,y:39}}],P.CB_MOVE_NOLIST="cb-move-nolist",P.CB_MOUNT_REMOVE="cb-mount-remove",P.CB_GET_APPEND="cb-get-append",P.CB_GET_BEFORE="cb-get-before",P.CB_GET_UNCHANGEID="cb-get-unchangeid",P.CB_GET_HL="cb-get-hl",P.CB_GET_FOCUS="cb-get-focus",P.CB_GET_FOCUSFIRST="cb-get-focusfirst",P.CB_GET_SETID="cb-get-setid",P.CB_GET_OUTLINE="cb-get-outline",P.CB_GET_ALL="cb-get-all",P.CB_GET_BACKLINK="cb-get-backlink",P.CB_GET_UNUNDO="cb-get-unundo",P.CB_GET_SCROLL="cb-get-scroll",P.CB_GET_CONTEXT="cb-get-context",P.CB_GET_ROOTSCROLL="cb-get-rootscroll",P.CB_GET_HTML="cb-get-html",P.CB_GET_HISTORY="cb-get-history",P.CB_GET_OPENNEW="cb-get-opennew",P.LOCAL_ZOOM="local-zoom",P.LOCAL_SEARCHDATA="local-searchdata",P.LOCAL_SEARCHKEYS="local-searchkeys",P.LOCAL_SEARCHASSET="local-searchasset",P.LOCAL_SEARCHUNREF="local-searchunref",P.LOCAL_DOCINFO="local-docinfo",P.LOCAL_DAILYNOTEID="local-dailynoteid",P.LOCAL_HISTORY="local-history",P.LOCAL_CODELANG="local-codelang",P.LOCAL_FONTSTYLES="local-fontstyles",P.LOCAL_EXPORTPDF="local-exportpdf",P.LOCAL_EXPORTWORD="local-exportword",P.LOCAL_EXPORTIMG="local-exportimg",P.LOCAL_BAZAAR="local-bazaar",P.LOCAL_PDFTHEME="local-pdftheme",P.LOCAL_LAYOUTS="local-layouts",P.LOCAL_AI="local-ai",P.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",P.LOCAL_FLASHCARD="local-flashcard",P.LOCAL_FILEPOSITION="local-fileposition",P.LOCAL_FILESPATHS="local-filespaths",P.LOCAL_DIALOGPOSITION="local-dialogposition",P.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",P.LOCAL_OUTLINE="local-outline",P.LOCAL_PLUGIN_DOCKS="local-plugin-docks",P.LOCAL_IMAGES="local-images",P.LOCAL_EMOJIS="local-emojis",P.LOCAL_MOVE_PATH="local-move-path",P.LOCAL_RECENT_DOCS="local-recent-docs",P.DIALOG_CONFIRM="dialog-confirm",P.DIALOG_OPENCARD="dialog-opencard",P.DIALOG_MAKECARD="dialog-makecard",P.DIALOG_VIEWCARDS="dialog-viewcards",P.DIALOG_DIALYNOTE="dialog-dialynote",P.DIALOG_RECENTDOCS="dialog-recentdocs",P.DIALOG_SWITCHTAB="dialog-switchtab",P.DIALOG_SEARCH="dialog-search",P.DIALOG_REPLACE="dialog-replace",P.DIALOG_GLOBALSEARCH="dialog-globalsearch",P.DIALOG_HISTORYCOMPARE="dialog-historycompare",P.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",P.DIALOG_AICUSTOMACTION="dialog-aicustomaction",P.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",P.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",P.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",P.DIALOG_CHANGELOG="dialog-changelog",P.DIALOG_COMMANDPANEL="dialog-commandpanel",P.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",P.DIALOG_EMOJIS="dialog-emojis",P.DIALOG_EXPORTIMAGE="dialog-exportimage",P.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",P.DIALOG_EXPORTWORD="dialog-exportword",P.DIALOG_HISTORY="dialog-history",P.DIALOG_HISTORYDOC="dialog-historydoc",P.DIALOG_MOVEPATHTO="dialog-movepathto",P.DIALOG_RENAME="dialog-rename",P.DIALOG_RENAMEASSETS="dialog-renameassets",P.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",P.DIALOG_RENAMETAG="dialog-renametag",P.DIALOG_REPLACETYPE="dialog-replacetype",P.DIALOG_SAVECRITERION="dialog-savecriterion",P.DIALOG_SEARCHTYPE="dialog-searchtype",P.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",P.DIALOG_SETTING="dialog-setting",P.DIALOG_SNAPSHOTTAG="dialog-snapshottag",P.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",P.DIALOG_SNIPPETS="dialog-snippets",P.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",P.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",P.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",P.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",P.DIALOG_WECHATREMINDER="dialog-wechatreminder",P.DIALOG_PASSWORD="dialog-password",P.DIALOG_SETPASSWORD="dialog-setpassword",P.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",P.DIALOG_KERNELFAULT="dialog-kernelfault",P.DIALOG_STATEEXCEPTED="dialog-stateexcepted",P.DIALOG_ATTR="dialog-attr",P.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",P.DIALOG_CREATENOTEBOOK="dialog-createnotebook",P.DIALOG_NOTEBOOKCONF="dialog-notebookconf",P.DIALOG_CREATEWORKSPACE="dialog-createworkspace",P.DIALOG_OPENWORKSPACE="dialog-openworkspace",P.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",P.MENU_BAR_WORKSPACE="barWorkspace",P.MENU_BAR_PLUGIN="topBarPlugin",P.MENU_BAR_ZOOM="barZoom",P.MENU_BAR_MODE="barmode",P.MENU_BAR_MORE="barmore",P.MENU_STATUS_HELP="statusHelp",P.MENU_STATUS_BACKGROUND_TASK="statusBackgroundTask",P.MENU_DOCK_MOBILE="dockMobileMenu",P.MENU_BLOCK_SINGLE="block-single",P.MENU_BLOCK_MULTI="block-multi",P.MENU_TITLE="titleMenu",P.MENU_FROM_TITLE_PROTYLE="title-protyle",P.MENU_FROM_TITLE_BREADCRUMB="title-breadcrumb",P.MENU_BREADCRUMB_MORE="breadcrumbMore",P.MENU_BREADCRUMB_MOBILE_PATH="breadcrumb-mobile-path",P.MENU_DOC_TREE_MORE="docTreeMore",P.MENU_FROM_DOC_TREE_MORE_NOTEBOOK="tree-notebook",P.MENU_FROM_DOC_TREE_MORE_DOC="tree-doc",P.MENU_FROM_DOC_TREE_MORE_ITEMS="tree-items",P.MENU_TAG="tagMenu",P.MENU_BOOKMARK="bookmarkMenu",P.MENU_OUTLINE_CONTEXT="outline-context",P.MENU_OUTLINE_EXPAND_LEVEL="outline-expand-level",P.MENU_AV_VIEW="av-view",P.MENU_AV_HEADER_CELL="av-header-cell",P.MENU_AV_HEADER_ADD="av-header-add",P.MENU_AV_ADD_FILTER="av-add-filter",P.MENU_AV_ADD_SORT="av-add-sort",P.MENU_AV_COL_OPTION="av-col-option",P.MENU_AV_COL_FORMAT_NUMBER="av-col-format-number",P.MENU_AV_GROUP_DATE="avGroupDate",P.MENU_AV_GROUP_SORT="avGroupSort",P.MENU_AV_ASSET_EDIT="av-asset-edit",P.MENU_AV_CALC="av-calc",P.MENU_AV_PAGE_SIZE="av-page-size",P.MENU_SEARCH_MORE="searchMore",P.MENU_SEARCH_METHOD="searchMethod",P.MENU_SEARCH_ASSET_MORE="searchAssetMore",P.MENU_SEARCH_ASSET_METHOD="searchAssetMethod",P.MENU_SEARCH_UNREF_MORE="searchUnRefMore",P.MENU_SEARCH_HISTORY="search-history",P.MENU_SEARCH_REPLACE_HISTORY="search-replace-history",P.MENU_SEARCH_ASSET_HISTORY="search-asset-history",P.MENU_MOVE_PATH_HISTORY="move-path-history",P.MENU_BACKGROUND_ASSET="background-asset",P.MENU_AI="ai",P.MENU_TAB="tab",P.MENU_TAB_LIST="tabList",P.MENU_INLINE_CONTEXT="inline-context",P.MENU_INLINE_IMG="inline-img",P.MENU_INLINE_FILE_ANNOTATION_REF="inline-file-annotation-ref",P.MENU_INLINE_REF="inline-block-ref",P.MENU_INLINE_A="inline-a",P.MENU_INLINE_TAG="inline-tag",P.MENU_INLINE_MATH="inline-math",P.TIMEOUT_OPENDIALOG=50,P.TIMEOUT_DBLCLICK=190,P.TIMEOUT_INPUT=256,P.TIMEOUT_LOAD=300,P.TIMEOUT_TRANSITION=300,P.TIMEOUT_COUNT=1e3,P.HELP_PATH={ar_SA:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",en_US:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",it_IT:"20210808180117-6v0mkxr",ja_JP:"20240530133126-axarxgx",pl_PL:"20210808180117-6v0mkxr",pt_BR:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",zh_CHT:"20211226090932-5lcq56f",zh_CN:"20210808180117-czj9bvb"},P.QUICK_DECK_ID="20230218211946-2kw8jgx",P.KEYCODELIST=Object.assign(yl(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),P.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:zt+"1",custom:zt+"1"},outline:{default:zt+"2",custom:zt+"2"},bookmark:{default:zt+"3",custom:zt+"3"},tag:{default:zt+"4",custom:zt+"4"},dailyNote:{default:zt+"5",custom:zt+"5"},inbox:{default:zt+"6",custom:zt+"6"},backlinks:{default:zt+"7",custom:zt+"7"},graphView:{default:zt+"8",custom:zt+"8"},globalGraph:{default:zt+"9",custom:zt+"9"},riffCard:{default:zt+"0",custom:zt+"0"},ai:{default:"",custom:""},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},recentClosed:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""},switchAdjust:{default:"",custom:""},rtl:{default:"",custom:""},ltr:{default:"",custom:""},aiWriting:{default:"",custom:""},openInNewTab:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"",custom:""},insertRowBelow:{default:"",custom:""},insertColumnLeft:{default:"",custom:""},insertColumnRight:{default:"",custom:""},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},P.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"},{type:"ai",size:{width:320,height:0},show:!0,icon:"iconSparkles",hotkeyLangId:"ai"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},P.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!0,aText:!0,aTitle:!0,aHref:!0,code:!0,em:!0,strong:!0,inlineMath:!0,inlineMemo:!0,blockRef:!0,fileAnnotationRef:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!0,mathBlock:!0,htmlBlock:!0},P.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,P.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],P.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac",".flac"],P.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],P.SIYUAN_ASSETS_EXTS=[".pdf"].concat(P.SIYUAN_ASSETS_IMAGE).concat(P.SIYUAN_ASSETS_AUDIO).concat(P.SIYUAN_ASSETS_VIDEO),P.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub",".cs"],P.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","cybertopia-cherry","cybertopia-dimmer","cybertopia-icecap","cybertopia-saturated","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","rose-pine","rose-pine-moon","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],P.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","1c-light","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","rose-pine-dawn","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],P.ZWSP="\u200B",P.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],P.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],P.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},P.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],P.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],P.PROTYLE_TOOLBAR=Y()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"];let p=P;const ee=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(parseInt(t,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(t,10)/4).toString(16)),He=(t,e,n=!1)=>{let a=T(t,e,n),i=!1,s=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!s;)i=T(a.parentElement,e,n),i?a=i:s=!0;return a||!1},ot=(t,e)=>{let n=U(t,e),a=!1,i=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!i;)a=U(n.parentElement,e),a?n=a:i=!0;return n||!1},Le=(t,e,n,a=!1)=>{let i=j(t,e,n,a),s=!1,l=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!l;)s=j(i.parentElement,e,n,a),s?i=s:l=!0;return i||!1},j=(t,e,n,a=!1)=>{var i;if(!t||t.nodeType===9)return!1;t.nodeType===3&&(t=t.parentElement);let s=t,l=!1;for(;s&&!l&&(a?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((i=s.getAttribute(e))!=null&&i.split(" ").includes(n))||typeof n!="string"&&s.hasAttribute(e)?l=!0:s=s.parentElement;return l&&s},U=(t,e)=>{if(!t||t.nodeType===9)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===e?a=!0:n=n.parentElement;return a&&n},T=(t,e,n=!1)=>{var a;if(!t||t.nodeType===9)return!1;t.nodeType===3&&(t=t.parentElement);let i=t,s=!1;for(;i&&!s&&(n?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)(a=i.classList)!=null&&a.contains(e)?s=!0:i=i.parentElement;return s&&i},B=t=>{var e;const n=j(t,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((e=n.getAttribute("data-type"))!=null&&e.startsWith("Node"))?n:!1},G=t=>{const e=Le(t,"data-type","NodeBlockQueryEmbed");return e?e===t?!1:e:!1},je=t=>T(t,"av__gallery-cover")?T(t,"av"):!1,Qe=t=>{let e=t;for(;e;){if(e.previousElementSibling&&e.previousElementSibling.getAttribute("data-node-id"))return e.previousElementSibling;const n=B(e.parentElement);if(n)e=n;else return!1}},$t=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!G(n))return e=n,!0}),e||t},Ut=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).find(n=>{if(!G(n)&&!n.classList.contains("li")&&!n.classList.contains("sb"))return e=n,!0}),e||t},mt=t=>{let e=t;for(;e;){if(e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr"))return e.nextElementSibling;const n=B(e.parentElement);if(n)e=n;else return!1}return!1},Ln=t=>{let e=t;for(;e;)if(e.classList.contains("list")||e.classList.contains("li")||e.classList.contains("bq")||e.classList.contains("sb"))e=e.querySelector("[data-node-id]");else return e;return!1},fe=t=>{if(!t||t.getAttribute("contenteditable")==="true"&&!t.classList.contains("protyle-wysiwyg"))return t;const e=t.querySelector('[contenteditable="true"]');if(e&&!j(e,"data-type","NodeBlockQueryEmbed"))return e},An=t=>{if(t.classList.contains("sb")){let e=!1;return Array.from(t.querySelectorAll("[data-node-id]")).find(n=>{if(!An(n))return e=!0,!0}),!e}return["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(t.getAttribute("data-type"))||t.getAttribute("data-type")==="NodeCodeBlock"&&t.classList.contains("render-node")},ys=t=>{var e,n;let a=t;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let i=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(s=>{if(s.textContent.replace(p.ZWSP,"").replace(`
`,"")!=="")return i=!0,!0}),i||(e=a.previousElementSibling)!=null&&e.getAttribute("data-node-id")||(n=a.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;a=a.parentElement}return a},Et=t=>{if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)for(;t.parentElement&&!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=Et(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)for(;t.parentElement&&!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=Et(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)for(;t.parentElement&&!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=Et(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)for(;t.parentElement&&!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else{t=Et(t);break}return t},Ge=t=>{let e=t.nextSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.nextSibling;else return e;return!1},Na=t=>{if(t.endContainer.nodeType===3&&t.endContainer.textContent.length!==t.endOffset&&t.endContainer.textContent!==p.ZWSP&&t.endContainer.textContent!==`
`)return!1;let e=t.endContainer;for(t.endContainer.nodeType!==3&&(e=t.endContainer.childNodes[t.endOffset]);e;){if(Ge(e))return!1;if(e.parentElement.getAttribute("spellcheck"))return!0;e=e.parentElement}return!0},pt=t=>{let e=t.previousSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.previousSibling;else return e;return!1},_l=t=>{let e=t.nextElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.firstElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.nextElementSibling)e=e.parentElement;else{if(e.nextElementSibling.tagName==="LI")return e.nextElementSibling;if(e.nextElementSibling.tagName==="UL")return e.nextElementSibling.firstElementChild}return!1},H_=t=>{let e=t.previousElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.lastElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.previousElementSibling)e=e.parentElement;else{if(e.previousElementSibling.tagName==="LI")return e.previousElementSibling;if(e.previousElementSibling.tagName==="UL"){const n=e.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},uA=()=>{const t=document.getElementById("message");t.innerHTML='<div class="fn__flex-1"></div>',t.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(t);){if(n.classList.contains("b3-snackbar__close")){At(n.parentElement.getAttribute("data-id")),e.preventDefault();break}else{if(n.tagName==="A"||n.tagName==="BUTTON")break;if(n.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&At(n.getAttribute("data-id")),e.preventDefault(),e.stopPropagation();break}}n=n.parentElement}}),document.querySelectorAll("#tempMessage > div").forEach(e=>{de(e.innerHTML,parseInt(e.getAttribute("data-timeout")),e.getAttribute("data-type"),e.getAttribute("data-message-id")),e.remove()})},de=(t,e=6e3,n="info",a)=>{const i=document.getElementById("message").firstElementChild;if(!i){let c=document.getElementById("tempMessage");c||(document.body.insertAdjacentHTML("beforeend",`<div style="font-size: 14px;top: 22px;position: fixed;z-index: 100;right: 30px;line-height: 20px;word-break: break-word;display: flex;flex-direction: column;align-items: flex-end;" 
id="tempMessage"></div>`),c=document.getElementById("tempMessage")),c.insertAdjacentHTML("beforeend",`<div style="background: white;padding: 8px 16px;border-radius: 6px;margin-bottom: 16px;"  
data-timeout="${e}" 
data-type="${n}" 
data-message-id="${a||""}">${t}</div>`);return}const s=a||ee(),l=i.querySelector(`.b3-snackbar[data-id="${s}"]`),o=t+(n==="error"?" v"+p.SIYUAN_VERSION:"");if(l){if(window.clearTimeout(parseInt(l.getAttribute("data-timeoutid"))),l.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${o}</div>${e===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),e>0){const c=window.setTimeout(()=>{At(s)},e);l.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${o}</div>`;if(e===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(e!==-1){const c=window.setTimeout(()=>{At(s)},e);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},At=t=>{const e=document.getElementById("message").firstElementChild;if(e)if(t){const n=e.querySelector(`[data-id="${t}"]`);n&&(n.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(n.getAttribute("data-timeoutid"))),setTimeout(()=>{n.remove(),e.childElementCount===0&&(e.parentElement.classList.remove("b3-snackbars--show"),e.innerHTML="")},p.TIMEOUT_INPUT));let a=!1;Array.from(e.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?e.parentElement.classList.add("b3-snackbars--show"):e.parentElement.classList.remove("b3-snackbars--show")}else e.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{e.innerHTML=""},p.TIMEOUT_INPUT)};var Ym=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const zm=t=>{if(typeof Buffer!="undefined")return Buffer.from(t,"utf8").toString("base64");{const n=new TextEncoder().encode(t);let a="";const i=32768;for(let s=0;s<n.length;s+=i){const l=n.subarray(s,Math.min(s+i,n.length));a+=String.fromCharCode(...l)}return btoa(a)}},mc=t=>{const e=t.match(/<!--data-siyuan='([^']+)'-->/);let n="",a=t;if(e)try{if(typeof Buffer!="undefined")n=Buffer.from(e[1],"base64").toString("utf8");else{const i=new TextDecoder,s=Uint8Array.from(atob(e[1]),l=>l.charCodeAt(0));n=i.decode(s)}a=t.replace(/<!--data-siyuan='[^']+'-->/,"")}catch(i){console.log("Failed to decode siyuan data from HTML comment:",i)}return{textSiyuan:n,textHtml:a}},nn=t=>{if(t)if($n())if(t.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+"/assets/"+encodeURIComponent(t.replace("assets/","")));else if(t.startsWith("/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+t);else try{new URL(t),window.webkit.messageHandlers.openLink.postMessage(t)}catch(e){window.webkit.messageHandlers.openLink.postMessage("https://"+t)}else ht()?window.JSAndroid.openExternal(t):bt()?window.JSHarmony.openExternal(t):window.open(t)},O_=t=>{t&&($n()?nn(t):ht()?window.JSAndroid.exportByDefault(t):bt()?window.JSHarmony.exportByDefault(t):window.open(t))},Bo=()=>ht()?window.JSAndroid.readClipboard():bt()?window.JSHarmony.readClipboard():typeof navigator.clipboard=="undefined"?(alert(window.siyuan.languages.clipboardPermissionDenied),""):navigator.clipboard.readText().catch(()=>{alert(window.siyuan.languages.clipboardPermissionDenied)})||"",hc=()=>Ym(void 0,null,function*(){const t={textPlain:"",textHTML:"",siyuanHTML:""};if(ht()){t.textPlain=window.JSAndroid.readClipboard(),t.textHTML=window.JSAndroid.readHTMLClipboard();const e=mc(t.textHTML);return t.textHTML=e.textHtml,t.siyuanHTML=e.textSiyuan,t}if(bt()){t.textPlain=window.JSHarmony.readClipboard(),t.textHTML=window.JSHarmony.readHTMLClipboard();const e=mc(t.textHTML);return t.textHTML=e.textHtml,t.siyuanHTML=e.textSiyuan,t}if(typeof navigator.clipboard=="undefined")return alert(window.siyuan.languages.clipboardPermissionDenied),t;try{const e=yield navigator.clipboard.read().catch(()=>{alert(window.siyuan.languages.clipboardPermissionDenied)});if(!e)return t;for(const n of e){if(n.types.includes("text/html")){const a=yield n.getType("text/html");t.textHTML=yield a.text();const i=mc(t.textHTML);t.textHTML=i.textHtml,t.siyuanHTML=i.textSiyuan}if(n.types.includes("text/plain")){const a=yield n.getType("text/plain");t.textPlain=yield a.text()}if(n.types.includes("image/png")){const a=yield n.getType("image/png");t.files=[new File([a],"image.png",{type:"image/png",lastModified:Date.now()})]}}return t}catch(e){return t}}),Be=t=>{let e;getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0).cloneRange());try{if(ht()){window.JSAndroid.writeClipboard(t);return}if(bt()){window.JSHarmony.writeClipboard(t);return}if($n()){window.webkit.messageHandlers.setClipboard.postMessage(t);return}navigator.clipboard.writeText(t)}catch(n){if($n())window.webkit.messageHandlers.setClipboard.postMessage(t);else if(ht())window.JSAndroid.writeClipboard(t);else if(bt())window.JSHarmony.writeClipboard(t);else{const a=document.createElement("textarea");a.value=t,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),e&&ne(e)}}},Yi=t=>Ym(void 0,null,function*(){t=t.replace(new RegExp(p.ZWSP,"g"),""),yield Be(t)}),bc=()=>If()?"touchstart":"click",Wt=t=>Mt()?!!(t.metaKey&&!t.ctrlKey):!!(!t.metaKey&&t.ctrlKey),et=t=>!t.metaKey&&!t.ctrlKey,Df=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,fA=t=>{var e;return((e=window.siyuan.config.system.disabledFeatures)==null?void 0:e.indexOf(t))>-1},If=()=>navigator.userAgent.indexOf("iPhone")>-1,B_=()=>{const t=navigator.userAgent;return t.includes("Safari")&&!t.includes("Chrome")&&!t.includes("Chromium")},Ha=()=>navigator.userAgent.indexOf("iPad")>-1,Mt=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,R_=()=>Ym(void 0,null,function*(){if(!navigator.userAgentData||!navigator.userAgentData.getHighEntropyValues)return!1;const t=yield navigator.userAgentData.getHighEntropyValues(["platformVersion"]);return navigator.userAgentData.platform==="Windows"&&parseInt(t.platformVersion.split(".")[0])>=13}),q_=()=>ht()?window.JSAndroid.getScreenWidthPx():bt()?window.JSHarmony.getScreenWidthPx():window.outerWidth,F_=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,ht=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,$n=()=>{var t;return window.siyuan.config.system.container==="ios"&&((t=window.webkit)==null?void 0:t.messageHandlers)},bt=()=>window.siyuan.config.system.container==="harmony"&&window.JSHarmony,Pt=(t,e=" ")=>t?e+pe(t):"",pe=t=>{if(!t||Mt())return t;const e=[];(t.indexOf("\u2318")>-1||t.indexOf("\u2303")>-1)&&e.push("Ctrl"),t.indexOf("\u21E7")>-1&&e.push("Shift"),t.indexOf("\u2325")>-1&&e.push("Alt");const n=t.replace(/[]/g,"");return n&&e.push({"\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"}[n]||n),e.join("+")},U_=t=>{A("/api/storage/getLocalStorage",void 0,e=>{window.siyuan.storage=e.data;const n={};n[p.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},n[p.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},p.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[p.LOCAL_SEARCHASSET].types[a]=!0}),n[p.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[p.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[p.LOCAL_LAYOUTS]=[],n[p.LOCAL_AI]=[],n[p.LOCAL_PLUGIN_DOCKS]={},n[p.LOCAL_PLUGINTOPUNPIN]=[],n[p.LOCAL_OUTLINE]={keepCurrentExpand:!1},n[p.LOCAL_FILEPOSITION]={},n[p.LOCAL_DIALOGPOSITION]={},n[p.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all",sideWidth:"256px",sideDocWidth:"256px",sideDiffWidth:"256px"},n[p.LOCAL_FLASHCARD]={fullscreen:!1},n[p.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[p.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[p.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[p.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[p.LOCAL_DOCINFO]={id:""},n[p.LOCAL_IMAGES]={file:"1f4c4",note:"1f5c3",folder:"1f4d1"},n[p.LOCAL_EMOJIS]={currentTab:"emoji"},n[p.LOCAL_FONTSTYLES]=[],n[p.LOCAL_FILESPATHS]=[],n[p.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},n[p.LOCAL_ZOOM]=1,n[p.LOCAL_MOVE_PATH]={keys:[],k:""},n[p.LOCAL_RECENT_DOCS]={type:"viewedAt"},[p.LOCAL_EXPORTIMG,p.LOCAL_SEARCHKEYS,p.LOCAL_PDFTHEME,p.LOCAL_BAZAAR,p.LOCAL_EXPORTWORD,p.LOCAL_EXPORTPDF,p.LOCAL_DOCINFO,p.LOCAL_FONTSTYLES,p.LOCAL_SEARCHDATA,p.LOCAL_ZOOM,p.LOCAL_LAYOUTS,p.LOCAL_AI,p.LOCAL_PLUGINTOPUNPIN,p.LOCAL_SEARCHASSET,p.LOCAL_FLASHCARD,p.LOCAL_DIALOGPOSITION,p.LOCAL_SEARCHUNREF,p.LOCAL_HISTORY,p.LOCAL_OUTLINE,p.LOCAL_FILEPOSITION,p.LOCAL_FILESPATHS,p.LOCAL_IMAGES,p.LOCAL_PLUGIN_DOCKS,p.LOCAL_EMOJIS,p.LOCAL_MOVE_PATH,p.LOCAL_RECENT_DOCS].forEach(a=>{if(typeof e.data[a]=="string")try{const i=JSON.parse(e.data[a]);typeof i=="number"?window.siyuan.storage[a]=i:window.siyuan.storage[a]=Object.assign(n[a],i)}catch(i){window.siyuan.storage[a]=n[a]}else typeof e.data[a]=="undefined"&&(window.siyuan.storage[a]=n[a])}),(!window.siyuan.storage[p.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[p.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[p.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)),t()})},Ee=(t,e,n)=>{window.siyuan.config.readonly||window.siyuan.isPublish||A("/api/storage/setLocalStorageVal",{app:p.SIYUAN_APPID,key:t,val:e},()=>{n&&n()})},Gm=t=>{var e,n,a;if(t.cmd==="msg"){const i=de(t.msg,t.data.closeTimeout,t.code===0?"info":"error",t.data.id);return(e=document.querySelector("#message #addMicrosoftDefenderExclusion"))==null||e.addEventListener("click",s=>{s.target.innerHTML='<svg class="fn__rotate" style="margin-right: 0;"><use xlink:href="#iconRefresh"></use></svg>',A("/api/system/addMicrosoftDefenderExclusion",{},()=>{At(i)})},{once:!0}),(n=document.querySelector("#message #ignoreAddMicrosoftDefenderExclusion"))==null||n.addEventListener("click",()=>{At(i),A("/api/system/ignoreAddMicrosoftDefenderExclusion")},{once:!0}),!1}if(t.cmd==="cmsg")return At(t.data.id),!1;if(t.cmd==="cprogress"){const i=document.getElementById("progress");return i&&i.remove(),!1}return t.cmd==="reloadui"?((a=t.data)!=null&&a.resetScroll?(window.siyuan.storage[p.LOCAL_FILEPOSITION]={},Ee(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION],()=>{Un({cb(){window.location.reload()},errorExit:!1})})):Un({cb(){window.location.reload()},errorExit:!1}),!1):t.code<0?(de(t.msg,t.data&&t.data.closeTimeout||0,t.code===-1?"error":"info"),!1):t};class ia{constructor(e){this.app=e.app,e.msgCallback&&this.connect(e)}connect(e){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${p.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);a.onopen=()=>{e.callback&&e.callback.call(this),document.getElementById("errorLog")&&(ay(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},a.onmessage=i=>{if(e.msgCallback){const s=Gm(JSON.parse(i.data));e.msgCallback.call(this,s)}},a.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})},3e3))},a.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&Jk()},this.ws=a}send(e,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:n})))}}var pA=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const W_=(t,e)=>pA(void 0,null,function*(){if(document.getElementById(e))return!1;const n=new XMLHttpRequest;n.open("GET",t,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=e,document.head.appendChild(a),typeof Lute=="undefined"&&window.location.reload()}),jt=(t,e)=>new Promise(n=>{if(document.getElementById(e))return n(!1),!1;const a=document.createElement("script");a.src=t,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(e))return a.remove(),n(!1),!1;a.id=e,n(!0)}}),Te=(t,e,n,a=0,i=0)=>{t.style.top=n+"px",t.style.left=e+"px";const s=t.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<p.SIZE_TOOLBAR_HEIGHT){const l=n-s.height-a;l>p.SIZE_TOOLBAR_HEIGHT&&l+s.height<window.innerHeight?t.style.top=l+"px":l<=p.SIZE_TOOLBAR_HEIGHT?t.style.top=p.SIZE_TOOLBAR_HEIGHT+"px":t.style.top=Math.max(p.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?t.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(t.style.left="0")},ce=(t,e,n=!1)=>{if(!e){if(t.includes("dialog")){const a=window.siyuan.dialogs.length;for(let i=0;i<a;i++)window.siyuan.dialogs[i].destroy()}return}if(t.includes("hint")&&(clearTimeout(e.hint.timeId),e.hint.element.classList.add("fn__none")),e.gutter&&t.includes("gutter")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML="",e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),e.gutter&&t.includes("gutterOnly")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML=""),e.toolbar&&t.includes("toolbar")&&(e.toolbar.element.classList.add("fn__none"),e.toolbar.element.style.display=""),e.toolbar&&t.includes("util")){const a=e.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(e.toolbar.subElement.classList.add("fn__none"),e.toolbar.subElementCloseCB&&(e.toolbar.subElementCloseCB(),e.toolbar.subElementCloseCB=void 0))}t.includes("select")&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},_s=t=>{t.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(e=>{e.classList.add("fn__none"),e.style.display=""}),t.includes("util")&&qn().forEach(e=>{if(e.protyle.toolbar){const n=e.protyle.toolbar.subElement.querySelector('[data-type="pin"]');(!n||n&&n.getAttribute("aria-label")===window.siyuan.languages.pin)&&(e.protyle.toolbar.subElement.classList.add("fn__none"),e.protyle.toolbar.subElementCloseCB&&(e.protyle.toolbar.subElementCloseCB(),e.protyle.toolbar.subElementCloseCB=void 0))}}),t.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(e=>{e.classList.add("fn__none")}),t.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(e=>{e.classList.add("fn__none"),e.innerHTML=""})},jm=(t,e)=>{t.addEventListener("mousedown",n=>{if(T(n.target,"protyle-util")&&!t.classList.contains("protyle-util"))return;let a=T(n.target,"resize__move"),i,s;const l=t.getBoundingClientRect();if(a?(i=n.clientX-l.left,s=n.clientY-l.top):(i=n.clientX,s=n.clientY,a=T(n.target,"resize__rd")||T(n.target,"resize__r")||T(n.target,"resize__rt")||T(n.target,"resize__d")||T(n.target,"resize__l")||T(n.target,"resize__ld")||T(n.target,"resize__lt")||T(n.target,"resize__t")),!a)return;const o=t.clientHeight,r=t.clientWidth,c=a.className.split("resize__")[1].split(" ")[0],d=document;t.style.userSelect="none",t.classList.contains("b3-dialog__container")&&t.parentElement.style.display!=="block"&&(t.parentElement.style.display="block",t.style.left=l.left+"px",t.style.top=l.top+"px",t.style.width=l.width+"px"),d.ondragstart=()=>!1;let u=!1;d.onmousemove=m=>{if(u=!0,!!t)if(c==="move"){let f=m.clientX-i,g=m.clientY-s;f>window.innerWidth-r&&(f=window.innerWidth-r),g>window.innerHeight-o&&(g=window.innerHeight-o),t.style.left=Math.max(f,0)+"px",t.style.top=Math.max(g,p.SIZE_TOOLBAR_HEIGHT)+"px"}else c==="r"&&m.clientX-i+r>200&&m.clientX-i+r<window.innerWidth?(t.style.width=m.clientX-i+r+"px",t.style.maxWidth="none"):c==="d"&&m.clientY-s+o>160&&m.clientY-s+o<window.innerHeight-p.SIZE_TOOLBAR_HEIGHT?(t.style.height=m.clientY-s+o+"px",t.style.maxHeight=""):c==="t"&&m.clientY>p.SIZE_TOOLBAR_HEIGHT&&s-m.clientY+o>160?(t.style.top=m.clientY+"px",t.style.maxHeight="",t.style.height=s-m.clientY+o+"px"):c==="l"&&m.clientX>0&&i-m.clientX+r>200?(t.style.left=m.clientX+"px",t.style.width=i-m.clientX+r+"px",t.style.maxWidth="none"):c==="rd"&&m.clientX-i+r>200&&m.clientX-i+r<window.innerWidth&&m.clientY-s+o>160&&m.clientY-s+o<window.innerHeight-p.SIZE_TOOLBAR_HEIGHT?(t.style.height=m.clientY-s+o+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.width=m.clientX-i+r+"px"):c==="rt"&&m.clientX-i+r>200&&m.clientX-i+r<window.innerWidth&&m.clientY>p.SIZE_TOOLBAR_HEIGHT&&s-m.clientY+o>160?(t.style.width=m.clientX-i+r+"px",t.style.top=m.clientY+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.height=s-m.clientY+o+"px"):c==="lt"&&m.clientX>0&&i-m.clientX+r>200&&m.clientY>p.SIZE_TOOLBAR_HEIGHT&&s-m.clientY+o>160?(t.style.left=m.clientX+"px",t.style.width=i-m.clientX+r+"px",t.style.top=m.clientY+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.height=s-m.clientY+o+"px"):c==="ld"&&m.clientX>0&&i-m.clientX+r>200&&m.clientY-s+o>160&&m.clientY-s+o<window.innerHeight-p.SIZE_TOOLBAR_HEIGHT&&(t.style.left=m.clientX+"px",t.style.width=i-m.clientX+r+"px",t.style.height=m.clientY-s+o+"px",t.style.maxHeight="",t.style.maxWidth="none")},d.onmouseup=()=>{if(!t)return;window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0),t.style.userSelect="auto",d.onmousemove=null,d.onmouseup=null,d.ondragstart=null,d.onselectstart=null,d.onselect=null,_s(["gutter"]);const m=T(t,"b3-dialog--open");if(m){const f=m.dataset.key;f&&t.offsetWidth&&(window.siyuan.storage[p.LOCAL_DIALOGPOSITION][f]={width:t.offsetWidth,height:t.offsetHeight,left:parseInt(t.style.left),top:parseInt(t.style.top)},Ee(p.LOCAL_DIALOGPOSITION,window.siyuan.storage[p.LOCAL_DIALOGPOSITION]))}u&&e&&e(c)}})},$f=t=>{t.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){t.classList.remove("protyle-wysiwyg--hl")},1024)},yc=(t,e,n="nearest")=>{let a;const i=t.wysiwyg.element;if(!t.preview.element.classList.contains("fn__none")){a=document.getElementById(e),a&&(t.preview.element.scrollTop=a.offsetTop,$f(a));return}if(Array.from(i.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!G(s))return a=s,!0}),a)return Ye(t,a,n),$f(a),a;if(e===t.block.rootID&&t.options.render.title&&t.title.editElement)return $f(t.title.editElement),t.title.editElement},Ye=(t,e,n="nearest",a="auto")=>{var i,s,l,o,r,c;if(!t.disabled&&!e&&getSelection().rangeCount>0){const m=getSelection().getRangeAt(0),f=B(m.startContainer);if(f){if(f.classList.contains("code-block")){const E=document.createElement("br");m.insertNode(E),E.scrollIntoView({block:n,behavior:a}),E.remove();return}if(f.classList.contains("av")&&f.dataset.render==="true"){if(((s=(i=f.querySelector(".av__row--header"))==null?void 0:i.getAttribute("style"))==null?void 0:s.indexOf("transform"))>-1||((o=(l=f.querySelector(".av__row--footer"))==null?void 0:l.getAttribute("style"))==null?void 0:o.indexOf("transform"))>-1)return;const E=f.querySelector(".av__cell--select, .av__row--select, .av__gallery-item--select");E?E.scrollIntoView({block:n,behavior:a}):f.scrollIntoView({block:n,behavior:a});return}const g=m.cloneRange(),h=document.createElement("br");m.insertNode(h);const b=t.contentElement,y=h.getBoundingClientRect().top-b.getBoundingClientRect().top;let w=0;y<0?w=b.scrollTop+y:y>b.clientHeight-74&&(w=b.scrollTop+(y+74-b.clientHeight)),w!==0&&b.scroll({top:w,behavior:a}),h.remove(),ne(g);return}}if(!e&&((r=document.activeElement)==null?void 0:r.tagName)!=="TEXTAREA"&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&(e=B(ke(t.wysiwyg.element).startContainer)),!e)return;const d=e.getBoundingClientRect(),u=t.contentElement.getBoundingClientRect();if(n==="start"){t.contentElement.scroll({top:t.contentElement.scrollTop+d.top-u.top,behavior:a});return}if(n==="nearest"){d.top<u.top?t.contentElement.scroll({top:t.contentElement.scrollTop+d.top-u.top,behavior:a}):d.bottom>u.bottom&&t.contentElement.scroll({top:t.contentElement.scrollTop+d.bottom-u.bottom,behavior:a});return}n==="center"&&t.contentElement.scroll({top:t.contentElement.scrollTop+d.top-(u.top+u.height/2),behavior:a})};var Mf=Ue(975);class $e{constructor(e){this.disableClose=e.disableClose,this.id=ee(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div");let n,a;if(!Y()&&e.positionId){const i=window.siyuan.storage[p.LOCAL_DIALOGPOSITION][e.positionId];i&&i.left+i.width+34<=window.innerWidth&&i.top+i.height<=window.innerHeight&&(n=i.left+"px",a=i.top+"px",e.width=i.width+"px",e.height=i.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container ${e.containerClassName||""}" style="width:${e.width||"auto"};height:${e.height||"auto"};
left:${n||"auto"};top:${a||"auto"}">
  <svg ${Y()&&e.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||e.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>
  <div class="b3-dialog__body">${e.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",i=>{this.disableClose||this.destroy(),i.preventDefault(),i.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",i=>{this.destroy(),i.preventDefault(),i.stopPropagation()}),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")},p.TIMEOUT_OPENDIALOG),jm(this.element.querySelector(".b3-dialog__container"),e.resizeCallback)}destroy(e){this.element.classList.remove("b3-dialog--open"),setTimeout(()=>{var n;this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(e),window.siyuan.dialogs.find((a,i)=>{if(a.id===this.id)return window.siyuan.dialogs.splice(i,1),!0}),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")},p.TIMEOUT_DBLCLICK)}bindInput(e,n,a=!0){e.focus();let i;e.addEventListener("keydown",s=>{if(s.isComposing||s.repeat){s.preventDefault();return}if(s.key==="Escape"){this.destroy(),s.preventDefault(),s.stopPropagation();return}if(!s.shiftKey&&et(s)&&s.key==="Enter"&&n&&a){if(i&&s.timeStamp-i<124)return;i=s.timeStamp,n(),s.preventDefault(),s.stopPropagation()}})}}const he=t=>t&&t.replace(/&/g,"&amp;").replace(/</g,"&lt;"),_i=t=>t.replace(/</g,"&lt;"),at=t=>t&&t.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Zt=t=>t&&t.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;");var Q=Ue(353);const V_=()=>{const t=window.siyuan.emojis[ye(0,window.siyuan.emojis.length-1)];return typeof t.items[ye(0,t.items.length-1)]=="undefined"?"1f600":t.items[ye(0,t.items.length-1)].unicode},be=(t,e="",n=!1,a=!1)=>{if(!t)return"";let i="";if(t.startsWith("api/icon/getDynamicIcon"))i=`<img class="${e}" ${a?"data-":""}src="${t}"/>`;else if(t.indexOf(".")>-1)i=`<img class="${e}" ${a?"data-":""}src="/emojis/${t}"/>`;else try{t.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),n&&(i=`<span class="${e}">${i}</span>`)}catch(s){}return i},Pf=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(l=>{s+=`<button data-unicode="${l.unicode}" class="emojis__item ariaLabel" aria-label="${El(l)}">
${be(l.unicode)}</button>`}),a.target.innerHTML=s,a.target.removeAttribute("data-index"),a.target.style.minHeight=""}})});t.querySelectorAll(".emojis__content").forEach(n=>{e.observe(n)})},_c=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i&&(a.target.src=i,a.target.removeAttribute("data-src"))})});t.querySelectorAll("img").forEach(n=>{e.observe(n)})},wc=(t="",e)=>{let n="";const a=[];t&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const l=[];window.siyuan.emojis.forEach((r,c)=>{t||(n+=`<div class="emojis__title" data-type="${c+1}">${vn(c)}</div><div style="min-height:${c===0?"30px":"300px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!t&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(d=>{if(t){if(window.siyuan.config.editor.emoji.includes(d.unicode)&&(be(d.unicode)===t||d.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||d.description.toLowerCase().indexOf(t.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1||d.description_ja_jp.toLowerCase().indexOf(t.toLowerCase())>-1)&&a.push(d),e&&i>e)return;(be(d.unicode)===t||d.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||d.description.toLowerCase().indexOf(t.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1||d.description_ja_jp.toLowerCase().indexOf(t.toLowerCase())>-1)&&(r.id==="custom"?l.push(d):s+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${El(d)}">
${be(d.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(d.unicode)&&a.push(d),c<2&&(n+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${El(d)}">
${be(d.unicode,void 0,!1,!0)}</button>`)}),t||(n+="</div>")}),t&&(l.sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(t.toLowerCase())<u[u.length-1].toLowerCase().indexOf(t.toLowerCase())?-1:0}).sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(t.toLowerCase())===u[u.length-1].toLowerCase().indexOf(t.toLowerCase())&&d[d.length-1].length<u[u.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${El(r)}">
${be(r.unicode,void 0,!1,!0)}</button>`}),n=n+s+"</div>");let o="";return a.length>0&&(o=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=a.filter(d=>d.unicode===r);c[0]&&(o+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${El(c[0])}">
${be(c[0].unicode,void 0,!1,!0)}
</button>`)}),o+="</div>"),o+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:o+n},wl=t=>{window.siyuan.config.editor.emoji.unshift(t),window.siyuan.config.editor.emoji.length>p.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),A("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},Y_=(t,e)=>{const n={1:["Sun","\u5468\u65E5","\u9031\u65E5"],2:["SUN","\u5468\u5929","\u9031\u5929"],3:["Sunday","\u661F\u671F\u65E5","\u661F\u671F\u65E5"],4:["SUNDAY","\u661F\u671F\u5929","\u661F\u671F\u5929"]};let a=0;return t===""&&(t=window.siyuan.config.lang),t==="zh_CN"?a=1:t==="zh_CHT"&&(a=2),`<option value="1" ${e==="1"?" selected":""}>${n[1][a]}</option>
<option value="2" ${e==="2"?" selected":""}>${n[2][a]}</option>
<option value="3" ${e==="3"?" selected":""}>${n[3][a]}</option>
<option value="4" ${e==="4"?" selected":""}>${n[4][a]}</option>`},z_=(t,e)=>{if(!t)return;let n="";window.siyuan.emojis[parseInt(t)].items.forEach(a=>{n+=`<button data-unicode="${a.unicode}" class="emojis__item ariaLabel" aria-label="${El(a)}">${be(a.unicode)}</button>`}),e.innerHTML=n,e.removeAttribute("data-index"),e.removeAttribute("style")},Xa=(t,e,n,a,i)=>{e!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const s="api/icon/getDynamicIcon?",l={color:"#d23f31",lang:"",date:Q().format("YYYY-MM-DD"),weekdayType:"1",type:"1",content:"SiYuan"};if(i&&i.getAttribute("src").startsWith(s)){const b=new URLSearchParams(i.getAttribute("src").replace(s,""));l.color=b.get("color")||"#d23f31",l.color.startsWith("#")||(l.color="#"+l.color),l.lang=b.get("lang")||"",l.date=b.get("date")||"",l.weekdayType=b.get("weekdayType")||"1",l.type=b.get("type")||"1",l.content=b.get("content")||"SiYuan"}const o=new $e({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:Y()?"80vw":"368px",height:"50vh",content:`<div class="emojis">
    <div class="emojis__tabheader">
        <div data-type="tab-emoji" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.emoji}"><svg><use xlink:href="#iconEmoji"></use></svg></div>
        <div class="fn__space"></div>
        <div data-type="tab-dynamic" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicIcon}"><svg><use xlink:href="#iconCalendar"></use></svg></div>
        <div class="fn__flex-1"></div>
        <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="emojis__tabbody">
        <div class="fn__none" data-type="tab-emoji">
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
                    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                    <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
                </label>
                <span class="fn__space"></span>
                <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="emojis__panel">${wc()}</div>
            <div class="fn__flex">
                ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",vn(0)],["1f60d",vn(1)],["1f433",vn(2)],["1f96a",vn(3)],["1f3a8",vn(4)],["1f3dd-fe0f",vn(5)],["1f52e",vn(6)],["267e-fe0f",vn(7)],["1f6a9",vn(8)]].map(([b,y],w)=>`<div data-type="${w}" class="emojis__type ariaLabel" aria-label="${y}">${be(b)}</div>`).join("")}
            </div>
        </div>
        <div class="fn__none" data-type="tab-dynamic">
            <div class="fn__flex emoji__dynamic-color">
                <div class="color__square fn__pointer${l.color==="#d23f31"?" color__square--current":""}" style="background-color:#d23f31"></div>
                <div class="color__square fn__pointer${l.color==="#3575f0"?" color__square--current":""}" style="background-color:#3575f0"></div>
                <div class="color__square fn__pointer${l.color==="#f3a92f"?" color__square--current":""}" style="background-color:#f3a92f"></div>
                <div class="color__square fn__pointer${l.color==="#65b84d"?" color__square--current":""}" style="background-color:#65b84d"></div>
                <div class="color__square fn__pointer${l.color==="#e099ff"?" color__square--current":""}" style="background-color:#e099ff"></div>
                <div class="color__square fn__pointer${l.color==="#ea5d97"?" color__square--current":""}" style="background-color:#ea5d97"></div>
                <div class="color__square fn__pointer${l.color==="#93627f"?" color__square--current":""}" style="background-color:#93627f"></div>
                <div class="color__square fn__pointer${l.color==="#5f6368"?" color__square--current":""}" style="background-color:#5f6368"></div>
                <div class="fn__space--small"></div>
                <input type="text" class="b3-text-field fn__flex-1 fn__flex-center" value="${l.color}">
            </div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.language}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    <option value="" ${l.lang===""?" selected":""}>${window.siyuan.languages.themeOS}</option>
                    <option value="en_US" ${l.lang==="en_US"?" selected":""}>English (en_US)</option>
                    <option value="zh_CHT" ${l.lang==="zh_CHT"?" selected":""}>\u7E41\u9AD4\u4E2D\u6587 (zh_CHT)</option>
                    <option value="zh_CN" ${l.lang==="zh_CN"?" selected":""}>\u7B80\u4F53\u4E2D\u6587 (zh_CN)</option>
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.date}</span>
                <span class="fn__space--small"></span>
                <input type="date" max="9999-12-31" class="b3-text-field fn__flex-1" value="${l.date}"/>
                <span class="fn__space--small"></span>
                <span data-action="clearDate" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicIconDateEmptyInfo}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.format}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    ${Y_(l.lang,l.weekdayType)}
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__flex fn__flex-wrap">
                <img class="emoji__dynamic-item${l.type==="1"?" emoji__dynamic-item--current":""}" src="${s}type=1&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="2"?" emoji__dynamic-item--current":""}" src="${s}type=2&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="3"?" emoji__dynamic-item--current":""}" src="${s}type=3&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="4"?" emoji__dynamic-item--current":""}" src="${s}type=4&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="5"?" emoji__dynamic-item--current":""}" src="${s}type=5&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="6"?" emoji__dynamic-item--current":""}" src="${s}type=6&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
                <img class="emoji__dynamic-item${l.type==="7"?" emoji__dynamic-item--current":""}" src="${s}type=7&color=${encodeURIComponent(l.color)}&date=${l.date}&weekdayType=${l.weekdayType}&lang=${l.lang}">
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.custom}</span>
                <span class="fn__space--small"></span>
                <input type="text" class="b3-text-field fn__flex-1" value="">
                <span class="fn__space"></span>
            </div>
            <div>
                <img data-type="text" class="emoji__dynamic-item${l.type==="8"?" emoji__dynamic-item--current":""}" src="${s}type=8&color=${encodeURIComponent(l.color)}&content=${encodeURIComponent(l.content)}&id=${t}">
            </div>
        </div>
    </div>
</div>`});o.element.setAttribute("data-key",p.DIALOG_EMOJIS),o.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const r=o.element.querySelector(".b3-dialog");r.style.justifyContent="inherit",r.style.alignItems="inherit";const c=window.siyuan.storage[p.LOCAL_EMOJIS].currentTab;o.element.querySelector(`.emojis__tabheader [data-type="tab-${c}"]`).classList.add("block__icon--active"),o.element.querySelector(`.emojis__tabbody [data-type="tab-${c}"]`).classList.remove("fn__none"),Te(o.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),o.element.querySelector(".emojis__item").classList.add("emojis__item--current");const d=o.element.querySelector('[data-type="tab-emoji"] .b3-text-field'),u=o.element.querySelector(".emojis__panel");d.addEventListener("compositionend",()=>{var b;u.innerHTML=wc(d.value),d.value?u.nextElementSibling.classList.add("fn__none"):u.nextElementSibling.classList.remove("fn__none"),u.scrollTop=0,(b=o.element.querySelector(".emojis__item"))==null||b.classList.add("emojis__item--current"),d.value===""&&Pf(o.element),_c(o.element)}),d.addEventListener("input",b=>{var y;b.isComposing||(u.innerHTML=wc(d.value),d.value?u.nextElementSibling.classList.add("fn__none"):u.nextElementSibling.classList.remove("fn__none"),u.scrollTop=0,(y=o.element.querySelector(".emojis__item"))==null||y.classList.add("emojis__item--current"),d.value===""&&Pf(o.element),_c(o.element))}),d.addEventListener("keydown",b=>{var y,w,E,C;if(b.isComposing||b.key.indexOf("Arrow")===-1&&b.key!=="Enter")return;const $=o.element.querySelector(".emojis__item--current");if(!$)return;if(b.key==="Enter"){const k=$.getAttribute("data-unicode");e==="notebook"?A("/api/notebook/setNotebookIcon",{notebook:t,icon:k},()=>{o.destroy(),wl(k),vl(k,t,"iconFilesRoot")}):e==="doc"&&A("/api/attr/setBlockAttrs",{id:t,attrs:{icon:k}},()=>{o.destroy(),wl(k),vl(k,t),Nf(k,t)}),a&&a(k),b.preventDefault(),b.stopPropagation();return}let M;if(b.key==="ArrowLeft")$.previousElementSibling?($.classList.remove("emojis__item--current"),M=$.previousElementSibling,b.preventDefault(),b.stopPropagation()):(y=$.parentElement.previousElementSibling)!=null&&y.previousElementSibling&&($.classList.remove("emojis__item--current"),M=$.parentElement.previousElementSibling.previousElementSibling.lastElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowRight")$.nextElementSibling?($.classList.remove("emojis__item--current"),M=$.nextElementSibling,b.preventDefault(),b.stopPropagation()):(w=$.parentElement.nextElementSibling)!=null&&w.nextElementSibling&&($.classList.remove("emojis__item--current"),M=$.parentElement.nextElementSibling.nextElementSibling.firstElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowDown"){if($.nextElementSibling){$.classList.remove("emojis__item--current");let k=Math.floor($.parentElement.clientWidth/($.clientWidth+2));for(M=$;M.nextElementSibling&&k>0;)M=M.nextElementSibling,k--}else{const k=(E=$.parentElement.nextElementSibling)==null?void 0:E.nextElementSibling;k&&(M=k.firstElementChild,$.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}else if(b.key==="ArrowUp"){if($.previousElementSibling){$.classList.remove("emojis__item--current");let k=Math.floor($.parentElement.clientWidth/($.clientWidth+2));for(M=$;M.previousElementSibling&&k>0;)M=M.previousElementSibling,k--}else{const k=(C=$.parentElement.previousElementSibling)==null?void 0:C.previousElementSibling;k&&(M=k.lastElementChild,$.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}if(M){M.classList.add("emojis__item--current");const k=d.clientHeight+6;M.offsetTop-k<u.scrollTop?u.scrollTop=M.offsetTop-k-6:M.offsetTop-k-u.clientHeight+M.clientHeight>u.scrollTop&&(u.scrollTop=M.offsetTop-k-u.clientHeight+M.clientHeight)}}),!Y()&&c==="emoji"&&d.focus(),Pf(o.element),_c(o.element),o.element.addEventListener("click",b=>{var y,w;let E=b.target;for(;E&&E!==o.element;){if(E.classList.contains("emojis__type")){const C=u.querySelector(`[data-type="${E.getAttribute("data-type")}"]`);if(C){const $=C.nextElementSibling.getAttribute("data-index");$&&(z_((y=C.previousElementSibling)==null?void 0:y.getAttribute("data-index"),C.previousElementSibling),z_($,C.nextElementSibling)),u.scrollTo({top:C.offsetTop-77})}break}else if(E.getAttribute("data-action")==="remove"){e==="notebook"?A("/api/notebook/setNotebookIcon",{notebook:t,icon:""},()=>{o.destroy(),vl("",t,"iconFilesRoot")}):e==="doc"&&A("/api/attr/setBlockAttrs",{id:t,attrs:{icon:""}},()=>{o.destroy(),vl("",t),Nf("",t)}),a&&a("");break}else if(E.classList.contains("emojis__item")||E.getAttribute("data-action")==="random"||E.classList.contains("emoji__dynamic-item")){let C="";E.classList.contains("emojis__item")?(C=E.getAttribute("data-unicode"),o.destroy()):E.classList.contains("emoji__dynamic-item")?(C=E.getAttribute("src"),o.destroy()):C=V_(),e==="notebook"?A("/api/notebook/setNotebookIcon",{notebook:t,icon:C},()=>{wl(C),vl(C,t,"iconFilesRoot")}):e==="doc"&&A("/api/attr/setBlockAttrs",{id:t,attrs:{icon:C}},()=>{wl(C),vl(C,t),Nf(C,t)}),a&&a(C);break}else if((w=E.getAttribute("data-type"))!=null&&w.startsWith("tab-")){r.querySelectorAll('.emojis__tabheader [data-type|="tab"]').forEach(C=>{C.dataset.type===E.dataset.type?C.classList.add("block__icon--active"):C.classList.remove("block__icon--active")}),r.querySelectorAll(".emojis__tabbody > div").forEach(C=>{C.dataset.type===E.dataset.type?C.classList.remove("fn__none"):C.classList.add("fn__none")}),window.siyuan.storage[p.LOCAL_EMOJIS].currentTab=E.dataset.type.replace("tab-",""),Ee(p.LOCAL_EMOJIS,window.siyuan.storage[p.LOCAL_EMOJIS]);break}else if(E.classList.contains("color__square")){g[0].value=E.getAttribute("style").replace("background-color:",""),g[0].dispatchEvent(new CustomEvent("input"));break}else if(E.dataset.action==="clearDate"){f.value="",f.dispatchEvent(new CustomEvent("change"));break}E=E.parentElement}});const m=o.element.querySelectorAll('[data-type="tab-dynamic"] .b3-select');m[0].addEventListener("change",()=>{o.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));m[0].value?y.set("lang",m[0].value):y.delete("lang"),b.setAttribute("src",s+y.toString()),m[1].innerHTML=Y_(m[0].value,m[1].value)})}),m[1].addEventListener("change",()=>{o.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));y.set("weekdayType",m[1].value),b.setAttribute("src",s+y.toString())})});const f=o.element.querySelector('[data-type="tab-dynamic"] [type="date"]');f.addEventListener("change",()=>{o.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));y.set("date",f.value?Q(f.value).format("YYYY-MM-DD"):""),b.setAttribute("src",s+y.toString())})});const g=o.element.querySelectorAll('[data-type="tab-dynamic"] [type="text"]'),h=o.element.querySelector('.emoji__dynamic-item[data-type="text"]');g[0].addEventListener("input",()=>{g[0].value.startsWith("#")&&(o.element.querySelectorAll(".emoji__dynamic-item").forEach(b=>{const y=new URLSearchParams(b.getAttribute("src").replace(s,""));y.set("color",g[0].value),b.setAttribute("src",s+y.toString())}),o.element.querySelectorAll(".color__square").forEach(b=>{b.style.backgroundColor===g[0].value?b.classList.add("color__square--current"):b.classList.remove("color__square--current")}))}),g[1].value=l.content,g[1].addEventListener("input",()=>{const b=new URLSearchParams(h.getAttribute("src").replace(s,""));b.set("content",g[1].value),h.setAttribute("src",s+b.toString())})},Nf=(t,e)=>{Oe().outline.forEach(n=>{n.blockId===e&&(n.headerElement.nextElementSibling.firstElementChild.outerHTML=be(t||window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-list-item__graphic",!0))})},vl=(t,e,n="iconFile")=>{let a;const i=nt("file");if(i){const s=i.data.file;n==="iconFile"?a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`):a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`)||s.element.querySelector(`[data-url="${e}"] .b3-list-item__icon`)||s.closeElement.querySelector(`[data-url="${e}"] .b3-list-item__icon`)}a&&(a.innerHTML=be(t||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?window.siyuan.storage[p.LOCAL_IMAGES].file:window.siyuan.storage[p.LOCAL_IMAGES].folder:window.siyuan.storage[p.LOCAL_IMAGES].note))),n!=="iconFile"&&Gi()},El=t=>window.siyuan.config.lang==="zh_CN"?t.description_zh_cn:window.siyuan.config.lang==="ja_JP"?t.description_ja_jp:t.description,vn=t=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[t].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[t].title_ja_jp:window.siyuan.emojis[t].title,gA=t=>{if(window.siyuan.emojis[0].items.length>0){const e={};window.siyuan.emojis[0].items.forEach(n=>{e[n.keywords]=t.options.hint.emojiPath+"/"+n.unicode}),t.lute.PutEmojis(e)}},mA=()=>{A("/api/system/getEmojiConf",{},t=>{window.siyuan.emojis=t.data,qn().forEach(e=>{gA(e.protyle)})})},G_=(t,e)=>{if(t.includes("\u2303")){if(!e.ctrlKey)return!1}else if(Mt()?e.ctrlKey:t.includes("\u2318")?!e.ctrlKey:e.ctrlKey)return!1;if(t.includes("\u2325")){if(!e.altKey)return!1}else if(e.altKey)return!1;if(t.includes("\u21E7")){if(!e.shiftKey)return!1}else if(e.shiftKey)return!1;if(t.includes("\u2318")){if(Mt()?!e.metaKey:!e.ctrlKey)return!1}else if(Mt()?e.metaKey:t.includes("\u2303")?!e.ctrlKey:e.ctrlKey)return!1;return!0},Hf=(t,e)=>{const n=t.replace(e,p.ZWSP).split("");return n.forEach((a,i)=>{a===p.ZWSP&&(n[i]=e)}),n},W=(t,e)=>{if(!t)return!1;if(t.startsWith("\u2303")&&!Mt()){if(t==="\u2303D")return!1;t=t.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(t.indexOf("\u21E7")===-1&&t.indexOf("\u2318")===-1&&t.indexOf("\u2325")===-1&&t.indexOf("\u2303")===-1)return!!(et(e)&&!e.altKey&&!e.shiftKey&&t===p.KEYCODELIST[e.keyCode]);let n=t.split("");if(t.indexOf("F")>-1?n.forEach((i,s)=>{i==="F"&&(n[s]="F"+n.splice(s+1,1),n[s+1]&&(n[s+1]+=n.splice(s+1,1)))}):t.indexOf("PageUp")>-1?n=Hf(t,"PageUp"):t.indexOf("PageDown")>-1?n=Hf(t,"PageDown"):t.indexOf("Home")>-1?n=Hf(t,"Home"):t.indexOf("End")>-1&&(n=Hf(t,"End")),t.startsWith("\u21E7")&&n.length===2)return!!(et(e)&&!e.altKey&&e.shiftKey&&n[1]===p.KEYCODELIST[e.keyCode]);if(t.startsWith("\u2325")){let i=n.length===3?n[2]:n[1];n.length===4&&(i=n[3]);const s=i===p.KEYCODELIST[e.keyCode];return!!(s&&e.altKey&&!e.shiftKey&&n.length<4&&(n.length===3?Wt(e)&&t.startsWith("\u2325\u2318"):et(e))||s&&t.startsWith("\u2325\u21E7\u2318")&&n.length===4&&e.altKey&&e.shiftKey&&Wt(e)||s&&t.startsWith("\u2325\u21E7")&&n.length===3&&e.altKey&&e.shiftKey&&et(e))}if(t.startsWith("\u2303")){if(!Mt())return!1;let i=n.length===3?n[2]:n[1];n.length===4?i=n[3]:n.length===5&&(i=n[4]);const s=i===p.KEYCODELIST[e.keyCode];return!!(s&&e.ctrlKey&&!e.altKey&&!e.shiftKey&&n.length<4&&(n.length===3?e.metaKey&&t.startsWith("\u2303\u2318"):!e.metaKey)||s&&t.startsWith("\u2303\u21E7")&&n.length===3&&e.ctrlKey&&!e.altKey&&e.shiftKey&&!e.metaKey||s&&t.startsWith("\u2303\u2325")&&n.length===3&&e.ctrlKey&&e.altKey&&!e.shiftKey&&!e.metaKey||s&&n.length===4&&e.ctrlKey&&(t.startsWith("\u2303\u2325\u21E7")&&e.shiftKey&&!e.metaKey&&e.altKey||t.startsWith("\u2303\u2325\u2318")&&!e.shiftKey&&e.metaKey&&e.altKey||t.startsWith("\u2303\u21E7\u2318")&&e.shiftKey&&e.metaKey&&!e.altKey)||s&&n.length===5&&e.ctrlKey&&e.shiftKey&&e.metaKey&&e.altKey)}const a=n.length>2&&n[0]==="\u21E7";return Wt(e)&&!e.altKey&&(!a&&!e.shiftKey||a&&e.shiftKey)?(a?n[2]:n[1])===p.KEYCODELIST[e.keyCode]:!1},Km=t=>{let e=!1;return Object.keys(window.siyuan.config.keymap).find(n=>{const a=window.siyuan.config.keymap[n];if(Object.keys(a).find(i=>{const s=a[i];if(typeof s.custom=="string"){if(s.custom===t)return e=!0,!0}else if(Object.keys(s).forEach(l=>{if(s[l].custom===t)return e=!0,!0}),e)return!0}),e)return!0}),e},j_=()=>{window.siyuan.config.keymap.general&&Object.keys(window.siyuan.config.keymap.general).forEach(t=>{["fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","graphView","globalGraph","riffCard"].includes(t)&&(navigator.platform.toUpperCase().indexOf("MAC")>-1?(window.siyuan.config.keymap.general[t].default=window.siyuan.config.keymap.general[t].default.replace("\u2325","\u2303"),window.siyuan.config.keymap.general[t].default===window.siyuan.config.keymap.general[t].custom&&(window.siyuan.config.keymap.general[t].custom=window.siyuan.config.keymap.general[t].default.replace("\u2325","\u2303"))):(window.siyuan.config.keymap.general[t].default=window.siyuan.config.keymap.general[t].default.replace("\u2303","\u2325"),window.siyuan.config.keymap.general[t].default===window.siyuan.config.keymap.general[t].custom&&(window.siyuan.config.keymap.general[t].custom=window.siyuan.config.keymap.general[t].default.replace("\u2303","\u2325"))))})};class dt{constructor(e,n){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,e){const a=this.menu.element.getAttribute("data-name");a&&a===e&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(e&&this.menu.element.setAttribute("data-name",e),this.menu.removeCB=n)}showSubMenu(e){this.menu.showSubMenu(e)}addItem(e){if(!this.isOpen)return this.menu.addItem(e)}addSeparator(e,n=!1){let a,i,s=!1;if(typeof e=="object"?(s=e.ignore||!1,i=e.index,a=e.id):typeof e=="number"&&(i=e,s=n),!(s||this.isOpen))return this.menu.addItem({id:a,type:"separator",index:i})}open(e){this.isOpen||this.menu.popup(e)}fullscreen(e="all"){this.isOpen||this.menu.fullscreen(e)}close(){this.menu.remove()}}const hA=(t,e)=>{},bA=()=>{const t=new URLSearchParams(window.location.search),e=t.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e))n=e.substring(20,42),a=Ie("focus",e)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();n=Of(i),a=Ie("focus",i)==="1"}else n=t.get("id"),a=t.get("focus")==="1";return{id:n,isZoomIn:a}},yA=t=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t),Of=t=>t.substring(16,38),_A=(t=window.location.href)=>{const e=new URL(window.location.origin);e.pathname="/check-auth",e.searchParams.set("to",t),window.location.href=e.href},wA=()=>{let t=document.getElementById("baseURL");t||(t=document.createElement("base"),t.id="baseURL"),t.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(t)},xt=(t,e=!0,n=!1)=>{let a=t;return e&&(a=De().basename(t)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},Bf=t=>De().basename(t,De().extname(t)).replace(/-\d{14}-\w{7}/,""),Ro=t=>!t||(t=t.trim(),1>t.length)?!1:(t=t.toLowerCase(),t.startsWith("assets/")||t.startsWith("file://")||t.startsWith("\\\\")?!0:F_()?t.indexOf(":")===1:t.startsWith("/")),De=()=>Mf.posix?Mf.posix:Mf,pD=()=>path,Zm=t=>{const e=[];return t.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");e.find(s=>{if(a.startsWith(s.replace(".sy","")))return!0})||e.push(a)}}),e},Jm=(t,e,n)=>{A("/api/filetree/moveDocs",{toNotebook:e,fromPaths:t,toPath:n})},zi=(t,e,n,a,i=!1)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.querySelector("#foldList"))return f.destroy(),!0}))return;const l=new $e({title:`<div style="padding: 8px;">
    ${a||window.siyuan.languages.move}
    <div style="max-height: 16px;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>
</div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <span data-menu="true" class="b3-form__icon-list fn__a b3-tooltips b3-tooltips__s" aria-label="${pe("\u2325\u2193")}">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input class="b3-text-field fn__block" style="padding-left: 42px;" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${Y()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${Y()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"50vw",height:Y()?"80vh":"70vh",destroyCallback(){n&&ne(n)}});l.element.querySelector(".b3-dialog__header").setAttribute("style","padding:0"),l.element.setAttribute("data-key",p.DIALOG_MOVEPATHTO),e&&e.length>0&&A("/api/filetree/getHPathsByPaths",{paths:e},f=>{l.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=he(f.data.join(" "))});const o=l.element.querySelector("#foldList"),r=l.element.querySelector("#foldTree");Gi(f=>{let g="";f.forEach(h=>{if(!h.closed){let b="";i&&(b=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${h.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${h.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${h.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${h.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${be(h.icon||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${he(h.name)}</span>
    ${b}
</li></ul>`}}),r.innerHTML=g},i);const c=l.element.querySelector(".b3-text-field");c.value=window.siyuan.storage[p.LOCAL_MOVE_PATH].k,c.select();const d=f=>{if(!(f&&f.isComposing)){if(c.value.trim()===""){o.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),o.classList.remove("fn__none"),o.scrollTo(0,0),A("/api/filetree/searchDocs",{k:c.value,flashcard:i},g=>{let h="";g.data.forEach(b=>{let y="";i&&(y=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),h+=`<li class="b3-list-item${h===""?" b3-list-item--focus":""}" data-path="${b.path}" data-box="${b.box}">
    ${be(b.boxIcon||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding: 4px 0">${he(b.hPath)}</span>
    ${y}
</li>`}),o.innerHTML=h})}},u=()=>{const f=window.siyuan.storage[p.LOCAL_MOVE_PATH].keys;if(!f||f.length===0||f.length===1&&f[0]===c.value)return;const g=new dt(p.MENU_MOVE_PATH_HISTORY);if(g.isOpen)return;g.element.classList.add("b3-menu--list"),g.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_MOVE_PATH].keys=[],Ee(p.LOCAL_MOVE_PATH,window.siyuan.storage[p.LOCAL_MOVE_PATH])}});const h=g.addSeparator(1);let b=!0;f.forEach(w=>{if(w!==c.value&&w){const E=g.addItem({iconHTML:"",label:he(w),action:"iconCloseRound",bind(C){C.addEventListener("click",$=>{var M;T($.target,"b3-menu__action")?(f.find((k,_)=>{if(k===w)return f.splice(_,1),!0}),window.siyuan.storage[p.LOCAL_MOVE_PATH].keys=f,Ee(p.LOCAL_MOVE_PATH,window.siyuan.storage[p.LOCAL_MOVE_PATH]),(M=C.previousElementSibling)!=null&&M.classList.contains("b3-menu__separator")&&!C.nextElementSibling?window.siyuan.menus.menu.remove():C.remove()):(c.value=C.textContent,d(),window.siyuan.menus.menu.remove()),$.preventDefault(),$.stopPropagation()})}});b&&E.classList.add("b3-menu__item--current"),b=!1}}),b&&h.remove();const y=c.getBoundingClientRect();g.open({x:y.left,y:y.bottom})};d(),c.addEventListener("compositionend",f=>{d(f)}),c.addEventListener("input",f=>{d(f)}),c.addEventListener("blur",()=>{if(c.value){let f=window.siyuan.storage[p.LOCAL_MOVE_PATH].keys;f.splice(0,0,c.value),f=Array.from(new Set(f)),f.length>window.siyuan.config.search.limit&&f.splice(window.siyuan.config.search.limit,f.length-window.siyuan.config.search.limit),window.siyuan.storage[p.LOCAL_MOVE_PATH].keys=f}window.siyuan.storage[p.LOCAL_MOVE_PATH].k=c.value,Ee(p.LOCAL_MOVE_PATH,window.siyuan.storage[p.LOCAL_MOVE_PATH])});const m=28;c.addEventListener("keydown",f=>{if(f.isComposing)return;if(W("\u2325\u2193",f)){f.stopPropagation(),u();return}if(window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_MOVE_PATH_HISTORY)return;const g=o.classList.contains("fn__none")?r:o,h=g.querySelectorAll(".b3-list-item--focus");if(h.length===0)return;let b=h[0];if(f.key.startsWith("Arrow")&&h.forEach((y,w)=>{w!==0&&y.classList.remove("b3-list-item--focus")}),o.classList.contains("fn__none")){if(f.key==="ArrowRight"&&!b.querySelector(".b3-list-item__arrow--open")&&!b.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||f.key==="ArrowLeft"&&b.querySelector(".b3-list-item__arrow--open")){Xm(b,i),f.preventDefault();return}if(f.key==="ArrowLeft"){let y=b.parentElement.previousElementSibling;if(y){y.tagName!=="LI"&&(y=g.querySelector(".b3-list-item")),b.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const w=y.getBoundingClientRect(),E=g.getBoundingClientRect();(w.top<E.top||w.bottom>E.bottom)&&y.scrollIntoView(w.top<E.top)}return f.preventDefault(),!0}if(f.key==="ArrowDown"||f.key==="ArrowRight"){let y=b;for(;y;)if(y.nextElementSibling)if(y.nextElementSibling.classList.contains("fn__none"))y=y.nextElementSibling;else{y.nextElementSibling.tagName==="UL"?y=y.nextElementSibling.firstElementChild:y=y.nextElementSibling;break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const w=y.getBoundingClientRect(),E=r.getBoundingClientRect();(w.top<E.top||w.bottom>E.bottom)&&y.scrollIntoView(w.top<E.top)}return f.preventDefault(),!0}if(f.key==="ArrowUp"){let y=b;for(;y;)if(y.previousElementSibling)if(y.previousElementSibling.classList.contains("fn__none"))y=y.previousElementSibling;else{if(y.previousElementSibling.tagName==="LI")y=y.previousElementSibling;else{const w=y.previousElementSibling.querySelectorAll(".b3-list-item");y=w[w.length-1]}break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const w=y.getBoundingClientRect(),E=r.getBoundingClientRect();(w.top<E.top||w.bottom>E.bottom)&&y.scrollIntoView(w.top<E.top)}f.preventDefault()}}else{if(f.key==="ArrowDown"){b.classList.remove("b3-list-item--focus"),b.nextElementSibling?b.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),b=g.querySelector(".b3-list-item--focus"),(g.scrollTop<b.offsetTop-g.clientHeight+m||g.scrollTop>b.offsetTop)&&(g.scrollTop=b.offsetTop-g.clientHeight+m),f.preventDefault();return}if(f.key==="ArrowUp"){if(b.classList.remove("b3-list-item--focus"),b.previousElementSibling)b.previousElementSibling.classList.add("b3-list-item--focus");else{const y=g.children.length;g.children[y-1].classList.add("b3-list-item--focus")}b=g.querySelector(".b3-list-item--focus"),(g.scrollTop<b.offsetTop-g.clientHeight+m||g.scrollTop>b.offsetTop-m*2)&&(g.scrollTop=b.offsetTop-m*2),f.preventDefault();return}}if(f.key==="Enter"){const y=g.querySelectorAll(".b3-list-item--focus");if(y.length===0)return;const w=[],E=[];y.forEach(C=>{w.push(C.getAttribute("data-path")),E.push(C.getAttribute("data-box"))}),t(w,E),l.destroy(),f.preventDefault()}}),l.element.addEventListener("click",f=>{let g=f.target;for(;g&&!g.isEqualNode(l.element);){if(g.classList.contains("b3-list-item__toggle")){Xm(g.parentElement,i),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-form__icon-list")){u(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const b=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const y=[],w=[];b.forEach(E=>{y.push(E.getAttribute("data-path")),w.push(E.getAttribute("data-box"))}),t(y,w),l.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){l.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const b=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;a===window.siyuan.languages.specifyPath&&Wt(f)?b.length===1&&b[0]===g||g.classList.toggle("b3-list-item--focus"):(b[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&Xm(g,i),f.preventDefault(),f.stopPropagation();break}g=g.parentElement}c.focus()})},Xm=(t,e)=>{const n=t.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.classList.add("fn__none");return}if(t.nextElementSibling&&t.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none");return}const a=t.getAttribute("data-box");A("/api/filetree/listDocsByPath",{notebook:a,path:t.getAttribute("data-path"),flashcard:e,app:p.SIYUAN_APPID},i=>{if(i.data.files.length===0){de(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(o=>{let r="";e?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${o.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${o.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${o.flashcardCount}</span>`:o.count&&o.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${o.count}</span>`),s+=`<li data-box="${a}" class="b3-list-item" data-path="${o.path}">
    <span style="padding-left: ${o.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${o.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${be(o.icon||(o.subFileCount===0?window.siyuan.storage[p.LOCAL_IMAGES].file:window.siyuan.storage[p.LOCAL_IMAGES].folder),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${xt(o.name,!0,!0)} <small class='ft__on-surface'>${o.hSize}</small>${o.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+o.bookmark:""}${o.name1?"<br>"+window.siyuan.languages.name+" "+o.name1:""}${o.alias?"<br>"+window.siyuan.languages.alias+" "+o.alias:""}${o.memo?"<br>"+window.siyuan.languages.memo+" "+o.memo:""}${o.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",o.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${o.hMtime}<br>${window.siyuan.languages.createdAt} ${o.hCtime}">${xt(o.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;n.classList.add("b3-list-item__arrow--open"),t.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const l=t.nextElementSibling;setTimeout(()=>{l.setAttribute("style",`height:${l.childElementCount*t.clientHeight}px;`),setTimeout(()=>{l.classList.remove("file-tree__sliderDown"),l.removeAttribute("style")},120)},2)})},Qa=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.name,!0}),e},vA=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.icon,!0}),e},EA=(t,e)=>{window.siyuan.notebooks.find(n=>{if(n.id===t)return n.name=e,!0})},Qm=()=>{let t=0;return window.siyuan.notebooks.forEach(e=>{e.closed||t++}),t},Gi=(t,e=!1)=>{A("/api/notebook/lsNotebooks",{flashcard:e},n=>{e||(window.siyuan.notebooks=n.data.notebooks),t&&t(n.data.notebooks)})},ji=(t,e=["edit","more"])=>{let n=!0;if(t){const a=t.getAttribute("data-readonly");if(typeof a=="string")n=a==="false";else return'<div class="protyle-icons"></div>'}return e.length===3?`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__reload"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit${n?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`:`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${n?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${n?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},vc=t=>{if(t.querySelector(".protyle-cursor"))return;const e=t.getAttribute("data-type");e==="NodeBlockQueryEmbed"?t.insertAdjacentHTML("afterbegin",`<div class="protyle-icons${G(t)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div><div class="protyle-cursor">${p.ZWSP}</div>`):(e==="NodeMathBlock"||t.getAttribute("data-subtype")==="math")&&(t.firstElementChild.innerHTML=`<span></span><span class="protyle-cursor">${p.ZWSP}</span>`)},sa=t=>(t.querySelectorAll("protyle-html").forEach(e=>{e.setAttribute("data-content",Lute.UnEscapeHTMLStr(e.getAttribute("data-content")))}),t),K_="%%params",kA=t=>{let e={responsive:"resize"};const n=t.substring(0,t.indexOf(`
`));if(n.startsWith(K_))try{e=Ja(n.substring(K_.length))}catch(a){console.error(`Failed to parse ABCJS params: ${a}`)}return e},Z_=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="abc"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&jt(`${e}/js/abcjs/abcjs-basic-min.js?v=6.5.0`,"protyleAbcjsScript").then(()=>{const a=T(t,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",ji(a));const s=i.firstElementChild.nextElementSibling;s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false"></div>`;const l=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));window.ABCJS.renderAbc(s.lastElementChild,l,kA(l)),i.setAttribute("data-render","true")})})};var SA=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const eh=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="echarts"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&jt(`${e}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{jt(`${e}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{const a=T(t,"protyle-wysiwyg",!0);let i;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(i=a.firstElementChild.clientWidth),n.forEach(s=>SA(void 0,null,function*(){var l,o,r;if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ji(a,["refresh","edit","more"]));const c=s.firstElementChild.nextElementSibling;if(!s.getAttribute("data-content")){c.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{!c.lastElementChild||c.childElementCount===1?c.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div style="height:${s.style.height||"420px"}" contenteditable="false"></div>`:c.lastElementChild.classList.remove("ft__error");const d=window.echarts.getInstanceById((l=c.lastElementChild)==null?void 0:l.getAttribute("_echarts_instance_")),u=yield Ja(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));d&&(((o=d.getOption().series[0])==null?void 0:o.type)!==((r=u.series[0])==null?void 0:r.type)&&d.clear(),d==null||d.resize()),window.echarts.init(c.lastElementChild,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:i}).setOption(u)}catch(d){window.echarts.dispose(c.lastElementChild),c.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" style="height:${s.style.height||"420px"}" contenteditable="false">echarts render error: <br>${d}</div>`}s.setAttribute("data-render","true")}))})})},J_=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="graphviz"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&jt(`${e}/js/graphviz/viz.js?v=3.11.0`,"protyleGraphVizScript").then(()=>{const a=T(t,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",ji(a));const s=i.firstElementChild.nextElementSibling;if(!i.getAttribute("data-content")){s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{Viz.instance().then(l=>{const o=l.renderSVGElement(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false">${o.outerHTML}</div>`}).catch(l=>{s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${l}</div>`})}catch(l){console.error("Graphviz error",l)}i.setAttribute("data-render","true")})})},Ec=(t,e)=>{if(!document.getElementById(e)){const n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href=t;const a=document.querySelector("#pluginsStyle");a?a.before(n):document.getElementsByTagName("head")[0].appendChild(n)}},Nn=(t,e=p.PROTYLE_CDN,n=!1)=>{let a=[];t.getAttribute("data-subtype")==="math"?a=[t]:a=Array.from(t.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(Ec(`${e}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),jt(`${e}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{jt(`${e}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{a.forEach(i=>{var s,l;if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let o={};try{o=Ja(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}const r=i.tagName==="DIV";try{const c=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:r,output:"html",macros:o,trust:!0,strict:u=>u==="unicodeTextInMathMode"?"ignore":"warn"}),d=B(i);if(r){vc(i),i.firstElementChild.firstElementChild.classList.remove("ft__error"),i.firstElementChild.firstElementChild.setAttribute("contenteditable","false"),i.firstElementChild.firstElementChild.innerHTML=c;const u=i.querySelectorAll(".base");u.length>0&&u[u.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const m=i.querySelector(".katex-html > .newline");m&&(m.parentElement.style.display="block")}else{i.classList.remove("ft__error"),i.innerHTML=c,d&&i.getBoundingClientRect().width>d.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const u=Ge(i);u?u&&u.nodeType!==3&&(((s=u.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1||u.classList.contains("img"))?i.after(document.createTextNode(p.ZWSP)):u&&!u.textContent.startsWith(`
`)&&u.textContent!==p.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",p.ZWSP),(l=i.previousSibling)!=null&&l.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",p.ZWSP):!pt(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",p.ZWSP)}n&&setTimeout(()=>{if(r){const u=i.querySelector(".katex-display");u.clientWidth<u.scrollWidth&&u.firstElementChild.setAttribute("style",`font-size:${u.clientWidth*100/u.scrollWidth}%`)}else d&&i.offsetWidth>d.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${d.clientWidth*100/i.offsetWidth}%`)})}catch(c){r?(vc(i),i.firstElementChild.firstElementChild.setAttribute("contenteditable","false"),i.firstElementChild.firstElementChild.innerHTML=c.message,i.firstElementChild.firstElementChild.classList.add("ft__error")):(i.innerHTML=c.message,i.classList.add("ft__error"))}})})}))};var X_=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Q_=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mermaid"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&jt(`${e}/js/mermaid/mermaid.min.js?v=11.12.0`,"protyleMermaidScript").then(()=>{jt(`${e}/js/mermaid/mermaid-zenuml.min.js?v=0.2.2`,"protyleMermaidZenumlScript").then(()=>X_(void 0,null,function*(){yield window.mermaid.registerExternalDiagrams([window.zenuml]),window.mermaid.registerIconPacks([{name:"logos",loader:()=>fetch(`${e}/js/mermaid/icons.json?v=11.11.0`).then(i=>i.json())}]);const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const i=new MutationObserver(()=>{ew(n),i.disconnect()}),s=j(n[0],"fold","1");if(s)i.observe(s,{attributeFilter:["fold"]});else{const l=T(n[0],"card__block",!0);l&&i.observe(l,{attributeFilter:["class"]})}}else ew(n)}))})},ew=t=>{const e=T(t[0],"protyle-wysiwyg",!0);t.forEach(n=>X_(void 0,null,function*(){if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",ji(e));const a=n.firstElementChild.nextElementSibling;if(!n.getAttribute("data-content")){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}const i="mermaid"+Lute.NewNodeID();try{a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false"><span id="${i}"></span></div>`;const s=yield window.mermaid.render(i,Lute.UnEscapeHTMLStr(n.getAttribute("data-content")));a.lastElementChild.innerHTML=s.svg}catch(s){const l=document.querySelector("#"+i);a.lastElementChild.innerHTML=`${l.outerHTML}<div class="fn__hr"></div><div class="ft__error">${s.message.replace(/\n/,"<br>")}</div>`,l.parentElement.remove()}n.setAttribute("data-render","true")}))},tw=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mindmap"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&jt(`${e}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{const a=T(t,"protyle-wysiwyg",!0);let i;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(i=a.firstElementChild.clientWidth),n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",ji(a));const l=s.firstElementChild.nextElementSibling;if(!s.getAttribute("data-content")){l.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{!l.lastElementChild||l.childElementCount===1?l.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div style="height:${s.style.height||"420px"}" contenteditable="false"></div>`:l.lastElementChild.classList.remove("ft__error"),window.echarts.init(l.lastElementChild,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:i}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(s.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(o,r)=>{var c;return(c=r==null?void 0:r.data)!=null&&c.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"})}catch(o){window.echarts.dispose(l.lastElementChild),l.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" style="height:${s.style.height||"420px"}" contenteditable="false">Mindmap render error: <br>${o}</div>`}s.setAttribute("data-render","true")})})},nw=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="flowchart"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&jt(`${e}/js/flowchart.js/flowchart.min.js?v=1.18.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=new MutationObserver(()=>{aw(n),a.disconnect()}),i=j(n[0],"fold","1");if(i)a.observe(i,{attributeFilter:["fold"]});else{const s=T(n[0],"card__block",!0);s&&a.observe(s,{attributeFilter:["class"]})}}else aw(n)})},aw=t=>{const e=T(t[0],"protyle-wysiwyg",!0);t.forEach(n=>{if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",ji(e));const a=n.firstElementChild.nextElementSibling;if(!n.getAttribute("data-content")){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false"></div>`,flowchart.parse(Lute.UnEscapeHTMLStr(n.getAttribute("data-content"))).drawSVG(a.lastElementChild)}catch(i){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${i}</div>`}n.setAttribute("data-render","true")})},iw=(t,e=p.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="plantuml"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&jt(`${e}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const a=T(t,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",ji(a));const s=i.firstElementChild.nextElementSibling;if(!i.getAttribute("data-content")){s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{const l=`${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")))}`;s.innerHTML=`<object type="image/svg+xml" data="${l}"/>`,s.classList.remove("ft__error"),s.firstElementChild.addEventListener("error",()=>{s.innerHTML=`<img src=${l}">`})}catch(l){s.classList.add("ft__error"),s.innerHTML=`plantuml render error: <br>${l}`}i.setAttribute("data-render","true")})})},sw=t=>{let e=[];t.getAttribute("data-type")==="NodeHTMLBlock"?e=[t]:e=Array.from(t.querySelectorAll('[data-type="NodeHTMLBlock"]')),e.length!==0&&e.length>0&&e.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},LA=(t,e,n)=>{const a=document.createElement("div");a.innerHTML=t;let i=!1;if((a.childElementCount===1&&a.lastElementChild.style.fontFamily.indexOf("monospace")>-1||a.childElementCount===1&&a.querySelectorAll("pre").length===1||t.indexOf(`
<p class="p1">`)===0||a.childElementCount===1&&a.firstElementChild.tagName==="TABLE"&&a.querySelector(".line-number")&&a.querySelector(".line-content"))&&(i=!0),i){let s=e||t;return/\n/.test(s)?n.lute.Md2BlockDOM(s):(s=s.replace("<","&lt;").replace(">","&gt;"),"`"+s+"`")}return!1},Ct=t=>{const e=t.getAttribute("data-subtype");if(!p.SIYUAN_RENDER_CODE_LANGUAGES.includes(e)||t.getAttribute("data-type")!=="NodeHTMLBlock"){Z_(t),sw(t),iw(t),Q_(t),nw(t),eh(t),tw(t),J_(t),Nn(t);return}e==="abc"?Z_(t):e==="plantuml"?iw(t):e==="mermaid"?Q_(t):e==="flowchart"?nw(t):e==="echarts"?eh(t):e==="mindmap"?tw(t):e==="graphviz"?J_(t):e==="math"?Nn(t):t.getAttribute("data-type")==="NodeHTMLBlock"&&sw(t)},ws=(t,e)=>{let n="";return t.forEach(a=>{typeof a=="string"?n+=`<option value="${a}" ${e===a?"selected":""}>${a}</option>`:n+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label}</option>`}),n},AA=(t,e)=>{let n="";return t.forEach(a=>{n+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label} (${a.name})</option>`}),n},Re=(t,e,n,a,i=!1)=>{if(!e&&!t){n();return}const s=new $e({title:t,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel" id="cancelDialogConfirmBtn">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button ${i?"b3-button--remove":"b3-button--text"}" id="confirmDialogConfirmBtn">${window.siyuan.languages[i?"delete":"confirm"]}</button>
</div>`,width:Y()?"92vw":"520px"});s.element.addEventListener("click",l=>{let o=l.target;const r=typeof l.detail=="string";for(;o&&o!==s.element||r;){if(o.id==="cancelDialogConfirmBtn"||r&&l.detail==="Escape"){a&&a(s),s.destroy();break}else if(o.id==="confirmDialogConfirmBtn"||r&&l.detail==="Enter"){n&&n(s),s.destroy();break}o=o.parentElement}}),s.element.setAttribute("data-key",p.DIALOG_CONFIRM)},lw=()=>{A("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{t.data.snippets.forEach(e=>{const n=`snippet${e.type==="css"?"CSS":"JS"}${e.id}`;let a=document.getElementById(n);if(!window.siyuan.config.snippet.enabledCSS&&e.type==="css"||!window.siyuan.config.snippet.enabledJS&&e.type==="js"){a&&a.remove();return}if(!e.enabled){a&&a.remove();return}if(a){if(a.innerHTML===e.content)return;a.remove()}e.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${n}">${e.content}</style>`):e.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=e.content,a.id=n,document.head.appendChild(a))})})},xA=()=>{A("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{let e="",n="";t.data.snippets.forEach(s=>{s.type==="css"?e+=th(s):n+=th(s)});const a=new $e({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        <div class="fn__flex">
            <div class="b3-form__icon fn__flex-1">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="css" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input fn__block">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} CSS" id="addCodeSnippetCSS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleCSS" class="b3-switch fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledCSS?" checked":""}>
        </div>
        ${e}
    </div>
    <div class="fn__none">
        <div class="fn__flex">
             <div class="b3-form__icon fn__flex-1">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="js" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input fn__block">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} JS" id="addCodeSnippetJS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleJS" class="b3-switch fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledJS?" checked":""}>
        </div>
        ${n}
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback:s=>{(s==null?void 0:s.cancel)!=="true"&&cw(a,t.data.snippets,i,!0)}});t.data.snippets.forEach(s=>{const l=a.element.querySelector(`[data-id="${s.id}"] input`);l.value=s.name;const o=a.element.querySelector(`[data-id="${s.id}"] textarea`);o.textContent=s.content});const i=[];a.element.setAttribute("data-key",p.DIALOG_SNIPPETS),a.element.addEventListener("click",s=>{let l=s.target;for(;l&&l!==a.element;){if(l.id==="addCodeSnippetCSS"||l.id==="addCodeSnippetJS"){l.parentElement.insertAdjacentHTML("afterend",th({type:l.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!0,disabledInPublish:!1})),s.stopPropagation(),s.preventDefault();break}else if(l.classList.contains("b3-button--cancel")){a.destroy({cancel:"true"}),s.stopPropagation(),s.preventDefault();break}else if(l.classList.contains("b3-button--text")){cw(a,t.data.snippets,i),s.stopPropagation(),s.preventDefault();break}else if(l.classList.contains("item")){l.getAttribute("data-type")==="css"?(l.classList.add("item--focus"),l.nextElementSibling.classList.remove("item--focus"),l.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),l.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(l.classList.add("item--focus"),l.previousElementSibling.classList.remove("item--focus"),l.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),l.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none")),s.stopPropagation(),s.preventDefault();break}else if(l.dataset.action==="remove"){const o=l.parentElement.parentElement;i.push("#snippet"+(o.getAttribute("data-type")==="css"?"CSS":"JS")+o.getAttribute("data-id")),o.remove(),s.stopPropagation(),s.preventDefault();break}l=l.parentElement}}),a.element.querySelectorAll('[data-action="search"]').forEach(s=>{s.addEventListener("input",l=>{l.isComposing||ow(a,s)}),s.addEventListener("compositionend",()=>{ow(a,s)})})})},ow=(t,e)=>{t.element.querySelectorAll(`.fn__flex-1 > div > [data-type="${e.dataset.type}"]`).forEach(n=>{const a=n.querySelector("input").value.toLowerCase(),i=n.querySelector("textarea").value.toLowerCase(),s=e.value.toLowerCase();!s||a&&(s.includes(a)||a.includes(s))||i&&(i.includes(s)||s.includes(i))?n.classList.remove("fn__none"):n.classList.add("fn__none")})},th=t=>`<div data-id="${t.id||""}" data-type="${t.type}">
    <div class="fn__hr--b"></div>
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__space"></div>
        <label class="fn__flex${window.siyuan.config.publish.enable?"":" fn__none"}">
            <input data-type="disabledInPublish" type="checkbox" class="b3-switch fn__flex-center" ${t.disabledInPublish?"":" checked"}>
            <div class="fn__space"></div>
            <span class="fn__flex-center">${window.siyuan.languages.publishService}</span>
        </label>
        <div class="fn__flex-1"></div>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" data-action="remove" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <div class="fn__space"></div>
        <input data-type="snippet" class="b3-switch fn__flex-center" type="checkbox"${t.enabled?" checked":""}>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
    <div class="fn__hr--b"></div>
</div>`,rw=(t,e,n)=>{A("/api/snippet/setSnippet",{snippets:e},()=>{n.forEach(a=>{const i=document.querySelector(a);i&&i.remove()}),window.siyuan.config.snippet.enabledCSS=t.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked,window.siyuan.config.snippet.enabledJS=t.element.querySelector('.b3-switch[data-action="toggleJS"]').checked,A("/api/setting/setSnippet",window.siyuan.config.snippet,()=>{pd()}),lw(),t.destroy({cancel:"true"})})},cw=(t,e,n,a=!1)=>{const i=[];t.element.querySelectorAll("[data-id]").forEach(s=>{i.push({disabledInPublish:!s.querySelector('.b3-switch[data-type="disabledInPublish"]').checked,id:s.getAttribute("data-id"),name:s.querySelector("input").value,type:s.getAttribute("data-type"),content:s.querySelector("textarea").value,enabled:s.querySelector('.b3-switch[data-type="snippet"]').checked})}),rn(e,i)&&window.siyuan.config.snippet.enabledCSS===t.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked&&window.siyuan.config.snippet.enabledJS===t.element.querySelector('.b3-switch[data-action="toggleJS"]').checked?t.destroy({cancel:"true"}):a?Re(window.siyuan.languages.save,window.siyuan.languages.snippetsTip,()=>{rw(t,i,n)}):rw(t,i,n)},la=(t,e)=>{let n="";switch(t){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":e?n="icon"+e.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":e==="t"?n="iconCheck":e==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n};class kc{constructor(e){this.click=e.click,this.ctrlClick=e.ctrlClick,this.altClick=e.altClick,this.shiftClick=e.shiftClick,this.rightClick=e.rightClick,this.toggleClick=e.toggleClick,this.element=e.element,this.blockExtHTML=e.blockExtHTML,this.topExtHTML=e.topExtHTML,this.updateData(e.data),this.bindEvent()}updateData(e){this.data=e,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),Nn(this.element))}genHTML(e){let n=`<ul${e[0].depth===0?" class='b3-list b3-list--background'":""}>`;return e.forEach(a=>{let i="",s='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(i=` aria-label="${Zt(a.hPath)}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${la(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(i=` aria-label="${Zt(Lute.BlockDOM2Content(a.name))}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}" style="height: 22px;width: 10px;"><use xlink:href="#${la(a.nodeType,a.subType)}"></use></svg>`);let l="";a.count&&(l=`<span class="counter">${a.count}</span>`);const o=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";Y()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${a.depth*18||4}px;margin-right: 2px`;const c=o||a.type==="backlink"&&!Y();n+=`<li class="b3-list-item${Y()?"":" b3-list-item--hide-action"}" 
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
style="--file-toggle-width:${a.depth===0?22:(a.depth+1)*18}px" 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${c?" b3-list-item__toggle--hl":""}${c?"":" fn__hidden"}">
        <svg data-id="${a.id||encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${(a.type==="outline"?!a.folded:o)?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${s}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${i}>${a.name}</span>
    ${this.topExtHTML||""}
    ${l}
</li>`,a.children&&a.children.length>0&&(n+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(n+=this.genBlockHTML(a.blocks,a.type==="outline"?!a.folded:!0,a.type)+"</ul>")}),n}genBlockHTML(e,n=!1,a){let i=`<ul class="${n?"":"fn__none"}">`;return e.forEach(s=>{let l="";s.count&&(l=`<span class="counter">${s.count}</span>`);let o;a==="outline"?o=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${s.id}" style="height: 22px;width: 10px;"><use xlink:href="#${la(s.type,s.subType)}"></use></svg>`:s.type==="NodeDocument"?o=`<span data-showref="true" class="b3-list-item__graphic popover__block" data-id="${s.id}">${be(s.ial.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span>`:o=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${s.id}"><use xlink:href="#${la(s.type,s.subType)}"></use></svg>`;let r="";Y()?s.depth>0&&(r=`padding-left: ${(s.depth-1)*20+24}px`):r=`padding-left: ${s.depth*18||4}px;margin-right: 2px`,i+=`<li class="b3-list-item${Y()?"":" b3-list-item--hide-action"}"  
style="--file-toggle-width:${s.depth===0?22:(s.depth+1)*18}px" 
data-node-id="${s.id}" 
data-ref-text="${encodeURIComponent(s.refText)}" 
data-def-id="${s.defID}" 
data-type="${s.type}" 
data-subtype="${s.subType}" 
data-treetype="${a}" 
data-def-path="${s.defPath}">
    <span style="${r}" class="b3-list-item__toggle${s.children?" b3-list-item__toggle--hl":""}${s.children?"":" fn__hidden"}">
        <svg data-id="${s.id}" class="b3-list-item__arrow${(a==="outline"?!s.folded:n)?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${o}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+Zt(Lute.BlockDOM2Content(s.content))+'"':""}>${s.content}</span>
    ${l}
    ${this.blockExtHTML||""}
</li>`,s.children&&s.children.length>0&&(i+=this.genBlockHTML(s.children,a==="outline"?!s.folded:!1,a)+"</ul>")}),i}toggleBlocks(e){if(this.toggleClick){this.toggleClick(e);return}if(!e.nextElementSibling)return;const n=e.firstElementChild.firstElementChild;n.classList.contains("b3-list-item__arrow--open")?(n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling.classList.add("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(e){e.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(n=>{n.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.tagName==="LI"&&this.rightClick){this.rightClick(n,e),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),this.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.classList.contains("b3-list-item__toggle")&&!n.classList.contains("fn__hidden")&&!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed){this.toggleBlocks(n.parentElement),this.setCurrent(n.parentElement),e.preventDefault();break}if(n.classList.contains("b3-list-item__action")&&this.click){const a=U(n,"LI");a&&this.click(a,e),e.preventDefault(),e.stopPropagation();break}else if(n.tagName==="LI"){this.setCurrent(n),n.getAttribute("data-node-id")||n.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(n,e):this.altClick&&window.siyuan.altIsPressed?this.altClick(n,e):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(n):this.click&&this.click(n,e),e.stopPropagation()):this.toggleBlocks(n),e.preventDefault();break}n=n.parentElement}}),this.element.addEventListener("dragstart",e=>{const n=U(e.target,"LI");n&&(e.dataTransfer.setData("text/html",n.outerHTML),n.style.opacity="0.38",window.siyuan.dragElement=n)}),this.element.addEventListener("dragend",e=>{const n=U(e.target,"LI");n&&(n.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const e=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(n=>{e.push(n.getAttribute("data-id"))}),e}setExpandIds(e){!e||e.length===0||this.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{e.includes(n.getAttribute("data-id"))?(n.classList.add("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(n.classList.remove("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.tagName==="UL"&&n.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}class CA{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(Y()?"click":"mouseover",e=>{const n=e.target;if(Y()&&(T(n,"b3-menu__title")||typeof e.detail=="string"&&e.detail==="back")){const l=this.element.querySelectorAll(".b3-menu__item--show");l.length>0?l[l.length-1].classList.remove("b3-menu__item--show"):(this.element.style.transform="",setTimeout(()=>{this.remove()},p.TIMEOUT_DBLCLICK));return}const a=T(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const i=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(a)&&s!==a&&!a.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),i&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(e){const n=e.parentElement.getBoundingClientRect();e.style.top=n.top-8+"px",e.style.left=n.right+8+"px",e.style.bottom="auto";const a=e.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?e.style.left=n.left-8-a.width+"px":e.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(e.style.top="auto",e.style.bottom="8px")}preventDefault(e){!T(e.target,"b3-menu")&&!T(e.target,"keyboard__bar")&&e.preventDefault()}addItem(e){const n=new N(e);if(n)return this.append(n.element,e.index),n.element}removeScrollEvent(){window.removeEventListener(Y()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(e=!1){var n;if(e){const a=window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item--show");if(a.length>0){const i=a[a.length-1];i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),(n=i.querySelector(".b3-menu__item--current"))==null||n.classList.remove("b3-menu__item--current");return}}window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(e,n){if(e){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(e);return}}this.element.lastElementChild.append(e)}}popup(e){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(Y()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),Te(this.element,e.x-(e.isLeft?this.element.clientWidth:0),e.y,e.h,e.w))}fullscreen(e="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{e==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100%)"}),this.element.lastElementChild.scrollTop=0)}}class N{constructor(e){if(!e.ignore){if(e.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=e.label,e.bind&&e.bind(this.element);return}if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),e.id&&this.element.setAttribute("data-id",e.id),e.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=e.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),e.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),(e.icon==="iconTrashcan"||e.warning)&&this.element.classList.add("b3-menu__item--warning"),e.element)this.element.append(e.element);else{let n=`<span class="b3-menu__label">${e.label||"&nbsp;"}</span>`;typeof e.iconHTML=="string"?n=e.iconHTML+n:n=`<svg class="b3-menu__icon ${e.iconClass||""}" style="${e.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${n}`,e.accelerator&&(n+=`<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(e.accelerator)}</span>`),e.action&&(n+=`<svg class="b3-menu__action${e.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${e.action}"></use></svg>`),e.checked&&(n+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=n}if(e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',e.submenu.forEach(a=>{var i;n.firstElementChild.append(((i=new N(a))==null?void 0:i.element)||"")}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}}const vs=(t,e)=>{let n=t;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly")||n.getBoundingClientRect().height===0)&&!n.querySelector(".b3-text-field");)e?n=n.nextElementSibling:n=n.previousElementSibling;return n},TA=t=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||t.altKey||t.shiftKey||t.ctrlKey||t.metaKey)return!1;const e=t.target;if(window.siyuan.menus.menu.element.contains(e)&&["INPUT","TEXTAREA"].includes(e.tagName))return!1;const n=p.KEYCODELIST[t.keyCode];if(n==="\u2193"||n==="\u2191"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let i;if(a?(a.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(i=vs(a.previousElementSibling,!1),i||(i=vs(a.parentElement.lastElementChild,!1))):(i=vs(a.nextElementSibling,!0),i||(i=vs(a.parentElement.firstElementChild,!0)))):n==="\u2191"?i=vs(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):i=vs(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),i){i.classList.contains("b3-menu__item")&&i.classList.add("b3-menu__item--current");const s=i.querySelector(":scope > .b3-text-field");s&&s.focus(),i.classList.remove("b3-menu__item--show");const l=i.parentElement.getBoundingClientRect(),o=i.getBoundingClientRect();(l.top>o.top||l.bottom<o.bottom)&&i.scrollIntoView(l.top>o.top)}return!0}else if(n==="\u2192"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!a)return!0;const i=a.querySelector(".b3-menu__submenu");if(!i)return!0;a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const s=vs(i.firstElementChild.firstElementChild,!0);return s&&s.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}else if(n==="\u2190"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!a)return!0;const i=T(a,"b3-menu__item--show");return i&&(i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(a){const i=a.querySelector(".b3-menu__submenu");if(i){a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const o=vs(i.firstElementChild.firstElementChild,!0);return o&&o.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}const s=a.querySelector(".b3-text-field"),l=a.querySelector(".b3-switch");if(s)return s.focus(),!0;l?l.click():a.dispatchEvent(new CustomEvent(bc())),window.siyuan.menus.menu.element.contains(a)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class DA{constructor(){this.menus=[]}addSeparator(e,n){typeof e=="number"?this.menus.splice(e,0,{type:"separator",id:n}):this.menus.push({type:"separator",id:n})}addItem(e){typeof e.index=="number"?this.menus.splice(e.index,0,e):this.menus.push(e)}}const qo=(t,e)=>t&&(!t.classList.contains(e)||t.getBoundingClientRect().height===0),xn=(t,e,n="b3-list-item--focus",a)=>{var i;let s=t.querySelector("."+n);if(!s&&a){a.classList.add(n),a.scrollIntoView(!0);return}if(!s)return;const l=n.split("--")[0];if(e.key==="ArrowDown"){for(e.preventDefault(),e.stopPropagation(),s.classList.remove(n),s=s.nextElementSibling;qo(s,l);)s=s.nextElementSibling;if(!s)for(s=t.children[0];qo(s,l);)s=s.nextElementSibling;return s?(s.classList.add(n),(t.scrollTop<s.offsetTop-t.clientHeight+s.clientHeight||t.scrollTop>s.offsetTop)&&s.scrollIntoView(t.scrollTop>s.offsetTop),s):void 0}else if(e.key==="ArrowUp"){for(e.preventDefault(),e.stopPropagation(),s.classList.remove(n),s=s.previousElementSibling;qo(s,l);)s=s.previousElementSibling;if(!s)for(s=t.children[t.children.length-1];s&&(s.classList.contains("fn__none")||!s.classList.contains(l));)s=s.previousElementSibling;if(!s)return;s.classList.add(n);const o=t.scrollTop>s.offsetTop-(((i=s.previousElementSibling)==null?void 0:i.clientHeight)||0);return(t.scrollTop<s.offsetTop-t.clientHeight+s.clientHeight||o)&&s.scrollIntoView(o),s}else if(e.key==="Home"){for(e.preventDefault(),e.stopPropagation(),s.classList.remove(n),s=t.children[0];qo(s,l);)s=s.nextElementSibling;return s?(s.classList.add(n),s.scrollIntoView(),s):void 0}else if(e.key==="End"){for(e.preventDefault(),e.stopPropagation(),s.classList.remove(n),s=t.children[t.children.length-1];qo(s,l);)s=s.previousElementSibling;return s?(s.classList.add(n),s.scrollIntoView(!1),s):void 0}},IA=(t,e,n="b3-list-item--focus",a)=>{var i,s;let l=t.querySelector("."+n);if(!l&&a){a.classList.add(n),a.scrollIntoView(!0);return}if(!l)return;const o=n.split("--")[0];if(e.key==="ArrowLeft"){e.preventDefault(),e.stopPropagation(),l.classList.remove(n),l.parentElement.classList.contains("b3-list")?l.querySelector(".b3-list-item__arrow--open")?(l.querySelector(".b3-list-item__arrow--open").classList.remove("b3-list-item__arrow--open"),l.nextElementSibling.classList.add("fn__none")):l=t.firstElementChild:l=l.parentElement.previousElementSibling,l.classList.add(n);const r=t.scrollTop>l.offsetTop-46-(((i=l.previousElementSibling)==null?void 0:i.clientHeight)||0);return(t.scrollTop<l.offsetTop-46-t.clientHeight+l.clientHeight||r)&&l.scrollIntoView(r),l}else{if(e.key==="ArrowRight")return e.preventDefault(),e.stopPropagation(),l.classList.remove(n),l.parentElement.classList.contains("b3-list")?l.querySelector(".b3-list-item__arrow--open")?l=l.nextElementSibling.firstElementChild:(l.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),l.nextElementSibling.classList.remove("fn__none")):l.nextElementSibling?l=l.nextElementSibling:l.parentElement.nextElementSibling&&(l=l.parentElement.nextElementSibling),l.classList.add(n),(t.scrollTop<l.offsetTop-46-t.clientHeight+l.clientHeight||t.scrollTop>l.offsetTop-46)&&l.scrollIntoView(t.scrollTop>l.offsetTop-46),l;if(e.key==="ArrowDown")return e.preventDefault(),e.stopPropagation(),l.classList.remove(n),l.nextElementSibling?(l=l.nextElementSibling,l.classList.contains(o)||(l.classList.contains("fn__none")?(l=l.nextElementSibling,l||(l=t.firstElementChild)):l=l.firstElementChild)):l=l.parentElement.nextElementSibling||t.firstElementChild,l.classList.add(n),(t.scrollTop<l.offsetTop-46-t.clientHeight+l.clientHeight||t.scrollTop>l.offsetTop-46)&&l.scrollIntoView(t.scrollTop>l.offsetTop-46),l;if(e.key==="ArrowUp"){e.preventDefault(),e.stopPropagation(),l.classList.remove(n),l.previousElementSibling?(l=l.previousElementSibling,l.classList.contains(o)||(l.classList.contains("fn__none")?l=l.previousElementSibling:l=l.lastElementChild)):l.parentElement.classList.contains("b3-list")?t.lastElementChild.classList.contains("fn__none")?l=t.lastElementChild.previousElementSibling:l=t.lastElementChild.lastElementChild:l=l.parentElement.previousElementSibling,l.classList.add(n);const r=t.scrollTop>l.offsetTop-46-(((s=l.previousElementSibling)==null?void 0:s.clientHeight)||0);return(t.scrollTop<l.offsetTop-46-t.clientHeight+l.clientHeight||r)&&l.scrollIntoView(r),l}else{if(e.key==="Home")return e.preventDefault(),e.stopPropagation(),l.classList.remove(n),l=t.children[0],l.classList.add(n),l.scrollIntoView(),l;if(e.key==="End")return e.preventDefault(),e.stopPropagation(),l.classList.remove(n),t.lastElementChild.classList.contains("fn__none")?l=t.lastElementChild.previousElementSibling:l=t.lastElementChild.lastElementChild,l.classList.add(n),l.scrollIntoView(!1),l}}},dw=t=>{const e=new $e({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
    <div class="b3-list fn__flex-1 b3-list--background fn__none protyle-hint" style="    position: absolute;
    width: calc(100% - 48px);">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_RENAMETAG);const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{A("/api/tag/renameTag",{oldLabel:t,newLabel:a.value},()=>{e.destroy(),nt("tag").data.tag.update()})});const a=e.element.querySelector("input");a.value=t,a.focus(),a.select();const i=e.element.querySelector(".b3-list--background");a.addEventListener("keydown",s=>{if(s.stopPropagation(),!s.isComposing){if(xn(i,s),s.key==="Escape")i.classList.contains("fn__none")?e.destroy():i.classList.add("fn__none"),s.preventDefault();else if(!s.shiftKey&&et(s)&&s.key==="Enter"){if(i.classList.contains("fn__none"))n[1].click();else{const l=i.querySelector(".b3-list-item--focus");a.value=l.dataset.type==="new"?l.querySelector("mark").textContent.trim():l.textContent.trim(),i.classList.add("fn__none")}s.preventDefault()}}}),a.addEventListener("input",s=>{s.stopPropagation(),i.classList.remove("fn__none"),A("/api/search/searchTag",{k:a.value.trim()},l=>{let o="",r=!1;l.data.tags.forEach((c,d)=>{o+=`<div class="b3-list-item${d===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${c}</div>
</div>`,c===`<mark>${l.data.k}</mark>`&&(r=!0)}),!r&&l.data.k&&(o=`<div data-type="new" class="b3-list-item${o?"":" b3-list-item--focus"}"><div class="fn__flex-1">${window.siyuan.languages.new} <mark>${he(l.data.k)}</mark></div></div>`+o),i.innerHTML=o})}),i.addEventListener("click",s=>{const l=s.target,o=T(l,"b3-list-item");o&&(a.value=o.dataset.type==="new"?o.querySelector("mark").textContent.trim():o.textContent.trim(),i.classList.add("fn__none"))})},uw=()=>De().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),ft=(t,e)=>{t&&A("/api/block/checkBlockFold",{id:t},n=>{e(n.data.isFolded,n.data.isFolded?[p.CB_GET_FOCUS,p.CB_GET_ALL]:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],n.data.isRoot)})},$A=()=>{let t;const e=nt("file");if(!e)return!1;t=e.data.file.element;const n=[];Object.keys(p.HELP_PATH).forEach(a=>{n.push(p.HELP_PATH[a])}),t.childNodes.forEach(a=>{a.querySelector('[data-type="addLocal"]')||n.includes(a.getAttribute("data-url"))||a.querySelector('[data-type="more-root"]').insertAdjacentHTML("beforebegin",`<span data-type="addLocal" class="b3-list-item__action">
    <svg><use xlink:href="#iconRiffCard"></use></svg>
</span>`)})};var MA=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Rf=t=>({id:"export",label:window.siyuan.languages.export,icon:"iconUpload",click(){return MA(this,null,function*(){O_(t)})}}),nh=(t,e,n,a,i=!1)=>{const s=[{id:"insertRight",icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:e.length===1?`${pe(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${pe("\u2325"+window.siyuan.languages.click)}`:void 0,click:()=>{n?ve({app:t,id:e[0],position:"right",action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]}):e.forEach(l=>{ft(l,(o,r)=>{ve({app:t,id:l,position:"right",action:r,zoomIn:o})})})}},{id:"insertBottom",icon:"iconLayoutBottom",label:window.siyuan.languages.insertBottom,accelerator:e.length===1?"\u21E7\u2318"+window.siyuan.languages.click:"",click:()=>{n?ve({app:t,id:e[0],position:"bottom",action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]}):e.forEach(l=>{ft(l,(o,r)=>{ve({app:t,id:l,position:"bottom",action:r,zoomIn:o})})})}}];if(window.siyuan.config.fileTree.openFilesUseCurrentTab&&s.push({id:"openInNewTab",label:window.siyuan.languages.openInNewTab,accelerator:e.length===1?"\u2325\u2318"+window.siyuan.languages.click:void 0,click:()=>{n?ve({app:t,id:e[0],action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL],removeCurrentTab:!1}):e.forEach(l=>{ft(l,(o,r)=>{ve({app:t,id:l,action:r,zoomIn:o,removeCurrentTab:!1})})})}}),s.push({id:"separator_1",type:"separator"}),s.push({id:"preview",icon:"iconPreview",label:window.siyuan.languages.preview,click:()=>{e.forEach(l=>{ve({app:t,id:l,mode:"preview"})})}}),i)return s;window.siyuan.menus.menu.append(new N({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:s}).element)},ah=t=>{if(ht())window.JSAndroid.writeImageClipboard(t);else{const e=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{e.width=a.target.width,e.height=a.target.height,e.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),e.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({"image/png":i})])},"image/png",1)},n.src=t}};var ih=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const PA=()=>ih(void 0,null,function*(){const t=yield Ae("/api/petal/loadPetals",{frontend:ie()});let e="";return t.data.forEach(n=>{e+=n.css||""}),e}),NA=t=>(["ant","material"].includes(window.siyuan.config.appearance.icon)?"":`<script src="${t}appearance/icons/material/icon.js?v=${p.SIYUAN_VERSION}"><\/script>`)+`<script src="${t}appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?v=${p.SIYUAN_VERSION}"><\/script>`,fw=t=>{if(["html","htmlmd"].includes(t.type)){const e=de(window.siyuan.languages.exporting,-1),n=t.type==="htmlmd"?"/api/export/exportMdHTML":"/api/export/exportHTML";A(n,{id:t.id,pdf:!1,removeAssets:!1,merge:!0,savePath:""},a=>ih(void 0,null,function*(){const i=yield pw(a,void 0,"",t);A("/api/export/exportBrowserHTML",{folder:a.data.folder,html:i,name:a.data.name},s=>{if(At(e),s.code===-1){de(window.siyuan.languages._kernel[14]+": "+s.msg,0,"error");return}window.open(s.data.zip),de(window.siyuan.languages.exported)})}));return}},HA=()=>{let t="";return document.querySelectorAll("style").forEach(e=>{e.id.startsWith("snippet")&&(t+=e.outerHTML)}),t},pw=(t,e,n,a,i)=>ih(void 0,null,function*(){let s=window.siyuan.config.appearance.themeLight,l=0;["html","htmlmd"].includes(a.type)&&window.siyuan.config.appearance.mode===1&&(s=window.siyuan.config.appearance.themeDark,l=1);const o=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let r="";o||(r=`<link rel="stylesheet" type="text/css" id="themeStyle" href="${n}appearance/themes/${s}/theme.css?${p.SIYUAN_VERSION}"/>`);const c=q_(),d=ht()||bt()?{js:`document.body.style.minWidth = "${c}px";`,css:`@page { size: A4; margin: 10mm 0 10mm 0; }
.protyle-wysiwyg {padding: 0; margin: 0;}`}:{js:"",css:""},u=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="${OE()}" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <base href="${n}">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="${n}stage/build/export/base.css?v=${p.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="${n}appearance/themes/${s}/theme.css?v=${p.SIYUAN_VERSION}"/>
    <script src="${n}stage/protyle/js/protyle-html.js?v=${p.SIYUAN_VERSION}"><\/script>
    ${r}
    <title>${t.data.name}</title>
    <!-- Exported by SiYuan v${p.SIYUAN_VERSION} -->
    <style>
        body {font-family: var(--b3-font-family);background-color: var(--b3-theme-background);color: var(--b3-theme-on-background)}
        ${yield td(!1,n)}
        ${yield PA()}
        ${d.css}
    </style>
    ${HA()}
</head>
<body>
<div class="${["htmlmd","word"].includes(a.type)?"b3-typography":"protyle-wysiwyg"+(window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":"")}" 
style="max-width: 800px;margin: 0 auto;" id="preview">${t.data.content}</div>
${NA(n)}
<script src="${n}stage/build/export/protyle-method.js?v=${p.SIYUAN_VERSION}"><\/script>
<script src="${n}stage/protyle/js/lute/lute.min.js?v=${p.SIYUAN_VERSION}"><\/script>  
<script>
    ${d.js}
    window.siyuan = {
      config: {
        appearance: { mode: ${l}, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
        editor: { 
          codeLineWrap: true,
          fontSize: ${window.siyuan.config.editor.fontSize},
          codeLigatures: ${window.siyuan.config.editor.codeLigatures},
          plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
          codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
          katexMacros: decodeURI(\`${encodeURI(window.siyuan.config.editor.katexMacros)}\`),
        }
      },
      languages: {copy:"${window.siyuan.languages.copy}"}
    };
    const previewElement = document.getElementById('preview');
    Protyle.highlightRender(previewElement, "stage/protyle");
    Protyle.mathRender(previewElement, "stage/protyle", ${a.type==="pdf"});
    Protyle.mermaidRender(previewElement, "stage/protyle");
    Protyle.flowchartRender(previewElement, "stage/protyle");
    Protyle.graphvizRender(previewElement, "stage/protyle");
    Protyle.chartRender(previewElement, "stage/protyle");
    Protyle.mindmapRender(previewElement, "stage/protyle");
    Protyle.abcRender(previewElement, "stage/protyle");
    Protyle.htmlRender(previewElement);
    Protyle.plantumlRender(previewElement, "stage/protyle");
    document.querySelectorAll(".protyle-action__copy").forEach((item) => {
      item.addEventListener("click", (event) => {
            let text = item.parentElement.nextElementSibling.textContent.trimEnd();
            text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying
            navigator.clipboard.writeText(text);
            event.preventDefault();
            event.stopPropagation();
      })
    });
<\/script></body></html>`;if(typeof e=="undefined")return u}),qf=(t,e="outerHTML")=>{if(!t.querySelector("[data-type='block-render']"))return t[e];const n=t.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),n[e]},OA=t=>{const e=document.createElement("template");return e.innerHTML=t,e.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{T(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.innerHTML},wi=(t,e,n)=>{if(Y())return;const a=e.getBoundingClientRect();if(a.height===0||!t){cn();return}const i=document.getElementById("tooltip");i.className=n?`tooltip tooltip--${n}`:"tooltip",i.innerHTML=t,i.removeAttribute("style");const s=e.getAttribute("data-position"),l=e.parentElement.getBoundingClientRect();let o,r;if(s==="parentE")r=Math.max(0,l.top-(i.clientHeight-l.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),o=l.right+8,o+i.clientWidth>window.innerWidth&&(o=l.left-i.clientWidth-8);else if(s==="parentW")r=Math.max(0,l.top-(i.clientHeight-l.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),o=l.left-i.clientWidth,o<0&&(o=l.right);else if(s!=null&&s.endsWith("west")){const c=parseInt(s)||.5;r=Math.max(0,a.top-(i.clientHeight-a.height)/2),r>window.innerHeight-i.clientHeight&&(r=window.innerHeight-i.clientHeight),o=a.left-i.clientWidth-c,o<0&&(o=a.right)}else if(s==="north")o=Math.max(0,a.left-(i.clientWidth-a.width)/2),r=a.top-i.clientHeight-.5,r<0&&(a.top<window.innerHeight-a.bottom?(r=a.bottom+.5,i.style.maxHeight=window.innerHeight-r+"px"):(r=0,i.style.maxHeight=a.top-.5+"px")),o+i.clientWidth>window.innerWidth&&(o=window.innerWidth-i.clientWidth);else{const c=parseInt(s)||.5;o=Math.max(0,a.left-(i.clientWidth-a.width)/2),r=a.bottom+c,r+i.clientHeight>window.innerHeight&&(a.top-c>window.innerHeight-r?(r=a.top-c-i.clientHeight,i.style.maxHeight=a.top-c+"px"):i.style.maxHeight=window.innerHeight-r+"px"),o+i.clientWidth>window.innerWidth&&(o=window.innerWidth-i.clientWidth)}i.style.top=r+"px",i.style.left=o+"px"},cn=()=>{document.getElementById("tooltip").classList.add("fn__none")},Ff=(t,e)=>/\r\n|\r|\n|\u2028|\u2029|\t/.test(t)?(e?wi(window.siyuan.languages.fileNameRule,e,"error"):de(window.siyuan.languages.fileNameRule),!1):t.length>p.SIZE_TITLE?(e?wi(window.siyuan.languages._kernel[106],e,"error"):de(window.siyuan.languages._kernel[106]),!1):!0,oa=t=>(t.indexOf("/")>-1&&(de(window.siyuan.languages.fileNameRule),t=t.replace(/\//g,"\uFF0F")),t.replace(/\r\n|\r|\n|\u2028|\u2029|\t|/g,"").substring(0,p.SIZE_TITLE)),gD=t=>t.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),sh=t=>{if(window.siyuan.config.readonly)return;const e=new $e({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px",destroyCallback(){t.range&&ne(t.range)}});e.element.setAttribute("data-key",p.DIALOG_RENAME);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(t.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(!Ff(n.value))return!1;if(n.value===t.name)return e.destroy(),!1;n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=oa(n.value),t.type==="notebook"?A("/api/notebook/renameNotebook",{notebook:t.notebookId,name:n.value},()=>{EA(t.notebookId,n.value)}):A("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n.value}),e.destroy()})},Uf=t=>{const e=new $e({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_RENAMEASSETS);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()});const i=Bf(t);n.value=i,n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(n.value===i||!n.value)return e.destroy(),!1;A("/api/asset/renameAsset",{oldPath:t,newName:n.value},s=>{Oe().asset.forEach(l=>{l.path===t&&(l.path=s.data.newPath,l.parent.updateTitle(xt(s.data.newPath)))}),qn().forEach(l=>{l.reload(!1)}),e.destroy()})})},BA=t=>{if(getSelection().rangeCount===0)return;const e=getSelection().getRangeAt(0),n=B(e.startContainer);if(!n)return;let a=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let i="",s=e.toString();if(s===""){if(s=a[0].textContent,a.forEach(l=>{i+=qf(l)}),!s)return}else{const l=document.createElement("div");l.appendChild(e.cloneContents()),i=l.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=oa(s),A("/api/filetree/createDoc",{notebook:t.notebookId,path:De().join(xt(t.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:t.lute.BlockDOM2StdMd(i)})};var gw=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const mD=(t,e)=>{},RA=t=>{const e=new $e({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${Y()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${Y()?"margin: 8px 0":"padding: 48px;margin: 8px 0"}" class="export-img">
        <div ${Y()?'style="padding:8px"':""} class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:Y()?"92vw":"990px",height:"70vh"});e.element.setAttribute("data-key",p.DIALOG_EXPORTIMAGE);const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>gw(void 0,null,function*(){const r=de(window.siyuan.languages.exporting,0),c=e.element.querySelector(".b3-dialog__container");c.style.height="";const d=e.element.querySelector(".b3-dialog__content");d.style.overflow="hidden",Ee(p.LOCAL_EXPORTIMG,window.siyuan.storage[p.LOCAL_EXPORTIMG]);const u=a.querySelectorAll("[data-subtype='plantuml']");for(let m=0;m<u.length;m++){const f=u[m].querySelector("object");if(f){const h=yield(yield fetch(f.getAttribute("data"))).text();f.insertAdjacentHTML("beforebegin",h),f.remove()}}a.querySelectorAll(".protyle-linenumber__rows span").forEach((m,f)=>{m.textContent=(f+1).toString()}),setTimeout(()=>{jt("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>gw(void 0,null,function*(){let m=yield window.htmlToImage.toBlob(e.element.querySelector(".b3-dialog__content"));(If()||B_())&&(yield window.htmlToImage.toBlob(d),yield window.htmlToImage.toBlob(d),yield window.htmlToImage.toBlob(d),m=yield window.htmlToImage.toBlob(d));const f=new FormData;f.append("file",m,n[1].getAttribute("data-title")),f.append("type","image/png"),A("/api/export/exportAsFile",f,g=>{nn(g.data.file)}),At(r),e.destroy()}))},p.TIMEOUT_LOAD)}));const a=e.element.querySelector(".protyle-wysiwyg"),i=e.element.querySelector("#keepFold");i.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[p.LOCAL_EXPORTIMG].keepFold=i.checked,A("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},r=>{o(r)})});const s=e.element.querySelector("#watermark");s.addEventListener("change",()=>{window.siyuan.storage[p.LOCAL_EXPORTIMG].watermark=s.checked,l()});const l=()=>{const r=e.element.querySelector(".export-img__watermark");r.innerHTML="",s.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):jt("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>{const c=Math.max(e.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${c}px;height: ${c}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.htmlToImage.toCanvas(r).then(d=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${d.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},o=r=>{a.innerHTML=r.data.content,a.setAttribute("data-doc-type",r.data.type||"NodeDocument"),Object.keys(r.data.attrs).forEach(c=>{a.setAttribute(c,r.data.attrs[c])}),a.querySelectorAll(".code-block").forEach(c=>{c.setAttribute("linewrap","true")}),Ct(a),rt(a),a.querySelectorAll("table").forEach(c=>{c.clientWidth>c.parentElement.clientWidth&&(c.setAttribute("style",`margin-bottom:${c.parentElement.clientWidth*c.clientHeight/c.clientWidth-c.parentElement.clientHeight+1}px;transform: scale(${c.parentElement.clientWidth/c.clientWidth});transform-origin: top left;`),c.parentElement.style.overflow="hidden")}),l(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),e.element.querySelector(".fn__loading").remove()};A("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},r=>{o(r),n[1].setAttribute("data-title",r.data.name+".png")})},lh=(t,e,n)=>{if(t.getAttribute("custom-pinthead")==="true"){const a=t.querySelector("table");a.clientHeight+a.scrollTop<e.offsetTop+e.clientHeight?a.scrollTop=e.offsetTop-a.clientHeight+e.clientHeight+1:a.scrollTop>e.offsetTop-e.clientHeight&&(a.scrollTop=e.offsetTop-e.clientHeight+1)}else Ye(n,e)},Oa=t=>{let e=t.previousElementSibling,n=0;for(;e;)n++,e=e.previousElementSibling;return n},mw=(t,e,n=!0)=>{let a=t.previousElementSibling;return a||(t.parentElement.previousElementSibling?a=t.parentElement.previousElementSibling.lastElementChild:t.parentElement.parentElement.tagName==="TBODY"&&t.parentElement.parentElement.previousElementSibling?a=t.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(e.selectNodeContents(a),n||e.collapse(!1),ne(e)),a},ei=(t,e,n,a,i)=>{i.insertNode(document.createElement("wbr"));const s=n.outerHTML,l=n.querySelector("table"),o=l.rows[0].cells.length,r=l.rows.length,c=[];for(let d=0;d<r;d++){for(let u=0;u<o;u++)l.rows[d].cells[u]===e[c.length]&&c.push(u);if(c.length>0)break}for(let d=0;d<r;d++)c.forEach(u=>{l.rows[d].cells[u].setAttribute("align",a)});le(t,n.getAttribute("data-node-id"),n.outerHTML,s),we(l,i)},oh=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let l="";for(let r=0;r<n.parentElement.childElementCount;r++)l+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let o;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${l}</tr>`),o=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${l}</tr></tbody>`),o=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${l}</tr>`),o=n.parentElement.nextElementSibling;e.selectNodeContents(o.cells[Oa(n)]),e.collapse(!0),ne(e),le(t,a.getAttribute("data-node-id"),a.outerHTML,s),lh(a,o,t)},hw=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let l="",o=!1;for(let c=0;c<n.parentElement.childElementCount;c++){const d=n.parentElement.children[c];d.className==="fn__none"&&(o=!0),n.tagName==="TH"?l+=`<th class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></th>`:l+=`<td class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></td>`}if(o){let c=n.parentElement.previousElementSibling,d=1;for(;c;)d++,Array.from(c.children).forEach(u=>{u.rowSpan>=d&&u.rowSpan>1&&(u.rowSpan=u.rowSpan+1)}),c=c.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${l}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML.replace(/<th/g,"<td").replace(/<\/th>/g,"</td>")),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${l}</tr>`),r=n.parentElement.previousElementSibling),e.selectNodeContents(r.cells[Oa(n)]),e.collapse(!0),ne(e),le(t,a.getAttribute("data-node-id"),a.outerHTML,s),lh(a,r,t)},Wf=(t,e,n,a,i)=>{const s=document.createElement("wbr");i.insertNode(s);const l=e.outerHTML;s.remove();const o=Oa(n),r=e.querySelector("table");for(let c=0;c<r.rows.length;c++){const d=r.rows[c].cells[o],u=document.createElement(d.tagName);d.insertAdjacentElement(a,u),d===n?(u.innerHTML="<wbr> ",u.offsetLeft+u.clientWidth>e.firstElementChild.scrollLeft+e.firstElementChild.clientWidth&&(e.firstElementChild.scrollLeft=u.offsetLeft+u.clientWidth-e.firstElementChild.clientWidth)):u.textContent=" "}r.querySelectorAll("col")[o].insertAdjacentHTML(a,"<col style='min-width: 60px;'>"),we(e,i),le(t,e.getAttribute("data-node-id"),e.outerHTML,l)},bw=(t,e,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();const l=Oa(n),o=n.parentElement.parentElement;let r=o.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),o.childElementCount===1?o.remove():n.parentElement.remove(),e.selectNodeContents(r.cells[l]),e.collapse(!0),ne(e),lh(a,r,t),le(t,a.getAttribute("data-node-id"),a.outerHTML,s)}},yw=(t,e,n,a)=>{var i;const s=document.createElement("wbr");e.insertNode(s);const l=n.outerHTML;s.remove();const o=Oa(a),r=a.previousElementSibling||a.nextElementSibling;if(r)e.selectNodeContents(r),e.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth);else{n.classList.add("protyle-wysiwyg--select"),Ea(t,n,e,"remove");return}const c=n.querySelector("table");for(let d=0;d<c.rows.length;d++){const u=c.rows[d].cells;if(u.length===1){c.remove();break}u[o].remove()}(i=n.querySelectorAll("col")[o])==null||i.remove(),le(t,n.getAttribute("data-node-id"),n.outerHTML,l),ne(e)},_w=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="THEAD")return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const l=i.parentElement.previousElementSibling.firstElementChild;l.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.after(l),i.parentElement.previousElementSibling.append(i)}le(t,a.getAttribute("data-node-id"),a.outerHTML,s),we(a,e),Ye(t,i)},ww=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const l=i.parentElement.nextElementSibling.firstElementChild;l.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.after(l),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}le(t,a.getAttribute("data-node-id"),a.outerHTML,s),we(a,e),Ye(t,i)},vw=(t,e,n,a)=>{if(!n.previousElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((o,r)=>{if(n===o)return s=r,!0}),a.querySelectorAll("tr").forEach(o=>{o.cells[s].after(o.cells[s-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const l=a.querySelectorAll("col");l[s].after(l[s-1]),le(t,a.getAttribute("data-node-id"),a.outerHTML,i),we(a,e)},Ew=(t,e,n,a)=>{if(!n.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((o,r)=>{if(n===o)return s=r,!0}),a.querySelectorAll("tr").forEach(o=>{o.cells[s].before(o.cells[s+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const l=a.querySelectorAll("col");l[s].before(l[s+1]),le(t,a.getAttribute("data-node-id"),a.outerHTML,i),we(a,e)},qA=(t,e,n)=>{var a,i;const s=U(n.startContainer,"TD")||U(n.startContainer,"TH"),l=B(n.startContainer);if(!s||!l)return!1;if(e.key==="Backspace"&&n.toString()===""){const k=pt(n.startContainer);if(n.startOffset===1&&k.nodeType===1&&k.tagName==="BR"&&n.startContainer.textContent.length===1&&!Ge(n.startContainer))return k.insertAdjacentHTML("beforebegin","<br>"),!1}if(e.key==="Enter"&&e.shiftKey&&et(e)&&!e.altKey){const k=document.createElement("wbr");n.insertNode(k);const _=l.outerHTML;if(k.remove(),s&&!s.innerHTML.endsWith("<br>")&&s.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),t.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const S=document.createElement("br");n.startContainer.after(S),n.setStartAfter(S)}else n.insertNode(document.createElement("br"));return n.collapse(!1),Ye(t),le(t,l.getAttribute("data-node-id"),l.outerHTML,_),e.preventDefault(),!0}if(!l.classList.contains("protyle-wysiwyg--select")&&!T(l,"protyle-wysiwyg--select")){if(et(e)&&!e.shiftKey&&!e.altKey&&e.key==="Enter"){e.preventDefault();const k=s.parentElement;if(!k.nextElementSibling&&k.parentElement.tagName==="TBODY"||k.parentElement.tagName==="THEAD"&&!k.parentElement.nextElementSibling)return Gn(t,"afterend",l.getAttribute("data-node-id")),!0;let _=k.nextElementSibling;return _||(_=k.parentElement.nextElementSibling.firstChild),_&&(n.selectNodeContents(_.cells[Oa(s)]),n.collapse(!0),Ye(t)),!0}if(e.key==="ArrowRight"&&n.toString()===""&&!l.nextElementSibling&&s===l.querySelector("table").lastElementChild.lastElementChild.lastElementChild&&_t(s,t.wysiwyg.element,n).start===s.textContent.length)return e.preventDefault(),Gn(t,"afterend",l.getAttribute("data-node-id")),!0;if(e.key==="Tab"&&et(e)){if(e.shiftKey)return mw(s,n),e.preventDefault(),!0;let k=s.nextElementSibling;return k||(s.parentElement.nextElementSibling?k=s.parentElement.nextElementSibling.firstElementChild:s.parentElement.parentElement.tagName==="THEAD"&&s.parentElement.parentElement.nextElementSibling?k=s.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:k=null),k?n.selectNodeContents(k):oh(t,n,s.parentElement.firstElementChild,l),e.preventDefault(),!0}if(e.key==="ArrowUp"&&et(e)&&!e.shiftKey&&!e.altKey){const k=n.startContainer;let _;for(k.nodeType!==3&&(k.tagName==="TH"||k.tagName==="TD")?_=k.childNodes[Math.min(n.startOffset,k.childNodes.length-1)]:k.parentElement.tagName==="SPAN"?_=k.parentElement.previousElementSibling:_=k.previousElementSibling;_;){if(_.tagName==="BR"&&pt(_))return!1;_=_.previousElementSibling}const v=s.parentElement;let S=v.previousElementSibling;return S||(S=v.parentElement.previousElementSibling.lastElementChild),!S||(S==null?void 0:S.tagName)==="COL"?!1:(n.selectNodeContents(S.cells[Oa(s)]),n.collapse(!1),Ye(t),e.preventDefault(),!0)}if(e.key==="ArrowDown"&&et(e)&&!e.shiftKey&&!e.altKey){const k=n.endContainer;let _;for(k.nodeType!==3&&(k.tagName==="TH"||k.tagName==="TD")?_=(a=k.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:a.nextElementSibling:k.parentElement.tagName==="SPAN"?_=k.parentElement.nextElementSibling:_=k.nextElementSibling;_;){if(_.tagName==="BR"&&_.nextSibling)return!1;_=_.nextElementSibling}const v=s.parentElement;if(!v.nextElementSibling&&v.parentElement.tagName==="TBODY"||v.parentElement.tagName==="THEAD"&&!v.parentElement.nextElementSibling)return!1;let S=v.nextElementSibling;return S||(S=v.parentElement.nextElementSibling.firstChild),S?(n.selectNodeContents(S.cells[Oa(s)]),n.collapse(!0),Ye(t),e.preventDefault(),!0):!1}if(et(e)&&!e.shiftKey&&!e.altKey&&e.key==="Backspace"&&_t(s,t.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&s.querySelectorAll("br").length===1))return!mw(s,n,!1)&&l.previousElementSibling&&oe(l.previousElementSibling,void 0,!1),Ye(t),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.alignLeft.custom,e))return ei(t,[s],l,"left",n),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.alignCenter.custom,e))return ei(t,[s],l,"center",n),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.alignRight.custom,e))return ei(t,[s],l,"right",n),e.preventDefault(),!0}const o=l.querySelector("table"),r=s.parentElement.querySelector(".fn__none");let c=!1,d=!1;Array.from(s.parentElement.children).forEach(k=>{k.colSpan>1&&(c=!0),k.rowSpan>1&&(d=!0)});let u=!1,m=!1,f=!1,g=s.parentElement.previousElementSibling;!g&&s.parentElement.parentElement.tagName==="TBODY"&&(g=o.querySelector("thead").lastElementChild),g&&(u=g.querySelector(".fn__none"),Array.from(g.children).forEach(k=>{k.colSpan>1&&(m=!0),k.rowSpan>1&&(f=!0)}));let h=!1,b=!1,y=!1,w=s.parentElement.nextElementSibling;!w&&s.parentElement.parentElement.tagName==="THEAD"&&(w=(i=o.querySelector("tbody"))==null?void 0:i.firstElementChild),w&&(h=w.querySelector(".fn__none"),Array.from(w.children).forEach(k=>{k.colSpan>1&&(b=!0),k.rowSpan>1&&(y=!0)}));const E=Oa(s);let C=!0;Array.from(o.rows).find(k=>{const _=k.cells[E];if(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1)return C=!1,!0});let $=!0;Array.from(o.rows).find(k=>{const _=k.cells[E+1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return $=!1,!0});let M=!0;if(Array.from(o.rows).find(k=>{const _=k.cells[E-1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return M=!1,!0}),W(window.siyuan.config.keymap.editor.table.moveToUp.custom,e))return(!r||r&&!d&&c)&&(!u||u&&!f&&m)&&_w(t,n,s,l),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table.moveToDown.custom,e))return(!r||r&&!d&&c)&&(!h||h&&!y&&b)&&ww(t,n,s,l),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table.moveToLeft.custom,e))return C&&M&&vw(t,n,s,l),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table.moveToRight.custom,e))return C&&$&&Ew(t,n,s,l),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,e))return hw(t,n,s,l),e.preventDefault(),e.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,e))return(!h||h&&!y&&b)&&oh(t,n,s,l),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,e))return(C||M)&&Wf(t,l,s,"beforebegin",n),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,e))return(C||$)&&Wf(t,l,s,"afterend",n),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.table["delete-row"].custom,e))return(!r&&!d||r&&!d&&c)&&bw(t,n,s,l),e.preventDefault(),e.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.table["delete-column"].custom,e))return C&&yw(t,n,l,s),e.preventDefault(),!0},vi=t=>t.item.offsetLeft+6>t.tableSelectElement.offsetLeft+t.scrollLeft&&t.item.offsetLeft+t.item.clientWidth-6<t.tableSelectElement.offsetLeft+t.scrollLeft+t.tableSelectElement.clientWidth&&t.item.offsetTop+6>t.tableSelectElement.offsetTop+t.scrollTop&&t.item.offsetTop+t.item.clientHeight-6<t.tableSelectElement.offsetTop+t.scrollTop+t.tableSelectElement.clientHeight,kw=(t,e)=>{var n;if(!e)return;const a=e.querySelector(".table__select"),i=[],s=e.firstElementChild.scrollLeft,l=e.querySelector("table").scrollTop;if(e.querySelectorAll("th, td").forEach(r=>{!r.classList.contains("fn__none")&&vi({tableSelectElement:a,scrollLeft:s,scrollTop:l,item:r})&&i.push(r)}),a.removeAttribute("style"),getSelection().rangeCount>0){const r=getSelection().getRangeAt(0);e.contains(r.startContainer)&&r.insertNode(document.createElement("wbr"))}const o=e.outerHTML;(n=e.querySelector("wbr"))==null||n.remove(),e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),i.forEach(r=>{r.innerHTML=""}),le(t,e.getAttribute("data-node-id"),e.outerHTML,o)},ra=(t,e=0,n=1e3)=>{t.scroll.lastScrollTop=-1,setTimeout(()=>{t.scroll.lastScrollTop=e},n)};var Vf=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Sw=t=>{const e=t.dataset.type;let n="";if(["NodeHeading","NodeParagraph"].includes(e))n=fe(t).innerHTML;else if(e==="NodeHTMLBlock")n="HTML";else if(e==="NodeAttributeView")n=t.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(e==="NodeThematicBreak")n=window.siyuan.languages.line;else if(e==="NodeIFrame")n="IFrame";else if(e==="NodeWidget")n=window.siyuan.languages.widget;else if(e==="NodeVideo")n=window.siyuan.languages.video;else if(e==="NodeAudio")n=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(e))n=Sc(t);else if(t.classList.contains("render-node"))n+=t.dataset.subtype||Lute.UnEscapeHTMLStr(t.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(e)&&(Array.from(t.querySelectorAll("[data-node-id]")).find(a=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a.getAttribute("data-type")))return n=Sw(t.querySelector("[data-node-id]")),!0}),n))return n;return n+` <span data-type="block-ref" data-subtype="s" data-id="${t.getAttribute("data-node-id")}">*</span>`},Sc=(t,e=!1)=>{let n="";const a=t.dataset.type;return a==="NodeHTMLBlock"?n+=Lute.UnEscapeHTMLStr(t.querySelector("protyle-html").getAttribute("data-content")):a==="NodeAttributeView"?(t.querySelectorAll(".av__row").forEach(i=>{i.querySelectorAll(".av__cell").forEach(s=>{n+=Bl(s)+" "}),n+=`
`}),n=n.trimEnd()):a==="NodeThematicBreak"?n+="---":a==="NodeIFrame"||a==="NodeWidget"?n+=t.querySelector("iframe").getAttribute("src"):a==="NodeVideo"?n+=t.querySelector("video").getAttribute("src"):a==="NodeAudio"?n+=t.querySelector("audio").getAttribute("src"):t.classList.contains("render-node")?n+=Lute.UnEscapeHTMLStr(t.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock"].includes(a)?n+=t.querySelector("[spellcheck]").textContent:a==="NodeTable"?(t.querySelectorAll("th, td").forEach(i=>{n+=i.textContent.trim()+"	",i.nextElementSibling||(n=n.slice(0,-1)+`
`)}),n=n.slice(0,-1)):!e&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a)&&t.querySelectorAll("[data-node-id]").forEach(i=>{const s=Sc(i,!0);n+=s?s+`
`:""}),n},Lw=(t,e)=>Vf(void 0,null,function*(){try{let n=(yield Bo())||"";n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),Uo(t,{textPlain:n,textHTML:"",target:e})}catch(n){console.log(n)}}),rh=t=>Vf(void 0,null,function*(){if([].length===0){let n=(yield Bo())||"";if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(j(i.startContainer,"data-type","code")||T(i.startContainer,"hljs")){Ht(n.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),t);return}}n=n.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),n=n.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),n=n.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),n=n.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),n=n.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),n=n.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),n=n.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),n=n.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u>"),Lc(t);const a=t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(n));Fo(t),Ht(a,t,!1,!1,!0)}}),Lc=t=>{t.lute.SetInlineAsterisk(!0),t.lute.SetGFMStrikethrough(!0),t.lute.SetInlineMath(!0),t.lute.SetSub(!0),t.lute.SetSup(!0),t.lute.SetTag(!0),t.lute.SetInlineUnderscore(!0)},Fo=t=>{t.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),t.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),t.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),t.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),t.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),t.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),t.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),t.lute.SetMark(window.siyuan.config.editor.markdown.inlineMark)},FA=(t,e)=>Vf(void 0,null,function*(){if(t&&t.app&&t.app.plugins)for(let n=0;n<t.app.plugins.length;n++){const a=yield new Promise(i=>{t.app.plugins[n].eventBus.emit("paste",{protyle:t,resolve:i,textHTML:"",textPlain:"",siyuanHTML:"",files:e})&&i(void 0)});a!=null&&a.files&&(e=a.files)}Yh(e,t,!0)}),Uo=(t,e)=>Vf(void 0,null,function*(){var n;("clipboardData"in e||"dataTransfer"in e)&&(e.stopPropagation(),e.preventDefault());let a,i,s,l;if("clipboardData"in e)a=e.clipboardData.getData("text/html"),i=e.clipboardData.getData("text/plain"),s=e.clipboardData.getData("text/siyuan"),l=e.clipboardData.files;else if("dataTransfer"in e)a=e.dataTransfer.getData("text/html"),i=e.dataTransfer.getData("text/plain"),s=e.dataTransfer.getData("text/siyuan"),e.dataTransfer.types[0]==="Files"&&(l=e.dataTransfer.items);else{if(((n=e.localFiles)==null?void 0:n.length)>0){FA(t,e.localFiles);return}a=e.textHTML,i=e.textPlain,s=e.siyuanHTML,l=e.files}if(i=i.replace(/\r\n|\r|\u2028|\u2029/g,`
`),(a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${i}">${i}</a>`||a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${i}">${i}</a><!--EndFragment-->`)&&(a=""),i.endsWith(p.ZWSP)&&!a&&!s&&(s=i.substr(0,i.length-1)),a&&i&&!s){const u=mc(a);s=u.textSiyuan,a=u.textHtml}if(!s){const u=new DOMParser().parseFromString(a,"text/html");u.body&&u.body.innerHTML&&(a=u.body.innerHTML),a.startsWith(`
<!--StartFragment-->`)&&a.endsWith(`<!--EndFragment-->

`)&&(a=u.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),a=Lute.Sanitize(a)}if(t&&t.app&&t.app.plugins)for(let u=0;u<t.app.plugins.length;u++){const m=yield new Promise(f=>{t.app.plugins[u].eventBus.emit("paste",{protyle:t,resolve:f,textHTML:a,textPlain:i,siyuanHTML:s,files:l})&&f(void 0)});m!=null&&m.textHTML&&(a=m.textHTML),m!=null&&m.textPlain&&(i=m.textPlain),m!=null&&m.siyuanHTML&&(s=m.siyuanHTML),m!=null&&m.files&&(l=m.files)}const o=B(e.target);if(!o){l&&l.length>0&&Ai(t,l);return}t.hint.enableExtend=p.BLOCK_HINT_KEYS.includes(t.hint.splitChar),ce(t.hint.enableExtend?["select"]:["select","hint"],t),t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(u=>{u.classList.remove("protyle-wysiwyg--hl")});const r=LA(a,i,t),c=ke(t.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||t.toolbar.getCurrentType(c).includes("code")){Ht(i.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),t);return}else if(s){const u=document.createElement("div");if(u.innerHTML=s,c.toString()){let g=[],h;if(u.childNodes.length===1&&u.childElementCount===1&&(g=(u.firstElementChild.getAttribute("data-type")||"").split(" "),(g.includes("block-ref")||g.includes("a"))&&(h=u.firstElementChild)),!h){const b=document.createElement("template");b.innerHTML=t.lute.SpinBlockDOM(s),b.content.firstChild.nodeType!==3&&b.content.firstElementChild.classList.contains("p")&&(b.innerHTML=b.content.firstElementChild.firstElementChild.innerHTML.trim()),b.content.childNodes.length===1&&b.content.childElementCount===1&&(g=(b.content.firstElementChild.getAttribute("data-type")||"").split(" "),(g.includes("block-ref")||g.includes("a"))&&(h=b.content.firstElementChild))}if(g.includes("block-ref")){const b=t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${h.dataset.id}${p.ZWSP}s${p.ZWSP}${c.toString()}`});b[0]&&t.toolbar.range.selectNodeContents(b[0]);return}if(g.includes("a")){t.toolbar.setInlineMark(t,"a","range",{type:"a",color:`${h.dataset.href}${p.ZWSP}${c.toString()}`});return}}let m=!1;u.querySelectorAll("[data-node-id]").forEach(g=>{const h=Lute.NewNodeID();g.setAttribute("data-node-id",h),g.removeAttribute(p.CUSTOM_RIFF_DECKS),g.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),g.setAttribute("updated",h.split("-")[0]),g.removeAttribute("refcount"),m=!0}),o.classList.contains("table")&&(m=!1),u.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(g=>{g.setAttribute("contenteditable","true")});let f=u.innerHTML;if(!o.classList.contains("av")&&f.startsWith("[[{")&&f.endsWith("}]]"))try{const g=JSON.parse(f);g.length>0&&g[0].length>0&&g[0][0].id&&g[0][0].type?Ht(i,t,m):Ht(f,t,m)}catch(g){Ht(f,t,m)}else-1<f.indexOf("NodeHTMLBlock")&&(f=Lute.UnEscapeHTMLStr(f)),f=f.replace(/\u200D```/g,"```"),Ht(f,t,m,!1,!0);We(t,t.wysiwyg.element),Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t)}else if(r)r.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(Ht(r,t,!0,!1,!0),rt(t.wysiwyg.element)):Ht(r,t),ce(["hint"],t);else{let u=!1;if(a.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""){a=a.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),l&&l.length===1&&(a.startsWith("<img")||a.startsWith("<table")&&a.indexOf("<img")>-1)?u=!1:u=!0;let m=!1;const f=document.createElement("div");f.innerHTML=a;const g=document.createTreeWalker(f,NodeFilter.SHOW_TEXT,null);let h=null;for(;h=g.nextNode();)if(h.nodeValue&&(h.nodeValue.match(/\n/g)||[]).length>=2){m=!0;break}const b=a.toLowerCase();i&&i.trim()!==""&&(a.startsWith("<span")||a.startsWith("<br"))&&m&&0>b.indexOf('class="katex')&&0>b.indexOf('class="math')&&0>b.indexOf("</a>")&&0>b.indexOf("</img>")&&0>b.indexOf("</code>")&&0>b.indexOf("</b>")&&0>b.indexOf("</strong>")&&0>b.indexOf("</i>")&&0>b.indexOf("</em>")&&0>b.indexOf("</ol>")&&0>b.indexOf("</ul>")&&0>b.indexOf("</table>")&&0>b.indexOf("</blockquote>")&&0>b.indexOf("</h1>")&&0>b.indexOf("</h2>")&&0>b.indexOf("</h3>")&&0>b.indexOf("</h4>")&&0>b.indexOf("</h5>")&&0>b.indexOf("</h6>")&&(u=!1)}if(u){const m=document.createElement("div");m.innerHTML=a,m.querySelectorAll("a").forEach(g=>{g.innerHTML.trim()===""&&g.remove()});let f;if(m.childElementCount===1&&m.childNodes.length===1&&(m.firstElementChild.tagName==="A"?f=m.firstElementChild:m.firstElementChild.tagName==="P"&&m.firstElementChild.childElementCount===1&&m.firstElementChild.childNodes.length===1&&m.firstElementChild.firstElementChild.tagName==="A"&&(f=m.firstElementChild.firstElementChild)),f){const g=c.toString(),h=t.toolbar.setInlineMark(t,"a","range",{type:"a",color:`${f.getAttribute("href")}${p.ZWSP}${g||f.textContent}`});g||(h[0].lastChild&&c.setEnd(h[0].lastChild,h[0].lastChild.textContent.length),c.collapse(!1));return}A("/api/lute/html2BlockDOM",{dom:m.innerHTML},g=>{Ht(g.data,t,!1,!1,!0),t.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(h=>{h.textContent===""&&A("/api/block/getRefText",{id:h.getAttribute("data-id")},b=>{h.innerHTML=b.data})}),We(t,t.wysiwyg.element),Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t),Ye(t,void 0,"nearest","smooth")});return}else if(l&&l.length>0){Ai(t,l);return}else if(i.trim()!==""&&(l&&l.length===0||!l)){if(c.toString()!==""){const f=i.split(`
`)[0];if(pn(i)){const g=t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${i.substring(2,24)}${p.ZWSP}s${p.ZWSP}${c.toString()}`});g[0]&&t.toolbar.range.selectNodeContents(g[0]);return}else if(wn(f)){t.toolbar.setInlineMark(t,"file-annotation-ref","range",{type:"file-annotation-ref",color:f.substring(2).replace(/ ".+">>$/,"")});return}else{const g=i.startsWith("assets/")?i:t.lute.GetLinkDest(i);if(g){t.toolbar.setInlineMark(t,"a","range",{type:"a",color:g});return}}}i=i.replace(/\u200D```/g,"```");const m=t.lute.Md2BlockDOM(i);Ht(m,t,!1,!1,!0)}We(t,t.wysiwyg.element),Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t)}const d=o.querySelector(".av__cell--select");o.classList.contains("av")&&d?Xi(o,d):Ye(t,void 0,"nearest","smooth")}),Ac=(t,e,n,a)=>{!ca()||(!e||e.length===0)&&!n||setTimeout(()=>{t.highlight.markHL.clear(),t.highlight.mark.clear(),t.highlight.rangeIndex=0,t.highlight.ranges=[];let i=!1,s;typeof n=="string"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id='${n}']`)).find(f=>{if(!G(f))return s=f,!0}),!s&&n===t.block.rootID&&t.title&&!t.title.element.classList.contains("fn__none")&&(s=t.title.element);const l=[],o=[];let r=0;const c=document.createTreeWalker(t.contentElement,NodeFilter.SHOW_TEXT);let d=c.nextNode();for(;d;)l.push(d),r+=d.textContent.length,o.push(r),d=c.nextNode();const u=t.contentElement.textContent,m=[];if(e&&e.length>0&&e.forEach(f=>{if(!f)return;let g=0,h=0,b=0;for(;(g=u.indexOf(f,g))!==-1;){const y=new Range;h=g+f.length;try{for(;b<l.length&&o[b]<=g;)b++;let w=l[b];for(y.setStart(w,g-(b?o[b-1]:0));b<l.length&&o[b]<h;)b++;w=l[b],y.setEnd(w,h-(b?o[b-1]:0));let E=!1;!i&&s&&s.contains(w)&&(i=!0,E=!0),m.push({range:y,startIndex:g,isCurrent:E})}catch(w){console.error("searchMarkRender error:",w)}g=h}}),!i&&s){const f=u.indexOf(s.textContent);if(f>-1){const g=new Range;let h=0;for(;l.length&&o[h]<=f;)h++;g.setStart(l[h],0),m.push({range:g,startIndex:f,isCurrent:!0})}}m.sort((f,g)=>g.startIndex>f.startIndex?-1:0).forEach((f,g)=>{typeof n=="string"&&f.isCurrent||typeof n=="number"&&n===g?(t.highlight.rangeIndex=g,t.highlight.markHL.add(f.range)):t.highlight.mark.add(f.range),t.highlight.ranges.push(f.range)}),CSS.highlights.set("search-mark-"+t.highlight.styleElement.dataset.uuid,t.highlight.mark),typeof n!="undefined"&&CSS.highlights.set("search-mark-hl-"+t.highlight.styleElement.dataset.uuid,t.highlight.markHL),a&&a()},t.wysiwyg.element.querySelector(".hljs")?p.TIMEOUT_TRANSITION:0)},ca=()=>!!(CSS&&CSS.highlights),xc=(t,e=!1)=>{if(!t.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:t.block.rootID,startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:t.contentElement.scrollTop||parseInt(t.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!t.wysiwyg.element.contains(a.startContainer))&&(a=t.toolbar.range),a&&t.wysiwyg.element.contains(a.startContainer)){const i=B(a.startContainer);if(i){const s=_t(i,void 0,a);n.focusId=i.getAttribute("data-node-id"),n.focusStart=s.start,n.focusEnd=s.end}}return t.block.showAll&&(n.zoomInId=t.block.id),e?n:(window.siyuan.storage[p.LOCAL_FILEPOSITION][t.block.rootID]=n,new Promise(i=>{Ee(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION],()=>{i(!0)})}))},ch=t=>{var e,n,a,i,s,l,o,r,c,d,u,m,f,g;let h=[];if(t.mergedOptions?h=t.mergedOptions.action:t.focus?h=[p.CB_GET_UNUNDO,p.CB_GET_FOCUS]:h=[p.CB_GET_UNUNDO],(e=t.scrollAttr)!=null&&e.zoomInId&&((n=t.scrollAttr)!=null&&n.rootId)&&t.scrollAttr.zoomInId!==t.scrollAttr.rootId){A("/api/filetree/getDoc",{id:t.scrollAttr.zoomInId,size:p.SIZE_GET_MAX,query:(a=t.protyle.query)==null?void 0:a.key,queryMethod:(i=t.protyle.query)==null?void 0:i.method,queryTypes:(s=t.protyle.query)==null?void 0:s.types,highlight:!ca()},b=>{var y,w,E,C,$;b.code===1?A("/api/filetree/getDoc",{id:t.scrollAttr.rootId||((y=t.mergedOptions)==null?void 0:y.blockId)||((w=t.protyle.block)==null?void 0:w.rootID)||t.scrollAttr.startId,query:(E=t.protyle.query)==null?void 0:E.key,queryMethod:(C=t.protyle.query)==null?void 0:C.method,queryTypes:($=t.protyle.query)==null?void 0:$.types,highlight:!ca()},M=>{kt({data:M,protyle:t.protyle,action:h,scrollAttr:t.scrollAttr,afterCB:t.cb?()=>{t.cb(M.data.keywords)}:void 0,updateReadonly:t.updateReadonly})}):(h.push(p.CB_GET_ALL),kt({data:b,protyle:t.protyle,action:h,scrollAttr:t.scrollAttr,afterCB:t.cb?()=>{t.cb(b.data.keywords)}:void 0,updateReadonly:t.updateReadonly}))});return}A("/api/filetree/getDoc",{id:((l=t.scrollAttr)==null?void 0:l.rootId)||((o=t.mergedOptions)==null?void 0:o.blockId)||((r=t.protyle.block)==null?void 0:r.rootID)||((c=t.scrollAttr)==null?void 0:c.startId),startID:(d=t.scrollAttr)==null?void 0:d.startId,endID:(u=t.scrollAttr)==null?void 0:u.endId,query:(m=t.protyle.query)==null?void 0:m.key,queryMethod:(f=t.protyle.query)==null?void 0:f.method,queryTypes:(g=t.protyle.query)==null?void 0:g.types,highlight:!ca()},b=>{kt({data:b,protyle:t.protyle,action:h,scrollAttr:t.scrollAttr,afterCB:t.cb?()=>{t.cb(b.data.keywords)}:void 0,updateReadonly:t.updateReadonly})})},Ei=(t,e,n)=>{if(!t.preview.element.classList.contains("fn__none")){t.preview.render(t),ad(t);return}if(window.siyuan.config.editor.displayBookmarkIcon?t.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):t.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),t.title&&(t.title.element.removeAttribute("data-render"),t.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?t.title.element.classList.add("protyle-wysiwyg--attr"):t.title.element.classList.remove("protyle-wysiwyg--attr")),t.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),Fo(t),t.lute.SetGFMStrikethrough1(!1),Rl(t),t.options.backlinkData){const a=t.element.getAttribute("data-ismention")==="true",i=T(t.element,"sy__backlink");if(i){const s=i.querySelectorAll(".b3-text-field"),l=a?s[1].value:s[0].value;A(a?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:t.element.getAttribute("data-defid"),refTreeID:t.block.rootID,highlight:!ca(),keyword:l},o=>{t.options.backlinkData=a?o.data.backmentions:o.data.backlinks,wE(t,t.options.backlinkData),Ac(t,o.data.keywords)})}}else ra(t),ch({protyle:t,focus:e,scrollAttr:xc(t,!0),updateReadonly:n,cb(a){var i;(i=t.query)!=null&&i.key&&Ac(t,a,t.highlight.rangeIndex)}})},Aw=t=>{const e=document.getElementById("model");e.style.transform="translateY(0px)",e.style.zIndex=(++window.siyuan.zIndex).toString();const n=e.querySelector(".toolbar__icon");t.icon?(n.classList.remove("fn__none"),n.querySelector("use").setAttribute("xlink:href","#"+t.icon)):n.classList.add("fn__none"),e.querySelector(".toolbar__text").innerHTML=t.title;const a=e.querySelector("#modelMain");a.innerHTML=t.html,t.bindEvent(a)},Yf=(t,e)=>{let n=`<option value="">${window.siyuan.languages.currentNotebook}</option>`;const a=[];return Object.keys(p.HELP_PATH).forEach(i=>{a.push(p.HELP_PATH[i])}),window.siyuan.notebooks.forEach(i=>{a.includes(i.id)||i.id===e||(n+=`<option value="${i.id}" ${t===i.id?"selected":""}>${he(i.name)}</option>`)}),n},UA=t=>{const e=`<div class="fn__flex">${he(t.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small fn__flex-center">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${Yf(t.conf.docCreateSaveBox,t.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${Yf(t.conf.refCreateSaveBox,t.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="">
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${t.conf.dailyNoteTemplatePath}">
</div></div>`;if(Y())Aw({title:e,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){xw(document.querySelector("#model"),t)}});else{const a=new $e({width:"80vw",title:e,content:n});a.element.setAttribute("data-key",p.DIALOG_NOTEBOOKCONF),xw(a.element,t)}},xw=(t,e)=>{t.querySelector(".b3-button--small").addEventListener("click",()=>{Be(e.box),de(window.siyuan.languages.copied)});const n=t.querySelector("#dailyNoteSavePath");n.value=e.conf.dailyNoteSavePath;const a=t.querySelector("#docCreateSavePath");a.value=e.conf.docCreateSavePath;const i=t.querySelector("#refCreateSavePath");i.value=e.conf.refCreateSavePath;const s=t.querySelector("#dailyNoteTemplatePath");s.value=e.conf.dailyNoteTemplatePath,t.querySelectorAll("input, select").forEach(l=>{l.addEventListener("change",()=>{A("/api/notebook/setNotebookConf",{notebook:e.box,conf:{refCreateSavePath:i.value,refCreateSaveBox:t.querySelector("#refCreateSaveBox").value,docCreateSaveBox:t.querySelector("#docCreateSaveBox").value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:s.value}})})})};var WA=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Hn=t=>WA(void 0,null,function*(){const e=window.siyuan.storage[p.LOCAL_SEARCHDATA];let n="",a=[];if(t.notebookId){if(n=Qa(t.notebookId),a.push(t.notebookId),t.searchPath&&t.searchPath!=="/"){const r=yield Ae("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.searchPath.endsWith(".sy")?t.searchPath:t.searchPath+".sy"});n=De().join(n,r.data),a[0]=De().join(a[0],t.searchPath)}}else p.DIALOG_GLOBALSEARCH===t.hotkey&&(e.removed?(n="",a=[]):(n=e.hPath,a=[...e.idPath]));const i={removed:e.removed,k:t.key||e.k,r:e.r,hasReplace:t.hotkey===p.DIALOG_REPLACE,method:e.method,hPath:n,idPath:a,group:e.group,sort:e.sort,types:Object.assign({},e.types),replaceTypes:Object.assign({},e.replaceTypes),page:t.key?1:e.page};if(window.siyuan.dialogs.find(r=>{if(r.element.querySelector("#searchList")){const c=r.element.querySelector(".b3-dialog__body"),d=JSON.parse(JSON.stringify(r.data)),u=getSelection().rangeCount>0?getSelection().getRangeAt(0).toString():void 0;if(u&&(d.k=u),r.element.setAttribute("data-key",t.hotkey),t.hotkey===p.DIALOG_REPLACE)d.hasReplace=!0,Al(c,d,r.data,r.editors.edit);else if(t.hotkey===p.DIALOG_GLOBALSEARCH)d.hasReplace=!1,d.hPath="",d.idPath=[],Al(c,d,r.data,r.editors.edit);else if(t.hotkey===p.DIALOG_SEARCH){d.hasReplace=!1;const m=r.editors.edit.protyle.path;A("/api/filetree/getHPathsByPaths",{paths:[m]},f=>{d.idPath=[De().join(r.editors.edit.protyle.notebookId,m)],d.hPath=f.data[0],r.data.idPath=d.idPath,r.data.hPath=d.hPath,Al(c,d,r.data,r.editors.edit)})}return!0}}))return;let l;getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));const o=new $e({positionId:t.hotkey,content:"",width:"80vw",height:"90vh",destroyCallback(r){l&&!r&&ne(l),o.editors.edit.destroy(),o.editors.unRefEdit.destroy()},resizeCallback(r){r!=="d"&&r!=="t"&&(o.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?o.editors.edit.resize():o.editors.unRefEdit.resize())}});o.element.setAttribute("data-key",t.hotkey),o.editors=sv(t.app,i,o.element.querySelector(".b3-dialog__body"),()=>{o.destroy({focus:"false"})}),o.data=i}),Cw=(t,e)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){A("/api/filetree/removeDoc",{notebook:t,path:e});return}A("/api/block/getDocInfo",{id:xt(e,!0,!0)},n=>{const a=he(n.data.name);let i=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",a)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;n.data.subFileCount>0&&(i=`${window.siyuan.languages.andSubFile.replace("${x}",a).replace("${y}",n.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),Re(window.siyuan.languages.deleteOpConfirm,i,()=>{A("/api/filetree/removeDoc",{notebook:t,path:e})},void 0,!0)})},zf=t=>{if(t.length===1){const e=ot(t[0],"UL");if(e){const n=e.getAttribute("data-url");t[0].getAttribute("data-type")==="navigation-file"?Cw(n,t[0].getAttribute("data-path")):Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr(Qa(n)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{A("/api/notebook/removeNotebook",{notebook:n,callback:p.CB_MOUNT_REMOVE})},void 0,!0)}}else{const e=[];if(t.forEach(n=>{n.getAttribute("data-path")!=="/"&&e.push(n.getAttribute("data-path"))}),e.length===0){de(window.siyuan.languages.notBatchRemove);return}Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",e.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{A("/api/filetree/removeDocs",{paths:e})},void 0,!0)}};var VA=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Gf=(t,e)=>{t.element.querySelector(".wysiwygLoading")||(Rl(t),ce(["toolbar"],t),A(`/api/format/net${e}2LocalAssets`,{id:t.block.rootID},()=>{qn().forEach(n=>{n.protyle.block.rootID===t.block.rootID&&Ei(n.protyle,n.protyle.element===t.element)})}))},kl=(t,e)=>{var n,a;setTimeout(()=>{_s(["gutter"])},p.TIMEOUT_TRANSITION);const i=t.className.includes("fullscreen");if(i?(t.classList.remove("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")):(t.classList.add("fullscreen"),(a=document.getElementById("drag"))==null||a.classList.add("fn__hidden")),ue()){const s=[];pr(window.siyuan.layout.layout,s),s.find(l=>VA(void 0,null,function*(){const o=l.headersElement.parentElement;if(o.getBoundingClientRect().top<=0)return o.querySelector(".item--readonly .fn__flex-1").style.WebkitAppRegion=i?"drag":"",!0}))}if(window.siyuan.config.system.os!=="darwin"&&!ue()){const s=document.getElementById("windowControls");i?s.style.zIndex="":(window.siyuan.zIndex++,s.style.zIndex=window.siyuan.zIndex.toString())}if(e){i?e.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):e.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const s=T(t,"layout--float");s&&(i?(s.setAttribute("data-temp",s.style.transform),s.style.transform="none"):(s.style.transform=s.getAttribute("data-temp"),s.removeAttribute("data-temp")));return}t.classList.contains("protyle")&&(window.siyuan.editorIsFullscreen=!i),Oe().editor.forEach(s=>{t!==s.element&&(window.siyuan.editorIsFullscreen,s.element.classList.contains("fullscreen")&&(s.element.classList.remove("fullscreen"),mn(s.editor.protyle)))})},Tw=(t,e)=>{if(!window.siyuan.config.readonly){const n=t.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?n?nd(e):Sa(e):A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.CUSTOM_SY_READONLY]:n?"false":"true"}})}},YA=()=>{};var jf=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Kf=(t,e=0)=>{let n=0,a=0;return t.cards.forEach((i,s)=>{s>e||(i.state===0?n++:a++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${t.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ft__success">${t.unreviewedOldCardCount}</span>
</span>`},Zf=t=>{let e;return e=`<div class="block__icons">
        ${t.isTab?'<div class="fn__flex-1"></div>':`<div class="block__logo">
            <svg class="block__logoicon"><use xlink:href="#iconRiffCard"></use></svg>${window.siyuan.languages.riffCard}
        </div>`}
        <span class="fn__flex-1 resize__move" style="min-height: 100%"></span>
        <div data-type="count" class="ft__on-surface ft__smaller fn__flex-center${t.cardsData.cards.length===0?" fn__none":" fn__flex"}">${Kf(t.cardsData)}</span></div>
        <div class="fn__space"></div>
        <button data-id="${t.id||""}" data-cardtype="${t.cardType}" data-type="filter" class="block__icon block__icon--show">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </button>
        <div class="fn__space"></div>
        <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show" aria-label="${window.siyuan.languages.fullscreen}">
            <svg><use xlink:href="#iconFullscreen"></use></svg>
        </div>
        <div class="fn__space${t.cardsData.cards.length===0?" fn__none":""}"></div>
        <div data-type="more" class="${t.cardsData.cards.length===0?"fn__none ":""}b3-tooltips b3-tooltips__sw block__icon block__icon--show" aria-label="${window.siyuan.languages.more}">
            <svg><use xlink:href="#iconMore"></use></svg>
        </div>
        <div class="fn__space${t.isTab?" fn__none":""}"></div>
        <div data-type="sticktab" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show${t.isTab?" fn__none":""}" aria-label="${window.siyuan.languages.openBy}">
            <svg><use xlink:href="#iconOpen"></use></svg>
        </div>
    </div>`,`<div class="card__main">
    ${e}
    <div class="card__block fn__flex-1 ${t.cardsData.cards.length===0?"fn__none":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${t.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action fn__none">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            ${Y()?"":"(p / q)"}
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer}${Y()?"":" ("+window.siyuan.languages.space+" / "+window.siyuan.languages.enterKey+")"}</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <button class="b3-button b3-button--cancel" disabled="disabled" style="display: flex;margin-bottom: 8px;height: 28px;padding: 0;" data-type="-2"><svg><use xlink:href="#iconLeft"></use></svg>${Y()?"":"(p / q)"}</button>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip}${Y()?"":" (0)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain}${Y()?"":" (1)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard}${Y()?"":" (2)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood}${Y()?"":" (3)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy}${Y()?"":" (4)"}
            </button>
        </div>
    </div>
</div>`},Dw=(t,e,n,a)=>{A("/api/block/getDocInfo",{id:t},i=>{e.wysiwyg.renderCustom(i.data.ial),A("/api/filetree/getDoc",{id:t,mode:0,size:p.SIZE_GET_MAX},s=>{kt({updateReadonly:!0,data:s,protyle:e,action:s.data.rootID===s.data.id?[]:[p.CB_GET_ALL],afterCB:()=>{if(e.element.classList.contains("fn__none"))return;let l=!1;!window.siyuan.config.flashcard.superBlock&&!window.siyuan.config.flashcard.heading&&!window.siyuan.config.flashcard.list&&!window.siyuan.config.flashcard.mark?l=!1:(window.siyuan.config.flashcard.superBlock&&e.wysiwyg.element.querySelector(":scope > .sb")&&(l=!0),window.siyuan.config.flashcard.heading&&e.wysiwyg.element.querySelector(':scope > [data-type="NodeHeading"]')&&(l=!0),window.siyuan.config.flashcard.list&&e.wysiwyg.element.querySelector(".list, .li")&&(l=!0),window.siyuan.config.flashcard.mark&&e.wysiwyg.element.querySelector('span[data-type~="mark"]')&&(l=!0));const o=n.querySelectorAll(".card__action");l?(window.siyuan.config.flashcard.superBlock&&e.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&e.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&e.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&e.element.classList.add("card__block--hidemark"),o[0].classList.remove("fn__none"),o[1].classList.add("fn__none")):(e.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),o[0].classList.add("fn__none"),o[1].querySelectorAll("button.b3-button").forEach((r,c)=>{c<2||(r.previousElementSibling.textContent=a.nextDues[c-1])}),o[1].classList.remove("fn__none"))}})})})},Jf=t=>jf(void 0,null,function*(){window.siyuan.storage[p.LOCAL_FLASHCARD].fullscreen&&kl(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]'));let e=0;typeof t.index=="number"&&(e=t.index);const n=new ba(t.app,t.element.querySelector("[data-type='render']"),{blockId:"",action:[p.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0,title:!0,hideTitleOnZoom:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),t.cardsData.cards.length>0&&Dw(t.cardsData.cards[e].blockID,n.protyle,t.element,t.cardsData.cards[e]),t.element.setAttribute("data-key",p.DIALOG_OPENCARD);const a=t.element.querySelectorAll(".card__action");t.index===0||typeof t.index=="undefined"?(a[0].firstElementChild.setAttribute("disabled","disabled"),a[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(a[0].firstElementChild.removeAttribute("disabled"),a[1].querySelector(".b3-button").removeAttribute("disabled"));const i=t.element.querySelector('[data-type="count"]'),s=t.element.querySelector('[data-type="filter"]'),l=()=>{const o=s.getAttribute("data-cardtype"),r=s.getAttribute("data-id");A(o==="all"?"/api/riff/getRiffDueCards":o==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},c=>jf(void 0,null,function*(){e=0,t.cardsData=c.data;for(let d=0;d<t.app.plugins.length;d++)t.cardsData=yield t.app.plugins[d].updateCards(t.cardsData);t.cardsData.cards.length>0?Qf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData}):Iw(i,n,a)}))};return i.innerHTML=Kf(t.cardsData,e),t.element.firstChild.addEventListener("click",o=>{const r=o.target;let c="";const d=t.cardsData.cards[e],u=s.getAttribute("data-id");if(typeof o.detail=="string")["1","j","a"].includes(o.detail)?c="1":["2","k","s"].includes(o.detail)?c="2":["3","l","d"].includes(o.detail)?c="3":["4",";","f"].includes(o.detail)?c="4":[" ","enter"].includes(o.detail)?c="-1":["p","q"].includes(o.detail)?c="-2":["0","x"].includes(o.detail)&&(c="-3");else{if(j(r,"data-type","fullscreen")){kl(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]')),mn(n.protyle),window.siyuan.storage[p.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[p.LOCAL_FLASHCARD].fullscreen,Ee(p.LOCAL_FLASHCARD,window.siyuan.storage[p.LOCAL_FLASHCARD]),o.stopPropagation(),o.preventDefault();return}const f=j(r,"data-type","more");if(f&&d){if(o.stopPropagation(),o.preventDefault(),s.getAttribute("data-cardtype")==="all"&&s.getAttribute("data-id")){de(window.siyuan.languages.noSupportTip);return}const w=new dt;w.addItem({id:"setDueTime",icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const C=new $e({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"}),$=C.element.querySelector("input"),M=C.element.querySelectorAll(".b3-button");C.bindInput($,()=>{M[1].click()}),$.focus(),$.select(),M[0].addEventListener("click",()=>{C.destroy()}),M[1].addEventListener("click",()=>{A("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:d.cardID,due:Q().add(parseInt($.value),"day").format("YYYYMMDDHHmmss")}]},()=>{a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),d.state===0?t.cardsData.unreviewedNewCardCount--:t.cardsData.unreviewedOldCardCount--,t.element.firstElementChild.dispatchEvent(new CustomEvent("click",{detail:"0"})),t.cardsData.cards.splice(e,1),e--,C.destroy()})})}}),d.state!==0&&w.addItem({id:"reset",icon:"iconRefresh",label:window.siyuan.languages.reset,click(){A("/api/riff/resetRiffCards",{type:s.getAttribute("data-cardtype"),id:u,deckID:p.QUICK_DECK_ID,blockIDs:[d.blockID]},()=>{const C=window.siyuan.languages._time["1m"].replace("%s","");d.lapses=0,d.lastReview=-621355968e5,d.reps=0,d.state=0,d.nextDues={1:C,2:C.replace("1","5"),3:C.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},a[1].querySelectorAll("button.b3-button").forEach(($,M)=>{M<2||($.previousElementSibling.textContent=d.nextDues[M-1])}),t.cardsData.unreviewedOldCardCount--,t.cardsData.unreviewedNewCardCount++,i.innerHTML=Kf(t.cardsData,e)})}}),w.addItem({id:"removeRiffCard",icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),d.state===0?t.cardsData.unreviewedNewCardCount--:t.cardsData.unreviewedOldCardCount--,t.element.firstElementChild.dispatchEvent(new CustomEvent("click",{detail:"0"})),V(void 0,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[d.blockID]}]),t.cardsData.cards.splice(e,1),e--}}),w.addSeparator(),w.addItem({id:"forgetCountAndRevisionCountAndCardStatusAndLastReviewTime",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${d.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${d.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${d.state===0?"ft__primary":"ft__success"}">${d.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${d.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${Q(d.lastReview).format("YYYY-MM-DD")}</div>
</div>`});const E=f.getBoundingClientRect();w.open({x:E.left,y:E.bottom});return}const g=j(r,"data-type","sticktab");if(g){const w=new dt;w.addItem({id:"openInNewTab",icon:"iconOpen",label:window.siyuan.languages.openInNewTab,click(){ea({app:t.app,custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardsData:t.cardsData,index:e,cardType:s.getAttribute("data-cardtype"),id:u,title:t.title},id:"siyuan-card"}}),t.dialog.destroy()}}),w.addItem({id:"insertRight",icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,click(){ea({app:t.app,position:"right",custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardsData:t.cardsData,index:e,cardType:s.getAttribute("data-cardtype"),id:u,title:t.title},id:"siyuan-card"}}),t.dialog.destroy()}});const E=g.getBoundingClientRect();w.open({x:E.left,y:E.bottom}),o.stopPropagation(),o.preventDefault();return}if(j(r,"data-type","close")){t.dialog&&t.dialog.destroy(),o.stopPropagation(),o.preventDefault();return}const b=j(r,"data-type","filter");if(b){A("/api/riff/getRiffDecks",{},w=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new N({id:"all",iconHTML:"",label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),l()}}).element),window.siyuan.menus.menu.append(new N({id:"fileTree",iconHTML:"",label:window.siyuan.languages.fileTree,click(){zi((C,$)=>{s.setAttribute("data-id",C[0]==="/"?$[0]:xt(C[0],!0,!0)),s.setAttribute("data-cardtype",C[0]==="/"?"notebook":"doc"),l()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(t.title||w.data.length>0)&&window.siyuan.menus.menu.append(new N({type:"separator"}).element),t.title&&(window.siyuan.menus.menu.append(new N({iconHTML:"",label:he(t.title),click(){s.setAttribute("data-id",t.id),s.setAttribute("data-cardtype",t.cardType),l()}}).element),w.data.length>0&&window.siyuan.menus.menu.append(new N({type:"separator"}).element)),w.data.forEach(C=>{window.siyuan.menus.menu.append(new N({iconHTML:"",label:he(C.name),click(){s.setAttribute("data-id",C.id),s.setAttribute("data-cardtype","all"),l()}}).element)});const E=b.getBoundingClientRect();window.siyuan.menus.menu.popup({x:E.left,y:E.bottom})}),o.stopPropagation(),o.preventDefault();return}if(j(r,"data-type","newround")){l(),o.stopPropagation(),o.preventDefault();return}}if(!c){const m=T(r,"b3-button");m&&(c=m.getAttribute("data-type"))}if(!(!c||!d)){if(o.preventDefault(),o.stopPropagation(),ce(["toolbar","hint","util","gutter"],n.protyle),c==="-1")if(a[0].classList.contains("fn__none"))c="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),a[0].classList.add("fn__none"),a[1].querySelectorAll("button.b3-button").forEach((m,f)=>{f<2||(m.previousElementSibling.textContent=d.nextDues[f-1])}),a[1].classList.remove("fn__none"),Xf(t.app,d,c);return}else if(c==="-2"){e>0&&(e--,Qf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData}),Xf(t.app,t.cardsData.cards[e+1],c));return}["1","2","3","4","-3"].includes(c)&&a[0].classList.contains("fn__none")&&A(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:d.deckID,cardID:d.cardID,rating:parseInt(c),reviewedCards:t.cardsData.cards},()=>{if(e++,e>t.cardsData.cards.length-1){const m=s.getAttribute("data-cardtype");A(m==="all"?"/api/riff/getRiffDueCards":m==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:u,deckID:u,notebook:u,reviewedCards:t.cardsData.cards},f=>jf(void 0,null,function*(){Xf(t.app,t.cardsData.cards[e-1],c),e=0,t.cardsData=f.data;for(let g=0;g<t.app.plugins.length;g++)t.cardsData=yield t.app.plugins[g].updateCards(t.cardsData);t.cardsData.cards.length===0?t.cardsData.unreviewedCount>0?zA(i,n,a,f.data.unreviewedCount):Iw(i,n,a):Qf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData})}));return}Qf({countElement:i,editor:n,actionElements:a,index:e,cardsData:t.cardsData}),Xf(t.app,t.cardsData.cards[e-1],c)})}}),n}),Xf=(t,e,n)=>{t.plugins.forEach(a=>{a.eventBus.emit("click-flashcard-action",{type:n,card:e})})},Wo=t=>{window.siyuan.config.readonly||A("/api/riff/getRiffDueCards",{deckID:""},e=>{Sl(t,e.data,"all")})},Sl=(t,e,n,a,i)=>jf(void 0,null,function*(){if(window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===p.DIALOG_OPENCARD)return u.destroy(),!0}))return;let l;getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));for(let u=0;u<t.plugins.length;u++)e=yield t.plugins[u].updateCards(e);const o=new $e({positionId:p.DIALOG_OPENCARD,content:Zf({id:a,cardType:n,cardsData:e,isTab:!1}),width:Y()?"100vw":"80vw",height:Y()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),l&&ne(l)},resizeCallback(u){u!=="d"&&u!=="t"&&r&&r.resize()}});o.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-surface)",o.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield Jf({app:t,element:o.element,cardsData:e,title:i,id:a,cardType:n,dialog:o});r.resize(),o.editors={card:r};const c=o.element.querySelector(".block__icons button.block__icon");c.focus();const d=document.createRange();d.selectNodeContents(c),d.collapse(),ne(d),YA()}),Qf=t=>{t.editor.protyle.element.classList.remove("fn__none"),t.editor.protyle.element.nextElementSibling.classList.add("fn__none"),t.countElement.innerHTML=Kf(t.cardsData,t.index),t.countElement.classList.remove("fn__none"),t.index===0?(t.actionElements[0].firstElementChild.setAttribute("disabled","disabled"),t.actionElements[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(t.actionElements[0].firstElementChild.removeAttribute("disabled"),t.actionElements[1].querySelector(".b3-button").removeAttribute("disabled")),Dw(t.cardsData.cards[t.index].blockID,t.editor.protyle,j(t.countElement,"data-key",p.DIALOG_OPENCARD),t.cardsData.cards[t.index])},Iw=(t,e,n)=>{t.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const a=e.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none");const i=t.parentElement.querySelector('[data-type="more"]');i.classList.add("fn__none"),i.previousElementSibling.classList.add("fn__none")},zA=(t,e,n,a)=>{t.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const i=e.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},Vo=(t,e,n,a,i)=>{let s=1,l;A(`/api/riff/get${a}RiffCards`,{id:e,page:s},o=>{var r;const c=new $e({positionId:p.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${he(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${a===""&&e===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${o.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${o.data.total}</span>
        ${Y()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${Y()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${dh(o.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:Y()?"100vw":"80vw",height:Y()?"100vh":"70vh",destroyCallback(){l&&(l.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(f){f!=="d"&&f!=="t"&&l&&l.resize()}});o.data.blocks.length>0&&(l=new ba(t,c.element.querySelector("#cardPreview"),{blockId:"",action:[p.CB_GET_ALL],render:{gutter:!0,breadcrumbDocName:!0,title:!0,hideTitleOnZoom:!0},typewriterMode:!1}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=l),c.editors={card:l},l.resize(),Ll(l,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const d=c.element.querySelector('[data-type="previous"]'),u=c.element.querySelector('[data-type="next"]'),m=c.element.querySelector(".b3-list--background");o.data.pageCount>1&&u.removeAttribute("disabled"),c.element.setAttribute("data-key",p.DIALOG_VIEWCARDS),c.element.addEventListener("click",f=>{var g;if(typeof f.detail=="string"){let b=m.querySelector(".b3-list-item--focus");if(b){b.classList.remove("b3-list-item--focus"),f.detail==="arrowup"?b=b.previousElementSibling||b.parentElement.lastElementChild:f.detail==="arrowdown"?b=b.nextElementSibling||b.parentElement.firstElementChild:f.detail==="home"?b=b.parentElement.firstElementChild:f.detail==="end"&&(b=b.parentElement.lastElementChild);const y=b.getBoundingClientRect(),w=b.parentElement.getBoundingClientRect();(y.top<w.top||y.bottom>w.bottom)&&b.scrollIntoView(y.top<w.top),Ll(l,b.getAttribute("data-id")),b.classList.add("b3-list-item--focus")}f.stopPropagation(),f.preventDefault();return}let h=f.target;for(;h&&c.element!==h;){const b=h.getAttribute("data-type");if(b==="close"){c.destroy(),f.stopPropagation(),f.preventDefault();break}else if(b==="previous"){if(s<=1)return;s--,s<=1&&d.setAttribute("disabled","disabled"),A(`/api/riff/get${a}RiffCards`,{id:e,page:s},y=>{var w;s===y.data.pageCount?u.setAttribute("disabled","disabled"):y.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${s}/${y.data.pageCount||1}`,m.innerHTML=dh(y.data.blocks,n,a),m.scrollTop=0,Ll(l,(w=c.element.querySelector(".b3-list-item--focus"))==null?void 0:w.getAttribute("data-id"))}),f.stopPropagation(),f.preventDefault();break}else if(b==="next"){if(s>=o.data.pageCount)return;s++,d.removeAttribute("disabled"),A(`/api/riff/get${a}RiffCards`,{id:e,page:s},y=>{var w;s===y.data.pageCount?u.setAttribute("disabled","disabled"):y.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${s}/${y.data.pageCount||1}`,m.innerHTML=dh(y.data.blocks,n,a),m.scrollTop=0,Ll(l,(w=c.element.querySelector(".b3-list-item--focus"))==null?void 0:w.getAttribute("data-id"))}),f.stopPropagation(),f.preventDefault();break}else if(b==="reset"){A("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?e:p.QUICK_DECK_ID,id:e,blockIDs:[h.getAttribute("data-id")]},()=>{h.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=Q().format("YYYY-MM-DD")}),f.stopPropagation(),f.preventDefault();break}else if(b==="resetAll"){Re(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",c.element.querySelector(".counter").textContent),()=>{A("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?e:p.QUICK_DECK_ID,id:e},()=>{c.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(y=>{y.textContent=Q().format("YYYY-MM-DD")})})}),f.stopPropagation(),f.preventDefault();break}else if(b==="card-item"){Ll(l,h.getAttribute("data-id")),(g=m.querySelector(".b3-list-item--focus"))==null||g.classList.remove("b3-list-item--focus"),h.classList.add("b3-list-item--focus"),f.stopPropagation(),f.preventDefault();break}else if(b==="remove"){A("/api/riff/removeRiffCards",{deckID:a===""?e:p.QUICK_DECK_ID,blockIDs:[h.getAttribute("data-id")]},y=>{var w;let E=h.parentElement.nextElementSibling;E||(E=h.parentElement.previousElementSibling),!E&&h.parentElement.parentElement.childElementCount>1&&(E=h.parentElement.parentElement.firstElementChild),E?(Ll(l,E.getAttribute("data-id")),(w=m.querySelector(".b3-list-item--focus"))==null||w.classList.remove("b3-list-item--focus"),E.classList.add("b3-list-item--focus"),h.parentElement.remove()):(Ll(l,""),m.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),i&&i(y)}),f.stopPropagation(),f.preventDefault();break}h=h.parentElement}})})},dh=(t,e,n)=>{let a="",i=!0;const s=e.split("/");return s.splice(0,1),t.forEach(l=>{var o,r,c,d;if(l.type){let u;n===""?u=Qa(l.box)+xt(Lute.UnEscapeHTMLStr(l.hPath),!1):(u=xt(Lute.UnEscapeHTMLStr(l.hPath),!1).replace("/"+s.join("/"),""),u.startsWith("/")&&(u=u.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${Y()?"":" b3-list-item--hide-action"}" data-id="${l.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${la(l.type)}"></use></svg>
${be(l.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${l.content||p.ZWSP}</span>
<span class="${Y()||!u?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${at(u)}">${he(u)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((o=l.riffCard)==null?void 0:o.reps)===0?" fn__none":""}">${(r=l.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(c=l.riffCard)!=null&&c.due?"":" fn__none"}">${Q((d=l.riffCard)==null?void 0:d.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${l.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${l.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,i=!1}else a+=`<div data-type="card-item" class="b3-list-item${Y()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${l.content}</span>
<span data-position="parentE" data-type="remove" data-id="${l.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),t.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},Ll=(t,e)=>{if(!e){t.protyle.element.classList.add("fn__none"),t.protyle.element.nextElementSibling.classList.remove("fn__none");return}t.protyle.element.classList.remove("fn__none"),t.protyle.element.nextElementSibling.classList.add("fn__none"),t.protyle.scroll.lastScrollTop=0,Rl(t.protyle),A("/api/block/getDocInfo",{id:e},n=>{t.protyle.wysiwyg.renderCustom(n.data.ial),A("/api/filetree/getDoc",{id:e,mode:0,size:p.SIZE_GET_MAX},a=>{kt({updateReadonly:!0,data:a,protyle:t.protyle,action:a.data.rootID===a.data.id?[]:[p.CB_GET_ALL]})})})},ep=(t,e,n)=>{t.addEventListener("mousedown",a=>{const i=T(e,"b3-dialog__body")||T(e,"protyle-util");if(!i)return;i.style.userSelect="none",i.style.pointerEvents="none";const s=document;s.ondragstart=()=>!1;const l=a.clientX,o=e.clientWidth,r=i.clientWidth-256;s.onmousemove=c=>{const d=o+(c.clientX-l);d<256||d>r||(e.style.width=d+"px")},s.onmouseup=()=>{i.style.userSelect="auto",i.style.pointerEvents="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,n&&(window.siyuan.storage[p.LOCAL_HISTORY][n]=e.clientWidth+"px",Ee(p.LOCAL_HISTORY,window.siyuan.storage[p.LOCAL_HISTORY]))}})};let Cc,Tc=!1;const tp=(t,e,n)=>{const a=t.querySelector('[data-type="docprevious"]'),i=t.querySelector('[data-type="docnext"]');e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const s=t.querySelector('.b3-select[data-type="opselect"]'),l=t.querySelector(".b3-list--background");t.querySelector(".protyle-title__input").classList.add("fn__none"),t.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),t.querySelector('.history__text[data-type="mdPanel"]').classList.add("fn__none"),A("/api/history/searchHistory",{query:n,page:e,op:s.value,type:3},o=>{e<o.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const r=t.querySelector('[data-type="jumpRepoPage"]');o.data.pageCount>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),r.setAttribute("data-totalpage",o.data.pageCount.toString()),r.textContent=e.toString();const c=i.nextElementSibling.nextElementSibling;if(c.classList.remove("fn__none"),c.textContent=window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",o.data.pageCount).replace("${y}",o.data.totalCount),o.data.histories.length===0){l.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let d="";o.data.histories.forEach(u=>{d+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${u}">
    <span class="b3-list-item__text">${Q(parseInt(u)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),l.innerHTML=d})},$w=t=>{const e=`<div class="history__action">
    <div class="block__icons">
        <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" disabled>1</button>
        <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
        <span class="fn__space"></span>
        <div class="fn__flex-1"></div>
        <select data-type="opselect" class="b3-select">
            <option value="all" selected>${window.siyuan.languages.allOp}</option>
            <option value="update">${window.siyuan.languages.historyUpdate}</option>
            <option value="format">${window.siyuan.languages.historyFormat}</option>
            <option value="sync">${window.siyuan.languages.historySync}</option>
            <option value="replace">${window.siyuan.languages.historyReplace}</option>
            <option value="outline">${window.siyuan.languages.historyOutline}</option>
        </select>
    </div>
</div>
<div class="fn__flex fn__flex-1 history__panel">
    <ul class="b3-list b3-list--background history__side" ${Y()?"":`style="width: ${window.siyuan.storage[p.LOCAL_HISTORY].sideDocWidth}"`}>
        <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
    </ul>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="protyle-title__input fn__none ft__center ft__breakword"></div>
        <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
        <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
    </div>
</div>`,n=new $e({title:t.pathString,content:e,width:Y()?"100vw":"90vw",height:Y()?"100vh":"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Cc=void 0}});n.element.setAttribute("data-key",p.DIALOG_HISTORYDOC);const a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{tp(n.element,1,t.id)});const i=n.element.querySelector('.history__text[data-type="docPanel"]'),s=n.element.querySelector('.history__text[data-type="mdPanel"]');tp(n.element,1,t.id),Cc=new ba(t.app,i,{blockId:"",history:{created:""},action:[p.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Sa(Cc.protyle);const l=n.element.querySelector('[data-type="jumpRepoPage"]'),o=n.element.querySelector(".protyle-title__input");n.element.addEventListener("click",r=>{let c=r.target;for(;c&&!c.isEqualNode(n.element);){const d=c.getAttribute("data-type");if(d==="rollback"&&!Tc){Mw(c.parentElement,a.value,t.id,u=>{const m=u.path;Tc=!1;const f=window.siyuan.languages.rollbackConfirm.replace("${name}",he(u.title)).replace("${time}",c.previousElementSibling.previousElementSibling.textContent.trim());Re("\u26A0\uFE0F "+window.siyuan.languages.rollback,f,()=>{A("/api/history/rollbackDocHistory",{notebook:t.notebookId,historyPath:m})})}),r.stopPropagation(),r.preventDefault();break}else if(c.classList.contains("b3-list-item")&&!Tc){Mw(c,a.value,t.id,u=>{var m;const f=u.path;A("/api/history/getDocHistoryContent",{historyPath:f},g=>{g.data.isLargeDoc?(s.value=g.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),kt({data:g,protyle:Cc.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]})),o.textContent=u.title,o.classList.remove("fn__none"),Tc=!1}),(m=c.parentElement.querySelector(".b3-list-item--focus"))==null||m.classList.remove("b3-list-item--focus"),c.classList.add("b3-list-item--focus")}),r.stopPropagation(),r.preventDefault();break}else if((d==="docprevious"||d==="docnext")&&c.getAttribute("disabled")!=="disabled"){const u=parseInt(l.textContent);tp(n.element,d==="docprevious"?u-1:u+1,t.id),r.stopPropagation(),r.preventDefault();break}else if(d==="jumpRepoPage"){const u=parseInt(c.getAttribute("data-totalpage")||"1");Re(window.siyuan.languages.jumpToPage.replace("${x}",u),`<input class="b3-text-field fn__block" type="number" min="1" max="${u}" value="${l.textContent}">`,m=>{const f=m.element.querySelector(".b3-text-field");f.value!==""&&tp(n.element,Math.max(1,Math.min(parseInt(f.value),u)),t.id)})}c=c.parentElement}}),ep(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDocWidth")},Mw=(t,e,n,a)=>{Tc=!0;const i=t.getAttribute("data-path");i&&a(i);const s=t.getAttribute("data-created");Cc.protyle.options.history.created=s,A("/api/history/getHistoryItems",{query:n,op:e,type:3,created:s},l=>{a(l.data.items[0])})},Dc=t=>`<li data-id="${t.id}" data-name="${at(t.name)}" class="b3-list-item b3-list-item--narrow${Y()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${he(t.name)}</span>
    <span class="b3-list-item__meta">${t.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-list-item__action--warning b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${Y()?" fn__none":""}">${t.updated}</span>
</li>`,Ic=(t,e)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===p.DIALOG_MAKECARD)return ce(["dialog"]),!0}),A("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(s=>{a+=Dc(s)});const i=new $e({positionId:p.DIALOG_MAKECARD,width:Y()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});i.element.setAttribute("data-key",p.DIALOG_MAKECARD),i.element.addEventListener("click",s=>{let l=s.target;for(;l&&l!==i.element;){const o=l.getAttribute("data-type");if(o==="create"){let r="";const c=i.element.querySelector(".b3-text-field");c.value?(r&&At(r),A("/api/riff/createRiffDeck",{name:c.value},d=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",Dc(d.data)),c.value=""})):(r=de(window.siyuan.languages._kernel[142]),c.focus()),s.stopPropagation(),s.preventDefault();break}else if(o==="add"){A("/api/riff/addRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:e},r=>{l.parentElement.outerHTML=Dc(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(o==="remove"){A("/api/riff/removeRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:e},r=>{l.parentElement.outerHTML=Dc(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(o==="delete"){Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${he(l.parentElement.getAttribute("data-name"))}</b>?`,()=>{A("/api/riff/removeRiffDeck",{deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.remove()})},void 0,!0),s.stopPropagation(),s.preventDefault();break}else if(o==="view"){Vo(t,l.parentElement.getAttribute("data-id"),l.parentElement.getAttribute("data-name"),"",r=>{l.parentElement.outerHTML=Dc(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(o==="viewall"){Vo(t,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(o==="rename"){const r=new $e({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"}),c=r.element.querySelector("input"),d=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{d[1].click()}),c.value=l.parentElement.getAttribute("data-name"),c.focus(),c.select(),d[0].addEventListener("click",()=>{r.destroy()}),d[1].addEventListener("click",()=>{A("/api/riff/renameRiffDeck",{name:c.value,deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,l.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}l=l.parentElement}})})},$c=(t,e)=>{let n=!0;const a=[];e.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),a.push(i.getAttribute("data-node-id")),(i.getAttribute(p.CUSTOM_RIFF_DECKS)||"").indexOf(p.QUICK_DECK_ID)===-1&&(n=!1))}),n?V(t,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}]):V(t,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}])};class GA{constructor(e=""){this.eventTarget=document.appendChild(document.createComment(e))}on(e,n){this.eventTarget.addEventListener(e,n)}once(e,n){this.eventTarget.addEventListener(e,n,{once:!0})}off(e,n){this.eventTarget.removeEventListener(e,n)}emit(e,n){return this.eventTarget.dispatchEvent(new CustomEvent(e,{detail:n,cancelable:!0}))}}const zn=t=>{const e=new DA;t.detail.menu=e,t.plugins.forEach(n=>{n.eventBus.emit(t.type,t.detail)}),e.menus.length>0&&(t.separatorPosition==="top"&&window.siyuan.menus.menu.append(new N({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:e.menus}).element),t.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new N({id:"separator_pluginBottom",type:"separator"}).element))},Mc=t=>{if(t.protyle.disabled)return;const e=new dt(p.MENU_AV_VIEW);if(e.isOpen)return;e.addItem({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),Cn({protyle:t.protyle,blockElement:t.blockElement,type:"config",cb:i=>{i.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),e.addItem({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),Cn({protyle:t.protyle,blockElement:t.blockElement,type:"config"})}}),e.addSeparator(),e.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove();const i=Lute.NewNodeID();V(t.protyle,[{action:"duplicateAttrViewView",avID:t.blockElement.dataset.avId,previousID:t.element.dataset.id,id:i,blockID:t.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:t.blockElement.dataset.avId,id:i,blockID:t.blockElement.dataset.nodeId}])}}),t.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&e.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),V(t.protyle,[{action:"removeAttrViewView",avID:t.blockElement.dataset.avId,id:t.element.dataset.id,blockID:t.blockElement.dataset.nodeId}])}});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom})},Pw=t=>{const e=t.menuElement.querySelector('.b3-text-field[data-type="name"]');e.addEventListener("blur",()=>{e.value!==e.dataset.value&&(V(t.protyle,[{action:"setAttrViewViewName",avID:t.data.id,id:t.data.viewID,data:e.value}],[{action:"setAttrViewViewName",avID:t.data.id,id:t.data.viewID,data:e.dataset.value}]),e.dataset.value=e.value)}),e.addEventListener("keydown",a=>{a.isComposing||a.key==="Enter"&&(a.preventDefault(),e.blur(),t.menuElement.parentElement.remove())}),e.select(),e.value=e.dataset.value;const n=t.menuElement.querySelector('.b3-text-field[data-type="desc"]');e.nextElementSibling.addEventListener("click",()=>{const a=n.parentElement;a.classList.toggle("fn__none"),a.classList.contains("fn__none")||n.focus()}),n.addEventListener("blur",()=>{n.value!==n.dataset.value&&(V(t.protyle,[{action:"setAttrViewViewDesc",avID:t.data.id,id:t.data.viewID,data:n.value}],[{action:"setAttrViewViewDesc",avID:t.data.id,id:t.data.viewID,data:n.dataset.value}]),n.dataset.value=n.value)}),n.addEventListener("keydown",a=>{a.isComposing||a.key==="Enter"&&(a.preventDefault(),n.blur(),t.menuElement.parentElement.remove())}),n.addEventListener("input",()=>{e.nextElementSibling.setAttribute("aria-label",n.value?he(n.value):window.siyuan.languages.addDesc)})},Nw=t=>{const e=t.view,n=yt(t);return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-type="update-view-icon">${e.icon?be(e.icon):`<svg style="height: 14px;width: 14px"><use xlink:href="#${np(t.viewType)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text" data-value="${at(e.name)}">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${e.desc?Zt(e.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__block" type="text" data-value="${at(e.desc)}">${e.desc}</textarea>
        </div>
        <div class="fn__hr"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="go-layout">
    <svg class="b3-menu__icon"><use xlink:href="#${np(t.viewType)}"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.layout}</span>
    <span class="b3-menu__accelerator">${Bw(t.viewType)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.fields}</span>
    <span class="b3-menu__accelerator">${n.filter(a=>!a.hidden).length}/${n.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${e.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${e.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goGroups">
    <svg class="b3-menu__icon"><use xlink:href="#iconGroups"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.group}</span>
    <span class="b3-menu__accelerator">${t.view.group&&t.view.group.field?n.filter(a=>a.id===t.view.group.field)[0].name:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${t.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},jA=t=>{const e=t.menuElement.querySelector(".b3-text-field");e.focus(),e.addEventListener("keydown",n=>{if(n.stopPropagation(),!n.isComposing)if(xn(t.menuElement.querySelector(".fn__flex-1"),n,"b3-menu__item--current"),n.key==="Enter"){const a=t.menuElement.querySelector(".b3-menu__item--current");a&&(V(t.protyle,[{action:"setAttrViewBlockView",blockID:t.blockElement.getAttribute("data-node-id"),id:a.dataset.id,avID:t.blockElement.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:t.blockElement.getAttribute("data-node-id"),id:t.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:t.blockElement.getAttribute("data-av-id")}]),t.menuElement.remove(),oe(t.blockElement))}else n.key==="Escape"&&(t.menuElement.remove(),oe(t.blockElement))}),e.addEventListener("input",n=>{n.isComposing||Hw(t.menuElement)}),e.addEventListener("compositionend",()=>{Hw(t.menuElement)})},Hw=t=>{var e;const a=t.querySelector(".b3-text-field").value;t.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(i=>{!a||a.toLowerCase().indexOf(i.textContent.trim().toLowerCase())>-1||i.textContent.trim().toLowerCase().indexOf(a.toLowerCase())>-1?i.classList.remove("fn__none"):(i.classList.add("fn__none"),i.classList.remove("b3-menu__item--current"))}),t.querySelector(".b3-menu__item--current")||(e=t.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)"))==null||e.classList.add("b3-menu__item--current")},KA=(t,e)=>{let n="";return t.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item${a.id===e?" b3-menu__item--current":""}" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch" data-av-type="${a.type}">
        ${a.icon?be(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${np(a.type)}"></use></svg>`}
        <span class="fn__ellipsis">${a.name}</span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${n}
</div>
</div>`},Ow=(t,e)=>{var n;const a=Lute.NewNodeID(),i=e.getAttribute("data-av-id"),s=e.querySelector(".av__views"),l=new dt(void 0,()=>{s.classList.remove("av__views--show")});l.addItem({icon:"iconTable",label:window.siyuan.languages.table,click(){V(t,[{action:"addAttrViewView",avID:i,id:a,blockID:e.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:i,id:a,blockID:e.getAttribute("data-node-id")}])}}),l.addItem({icon:"iconBoard",label:window.siyuan.languages.kanban,click(){V(t,[{action:"addAttrViewView",avID:i,layout:"kanban",id:a,blockID:e.getAttribute("data-node-id")}],[{action:"removeAttrViewView",layout:"kanban",avID:i,id:a,blockID:e.getAttribute("data-node-id")}])}}),l.addItem({icon:"iconGallery",label:window.siyuan.languages.gallery,click(){V(t,[{action:"addAttrViewView",avID:i,layout:"gallery",id:a,blockID:e.getAttribute("data-node-id")}],[{action:"removeAttrViewView",layout:"gallery",avID:i,id:a,blockID:e.getAttribute("data-node-id")}])}}),s.classList.add("av__views--show");const o=(n=s.querySelector('.block__icon[data-type="av-add"]'))==null?void 0:n.getBoundingClientRect();l.open({x:o.left,y:o.bottom+8})},np=t=>{switch(t){case"table":return"iconTable";case"gallery":return"iconGallery";case"kanban":return"iconBoard"}},Bw=t=>{switch(t){case"table":return window.siyuan.languages.table;case"gallery":return window.siyuan.languages.gallery;case"kanban":return window.siyuan.languages.kanban}},yt=t=>t.viewType==="table"?t.view.columns:t.view.fields,ZA=t=>{const e=window.siyuan.dragElement.parentElement;if(e.scrollWidth>e.clientWidth){const i=e.getBoundingClientRect();t.clientX<i.left?e.scroll({left:e.scrollLeft-p.SIZE_SCROLL_STEP,behavior:"smooth"}):t.clientX>i.right&&e.scroll({left:e.scrollLeft+p.SIZE_SCROLL_STEP,behavior:"smooth"})}const n=T(document.elementFromPoint(t.clientX,window.siyuan.dragElement.getBoundingClientRect().top+10),"item");if(!n||e!==window.siyuan.dragElement.parentElement||n===window.siyuan.dragElement)return;const a=n.getBoundingClientRect();if(a.left+a.width/2<t.clientX){if(n.nextElementSibling&&n.nextElementSibling===window.siyuan.dragElement)return;n.after(window.siyuan.dragElement)}else{if(n.previousElementSibling&&n.previousElementSibling===window.siyuan.dragElement)return;n.before(window.siyuan.dragElement)}},an=(t,e)=>{t.includes("cell")&&e.querySelectorAll(".av__cell--select, .av__cell--active").forEach(n=>{var a;(a=n.querySelector(".av__drag-fill"))==null||a.remove(),n.classList.remove("av__cell--select","av__cell--active")}),t.includes("row")&&e.querySelectorAll(".av__row--select").forEach(n=>{n.classList.remove("av__row--select"),n.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),Es(n)}),t.includes("galleryItem")&&e.querySelectorAll(".av__gallery-item--select").forEach(n=>{n.classList.remove("av__gallery-item--select")}),t.includes("av")&&e.querySelectorAll(" .av__cell--select, .av__cell--active, .av__row--select, .av__gallery-item--select").forEach(n=>{var a;n.classList.contains("av__row--select")?(n.classList.remove("av__row--select"),n.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),Es(n)):((a=n.querySelector(".av__drag-fill"))==null||a.remove(),n.classList.remove("av__cell--select","av__cell--active","av__gallery-item--select"))}),t.includes("img")&&e.querySelectorAll(".img--select").forEach(n=>{n.classList.remove("img--select")})},Rw=t=>{var e,n,a;const i=t.blockElement.getAttribute("data-av-type");t.blockElement.querySelector('[data-type="av-search"]').value="";const s=t.groupID?`.av__body[data-group-id="${t.groupID}"] `:"";let l=t.previousId?t.blockElement.querySelector(s+`.av__gallery-item[data-id="${t.previousId}"]`):t.blockElement.querySelector(s+".av__gallery-item");t.blockElement.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(l=t.blockElement.querySelector(s+".av__gallery-add").previousElementSibling);const r=t.blockElement.querySelector(`.av__body[data-group-id="${t.groupID}"] `);if(r&&["updated","created"].includes(r.getAttribute("data-dtype"))&&r.getAttribute("data-content")!=="_@today@_"&&(l=(e=t.blockElement.querySelector('.av__body[data-content="_@today@_"] .av__gallery-add'))==null?void 0:e.previousElementSibling,!l))return;let c="";l==null||l.querySelectorAll(".av__cell").forEach(m=>{var f;let g=1;const h=Zn(m);if(h==="lineNumber"){const y=(f=m.querySelector(".av__celltext"))==null?void 0:f.getAttribute("data-value");y&&(g=parseInt(y))}const b=`<div class="av__cell${h==="checkbox"?" av__cell-uncheck":""}" 
data-field-id="${m.dataset.fieldId}" 
data-wrap="${m.dataset.wrap}" 
data-dtype="${m.dataset.dtype}" 
${h==="block"?' data-detached="true"':""}>${li(si(h,null),g,!1,i)}</div>`;m.previousElementSibling.classList.contains("av__gallery-name")?c+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${m.parentElement.dataset.empty}">
    ${m.previousElementSibling.outerHTML}
    ${b}
</div>`:c+=`<div class="av__gallery-field" data-empty="${m.parentElement.dataset.empty}">
    ${m.previousElementSibling.outerHTML}
    ${b}
</div>`}),an(["galleryItem"],t.blockElement);let d="";const u=((n=l==null?void 0:l.querySelector(".av__gallery-cover"))==null?void 0:n.className)||"fn__none";t.srcIDs.forEach(()=>{d+=`<div class="av__gallery-item" data-type="ghost">
    <div class="${u}"><span style="width: 100%;height: 100%;border-radius: var(--b3-border-radius) var(--b3-border-radius) 0 0;" class="av__pulse"></span></div>
    <div class="av__gallery-fields">${c}</div>
</div>`}),l?l.insertAdjacentHTML("afterend",d):(a=t.blockElement.querySelector(s+".av__gallery"))==null||a.insertAdjacentHTML("afterbegin",d),A("/api/av/getAttributeViewAddingBlockDefaultValues",{avID:t.blockElement.getAttribute("data-av-id"),viewID:t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),groupID:t.groupID,previousID:t.previousId},m=>{if(m.data.values){let f;const g=Object.keys(m.data.values);t.blockElement.querySelectorAll('[data-type="ghost"]').forEach(h=>{h.querySelectorAll(".av__cell").forEach(b=>{if(!f&&b.getAttribute("data-detached")==="true"&&(f=b),g.includes(b.dataset.fieldId)){const y=m.data.values[b.dataset.fieldId];y.type==="checkbox"&&b.parentElement.querySelector(".av__gallery-tip")&&(y.checkbox.content=b.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]),b.innerHTML=li(y,void 0,!1,i),Cp(b,y)}})})}qw(t.blockElement)})},Ba=(t,e)=>Wv(t)?t.getAttribute("data-row-id"):T(t,e==="table"?"av__row":"av__gallery-item").dataset.id,ti=(t,e)=>{const n=T(t,"av__row");if(!n)return;const a=t.querySelector("use");n.classList.contains("av__row--header")||e==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"||e==="unselectAll"?n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck");const s=T(i,"av__row");s&&s.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck");const s=T(i,"av__row");s&&s.classList.add("av__row--select")}):e==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&e==="toggle"?(n.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(e==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&e==="toggle")&&(n.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),oe(B(n)),Es(n)},Es=t=>{const e=B(t);if(!e)return;const n=t.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=t.parentElement.querySelectorAll(".av__row:not(.av__row--header)").length,i=t.parentElement.firstElementChild,s=i.querySelector("use");a===n&&a!==0?(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck")):n===0?(i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck")):n>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));const l=e.querySelector(".av__counter"),o=e.querySelectorAll(".av__row--select:not(.av__row--header)").length;if(o===0){l.classList.add("fn__none");return}l.classList.remove("fn__none"),l.innerHTML=`${o} ${window.siyuan.languages.selected}`},qw=t=>{const e=t.getAttribute("data-av-type");t.querySelectorAll(".av__body").forEach(n=>{const a=n.dataset.pageSize;if(a){const i=n.querySelectorAll(e==="table"?".av__row:not(.av__row--header)":".av__gallery-item").length;parseInt(a)<i&&(n.dataset.pageSize=i.toString())}})},ap=t=>{var e;t.blockElement.querySelector('[data-type="av-search"]').value="";const n=t.groupID?`.av__body[data-group-id="${t.groupID}"] `:"";let a=t.blockElement.querySelector(n+`.av__row[data-id="${t.previousId}"]`)||t.blockElement.querySelector(n+".av__row--header");t.blockElement.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(a=t.blockElement.querySelector(n+".av__row--util").previousElementSibling);const s=t.blockElement.querySelector(`.av__body[data-group-id="${t.groupID}"] `);if(s&&["updated","created"].includes(s.getAttribute("data-dtype"))&&s.getAttribute("data-content")!=="_@today@_"&&(a=(e=t.blockElement.querySelector('.av__body[data-content="_@today@_"] .av__row--util'))==null?void 0:e.previousElementSibling),!a)return;let l='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>';const o=a.querySelectorAll(".av__colsticky .av__cell").length-1;o>-1&&(l='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),a.querySelectorAll(".av__cell").forEach((c,d)=>{var u;let m=1;const f=Zn(c);if(f==="lineNumber"){const g=(u=c.querySelector(".av__celltext"))==null?void 0:u.getAttribute("data-value");g&&(m=parseInt(g))}l+=`<div class="av__cell${f==="checkbox"?" av__cell-uncheck":""}" data-col-id="${c.dataset.colId}" 
data-wrap="${c.dataset.wrap}" 
data-dtype="${c.dataset.dtype}" 
style="width: ${c.style.width};${c.dataset.dtype==="number"?"text-align: right;":""}" 
${f==="block"?' data-detached="true"':""}>${li(si(f,null),m)}</div>`,o===d&&(l+="</div>")});let r="";an(["cell","row"],t.blockElement),t.srcIDs.forEach(()=>{r+=`<div class="av__row" data-type="ghost">
    ${l}
</div>`}),a.insertAdjacentHTML("afterend",r),A("/api/av/getAttributeViewAddingBlockDefaultValues",{avID:t.blockElement.getAttribute("data-av-id"),viewID:t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),groupID:t.groupID,previousID:t.previousId},c=>{if(c.data.values){let d;const u=Object.keys(c.data.values);t.blockElement.querySelectorAll('[data-type="ghost"]').forEach(m=>{m.querySelectorAll(".av__cell").forEach(f=>{if(!d&&f.getAttribute("data-detached")==="true"&&(d=f),u.includes(f.dataset.colId)){const g=c.data.values[f.dataset.colId];f.innerHTML=li(g),Cp(f,g)}})})}qw(t.blockElement)})},ks=(t,e,n)=>{if(t.dataset.avType!=="table")return;const a=t.querySelectorAll(".av__row--header");a.length>0&&(n==="top"||n==="all")&&a.forEach(s=>{const l=s.parentElement.getBoundingClientRect(),o=Math.floor(e.top-l.top);o>0&&o<l.height-s.clientHeight?s.style.transform=`translateY(${o}px)`:s.style.transform=""});const i=t.querySelectorAll(".av__row--footer");i.length>0&&(n==="bottom"||n==="all")&&i.forEach(s=>{if(s.querySelector(".av__calc--ashow")){const l=s.parentElement.getBoundingClientRect(),o=Math.ceil(e.bottom-l.bottom);o<0&&-o<l.height-s.clientHeight?s.style.transform=`translateY(${o}px)`:s.style.transform=""}else s.style.transform=""})},Yo=t=>{var e;if(t.currentPageSize===t.newPageSize)return;t.nodeElement.querySelectorAll(".av__body").forEach(a=>{a.dataset.pageSize=t.newPageSize});const n=t.nodeElement.getAttribute("data-node-id");V(t.protyle,[{action:"setAttrViewPageSize",avID:t.avID,data:parseInt(t.newPageSize),blockID:n}],[{action:"setAttrViewPageSize",data:parseInt(t.currentPageSize),avID:t.avID,blockID:n}]),(e=document.querySelector(".av__panel"))==null||e.remove()},Fw=t=>{const e=new dt(p.MENU_AV_PAGE_SIZE);if(e.isOpen)return;const n=t.target.dataset.size;e.addItem({iconHTML:"",label:"5",checked:n==="5",click(){Yo({currentPageSize:n,newPageSize:"5",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",label:"10",checked:n==="10",click(){Yo({currentPageSize:n,newPageSize:"10",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n==="25",label:"25",click(){Yo({currentPageSize:n,newPageSize:"25",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n==="50",label:"50",click(){Yo({currentPageSize:n,newPageSize:"50",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n==="100",label:"100",click(){Yo({currentPageSize:n,newPageSize:"100",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",checked:n===p.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){Yo({currentPageSize:n,newPageSize:p.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}});const a=t.target.getBoundingClientRect();e.open({x:a.left,y:a.bottom})},Uw=(t,e)=>{const n=t.querySelectorAll(".av__row--select:not(.av__row--header), .av__gallery-item--select");if(n.length===0)return;const a=t.getAttribute("data-av-id"),i=[],s=[];n.forEach(o=>{s.push(o.getAttribute("data-id"))}),n.forEach(o=>{var r;const c=Ci("block",o.querySelector('.av__cell[data-dtype="block"]'));i.push({action:"insertAttrViewBlock",avID:a,previousID:((r=o.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcs:[{itemID:Lute.NewNodeID(),id:o.getAttribute("data-id"),isDetached:c.isDetached,content:c.block.content}],blockID:t.dataset.nodeId,groupID:o.parentElement.getAttribute("data-group-id")})});const l=Q().format("YYYYMMDDHHmmss");i.push({action:"doUpdateUpdated",id:t.dataset.nodeId,data:t.getAttribute("updated")}),V(e,[{action:"removeAttrViewBlock",srcIDs:s,avID:a},{action:"doUpdateUpdated",id:t.dataset.nodeId,data:l}],i),n.forEach(o=>{o.remove()}),ks(t,e.contentElement.getBoundingClientRect(),"all"),Es(t.querySelector(".av__row")),t.setAttribute("updated",l)},Ss=t=>{const e=t.blockElement.getAttribute("data-av-id"),n=[],a=[];new Array(t.count).fill(0).forEach(()=>{const s=Lute.NewNodeID();n.push(s),a.push({itemID:Lute.NewNodeID(),id:s,isDetached:!0,content:""})});const i=Q().format("YYYYMMDDHHmmss");V(t.protyle,[{action:"insertAttrViewBlock",avID:e,previousID:t.previousID,srcs:a,blockID:t.blockElement.dataset.nodeId,groupID:t.groupID},{action:"doUpdateUpdated",id:t.blockElement.dataset.nodeId,data:i}],[{action:"removeAttrViewBlock",srcIDs:n,avID:e},{action:"doUpdateUpdated",id:t.blockElement.dataset.nodeId,data:t.blockElement.getAttribute("updated")}]),["gallery","kanban"].includes(t.blockElement.getAttribute("data-av-type"))?Rw({blockElement:t.blockElement,protyle:t.protyle,srcIDs:n,previousId:t.previousID,groupID:t.groupID}):ap({protyle:t.protyle,blockElement:t.blockElement,srcIDs:n,previousId:t.previousID,groupID:t.groupID}),t.blockElement.setAttribute("updated",i)},uh=(t,e,n,a=!0,i)=>{A("/api/av/searchAttributeView",{keyword:e,excludes:a&&n?[n]:void 0},s=>{let l="";s.data.results.forEach((o,r)=>{const c=o.children&&o.children.length>0&&a;l+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${o.avID}" data-block-id="${o.blockID}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl${a?"":" fn__none"}" style="height:auto;align-self: stretch;margin: 4px 0;">
        <svg class="b3-list-item__arrow">${c?'<use xlink:href="#iconRight"></use>':""}</svg>
    </span>
    <span class="fn__space--small"></span>
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${he(o.avName||window.siyuan.languages._kernel[267])}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${_i(o.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${o.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`,c&&(l+='<div class="fn__none">',o.children.forEach(d=>{const u=Bw(d.viewLayout);l+=`<div style="padding-left: 48px;" class="b3-list-item b3-list-item--narrow" data-av-id="${d.avID}" data-view-id="${d.viewID}">
<span class="b3-list-item__text">${he(d.viewName)}</span> 
<span class="b3-list-item__meta">${u}</span>
</div>`}),l+="</div>")}),t.innerHTML=l,i&&i()})},Ww=(t,e,n)=>{e.dataset.avId=n.dataset.avId,e.dataset.blockId=n.dataset.blockId,e.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const a=T(e,"b3-menu__items");a&&Nc(a,t,!0)},Pc=(t,e,n,a=!0)=>{window.siyuan.menus.menu.remove();const i=new dt;i.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter"${Y()?"":' style="width: 50vw"'} >
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(l){const o=l.querySelector(".b3-list"),r=l.querySelector("input");r.addEventListener("keydown",c=>{if(!c.isComposing&&(IA(o,c),c.key==="Enter")){c.preventDefault(),c.stopPropagation();const d=o.querySelector(".b3-list-item--focus");n?n(d):Ww(t,e,d),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",c=>{c.stopPropagation(),!c.isComposing&&uh(o,r.value,t,a)}),r.addEventListener("compositionend",()=>{uh(o,r.value,t,a)}),l.lastElementChild.addEventListener("click",c=>{let d=c.target;for(;d&&!d.classList.contains("b3-list");){if(d.classList.contains("b3-list-item__toggle")){d.firstElementChild.classList.contains("b3-list-item__arrow--open")?(d.firstElementChild.classList.remove("b3-list-item__arrow--open"),d.parentElement.nextElementSibling.classList.add("fn__none")):(d.firstElementChild.classList.add("b3-list-item__arrow--open"),d.parentElement.nextElementSibling.classList.remove("fn__none")),c.preventDefault(),c.stopPropagation();break}else if(d.classList.contains("b3-list-item")){c.preventDefault(),c.stopPropagation(),n?n(d):Ww(t,e,d),window.siyuan.menus.menu.remove();break}d=d.parentElement}}),uh(o,"",t,a,()=>{const c=e.getBoundingClientRect();i.open({x:c.left,y:c.bottom,h:c.height}),l.querySelector("input").focus()})}}),i.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const s=He(e,"block__popover",!0);i.element.setAttribute("data-from",s?s.dataset.level+"popover":"app")},JA=t=>{const e=t.avElement.querySelector('input[data-type="colName"]'),a=t.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),i=t.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let s;t.colsData.find(o=>{if(o.id===i)return o.relation||(o.relation={}),s=o,!0});const l=t.avElement.querySelector('[data-type="name"]').value;V(t.protyle,[{action:"updateAttrViewColRelation",avID:t.avID,keyID:i,id:a||s.relation.avID,backRelationKeyID:s.relation.avID===a&&s.relation.backKeyID||Lute.NewNodeID(),isTwoWay:t.avElement.querySelector(".b3-switch").checked,name:e.value,format:l},{action:"doUpdateUpdated",id:t.blockElement.getAttribute("data-node-id"),data:Q().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColRelation",avID:t.avID,keyID:i,id:s.relation.avID||a,backRelationKeyID:s.relation.backKeyID,isTwoWay:s.relation.isTwoWay,name:e.dataset.oldValue,format:s.name}]),t.avElement.remove(),On(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:l}),oe(t.blockElement)},Nc=(t,e,n=!1)=>{const a=t.querySelector('.b3-menu__item[data-type="goSearchAV"]'),i=a.nextElementSibling,s=i.querySelector(".b3-switch"),l=i.nextElementSibling,o=l.nextElementSibling,r=JSON.parse(a.dataset.oldValue);if(r.avID){const c=l.querySelector("input");n&&(a.dataset.avId!==r.avID?(c.value="",s.checked=!1):(c.value=c.dataset.oldValue,s.checked=r.isTwoWay)),s.checked?l.classList.remove("fn__none"):l.classList.add("fn__none"),a.dataset.avId&&r.avID!==a.dataset.avId||r.isTwoWay!==s.checked||c.dataset.oldValue!==c.value?o.classList.remove("fn__none"):o.classList.add("fn__none")}else a.dataset.avId&&(s.checked?l.classList.remove("fn__none"):l.classList.add("fn__none"),o.classList.remove("fn__none"))},fh=t=>{const e=t.querySelector(".b3-form__icona .b3-text-field");t.querySelector(".b3-menu__icon.fn__grab")?(e.nextElementSibling.classList.remove("fn__none"),e.style.paddingRight="26px"):(e.nextElementSibling.classList.add("fn__none"),e.style.paddingRight="")},ni=t=>{if(t.type==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label fn__ellipsis ${t.isDetached?"":" popover__block"}" ${t.isDetached?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t.id}">${t.text}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(t.type==="empty")return t.newName?`<button class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis">${window.siyuan.languages.newRowInRelation.replace("${x}",t.text).replace("${y}",t.newName)}</span>
</button>`:`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(t.type=="unselect")return`<button data-row-id="${t.rowId}" class="${t.className||"b3-menu__item ariaLabel"}" data-position="west" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis${t.isDetached?"":" popover__block"}" ${t.isDetached?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t.id}">${t.text}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},Vw=(t,e,n)=>{A("/api/av/getAttributeViewPrimaryKeyValues",{id:t.firstElementChild.getAttribute("data-av-id"),keyword:n},a=>{const i=a.data.rows.values||[];let s="",l="";const o=[];e.querySelectorAll(".av__cell--relation").forEach(c=>{const d=c.querySelector(".av__celltext");o.push(c.dataset.rowId),l+=`<button data-row-id="${c.dataset.rowId}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel${d.textContent.indexOf(n)>-1?"":" fn__none"}" 
draggable="true">${ni({type:"selected",id:d.dataset.id,isDetached:!d.classList.contains("av__celltext--ref"),text:Lute.EscapeHTMLStr(d.textContent||window.siyuan.languages.untitled)})}</button>`}),i.forEach(c=>{o.includes(c.blockID)||(s+=ni({type:"unselect",rowId:c.blockID,id:c.block.id,isDetached:c.isDetached,text:Lute.EscapeHTMLStr(c.block.content||window.siyuan.languages.untitled)}))});const r=t.querySelector(".popover__block");t.querySelector(".b3-menu__items").innerHTML=`${l}
<button class="b3-menu__separator"></button>
${s}
${n?ni({type:"empty",newName:Lute.EscapeHTMLStr(n),text:`<span style="color: var(--b3-protyle-inline-blockref-color);" class="popover__block" data-id="${r.getAttribute("data-id")}">${r.textContent}</span>`}):s?"":ni({type:"empty"})}`,t.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current"),fh(t)})},XA=t=>{A("/api/av/getAttributeViewPrimaryKeyValues",{id:t.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},e=>{const n=e.data.rows.values||[];let a="",i="";const s=[];t.cellElements[0].querySelectorAll(".av__cell--relation").forEach(d=>{const u=d.querySelector(".av__celltext");s.push(d.dataset.rowId),i+=`<button data-row-id="${d.dataset.rowId}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${ni({type:"selected",id:u.dataset.id,isDetached:!u.classList.contains("av__celltext--ref"),text:Lute.EscapeHTMLStr(u.textContent||window.siyuan.languages.untitled)})}</button>`}),n.forEach(d=>{s.includes(d.blockID)||(a+=ni({type:"unselect",rowId:d.blockID,id:d.block.id,isDetached:d.isDetached,text:Lute.EscapeHTMLStr(d.block.content||window.siyuan.languages.untitled)}))}),t.menuElement.querySelector(".b3-menu__items").innerHTML=`${i}
<button class="b3-menu__separator"></button>
${a||ni({type:"empty"})}`;const l=t.cellElements[t.cellElements.length-1].getBoundingClientRect();Te(t.menuElement,l.left,l.bottom,l.height),t.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const o=t.menuElement.querySelector("input");o.focus();const r=o.parentElement.parentElement.querySelector(".popover__block");r.innerHTML=Lute.EscapeHTMLStr(e.data.name),r.setAttribute("data-id",e.data.blockIDs[0]);const c=t.menuElement.querySelector(".b3-menu__items");o.addEventListener("keydown",d=>{if(d.isComposing)return;xn(c,d,"b3-menu__item--current");const u=t.menuElement.querySelector(".b3-menu__item--current");d.key==="Enter"&&u&&u.getAttribute("data-type")==="setRelationCell"&&(Yw(t.protyle,t.blockElement,u,t.cellElements),d.preventDefault(),d.stopPropagation())}),o.addEventListener("input",d=>{d.isComposing||(Vw(t.menuElement,t.cellElements[0],o.value),d.stopPropagation())}),o.addEventListener("compositionend",d=>{d.stopPropagation(),Vw(t.menuElement,t.cellElements[0],o.value)}),fh(t.menuElement),t.menuElement.querySelector('[data-type="copyRelatedItems"]').addEventListener("click",()=>{let d="";const u=t.menuElement.querySelectorAll('.b3-menu__item[draggable="true"]');u.forEach(m=>{u.length>1&&(d+="- ");const f=m.querySelector(".b3-menu__label");!f.dataset.id||f.dataset.id==="undefined"?d+=f.textContent+`
`:d+=`((${f.dataset.id} "${f.textContent}"))
`}),d&&(Be(d.trimEnd()),de(window.siyuan.languages.copied))})})},QA=(t,e)=>{let n;return yt(t).find(a=>{if(a.id===Xn(e[0],t.viewType))return n=a.relation,!0}),n&&n.avID?`<div data-av-id="${n.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <div class="b3-form__icona fn__flex-1" style="overflow: visible">
        <input class="b3-text-field fn__block" style="min-width: 190px"/>
        <svg class="b3-form__icona-icon ariaLabel fn__none" data-position="north" data-type="copyRelatedItems" aria-label="${window.siyuan.languages.copy} ${window.siyuan.languages.relatedItems}"><use xlink:href="#iconCopy"></use></svg>
    </div>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);max-width: 200px" data-id="" class="popover__block fn__pointer fn__ellipsis"></span>
</div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},Yw=(t,e,n,a)=>{const i=T(n,"b3-menu");if(!i||i.querySelector(".dragover__bottom, .dragover__top"))return;if(!e.contains(a[0])){const l=e.getAttribute("data-av-type"),o=Ba(a[0],l);l==="table"?a[0]=e.querySelector(`.av__row[data-id="${o}"] .av__cell[data-col-id="${a[0].dataset.colId}"]`)||e.querySelector(`.fn__flex-1[data-col-id="${a[0].dataset.colId}"]`):a[0]=e.querySelector(`.av__gallery-item[data-id="${o}"] .av__cell[data-field-id="${a[0].dataset.fieldId}"]`)}const s={blockIDs:[],contents:[]};if(i.querySelectorAll('[draggable="true"]').forEach(l=>{const o=l.getAttribute("data-row-id"),r=l.querySelector(".b3-menu__label");s.blockIDs.push(o),s.contents.push({type:"block",block:{id:r.getAttribute("data-id"),content:r.textContent},isDetached:!r.classList.contains("popover__block")})}),n.classList.contains("b3-menu__item")){const l=n.getAttribute("data-row-id"),o=n.querySelector(".b3-menu__label").getAttribute("data-id"),r=i.querySelector(".b3-menu__separator"),c=i.querySelector("input").value;if(n.getAttribute("draggable")){!r.nextElementSibling.getAttribute("data-row-id")&&!c&&r.nextElementSibling.remove();const d=s.blockIDs.indexOf(l);s.blockIDs.splice(d,1),s.contents.splice(d,1),r.after(n),n.outerHTML=ni({type:"unselect",rowId:l,id:o,isDetached:!n.querySelector(".popover__block"),text:Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent),className:n.className})}else if(l)s.blockIDs.push(l),s.contents.push({type:"block",block:{id:o,content:n.firstElementChild.textContent},isDetached:!n.firstElementChild.getAttribute("style")}),r.before(n),n.outerHTML=`<button data-row-id="${l}" data-position="west" data-type="setRelationCell" class="${n.className}" 
draggable="true">${ni({type:"selected",rowId:l,id:o,isDetached:!n.querySelector(".popover__block"),text:Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent)})}</button>`,r.nextElementSibling||r.insertAdjacentHTML("afterend",ni({type:"empty"}));else{const d=n.querySelector(".popover__block").getAttribute("data-id"),u=n.querySelector("b").textContent,m=Lute.NewNodeID(),f=T(a[0],"av__body");V(t,[{action:"insertAttrViewBlock",avID:i.firstElementChild.getAttribute("data-av-id"),srcs:[{itemID:m,id:Lute.NewNodeID(),isDetached:!0,content:u}],blockID:d,groupID:f?f.getAttribute("data-group-id"):""},{action:"doUpdateUpdated",id:d,data:Q().format("YYYYMMDDHHmmss")}]),s.blockIDs.push(m),s.contents.push({type:"block",block:{content:u},isDetached:!0}),r.insertAdjacentHTML("beforebegin",`<button data-row-id="${m}" data-position="west" data-type="setRelationCell" 
class="${n.className} ariaLabel" draggable="true">${ni({type:"selected",rowId:m,isDetached:!0,text:Lute.EscapeHTMLStr(u)})}</button>`)}}Bn(t,e,s,a),fh(i)},ph=t=>{const e=[];t.forEach(n=>{const a=n.getAttribute("data-node-id");a&&e.push({itemID:Lute.NewNodeID(),id:a,isDetached:!1})}),e.length>0&&Pc("",t[0],n=>{const a=n.dataset.avId,i=n.dataset.viewId;V(void 0,[{action:"insertAttrViewBlock",ignoreDefaultFill:!i,viewID:i,avID:a,srcs:e,blockID:n.dataset.blockId},{action:"doUpdateUpdated",id:n.dataset.blockId,data:Q().format("YYYYMMDDHHmmss")}])})},ip=(t,e,n)=>{var a,i;if(e&&((i=(a=t.title)==null?void 0:a.editElement)!=null&&i.contains(e.startContainer))||n==="title")Pc("",t.breadcrumb.element,s=>{const l=s.dataset.avId,o=s.dataset.viewId;V(t,[{action:"insertAttrViewBlock",ignoreDefaultFill:!o,viewID:o,avID:l,srcs:[{itemID:Lute.NewNodeID(),id:t.block.rootID,isDetached:!1}],blockID:s.dataset.blockId},{action:"doUpdateUpdated",id:s.dataset.blockId,data:Q().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[t.block.rootID],avID:l}]),ne(e)});else{let s;const l=[];if(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(o=>{s||(s=o),l.push(o.getAttribute("data-node-id"))}),!s){const o=B(e.startContainer);o&&(s=o,l.push(o.getAttribute("data-node-id")))}s||(s=t.wysiwyg.element,l.push(t.block.rootID)),Pc("",s,o=>{const r=[],c=[];l.forEach(m=>{r.push(m),c.push({itemID:Lute.NewNodeID(),id:m,isDetached:!1})});const d=o.dataset.avId,u=o.dataset.viewId;V(t,[{action:"insertAttrViewBlock",ignoreDefaultFill:!u,viewID:u,avID:d,srcs:c,blockID:o.dataset.blockId},{action:"doUpdateUpdated",id:o.dataset.blockId,data:Q().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:r,avID:d}]),ne(e)})}};var zw=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Gw=(t,e)=>{if(window.siyuan.menus.menu.element.setAttribute("data-from",p.MENU_FROM_DOC_TREE_MORE_ITEMS),!Array.from(t).find(i=>{if(i.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;const a=[];if(t.forEach(i=>{const s=i.getAttribute("data-node-id");s&&a.push(s)}),a.length>0&&window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:xs(a).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){a.forEach(i=>{A("/api/filetree/duplicateDoc",{id:i})})}}])}).element),window.siyuan.menus.menu.append(Zh(Zm(Array.from(t)))),a.length>0&&window.siyuan.menus.menu.append(new N({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{ph(Array.from(t))}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{zf(Array.from(t))}}).element),a.length===0)return window.siyuan.menus.menu;if(window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){const i=[{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{V(void 0,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{V(void 0,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{Ic(e,a)}}),window.siyuan.menus.menu.append(new N({id:"riffCard",label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:i}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element)}return nh(e,a),window.siyuan.menus.menu.append(new N({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const i=de(window.siyuan.languages.exporting,-1);A(" /api/export/exportMds",{ids:a},s=>{At(i),nn(s.data.zip)})}}]}).element),e.plugins&&zn({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:t,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},sp=(t,e)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_DOC_TREE_MORE);const n=U(e,"DIV");if(!n)return window.siyuan.menus.menu;e.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(l=>{l.classList.remove("b3-list-item--focus"),l.removeAttribute("select-end"),l.removeAttribute("select-start")}),e.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return Gw(a,t);window.siyuan.menus.menu.element.setAttribute("data-from",p.MENU_FROM_DOC_TREE_MORE_NOTEBOOK);const i=e.parentElement.getAttribute("data-url"),s=Qa(i);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(zv({path:"/",notebookId:i,name:s,type:"notebook"})),window.siyuan.menus.menu.append(new N({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{A("/api/notebook/getNotebookConf",{notebook:i},o=>{UA(o.data)})}}).element);const l=Kw("notebook",parseInt(e.parentElement.getAttribute("data-sortmode")),o=>(A("/api/notebook/setNotebookConf",{notebook:i,conf:{sortMode:o}},()=>{var r;e.parentElement.setAttribute("data-sortmode",o.toString());let c;c=nt("file").data.file;const d=e.querySelector(".b3-list-item__arrow--open");d&&(d.classList.remove("b3-list-item__arrow--open"),(r=e.nextElementSibling)==null||r.remove(),c.getLeaf(e,i))}),!0));window.siyuan.menus.menu.append(new N({id:"sort",icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element)}return window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{A("/api/riff/getNotebookRiffDueCards",{notebook:i},l=>{Sl(t,l.data,"notebook",i,s)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{Vo(t,i,s,"Notebook")}}]}).element),window.siyuan.menus.menu.append(new N({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){Hn({app:t,hotkey:p.DIALOG_SEARCH,notebookId:i})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){Hn({app:t,hotkey:p.DIALOG_REPLACE,notebookId:i})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"close",label:window.siyuan.languages.close,icon:"iconClose",click:()=>{A("/api/notebook/closeNotebook",{notebook:i})}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{zf(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),jw(i,"/"),window.siyuan.menus.menu.append(new N({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const l=de(window.siyuan.languages.exporting,-1);A("/api/export/exportNotebookSY",{id:i},o=>{At(l),nn(o.data.zip)})}},{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const l=de(window.siyuan.languages.exporting,-1);A("/api/export/exportNotebookMd",{notebook:i},o=>{At(l),nn(o.data.zip)})}}]}).element),t.plugins&&zn({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},lp=(t,e,n,a)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_DOC_TREE_MORE);const i=U(a,"DIV");if(!i)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(i.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const s=i.querySelectorAll(".b3-list-item--focus");if(s.length>1)return Gw(s,t);const l=a.getAttribute("data-node-id");let o=a.getAttribute("data-name");if(o=xt(o,!1,!0),!window.siyuan.config.readonly){let r,c;const d=ot(a,"UL");if((window.siyuan.config.fileTree.sort===6||d&&d.dataset.sortmode==="6")&&(window.siyuan.menus.menu.append(new N({id:"newDocAbove",icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const u=[];Array.from(a.parentElement.children).forEach(m=>{m.tagName==="LI"&&(m===a&&u.push(void 0),u.push(m.getAttribute("data-path")))}),ki({app:t,notebookId:e,currentPath:De().dirname(n),paths:u,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new N({id:"newDocBelow",icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const u=[];Array.from(a.parentElement.children).forEach(m=>{m.tagName==="LI"&&(u.push(m.getAttribute("data-path")),m===a&&u.push(void 0))}),ki({app:t,notebookId:e,currentPath:De().dirname(n),paths:u,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:xs([l]).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){A("/api/filetree/duplicateDoc",{id:l})}}])}).element),window.siyuan.menus.menu.append(Zh(Zm(Array.from(i.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new N({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{ph([a])}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{zf(Array.from(i.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(zv({path:n,notebookId:e,name:o,type:"file"})),window.siyuan.menus.menu.append(new N({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",click(){A("/api/block/getDocInfo",{id:l},u=>{fa(u.data.ial)})}}).element),!window.siyuan.config.readonly){const u=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{A("/api/riff/getTreeRiffDueCards",{rootID:l},m=>{Sl(t,m.data,"doc",l,o)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{A("/api/filetree/getHPathByID",{id:l},m=>{Vo(t,l,De().join(Qa(e),m.data),"Tree")})}},{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{V(void 0,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[l]}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[l]}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{V(void 0,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[l]}],[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[l]}])}}];window.siyuan.config.flashcard.deck&&u.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{Ic(t,[l])}}),window.siyuan.menus.menu.append(new N({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:u}).element)}window.siyuan.menus.menu.append(new N({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return zw(this,null,function*(){const u=xt(n,!1,!0);Hn({app:t,hotkey:p.DIALOG_SEARCH,notebookId:e,searchPath:u})})}}).element),window.siyuan.menus.menu.append(new N({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return zw(this,null,function*(){const u=xt(n,!1,!0);Hn({app:t,hotkey:p.DIALOG_REPLACE,notebookId:e,searchPath:u})})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element)}return nh(t,[l],e,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){$w({app:t,id:l,notebookId:e,pathString:o})}}).element),jw(e,n),window.siyuan.menus.menu.append(Yv(l)),t.plugins&&zn({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:s,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu.element.setAttribute("data-from",p.MENU_FROM_DOC_TREE_MORE_DOC),window.siyuan.menus.menu},jw=(t,e)=>{if(window.siyuan.config.readonly)return;const n=()=>{let a;a=nt("file").data.file;const i=a.element.querySelector(`[data-path="${e}"]`);i.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),a.getLeaf(i,t,!0),window.siyuan.menus.menu.remove()};window.siyuan.menus.menu.append(new N({id:"import",icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{id:"importSiYuanZip",icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),s.append("notebook",t),s.append("toPath",e),A("/api/import/importSY",s,()=>{n()})})}},{id:"importMarkdownZip",icon:"iconMarkdown",label:'Markdown .zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),s.append("notebook",t),s.append("toPath",e),A("/api/import/importZipMd",s,()=>{n()})})}}]}).element)},Kw=(t,e,n)=>{const a=[{id:"fileNameASC",icon:e===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{id:"fileNameDESC",icon:e===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{id:"fileNameNatASC",icon:e===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{id:"fileNameNatDESC",icon:e===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{id:"separator_1",type:"separator"},{id:"createdASC",icon:e===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{id:"createdDESC",icon:e===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{id:"modifiedASC",icon:e===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{id:"modifiedDESC",icon:e===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{id:"separator_2",type:"separator"},{id:"refCountASC",icon:e===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{id:"refCountDESC",icon:e===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{id:"separator_3",type:"separator"},{id:"docSizeASC",icon:e===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{id:"docSizeDESC",icon:e===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{id:"separator_4",type:"separator"},{id:"subDocCountASC",icon:e===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{id:"subDocCountDESC",icon:e===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{id:"separator_5",type:"separator"},{id:"customSort",icon:e===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return t==="notebook"&&a.push({id:"sortByFiletree",icon:e===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a},op=(t,e)=>{A("/api/filetree/createDailyNote",{notebook:e,app:p.SIYUAN_APPID},n=>{ve({app:t,id:n.data.id,action:[p.CB_GET_FOCUS]})})},gh=t=>{if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===p.DIALOG_DIALYNOTE)return s.destroy(),!0}))return;const n=Qm();if(n===0){de(window.siyuan.languages.newFileTip);return}if(n===1){let s="";window.siyuan.notebooks.find(l=>{l.closed||(s=l.id)}),op(t,s);return}const a=window.siyuan.storage[p.LOCAL_DAILYNOTEID],i=window.siyuan.notebooks.find(s=>{if(s.id===a&&!s.closed)return!0});if(a&&i&&!Y())op(t,a);else{let s="";window.siyuan.notebooks.forEach(c=>{c.closed||(s+=`<option value="${c.id}">${c.name}</option>`)});const l=new $e({positionId:p.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${s}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});l.element.setAttribute("data-key",p.DIALOG_DIALYNOTE);const o=l.element.querySelectorAll(".b3-button"),r=l.element.querySelector(".b3-select");r.value=a,o[0].addEventListener("click",()=>{l.destroy()}),o[1].addEventListener("click",()=>{const c=r.value;window.siyuan.storage[p.LOCAL_DAILYNOTEID]=c,Ee(p.LOCAL_DAILYNOTEID,window.siyuan.storage[p.LOCAL_DAILYNOTEID]),op(t,c),l.destroy()})}},rp=()=>{const t=p.HELP_PATH[window.siyuan.config.appearance.lang];A("/api/notebook/removeNotebook",{notebook:t,callback:p.CB_MOUNT_REMOVE},()=>{A("/api/notebook/openNotebook",{notebook:t,app:p.SIYUAN_APPID})})},Zw=()=>{const t=new $e({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});t.element.setAttribute("data-key",p.DIALOG_CREATENOTEBOOK);const e=t.element.querySelectorAll(".b3-button");t.bindInput(t.element.querySelector("input"),()=>{e[1].dispatchEvent(new CustomEvent("click"))}),e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input").value;if(!Ff(n))return!1;A("/api/notebook/createNotebook",{name:n}),t.destroy()})};var mh=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class Ki extends ia{constructor(e){super({app:e.app,type:"filetree",id:e.tab.id,msgCallback(a){if(a)switch(a.cmd){case"reloadDocInfo":this.updateDocInfo(a);break;case"moveDoc":this.onMove(a);break;case"reloadFiletree":Gi(()=>{this.init(!1)});break;case"mount":this.onMount(a),e.app.plugins.forEach(i=>{i.eventBus.emit("opened-notebook",a)});break;case"createnotebook":Gi(i=>{let s;i.find(l=>{if(!l.closed){if(l.id===a.data.box.id)return s?this.element.querySelector(`.b3-list[data-url="${s}"]`).insertAdjacentHTML("afterend",this.genNotebook(a.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(a.data.box)),!0;s=l.id}})});break;case"unmount":this.onRemove(a),e.app.plugins.forEach(i=>{i.eventBus.emit("closed-notebook",a)});break;case"removeDoc":this.onRemove(a);break;case"create":a.data.listDocTree?this.selectItem(a.data.box.id,a.data.path):this.updateItemArrow(a.data.box.id,a.data.path);break;case"createdailynote":case"heading2doc":case"li2doc":this.selectItem(a.data.box.id,a.data.path);break;case"renamenotebook":this.element.querySelector(`[data-url="${a.data.box}"] .b3-list-item__text`).innerHTML=he(a.data.name);break;case"rename":this.onRename(a.data);break}}}),this.lastSelectedElement=null,e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__file"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconFiles"></use></svg>${window.siyuan.languages.fileTree}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="focus" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.selectOpen1}${Pt(window.siyuan.config.keymap.general.selectOpen1.custom)}"><svg><use xlink:href='#iconFocus'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse}${Pt(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <div class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></div>
    <div data-type="more" class="b3-tooltips b3-tooltips__sw block__icon${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="padding-top: 2px;"></div>
<ul class="b3-list fn__flex-column" style="min-height: auto;height:30px;transition: height  .2s cubic-bezier(0, 0, .2, 1) 0ms">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
        <span class="counter" style="cursor: auto"></span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=e.tab.panelElement.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=e.tab.panelElement.lastElementChild,this.closeElement.addEventListener("click",a=>{gt(this.element.parentElement);let i=a.target;for(;i&&!i.isEqualNode(this.closeElement);){const s=i.getAttribute("data-type");if(i.classList.contains("b3-list-item__icon")){a.preventDefault(),a.stopPropagation();const l=i.getBoundingClientRect();Xa(i.parentElement.getAttribute("data-url"),"notebook",{x:l.left,y:l.bottom,h:l.height,w:l.width},void 0,i.querySelector("img"));break}else if(s==="toggle"){const l=i.querySelector("svg");l.classList.contains("b3-list-item__arrow--open")?(this.closeElement.style.height="30px",l.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",l.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none")),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}else if(s==="open"){A("/api/notebook/openNotebook",{notebook:i.getAttribute("data-url")}),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}i=i.parentElement}}),this.actionsElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{Array.from(this.element.children).forEach(a=>{const i=a.firstElementChild,s=i.querySelector(".b3-list-item__arrow");s.classList.contains("b3-list-item__arrow--open")&&(s.classList.remove("b3-list-item__arrow--open"),i.nextElementSibling.remove())}),window.siyuan.storage[p.LOCAL_FILESPATHS]=[],Ee(p.LOCAL_FILESPATHS,[])}),this.actionsElement.addEventListener("click",a=>{let i=a.target;for(;i&&!i.isEqualNode(this.actionsElement);){const s=i.getAttribute("data-type");if(s==="min"){nt("file").toggleModel("file",!1,!0),a.preventDefault(),a.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(s==="focus"){PE(),a.preventDefault();break}else if(s==="more"){this.initMoreMenu().popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break}i=i.parentElement}gt(this.element.parentElement)}),this.element.addEventListener("mousedown",a=>{if(a.button!==1||!window.siyuan.config.fileTree.openFilesUseCurrentTab)return;let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.tagName==="LI"&&!i.getAttribute("data-opening")){i.setAttribute("data-opening","true"),ve({app:e.app,removeCurrentTab:!1,id:i.getAttribute("data-node-id"),action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL],afterOpen(){i.removeAttribute("data-opening")}}),a.stopPropagation(),a.preventDefault();break}i=i.parentElement}}),this.element.addEventListener("click",a=>{var i,s;let l=a.target;const o=ot(l,"UL");let r=!0;if(o){const c=o.getAttribute("data-url");for(;l&&!l.isEqualNode(this.element);){if(et(a)&&l.classList.contains("b3-list-item__icon")&&window.siyuan.config.system.container!=="ios"){a.preventDefault(),a.stopPropagation();const d=l.getBoundingClientRect();l.parentElement.getAttribute("data-type")==="navigation-file"?Xa(l.parentElement.getAttribute("data-node-id"),"doc",{x:d.left,y:d.bottom,h:d.height,w:d.width},void 0,l.querySelector("img")):Xa(l.parentElement.parentElement.getAttribute("data-url"),"notebook",{x:d.left,y:d.bottom,h:d.height,w:d.width},void 0,l.querySelector("img"));break}else if(et(a)&&l.classList.contains("b3-list-item__toggle")){this.getLeaf(l.parentElement,c),a.preventDefault(),a.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(et(a)&&l.classList.contains("b3-list-item__action")){const d=l.getAttribute("data-type"),u=l.parentElement.getAttribute("data-path");window.siyuan.config.readonly||(d==="new"?ki({app:e.app,notebookId:c,currentPath:u,useSavePath:!1,listDocTree:!0}):d==="more-root"?sp(e.app,l.parentElement).popup({x:a.clientX,y:a.clientY}):d==="addLocal"&&(A("/api/filetree/moveLocalShorthands",{notebook:c}),this.element.querySelectorAll('[data-type="addLocal"]').forEach(m=>{m.remove()}))),d==="more-file"&&lp(e.app,c,u,l.parentElement).popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break}else if(l.tagName==="LI"){if(Wt(a)&&!a.altKey&&!a.shiftKey)l.classList.toggle("b3-list-item--focus"),this.lastSelectedElement=l;else if(a.shiftKey&&!a.altKey&&et(a)){document.contains(this.lastSelectedElement)||(this.lastSelectedElement=null),this.lastSelectedElement||(this.lastSelectedElement=this.element.querySelector(".b3-list-item--focus")),this.lastSelectedElement||(this.lastSelectedElement=l.parentElement.firstElementChild),this.element.querySelectorAll(".b3-list-item--focus").forEach(h=>{h.classList.remove("b3-list-item--focus")});const d=Array.from(this.element.querySelectorAll("li.b3-list-item")),u=d.indexOf(this.lastSelectedElement),m=d.indexOf(l),f=Math.min(u,m),g=Math.max(u,m);for(let h=f;h<=g;h++)d[h].classList.add("b3-list-item--focus")}else if(this.lastSelectedElement=l,this.setCurrent(l,!1),l.getAttribute("data-type")==="navigation-file"){if(r=!1,l.getAttribute("data-opening"))return;l.setAttribute("data-opening","true"),a.altKey&&et(a)&&!a.shiftKey?ve({app:e.app,id:l.getAttribute("data-node-id"),position:"right",action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL],afterOpen(){l.removeAttribute("data-opening")}}):!a.altKey&&Wt(a)&&a.shiftKey?ve({app:e.app,id:l.getAttribute("data-node-id"),position:"bottom",action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL],afterOpen(){l.removeAttribute("data-opening")}}):window.siyuan.config.fileTree.openFilesUseCurrentTab&&a.altKey&&Wt(a)&&!a.shiftKey?ve({app:e.app,removeCurrentTab:!1,id:l.getAttribute("data-node-id"),action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL],afterOpen(){l.removeAttribute("data-opening")}}):ve({app:e.app,id:l.getAttribute("data-node-id"),action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL],afterOpen(){l.removeAttribute("data-opening")}})}else l.getAttribute("data-type")==="navigation-root"&&this.getLeaf(l,c);(i=this.element.querySelector('[select-end="true"]'))==null||i.removeAttribute("select-end"),(s=this.element.querySelector('[select-start="true"]'))==null||s.removeAttribute("select-start"),window.siyuan.menus.menu.remove(),a.stopPropagation(),a.preventDefault();break}l=l.parentElement}}r&&gt(this.element.parentElement)}),this.element.addEventListener("dragstart",a=>{if(Se()){a.stopPropagation(),a.preventDefault();return}window.getSelection().removeAllRanges(),cn();const i=U(a.target,"LI");if(i){this.parent.panelElement.classList.add("sy__file--disablehover");let s=Array.from(this.element.querySelectorAll(".b3-list-item--focus"));i.classList.contains("b3-list-item--focus")||(s.forEach(r=>{r.classList.remove("b3-list-item--focus")}),i.classList.add("b3-list-item--focus"),s=[i]);let l="";const o=document.createElement("ul");s.forEach((r,c)=>{o.append(r.cloneNode(!0)),r.style.opacity="0.38";const d=r.dataset.nodeId||r.dataset.path;d&&(l+=d,c<s.length-1&&(l+=","))}),o.setAttribute("style",`width: 219px;position: fixed;top:-${s.length*30}px`),o.setAttribute("class","b3-list b3-list--background"),document.body.append(o),a.dataTransfer.setDragImage(o,16,16),a.dataTransfer.setData(p.SIYUAN_DROP_FILE,l),a.dataTransfer.dropEffect="move",window.siyuan.dragElement=document.createElement("div"),window.siyuan.dragElement.innerText=l,setTimeout(()=>{o.remove()})}}),this.element.addEventListener("dragend",()=>{this.parent.panelElement.classList.remove("sy__file--disablehover"),this.element.querySelectorAll(".b3-list-item--focus").forEach((a,i)=>{if(a.style.opacity="",i===0){const s=a.querySelector(".ariaLabel");s&&wi(s.getAttribute("aria-label"),s)}}),window.siyuan.dragElement=void 0,document.querySelectorAll(".layout-tab-bars--drag").forEach(a=>{a.classList.remove("layout-tab-bars--drag")})}),this.element.addEventListener("dragover",a=>{if(window.siyuan.config.readonly||a.dataTransfer.types.includes(p.SIYUAN_DROP_TAB))return;const i=this.element.getBoundingClientRect();(a.clientY<i.top+p.SIZE_SCROLL_TB||a.clientY>i.bottom-p.SIZE_SCROLL_TB)&&this.element.scroll({top:this.element.scrollTop+(a.clientY<i.top+p.SIZE_SCROLL_TB?-p.SIZE_SCROLL_STEP:p.SIZE_SCROLL_STEP),behavior:"smooth"});let s=U(a.target,"LI");if(s||(s=U(document.elementFromPoint(a.clientX,a.clientY-1),"LI")),!s||!window.siyuan.dragElement){a.preventDefault();return}this.element.querySelectorAll(".dragover, .dragover__bottom, .dragover__top").forEach(u=>{u.classList.remove("dragover","dragover__bottom","dragover__top")});let l="";for(const u of a.dataTransfer.items)u.type.startsWith(p.SIYUAN_DROP_GUTTER)&&(l=u.type);if(l){const u=l.replace(p.SIYUAN_DROP_GUTTER,"").split(p.ZWSP);if(!["nodelistitem","nodeheading"].includes(u[0])){a.preventDefault();return}}else if(s.classList.contains("b3-list-item--focus"))return;let o=!l;Array.from(this.element.querySelectorAll(".b3-list-item--focus")).find(u=>{if(u.getAttribute("data-type")==="navigation-file")return o=!1,!0});const r=s.getAttribute("data-type");if(o&&r!=="navigation-root"){a.preventDefault();return}const c=j(s,"data-sortmode",null);if(!c)return;const d=c.getAttribute("data-sortmode");if(o&&r==="navigation-root"&&window.siyuan.config.fileTree.sort===6||!o&&r!=="navigation-root"&&(d==="6"||window.siyuan.config.fileTree.sort===6&&d==="15")){const u=s.getBoundingClientRect(),m=u.height*.2;r==="navigation-root"&&o?a.clientY>u.top+u.height/2?s.classList.add("dragover__bottom"):s.classList.add("dragover__top"):a.clientY>u.bottom-m?s.classList.add("dragover__bottom"):a.clientY<u.top+m&&s.classList.add("dragover__top"),a.preventDefault()}if(s.classList.contains("dragover__top")||s.classList.contains("dragover__bottom")||r==="navigation-root"&&o){a.preventDefault();return}s.classList.add("dragover"),a.preventDefault()});let n=0;this.element.addEventListener("dragleave",()=>{n--,n===0&&this.element.querySelectorAll(".dragover, .dragover__bottom, .dragover__top").forEach(a=>{a.classList.remove("dragover","dragover__bottom","dragover__top")})}),this.element.addEventListener("dragenter",a=>{a.preventDefault(),n++}),this.element.addEventListener("drop",a=>mh(this,null,function*(){n=0;const i=this.element.querySelector(".dragover, .dragover__bottom, .dragover__top");if(!i)return;const s=ot(i,"UL");if(!s)return;const l=this.element.scrollTop,o=s.getAttribute("data-url"),r=i.getAttribute("data-path");let c="";for(const f of a.dataTransfer.items)f.type.startsWith(p.SIYUAN_DROP_GUTTER)&&(c=f.type);if(c){const f=c.replace(p.SIYUAN_DROP_GUTTER,"").split(p.ZWSP);if(["nodelistitem","nodeheading"].includes(f[0])){const g={targetNoteBook:o,pushMode:0};i.classList.contains("dragover")?g.targetPath=r:i.classList.contains("dragover__bottom")?g.previousPath=r:i.classList.contains("dragover__top")&&(i.previousElementSibling?g.previousPath=i.previousElementSibling.getAttribute("data-path"):g.targetPath=i.parentElement.previousElementSibling.getAttribute("data-path")),f[0]==="nodeheading"?(g.srcHeadingID=f[2].split(",")[0],A("/api/filetree/heading2Doc",g)):(g.srcListItemID=f[2].split(",")[0],A("/api/filetree/li2Doc",g))}i.classList.remove("dragover","dragover__bottom","dragover__top"),window.siyuan.dragElement=void 0;return}if(window.siyuan.dragElement=void 0,!a.dataTransfer.getData(p.SIYUAN_DROP_FILE)){i.classList.remove("dragover","dragover__bottom","dragover__top");return}const d=[],u=[],m=[];if(this.element.querySelectorAll(".b3-list-item--focus").forEach(f=>{if(f.getAttribute("data-type")==="navigation-root")d.push(f);else{const g=f.getAttribute("data-path");if(!m.find(b=>{if(g.startsWith(b.replace(".sy","")))return!0})){if(i.getAttribute("data-path").startsWith(f.dataset.path.replace(".sy","")))return;u.push(f),m.push(g)}}}),i.classList.contains("dragover")){A("/api/filetree/moveDocs",{toNotebook:o,fromPaths:m,toPath:r}),i.classList.remove("dragover","dragover__bottom","dragover__top");return}if(i.classList.contains("dragover__bottom")||i.classList.contains("dragover__top")){const f=s.getAttribute("data-sortmode");if(window.siyuan.config.fileTree.sort===6&&d.length>0&&i.getAttribute("data-path")==="/"){i.classList.contains("dragover__top")?d.forEach(h=>{i.parentElement.before(h.parentElement)}):d.reverse().forEach(h=>{i.parentElement.after(h.parentElement)});const g=[];Array.from(this.element.children).forEach(h=>{g.push(h.getAttribute("data-url"))}),A("/api/notebook/changeSortNotebook",{notebooks:g})}else if((f==="6"||window.siyuan.config.fileTree.sort===6&&f==="15")&&u.length>0){let g=!1;const h=De().dirname(r);m.length>0&&(yield Ae("/api/filetree/moveDocs",{toNotebook:o,fromPaths:m,toPath:h==="/"?"/":h+".sy",callback:p.CB_MOVE_NOLIST}),u.forEach(y=>{y.setAttribute("data-path",De().join(h,y.getAttribute("data-node-id")+".sy"))}),g=!0),i.classList.contains("dragover__top")?u.forEach(y=>{let w;y.nextElementSibling&&y.nextElementSibling.tagName==="UL"&&(w=y.nextElementSibling),i.before(y),w&&y.after(w)}):i.classList.contains("dragover__bottom")&&u.reverse().forEach(y=>{let w;y.nextElementSibling&&y.nextElementSibling.tagName==="UL"&&(w=y.nextElementSibling),i.nextElementSibling&&i.nextElementSibling.tagName==="UL"?i.nextElementSibling.after(y):i.after(y),w&&y.after(w)});const b=[];Array.from(i.parentElement.children).forEach(y=>{y.tagName==="LI"&&b.push(y.getAttribute("data-path"))}),A("/api/filetree/changeSort",{paths:b,notebook:o},()=>{g&&A("/api/filetree/listDocsByPath",{notebook:o,path:h==="/"?"/":h+".sy",app:p.SIYUAN_APPID},y=>{if(y.data.path==="/"&&y.data.files.length===0){de(window.siyuan.languages.emptyContent);return}this.onLsHTML(y.data,l)})})}}i.classList.remove("dragover","dragover__bottom","dragover__top")})),this.init(),window.siyuan.config.openHelp&&rp()}updateDocInfo(e){var n;const a=this.element.querySelector(`li[data-node-id="${e.data.rootID}"]`);a&&(a.setAttribute("data-count",e.data.subFileCount),(n=a.querySelector(".ariaLabel"))==null||n.setAttribute("aria-label",this.genDocAriaLabel(e.data,_i)))}updateItemArrow(e,n){const a=this.element.querySelector(`[data-url="${e}"]`);if(!a)return;let i=n,s;for(;!s;)if(s=a.querySelector(`[data-path="${i}"]`),s){const l=s.querySelector(".fn__hidden");l?l.classList.remove("fn__hidden"):this.getLeaf(s,e,!0);break}else{const l=De().dirname(i);if(l==="/"){a.firstElementChild.querySelector(".b3-list-item__arrow--open")&&this.getLeaf(a.firstElementChild,e,!0);break}else i=l+".sy"}}genNotebook(e){const n=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${be(e.icon||window.siyuan.storage[p.LOCAL_IMAGES].note)}</span>`;return e.closed?`<li data-url="${e.id}" class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text" style="cursor: default;">${he(e.name)}</span>
    <span data-type="open" data-url="${e.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.openBy}">
        <svg><use xlink:href="#iconOpen"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${e.id}" data-sort="${e.sort}" data-sortmode="${e.sortMode}">
<li class="b3-list-item b3-list-item--hide-action" ${window.siyuan.config.fileTree.sort===6?'draggable="true"':""} 
style="--file-toggle-width:22px" 
data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text ariaLabel" data-position="parentE">${he(e.name)}</span>
    <span data-type="more-root" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(e=!0){let n="",a="",i=0;window.siyuan.notebooks.forEach(o=>{o.closed?(i++,a+=this.genNotebook(o)):n+=this.genNotebook(o)}),this.element.innerHTML=n,this.closeElement.lastElementChild.innerHTML=a;const s=this.closeElement.querySelector(".counter");if(s.textContent=i.toString(),i?this.closeElement.classList.remove("fn__none"):this.closeElement.classList.add("fn__none"),window.siyuan.storage[p.LOCAL_FILESPATHS].forEach(o=>{o.openPaths.forEach(r=>{this.selectItem(o.notebookId,r,void 0,!1,!1)})}),!e)return;const l=this.closeElement.querySelector("svg");n!==""?(this.closeElement.style.height="30px",l.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",l.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none"))}onRemove(e){if(e.cmd==="unmount"){if(Gi(n=>{const a=this.element.querySelector(`ul[data-url="${e.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),p.CB_MOUNT_REMOVE!==e.callback)){let i="";n.find(l=>{l.closed&&(i+=this.genNotebook(l))}),this.closeElement.lastElementChild.innerHTML=i;const s=this.closeElement.querySelector(".counter");s.textContent=(parseInt(s.textContent)+1).toString(),this.closeElement.classList.remove("fn__none")}}),p.CB_MOUNT_REMOVE===e.callback){const n=this.closeElement.querySelector(`li[data-url="${e.data.box}"]`);if(n){n.remove();const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&this.closeElement.classList.add("fn__none")}}return}e.data.ids.forEach(n=>{var a;const i=this.element.querySelector(`li.b3-list-item[data-node-id="${n}"]`);if(i){((a=i.nextElementSibling)==null?void 0:a.tagName)==="UL"&&i.nextElementSibling.remove();const s=i.parentElement.previousElementSibling;if(i.parentElement.childElementCount===1){if(s){const l=s.querySelector("svg");l.classList.remove("b3-list-item__arrow--open"),s.dataset.type!=="navigation-root"&&l.parentElement.classList.add("fn__hidden");const o=l.parentElement.nextElementSibling;o.innerHTML===be(window.siyuan.storage[p.LOCAL_IMAGES].folder)&&(o.innerHTML=be(window.siyuan.storage[p.LOCAL_IMAGES].file))}i.parentElement.remove()}else i.remove()}})}onMount(e){if(e.data.existed)return;const n=this.closeElement.querySelector(`li[data-url="${e.data.box.id}"]`);if(n){const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&this.closeElement.classList.add("fn__none"),n.remove()}Gi(a=>{const i=this.genNotebook(e.data.box);if(this.element.childElementCount===0)this.element.innerHTML=i;else{let s;a.find((l,o)=>{if(l.id===e.data.box.id){for(;o>0;)if(a[o-1].closed)o--;else{s=a[o-1].id;break}return!0}}),s?this.element.querySelector(`[data-url="${s}"]`).insertAdjacentHTML("afterend",i):this.element.insertAdjacentHTML("afterbegin",i)}})}onRename(e){const n=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);n&&(n.setAttribute("data-name",Lute.EscapeHTMLStr(e.title)),n.querySelector(".b3-list-item__text").innerHTML=he(e.title))}onMove(e){const n=this.element.querySelector(`ul[data-url="${e.data.fromNotebook}"] li[data-path="${e.data.fromPath}"]`);if(n)if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),n.parentElement.childElementCount===1){if(n.parentElement.previousElementSibling){const i=n.parentElement.previousElementSibling;i.getAttribute("data-type")!=="navigation-root"&&i.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),i.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const s=i.querySelector(".b3-list-item__icon");s.innerHTML===be(window.siyuan.storage[p.LOCAL_IMAGES].folder)&&(s.innerHTML=be(window.siyuan.storage[p.LOCAL_IMAGES].file))}n.parentElement.remove()}else n.remove();else{const i=this.element.querySelector(`ul[data-url="${e.data.fromNotebook}"] li[data-path="${De().dirname(e.data.fromPath)}.sy"]`);i&&i.getAttribute("data-count")==="1"&&(i.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),i.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"))}const a=this.element.querySelector(`[data-url="${e.data.toNotebook}"] li[data-path="${e.data.toPath}"]`);if(a){a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=a.querySelector(".b3-list-item__icon");i.innerHTML===be(window.siyuan.storage[p.LOCAL_IMAGES].file)&&(i.innerHTML=be(window.siyuan.storage[p.LOCAL_IMAGES].folder)),a.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")&&e.callback!==p.CB_MOVE_NOLIST&&this.getLeaf(a,e.data.toNotebook,!0)}}onLsHTML(e,n){if(e.files.length===0)return;const a=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);if(!a)return;let i="";e.files.forEach(l=>{i+=this.genFileHTML(l)});let s=a.nextElementSibling;if(s&&s.tagName==="UL"){const l=document.createElement("template");l.innerHTML=i,s.querySelectorAll(":scope > .b3-list-item > .b3-list-item__toggle> .b3-list-item__arrow--open").forEach(o=>{const r=T(o,"b3-list-item");if(r){const c=l.content.querySelector(`.b3-list-item[data-node-id="${r.getAttribute("data-node-id")}"]`);c.after(r.nextElementSibling),c.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open")}}),s.innerHTML=l.innerHTML,typeof n=="number"&&this.element.scroll({top:n,behavior:"smooth"});return}a.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),a.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`),s=a.nextElementSibling,setTimeout(()=>{s.setAttribute("style",`top: -1px;position: relative;height:${s.childElementCount*(a.clientHeight+1)-1}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(l=>{l.classList.remove("file-tree__sliderDown"),l.removeAttribute("style")}),typeof n=="number"&&this.element.scroll({top:n,behavior:"smooth"})},120)},2)}onLsSelect(e,n,a,i){return mh(this,null,function*(){let s="";if(e.files.forEach(d=>{s+=this.genFileHTML(d)}),s==="")return;const l=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);if(!l)return;l.nextElementSibling&&l.nextElementSibling.tagName==="UL"&&l.nextElementSibling.remove();const o=l.querySelector(".b3-list-item__arrow");o.classList.add("b3-list-item__arrow--open"),o.parentElement.classList.remove("fn__hidden");const r=l.querySelector(".b3-list-item__icon");r.textContent===be(window.siyuan.storage[p.LOCAL_IMAGES].file)&&(r.textContent=be(window.siyuan.storage[p.LOCAL_IMAGES].folder)),l.insertAdjacentHTML("afterend",`<ul>${s}</ul>`);let c;for(let d=0;d<e.files.length;d++){const u=e.files[d];if(n===u.path)c=yield this.selectItem(e.box,n,void 0,a,i);else if(n.startsWith(u.path.replace(".sy",""))){const m=yield Ae("/api/filetree/listDocsByPath",{notebook:e.box,path:u.path,app:p.SIYUAN_APPID});c=yield this.selectItem(m.data.box,n,m.data,a,i)}}return i&&this.setCurrent(c),c})}setCurrent(e,n=!0){if(e&&(this.element.querySelectorAll("li.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"),n)){const a=this.element.getBoundingClientRect();this.element.scrollTop=this.element.scrollTop+(e.getBoundingClientRect().top-(a.top+a.height/2))}}getLeaf(e,n,a=!1){var i;const s=e.querySelector(".b3-list-item__arrow");if(s.classList.contains("b3-list-item__arrow--open")&&!a){s.classList.remove("b3-list-item__arrow--open"),(i=e.nextElementSibling)==null||i.remove(),this.getOpenPaths();return}A("/api/filetree/listDocsByPath",{notebook:n,path:e.getAttribute("data-path"),app:p.SIYUAN_APPID},l=>{if(l.data.path==="/"&&l.data.files.length===0){ki({app:this.app,notebookId:n,currentPath:"/",useSavePath:!1,listDocTree:!0});return}this.onLsHTML(l.data),this.getOpenPaths()})}selectItem(e,n,a,i=!0,s=!0){return mh(this,null,function*(){const l=this.element.querySelector(`[data-url="${e}"]`);if(!l)return;let o=n,r;for(;!r;)if(r=l.querySelector(`[data-path="${o}"]`),!r){const c=De().dirname(o);c==="/"?o=c:o=c+".sy"}if(r.getAttribute("data-path")===n)return i&&this.getOpenPaths(),s&&this.setCurrent(r),r;if(a&&a.path===o)r=yield this.onLsSelect(a,n,i,s);else{const c=yield Ae("/api/filetree/listDocsByPath",{notebook:e,path:o,app:p.SIYUAN_APPID});r=yield this.onLsSelect(c.data,n,i,s)}return r})}getOpenPaths(){const e=[];this.element.querySelectorAll(".b3-list[data-url]").forEach(n=>{const a={notebookId:n.getAttribute("data-url"),openPaths:[]};if(n.querySelectorAll(".b3-list-item__arrow--open").forEach(i=>{const s=U(i,"LI");s&&a.openPaths.push(s.getAttribute("data-path"))}),a.openPaths.length>0){for(let i=0;i<a.openPaths.length;i++)for(let s=i+1;s<a.openPaths.length;s++)a.openPaths[s].startsWith(a.openPaths[i].replace(".sy",""))&&(a.openPaths.splice(i,1),s--);a.openPaths.forEach((i,s)=>{var l,o,r;const c=(r=(o=(l=this.element.querySelector(`[data-url="${a.notebookId}"] li[data-path="${i}"]`))==null?void 0:l.nextElementSibling)==null?void 0:o.firstElementChild)==null?void 0:r.getAttribute("data-path");c&&(a.openPaths[s]=c)}),e.push(a)}}),window.siyuan.storage[p.LOCAL_FILESPATHS]=e,Ee(p.LOCAL_FILESPATHS,e)}genDocAriaLabel(e,n){return`${n(xt(e.name,!0,!0))} <small class='ft__on-surface'>${e.hSize}</small>${e.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+n(e.bookmark):""}${e.name1?"<br>"+window.siyuan.languages.name+" "+n(e.name1):""}${e.alias?"<br>"+window.siyuan.languages.alias+" "+n(e.alias):""}${e.memo?"<br>"+window.siyuan.languages.memo+" "+n(e.memo):""}${e.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",e.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${e.hMtime}<br>${window.siyuan.languages.createdAt} ${e.hCtime}`}genFileHTML(e){let n="";e.count&&e.count>0&&(n=`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.count}</span>`);const a=this.genDocAriaLabel(e,Zt),i=(e.path.split("/").length-1)*18;return`<li data-node-id="${e.id}" data-name="${Lute.EscapeHTMLStr(e.name)}" draggable="true" data-count="${e.subFileCount}" 
data-type="navigation-file" 
style="--file-toggle-width:${i+18}px" 
class="b3-list-item b3-list-item--hide-action" data-path="${e.path}">
    <span style="padding-left: ${i}px" class="b3-list-item__toggle b3-list-item__toggle--hl${e.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon b3-tooltips b3-tooltips__n popover__block" data-id="${e.id}" aria-label="${window.siyuan.languages.changeIcon}">${be(e.icon||(e.subFileCount===0?window.siyuan.storage[p.LOCAL_IMAGES].file:window.siyuan.storage[p.LOCAL_IMAGES].folder))}</span>
    <span class="b3-list-item__text ariaLabel" data-position="parentE"
aria-label="${a}">${xt(e.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${n}
</li>`}initMoreMenu(){if(window.siyuan.menus.menu.remove(),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({icon:"iconFilesRoot",label:window.siyuan.languages.newNotebook,click:()=>{Zw()}}).element),window.siyuan.menus.menu.append(new N({icon:"iconRefresh",label:window.siyuan.languages.rebuildIndex,click:()=>{this.element.getAttribute("disabled")||(this.element.setAttribute("disabled","disabled"),Xk(()=>{this.element.removeAttribute("disabled"),this.init(!1)}))}}).element),!window.siyuan.config.readonly){const e=Kw("notebooks",window.siyuan.config.fileTree.sort,n=>{window.siyuan.config.fileTree.sort=n,A("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{Gi(()=>{this.init(!1)})})});window.siyuan.menus.menu.append(new N({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:e}).element)}return window.siyuan.menus.menu}}const ex=t=>{let e="",n="";if(Oe().editor.find(a=>{const i=a.parent.headElement;if(i.classList.contains("item--focus")&&(e=a.editor.protyle.notebookId,t?n=a.editor.protyle.path:n=De().dirname(a.editor.protyle.path),T(i,"layout__wnd--active")))return!0}),!e){const a=nt("file").data.file;if(a instanceof Ki){const i=a.element.querySelector(".b3-list-item--focus");if(i){const s=ot(i,"UL");s&&(e=s.getAttribute("data-url"));const l=i.getAttribute("data-path");t?n=l:n=De().dirname(l)}}}return e||window.siyuan.notebooks.find(a=>{if(!a.closed)return e=a.id,n="/",!0}),{notebookId:e,currentPath:n}},ki=t=>{if(Qm()===0){de(window.siyuan.languages.newFileTip);return}if(!t.notebookId){const e=ex(t.useSavePath);t.notebookId=e.notebookId,t.currentPath=e.currentPath}A("/api/filetree/getDocCreateSavePath",{notebook:t.notebookId},e=>{if(t.useSavePath||(e.data.box=t.notebookId),e.data.path.indexOf("/")>-1&&t.useSavePath||t.name)if(e.data.path.startsWith("/")||t.currentPath==="/"){const n=De().join(e.data.path,t.name||(e.data.path.endsWith("/")?window.siyuan.languages.untitled:""));A("/api/filetree/createDocWithMd",{notebook:e.data.box,path:n,markdown:"",listDocTree:t.listDocTree},a=>{t.afterCB&&t.afterCB(a.data,De().basename(n)),ve({app:t.app,id:a.data,action:[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW]})})}else A("/api/filetree/getHPathByPath",{notebook:e.data.box,path:t.notebookId===e.data.box?t.currentPath.endsWith(".sy")?t.currentPath:t.currentPath+".sy":e.data.path||"/"},n=>{const a=De().join(n.data,e.data.path,t.name||(e.data.path.endsWith("/")?window.siyuan.languages.untitled:""));A("/api/filetree/createDocWithMd",{notebook:e.data.box,path:a,parentID:xt(t.currentPath,!0,!0),markdown:"",listDocTree:t.listDocTree},i=>{t.afterCB&&t.afterCB(i.data,De().basename(a)),ve({app:t.app,id:i.data,action:[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW]})})});else{const n=De().basename(e.data.path||window.siyuan.languages.untitled);if(!Ff(n))return;if(t.notebookId!==e.data.box){const s=De().join(e.data.path||"/",t.name||(e.data.path.endsWith("/")?window.siyuan.languages.untitled:""));A("/api/filetree/createDocWithMd",{notebook:e.data.box,path:s,markdown:"",listDocTree:t.listDocTree},l=>{t.afterCB&&t.afterCB(l.data,De().basename(s)),ve({app:t.app,id:l.data,action:[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW]})});return}const a=Lute.NewNodeID(),i=De().join(xt(t.currentPath,!1,!0),a+".sy");t.paths&&(t.paths[t.paths.indexOf(void 0)]=i),A("/api/filetree/createDoc",{notebook:e.data.box,path:i,title:n,md:"",sorts:t.paths,listDocTree:t.listDocTree},()=>{t.afterCB&&t.afterCB(a,n),ve({app:t.app,id:a,action:[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW]})})}})},hh=(t,e,n)=>{A("/api/filetree/getRefCreateSavePath",{notebook:e},a=>{let i=t;e!==a.data.box&&(i=a.data.path||"/"),a.data.path?a.data.path.startsWith("/")?n(xt(a.data.path,!1,!0),a.data.box):A("/api/filetree/getHPathByPath",{notebook:a.data.box,path:i},s=>{n(xt(De().join(s.data,a.data.path),!1,!0),a.data.box)}):A("/api/filetree/getHPathByPath",{notebook:a.data.box,path:i},s=>{n(xt(s.data,!1,!0),a.data.box)})})},bh=(t,e)=>{ce(["dialog"]),ki({app:t,useSavePath:!0,name:oa(e.trim())||window.siyuan.languages.untitled})},Jw=(t,e,n,a,i)=>{const s=oa(e.trim()?e.trim():t.lute.BlockDOM2Content(n.outerHTML).replace(/\n/g,"").trim())||window.siyuan.languages.untitled,l=De().join(a,s);A("/api/filetree/getIDsByHPath",{path:l,notebook:i},o=>{const r=s.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen);if(o.data&&o.data.length>0){const c=t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${o.data[0]}${p.ZWSP}d${p.ZWSP}${r}`});c[0]&&t.toolbar.range.selectNodeContents(c[0])}else A("/api/filetree/createDocWithMd",{notebook:i,path:l,parentID:t.notebookId===i?t.block.rootID:"",markdown:""},c=>{const d=t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${c.data}${p.ZWSP}d${p.ZWSP}${r}`});d[0]&&t.toolbar.range.selectNodeContents(d[0])});ce(["toolbar"],t)})};var tx=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const nx=(t,e)=>{const n=new $e({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${t.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${t.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${t.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${t.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${t.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${t.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${t.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${t.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${t.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${t.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${t.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${t.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${t.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${t.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${t.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${t.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${t.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",p.DIALOG_SEARCHTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.types[i.getAttribute("data-type")]=i.checked}),e(),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},t),Ee(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),n.destroy()})},ax=t=>{let e="";Object.keys(p.SIYUAN_DEFAULT_REPLACETYPES).forEach(i=>{e+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[i]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${i}" type="checkbox"${t.replaceTypes[i]?" checked":""}>
</label>`});const n=new $e({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${e}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",p.DIALOG_REPLACETYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.replaceTypes[i.getAttribute("data-type")]=i.checked}),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},t),Ee(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),n.destroy()})},ix=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_METHOD){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_METHOD),window.siyuan.menus.menu.append(new N({icon:"iconExact",label:window.siyuan.languages.keyword,current:t.method===0,click(){t.method=0,e()}}).element),window.siyuan.menus.menu.append(new N({icon:"iconQuote",label:window.siyuan.languages.querySyntax,current:t.method===1,click(){t.method=1,e()}}).element),window.siyuan.menus.menu.append(new N({icon:"iconDatabase",label:"SQL",current:t.method===2,click(){t.method=2,e()}}).element),window.siyuan.menus.menu.append(new N({icon:"iconRegex",label:window.siyuan.languages.regex,current:t.method===3,click(){t.method=3,e()}}).element)},cp=(t,e,n,a,i)=>{t.removed=!1;const s=t;s.name=a,e.push(Object.assign({},s)),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},t),Ee(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),A("/api/storage/setCriterion",{criterion:s},()=>{var l;i.destroy();const o=n.querySelector("#criteria").firstElementChild;o.classList.remove("fn__none"),(l=o.querySelector(".b3-chip--current"))==null||l.classList.remove("b3-chip--current"),o.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},Xw=(t,e,n)=>{const a=new $e({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});a.element.setAttribute("data-key",p.DIALOG_SAVECRITERION);const i=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{const s=a.element.querySelector("input"),l=s.value.trim();if(!l){de(window.siyuan.languages._kernel[142]);return}Y()?(t.k=document.querySelector("#toolbarSearch").value,t.r=n.querySelector("#toolbarReplace").value):(t.k=n.querySelector("#searchInput").value,t.r=n.querySelector("#replaceInput").value);const o=n.querySelector("#criteria").firstElementChild;let r="",c="";if(e.forEach(d=>{d.name===l&&(r=d.name),Qw(d,t)&&(c=d.name)}),s.blur(),r&&!c)Re(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(o.children).forEach(d=>{d.textContent===l&&d.remove()}),e.find((d,u)=>{if(d.name===l)return e.splice(u,1),!0}),cp(t,e,n,l,a)});else if(r&&c)if(r===c)a.destroy();else{const d=r===l?c:r;Re(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",d).replace("${y}",l),()=>{Array.from(o.children).forEach(u=>{(u.textContent===c||u.textContent===r)&&u.remove()}),e.find((u,m)=>{if(u.name===d||u.name===r)return A("/api/storage/removeCriterion",{name:d}),e.splice(m,1),!0}),cp(t,e,n,l,a)})}else!r&&c?Re(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",c).replace("${y}",l),()=>{Array.from(o.children).forEach(d=>{d.textContent===c&&d.remove()}),e.find((d,u)=>{if(d.name===c)return A("/api/storage/removeCriterion",{name:c}),e.splice(u,1),!0}),cp(t,e,n,l,a)}):cp(t,e,n,l,a)})},sx=(t,e,n,a,i,s)=>tx(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_MORE);const l=[{iconHTML:"",label:window.siyuan.languages.type,current:t.sort===0,click(){t.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:t.sort===1,click(){t.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:t.sort===2,click(){t.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:t.sort===3,click(){t.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:t.sort===4,click(){t.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:t.sort===6,click(){t.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:t.sort===7,click(){t.sort=7,a()}}];t.group===1&&l.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:t.sort===5,click(){t.sort=5,a()}}),window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element),window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:t.group===0,click(){Y()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),t.group=0,t.sort===5&&(t.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:t.group===1,click(){Y()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),t.group=1,a()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new N({type:"separator"}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){Xw(t,e,n)}}).element),window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)}),Qw=(t,e)=>!!(e.group===t.group&&e.hPath===t.hPath&&e.hasReplace===t.hasReplace&&e.k===t.k&&e.method===t.method&&e.r===t.r&&e.sort===t.sort&&rn(e.types,t.types)&&rn(e.replaceTypes,t.replaceTypes)&&rn(e.idPath,t.idPath)),lx=(t,e,n)=>{A("/api/storage/getCriteria",{},a=>{let i="";a.data.forEach(s=>{e.push(s);let l=!1;Qw(s,n)&&(l=!0),i+=`<div data-type="set-criteria" class="${l?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer">${he(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),t.innerHTML=`<div class="b3-chips${i?"":" fn__none"}">
    ${i}
</div>
<span class="fn__flex-1"></span>
<button data-type="saveCriterion" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.saveCriterion}</button>
<span class="fn__space"></span>
<button data-type="removeCriterion" aria-label="${window.siyuan.languages.useCriterion}" class="ariaLabel b3-button b3-button--small b3-button--outline fn__flex-center fn__flex-shrink" data-position="9south">${window.siyuan.languages.removeCriterion}</button>
<span class="fn__space"></span>`})},ox=t=>{const e=[];return t.querySelectorAll(".b3-list-item__text mark").forEach(n=>{e.push(n.textContent)}),e.length===0&&t.querySelectorAll(".b3-list-item__meta mark").forEach(n=>{e.push(n.textContent)}),[...new Set(e)].join(" ")},yh=(t,e,n)=>{t.value===""?(e.classList.add("fn__none"),typeof n=="number"&&(t.style.paddingRight=t.dataset.oldPaddingRight)):(e.classList.remove("fn__none"),typeof n=="number"&&t.style.setProperty("padding-right",`${n*2+e.clientWidth}px`,"important"))},Hc=t=>{t.inputElement.dataset.oldPaddingRight=t.inputElement.style.paddingRight,t.inputElement.insertAdjacentHTML("afterend",`<svg class="${t.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${t.right?"right: "+t.right+"px;":""}${t.height?"height:"+t.height+"px;":""}${t.width?"width:"+t.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const e=t.inputElement.nextElementSibling;e.addEventListener("click",()=>{t.inputElement.value="",t.inputElement.focus(),yh(t.inputElement,e,t.right),t.clearCB&&t.clearCB()}),t.inputElement.addEventListener("input",()=>{yh(t.inputElement,e,t.right)}),yh(t.inputElement,e,t.right)},ev=t=>{const e=window.siyuan.storage[p.LOCAL_SEARCHKEYS];if(!e.replaceKeys||e.replaceKeys.length===0||e.length===1&&e[0]===t.value)return;const n=new dt(p.MENU_SEARCH_REPLACE_HISTORY);if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_SEARCHKEYS].replaceKeys=[],Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])}});const a=n.addSeparator(1);let i=!0;e.replaceKeys.forEach(l=>{if(l!==t.value&&l){const o=n.addItem({iconHTML:"",label:he(l),action:"iconCloseRound",bind(r){r.addEventListener("click",c=>{var d;T(c.target,"b3-menu__action")?(e.replaceKeys.find((u,m)=>{if(u===l)return e.replaceKeys.splice(m,1),!0}),window.siyuan.storage[p.LOCAL_SEARCHKEYS].replaceKeys=e.replaceKeys,Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS]),(d=r.previousElementSibling)!=null&&d.classList.contains("b3-menu__separator")&&!r.nextElementSibling?window.siyuan.menus.menu.remove():r.remove()):(t.value=r.textContent,window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});i&&o.classList.add("b3-menu__item--current"),i=!1}}),i&&a.remove();const s=t.previousElementSibling.getBoundingClientRect();n.open({x:s.left,y:s.bottom})},tv=(t,e,n)=>{const a=t.querySelector("#searchInput, #toolbarSearch"),i=window.siyuan.storage[p.LOCAL_SEARCHKEYS];if(!i.keys||i.keys.length===0||i.length===1&&i[0]===a.value)return;const s=new dt(p.MENU_SEARCH_HISTORY);if(s.isOpen)return;s.element.classList.add("b3-menu--list"),s.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_SEARCHKEYS].keys=[],Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])}});const l=s.addSeparator(1);let o=!0;i.keys.forEach(c=>{if(c!==a.value&&c){const d=s.addItem({iconHTML:"",label:he(c),action:"iconCloseRound",bind(u){u.addEventListener("click",m=>{var f;T(m.target,"b3-menu__action")?(i.keys.find((g,h)=>{if(g===c)return i.keys.splice(h,1),!0}),window.siyuan.storage[p.LOCAL_SEARCHKEYS].keys=i.keys,Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS]),(f=u.previousElementSibling)!=null&&f.classList.contains("b3-menu__separator")&&!u.nextElementSibling?window.siyuan.menus.menu.remove():u.remove()):(a.value=u.textContent,e.page=1,En(t,e,n,!0),window.siyuan.menus.menu.remove()),m.preventDefault(),m.stopPropagation()})}});o&&d.classList.add("b3-menu__item--current"),o=!1}}),o&&l.remove();const r=a.previousElementSibling.getBoundingClientRect();s.open({x:r.left,y:r.bottom})},nv=t=>{const e=t.querySelector("#searchAssetInput"),n=window.siyuan.storage[p.LOCAL_SEARCHASSET].keys;if(!n||n.length===0||n.length===1&&n[0]===e.value)return;const a=new dt(p.MENU_SEARCH_ASSET_HISTORY);if(a.isOpen)return;a.element.classList.add("b3-menu--list"),a.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].keys=[],Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])}});const i=a.addSeparator(1);let s=!0;n.forEach(o=>{if(o!==e.value&&o){const r=a.addItem({iconHTML:"",label:he(o),action:"iconCloseRound",bind(c){c.addEventListener("click",d=>{var u;T(d.target,"b3-menu__action")?(n.find((m,f)=>{if(m===o)return n.splice(f,1),!0}),window.siyuan.storage[p.LOCAL_SEARCHASSET].keys=n,Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET]),(u=c.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(e.value=c.textContent,da(t),window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});s&&r.classList.add("b3-menu__item--current"),s=!1}}),s&&i.remove();const l=e.previousElementSibling.getBoundingClientRect();a.open({x:l.left,y:l.bottom})},av=(t,e)=>{let n=window.siyuan.storage[p.LOCAL_SEARCHKEYS][t];n.splice(0,0,e),n=Array.from(new Set(n)),n.length>window.siyuan.config.search.limit&&n.splice(window.siyuan.config.search.limit,n.length-window.siyuan.config.search.limit),window.siyuan.storage[p.LOCAL_SEARCHKEYS][t]=n,Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])},rx=t=>{if(!t.value)return;let e=window.siyuan.storage[p.LOCAL_SEARCHASSET].keys;e.splice(0,0,t.value),e=Array.from(new Set(e)),e.length>window.siyuan.config.search.limit&&e.splice(window.siyuan.config.search.limit,e.length-window.siyuan.config.search.limit),window.siyuan.storage[p.LOCAL_SEARCHASSET].k=t.value,window.siyuan.storage[p.LOCAL_SEARCHASSET].keys=e,Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])},cx=(t,e)=>{if(window.siyuan.menus.menu.remove(),t.previousElementSibling.classList.add("fn__none"),t.classList.remove("fn__none"),t.innerHTML){t.querySelector("#searchAssetInput").select();return}const n=window.siyuan.storage[p.LOCAL_SEARCHASSET];t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none");let a="";if(t.innerHTML=`<div class="block__icons">
    <span data-type="assetPrevious" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="assetNext" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
    <span class="fn__space"></span>
    <span id="searchAssetResult" class="ft__selectnone"></span>
    <span class="fn__flex-1${e?"":" resize__move"}" style="min-height: 100%"></span>
    <span class="fn__space"></span>
    <span id="assetMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9south">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span id="searchAssetClose" aria-label="${e?window.siyuan.languages.stickSearch:window.siyuan.languages.globalSearch}" class="block__icon block__icon--show ariaLabel" data-position="9south">
        <svg><use xlink:href="#iconBack"></use></svg>
    </span>
</div>
<div class="b3-form__icon search__header">
    <div class="fn__flex-1" style="position: relative">
        <span class="search__history-icon ariaLabel" id="assetHistoryBtn" aria-label="${pe("\u2325\u2193")}">
            <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="searchAssetInput" value="${n.k}" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.keyword}">
    </div>
    <div class="block__icons">
        <span data-type="assetRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space"></span>
        ${Oc(n.method,"assetSyntaxCheck")}
        <span class="fn__space"></span>
        <span id="assetFilter" aria-label="${window.siyuan.languages.type}" class="block__icon ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
    </div>
</div>
<div class="search__layout${n.layout===1?" search__layout--row":""}">
    <div id="searchAssetList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
    <div class="search__drag"></div>
    <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;box-sizing: border-box;"></div>
</div>
<div class="search__tip${e?" fn__none":""}">
    <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
    ${a}
    <kbd>${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.searchTip3}
    <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
</div>`,t.querySelector("#searchAssetList").innerHTML!=="")return;const i=t.querySelector("#searchAssetPreview");n.layout===1?n.col&&(i.style.width=n.col,i.classList.remove("fn__flex-1")):n.row&&(i.classList.remove("fn__flex-1"),i.style.height=n.row);const s=t.querySelector("#searchAssetInput");s.select(),s.addEventListener("compositionend",o=>{o.isComposing||da(t,n)}),s.addEventListener("input",o=>{o.isComposing||da(t,n)}),s.addEventListener("blur",()=>{rx(s)}),da(t,n),Hc({right:8,height:s.clientHeight,inputElement:s,clearCB(){da(t,n)}});const l=t.querySelector(".search__drag");l.addEventListener("mousedown",o=>{const r=document,c=l.previousElementSibling,d=n.layout===1?"lr":"tb",u=o[d==="lr"?"clientX":"clientY"],m=d==="lr"?c.offsetWidth:c.offsetHeight,f=d==="lr"?i.offsetWidth:i.offsetHeight;i.classList.remove("fn__flex-1"),i.style[d==="lr"?"width":"height"]=f+"px",t.style.userSelect="none",r.onmousemove=g=>{g.preventDefault(),g.stopPropagation();const h=m+(g[d==="lr"?"clientX":"clientY"]-u),b=f-(g[d==="lr"?"clientX":"clientY"]-u);h<120||b<120||(i.style[d==="lr"?"width":"height"]=b+"px")},r.onmouseup=()=>{t.style.userSelect="none",r.onmousemove=null,r.onmouseup=null,r.ondragstart=null,r.onselectstart=null,r.onselect=null,window.siyuan.storage[p.LOCAL_SEARCHASSET][d==="lr"?"col":"row"]=i[d==="lr"?"offsetWidth":"offsetHeight"]+"px",Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])}}),l.addEventListener("dblclick",()=>{i.style[n.layout===1?"width":"height"]="",i.classList.add("fn__flex-1");const o=n.layout===1?"lr":"tb";window.siyuan.storage[p.LOCAL_SEARCHASSET][o==="lr"?"col":"row"]="",Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])})};let iv;const da=(t,e,n=1)=>{const a=t.parentElement.querySelector(".fn__loading--top");a.classList.remove("fn__none"),clearTimeout(iv),iv=window.setTimeout(()=>{e||(e=window.siyuan.storage[p.LOCAL_SEARCHASSET]);const i=t.querySelector('[data-type="assetPrevious"]');n>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");const s=t.querySelector("#searchAssetInput");A("/api/search/fullTextSearchAssetContent",{page:n,query:s.value,types:e.types,method:e.method,orderBy:e.sort},l=>{var o,r;a.classList.add("fn__none");const c=t.querySelector('[data-type="assetNext"]');n<l.data.pageCount?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled");let d="";l.data.assetContents.forEach((m,f)=>{d+=`<div data-type="search-item" class="b3-list-item${f===0?" b3-list-item--focus":""}" data-id="${m.id}">
<span class="ft__on-surface">${m.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${m.content}</span>
<span class="b3-list-item__meta">${m.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Zt(m.path)}">${m.name}</span>
</div>`});const u=t.querySelector("#searchAssetPreview");l.data.assetContents.length>0?(u.classList.remove("fn__none"),(o=t.querySelector(".search__drag"))==null||o.classList.remove("fn__none"),dp(u,l.data.assetContents[0].id,s.value,e.method)):(u.classList.add("fn__none"),(r=t.querySelector(".search__drag"))==null||r.classList.add("fn__none")),t.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${l.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${l.data.matchedAssetCount}</span>`,t.querySelector("#searchAssetList").innerHTML=d||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},p.TIMEOUT_INPUT)},dp=(t,e,n,a)=>{A("/api/search/getAssetContent",{id:e,query:n,queryMethod:a},i=>{t.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=t.querySelector("mark");if(s){s.classList.add("mark--hl");const l=t.getBoundingClientRect();t.scrollTop=t.scrollTop+s.getBoundingClientRect().top-l.top-l.height/2}})},dx=t=>{let e;const n=Array.from(t.querySelectorAll("mark"));if(n.find((a,i)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),e=n[i+1];return}}),e||(e=n[0]),e){e.classList.add("mark--hl");const a=t.getBoundingClientRect();t.scrollTop=t.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},ux=(t,e)=>{const n=window.siyuan.storage[p.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_ASSET_METHOD){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_ASSET_METHOD),window.siyuan.menus.menu.append(new N({icon:"iconExact",label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].method=0,e()}}).element),window.siyuan.menus.menu.append(new N({icon:"iconQuote",label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].method=1,e()}}).element),window.siyuan.menus.menu.append(new N({icon:"iconRegex",label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].method=3,e()}}).element);const a=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:a.right,y:a.bottom,isLeft:!0})},fx=t=>{let e="";return p.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{e+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${t[n]?" checked":""}>
    </label>`}),e},px=t=>{const e=window.siyuan.storage[p.LOCAL_SEARCHASSET].types,n=new $e({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${fx(e)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});n.element.setAttribute("data-key",p.DIALOG_SEARCHASSETSTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{e[i.getAttribute("data-type")]=i.checked}),da(t),Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET]),n.destroy()})},gx=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_ASSET_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_ASSET_MORE);const a=window.siyuan.storage[p.LOCAL_SEARCHASSET],i=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.topBottomLayout,current:a.layout===0,click(){e.querySelector(".search__layout").classList.remove("search__layout--row");const l=e.querySelector("#searchAssetPreview");l.style.width="",a.row?(l.style.height=a.row,l.classList.remove("fn__flex-1")):l.classList.add("fn__flex-1"),a.layout=0,Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])}},{iconHTML:"",label:window.siyuan.languages.leftRightLayout,current:a.layout===1,click(){const l=e.querySelector("#searchAssetPreview");e.querySelector(".search__layout").classList.add("search__layout--row"),l.style.height="",a.col?(l.style.width=a.col,l.classList.remove("fn__flex-1")):l.classList.add("fn__flex-1"),a.layout=1,Ee(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])}}]}).element),window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){e.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),A("/api/asset/fullReindexAssetContent",{},()=>{da(e,a)})}}).element);const s=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.right,y:s.bottom,isLeft:!0})},mx=(t,e)=>{if(window.siyuan.menus.menu.remove(),t.previousElementSibling.previousElementSibling.classList.add("fn__none"),t.classList.remove("fn__none"),t.querySelector("#searchUnRefResult").innerHTML||(t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),t.querySelector("#searchUnRefList").innerHTML!==""))return;const n=window.siyuan.storage[p.LOCAL_SEARCHUNREF];n.layout===1?n.col&&(e.protyle.element.style.width=n.col,e.protyle.element.classList.remove("fn__flex-1")):n.row&&(e.protyle.element.classList.remove("fn__flex-1"),e.protyle.element.style.height=n.row);const a=t.querySelector(".search__drag");a.addEventListener("mousedown",i=>{const s=document,l=a.nextElementSibling,o=a.previousElementSibling,r=n.layout===1?"lr":"tb",c=i[r==="lr"?"clientX":"clientY"],d=r==="lr"?o.clientWidth:o.clientHeight,u=r==="lr"?l.clientWidth:l.clientHeight;l.classList.remove("fn__flex-1"),l.style[r==="lr"?"width":"height"]=u+"px",t.style.userSelect="none",s.onmousemove=m=>{m.preventDefault(),m.stopPropagation();const f=d+(m[r==="lr"?"clientX":"clientY"]-c),g=u-(m[r==="lr"?"clientX":"clientY"]-c);f<120||g<120||(l.style[r==="lr"?"width":"height"]=g+"px")},s.onmouseup=()=>{t.style.userSelect="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,window.siyuan.storage[p.LOCAL_SEARCHUNREF][r==="lr"?"col":"row"]=l[r==="lr"?"clientWidth":"clientHeight"]+"px",Ee(p.LOCAL_SEARCHUNREF,window.siyuan.storage[p.LOCAL_SEARCHUNREF]),r==="lr"&&mn(e.protyle)}}),a.addEventListener("dblclick",()=>{e.protyle.element.style[n.layout===1?"width":"height"]="",e.protyle.element.classList.add("fn__flex-1");const i=n.layout===1?"lr":"tb";window.siyuan.storage[p.LOCAL_SEARCHUNREF][i==="lr"?"col":"row"]="",Ee(p.LOCAL_SEARCHUNREF,window.siyuan.storage[p.LOCAL_SEARCHUNREF]),i==="lr"&&mn(e.protyle)}),zo(t,e)},zo=(t,e,n=1)=>{const a=t.querySelector('[data-type="unRefPrevious"]');n>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),A("/api/search/listInvalidBlockRefs",{page:n},i=>{var s,l;t.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const o=t.querySelector('[data-type="unRefNext"]');n<i.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled");let r="";i.data.blocks.forEach((c,d)=>{const u=Qa(c.box)+xt(c.hPath,!1);r+=`<div data-type="search-item" class="b3-list-item${d===0?" b3-list-item--focus":""}" data-node-id="${c.id}" data-root-id="${c.rootID}">
<svg class="b3-list-item__graphic"><use xlink:href="#${la(c.type)}"></use></svg>
${be(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
${vh(c)}
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Zt(u)}">${_i(u)}</span>
</div>`}),i.data.blocks.length>0?(e.protyle.element.classList.remove("fn__none"),(s=t.querySelector(".search__drag"))==null||s.classList.remove("fn__none"),xl({edit:e,id:i.data.blocks[0].id})):(e.protyle.element.classList.add("fn__none"),(l=t.querySelector(".search__drag"))==null||l.classList.add("fn__none")),t.querySelector("#searchUnRefResult").innerHTML=`${n}/${i.data.pageCount||1}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.findInDoc.replace("${x}",i.data.matchedRootCount).replace("${y}",i.data.matchedBlockCount)}</span>`,t.querySelector("#searchUnRefList").innerHTML=r||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},hx=(t,e,n)=>{const a=new dt(p.MENU_SEARCH_UNREF_MORE);if(a.isOpen)return;const i=window.siyuan.storage[p.LOCAL_SEARCHUNREF];a.addItem({icon:"iconLayout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.topBottomLayout,current:i.layout===0,click(){e.querySelector(".search__layout").classList.remove("search__layout--row"),n.protyle.element.style.width="",i.row?(n.protyle.element.style.height=i.row,n.protyle.element.classList.remove("fn__flex-1")):n.protyle.element.classList.add("fn__flex-1"),mn(n.protyle),i.layout=0,Ee(p.LOCAL_SEARCHUNREF,window.siyuan.storage[p.LOCAL_SEARCHUNREF])}},{iconHTML:"",label:window.siyuan.languages.leftRightLayout,current:i.layout===1,click(){e.querySelector(".search__layout").classList.add("search__layout--row"),n.protyle.element.style.height="",i.col?(n.protyle.element.style.width=i.col,n.protyle.element.classList.remove("fn__flex-1")):n.protyle.element.classList.add("fn__flex-1"),mn(n.protyle),i.layout=1,Ee(p.LOCAL_SEARCHUNREF,window.siyuan.storage[p.LOCAL_SEARCHUNREF])}}]}),a.addItem({icon:"iconRefresh",label:window.siyuan.languages.refresh,click(){e.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),zo(e,n)}});const s=t.getBoundingClientRect();a.open({x:s.right,y:s.bottom,isLeft:!0})},_h=()=>({audioBlock:window.siyuan.config.search.audioBlock,videoBlock:window.siyuan.config.search.videoBlock,iframeBlock:window.siyuan.config.search.iframeBlock,widgetBlock:window.siyuan.config.search.widgetBlock,document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}),Si=(t,e,n,a)=>{if(e=e.trim(),Oe().search.find(l=>(l.parent.parent.switchTab(l.parent.headElement),l.updateSearch(e,n),!0)))return;const s=window.siyuan.storage[p.LOCAL_SEARCHDATA];ea({app:t,searchData:{k:e,r:"",hasReplace:!1,method:a?a.method:s.method,hPath:"",idPath:[],group:s.group,sort:s.sort,types:Object.assign({},s.types),replaceTypes:Object.assign({},s.replaceTypes),removed:s.removed,page:1},position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0})},sv=(t,e,n,a)=>{let i=!0,s=!1;e.idPath.forEach(C=>{C.endsWith(".sy")&&(i=!1),C.split("/").length>1&&(s=!0)});const l=window.siyuan.storage[p.LOCAL_SEARCHKEYS],o=window.siyuan.storage[p.LOCAL_SEARCHUNREF];n.innerHTML=`<div class="fn__flex-column" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}">
    <div class="block__icons" style="overflow: auto">
        <span data-position="9south" data-type="previous" class="block__icon block__icon--show ariaLabel" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-position="9south" data-type="next" class="block__icon block__icon--show ariaLabel" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span id="searchResult" class="fn__flex-shrink ft__selectnone"></span>
        <span class="fn__space"></span>
        <span class="fn__flex-1${a?" resize__move":""}" style="min-height: 100%"></span>
        <span id="searchPathInput" data-position="9south" class="search__path ft__on-surface fn__flex-center ft__smaller fn__ellipsis ariaLabel" aria-label="${Zt(e.hPath)}">
            ${he(e.hPath)}
            <svg class="search__rmpath${e.hPath?"":" fn__none"}"><use xlink:href="#iconCloseRound"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-position="9south" id="searchInclude" ${s?"":"disabled"} aria-label="${window.siyuan.languages.includeChildDoc}" class="block__icon block__icon--show ariaLabel">
            <svg${i?' class="ft__primary"':""}><use xlink:href="#iconInclude"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchPath" aria-label="${window.siyuan.languages.specifyPath}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconMore"></use></svg>
        </span>
        <span class="${a?"":"fn__none "}fn__space"></span>
        <span id="searchOpen" aria-label="${window.siyuan.languages.openInNewTab}" class="${a?"":"fn__none "}block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconLayoutRight"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchUnRef" aria-label="${window.siyuan.languages.listInvalidRefBlocks}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconLinkOff"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchAsset" aria-label="${window.siyuan.languages.searchAssetContent}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconExact"></use></svg>
        </span>
    </div>
    <div class="b3-form__icon search__header">
        <div style="position: relative" class="fn__flex-1">
            <span class="search__history-icon ariaLabel" id="searchHistoryBtn" aria-label="${pe("\u2325\u2193")}">
                <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchInput" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" autocomplete="off" autocorrect="off" spellcheck="false">
        </div>
        <div class="block__icons">
            <span id="searchFilter" aria-label="${window.siyuan.languages.searchType}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span> 
            <span class="fn__space"></span>
            ${Oc(e.method,"searchSyntaxCheck")}
            <span class="fn__space"></span>
            <span id="searchReplace" aria-label="${window.siyuan.languages.replace}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconReplace"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon ariaLabel" data-position="9south">
                <svg><use xlink:href="#iconRefresh"></use></svg>
            </span>
            <div class="fn__flex${e.group===0?" fn__none":""}">
                <span class="fn__space"></span>
                <span id="searchExpand" class="block__icon block__icon--show ariaLabel" data-position="9south" aria-label="${window.siyuan.languages.expand}">
                    <svg><use xlink:href="#iconExpand"></use></svg>
                </span>
                <span class="fn__space"></span>
                <span id="searchCollapse" class="block__icon block__icon--show ariaLabel" data-position="9south" aria-label="${window.siyuan.languages.collapse}">
                    <svg><use xlink:href="#iconContract"></use></svg>
                </span>
            </div>
        </div>
    </div>
    <div class="b3-form__icon search__header${e.hasReplace?"":" fn__none"}">
        <div class="fn__flex-1" style="position: relative">
            <span class="search__history-icon ariaLabel" id="replaceHistoryBtn" aria-label="${pe("\u2325\u2193")}">
                <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconReplace"></use></svg>
                <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="replaceInput" class="b3-text-field b3-text-field--text">
        </div>
        <div class="fn__space"></div>
        <svg class="fn__rotate fn__none svg" style="padding: 0 8px;align-self: center;margin-right: 8px"><use xlink:href="#iconRefresh"></use></svg>
        <span id="replaceFilter" aria-label="${window.siyuan.languages.replaceType}" class="block__icon ariaLabel fn__flex-center" data-position="9south">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
        <span class="fn__space"></span>
        <button id="replaceAllBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button id="replaceBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">\u21B5 ${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" class="search__header"></div>
    <div class="search__layout${(a?l.layout===1:l.layoutTab===1)?" search__layout--row":""}">
        <div id="searchList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
        <div class="search__drag"></div>
        <div id="searchPreview" class="fn__flex-1 search__preview"></div>
    </div>
    <div class="search__tip${a?"":" fn__none"}">
        <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${pe(window.siyuan.config.keymap.general.newFile.custom)}</kbd> ${window.siyuan.languages.new}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.doubleClick}</kbd> ${window.siyuan.languages.searchTip2}
        <kbd>${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.searchTip3}
        <kbd>${pe(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${pe("\u2325"+window.siyuan.languages.click)}</kbd> ${window.siyuan.languages.searchTip4}
        <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
    </div>
</div>
<div class="fn__flex-column fn__none" id="searchAssets" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}"></div>
<div class="fn__flex-column fn__none" id="searchUnRefPanel" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}">
    <div class="block__icons">
        <span data-type="unRefPrevious" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="unRefNext" class="block__icon block__icon--show ariaLabel" data-position="9south" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span id="searchUnRefResult" class="ft__selectnone"></span>
        <span class="fn__flex-1${a?" resize__move":""}" style="min-height: 100%"></span>
        <span class="fn__space"></span>
        <span id="unRefMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconMore"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchUnRefClose" aria-label="${a?window.siyuan.languages.globalSearch:window.siyuan.languages.stickSearch}" class="block__icon block__icon--show ariaLabel" data-position="9south">
            <svg><use xlink:href="#iconBack"></use></svg>
        </span>
    </div>
    <div class="search__layout${o.layout===1?" search__layout--row":""}">
        <div id="searchUnRefList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
        <div class="search__drag"></div>
        <div id="searchUnRefPreview" class="fn__flex-1 search__preview"></div>
    </div>
    <div class="search__tip${a?"":" fn__none"}">
        <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.doubleClick}</kbd> ${window.siyuan.languages.searchTip2}
        <kbd>${pe(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${pe("\u2325"+window.siyuan.languages.click)}</kbd> ${window.siyuan.languages.searchTip4}
        <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
    </div>
</div>
<div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>`;const r=[];lx(n.querySelector("#criteria"),r,e);const c=n.querySelector("#searchList"),d=n.querySelector("#searchInput"),u=n.querySelector("#replaceInput"),m=new ba(t,n.querySelector("#searchPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0,title:!0}});m.resize();const f=new ba(t,n.querySelector("#searchUnRefPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0,title:!0}});f.resize(),a?l.layout===1?l.col&&(m.protyle.element.style.width=l.col,m.protyle.element.classList.remove("fn__flex-1")):l.row&&(m.protyle.element.classList.remove("fn__flex-1"),m.protyle.element.style.height=l.row):l.layoutTab===1?l.colTab&&(m.protyle.element.style.width=l.colTab,m.protyle.element.classList.remove("fn__flex-1")):l.rowTab&&(m.protyle.element.classList.remove("fn__flex-1"),m.protyle.element.style.height=l.rowTab);let g,h=new Date().getTime();d.value=e.k||"",u.value=e.r||"",d.select();const b=n.querySelector(".search__drag");b.addEventListener("mousedown",C=>{const $=document,M=b.nextElementSibling,k=b.previousElementSibling,_=window.siyuan.storage[p.LOCAL_SEARCHKEYS][a?"layout":"layoutTab"]===1?"lr":"tb",v=C[_==="lr"?"clientX":"clientY"],S=_==="lr"?k.clientWidth:k.clientHeight,L=_==="lr"?M.clientWidth:M.clientHeight;M.classList.remove("fn__flex-1"),M.style[_==="lr"?"width":"height"]=L+"px",n.style.userSelect="none",$.onmousemove=D=>{D.preventDefault(),D.stopPropagation();const I=S+(D[_==="lr"?"clientX":"clientY"]-v),q=L-(D[_==="lr"?"clientX":"clientY"]-v);I<120||q<120||(M.style[_==="lr"?"width":"height"]=q+"px")},$.onmouseup=()=>{n.style.userSelect="",$.onmousemove=null,$.onmouseup=null,$.ondragstart=null,$.onselectstart=null,$.onselect=null,window.siyuan.storage[p.LOCAL_SEARCHKEYS][_==="lr"?a?"col":"colTab":a?"row":"rowTab"]=M[_==="lr"?"clientWidth":"clientHeight"]+"px",Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS]),_==="lr"&&mn(m.protyle)}}),b.addEventListener("dblclick",()=>{m.protyle.element.style[y.layout===1?"width":"height"]="",m.protyle.element.classList.add("fn__flex-1");const C=window.siyuan.storage[p.LOCAL_SEARCHKEYS][a?"layout":"layoutTab"]===1?"lr":"tb";window.siyuan.storage[p.LOCAL_SEARCHKEYS][C==="lr"?a?"col":"colTab":a?"row":"rowTab"]="",Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS]),C==="lr"&&mn(m.protyle)});const y=window.siyuan.storage[p.LOCAL_SEARCHASSET],w=n.querySelector("#searchAssets"),E=n.querySelector("#searchUnRefPanel");return n.addEventListener("click",C=>{var $,M,k;let _=C.target;const v=n.querySelector("#searchPathInput");for(;_&&_!==n;){const S=_.getAttribute("data-type");if(S==="removeCriterion"){Al(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:_h(),replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},e,m,!0),($=n.querySelector(".b3-chip--current"))==null||$.classList.remove("b3-chip--current"),C.stopPropagation(),C.preventDefault();break}else if(S==="saveCriterion"){Xw(e,r,n),C.stopPropagation(),C.preventDefault();break}else if(S==="next"){_.getAttribute("disabled")||e.page<parseInt(_.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(e.page++,En(n,e,m)),C.stopPropagation(),C.preventDefault();break}else if(S==="previous"){_.getAttribute("disabled")||e.page>1&&(e.page--,En(n,e,m)),C.stopPropagation(),C.preventDefault();break}else if(_.classList.contains("b3-chip")&&S==="set-criteria"){e.removed=!1,(M=_.parentElement.querySelector(".b3-chip--current"))==null||M.classList.remove("b3-chip--current"),_.classList.add("b3-chip--current"),r.find(L=>{if(L.name===_.innerText.trim())return Al(n,L,e,m),!0}),C.stopPropagation(),C.preventDefault();break}else if(_.classList.contains("b3-chip__close")&&S==="remove-criteria"){const L=_.parentElement.textContent;A("/api/storage/removeCriterion",{name:L}),r.find((D,I)=>{if(D.name===L)return r.splice(I,1),!0}),_.parentElement.classList.contains("b3-chip--current")&&Al(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:_h(),replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},e,m,!0),_.parentElement.remove(),C.stopPropagation(),C.preventDefault();break}else if(_.classList.contains("search__rmpath")){e.idPath=[],e.hPath="",e.page=1,v.textContent="",v.setAttribute("aria-label",""),En(n,e,m,!0);const L=n.querySelector("#searchInclude");L.firstElementChild.classList.add("ft__primary"),L.setAttribute("disabled","disabled"),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchExpand"){Array.from(c.children).forEach(L=>{L.classList.contains("b3-list-item")&&(L.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),L.nextElementSibling.classList.remove("fn__none"))}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchCollapse"){Array.from(c.children).forEach(L=>{L.classList.contains("b3-list-item")&&(L.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),L.nextElementSibling.classList.add("fn__none"))}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchPath"){zi((L,D)=>{A("/api/filetree/getHPathsByPaths",{paths:L},I=>{e.idPath=[];const q=[];let Z=!1;L.forEach((F,K)=>{F==="/"?(e.idPath.push(D[K]),q.push(Qa(D[K]))):(Z=!0,e.idPath.push(De().join(D[K],F.replace(".sy",""))))}),I.data&&q.push(...I.data),e.hPath=q.join(" "),e.page=1,v.innerHTML=`${_i(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,v.setAttribute("aria-label",he(e.hPath));const R=n.querySelector("#searchInclude");R.firstElementChild.classList.add("ft__primary"),Z?R.removeAttribute("disabled"):R.setAttribute("disabled","disabled"),En(n,e,m,!0)})},[],void 0,window.siyuan.languages.specifyPath),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchInclude"){if(C.stopPropagation(),C.preventDefault(),_.hasAttribute("disabled"))return;const L=_.firstElementChild;L.classList.toggle("ft__primary"),L.classList.contains("ft__primary")?e.idPath.forEach((D,I)=>{D.endsWith(".sy")&&(e.idPath[I]=D.replace(".sy",""))}):e.idPath.forEach((D,I)=>{!D.endsWith(".sy")&&D.split("/").length>1&&(e.idPath[I]=D+".sy")}),e.page=1,En(n,e,m,!0);break}else if(_.id==="searchReplace"){e.hasReplace=!e.hasReplace,n.querySelectorAll(".search__header")[1].classList.toggle("fn__none"),(k=n.querySelector("#criteria .b3-chip--current"))==null||k.classList.remove("b3-chip--current"),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchUnRef"){mx(E,f),C.stopPropagation(),C.preventDefault();break}else if(_.id==="unRefMore"){hx(_,E,f),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchUnRefClose"){window.siyuan.menus.menu.remove(),E.classList.add("fn__none"),w.previousElementSibling.classList.remove("fn__none"),d.select(),C.stopPropagation(),C.preventDefault();break}else if(S==="unRefPrevious"){if(!_.getAttribute("disabled")){let L=parseInt(E.querySelector("#searchUnRefResult").textContent);L>1&&(L--,zo(E,f,L))}C.stopPropagation(),C.preventDefault();break}else if(S==="unRefNext"){if(!_.getAttribute("disabled")){let L=parseInt(E.querySelector("#searchUnRefResult").textContent);L<parseInt(E.querySelector("#searchUnRefResult").textContent.split("/")[1])&&(L++,zo(E,f,L))}C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchAsset"){cx(w,!a),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchAssetClose"){window.siyuan.menus.menu.remove(),w.classList.add("fn__none"),w.previousElementSibling.classList.remove("fn__none"),d.select(),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchOpen"){e.k=d.value,e.r=u.value,ea({app:t,searchData:e,position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0}),a&&a(),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchRefresh"){En(n,e,m),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchMore"){sx(e,r,n,()=>{e.page=1,En(n,e,m,!0)},()=>{var D;Al(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:_h(),replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},e,m,!0),(D=n.querySelector("#criteria .b3-chip--current"))==null||D.classList.remove("b3-chip--current")},()=>{const D=window.siyuan.storage[p.LOCAL_SEARCHKEYS],I=T(n,"b3-dialog__container");window.siyuan.menus.menu.append(new N({iconHTML:"",label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.topBottomLayout,current:I?D.layout===0:D.layoutTab===0,click(){n.querySelector(".search__layout").classList.remove("search__layout--row"),m.protyle.element.style.width="",I&&D.row||!I&&D.rowTab?(m.protyle.element.style.height=I?D.row:D.rowTab,m.protyle.element.classList.remove("fn__flex-1")):m.protyle.element.classList.add("fn__flex-1"),mn(m.protyle),I?D.layout=0:D.layoutTab=0,Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])}},{iconHTML:"",label:window.siyuan.languages.leftRightLayout,current:I?D.layout===1:D.layoutTab===1,click(){n.querySelector(".search__layout").classList.add("search__layout--row"),m.protyle.element.style.height="",I&&D.col||!I&&D.colTab?(m.protyle.element.style.width=I?D.col:D.colTab,m.protyle.element.classList.remove("fn__flex-1")):m.protyle.element.classList.add("fn__flex-1"),mn(m.protyle),I?D.layout=1:D.layoutTab=1,Ee(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])}}]}).element)});const L=_.getBoundingClientRect();window.siyuan.menus.menu.popup({x:L.right,y:L.bottom,isLeft:!0}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchFilter"){window.siyuan.menus.menu.remove(),nx(e,()=>{e.page=1,En(n,e,m,!0)}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="replaceFilter"){window.siyuan.menus.menu.remove(),ax(e),C.stopPropagation(),C.preventDefault();break}else if(S==="assetPrevious"){if(!_.getAttribute("disabled")){let L=parseInt(w.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);L>1&&(L--,da(w,y,L))}C.stopPropagation(),C.preventDefault();break}else if(S==="assetNext"){if(!_.getAttribute("disabled")){let L=parseInt(w.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);L<parseInt(w.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])&&(L++,da(w,y,L))}C.stopPropagation(),C.preventDefault();break}else if(_.id==="assetMore"){gx(_,w,()=>{da(w),Ee(p.LOCAL_SEARCHASSET,y)}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="assetFilter"){px(w),C.stopPropagation(),C.preventDefault();break}else if(_.id==="assetSyntaxCheck"){ux(_,()=>{n.querySelector("#assetSyntaxCheck").outerHTML=Oc(y.method,"assetSyntaxCheck"),da(w,y),Ee(p.LOCAL_SEARCHASSET,y)}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchSyntaxCheck"){ix(e,()=>{n.querySelector("#searchSyntaxCheck").outerHTML=Oc(e.method,"searchSyntaxCheck"),e.page=1,En(n,e,m,!0)});const L=_.getBoundingClientRect();window.siyuan.menus.menu.popup({x:L.right,y:L.bottom,isLeft:!0}),C.stopPropagation(),C.preventDefault();break}else if(_.id==="searchHistoryBtn"){tv(n,e,m),C.stopPropagation(),C.preventDefault();return}else if(_.id==="assetHistoryBtn"){nv(w),C.stopPropagation(),C.preventDefault();return}else if(_.id==="replaceHistoryBtn"){ev(n.querySelector("#replaceInput")),C.stopPropagation(),C.preventDefault();return}else if(_.id==="replaceAllBtn"){wh(n,e,m,!0),C.stopPropagation(),C.preventDefault();break}else if(S==="assetRefresh"){da(w),C.stopPropagation(),C.preventDefault();break}else if(_.id==="replaceBtn"){wh(n,e,m,!1),C.stopPropagation(),C.preventDefault();break}else if(_.classList.contains("b3-list-item__toggle")){_.parentElement.nextElementSibling.classList.toggle("fn__none"),_.firstElementChild.classList.toggle("b3-list-item__arrow--open"),C.stopPropagation(),C.preventDefault();break}else if(_.classList.contains("b3-list-item")){const L=n.querySelector("#searchAssetInput");if(S==="search-new")e.method==0&&bh(t,d.value);else if(S==="search-item"){const D=_.dataset.id?"asset":E.classList.contains("fn__none")?"doc":"unRef";let I=C.detail===1,q=C.detail===2;if(Ha()){const Z=new Date().getTime();I=Z-h>p.TIMEOUT_DBLCLICK,q=!I,h=Z}if(I)g=window.setTimeout(()=>{if(D==="asset")_.classList.contains("b3-list-item--focus")?_.classList.contains("b3-list-item--focus")&&(dx(n.querySelector("#searchAssetPreview")),L.focus()):(w.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus"),dp(n.querySelector("#searchAssetPreview"),_.dataset.id,L.value,window.siyuan.storage[p.LOCAL_SEARCHASSET].method),L.focus());else if(C.altKey){const Z=_.getAttribute("data-node-id");ft(Z,(R,F)=>{ve({app:t,id:Z,action:F,zoomIn:R,position:"right"}),a&&a()})}else _.classList.contains("b3-list-item--focus")?D==="doc"&&_.classList.contains("b3-list-item--focus")&&(bx({edit:m,id:_.getAttribute("data-node-id"),target:_}),d.focus()):((D==="doc"?c:E).querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),_.classList.add("b3-list-item--focus"),xl({edit:D==="doc"?m:f,id:_.getAttribute("data-node-id"),config:D==="doc"?e:null,value:D==="doc"?d.value:null}),d.focus())},p.TIMEOUT_DBLCLICK);else if(q&&et(C)&&(clearTimeout(g),D!=="asset")){const Z=_.getAttribute("data-node-id");ft(Z,(R,F)=>{ve({app:t,id:Z,action:F,zoomIn:R}),a&&a()})}window.siyuan.menus.menu.remove()}else _.querySelector(".b3-list-item__toggle")&&(_.nextElementSibling.classList.toggle("fn__none"),_.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));C.stopPropagation(),C.preventDefault();break}_=_.parentElement}},!1),d.addEventListener("compositionend",C=>{e.page=1,!C.isComposing&&En(n,e,m,!0)}),d.addEventListener("input",C=>{e.page=1,!C.isComposing&&En(n,e,m,!0)}),d.addEventListener("blur",()=>{e.removed&&(e.k=d.value,window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},e),Ee(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA])),av("keys",d.value)}),Hc({inputElement:d,right:8,height:d.clientHeight,clearCB(){e.page=1,En(n,e,m)}}),Hc({right:8,inputElement:u,height:d.clientHeight}),En(n,e,m),{edit:m,unRefEdit:f}},Oc=(t,e)=>{let n="",a="";switch(t){case 0:n=window.siyuan.languages.keyword,a="Exact";break;case 1:n=window.siyuan.languages.querySyntax,a="Quote";break;case 2:n="SQL",a="Database";break;case 3:n=window.siyuan.languages.regex,a="Regex";break}return`<span id="${e}" aria-label="${window.siyuan.languages.searchMethod} ${n}" class="block__icon ariaLabel" data-position="9south">
    <svg><use xlink:href="#icon${a}"></use></svg>
</span>`},Al=(t,e,n,a,i=!1)=>{const s=T(t,"b3-dialog--open");if(s&&s.getAttribute("data-key")===p.DIALOG_SEARCH&&(e.hPath=n.hPath,e.idPath=[...n.idPath]),n.hasReplace!==e.hasReplace){const d=t.querySelectorAll(".search__header")[1];e.hasReplace?d.classList.remove("fn__none"):d.classList.add("fn__none")}const l=t.querySelector("#searchPathInput");e.hPath?(l.innerHTML=`${_i(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,l.setAttribute("aria-label",he(e.hPath))):(l.innerHTML="",l.setAttribute("aria-label","")),n.group!==e.group&&(e.group===0?t.querySelector("#searchExpand").parentElement.classList.add("fn__none"):t.querySelector("#searchExpand").parentElement.classList.remove("fn__none"));let o=!0,r=!1;e.idPath.forEach(d=>{d.endsWith(".sy")&&(o=!1),d.split("/").length>1&&(r=!0)});const c=t.querySelector("#searchInclude");o?c.firstElementChild.classList.add("ft__primary"):c.firstElementChild.classList.remove("ft__primary"),r?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled"),(e.k||i)&&(t.querySelector("#searchInput").value=e.k),t.querySelector("#replaceInput").value=e.r,t.querySelector("#searchSyntaxCheck").outerHTML=Oc(e.method,"searchSyntaxCheck"),n=JSON.parse(JSON.stringify(e)),window.siyuan.storage[p.LOCAL_SEARCHDATA]=JSON.parse(JSON.stringify(e)),Ee(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),En(t,n,a),window.siyuan.menus.menu.remove()},lv=(t,e,n)=>{t.scrollTop=t.scrollTop+e.getBoundingClientRect().top-n.top-n.height/2;const a=T(e.startContainer,"table");if(a){const i=U(e.startContainer,"TD")||U(e.startContainer,"TH");i&&(a.firstElementChild.scrollLeft=i.offsetLeft,a.getAttribute("custom-pinthead")==="true"&&(t.scrollTop=t.scrollTop+a.getBoundingClientRect().top-n.top,a.querySelector("table").scrollTop=i.offsetTop))}},bx=t=>{const e=t.edit.protyle.contentElement.getBoundingClientRect();if(ca()){t.edit.protyle.highlight.markHL.clear(),t.edit.protyle.highlight.mark.clear(),t.edit.protyle.highlight.rangeIndex++,t.edit.protyle.highlight.rangeIndex>=t.edit.protyle.highlight.ranges.length&&(t.edit.protyle.highlight.rangeIndex=0);let i;t.edit.protyle.highlight.ranges.forEach((s,l)=>{t.edit.protyle.highlight.rangeIndex===l?(t.edit.protyle.highlight.markHL.add(s),i=s):t.edit.protyle.highlight.mark.add(s)}),i&&(i.toString()?lv(t.edit.protyle.contentElement,i,e):yc(t.edit.protyle,t.id,"center"));return}let n;const a=Array.from(t.edit.protyle.wysiwyg.element.querySelectorAll('span[data-type~="search-mark"]'));a.find((i,s)=>{if(i.classList.contains("search-mark--hl")){i.classList.remove("search-mark--hl"),n=a[s+1];return}}),n||(n=a[0]),n&&(n.classList.add("search-mark--hl"),t.edit.protyle.contentElement.scrollTop=t.edit.protyle.contentElement.scrollTop+n.getBoundingClientRect().top-e.top-e.height/2)};let up;const xl=t=>{up=t.id,ft(t.id,e=>{up===t.id&&(t.edit.protyle.scroll.lastScrollTop=0,Rl(t.edit.protyle),A("/api/block/getDocInfo",{id:t.id},n=>{var a,i;up===t.id&&(t.edit.protyle.options.render.title&&t.edit.protyle.title.render(t.edit.protyle,n),A("/api/filetree/getDoc",{id:t.id,query:t.value||null,queryMethod:((a=t.config)==null?void 0:a.method)||null,queryTypes:((i=t.config)==null?void 0:i.types)||null,mode:e?0:3,size:e?p.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,zoom:e,highlight:!ca()},s=>{var l,o;if(up!==t.id)return;t.edit.protyle.query={key:t.value||null,method:((l=t.config)==null?void 0:l.method)||null,types:((o=t.config)==null?void 0:o.types)||null},kt({updateReadonly:!0,data:s,protyle:t.edit.protyle,action:e?[p.CB_GET_ALL,p.CB_GET_HTML]:[p.CB_GET_HTML]});const r=t.edit.protyle.contentElement.getBoundingClientRect();if(ca()){let c;Ac(t.edit.protyle,s.data.keywords,t.id,()=>{const d=()=>{const u=t.edit.protyle.highlight.ranges[t.edit.protyle.highlight.rangeIndex];t.edit.protyle.highlight.ranges.length>0&&u&&u.toString()?lv(t.edit.protyle.contentElement,u,r):yc(t.edit.protyle,t.id,"center")};c&&c.disconnect(),d(),c=new ResizeObserver(()=>{d()}),c.observe(t.edit.protyle.wysiwyg.element),setTimeout(()=>{c.disconnect()},p.TIMEOUT_COUNT)})}else{const c=t.edit.protyle.wysiwyg.element.querySelectorAll('span[data-type~="search-mark"]');if(c.length===0)return;c[0].classList.add("search-mark--hl"),t.edit.protyle.contentElement.scrollTop=t.edit.protyle.contentElement.scrollTop+c[0].getBoundingClientRect().top-r.top-r.height/2}}))}))})},wh=(t,e,n,a)=>{if(e.method===2){de(window.siyuan.languages._kernel[132]);return}const i=t.querySelector("#searchList"),s=t.querySelector("#replaceInput"),l=t.querySelector("#searchInput"),o=t.querySelector("svg.fn__rotate");if(!o.classList.contains("fn__none"))return;av("replaceKeys",s.value);const r=i.querySelector(".b3-list-item--focus");if(!r||r.dataset.type==="search-new")return;o.classList.remove("fn__none");const c=r.getAttribute("data-node-id");A("/api/search/findReplace",{k:e.method===0||e.method===1?ox(r):l.value,r:s.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page,ids:a?[]:[c],replaceTypes:e.replaceTypes},d=>{var u;if(o.classList.add("fn__none"),d.code===1){de(d.msg);return}if(a){En(t,e,n,!1);return}const m=r.getAttribute("data-root-id");Oe().editor.forEach(g=>{m===g.editor.protyle.block.rootID&&Ei(g.editor.protyle,!1)});let f=r.getAttribute("data-node-id");if(r.nextElementSibling?f=r.nextElementSibling.getAttribute("data-node-id"):r.previousElementSibling&&(f=r.previousElementSibling.getAttribute("data-node-id")),e.group===1&&!f){const g=r.parentElement.nextElementSibling||((u=r.parentElement.previousElementSibling.previousElementSibling)==null?void 0:u.previousElementSibling);g&&(f=g.nextElementSibling.firstElementChild.getAttribute("data-node-id"))}En(t,e,n,!1,{currentId:c,newId:f})})},En=(t,e,n,a=!1,i)=>{let s=parseInt(t.getAttribute("data-timeout")||"0");clearTimeout(s),s=window.setTimeout(()=>{var l,o;a&&((l=t.querySelector("#criteria .b3-chip--current"))==null||l.classList.remove("b3-chip--current"));const r=t.querySelector(".fn__loading--top");r.classList.remove("fn__none");const c=t.querySelector("#searchInput");e.query=c.value,t.querySelector("#searchList").scrollTo(0,0);const d=t.querySelector('[data-type="previous"]'),u=t.querySelector('[data-type="next"]');(o=n.protyle)==null||o.app.plugins.forEach(f=>{f.eventBus.emit("input-search",{protyle:n,config:e,searchElement:c})});const m=t.querySelector("#searchResult");e.query===""&&(!e.idPath||e.idPath.length===0)?A("/api/block/getRecentUpdatedBlocks",{},f=>{window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]&&window.siyuan.reqIds["/api/search/fullTextSearchBlock"]&&window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]<window.siyuan.reqIds["/api/search/fullTextSearchBlock"]||(ov(f.data,n,t,e),r.classList.add("fn__none"),m.innerHTML="",d.setAttribute("disabled","true"),u.setAttribute("disabled","true"))}):(e.page>1?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled"),A("/api/search/fullTextSearchBlock",{query:e.query,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page||1},f=>{if(window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]&&window.siyuan.reqIds["/api/search/fullTextSearchBlock"]&&window.siyuan.reqIds["/api/block/getRecentUpdatedBlocks"]>window.siyuan.reqIds["/api/search/fullTextSearchBlock"])return;e.page||(e.page=1),e.page<f.data.pageCount?u.removeAttribute("disabled"):u.setAttribute("disabled","disabled"),ov(f.data.blocks,n,t,e,i);let g=window.siyuan.languages.findInDoc.replace("${x}",f.data.matchedRootCount).replace("${y}",f.data.matchedBlockCount);f.data.docMode&&(g=window.siyuan.languages.matchDoc.replace("${x}",f.data.matchedRootCount)),m.innerHTML=`${e.page}/${f.data.pageCount||1}<span class="fn__space"></span>
<span class="ft__on-surface">${g}</span>`,r.classList.add("fn__none"),m.setAttribute("data-pagecount",f.data.pageCount||1)}))},p.TIMEOUT_INPUT),t.setAttribute("data-timeout",s.toString())},vh=t=>{let e="";return t.name&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span class="b3-list-item__hinttext">${t.name}</span></span>`),t.alias&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span class="b3-list-item__hinttext">${t.alias}</span></span>`),t.memo&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span class="b3-list-item__hinttext">${t.memo}</span></span>`),e},ov=(t,e,n,a,i)=>{let s="",l,o;if(t.forEach(r=>{const c=Qa(r.box)+xt(r.hPath,!1);let d="";r.children?(s+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${be(vA(r.box)||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text ariaLabel" style="color: var(--b3-theme-on-surface)" aria-label="${Zt(c)}">${_i(c)}</span>
</div><div>`,r.children.forEach(u=>{i&&(u.id===i.currentId&&(l=u),u.id===i.newId&&(o=u)),u.refCount&&(d=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${u.refCount}</span>`),s+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item" data-node-id="${u.id}" data-root-id="${u.rootID}">
<svg class="b3-list-item__graphic popover__block" data-id="${u.id}"><use xlink:href="#${la(u.type)}"></use></svg>
${be(u.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${u.content}</span>
${vh(u)}
${u.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${u.tag.replace(/#/g,"")}</span>`:""}
${d}
</div>`}),s+="</div>"):(i&&(r.id===i.currentId&&(l=r),r.id===i.newId&&(o=r)),r.refCount&&(d=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${r.refCount}</span>`),s+=`<div data-type="search-item" class="b3-list-item" data-node-id="${r.id}" data-root-id="${r.rootID}">
<svg class="b3-list-item__graphic popover__block" data-id="${r.id}"><use xlink:href="#${la(r.type)}"></use></svg>
${be(r.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${r.content}</span>
${vh(r)}
${r.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${r.tag.replace(/#/g,"")}</span>`:""}
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Zt(c)}">${_i(c)}</span>
${d}
</div>`)}),l||(l=o),!l&&t.length>0&&(t[0].children?l=t[0].children[0]:l=t[0]),l?(e.protyle.element.classList.remove("fn__none"),n.querySelector(".search__drag").classList.remove("fn__none"),xl({edit:e,id:l.id,config:a,value:n.querySelector("#searchInput").value})):(e.protyle.element.classList.add("fn__none"),n.querySelector(".search__drag").classList.add("fn__none")),n.querySelector("#searchList").innerHTML=s||(a.method===0?`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${he(n.querySelector("#searchInput").value)}</mark>
    </span>
    <kbd class="b3-list-item__meta">${window.siyuan.languages.enterNew}</kbd>
</div>
<div class="search__empty">
    ${window.siyuan.languages.enterNewTip}
</div>`:`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <span class="b3-list-item__text">
        ${window.siyuan.languages.emptyContent}
    </span>
</div>`),l){const r=n.querySelector(`[data-node-id="${l.id}"]`);r&&(r.classList.add("b3-list-item--focus"),!r.previousElementSibling&&r.parentElement.previousElementSibling?r.parentElement.previousElementSibling.scrollIntoView():r.scrollIntoView())}},rv=t=>{var e;const n=parseInt(t.getAttribute("data-subtype").substr(1));let a=t.nextElementSibling;for(;a;){const i=parseInt((e=a.getAttribute("data-subtype"))==null?void 0:e.substr(1));if(!a.classList.contains("protyle-attr")&&(isNaN(i)||i>n)){const s=a;a=a.nextElementSibling,s.remove()}else break}};class yx{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();if(this.render(e,n,!1),this.hasUndo=!0,this.redoStack.push(n),e.breadcrumb){const a=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&(this.undoStack.length===0&&a.setAttribute("disabled","true"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(e){if(e.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();if(this.render(e,n,!0),this.undoStack.push(n),e.breadcrumb){const a=e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&(e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&a.setAttribute("disabled","true"))}}render(e,n,a){var i;ce(["hint","gutter"],e),e.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(s=>{Tp(e,s,!0)}),V(e,n.doOperations)):(n.undoOperations.forEach(s=>{Tp(e,s,!0)}),V(e,n.undoOperations)),(i=document.querySelector(".av__panel"))==null||i.remove(),ra(e),Ye(e)}replace(e,n){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,n.breadcrumb)){const a=n.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&a.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,n,a){if(this.undoStack.push({undoOperations:n,doOperations:e}),this.undoStack.length>p.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),a.breadcrumb){const i=a.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');i&&i.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const ai=t=>!1,_x=(t,e,n)=>{var a,i,s,l,o,r,c,d,u;let m,f="",g=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(g.length===0){let b=Et(e);const y=j(b,"fold","1");y&&(b=y),(a=b.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(b=Et(b.parentElement)),g=[b]}const h=g[0].getAttribute("data-type");if(h==="NodeListItem"&&!g[0].previousElementSibling&&((s=(i=g[0].parentElement.previousElementSibling)==null?void 0:i.previousElementSibling)!=null&&s.classList.contains("protyle-action")))if((l=g[0].parentElement.parentElement.previousElementSibling)!=null&&l.classList.contains("li")){if(m=g[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),f=g[0].parentElement.parentElement.parentElement.outerHTML,!m){const b=Lute.NewNodeID();g[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),m=g[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(h==="NodeList"&&((r=(o=g[0].previousElementSibling)==null?void 0:o.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=g[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(m=g[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),f=g[0].parentElement.parentElement.outerHTML,!m){const b=Lute.NewNodeID();g[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),m=g[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(m){m=m.lastElementChild.previousElementSibling;const b=g[0].classList.contains("list")?g[0]:g[0].parentElement;g.reverse().forEach(y=>{y.classList.contains("list")?m.after(y.firstElementChild):m.after(y)}),m.id==="moveTempLi"&&(m=m.nextElementSibling,m.previousElementSibling.remove()),b.childElementCount===1?b.remove():b.getAttribute("data-subtype")==="o"&&b.classList.contains("list")&&Tt(b,1),m.getAttribute("data-subtype")==="o"&&Tt(m.parentElement),le(t,m.parentElement.parentElement.parentElement.getAttribute("data-node-id"),m.parentElement.parentElement.parentElement.outerHTML,f),ra(t),we(m.parentElement,n),Ye(t);return}if(!(!g[0].previousElementSibling||(d=g[0].previousElementSibling)!=null&&d.classList.contains("protyle-action"))){if(m=g[0].previousElementSibling,g[0].getAttribute("data-subtype")==="o"&&h==="NodeListItem"){const b=g[0].parentElement.outerHTML;g[g.length-1].after(m),Tt(g[0].parentElement,1),le(t,g[0].parentElement.getAttribute("data-node-id"),g[0].parentElement.outerHTML,b)}else{const b=m.getAttribute("data-node-id");V(t,[{action:"move",id:b,previousID:g[g.length-1].getAttribute("data-node-id")}],[{action:"move",id:b,previousID:(u=m.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||t.block.parentID}]),g[g.length-1].after(m)}ra(t),Ye(t)}},wx=(t,e,n)=>{var a,i,s,l,o,r,c;let d,u="",m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){let g=Et(e);const h=j(g,"fold","1");h&&(g=h),(a=g.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(g=Et(g.parentElement)),m=[g]}const f=m[0].getAttribute("data-type");if(f==="NodeListItem"&&m[m.length-1].nextElementSibling.classList.contains("protyle-attr")&&((i=m[0].parentElement.parentElement)!=null&&i.classList.contains("li")))if((s=m[0].parentElement.parentElement.nextElementSibling)!=null&&s.classList.contains("li")){if(d=m[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=m[0].parentElement.parentElement.parentElement.outerHTML,!d){const g=Lute.NewNodeID();m[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${g}" data-type="NodeList" class="list" updated="${g.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=m[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(f==="NodeList"&&m[m.length-1].nextElementSibling.classList.contains("protyle-attr")&&((l=m[0].parentElement)!=null&&l.classList.contains("li")))if((o=m[0].parentElement.nextElementSibling)!=null&&o.classList.contains("li")){if(d=m[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=m[0].parentElement.parentElement.outerHTML,!d){const g=Lute.NewNodeID();m[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${g}" data-type="NodeList" class="list" updated="${g.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),d=m[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(d){const g=m[0].classList.contains("list")?m[0]:m[0].parentElement;m.forEach(h=>{h.classList.contains("list")?d.before(h.firstElementChild):d.before(h)}),g.childElementCount===1?g.remove():g.getAttribute("data-subtype")==="o"&&g.classList.contains("list")&&Tt(g,1),d.getAttribute("data-subtype")==="o"&&Tt(d.parentElement,1),le(t,d.parentElement.parentElement.parentElement.getAttribute("data-node-id"),d.parentElement.parentElement.parentElement.outerHTML,u),ra(t),we(d.parentElement,n),Ye(t);return}if(!(!m[m.length-1].nextElementSibling||(r=m[m.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(d=m[m.length-1].nextElementSibling,d.getAttribute("data-subtype")==="o"&&d.getAttribute("data-type")==="NodeListItem"){const g=d.parentElement.outerHTML;m[0].before(d),Tt(d.parentElement,1),le(t,d.parentElement.getAttribute("data-node-id"),d.parentElement.outerHTML,g)}else{const g=d.getAttribute("data-node-id");V(t,[{action:"move",id:g,previousID:(c=m[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:d.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:g,previousID:m[m.length-1].getAttribute("data-node-id")}]),m[0].before(d)}ra(t),Ye(t)}},cv=(t,e,n)=>{if(e.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const a=t.querySelector("#searchList"),i=t.querySelector("#toolbarReplace"),s=i.parentElement.querySelector(".fn__rotate");if(!s.classList.contains("fn__none"))return;saveKeyList("replaceKeys",i.value);const l=a.querySelector(".b3-list-item--focus");if(!l)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none");const o=l.getAttribute("data-node-id");fetchPost("/api/search/findReplace",{k:e.method===0||e.method===1?getKeyByLiElement(l):document.querySelector("#toolbarSearch").value,r:i.value,ids:n?[]:[o],types:e.types,method:e.method,replaceTypes:e.replaceTypes,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},r=>{var c;if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(n){ua(e,t,!1);return}reloadProtyle(window.siyuan.mobile.editor.protyle,!1);let d=l.getAttribute("data-node-id");if(l.nextElementSibling?d=l.nextElementSibling.getAttribute("data-node-id"):l.previousElementSibling&&(d=l.previousElementSibling.getAttribute("data-node-id")),e.group===1&&!d){const u=l.parentElement.nextElementSibling||((c=l.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);u&&(d=u.nextElementSibling.firstElementChild.getAttribute("data-node-id"))}ua(e,t,!1,{currentId:o,newId:d})})},Eh=(t,e,n)=>{n.hasReplace!==e.hasReplace&&(e.hasReplace?(t.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),t.querySelector(".toolbar").classList.remove("fn__none")):(t.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),t.querySelector(".toolbar").classList.add("fn__none")));const a=t.querySelector("#searchPath");e.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(e.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==e.group&&(e.group===0?(t.querySelector('[data-type="expand"]').classList.add("fn__none"),t.querySelector('[data-type="contract"]').classList.add("fn__none")):(t.querySelector('[data-type="expand"]').classList.remove("fn__none"),t.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;e.idPath.forEach(o=>{o.endsWith(".sy")&&(i=!1),o.split("/").length>1&&(s=!0)});const l=t.querySelector('[data-type="include"]');i?l.classList.add("toolbar__icon--active"):l.classList.remove("toolbar__icon--active"),s?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=e.k,t.querySelector("#toolbarReplace").value=e.r,Object.assign(n,e),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),ua(n,t),window.siyuan.menus.menu.remove()},dv=(t,e,n,a)=>{const i=document.querySelector("#searchList");let s="",l,o;t.forEach(c=>{const d=getNotebookName(c.box)+getDisplayName(c.hPath,!1);c.children?(s+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(c.box)||window.siyuan.storage[Constants.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(d)}</span>
</div><div>`,c.children.forEach(u=>{a&&(u.id===a.currentId&&(l=u),u.id===a.newId&&(o=u)),s+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item" data-node-id="${u.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(u.type)}"></use></svg>
${unicode2Emoji(u.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${u.content}</span>
${u.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${u.tag.replace(/#/g,"")}</span>`:""}
</div>`}),s+="</div>"):(a&&(c.id===a.currentId&&(l=c),c.id===a.newId&&(o=c)),s+=`<div class="b3-list-item b3-list-item--two" data-type="search-item" data-node-id="${c.id}">
    <div class="b3-list-item__first">
        <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(c.type)}"></use></svg>
        ${unicode2Emoji(c.ial.icon,"b3-list-item__graphic",!0)}
        <span class="b3-list-item__text">${c.content}</span>
    </div>
    <div class="fn__flex">
        ${c.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${c.tag.replace(/#/g,"")}</span><span class="fn__space"></span>`:""}
        <span class="b3-list-item__text b3-list-item__meta">${escapeGreat(d)}</span>
    </div>
</div>`)}),i.innerHTML=s||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,i.scrollTop=0;let r="";if(n){let c=window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount);n.data.docMode&&(c=window.siyuan.languages.matchDoc.replace("${x}",n.data.matchedRootCount)),r=`<span class="fn__flex-center">${c}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e.page}/${n.data.pageCount||1}</span>`}if(i.previousElementSibling.querySelector('[data-type="result"]').innerHTML=r,l||(l=o),!l&&t.length>0&&(t[0].children?l=t[0].children[0]:l=t[0]),l){const c=i.querySelector(`[data-node-id="${l.id}"]`);c&&(c.classList.add("b3-list-item--focus"),c.scrollIntoView())}};let uv=0;const ua=(t,e,n=!1,a)=>{clearTimeout(uv),uv=window.setTimeout(()=>{var i;n&&((i=e.querySelector("#criteria .b3-chip--current"))==null||i.classList.remove("b3-chip--current"));const s=e.querySelector(".fn__loading--top");s.classList.remove("fn__none");const l=e.querySelector('[data-type="previous"]'),o=e.querySelector('[data-type="next"]'),r=document.getElementById("toolbarSearch");t.query=r.value,t.query===""&&(!t.idPath||t.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},c=>{dv(c.data,t,void 0,a),s.classList.add("fn__none"),l.setAttribute("disabled","true"),o.setAttribute("disabled","true")}):(t.page||(t.page=1),t.page>1?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:t.query,method:t.method,types:t.types,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},c=>{dv(c.data.blocks,t,c,a),s.classList.add("fn__none"),t.page<c.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},vx=(t,e,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",d=>{d&&d.isComposing||(n.page=1,ua(n,e,!0))}),a.addEventListener("input",d=>{d&&d.isComposing||(n.page=1,ua(n,e,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),saveKeyList("keys",a.value)}),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){n.page=1,ua(n,e)}});const i=e.querySelector(".toolbar .toolbar__title");i.value=n.r||"",addClearButton({inputElement:i,className:"toolbar__icon"});const s=[];initCriteriaMenu(e.querySelector("#criteria"),s,n);const l=document.querySelector("#searchAssetsPanel"),o=document.querySelector("#searchUnRefPanel"),r=e.querySelector("#searchList"),c=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];e.addEventListener("click",d=>{var u,m;let f=d.target;for(;f&&f!==e;){const g=f.getAttribute("data-type");if(g==="replaceHistory"){toggleReplaceHistory(f.nextElementSibling),d.stopPropagation(),d.preventDefault();break}else if(g==="assetHistory"){toggleAssetHistory(l),d.stopPropagation(),d.preventDefault();break}else if(g==="previous"){f.getAttribute("disabled")||(n.page--,ua(n,e)),d.stopPropagation(),d.preventDefault();break}else if(g==="next"){f.getAttribute("disabled")||(n.page++,ua(n,e)),d.stopPropagation(),d.preventDefault();break}else if(g==="set-criteria"){n.removed=!1,(u=f.parentElement.querySelector(".b3-chip--current"))==null||u.classList.remove("b3-chip--current"),f.classList.add("b3-chip--current"),s.find(h=>{if(h.name===f.innerText.trim())return Eh(e,h,n),!0}),d.stopPropagation(),d.preventDefault();break}else if(g==="remove-criteria"){const h=f.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:h}),s.find((b,y)=>{if(b.name===h)return s.splice(y,1),!0}),f.parentElement.classList.contains("b3-chip--current")&&Eh(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n),f.parentElement.parentElement.childElementCount===1&&f.parentElement.parentElement.classList.add("fn__none"),f.parentElement.remove(),d.stopPropagation(),d.preventDefault();break}else if(g==="remove-path"){n.idPath=[],n.hPath="",e.querySelector("#searchPath").classList.add("fn__none"),n.page=1,ua(n,e,!0);const h=e.querySelector('[data-type="include"]');h.classList.remove("toolbar__icon--active"),h.setAttribute("disabled","disabled"),d.stopPropagation(),d.preventDefault();break}else if(g==="expand"){Array.from(r.children).forEach(h=>{h.classList.contains("b3-list-item")&&(h.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),h.nextElementSibling.classList.remove("fn__none"))}),d.stopPropagation(),d.preventDefault();break}else if(g==="contract"){Array.from(r.children).forEach(h=>{h.classList.contains("b3-list-item")&&(h.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),h.nextElementSibling.classList.add("fn__none"))}),d.stopPropagation(),d.preventDefault();break}else if(g==="currentPath"&&!f.hasAttribute("disabled")){const h=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[h.path]},b=>{n.idPath=[pathPosix().join(h.notebookId,h.path)],n.hPath=b.data[0];const y=e.querySelector("#searchPath");y.classList.remove("fn__none"),y.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const w=e.querySelector('[data-type="include"]');w.classList.remove("toolbar__icon--active"),w.removeAttribute("disabled"),n.page=1,ua(n,e,!0)}),d.stopPropagation(),d.preventDefault();break}else if(g==="path"){movePathTo((h,b)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:h},y=>{n.idPath=[];const w=[];let E=!1;h.forEach((M,k)=>{M==="/"?(n.idPath.push(b[k]),w.push(getNotebookName(b[k]))):(E=!0,n.idPath.push(pathPosix().join(b[k],M.replace(".sy",""))))}),y.data&&w.push(...y.data),n.hPath=w.join(" ");const C=e.querySelector("#searchPath");C.classList.remove("fn__none"),C.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const $=e.querySelector('[data-type="include"]');$.classList.add("toolbar__icon--active"),E?$.removeAttribute("disabled"):$.setAttribute("disabled","disabled"),n.page=1,ua(n,e,!0)})},[],void 0,window.siyuan.languages.specifyPath),d.stopPropagation(),d.preventDefault();break}else if(g==="include"&&!f.hasAttribute("disabled")){f.classList.toggle("toolbar__icon--active"),f.classList.contains("toolbar__icon--active")?n.idPath.forEach((h,b)=>{h.endsWith(".sy")&&(n.idPath[b]=h.replace(".sy",""))}):n.idPath.forEach((h,b)=>{!h.endsWith(".sy")&&h.split("/").length>1&&(n.idPath[b]=h+".sy")}),n.page=1,ua(n,e,!0),d.stopPropagation(),d.preventDefault();break}else if(g==="toggle-replace"){n.hasReplace=!n.hasReplace,i.parentElement.classList.toggle("fn__none"),f.classList.toggle("toolbar__icon--active"),d.stopPropagation(),d.preventDefault();break}else if(g==="more"){moreMenu(n,s,e,()=>{n.page=1,ua(n,e,!0)},()=>{Eh(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),d.stopPropagation(),d.preventDefault();break}else if(g==="replace-all"){cv(e,n,!0),d.stopPropagation(),d.preventDefault();break}else if(g==="refreshUnRef"){fp(o),d.stopPropagation(),d.preventDefault();break}else if(g==="unRefPrevious"){if(!f.getAttribute("disabled")){let h=parseInt(o.querySelector("#searchUnRefResult").lastElementChild.textContent);h>1&&(h--,fp(o,h))}d.stopPropagation(),d.preventDefault();break}else if(g==="unRefNext"){const h=o.querySelector("#searchUnRefResult").lastElementChild;let b=parseInt(h.textContent);b<parseInt(h.textContent.split("/")[1])&&(b++,fp(o,b)),d.stopPropagation(),d.preventDefault();break}else if(g==="queryAsset"){assetMethodMenu(f,()=>{assetInputEvent(l,c),setStorageVal(Constants.LOCAL_SEARCHASSET,c)}),d.stopPropagation(),d.preventDefault();break}else if(g==="filterAsset"){assetFilterMenu(l),d.stopPropagation(),d.preventDefault();break}else if(g==="moreAsset"){assetMoreMenu(f,l,()=>{assetInputEvent(l),setStorageVal(Constants.LOCAL_SEARCHASSET,c)}),d.stopPropagation(),d.preventDefault();break}else if(g==="goAsset"){Ex(),d.stopPropagation(),d.preventDefault();break}else if(g==="goSearch"){l.classList.add("fn__none"),o.classList.add("fn__none"),d.stopPropagation(),d.preventDefault();break}else if(g==="assetPrevious"){f.getAttribute("disabled")||assetInputEvent(l,c,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),d.stopPropagation(),d.preventDefault();break}else if(g==="assetNext"){f.getAttribute("disabled")||assetInputEvent(l,c,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),d.stopPropagation(),d.preventDefault();break}else if(g==="replace"){cv(e,n,!1),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item__toggle")){f.parentElement.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.classList.toggle("b3-list-item__arrow--open"),d.stopPropagation(),d.preventDefault();break}else if(f.classList.contains("b3-list-item")){if(f.getAttribute("data-type")==="search-new")newFileByName(t,a.value);else if(f.getAttribute("data-type")==="search-item"){const h=f.getAttribute("data-node-id");h?((m=window.siyuan.mobile.editor)!=null&&m.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(h,b=>{openMobileFileById(t,h,b?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):f.classList.contains("b3-list-item--focus")?f.classList.contains("b3-list-item--focus")&&renderNextAssetMark(e.querySelector("#searchAssetPreview")):(e.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),f.classList.add("b3-list-item--focus"),renderPreview(e.querySelector("#searchAssetPreview"),f.dataset.id,e.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else f.querySelector(".b3-list-item__toggle")&&(f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));d.stopPropagation(),d.preventDefault();break}f=f.parentElement}},!1)},hD=(t,e)=>{var n;const a=JSON.parse(JSON.stringify(window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),i=(((n=getCurrentEditor())==null?void 0:n.protyle.toolbar.range)||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();i&&(a.k=i),e&&Object.keys(e).forEach(o=>{a[o]=e[o]}),activeBlur();let s=!0,l=!1;a.idPath.forEach(o=>{o.endsWith(".sy")&&(s=!1),o.split("/").length>1&&(l=!0)}),openModel({title:`<div class="fn__flex">
    <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="history">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block" autocomplete="off" autocorrect="off" spellcheck="false">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${a.hasReplace?"":" fn__none"}">
        <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="replaceHistory">
            <svg class="svg--mid"><use xlink:href="#iconReplace"></use></svg>
            <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${a.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(a.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${a.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${l?"":"disabled"} data-type="include" class="toolbar__icon${s?" toolbar__icon--active":""}"><use xlink:href="#iconInclude"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
           <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="assetHistory">
                <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
                <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(o){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(t,document.querySelector("#toolbarSearch").value)}),document.querySelector('.toolbar [data-type="history"]').addEventListener("click",()=>{toggleSearchHistory(document.querySelector("#model"),a,void 0)}),vx(t,o.firstElementChild,a),ua(a,o)}})},Ex=()=>{const t=document.querySelector("#searchAssetsPanel");if(t.classList.remove("fn__none"),t.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],a=t.querySelector("input");a.value=n.k,a.addEventListener("compositionend",i=>{i.isComposing||assetInputEvent(t,n)}),a.addEventListener("input",i=>{i.isComposing||assetInputEvent(t,n)}),a.addEventListener("blur",()=>{saveAssetKeyList(a)}),assetInputEvent(t,n),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){assetInputEvent(t,n)}})},bD=()=>{window.siyuan.menus.menu.remove();const t=document.querySelector("#searchUnRefPanel");t.classList.remove("fn__none"),!t.querySelector("#searchUnRefList").innerHTML&&fp(t)},fp=(t,e=1)=>{const n=t.querySelector('[data-type="unRefPrevious"]');e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),fetchPost("/api/search/listInvalidBlockRefs",{page:e},a=>{t.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const i=t.querySelector('[data-type="unRefNext"]');e<a.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");let s="";a.data.blocks.forEach((l,o)=>{const r=getNotebookName(l.box)+getDisplayName(l.hPath,!1);s+=`<div class="b3-list-item b3-list-item--two${o===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${l.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(l.type)}"></use></svg>
    ${unicode2Emoji(l.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${l.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),t.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e}/${a.data.pageCount||1}</span>`,t.querySelector("#searchUnRefList").innerHTML=s||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},yD=t=>{fetchPost("/api/storage/getRecentDocs",{sortBy:"viewedAt"},e=>{let n="";e.data.forEach((a,i)=>{n+=`<li data-index="${i}" data-node-id="${a.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${unicode2Emoji(a.icon||window.siyuan.storage[Constants.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(a.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&openMobileFileById(t,s.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},Cl=t=>{if(!t)return"";const e=De().extname(t).toLowerCase();return p.SIYUAN_ASSETS_IMAGE.includes(e)?`<img style="max-height: 100%" src="${t}">`:p.SIYUAN_ASSETS_AUDIO.includes(e)?`<audio style="max-width: 100%" controls="controls" src="${t}"></audio>`:p.SIYUAN_ASSETS_VIDEO.includes(e)?`<video style="max-width: 100%" controls="controls" src="${t}"></video>`:t},kx=()=>{Oe().asset.forEach(t=>{const e=t.pdfObject;if(!e)return;const{pdfDocument:n,pdfViewer:a}=e;if(!n)return;const i=t.element.querySelector("#viewerContainer");if(i.clientHeight===0)return;if(i){const l=i.getAttribute("data-scrolltop");l&&(i.scrollTo(0,parseInt(l)),i.removeAttribute("data-scrolltop"))}const s=a.currentScaleValue;(s==="auto"||s==="page-fit"||s==="page-width")&&(a.currentScaleValue=s),a.update()})},fv=(t,e,n,a)=>{let i="";if(p.SIYUAN_ASSETS_AUDIO.includes(t))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${Q().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${e}"></audio>${p.ZWSP}</div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;else if(p.SIYUAN_ASSETS_IMAGE.includes(t)){let s="";e.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${e}" data-src="${e}" alt="${n}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else p.SIYUAN_ASSETS_VIDEO.includes(t)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${Q().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${p.ZWSP}<video controls="controls" src="${e}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${e}">${a}</span>`;return i},kh=(t,e)=>{if(!t||t.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return t.forEach((a,i)=>{let s="";e&&(s=`data-id2="${e[i].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${at(a.path)} ${a.hSize}">${he(a.title)}</span>
</li>`}),n};let Tl,Go;const pv=(t,e)=>{if(!T(e,"history__side"))return;const a=T(e,"b3-dialog__container");if(!a)return;const i=a.querySelector('[data-type="editors"]'),s=i.firstElementChild,l=i.lastElementChild;Tl||(Tl=new ba(t,s.lastElementChild,{blockId:"",history:{snapshot:""},action:[p.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Sa(Tl.protyle),Go=new ba(t,l.lastElementChild,{blockId:"",action:[p.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Sa(Go.protyle)),A("/api/repo/openRepoSnapshotDoc",{id:e.getAttribute("data-id")},r=>{s.classList.remove("fn__none");const c=s.querySelector("textarea"),d=De().extname(r.data.content).toLowerCase(),u=s.querySelector(".protyle-title__input");p.SIYUAN_ASSETS_IMAGE.concat(p.SIYUAN_ASSETS_AUDIO).concat(p.SIYUAN_ASSETS_VIDEO).includes(d)?(c.previousElementSibling.innerHTML=Cl(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),Tl.protyle.options.history.snapshot=a.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),kt({data:r,protyle:Tl.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]})),u.textContent=r.data.title,s.querySelector(".history__date").textContent=Q(r.data.updated).format("YYYY-MM-DD HH:mm")});const o=e.getAttribute("data-id2");o?(l.classList.remove("fn__none"),A("/api/repo/openRepoSnapshotDoc",{id:o},r=>{const c=l.querySelector("textarea"),d=De().extname(r.data.content).toLowerCase(),u=l.querySelector(".protyle-title__input");p.SIYUAN_ASSETS_IMAGE.concat(p.SIYUAN_ASSETS_AUDIO).concat(p.SIYUAN_ASSETS_VIDEO).includes(d)?(c.previousElementSibling.innerHTML=Cl(r.data.content),c.previousElementSibling.classList.remove("fn__none"),c.classList.add("fn__none"),l.lastElementChild.classList.add("fn__none")):r.data.displayInText?(c.value=r.data.content,c.classList.remove("fn__none"),l.lastElementChild.classList.add("fn__none"),c.previousElementSibling.classList.add("fn__none")):(c.classList.add("fn__none"),l.lastElementChild.classList.remove("fn__none"),c.previousElementSibling.classList.add("fn__none"),Go.protyle.options.history.snapshot=a.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),kt({data:r,protyle:Go.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]})),u.textContent=r.data.title,l.querySelector(".history__date").textContent=Q(r.data.updated).format("YYYY-MM-DD HH:mm")})):l.classList.add("fn__none")},Sx=(t,e)=>{if(e.length!==2)return;let n,a;e[0].time>e[1].time?(n=e[1].id,a=e[0].id):(n=e[0].id,a=e[1].id);const i=new $e({title:window.siyuan.languages.compare,content:"",width:Y()?"92vw":"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Tl=void 0,Go=void 0}});i.element.setAttribute("data-key",p.DIALOG_HISTORYCOMPARE),i.element.addEventListener("click",s=>{var l;if(typeof s.detail=="string"){pv(t,i.element.querySelector(".history__side .b3-list-item--focus")),s.stopPropagation(),s.preventDefault();return}let o=s.target;for(;o&&o!==i.element;){if(o.classList.contains("b3-list-item")&&!o.dataset.id){o.nextElementSibling.classList.toggle("fn__none"),o.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item")&&o.dataset.id){if(o.classList.contains("b3-list-item--focus"))return;(l=i.element.querySelector(".history__side .b3-list-item--focus"))==null||l.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),pv(t,o),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("block__icon")){o.getAttribute("data-direct")==="left"?(o.setAttribute("data-direct","right"),Sh(a,n,i,"right")):(o.setAttribute("data-direct","left"),Sh(n,a,i,"left")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}}),Sh(n,a,i,"left")},Sh=(t,e,n,a)=>{Tl=void 0,Go=void 0;const i=Y();A("/api/repo/diffRepoSnapshots",{left:t,right:e},s=>{const l=n.element.querySelector(".b3-dialog__header");l.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${Q(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${Q(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,l.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__side" ${Y()?"":`style="width: ${window.siyuan.storage[p.LOCAL_HISTORY].sideDiffWidth}"`}>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${kh(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${kh(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${kh(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex" data-type="editors">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${Q(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${s.data.left.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${s.data.right.title} ${Q(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${s.data.right.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`,ep(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDiffWidth")})};let Dl;const jo=(t,e)=>{const n=t.querySelector('[data-type="docprevious"]'),a=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const i=t.querySelector('button[data-type="jumpHistoryPage"]');i.textContent=`${e}`;const s=t.querySelector(".b3-text-field"),l=t.querySelector('.b3-select[data-type="opselect"]'),o=t.querySelector('.b3-select[data-type="typeselect"]'),r=t.querySelector('.b3-select[data-type="notebookselect"]'),c=t.querySelector('.history__text[data-type="docPanel"]'),d=t.querySelector('.history__text[data-type="assetPanel"]'),u=t.querySelector('.history__text[data-type="mdPanel"]'),m=t.querySelector(".b3-list");t.querySelector(".protyle-title__input").classList.add("fn__none"),d.classList.add("fn__none"),u.classList.add("fn__none"),c.classList.add("fn__none"),o.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[p.LOCAL_HISTORY].type!==2&&(l.value="all"),l.querySelector('option[value="clean"]').classList.remove("fn__none"),l.querySelector('option[value="update"]').classList.remove("fn__none"),l.querySelector('option[value="delete"]').classList.add("fn__none"),l.querySelector('option[value="format"]').classList.add("fn__none"),l.querySelector('option[value="sync"]').classList.remove("fn__none"),l.querySelector('option[value="replace"]').classList.add("fn__none"),l.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[p.LOCAL_HISTORY].type===2&&(l.value="all"),l.querySelector('option[value="clean"]').classList.add("fn__none"),l.querySelector('option[value="update"]').classList.remove("fn__none"),l.querySelector('option[value="delete"]').classList.remove("fn__none"),l.querySelector('option[value="format"]').classList.remove("fn__none"),l.querySelector('option[value="sync"]').classList.remove("fn__none"),l.querySelector('option[value="replace"]').classList.remove("fn__none"),l.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[p.LOCAL_HISTORY].notebookId=r.value,window.siyuan.storage[p.LOCAL_HISTORY].type=parseInt(o.value),window.siyuan.storage[p.LOCAL_HISTORY].operation=l.value,Ee(p.LOCAL_HISTORY,window.siyuan.storage[p.LOCAL_HISTORY]),A("/api/history/searchHistory",{notebook:r.value,query:s.value,page:e,op:l.value,type:parseInt(o.value)},f=>{e<f.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(f.data.pageCount||1).toString());const g=a.nextElementSibling.nextElementSibling;if(g.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",f.data.pageCount).replace("${y}",f.data.totalCount||1)}`,g.classList.remove("fn__none"),f.data.histories.length===0){m.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let h="";f.data.histories.forEach(b=>{h+=`<li class="b3-list-item" data-type="toggle" data-created="${b}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${Q(parseInt(b)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),m.innerHTML=h})},gv=(t,e,n)=>{if(t.data.snapshots.length===0){e.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeCloudRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:n==="getCloudRepoSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>`:n==="getRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="uploadSnapshot" aria-label="${window.siyuan.languages.upload}"><svg><use xlink:href="#iconUpload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:n==="getRepoSnapshots"&&(a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="genTag" aria-label="${window.siyuan.languages.tagSnapshot}"><svg><use xlink:href="#iconTags"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>`);let i="";const s=Y();t.data.snapshots.forEach(l=>{let o="";l.typesCount&&(o=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${l.count}<span class="fn__space"></span>`,l.typesCount.forEach(c=>{o+=`${c.type} ${c.count}<span class="fn__space"></span>`}),o+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${l.hCreated}</span>
    <span class="fn__space"></span>
    ${l.hSize}
    <span class="fn__space"></span>
    ${l.systemOS}${l.systemName&&l.systemOS?"/":""}${l.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${l.tag?"":" fn__none"}">${l.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${he(l.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${l.id.substring(0,7)}</code>
</div>
${o}`;i+=`<li class="b3-list-item b3-list-item--hide-action" data-type="repoitem" data-id="${l.id}" data-tag="${l.tag}">
<div class="fn__flex-1">${r}</div>
${a}
</li>`}),e.lastElementChild.innerHTML=`${i}`},Ls=(t,e)=>{const n=t.querySelector(".b3-select");n.disabled=!0;const a=n.value;t.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const i=t.querySelector('button[data-type="jumpRepoPage"]');i.textContent=`${e}`;const s=t.querySelector('[data-type="previous"]'),l=t.querySelector('[data-type="next"]'),o=l.nextElementSibling.nextElementSibling;t.setAttribute("data-init","true"),a==="getRepoTagSnapshots"||a==="getCloudRepoTagSnapshots"?(A(`/api/repo/${a}`,{},r=>{gv(r,t,a),n.disabled=!1}),s.classList.add("fn__none"),l.classList.add("fn__none"),o.classList.add("fn__none"),i.classList.add("fn__none")):(s.classList.remove("fn__none"),l.classList.remove("fn__none"),i.classList.remove("fn__none"),t.setAttribute("data-page",e.toString()),e>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),l.setAttribute("disabled","disabled"),A(`/api/repo/${a}`,{page:e},r=>{n.disabled=!1,e<r.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),o.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,o.classList.remove("fn__none"),gv(r,t,a)}))},Lx=t=>{t.setAttribute("data-init","true"),A("/api/history/getNotebookHistory",{},e=>{if(e.data.histories.length===0){t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";e.data.histories.forEach((a,i)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${i===0?"":"fn__none"}">`,a.items.forEach(s=>{n+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${he(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),t.innerHTML=n})},pp=t=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(s=>{if(s.element.querySelector("#historyContainer"))return s.destroy(),!0}))return;const n=window.siyuan.storage[p.LOCAL_HISTORY];let a=`<option value='%' ${n.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(s=>{s.closed||(a+=` <option value="${s.id}"${s.id===n.notebookId?" selected":""}>${he(s.name)}</option>`)});const i=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" ${Y()?"":'style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0"'}>
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${Y()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${Y()?"fn__size96":"fn__size200"}">
                        <option value="0" ${n.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${n.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${n.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${Y()?" fn__size96":""}">
                        <option value="all" ${n.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${n.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${n.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${n.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${n.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${n.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${n.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${n.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${Y()?"fn__size96":"fn__size200"}">
                        ${a}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background history__side" ${Y()?"":`style="width: ${n.sideWidth}"`}>
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="history__resize"></div>
                <div class="fn__flex-column fn__flex-1">
                    <div class="protyle-title__input ft__center ft__breakword fn__none"></div>
                    <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                    <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                    <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
                </div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${Y()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(Y())Aw({html:i,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(s){s.firstElementChild.setAttribute("style","background-color:var(--b3-theme-background);height:100%"),mv(t,s.firstElementChild)}});else{const s=new $e({content:i,width:"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Dl=void 0}});s.element.setAttribute("data-key",p.DIALOG_HISTORY),s.element.querySelector("input").focus(),mv(t,s.element,s),ep(s.element.querySelector(".history__resize"),s.element.querySelector(".history__side"),"sideWidth")}},mv=(t,e,n)=>{const a=e.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(u=>{u.addEventListener("change",()=>{jo(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",u=>{u.isComposing||jo(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{jo(a,1)});const i=a.querySelector('.history__text[data-type="docPanel"]'),s=a.querySelector('.history__text[data-type="assetPanel"]'),l=a.querySelector('.history__text[data-type="mdPanel"]'),o=a.querySelector(".protyle-title__input");jo(a,1),Dl=new ba(t,i,{blockId:"",history:{created:""},action:[p.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Sa(Dl.protyle);const r=e.querySelector('#historyContainer [data-type="repo"]'),c=e.querySelector('#historyContainer [data-type="doc"]'),d=r.querySelector(".b3-select");d.addEventListener("change",()=>{Ls(r,1);const u=e.querySelector(".b3-button[data-type='compare']");u.setAttribute("disabled","disabled"),u.removeAttribute("data-ids")}),e.addEventListener("click",u=>{var m;let f=u.target;for(;f&&!f.isEqualNode(e);){const g=f.getAttribute("data-type");if(f.classList.contains("item")){f.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(e.querySelector("#historyContainer").children).forEach(h=>{h.getAttribute("data-type")===g?(h.classList.remove("fn__none"),h.classList.add("fn__block"),f.classList.add("item--focus"),h.getAttribute("data-init")!=="true"&&(g==="notebook"?Lx(h):g==="repo"&&Ls(h,1))):(h.classList.add("fn__none"),h.classList.remove("fn__block"))}),u.stopPropagation(),u.preventDefault();break}else if(f.classList.contains("b3-list-item__action")&&g==="rollback"&&!window.siyuan.config.readonly){const h=f.parentElement.getAttribute("data-type");let b=f.previousElementSibling.previousElementSibling.textContent.trim(),y=Q(parseInt(f.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");h==="notebook"?y=f.parentElement.parentElement.previousElementSibling.textContent.trim():h==="repoitem"&&(b=window.siyuan.languages.workspaceData,y=f.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const w=window.siyuan.languages.rollbackConfirm.replace("${name}",b).replace("${time}",y);Re("\u26A0\uFE0F "+window.siyuan.languages.rollback,w,()=>{h==="assets"?A("/api/history/rollbackAssetsHistory",{historyPath:f.parentElement.getAttribute("data-path")}):h==="doc"?A("/api/history/rollbackDocHistory",{notebook:f.parentElement.getAttribute("data-notebook-id"),historyPath:f.parentElement.getAttribute("data-path")}):h==="notebook"?A("/api/history/rollbackNotebookHistory",{historyPath:f.parentElement.getAttribute("data-path")}):A("/api/repo/checkoutRepo",{id:f.parentElement.getAttribute("data-id")})}),u.stopPropagation(),u.preventDefault();break}else if(g==="more"){f.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(h=>{h.classList.toggle("fn__none")}),u.stopPropagation(),u.preventDefault();break}else if(g==="toggle"){const h=f.firstElementChild.firstElementChild;if(h.classList.contains("b3-list-item__arrow--open"))f.nextElementSibling.classList.add("fn__none"),h.classList.remove("b3-list-item__arrow--open");else if(f.nextElementSibling&&f.nextElementSibling.tagName==="UL")f.nextElementSibling.classList.remove("fn__none"),h.classList.add("b3-list-item__arrow--open");else{const b=a.querySelector(".b3-text-field"),y=a.querySelector('.b3-select[data-type="opselect"]'),w=a.querySelector('.b3-select[data-type="typeselect"]'),E=a.querySelector('.b3-select[data-type="notebookselect"]'),C=f.getAttribute("data-created");A("/api/history/getHistoryItems",{notebook:E.value,query:b.value,op:y.value,type:parseInt(w.value),created:C},$=>{h.classList.add("b3-list-item__arrow--open");let M="",k="";$.data.items.forEach(_=>{let v=" b3-chip b3-chip--list ";_.op==="clean"?(v+="b3-chip--primary ",k=window.siyuan.languages.historyClean):_.op==="update"?(v+="b3-chip--info ",k=window.siyuan.languages.historyUpdate):_.op==="delete"?(v+="b3-chip--error ",k=window.siyuan.languages.historyDelete):_.op==="format"?(v+="b3-chip--pink ",k=window.siyuan.languages.historyFormat):_.op==="sync"?(v+="b3-chip--success ",k=window.siyuan.languages.historySync):_.op==="replace"?(v+="b3-chip--secondary ",k=window.siyuan.languages.historyReplace):_.op==="outline"&&(v+="b3-chip--warning ",k=window.siyuan.languages.historyOutline),M+=`<li data-notebook-id="${_.notebook}" data-created="${C}" data-type="${w.value==="2"?"assets":"doc"}" data-path="${_.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${y.value==="all"?"":"fn__none"}${v}ariaLabel" data-position="6south" aria-label="${k}">${_.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${at(_.title)}">${he(_.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6south" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),f.insertAdjacentHTML("afterend",`<ul>${M}</ul>`)})}u.stopPropagation(),u.preventDefault();break}else if(g==="rmtoggle"){f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),u.stopPropagation(),u.preventDefault();break}else if(f.classList.contains("b3-list-item")&&g==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(d.value)){const h=e.querySelector(".b3-button[data-type='compare']"),b=JSON.parse(h.getAttribute("data-ids")||"[]"),y=f.getAttribute("data-id");if(f.classList.contains("b3-list-item--focus"))f.classList.remove("b3-list-item--focus"),b.forEach((w,E)=>{y===w.id&&b.splice(E,1)});else{for(f.classList.add("b3-list-item--focus");b.length>1;)b[0].id!==y&&((m=f.parentElement.querySelector(`.b3-list-item[data-id="${b.splice(0,1)[0].id}"]`))==null||m.classList.remove("b3-list-item--focus"));b.push({id:y,time:f.querySelector('[data-type="hCreated"]').textContent})}b.length===2?h.removeAttribute("disabled"):h.setAttribute("disabled","disabled"),h.setAttribute("data-ids",JSON.stringify(b)),u.stopPropagation(),u.preventDefault();break}else if(f.classList.contains("b3-list-item")&&(g==="assets"||g==="doc")){const h=f.getAttribute("data-path");if(g==="assets")s.classList.remove("fn__none"),s.innerHTML=Cl(h);else if(g==="doc"){const y=a.querySelector(".b3-text-field").value;A("/api/history/getDocHistoryContent",{historyPath:h,highlight:!ca(),k:y},w=>{w.data.isLargeDoc?(l.value=w.data.content,l.classList.remove("fn__none"),i.classList.add("fn__none")):(l.classList.add("fn__none"),i.classList.remove("fn__none"),Dl.protyle.options.history.created=f.dataset.created,kt({data:w,protyle:Dl.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]}),Ac(Dl.protyle,y.split(" ")))})}o.classList.remove("fn__none"),o.textContent=f.querySelector(".b3-list-item__text").textContent;let b=T(f,"b3-list");b&&(b=b.querySelector(".b3-list-item--focus"),b&&b.classList.remove("b3-list-item--focus")),f.classList.add("b3-list-item--focus"),u.stopPropagation(),u.preventDefault();break}else if(g==="genRepo"){const h=new $e({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});h.element.setAttribute("data-key",p.DIALOG_SNAPSHOTMEMO);const b=h.element.querySelector("textarea");b.focus();const y=h.element.querySelectorAll(".b3-button");h.bindInput(b,()=>{y[1].click()}),y[0].addEventListener("click",()=>{h.destroy()}),y[1].addEventListener("click",()=>{A("/api/repo/createSnapshot",{memo:b.value},()=>{Ls(r,1)}),h.destroy()}),u.stopPropagation(),u.preventDefault();break}else if(g==="removeRepoTagSnapshot"||g==="removeCloudRepoTagSnapshot"){const h=f.parentElement.getAttribute("data-tag");Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${h}</i>?`,()=>{A("/api/repo/"+g,{tag:h},()=>{Ls(r,1)})},void 0,!0),u.stopPropagation(),u.preventDefault();break}else if(g==="uploadSnapshot"){A("/api/repo/uploadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),u.stopPropagation(),u.preventDefault();break}else if(g==="downloadSnapshot"){A("/api/repo/downloadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),u.stopPropagation(),u.preventDefault();break}else if(g==="genTag"){const h=new $e({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${Q().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:Y()?"92vw":"520px"});h.element.setAttribute("data-key",p.DIALOG_SNAPSHOTTAG);const b=h.element.querySelector(".b3-text-field");b.select();const y=h.element.querySelectorAll(".b3-button");y[0].addEventListener("click",()=>{h.destroy()}),y[2].addEventListener("click",()=>{A("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:b.value},()=>{A("/api/repo/uploadCloudSnapshot",{tag:b.value,id:f.parentElement.getAttribute("data-id")},()=>{Ls(r,1)})}),h.destroy()}),y[1].addEventListener("click",()=>{A("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:b.value},()=>{Ls(r,1)}),h.destroy()}),u.stopPropagation(),u.preventDefault();break}else if((g==="previous"||g==="next")&&f.getAttribute("disabled")!=="disabled"){const h=parseInt(r.getAttribute("data-page"));Ls(r,g==="previous"?h-1:h+1),u.stopPropagation(),u.preventDefault();break}else if(g==="jumpRepoPage"){const h=parseInt(r.getAttribute("data-page")),b=parseInt(f.getAttribute("data-totalpage")||"1");b>1&&Re(window.siyuan.languages.jumpToPage.replace("${x}",b),`<input class="b3-text-field fn__block" type="number" min="1" max="${b}" value="${h}">`,y=>{const w=y.element.querySelector(".b3-text-field");if(w.value==="")return;let E=parseInt(w.value);E=Math.max(1,Math.min(E,b)),Ls(r,E)})}else if(g==="jumpHistoryPage"){const h=parseInt(c.getAttribute("data-page")),b=parseInt(f.getAttribute("data-totalpage")||"1");b>1&&Re(window.siyuan.languages.jumpToPage.replace("${x}",b),`<input class="b3-text-field fn__block" type="number" min="1" max="${b}" value="${h}">`,y=>{const w=y.element.querySelector(".b3-text-field");if(w.value==="")return;let E=parseInt(w.value);E=Math.max(1,Math.min(E,b)),jo(a,E)})}else if((g==="docprevious"||g==="docnext")&&f.getAttribute("disabled")!=="disabled"){const h=parseInt(a.getAttribute("data-page"));jo(a,g==="docprevious"?h-1:h+1),u.stopPropagation(),u.preventDefault();break}else if(g==="rebuildIndex"){A("/api/history/reindexHistory"),n?n.destroy():(Nx(),Dl=void 0),u.stopPropagation(),u.preventDefault();break}else if(g==="compare"&&!f.getAttribute("disabled")){Sx(t,JSON.parse(f.getAttribute("data-ids")||"[]")),u.stopPropagation(),u.preventDefault();break}f=f.parentElement}})},_D=t=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.classList.remove("fn__none"),e.innerHTML===""&&(e.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${isIPhone()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.id==="emptySearch"){popSearch(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){getRecentDocs(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){openHistory(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){newFile({app:t,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){newNotebook(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){mountHelp(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},Ax=()=>{const t=document.getElementById("toolbarName");gd(t.value),t.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},gp=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,xx=(t,e,n=[p.CB_GET_HL])=>{window.siyuan.storage[p.LOCAL_DOCINFO]={id:e},Ee(p.LOCAL_DOCINFO,window.siyuan.storage[p.LOCAL_DOCINFO]);const a=document.querySelector(".av__panel");if(a&&!a.classList.contains("fn__none")&&a.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){xc(window.siyuan.mobile.editor.protyle),ce(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&ql(window.siyuan.mobile.editor.protyle,"wysiwyg");let i;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!G(s))return i=s,!0}),i){Dh(),n.includes(p.CB_GET_HL)?yc(window.siyuan.mobile.editor.protyle,e):Ye(window.siyuan.mobile.editor.protyle,i),vv(),A("/api/storage/updateRecentDocViewTime",{rootID:window.siyuan.mobile.editor.protyle.block.rootID});return}}A("/api/block/getBlockInfo",{id:e},i=>{if(i.code===3){de(i.msg);return}const s={blockId:e,rootId:i.data.rootID,action:n,render:{scroll:!0,title:!0,titleShowTop:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu","yuque"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),Dh(),Rl(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==i.data.rootID?(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML="",A("/api/storage/updateRecentDocOpenTime",{rootID:i.data.rootID})):A("/api/storage/updateRecentDocViewTime",{rootID:i.data.rootID}),n.includes(p.CB_GET_SCROLL)&&window.siyuan.storage[p.LOCAL_FILEPOSITION][i.data.rootID]?ch({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[p.LOCAL_FILEPOSITION][i.data.rootID],mergedOptions:s,cb(){t.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):A("/api/filetree/getDoc",{id:e,size:n.includes(p.CB_GET_ALL)?p.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(p.CB_GET_CONTEXT)?3:0},l=>{kt({data:l,protyle:window.siyuan.mobile.editor.protyle,action:n,afterCB(){t.plugins.forEach(o=>{o.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):(A("/api/storage/updateRecentDocOpenTime",{rootID:i.data.rootID}),window.siyuan.mobile.editor=new ba(t,document.getElementById("editor"),s)),Ax(),vv()})};class Il{constructor(e,n){this.element=document.createElement("button");const a=n.hotkey?` ${pe(n.hotkey)}`:"",i=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",i+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(bc(),s=>{s.preventDefault(),p.INLINE_TYPE.includes(n.name)?e.toolbar.setInlineMark(e,n.name,"toolbar"):n.click&&n.click(e.getInstance())})}}class Cx extends Il{constructor(e,n){super(e,n),this.element.addEventListener("click",()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Lh(e,bv(e))),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0,ne(e.toolbar.range);const a=Ca(e.wysiwyg.element,e.toolbar.range);Te(e.toolbar.subElement,a.left,a.top+18,26)})}}const Lh=(t,e)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(f=>{n+=`<button ${f?`class="color__square" style="color:${f}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="color">A</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(f=>{a+=`<button ${f?`class="color__square" style="background-color:${f}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="backgroundColor"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;e==null||e.find(f=>{if(f.classList.contains("li"))return s=!0,!0});let l="";const o=window.siyuan.storage[p.LOCAL_FONTSTYLES];o.length>0&&(l=`<div data-id="lastUsed" class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="fn__kbd fn__flex-center${window.siyuan.config.keymap.editor.insert.lastUsed.custom?"":" fn__none"}">${pe(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div data-id="lastUsedWrap" class="fn__flex fn__flex-wrap" style="align-items: center">`,o.forEach(f=>{const g=f.split(p.ZWSP);switch(g[0]){case"color":l+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorFont}${g[1]?"":" "+window.siyuan.languages.default}" ${g[1]?`style="color:${g[1]}"`:""} data-type="${g[0]}">A</button>`;break;case"backgroundColor":l+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorPrimary}${g[1]?"":" "+window.siyuan.languages.default}" ${g[1]?`style="background-color:${g[1]}"`:""} data-type="${g[0]}"></button>`;break;case"style2":l+=`<button data-type="${g[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":l+=`<button data-type="${g[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(l+=`<button data-type="${g[0]}" class="protyle-font__style">${g[1]}</button>`);break;case"style1":l+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.color}${g[1]?"":" "+window.siyuan.languages.default}" ${g[1]?`style="background-color:${g[1]};color:${g[2]}"`:""} data-type="${g[0]}">A</button>`;break;case"clear":l+=`<button style="height: 26px;display: flex;align-items: center;padding: 0 5px;" data-type="${g[0]}" class="protyle-font__style ariaLabel" aria-label="${window.siyuan.languages.clearFontStyle}"><svg class="svg--mid"><use xlink:href="#iconTrashcan"></use></svg></button>`;break}}),l+="</div>");let r,c=window.siyuan.config.editor.fontSize+"px";e&&e.length>0?r=e[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=j(t.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||window.siyuan.config.editor.fontSize+"px"),i.innerHTML=`${l}
<div class="fn__hr"></div>
<div data-id="color">${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div data-id="colorWrap" class="fn__flex fn__flex-wrap">
    <button class="color__square ariaLabel" data-position="3south" data-type="style1" aria-label="${window.siyuan.languages.default}">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div data-id="colorFont">${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div data-id="colorFontWrap" class="fn__flex fn__flex-wrap">
    ${n}
</div>
<div class="fn__hr"></div>
<div data-id="colorPrimary">${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div data-id="colorPrimaryWrap" class="fn__flex fn__flex-wrap">
    ${a}
</div>
<div class="fn__hr"></div>
<div data-id="fontStyle">${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div data-id="fontStyleWrap" class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div data-id="fontSize" class="fn__flex${s?" fn__none":""}">
    ${window.siyuan.languages.fontSize}
    <span class="fn__flex-1"></span>
    <label class="fn__flex">
        ${window.siyuan.languages.relativeFontSize}
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" ${c.endsWith("em")?"checked":""} type="checkbox">
        <span class="fn__space--small"></span>
    </label>
</div>
<div data-id="fontSizeWrap" class="${s?" fn__none":""}">
    <div class="fn__hr"></div>
    <div class="b3-tooltips b3-tooltips__n fn__flex${c.endsWith("em")?" fn__none":""}" aria-label="${c}">   
        <input class="b3-slider fn__block" id="fontSizePX" max="72" min="9" step="1" type="range" value="${parseInt(c)}">
    </div>
    <div class="b3-tooltips b3-tooltips__n fn__flex${c.endsWith("em")?"":" fn__none"}" aria-label="${parseFloat(c)*100}%">   
        <input class="b3-slider fn__block" id="fontSizeEM" max="4.5" min="0.56" step="0.01" type="range" value="${parseFloat(c)}">
    </div>
</div>
<div class="fn__hr--b"></div>
<div data-id="clearFontStyle" class="fn__flex">
    <div class="fn__space--small"></div>
    <button class="b3-button b3-button--remove fn__block" data-type="clear">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
    </button>
    <div class="fn__space--small"></div>
</div>`,i.addEventListener("click",function(f){let g=f.target;for(;g&&!g.isEqualNode(i);){const h=g.getAttribute("data-type");if(g.tagName==="BUTTON"){h==="style1"?ii(t,e,h,g.style.backgroundColor+p.ZWSP+g.style.color):h==="fontSize"?ii(t,e,h,g.textContent.trim()):h==="backgroundColor"?ii(t,e,h,g.style.backgroundColor):h==="color"?ii(t,e,h,g.style.color):ii(t,e,h);break}g=g.parentElement}});const d=i.querySelector(".b3-switch"),u=i.querySelector("#fontSizePX"),m=i.querySelector("#fontSizeEM");return d.addEventListener("change",function(){if(d.checked){const f=parseFloat((parseInt(u.value)/16).toFixed(2));m.parentElement.setAttribute("aria-label",(f*100).toString()+"%"),m.value=f.toString(),u.parentElement.classList.add("fn__none"),m.parentElement.classList.remove("fn__none"),ii(t,e,"fontSize",m.value+"em")}else{const f=Math.round(parseFloat(m.value)*16);u.parentElement.setAttribute("aria-label",f+"px"),u.value=f.toString(),u.parentElement.classList.remove("fn__none"),m.parentElement.classList.add("fn__none"),ii(t,e,"fontSize",u.value+"px")}}),u.addEventListener("change",function(){ii(t,e,"fontSize",u.value+"px")}),m.addEventListener("change",function(){ii(t,e,"fontSize",m.value+"em")}),u.addEventListener("input",function(){u.parentElement.setAttribute("aria-label",u.value+"px")}),m.addEventListener("input",function(){m.parentElement.setAttribute("aria-label",(parseFloat(m.value)*100).toFixed(0)+"%")}),i},ii=(t,e,n,a)=>{let i=window.siyuan.storage[p.LOCAL_FONTSTYLES];if(n)i.splice(0,0,`${n}${p.ZWSP}${a}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[p.LOCAL_FONTSTYLES]=i,Ee(p.LOCAL_FONTSTYLES,window.siyuan.storage[p.LOCAL_FONTSTYLES]);else if(i.length===0)n="style1",a="var(--b3-card-error-color)"+p.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(p.ZWSP);n=s.splice(0,1)[0],a=s.join(p.ZWSP)}e&&e.length>0?(Ds(e,t,s=>{if(n==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="",s.style.removeProperty("--b3-parent-background");else if(n==="style1"){const l=a.split(p.ZWSP);s.style.backgroundColor=l[0],s.style.color=l[1],s.style.setProperty("--b3-parent-background",l[0])}else n==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):n==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?s.style.color=a:n==="backgroundColor"?(s.style.backgroundColor=a,s.style.setProperty("--b3-parent-background",a)):n==="fontSize"&&(s.style.fontSize=a);(n==="fontSize"||n==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&or(s.querySelector(".hljs"))}),ne(t.toolbar.range)):n==="clear"?t.toolbar.setInlineMark(t,"clear","range",{type:"text"}):t.toolbar.setInlineMark(t,"text","range",{type:n,color:a})},Ah=(t,e)=>{const n=s=>{const l=s.split(p.ZWSP),o=l.splice(0,1)[0];t.setAttribute("data-id",o),t.setAttribute("data-subtype",l.splice(0,1)[0]),t.removeAttribute("data-href");let r=l.join("");r.replace(/\s/g,"")===""&&(r=o),t.innerText=r},a=s=>{const l=s.split(p.ZWSP);t.setAttribute("data-href",l[0]),t.removeAttribute("data-subtype"),t.removeAttribute("data-id"),l[1]&&(t.textContent=l[1])},i=s=>{const l=s.split(p.ZWSP);t.setAttribute("data-id",l[0]),t.removeAttribute("data-href"),t.removeAttribute("data-subtype"),l[1]&&(t.textContent=l[1])};if(e){switch(e.type){case"color":t.style.color=e.color;break;case"fontSize":t.style.fontSize=e.color;break;case"backgroundColor":t.style.backgroundColor=e.color;break;case"style1":t.style.backgroundColor=e.color.split(p.ZWSP)[0],t.style.color=e.color.split(p.ZWSP)[1];break;case"style2":t.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",t.style.webkitTextFillColor="transparent";break;case"style4":t.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(e.color);break;case"inline-math":t.className="render-node",t.setAttribute("contenteditable","false"),t.setAttribute("data-subtype","math"),t.setAttribute("data-content",t.textContent.replace(p.ZWSP,"")),t.removeAttribute("data-render"),t.textContent="";break;case"a":a(e.color);break;case"file-annotation-ref":i(e.color);break;case"inline-memo":t.removeAttribute("contenteditable"),t.removeAttribute("data-content");break}t.getAttribute("style")||t.removeAttribute("style")}},hv=(t,e,n)=>{if(!n&&t){const a=e.getAttribute("data-type").split(" ");return a.includes("inline-math")||a.includes("inline-memo")||a.includes("a")||a.includes("block-ref")&&(t.getAttribute("data-id")!==e.getAttribute("data-id")||t.getAttribute("data-subtype")!==e.getAttribute("data-subtype")||t.textContent!==e.textContent)||a.includes("file-annotation-ref")&&(t.getAttribute("data-id")!==e.getAttribute("data-id")||t.textContent!==e.textContent)?!1:e.style.color===t.style.color&&e.style.webkitTextFillColor===t.style.webkitTextFillColor&&e.style.webkitTextStroke===t.style.webkitTextStroke&&e.style.textShadow===t.style.textShadow&&e.style.backgroundColor===t.style.backgroundColor&&e.style.fontSize===t.style.fontSize}if(n){if(n.type==="text")return!e.style.color&&!e.style.webkitTextFillColor&&!e.style.webkitTextStroke&&!e.style.textShadow&&!e.style.fontSize&&!e.style.backgroundColor;if(n.type==="color")return n.color===e.style.color;if(n.type==="backgroundColor")return n.color===e.style.backgroundColor;if(n.type==="style1")return n.color.split(p.ZWSP)[0]===e.style.color&&n.color.split(p.ZWSP)[1]===e.style.backgroundColor;if(n.type==="style2")return e.style.webkitTextFillColor==="transparent"&&e.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)";if(n.type==="style4")return e.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";if(n.type==="fontSize")return n.color===e.style.fontSize}return!1},bv=t=>{let e;if(t.toolbar.range.toString()===""&&(e=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0)){const n=B(t.toolbar.range.startContainer);n&&(e=[n])}return e},Tx=(t,e,n)=>{var a,i,s;if(T(t,"protyle-wysiwyg__embed"))return;const l=An(t);if(!l&&t.classList.contains("protyle-wysiwyg--select")){Yt(fe(t),e,!1),e.collapse(!1),ce(["select"],n);return}if((a=n.observerLoad)==null||a.disconnect(),l||t.classList.contains("table")){t.classList.contains("protyle-wysiwyg--select")&&t.classList.contains("render-node")?n.toolbar.showRender(n,t):Gn(n,"afterend");return}const o=fe(t);if(o.querySelectorAll(".img--select").forEach(_=>{_.classList.remove("img--select")}),t.getAttribute("data-type")==="NodeAttributeView")return!0;const r=o.innerHTML.trimStart(),c=o.textContent.trimStart();if((r.startsWith("```")||r.startsWith("\xB7\xB7\xB7")||r.startsWith("~~~")||r.indexOf("\n```")>-1&&c.indexOf("\n```")>-1||r.indexOf(`
~~~`)>-1&&c.indexOf(`
~~~`)>-1||r.indexOf(`
\xB7\xB7\xB7`)>-1&&c.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(r.indexOf(`
`)===-1&&r.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(t.classList.contains("p")){const _=t.outerHTML;let v=o.innerHTML.replace(/\n(~||`){3,}/g,"\n```").trim().replace(/^(~||`){3,}/g,"```");v.endsWith("\n```")||(v+="<wbr>\n```"),o.innerHTML=v,t.outerHTML=n.lute.SpinBlockDOM(t.outerHTML),t=n.wysiwyg.element.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);const S=t.querySelector(".protyle-action__language");return S?(window.siyuan.storage[p.LOCAL_CODELANG]&&S.textContent===""?S.textContent=window.siyuan.storage[p.LOCAL_CODELANG]:p.SIYUAN_RENDER_CODE_LANGUAGES.includes(S.textContent)||(window.siyuan.storage[p.LOCAL_CODELANG]=S.textContent,Ee(p.LOCAL_CODELANG,window.siyuan.storage[p.LOCAL_CODELANG])),p.SIYUAN_RENDER_CODE_LANGUAGES.includes(S.textContent)?(t.dataset.content="",t.dataset.subtype=S.textContent,t.className="render-node",t.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,n.toolbar.showRender(n,t),Ct(t)):rt(t)):(n.toolbar.showRender(n,t),Ct(t)),le(n,t.getAttribute("data-node-id"),t.outerHTML,_),!0}}if(t.getAttribute("data-type")==="NodeCodeBlock"){const _=document.createElement("wbr");e.insertNode(_);const v=t.outerHTML;return _.remove(),e.extractContents(),o.textContent.endsWith(`
`)||o.insertAdjacentText("beforeend",`
`),e.insertNode(document.createTextNode(`
`)),e.collapse(!1),e.insertNode(_),o.parentElement.removeAttribute("data-render"),rt(t),le(n,t.getAttribute("data-node-id"),t.outerHTML,v),Ye(n),!0}if(o.textContent.replace(p.ZWSP,"").replace(`
`,"")===""&&t.nextElementSibling&&t.nextElementSibling.classList.contains("protyle-attr")&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){e.insertNode(document.createElement("wbr"));const _=ys(t),v=t.getAttribute("data-node-id"),S=_.getAttribute("data-node-id"),L={action:"insert",id:v,data:t.outerHTML},D={action:"insert",id:S,data:_.outerHTML};return S===v?(L.previousID=t.parentElement.getAttribute("data-node-id"),D.previousID=t.previousElementSibling.getAttribute("data-node-id"),t.parentElement.after(t)):(L.previousID=_.previousElementSibling?_.previousElementSibling.getAttribute("data-node-id"):void 0,L.parentID=_.parentElement.getAttribute("data-node-id")||n.block.parentID,D.previousID=L.previousID,D.parentID=L.parentID,_.after(t),_.remove()),V(n,[{action:"delete",id:S},L],[{action:"delete",id:v},D]),S===v&&t.parentElement.classList.contains("sb")&&t.parentElement.getAttribute("data-sb-layout")==="col"&&ga({protyle:n,selectsElement:[t.previousElementSibling,t],type:"BlocksMergeSuperBlock",level:"row"}),we(t,e),!0}const d=_t(o,n.wysiwyg.element,e);if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&(t.nextElementSibling.classList.contains("protyle-attr")||t.nextElementSibling.classList.contains("list")&&((i=t.previousElementSibling)!=null&&i.classList.contains("protyle-action"))||d.start===0&&t.previousElementSibling.classList.contains("protyle-action")||t.parentElement.getAttribute("fold")==="1")&&Dx(n,t,e))return!0;if(o.textContent!==""&&e.toString()===""&&d.start===0){let _;t.previousElementSibling&&t.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&t.previousElementSibling.getAttribute("fold")==="1"?_=Fc(t.previousElementSibling,!1,!0):_=jn(!1,!0);const v=_.getAttribute("data-node-id");return V(n,[{action:"insert",data:_.outerHTML,id:v,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):"",parentID:t.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:v}]),_.querySelector("wbr").remove(),t.insertAdjacentElement("beforebegin",_),mp(_),!0}e.insertNode(document.createElement("wbr"));const u=t.outerHTML;if(e.toString()!==""){const _=j(e.startContainer,"data-type","inline-math");if(_){const v=Ge(_);return v&&(e=getSelection().getRangeAt(0),e.setEnd(v,v.textContent.startsWith(p.ZWSP)?1:0),e.collapse(!1)),(s=_.querySelector("wbr"))==null||s.remove(),!0}e.extractContents(),e.insertNode(document.createElement("wbr"))}o.lastChild&&e.setEndAfter(o.lastChild);const m=t.getAttribute("data-node-id"),f=document.createElement("div");t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"?f.innerHTML=Fc(t,!0):f.appendChild(jn(!1,!1));const g=f.querySelector('[contenteditable="true"]');g.appendChild(e.extractContents());const h=g.querySelector("wbr");h&&h.parentElement.tagName==="SPAN"&&h.parentElement.innerHTML==="<wbr>"&&(h.parentElement.outerHTML="<wbr>");const b=g.innerHTML.trimStart(),y=g.textContent.trimStart();if((b.startsWith("```")||b.startsWith("\xB7\xB7\xB7")||b.startsWith("~~~")||b.indexOf("\n```")>-1&&y.indexOf("\n```")>-1||b.indexOf(`
~~~`)>-1&&y.indexOf(`
~~~`)>-1||b.indexOf(`
\xB7\xB7\xB7`)>-1&&y.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(b.indexOf(`
`)===-1&&b.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let _=g.innerHTML.replace(/\n(~||`){3,}/g,"\n```").trim().replace(/^(~||`){3,}/g,"```");_.endsWith("\n```")||(_+="\n```"),g.innerHTML=_}f.innerHTML=n.lute.SpinBlockDOM(f.innerHTML);const w=document.createElement("div");w.innerHTML=n.lute.SpinBlockDOM(o.parentElement.outerHTML);const E=[],C=[];let $=t;const M=[];Array.from(w.children).forEach(_=>{_.dataset.nodeId===m?(t.before(_),t.remove(),E.push({action:"update",data:_.outerHTML,id:m}),C.push({action:"update",data:u,id:m})):(E.push({action:"insert",data:_.outerHTML,id:_.dataset.nodeId,nextID:m}),$.insertAdjacentElement("afterend",_),C.push({action:"delete",id:_.dataset.nodeId})),_.dataset.type==="NodeBlockQueryEmbed"?We(n,_):Nn(_),$=_,M.push(_)}),Array.from(f.children).forEach(_=>{const v=_.getAttribute("data-node-id");E.push({action:"insert",data:_.outerHTML,id:v,previousID:$.getAttribute("data-node-id")}),C.push({action:"delete",id:v}),$.insertAdjacentElement("afterend",_),_.classList.contains("code-block")?rt(_):_.dataset.type==="NodeBlockQueryEmbed"?We(n,_):Nn($.nextElementSibling),$=_,M.push(_)});const k=$.parentElement;return V(n,E,C),k.classList.contains("sb")&&k.getAttribute("data-sb-layout")==="col"&&ga({protyle:n,selectsElement:M,type:"BlocksMergeSuperBlock",level:"row"}),we($,e),Ye(n),!0},Dx=(t,e,n)=>{var a,i;const s=e.parentElement,l=fe(e);if(["",`
`].includes(l.textContent)&&e.previousElementSibling.classList.contains("protyle-action")&&!e.querySelector("img")){if((a=s.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return qc(t,[e.parentElement],n),!0;if(!s.parentElement.classList.contains("protyle-wysiwyg"))return Gx(t,e,n),!0}const o=_t(l,t.wysiwyg.element,n);if(n.toString()===""&&o.start===0&&!pt(n.startContainer)){if(s.parentElement.classList.contains("protyle-wysiwyg"))return!0;const g=document.createElement("wbr");n.insertNode(g);const h=s.parentElement.outerHTML;g.remove();let b=Hl(s,-1,!0);if(e.previousElementSibling.classList.contains("protyle-action"))fe(e).textContent===""?s.insertAdjacentElement("afterend",b):s.insertAdjacentElement("beforebegin",b);else{if(fe(e).textContent!=="")return!1;e.remove(),b=Hl(s,-1,!0),s.insertAdjacentElement("afterend",b)}return s.getAttribute("data-subtype")==="o"&&Tt(s.parentElement),le(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,h),we(b,n),Ye(t),mp(b),!0}const r=s.querySelector(".list");let c;if(r&&s.getAttribute("fold")!=="1"&&e.nextElementSibling===r){if(o.end>=l.textContent.length-(l.textContent.endsWith(p.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const g=s.outerHTML;e.querySelector("wbr").remove(),c=Hl(r.firstElementChild,-1,!0),r.firstElementChild.before(c),r.getAttribute("data-subtype")==="o"&&Tt(r),le(t,s.getAttribute("data-node-id"),s.outerHTML,g),we(s,n),Ye(t)}else{n.insertNode(document.createElement("wbr"));const g=s.outerHTML,h=s.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(l.lastChild),c=Hl(s,0,!1);const b=fe(c);b.appendChild(n.extractContents());const y=b.querySelector("wbr");y&&y.parentElement.tagName==="SPAN"&&y.parentElement.innerHTML==="<wbr>"&&(y.parentElement.outerHTML="<wbr>");let w=r.nextElementSibling;for(c.lastElementChild.before(r);!w.classList.contains("protyle-attr");)w=w.nextElementSibling,c.lastElementChild.before(w.previousElementSibling);s.insertAdjacentElement("afterend",c),s.getAttribute("data-subtype")==="o"&&Tt(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?V(t,[{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",data:g,id:s.getAttribute("data-node-id")}]):le(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,h),we(c,n),Ye(t)}return mp(c),!0}if((n.toString()===""||n.toString()===p.ZWSP)&&n.startContainer.nodeType===3&&n.startOffset===0){let g=n.startContainer;for(;g;)if(g.textContent===p.ZWSP){n.setStart(g,1),n.collapse(!1);break}else g=g.nextSibling}n.insertNode(document.createElement("wbr"));const d=s.outerHTML,u=s.parentElement.outerHTML;if(n.toString()!==""){const g=j(n.startContainer,"data-type","inline-math");if(g){const h=Ge(g);return h&&(n=getSelection().getRangeAt(0),n.setEnd(h,h.textContent.startsWith(p.ZWSP)?1:0),n.collapse(!1)),(i=g.querySelector("wbr"))==null||i.remove(),!0}n.extractContents(),n.insertNode(document.createElement("wbr"))}l.lastChild&&n.setEndAfter(l.lastChild),c=Hl(s,0,!1);const m=fe(c);m.appendChild(n.extractContents());const f=m.querySelector("wbr");return f&&f.parentElement.tagName==="SPAN"&&f.parentElement.innerHTML==="<wbr>"&&(f.parentElement.outerHTML="<wbr>"),m.parentElement.outerHTML=t.lute.SpinBlockDOM(m.parentElement.outerHTML),s.insertAdjacentElement("afterend",c),We(t,c),Nn(c),Ct(c),l.parentElement.outerHTML=t.lute.SpinBlockDOM(l.parentElement.outerHTML),We(t,s),Nn(s),Ct(s),s.getAttribute("data-subtype")==="o"&&Tt(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?V(t,[{action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",id:s.getAttribute("data-node-id"),data:d}]):le(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,u),we(c,n),Ye(t),mp(c),!0},mp=t=>{const e=fe(t).childNodes;for(let n=0;n<e.length;n++)e[n].nodeType===3&&e[n].textContent.length===0&&(e[n].remove(),n--)},Ix=(t,e,n)=>{let a=t.startContainer;const i=Ge(a);if(e.getAttribute("data-type")==="NodeAttributeView")return!0;if(i&&i.nodeType!==3&&_t(t.startContainer,n.wysiwyg.element,t).end===t.endContainer.textContent.length&&(i.classList.contains("img")||i.getAttribute("data-type")==="inline-math")){i.insertAdjacentHTML("beforebegin","<wbr>");const l=e.outerHTML;i.previousElementSibling.remove();const o=document.createTextNode(`
`);return a.after(document.createTextNode(p.ZWSP)),a.after(o),t.selectNode(o),t.collapse(!1),le(n,e.getAttribute("data-node-id"),e.outerHTML,l),!0}if(a.nodeType===3&&(a=a.parentElement),a&&n.toolbar.getCurrentType(t).length>0&&_t(a,a,t).end===a.textContent.length)return yv(t,e,n,a),!0;if(Ha()||Y()){a=t.startContainer;const s=Ge(a);return s&&s.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(yv(t,e,n,a),!0)}return!1},yv=(t,e,n,a)=>{const i=document.createElement("wbr");a.nodeType===3?t.insertNode(i):a.insertAdjacentElement("afterend",i);const s=e.outerHTML;i.remove();let l;Ge(a)||(l=document.createTextNode(`
`),a.after(l));const o=document.createTextNode(`
`);a.after(o),l?t.setStart(l,0):t.setStart(o,1),t.collapse(!0),ne(t),le(n,e.getAttribute("data-node-id"),e.outerHTML,s)};let _v,Bc=!1;const Ze=(t,e,n,a="false")=>{let i;return e&&e.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${e}"></use></svg>`:i=e,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(t)}">
    ${i}
    <span class="keyboard__slash-text">${n}</span>
</button>`},wv=(t,e)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((u,m)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" ${u?`style="color:${u}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${u?m+1:window.siyuan.languages.default}</span>
</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((u,m)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" ${u?`style="background-color:${u}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${u?m+1:window.siyuan.languages.default}</span>
</button>`});const i=bv(t);let s=!1;i==null||i.find(u=>{if(u.classList.contains("li"))return s=!0,!0});let l="";const o=window.siyuan.storage[p.LOCAL_FONTSTYLES];o.length>0&&(l=`<div data-id="lastUsed" class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div data-id="lastUsedWrap" class="keyboard__slash-block">`,o.forEach(u=>{const m=u.split(p.ZWSP);switch(m[0]){case"color":l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" ${m[1]?`style="color:${m[1]}"`:""} >A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${m[1]?parseInt(m[1].replace("var(--b3-font-color",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"backgroundColor":l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" ${m[1]?`style="background-color:${m[1]}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${m[1]?parseInt(m[1].replace("var(--b3-font-background",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"style2":l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text">${m[1]}</span>
</button>`);break;case"style1":m[1]?l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" style="background-color:${m[1]};color:${m[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[m[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`:l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
</button>`;break;case"clear":l+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),l+="</div>");let r,c="16px";i&&i.length>0?r=i[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=j(t.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const d=e.querySelector(".keyboard__util");d.innerHTML=`${l}
<div data-id="color" class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div data-id="colorWrap" class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div data-id="colorFont" class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div data-id="colorFontWrap" class="keyboard__slash-block">
    ${n}
</div>
<div data-id="colorPrimary" class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div data-id="colorPrimaryWrap" class="keyboard__slash-block">
    ${a}
</div>
<div data-id="fontStyle" class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div data-id="fontStyleWrap" class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div data-id="fontSize" class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div data-id="fontSizeWrap" class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,d.querySelector("select").addEventListener("change",function(u){ii(t,i,"fontSize",u.target.value)})},$x=(t,e)=>{t.hint.splitChar="/",t.hint.lastIndex=-1;let n="";t.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n+=Ze(`plugin${Constants.ZWSP}${i.name}${Constants.ZWSP}${s.id}`,"",s.html,"true")})}),n&&(n=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${n}</div>`);const a=e.querySelector(".keyboard__util");a.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ze(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${Ze(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${Ze(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${Ze("((","iconRef",window.siyuan.languages.ref,"true")}
    ${Ze("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${Ze(Constants.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${Ze('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${Ze(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ze(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true")}
    ${isInAndroid()?Ze(Constants.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true"):""}
    ${Ze('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${Ze("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${Ze('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${Ze('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${Ze("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ze("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${Ze("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${Ze("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${Ze("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${Ze("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${Ze("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${Ze("- "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${Ze("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${Ze("- [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${Ze("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${Ze("```","iconCode",window.siyuan.languages.code,"true")}
    ${Ze(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${Ze("---","iconLine",window.siyuan.languages.line,"true")}
    ${Ze("$$","iconMath",window.siyuan.languages.math)}
    ${Ze("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ze("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${Ze("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${Ze("```flowchart\n```","","Flow Chart","true")}
    ${Ze("```graphviz\n```","","Graph","true")}
    ${Ze("```mermaid\n```","","Mermaid","true")}
    ${Ze("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${Ze("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ze(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${Ze(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${Ze(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${Ze(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${Ze(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${n}`,t.hint.bindUploadEvent(t,a)},xh=t=>{window.siyuan.menus.menu.remove(),Bc=!0;const e=document.getElementById("keyboardToolbar");let n=e.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const a=gp();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=t),setTimeout(()=>{e.style.height=n},p.TIMEOUT_TRANSITION),setTimeout(()=>{Bc=!1},1e3)},Rc=()=>{const t=document.getElementById("keyboardToolbar");t.style.height="";const e=getCurrentEditor();e&&(e.protyle.element.parentElement.style.paddingBottom="42px"),t.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},Mx=()=>{clearTimeout(_v),_v=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){Ch();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){Ch();return}Bc||Rc(),Px();const t=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),e=getSelection().getRangeAt(0);if(!hasClosestByClassName(e.startContainer,"protyle-wysiwyg",!0)){t[0].classList.add("fn__none"),t[1].classList.add("fn__none");return}e.toString()||t[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(t[0].classList.add("fn__none"),t[1].classList.remove("fn__none")):(t[0].classList.remove("fn__none"),t[1].classList.add("fn__none"));const i=getCurrentEditor().protyle;if(i.toolbar.range=e,!t[0].classList.contains("fn__none")){i.undo.undoStack.length===0?t[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?t[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=hasClosestBlock(e.startContainer);if(s){const l=t[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(l.classList.remove("fn__none"),l.nextElementSibling.classList.remove("fn__none")):(l.classList.add("fn__none"),l.nextElementSibling.classList.add("fn__none"))}}t[1].classList.contains("fn__none")||(t[1].querySelectorAll(".protyle-toolbar__item--current").forEach(l=>{l.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(e).forEach(l=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(l))return;const o=t[1].querySelector(`[data-type="${l}"]`);o&&o.classList.add("protyle-toolbar__item--current")}))},620)},Px=()=>{Bc||Rc();const t=document.getElementById("keyboardToolbar");if(!t.classList.contains("fn__none"))return;t.classList.remove("fn__none"),t.style.zIndex=(++window.siyuan.zIndex).toString();const e=document.getElementById("model");e.style.transform==="translateY(0px)"&&(e.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=getCurrentEditor();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(i=>{i.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const i=hasClosestByClassName(n.startContainer,"protyle-content",!0);if(i){const s=i.getBoundingClientRect().top,l=getSelectionPosition(i).top;if(l<window.innerHeight-42&&l>s)return;i.scroll({top:i.scrollTop+l-window.innerHeight+42+26,left:i.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},Ch=()=>{if(Bc)return;const t=document.getElementById("keyboardToolbar");if(t.classList.contains("fn__none"))return;t.classList.add("fn__none"),t.style.height="";const e=gp();e&&(e.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),gp().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-hide")})},hp=()=>{window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard(),Ch(),document.activeElement.blur()},wD=()=>{let t=!1;document.addEventListener("selectionchange",()=>{t||Mx()},!1);const e=document.getElementById("keyboardToolbar");e.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`;let n=0,a=0,i=!1;e.addEventListener("touchstart",s=>{n=s.touches[0].clientY,a=s.touches[0].clientX,i=!1}),e.addEventListener("touchmove",s=>{(Math.abs(s.touches[0].clientY-n)>10||Math.abs(s.touches[0].clientX-a)>10)&&(i=!0)}),e.addEventListener(isInAndroid()||isInHarmony()?"touchend":"click",s=>{var l;if(i)return;const o=(l=getCurrentEditor())==null?void 0:l.protyle,r=s.target,c=hasClosestByClassName(s.target,"keyboard__slash-item");if(c&&!c.getAttribute("data-type")){const g=decodeURIComponent(c.getAttribute("data-value"));if(g===Constants.ZWSP+3)return;o.hint.fill(g,o,!1),s.preventDefault(),s.stopPropagation(),c.getAttribute("data-focus")==="true"&&focusByRange(o.toolbar.range);return}const d=hasClosestByTag(r,"BUTTON");if(!d||d.getAttribute("disabled"))return;const u=d.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(u)){const g=getFontNodeElements(o),h=d.firstElementChild;u==="style1"?fontEvent(o,g,u,h.style.backgroundColor+Constants.ZWSP+h.style.color):u==="fontSize"?fontEvent(o,g,u,h.textContent.trim()):u==="backgroundColor"?fontEvent(o,g,u,h.style.backgroundColor):u==="color"?fontEvent(o,g,u,h.style.color):fontEvent(o,g,u)}if(s.preventDefault(),s.stopPropagation(),getSelection().rangeCount===0)return;const m=getSelection().getRangeAt(0);if(u==="done"){e.clientHeight>100?(Rc(),focusByRange(m)):hp();return}if(window.siyuan.config.readonly||!o||o.disabled)return;if(u==="undo"){o.undo.undo(o);return}else if(u==="redo"){o.undo.redo(o);return}if(getSelection().rangeCount===0)return;const f=hasClosestBlock(m.startContainer);if(f){if(u==="goback"){e.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const g=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");g[0].classList.remove("fn__none"),g[1].classList.add("fn__none"),focusByRange(m),t=!0,setTimeout(()=>{t=!1},1e3);return}else if(u==="goinline"){d.classList.add("protyle-toolbar__item--current");const g=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");g[1].classList.remove("fn__none"),g[0].classList.add("fn__none"),focusByRange(m);return}else if(["a","block-ref","inline-math","inline-memo"].includes(u)){hasClosestByAttribute(m.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],o),o.toolbar.element.querySelector(`[data-type="${u}"]`).dispatchEvent(new CustomEvent("click")));return}else if(d.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(u)){hasClosestByAttribute(m.startContainer,"data-type","NodeCodeBlock")||o.toolbar.setInlineMark(o,u,"toolbar");return}else if(u==="text"){if(d.classList.contains("protyle-toolbar__item--current"))Rc(),focusByRange(m);else{d.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const g=o.contentElement.scrollTop;wv(o,e),xh(g),window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard()}return}else if(u==="moveup"){moveToUp(o,f,m),focusByRange(m);return}else if(u==="movedown"){moveToDown(o,f,m),focusByRange(m);return}else if(u==="softLine"){m.extractContents(),softEnter(m,f,o),focusByRange(m);return}else if(u==="add"){if(d.classList.contains("protyle-toolbar__item--current"))Rc(),focusByRange(m);else{d.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const g=o.contentElement.scrollTop;$x(o,e),xh(g),window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard()}return}else if(u==="block"){o.gutter.renderMenu(o,f),window.siyuan.menus.menu.fullscreen(),hp();return}else if(u==="outdent"){listOutdent(o,[f.parentElement],m),focusByRange(m);return}else if(u==="indent"){listIndent(o,[f.parentElement],m),focusByRange(m);return}}})},vv=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const t=document.querySelector(".side-mask");t.classList.add("fn__none"),t.style.opacity="",window.siyuan.menus.menu.remove()},Nx=()=>{hp(),document.getElementById("model").style.transform=""},Th=null,Hx=t=>{var e;const n=getCurrentEditor().protyle;if((e=n.observerLoad)==null||e.disconnect(),window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],n),n.contentElement.classList.contains("fn__none")&&setEditMode(n,"wysiwyg"),n.notebookId=t.data.notebookId,n.path=t.data.path,t.data.startId===n.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&t.data.endId===n.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){n.contentElement.scrollTo({top:t.scrollTop,behavior:"smooth"});return}t.id!==n.block.rootID&&fetchPost("/api/block/getDocInfo",{id:t.id},i=>{setTitle(i.data.name),n.title.setTitle(i.data.name),n.background.render(i.data.ial,n.block.rootID),n.wysiwyg.renderCustom(i.data.ial)});const a=n.breadcrumb.element.parentElement.querySelector('[data-type="exit-focus"]');if(t.zoomId){t.zoomId!==n.block.id?fetchPost("/api/block/checkBlockExist",{id:t.id},i=>{i.data&&zoomOut({protyle:n,id:t.id,isPushBack:!1,callback:()=>{n.contentElement.scrollTop=t.scrollTop}})}):n.contentElement.scrollTop=t.scrollTop,a.classList.remove("fn__none");return}fetchPost("/api/filetree/getDoc",{id:t.id,startID:t.data.startId,endID:t.data.endId},i=>{n.block.parentID=i.data.parentID,n.block.parent2ID=i.data.parent2ID,n.block.rootID=i.data.rootID,n.block.showAll=!1,n.block.mode=i.data.mode,n.block.blockCount=i.data.blockCount,n.block.id=i.data.id,n.block.action=t.callback,n.wysiwyg.element.setAttribute("data-doc-type",i.data.type),n.wysiwyg.element.innerHTML=i.data.content,processRender(n.wysiwyg.element),highlightRender(n.wysiwyg.element),avRender(n.wysiwyg.element,n),blockRender(n,n.wysiwyg.element,t.scrollTop),i.data.isSyncing?disabledForeverProtyle(n):setReadonlyByConfig(n,!0),n.contentElement.scrollTop=t.scrollTop,setTimeout(()=>{n.contentElement.scrollTop=t.scrollTop},Constants.TIMEOUT_LOAD),n.app.plugins.forEach(s=>{s.eventBus.emit("switch-protyle",{protyle:n}),s.eventBus.emit("loaded-protyle-static",{protyle:n})}),a.classList.add("fn__none")})},Dh=()=>{const t=gp().protyle;t.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:t.block.showAll?t.block.id:t.block.rootID,data:{startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:t.notebookId,path:t.path},scrollTop:t.contentElement.scrollTop,callback:t.block.action,zoomId:t.block.showAll?t.block.id:void 0})},vD=()=>{const t=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(t&&!t.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],t.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if((window.JSAndroid||window.JSHarmony)&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid?window.JSAndroid.returnDesktop():window.JSHarmony&&window.JSHarmony.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(Th.length===0&&t){const n=t.protyle;Th.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const e=window.siyuan.backStack.pop();Th.push(e),Hx(e)};var Ox=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Ko=(t,e,n)=>{if(!t){e.innerHTML="";return}A("/api/template/render",{id:n,path:t,preview:!0},a=>{e.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},Ev=(t,e,n=!0)=>{if(!t.getAttribute("data-type")||!e.getAttribute("data-type"))return!1;t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim()),e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim());const a=t.attributes;let i=!0;for(let s=0;s<a.length;s++)e.getAttribute(a[s].name)!==a[s].value&&(i=!1);return i&&(n?t.innerHTML=t.innerHTML+e.innerHTML:t.innerHTML=e.innerHTML+t.innerHTML,e.remove()),i},kv=t=>{let e=t.previousSibling;for(;e&&e.nodeType!==3&&Ev(t,e,!1);)e=t.previousSibling;let n=t.nextSibling;for(;n&&n.nodeType!==3&&Ev(t,n);)n=t.nextSibling;(t.getAttribute("data-type")||"").includes("search-mark")&&t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim())},Ih=(t,e,n)=>{const a=t.getAttribute("data-type").split(" ");if(a.length===1){const i=t.parentElement;t.outerHTML=t.innerHTML.replace(p.ZWSP,"")+"<wbr>",n&&we(i,n)}else a.find((i,s)=>{if(e===i)return a.splice(s,1),!0}),t.setAttribute("data-type",a.join(" ")),e==="a"?t.removeAttribute("data-href"):e==="file-annotation-ref"?t.removeAttribute("data-id"):e==="block-ref"&&(t.removeAttribute("data-id"),t.removeAttribute("data-subtype")),n&&(n.selectNodeContents(t),n.collapse(!1),ne(n))},bp=t=>{const e=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],n=[];return t.forEach(a=>{let i=a;e.find(s=>{if(typeof a=="string"&&s.name===a)return i=s,!0;if(typeof a=="object"&&s.name===a.name)return i=Object.assign({},s,a),!0}),n.push(i)}),n},Jt=(t,e)=>Ox(void 0,null,function*(){let n="";for(let a=0;a<t.length;a++){const i=t[a];if(t.length>1&&(n+="- "),e==="ref"){const s=yield Ae("/api/block/getRefText",{id:i});n+=`((${i} '${s.data}'))`}else if(e==="blockEmbed")n+=`{{select * from blocks where id='${i}'}}`;else if(e==="protocol")n+=`siyuan://blocks/${i}`;else if(e==="protocolMd"){const s=yield Ae("/api/block/getRefText",{id:i});n+=`[${s.data}](siyuan://blocks/${i})`}else if(e==="hPath"){const s=yield Ae("/api/filetree/getHPathByID",{id:i});n+=s.data}else e==="id"&&(n+=i);t.length>1&&a!==t.length-1&&(n+=`
`)}Be(n)});var Bx=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Sv=(t,e,n)=>{if(W(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,e))return Gf(t,"Img"),e.preventDefault(),e.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,e))return Gf(t,"Assets"),e.preventDefault(),e.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,e))return A("/api/format/autoSpace",{id:t.block.rootID}),e.preventDefault(),e.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return A("/api/filetree/getHPathByID",{id:t.block.rootID},i=>{Be(i.data)}),e.preventDefault(),e.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),Jt(i.map(s=>s.getAttribute("data-node-id")),"protocolMd")}else Jt([t.block.rootID],"protocolMd");return e.preventDefault(),e.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.general.copyID.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),Jt(i.map(s=>s.getAttribute("data-node-id")),"id")}else Jt([t.block.rootID],"id");return e.preventDefault(),e.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),Jt(i.map(s=>s.getAttribute("data-node-id")),"protocol")}else Jt([t.block.rootID],"protocol");return e.preventDefault(),e.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e)){if(n){const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));i.length===0&&i.push(n),Jt(i.map(s=>s.getAttribute("data-node-id")),"blockEmbed")}else Jt([t.block.rootID],"blockEmbed");return e.preventDefault(),e.stopPropagation(),!0}let a=!1;if(t.app.plugins.find(i=>{if(i.commands.find(s=>{if(s.editorCallback&&W(s.customHotkey,e))return a=!0,s.editorCallback(t),!0}),a)return!0}),a)return!0},Lv=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else{const i=U(t.range.startContainer,"TD")||U(t.range.startContainer,"TH")||fe(t.nodeElement)||t.nodeElement,s=_t(i,t.editorElement,t.range).start,l=i.innerText,o=W(window.siyuan.config.keymap.editor.general.expandUp.custom,t.event);if(!(!Mt()&&o)){if(s>0){l.substr(0,s).indexOf(`
`)===-1&&t.range.getBoundingClientRect().top-i.getBoundingClientRect().top-parseInt(getComputedStyle(i).paddingTop)<14&&(Yl(i,t.range),t.event.preventDefault());return}}}t.range.collapse(!0),ce(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Pn(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},Av=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else{const a=U(t.range.startContainer,"TD")||U(t.range.startContainer,"TH"),i=a||fe(t.nodeElement)||t.nodeElement,s=_t(i,t.editorElement,t.range).end,l=i.innerText,o=W(window.siyuan.config.keymap.editor.general.expandDown.custom,t.event);if(!(!Mt()&&o)){if(s<l.length){!mt(t.nodeElement)&&l.trimRight().substr(s).indexOf(`
`)===-1&&i.getBoundingClientRect().bottom-t.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(i).paddingBottom)<14?(Yt(i,t.range,!1),t.nodeElement.classList.contains("code-block")&&o&&t.event.preventDefault()):a&&(Yt(a,t.range,!1),t.event.preventDefault());return}}}t.range.collapse(!1),ce(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Pn(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},yp=t=>{let e,n;return t.forEach(a=>{a.getAttribute("select-start")&&(e=a),a.getAttribute("select-end")&&(n=a)}),e||(e=t[0],e.setAttribute("select-start","true")),n||(n=t[t.length-1],n.setAttribute("select-end","true")),{startElement:e,endElement:n}},_p=(t,e)=>Bx(void 0,null,function*(){var n;let a;const i=[],s=[];let l,o=t[t.length-1],r=!0;o.classList.contains("li")&&(o.getAttribute("data-subtype")==="o"&&(l=parseInt(o.getAttribute("data-marker"),10)),t.find(u=>{if(!u.classList.contains("li")||o.getAttribute("data-subtype")!==u.getAttribute("data-subtype"))return r=!1,!0}),r||(o=He(o,"list")||o));let c="";const d=[];for(let u=t.length-1;u>=0;--u){const m=t[u];m.classList.remove("protyle-wysiwyg--select");let f=m.cloneNode(!0);const g=Lute.NewNodeID();if(m.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&m.querySelector('[data-type="NodeHeading"][fold="1"]')){const h=yield Ae("/api/block/getBlockDOM",{id:m.getAttribute("data-node-id")}),b=document.createElement("template");b.innerHTML=h.data.dom,f=b.content.firstElementChild}if(m.getAttribute("data-type")==="NodeListItem"&&!r)if(c||(c=`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`),c=qf(m)+c,u===0||t[u-1].getAttribute("data-type")!=="NodeListItem"||t[u-1].getAttribute("data-subtype")!==m.getAttribute("data-subtype")){const h=document.createElement("template");h.innerHTML=`<div data-subtype="${m.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${c}`,f=h.content.firstElementChild,c=""}else continue;if(u===t.length-1&&(a=f),f.setAttribute("data-node-id",g),f.removeAttribute(p.CUSTOM_RIFF_DECKS),f.classList.remove("protyle-wysiwyg--hl"),f.setAttribute("updated",g.split("-")[0]),f.removeAttribute("refcount"),(n=f.lastElementChild.querySelector(".protyle-attr--refcount"))==null||n.remove(),f.querySelectorAll("[data-node-id]").forEach(h=>{var b;const y=Lute.NewNodeID();h.setAttribute("data-node-id",y),h.removeAttribute(p.CUSTOM_RIFF_DECKS),h.classList.remove("protyle-wysiwyg--hl"),h.setAttribute("updated",y.split("-")[0]),h.removeAttribute("refcount"),(b=h.lastElementChild.querySelector(".protyle-attr--refcount"))==null||b.remove()}),typeof l=="number"){const h=l+u+1;f.setAttribute("data-marker",h+"."),f.querySelector(".protyle-action--order").textContent=h+"."}if(o.after(sa(f)),i.push({action:"insert",data:f.outerHTML,id:g,previousID:o.getAttribute("data-node-id")}),s.push({action:"delete",id:g}),m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"){d.push({oldId:m.getAttribute("data-node-id"),newId:g});const h=yield Ae("/api/block/getHeadingChildrenDOM",{id:m.getAttribute("data-node-id")}),b=document.createElement("template");b.innerHTML=h.data,Array.from(b.content.children).reverse().forEach((y,w)=>{if(w===b.content.children.length-1)return;y.querySelectorAll("[data-node-id]").forEach(C=>{C.setAttribute("data-node-id",Lute.NewNodeID()),C.removeAttribute(p.CUSTOM_RIFF_DECKS),C.removeAttribute("refcount")});const E=Lute.NewNodeID();y.setAttribute("data-node-id",E),y.removeAttribute(p.CUSTOM_RIFF_DECKS),y.removeAttribute("refcount"),i.push({context:{ignoreProcess:"true"},action:"insert",data:y.outerHTML,id:E,previousID:g}),s.push({action:"delete",id:E})})}}if(e.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(u=>{u.remove()}),typeof l=="number"){let u=a.nextElementSibling;for(l=l+t.length;u&&u.getAttribute("data-subtype")==="o";){l++;const m=u.getAttribute("data-node-id");s.push({action:"update",id:m,data:u.outerHTML}),u.setAttribute("data-marker",l+"."),u.querySelector(".protyle-action--order").textContent=l+".",i.push({action:"update",data:u.outerHTML,id:m}),u=u.nextElementSibling}}V(e,i,s),oe(a),Ye(e)}),$h=t=>{t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.options.backlinkData?(oe(t.wysiwyg.element.firstElementChild),t.contentElement.scrollTop=0,t.scroll.lastScrollTop=1):A("/api/filetree/getDoc",{id:t.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{kt({data:e,protyle:t,action:[p.CB_GET_FOCUS]})})},xv=t=>{!t.scroll.element.classList.contains("fn__none")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?A("/api/filetree/getDoc",{id:t.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{kt({data:e,protyle:t,action:[p.CB_GET_FOCUS],afterCB(){oe(t.wysiwyg.element.lastElementChild,void 0,!1)}})}):(t.contentElement.scrollTop=t.contentElement.scrollHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop,oe(t.wysiwyg.element.lastElementChild,void 0,!1))},Cv=(t,e,n,a,i)=>{e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.minWidth="calc(100% - 0.1em)"}),le(t,a,e.outerHTML,i)},Tv=(t,e,n,a,i)=>{e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.removeAttribute("style")}),le(t,a,e.outerHTML,i)},Ra=(t,e)=>t?`<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(t)}</span>`:e?`<span class="b3-list-item__meta">${e}</span>`:"",Mh=(t,e)=>{const n=[{filter:[window.siyuan.languages.template,"template","\u6A21\u677F","moban","muban","mb"],id:"template",value:p.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:[window.siyuan.languages.widget,"widget","\u6302\u4EF6","guajian","gj"],id:"widget",value:p.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:[window.siyuan.languages.assets,"assets","\u8D44\u6E90","ziyuan","zy"],id:"assets",value:p.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:[window.siyuan.languages.ref,"block reference","\u5757\u5F15\u7528","kuaiyinyong","kyy"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:[window.siyuan.languages.blockEmbed,"embed block","\u5D4C\u5165\u5757","qianrukuai","qrk"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:[window.siyuan.languages.aiWriting,"ai writing","ai\u7F16\u5199","aibianxie","aibx","\u4EBA\u5DE5\u667A\u80FD","rengongzhineng","rgzn"],id:"aiWriting",value:p.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span>${Ra(window.siyuan.config.keymap.editor.general.aiWriting.custom,"")}</div>`},{filter:[window.siyuan.languages.database,"database","db","\u6570\u636E\u5E93","shujuku","sjk","\u89C6\u56FE","view"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:[window.siyuan.languages.newFileRef,"create new doc with reference","\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy"],id:"newFileRef",value:p.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:[window.siyuan.languages.newSubDocRef,"create sub doc with reference","\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy"],id:"newSubDocRef",value:p.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:[window.siyuan.languages.heading1,"heading1","h1","\u4E00\u7EA7\u6807\u9898","yijibiaoti","yjbt"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${Ra(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:[window.siyuan.languages.heading2,"heading2","h2","\u4E8C\u7EA7\u6807\u9898","erjibiaoti","ejbt"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${Ra(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:[window.siyuan.languages.heading3,"heading3","h3","\u4E09\u7EA7\u6807\u9898","sanjibiaoti","sjbt"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${Ra(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:[window.siyuan.languages.heading4,"heading4","h4","\u56DB\u7EA7\u6807\u9898","sijibiaoti","sjbt"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${Ra(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:[window.siyuan.languages.heading5,"heading5","h5","\u4E94\u7EA7\u6807\u9898","wujibiaoti","wjbt"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${Ra(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:[window.siyuan.languages.heading6,"heading6","h6","\u516D\u7EA7\u6807\u9898","liujibiaoti","ljbt"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${Ra(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:[window.siyuan.languages.list,"unordered list","\u65E0\u5E8F\u5217\u8868","wuxvliebiao","wuxuliebiao","wxlb"],id:"list",value:"- "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${Ra(window.siyuan.config.keymap.editor.insert.list.custom,"- ")}</div>`},{filter:[window.siyuan.languages["ordered-list"],"order list","ordered list","\u6709\u5E8F\u5217\u8868","youxvliebiao","youxuliebiao","yxlb"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${Ra(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:[window.siyuan.languages.check,"task list","todo list","\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb"],id:"check",value:"- [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${Ra(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:[window.siyuan.languages.quote,"blockquote","bq","\u5F15\u8FF0","yinshu","ys"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${Ra(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:[window.siyuan.languages.code,"code block","\u4EE3\u7801\u5757","daimakuai","dmk"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${Ra(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:[window.siyuan.languages.table,"table","\u8868\u683C","biaoge","bg"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:[window.siyuan.languages.line,"thematic break","divider","\u5206\u9694\u7EBF","\u5206\u5272\u7EBF","fengexian","fgx"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:[window.siyuan.languages.math,"formulas block","math block","\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:[window.siyuan.languages.emoji,"emoji","\u8868\u60C5","biaoqing","bq"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:[window.siyuan.languages.link,"link","a","\u94FE\u63A5","lianjie","lj"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:[window.siyuan.languages.bold,"bold","strong","\u7C97\u4F53","cuti","ct","\u52A0\u7C97","jiacu","jc"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:[window.siyuan.languages.italic,"italic","em","\u659C\u4F53","xieti","xt"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:[window.siyuan.languages.underline,"underline","\u4E0B\u5212\u7EBF","xiahuaxian","xhx"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:[window.siyuan.languages.strike,"strike","delete","\u5220\u9664\u7EBF","shanchuxian","scx"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:[window.siyuan.languages.mark,"mark","\u6807\u8BB0","biaoji","bj","\u9AD8\u4EAE","gaoliang","gl"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:[window.siyuan.languages.sup,"superscript","\u4E0A\u6807","shangbiao","sb"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:[window.siyuan.languages.sub,"subscript","\u4E0B\u6807","xiaobiao","xb"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-code"],"inline code","\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:[window.siyuan.languages.kbd,"kbd","\u952E\u76D8","jianpan","jp"],id:"kbd",value:"kbd",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.kbd}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.kbd.custom)}</span></div>`},{filter:[window.siyuan.languages.tag,"tags","\u6807\u7B7E","biaoqian","bq"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-math"],"inline formulas","inline math","\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxvegongshi","hangjishuxuegongshi","hjsxgs"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:[window.siyuan.languages.insertAsset,"insert image or file","upload","\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","charutupianhuowenjian","crtphwj","\u4E0A\u4F20","sc"],id:"insertAsset",value:p.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${e.options.upload.accept?'multiple="'+e.options.upload.accept+'"':""}></div>`},{filter:[window.siyuan.languages.insertIframeURL,"insert iframe link","\u63D2\u5165 iframe \u94FE\u63A5","charuiframelianjie","criframelj"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:[window.siyuan.languages.insertImgURL,"insert image link","image","img","\u63D2\u5165\u56FE\u7247\u94FE\u63A5","charutupianlianjie","crtplj"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:[window.siyuan.languages.insertVideoURL,"insert video link","\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:[window.siyuan.languages.insertAudioURL,"insert audio link","\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:[window.siyuan.languages.staff,"staff","\u4E94\u7EBF\u8C31","wuxianpu","wxp"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:[window.siyuan.languages.chart,"chart","\u56FE\u8868","tubiao","tb"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["flowchart","flow chart","\u6D41\u7A0B\u56FE","liuchengtu","lct"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["graphviz","\u72B6\u6001\u56FE","zhuangtaitu","ztt"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["mermaid","diagram","\u56FE\u8868","tubiao","tb"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:[window.siyuan.languages.mindmap,"mindmap","\u8111\u56FE","naotu","nt"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["plantuml","\u5EFA\u6A21\u8BED\u8A00","jianmoyuyan","jmyy"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:[window.siyuan.languages.infoStyle,"info style","\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys"],id:"infoStyle",value:`style${p.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:[window.siyuan.languages.successStyle,"success style","\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys"],id:"successStyle",value:`style${p.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:[window.siyuan.languages.warningStyle,"warning style","\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys"],id:"warningStyle",value:`style${p.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:[window.siyuan.languages.errorStyle,"error style","\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys"],id:"errorStyle",value:`style${p.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:[window.siyuan.languages.clearFontStyle,"clear style","\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys"],id:"clearFontStyle",value:`style${p.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let a=!1;return e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n.push({filter:s.filter,id:s.id,value:`plugin${p.ZWSP}${i.name}${p.ZWSP}${s.id}`,html:s.html}),a=!0})}),a||n.pop(),t===""?n:n.filter(i=>i.filter?!!i.filter.find(l=>{if(l.toLowerCase().indexOf(t.toLowerCase())>-1)return!0}):!1)},Rx=(t,e)=>(e.hint.genLoading(e),A("/api/search/searchTag",{k:t},n=>{const a=[];let i=!1;n.data.tags.forEach(s=>{const l=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`<span data-type="tag">${l}</span>`,html:`<div class="b3-list-item__text">${s}</div>`}),l===n.data.k&&(i=!0)}),n.data.k&&!i&&(a.splice(0,0,{value:`<span data-type="tag">${n.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.newTag} <mark>${he(n.data.k)}</mark></div>`}),a.length>1&&(a[1].focus=!0)),e.hint.genHTML(a,e,!0,"hint")}),[]),Ph=t=>{let e;t.type==="NodeDocument"&&t.ial.icon?(e=be(t.ial.icon,"b3-list-item__graphic popover__block",!0),e=e.replace('popover__block"',`popover__block" data-id="${t.id}"`)):e=`<svg class="b3-list-item__graphic popover__block" data-id="${t.id}"><use xlink:href="#${la(t.type)}"></use></svg>`;let n="";t.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${t.name}</span></span><span class="fn__space"></span>`),t.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${t.alias}</span></span><span class="fn__space"></span>`),t.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${t.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`);let a="";return t.refCount&&(a=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${t.refCount}</span>`),`${n}<div class="b3-list-item__first" data-node-id="${t.id}">
    ${e}
    <span class="b3-list-item__text">${t.content}</span>${a}
</div>
<div class="b3-list-item__meta b3-list-item__showall">${t.hPath}</div>`},As=(t,e,n)=>{const a=B(ke(e.wysiwyg.element).startContainer);return e.hint.genLoading(e),A("/api/search/searchRefBlock",{k:t,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:n==="av"?"":e.block.rootID,isDatabase:n==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(e.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const l=Lute.UnEscapeHTMLStr(oa(i.data.k));s.push({value:`((newFile "${l}"${p.ZWSP}'${l}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(l=>{let o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="d">${l.name||l.refText.replace(new RegExp(p.ZWSP,"g"),"")}</span>`;if(n==="search")o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${t}${p.ZWSP}${l.name||l.refText.replace(new RegExp(p.ZWSP,"g"),"")}</span>`;else if(n==="av"){let r=l.name||l.refText.replace(new RegExp(p.ZWSP,"g"),"");a&&(r=l.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||r),o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${r}</span>`}s.push({value:o,html:Ph(l)})}),n==="search"&&(e.hint.splitChar="((",e.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),e.hint.genHTML(s,e,!0,n)}),[]},Zo=(t,e)=>{if(t.endsWith("}}")||t.endsWith("\u300D\u300D"))return[];e.hint.genLoading(e);const n=B(ke(e.wysiwyg.element).startContainer);return A("/api/search/searchRefBlock",{k:t,isDatabase:!1,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):e.block.parentID,rootID:e.block.rootID},a=>{const i=[];a.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:Ph(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),e.hint.genHTML(i,e,!0,"hint")}),[]},Dv=(t,e,n)=>{A("/api/template/render",{id:e.block.parentID,path:t},a=>{ne(e.toolbar.range);const i=fe(n);i&&i.textContent.trim()===""?Ht(a.data.content,e,!0):Ht(a.data.content,e),e.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),We(e,e.wysiwyg.element),Ct(e.wysiwyg.element),rt(e.wysiwyg.element),Vt(e.wysiwyg.element,e),ce(["util"],e)})},Iv=(t,e)=>{ne(e.toolbar.range),Ht(e.lute.SpinBlockDOM(`<iframe src="/widgets/${t}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),e,!0),ce(["util"],e)},$v=(t,e)=>{ne(e.toolbar.range);const n=De().extname(t).toLowerCase(),a=t.startsWith("assets/")?Bf(t):t;Ht(fv(n,t,a,t.startsWith("assets/")?a+n:t),e),ce(["util"],e)},Nh=(t,e,n)=>{if(t==="/")return;const a=xt(t,!0,!0);if(n.block.rootID===a)return;const i=[];let s;const l=e[0].parentElement;let o;if(e.forEach((r,c)=>{c===e.length-1&&r.parentElement&&(s=Et(r),o=s.nextElementSibling||s.previousElementSibling,s===r&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(l.classList.contains("list")&&l.getAttribute("data-subtype")==="o"&&l.childElementCount>1)Tt(l,1),Array.from(l.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&l.classList.contains("protyle-wysiwyg")&&l.childElementCount===0)setTimeout(()=>{dn({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},p.TIMEOUT_INPUT*2+100);else if(l.classList.contains("protyle-wysiwyg")&&l.innerHTML===""&&!T(l,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),c=jn(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:n.block.parentID}),l.innerHTML=c.outerHTML,oe(c)}else o&&oe(o);V(n,i)},$l=t=>{t.style.minWidth?t.style.width="":t.removeAttribute("style")};var Mv=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Hh=(t,e,n,a=[])=>{A("/api/search/searchAsset",{k:e,exts:a},i=>{let s="";i.data.forEach((c,d)=>{s+=`<div data-value="${c.path}" class="b3-list-item${d===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${c.hName}</div></div>`});const l=t.querySelector(".b3-list"),o=t.querySelector("#preview"),r=t.querySelector("input");l.innerHTML=s||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,i.data.length>0?o.innerHTML=Cl(i.data[0].path):o.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.popup(n),e||r.select()})},Oh=(t,e,n,a)=>{const i=new dt(p.MENU_BACKGROUND_ASSET);i.isOpen||i.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: ${Y()?"80":"50"}vh">
<div class="fn__flex-column" style="${Y()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${Y()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(s){s.style.maxWidth="none";const l=s.querySelector(".b3-list"),o=s.querySelector("#preview");l.addEventListener("mouseover",c=>{const d=c.target,u=T(d,"b3-list-item");u&&(o.innerHTML=Cl(u.getAttribute("data-value")))});const r=s.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;const d=s.querySelector(".b3-list--empty");if(!d){const u=xn(l,c);u&&(o.innerHTML=Cl(u.getAttribute("data-value")),c.stopPropagation())}if(c.key==="Enter"){if(d)n||(window.siyuan.menus.menu.remove(),ne(t.toolbar.range));else{const u=s.querySelector(".b3-list-item--focus");n?n(u.getAttribute("data-value"),u.textContent):($v(u.getAttribute("data-value"),t),window.siyuan.menus.menu.remove())}c.preventDefault(),c.stopPropagation()}else c.key==="Escape"&&(n||ne(t.toolbar.range))}),r.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),Hh(s,r.value,e,a))}),r.addEventListener("compositionend",c=>{c.stopPropagation(),Hh(s,r.value,e,a)}),s.lastElementChild.addEventListener("click",c=>{const d=c.target;if(j(d,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),c.stopPropagation();return}if(j(d,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),c.stopPropagation();return}const f=T(d,"b3-list-item");if(f){c.stopPropagation();const g=f.getAttribute("data-value");n?n(g,f.textContent):($v(g,t),window.siyuan.menus.menu.remove())}}),Hh(s,"",e,a)}})},Bh=(t,e)=>{var n;const a=B(e);if(!a)return;ce(["util","toolbar","hint"],t);const i=a.getAttribute("data-node-id");let s=a.outerHTML;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_FILE_ANNOTATION_REF);let l;window.siyuan.menus.menu.append(new N({id:"idAndAnchor",iconHTML:"",type:"readonly",label:`<div>ID</div><textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${Y()?"100%":"360px"}" class="b3-text-field" readonly>${e.getAttribute("data-id")||""}</textarea><div class="fn__hr"></div><div>${window.siyuan.languages.anchor}</div><textarea rows="1" style="margin:4px 0;width: ${Y()?"100%":"360px"}" class="b3-text-field"></textarea>`,bind(c){c.style.maxWidth="none",l=c.querySelectorAll(".b3-text-field")[1],l.value=e.textContent;const d=()=>{l.value?e.innerHTML=Lute.EscapeHTMLStr(l.value):e.innerHTML="*"};l.addEventListener("input",u=>{u.isComposing||(d(),u.stopPropagation())}),l.addEventListener("compositionend",u=>{u.isComposing||(d(),u.stopPropagation())}),l.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(ai(u))return}})}}).element),window.siyuan.menus.menu.append(new N({type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:[{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),Ih(e,"file-annotation-ref",t.toolbar.range),le(t,i,a.outerHTML,s),s=a.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.textContent="*",a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,i,a.outerHTML,s),s=a.outerHTML}}]}).element),window.siyuan.menus.menu.append(new N({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,i,a.outerHTML,s),we(a,t.toolbar.range),s=a.outerHTML}}).element),(n=t==null?void 0:t.app)!=null&&n.plugins&&zn({plugins:t.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const r=He(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),l.select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==s&&(a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,i,a.outerHTML,s));const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!t.element.contains(c.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),ne(t.toolbar.range))}},Rh=(t,e)=>{var n;const a=B(e);if(!a)return;ce(["util","toolbar","hint"],t);const i=e.getAttribute("data-id"),s=a.getAttribute("data-node-id");let l=a.outerHTML;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_REF),t.disabled||(window.siyuan.menus.menu.append(new N({id:"anchor",iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(c){const d=c.querySelector("input");d.value=e.getAttribute("data-subtype")==="d"?"":e.textContent,d.addEventListener("input",()=>{d.value?e.innerHTML=Lute.EscapeHTMLStr(d.value).trim()||i:A("/api/block/getRefText",{id:i},u=>{e.innerHTML=u.data}),e.setAttribute("data-subtype",d.value?"s":"d")}),d.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(ai(u))return}})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new N({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",accelerator:window.siyuan.config.keymap.editor.general.openBy.custom+"/"+window.siyuan.languages.click,click(){ft(i,(c,d,u)=>{u||d.push(p.CB_GET_HL),ve({app:t.app,id:i,action:d,zoomIn:c})})}}).element),window.siyuan.menus.menu.append(new N({id:"refTab",label:window.siyuan.languages.refTab,icon:"iconEyeoff",accelerator:window.siyuan.config.keymap.editor.general.refTab.custom+"/"+pe("\u2318"+window.siyuan.languages.click),click(){ft(i,c=>{ve({app:t.app,id:i,action:c?[p.CB_GET_HL,p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:c})})}}).element),window.siyuan.menus.menu.append(new N({id:"insertRight",label:window.siyuan.languages.insertRight,icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.editor.general.insertRight.custom+"/"+pe("\u2325"+window.siyuan.languages.click),click(){ft(i,(c,d,u)=>{u||d.push(p.CB_GET_HL),ve({app:t.app,id:i,position:"right",action:d,zoomIn:c})})}}).element),window.siyuan.menus.menu.append(new N({id:"insertBottom",label:window.siyuan.languages.insertBottom,icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.editor.general.insertBottom.custom+(window.siyuan.config.keymap.editor.general.insertBottom.custom?"/":"")+pe("\u21E7"+window.siyuan.languages.click),click(){ft(i,(c,d,u)=>{u||d.push(p.CB_GET_HL),ve({app:t.app,id:i,position:"bottom",action:d,zoomIn:c})})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"backlinks",icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{Qc({app:t.app,blockId:i})}}).element),window.siyuan.menus.menu.append(new N({id:"graphView",icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{ed({app:t.app,blockId:i})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),!t.disabled){let c=[];e.getAttribute("data-subtype")==="s"?c.push({id:"turnToDynamic",iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){e.setAttribute("data-subtype","d"),A("/api/block/getRefText",{id:i},d=>{e.innerHTML=d.data,a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),l=a.outerHTML}),ne(t.toolbar.range)}}):c.push({id:"turnToStatic",iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){e.setAttribute("data-subtype","s"),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),ne(t.toolbar.range),l=a.outerHTML}}),c=c.concat([{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),Ih(e,"block-ref",t.toolbar.range),le(t,s,a.outerHTML,l),l=a.outerHTML}},{id:"*",iconHTML:"",label:"*",click(){e.setAttribute("data-subtype","s"),e.textContent="*",a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),ne(t.toolbar.range),l=a.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.setAttribute("data-subtype","s"),e.textContent="*",a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),ne(t.toolbar.range),l=a.outerHTML}},{id:"link",label:window.siyuan.languages.link,iconHTML:"",click(){e.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${e.getAttribute("data-id")}">${e.innerHTML}</span><wbr>`,a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),we(a,t.toolbar.range),l=a.outerHTML}}]),e.parentElement.textContent.trim()===e.textContent.trim()&&e.parentElement.tagName==="DIV"&&c.push({id:"blockEmbed",iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const d=`<div data-content="select * from blocks where id='${i}'" data-node-id="${s}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${Q().format("YYYYMMDDHHmmss")}">${a.querySelector(".protyle-attr").outerHTML}</div>`;a.outerHTML=d,le(t,s,d,l),We(t,t.wysiwyg.element),l=a.outerHTML}}),c.push({id:"defBlock",iconHTML:"",label:window.siyuan.languages.defBlock,click(){A("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!1})}}),c.push({id:"defBlockChildren",iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){A("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!0})}}),window.siyuan.menus.menu.append(new N({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:c}).element)}window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(t.lute.BlockDOM2StdMd(e.outerHTML).trim())}}).element),t.disabled||(window.siyuan.menus.menu.append(new N({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){Be(t.lute.BlockDOM2StdMd(e.outerHTML)),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),we(a,t.toolbar.range),l=a.outerHTML}}).element),window.siyuan.menus.menu.append(new N({id:"remove",label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l),we(a,t.toolbar.range),l=a.outerHTML}}).element)),(n=t==null?void 0:t.app)!=null&&n.plugins&&zn({plugins:t.app.plugins,type:"open-menu-blockref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const r=He(t.element,"block__popover",!0);window.siyuan.menus.menu.data=e,window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),t.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==l&&(a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,a.outerHTML,l));const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!t.element.contains(c.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),ne(t.toolbar.range))})},qx=(t,e)=>{var n,a,i;const s=ke(e);window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_CONTEXT);const l=e.outerHTML,o=e.getAttribute("data-node-id");if(s.toString()!==""||(a=(n=s.cloneContents().childNodes[0])==null?void 0:n.classList)!=null&&a.contains("emoji")){if(window.siyuan.menus.menu.append(new N({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){ne(ke(e)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new N({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){ne(ke(e)),Yi(getSelection().getRangeAt(0).toString())}}).element),t.disabled)return;window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){ne(ke(e)),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click(){const r=ke(e);r.insertNode(document.createElement("wbr")),r.extractContents(),we(e,r),ne(r),le(t,o,e.outerHTML,l)}}).element)}else{const r=U(s.startContainer,"SPAN");if(r){const c=t.toolbar.getCurrentType(s);if(c.includes("code")||c.includes("kbd")){if(window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(t.lute.BlockDOM2StdMd(r.outerHTML))}}).element),window.siyuan.menus.menu.append(new N({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,click(){Yi(r.textContent)}}).element),!t.disabled){const d=e.getAttribute("data-node-id");window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){Be(t.lute.BlockDOM2StdMd(r.outerHTML)),r.insertAdjacentHTML("afterend","<wbr>"),r.remove(),e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,d,e.outerHTML,l),we(e,t.toolbar.range)}}).element),window.siyuan.menus.menu.append(new N({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){r.insertAdjacentHTML("afterend","<wbr>"),r.remove(),e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,d,e.outerHTML,l),we(e,t.toolbar.range)}}).element)}window.siyuan.menus.menu.append(new N({type:"separator"}).element)}}}if(!t.disabled){let r;window.siyuan.menus.menu.append(new N({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return Mv(this,null,function*(){if(ne(ke(e)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const c=yield hc();Uo(t,Object.assign(c,{target:e}))}catch(c){console.log(c)}})}}).element),window.siyuan.menus.menu.append(new N({id:"pasteAsPlainText",label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click(){ne(ke(e)),rh(t)}}).element),window.siyuan.menus.menu.append(new N({id:"pasteEscaped",label:window.siyuan.languages.pasteEscaped,click(){ne(ke(e)),Lw(t,e)}}).element)}if(window.siyuan.menus.menu.append(new N({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click(){Jp(t,e,s)}}).element),e.classList.contains("table")&&!t.disabled){const r=U(s.startContainer,"TD")||U(s.startContainer,"TH");if(r){const c=Pv(t,e,r,s);c.insertMenus.length>0&&(window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),c.insertMenus.forEach(d=>{window.siyuan.menus.menu.append(new N(d).element)})),c.removeMenus.length>0&&(window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),c.removeMenus.forEach(d=>{window.siyuan.menus.menu.append(new N(d).element)})),window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"more",type:"submenu",icon:"iconMore",label:window.siyuan.languages.more,submenu:c.otherMenus.concat(c.other2Menus)}).element)}}(i=t==null?void 0:t.app)!=null&&i.plugins&&zn({plugins:t.app.plugins,type:"open-menu-content",detail:{protyle:t,range:s,element:e},separatorPosition:"top"})},qh=(t,e)=>{if(t.block.showAll)dn({protyle:t,id:t.block.parent2ID,focusId:e});else{const n=t.path.split("/");n.length>2&&ve({app:t.app,id:n[n.length-2],action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]})}},dn=t=>{var e,n;if(t.protyle.options.backlinkData)return;typeof t.isPushBack=="undefined"&&(t.isPushBack=!0),typeof t.reload=="undefined"&&(t.reload=!1);const a=T(t.protyle.element,"block__popover",!0);if(a){const s=a.querySelector('[data-type="pin"]');s&&a.getAttribute("data-pin")!=="true"&&(s.setAttribute("aria-label",window.siyuan.languages.unpin),s.querySelector("use").setAttribute("xlink:href","#iconUnpin"),a.setAttribute("data-pin","true"))}const i=(e=t.protyle.breadcrumb)==null?void 0:e.element.querySelector(".protyle-breadcrumb__item--active");if(!t.reload&&i&&i.getAttribute("data-node-id")===t.id){if(t.id===t.protyle.block.rootID)return;const s=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`);if(s){oe(s),s.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[p.LOCAL_DOCINFO]={id:t.id},Ee(p.LOCAL_DOCINFO,window.siyuan.storage[p.LOCAL_DOCINFO]),t.isPushBack&&Dh()),A("/api/filetree/getDoc",{id:t.id,size:t.id===t.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.SIZE_GET_MAX},s=>Mv(void 0,null,function*(){if(t.isPushBack?kt({data:s,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_HTML],afterCB:t.callback}):kt({data:s,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML,p.CB_GET_UNUNDO]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_UNUNDO,p.CB_GET_HTML],afterCB:t.callback}),t.focusId){let l=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`);if(!l){const o=yield Ae("/api/block/getUnfoldedParentID",{id:t.focusId});t.focusId=o.data.parentID,l=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${o.data.parentID}"]`)}if(l){let o=l;for(;o.getBoundingClientRect().height===0;)o=o.parentElement;o.classList.contains("protyle-wysiwyg")?o=l.previousElementSibling||l.nextElementSibling:o=Ut(o),oe(o);const r=new ResizeObserver(()=>{Ye(t.protyle,l,"start")});r.observe(t.protyle.wysiwyg.element),setTimeout(()=>{r.disconnect()},1e3*3)}else if(t.focusId){if(t.id===t.protyle.block.rootID){A("/api/filetree/getDoc",{id:t.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{kt({data:o,protyle:t.protyle,action:t.isPushBack?[p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_UNUNDO]})});return}}else{A("/api/filetree/getDoc",{id:t.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{kt({data:o,protyle:t.protyle,action:t.isPushBack?[p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_UNUNDO]})});return}}else t.id!==t.protyle.block.rootID&&(t.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{t.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365));if(t.protyle.model){const l=Oe();l.outline.forEach(o=>{o.blockId===t.protyle.block.rootID&&o.setCurrent(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`))}),ey(l,t.protyle)}}))},Fh=(t,e,n,a)=>{var i;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_IMG);const s=B(n);if(!s)return;ce(["util","toolbar","hint"],t);const l=s.getAttribute("data-node-id"),o=n.querySelector("img"),r=n.querySelector(".protyle-action__title span"),c=s.outerHTML;let d=o.getAttribute("src");if(d||(d=""),t.disabled||(window.siyuan.menus.menu.append(new N({id:"imageUrlAndTitleAndTooltipText",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea spellcheck="false" style="margin:4px 0;width: ${Y()?"100%":"360px"}" rows="1" class="b3-text-field">${d}</textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="margin:4px 0;width: ${Y()?"100%":"360px"}" rows="1" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="margin:4px 0;width: ${Y()?"100%":"360px"}" rows="1" class="b3-text-field"></textarea>`,bind(g){g.style.maxWidth="none";const h=g.querySelectorAll("textarea");h[0].addEventListener("input",b=>{const y=b.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim();if(o.setAttribute("src",y),o.setAttribute("data-src",y),y.startsWith("assets/")){const w=n.querySelector(".img__net");w&&w.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),h[1].value=r.innerText,h[1].addEventListener("input",b=>{const y=b.target.value;o.setAttribute("title",y),r.innerText=y,Nn(r)}),h[2].value=o.getAttribute("alt")||"",g.addEventListener("click",b=>{let y=b.target;for(;y;){if(y.dataset.action==="copy"){Be(y.parentElement.nextElementSibling.value),de(window.siyuan.languages.copied);break}y=y.parentElement}})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let g=t.lute.BlockDOM2StdMd(n.outerHTML);g=g.replace(/%20/g," "),Be(g)}}).element),t.disabled&&window.siyuan.menus.menu.append(new N({id:"copyImageURL",label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){Be(o.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new N({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){ah(o.getAttribute("src"))}}).element),!t.disabled){window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let y=t.lute.BlockDOM2StdMd(n.outerHTML);y=y.replace(/%20/g," "),Be(y),n.outerHTML="<wbr>",s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c),we(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c),we(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element);const g=o.getAttribute("data-src");g.startsWith("assets/")&&window.siyuan.menus.menu.append(new N({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Uf(g)}}).element),window.siyuan.menus.menu.append(new N({id:"ocr",label:"OCR",submenu:[{id:"ocrResult",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(y){y.style.maxWidth="none",A("/api/asset/getImageOCRText",{path:o.getAttribute("src")},w=>{const E=y.querySelector("textarea");E.value=w.data.text,E.dataset.ocrText=w.data.text})}},{type:"separator"},{id:"reOCR",iconHTML:"",label:window.siyuan.languages.reOCR,click(){A("/api/asset/ocr",{path:o.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new N({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){Cv(t,s,[n],l,c)}}).element),window.siyuan.menus.menu.append(new N({id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){Tv(t,s,[n],l,c)}}).element);let h;window.siyuan.menus.menu.append(new N({id:"width",label:window.siyuan.languages.width,submenu:[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" style="margin: 4px 8px 4px 0" value="${o.parentElement.style.width.endsWith("px")?parseInt(o.parentElement.style.width):""}" type="number" placeholder="${window.siyuan.languages.width}"><span class="fn__flex-center">px</span></div>`,bind(y){const w=y.querySelector("input");w.addEventListener("input",()=>{h.value="0",h.parentElement.setAttribute("aria-label",w.value?w.value+"px":window.siyuan.languages.default),$l(n),o.parentElement.style.width=w.value?w.value+"px":"",o.style.height=""}),w.addEventListener("blur",()=>{w.value!==o.parentElement.style.width.replace("px","")&&(s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c),window.siyuan.menus.menu.remove(),oe(s))})}},Ml("25%",o,t,l,s,c),Ml("33%",o,t,l,s,c),Ml("50%",o,t,l,s,c),Ml("67%",o,t,l,s,c),Ml("75%",o,t,l,s,c),Ml("100%",o,t,l,s,c),{id:"separator_1",type:"separator"},{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${o.parentElement.style.width?o.parentElement.style.width.replace("vw","%").replace("calc(","").replace(" - 8px)",""):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${o.parentElement.style.width.indexOf("%")>-1||o.parentElement.style.width.endsWith("vw")?parseInt(o.parentElement.style.width.replace("calc(","")):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind(y){h=y.querySelector("input"),h.addEventListener("input",()=>{$l(n),o.parentElement.style.width=`calc(${h.value}% - 8px)`,o.style.height="",h.parentElement.setAttribute("aria-label",`${h.value}%`)}),h.addEventListener("change",()=>{s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c),window.siyuan.menus.menu.remove(),oe(s)})}},{id:"separator_2",type:"separator"},Ml(window.siyuan.languages.default,o,t,l,s,c)]}).element);let b;window.siyuan.menus.menu.append(new N({id:"height",label:window.siyuan.languages.height,submenu:[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${o.style.height.endsWith("px")?parseInt(o.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind(y){const w=y.querySelector("input");w.addEventListener("input",()=>{b.value="0",b.parentElement.setAttribute("aria-label",w.value?w.value+"px":window.siyuan.languages.default),o.style.height=w.value?w.value+"px":"",$l(n),o.parentElement.style.width=""}),w.addEventListener("blur",()=>{w.value!==o.style.height.replace("px","")&&(s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c),window.siyuan.menus.menu.remove(),oe(s))})}},Pl("25%",o,t,l,s,c),Pl("33%",o,t,l,s,c),Pl("50%",o,t,l,s,c),Pl("67%",o,t,l,s,c),Pl("75%",o,t,l,s,c),Pl("100%",o,t,l,s,c),{id:"separator_1",type:"separator"},{id:"heightDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${o.style.height?o.style.height.replace("vh","%"):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${o.style.height.endsWith("vh")?parseInt(o.style.height):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind(y){b=y.querySelector("input"),b.addEventListener("input",()=>{$l(n),o.parentElement.style.width="",o.style.height=b.value+"vh",b.parentElement.setAttribute("aria-label",`${b.value}%`)}),b.addEventListener("change",()=>{s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c),window.siyuan.menus.menu.remove(),oe(s)})}},{id:"separator_2",type:"separator"},Pl(window.siyuan.languages.default,o,t,l,s,c)]}).element)}const u=o.getAttribute("src");u&&(window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),Vc(t.app,u,!1,!1));const m=o.getAttribute("data-src");m&&m.startsWith("assets/")&&window.siyuan.menus.menu.append(new N(Rf(m)).element),(i=t==null?void 0:t.app)!=null&&i.plugins&&zn({plugins:t.app.plugins,type:"open-menu-image",detail:{protyle:t,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const f=He(t.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",f?f.dataset.level+"popover":"app"),!t.disabled){const g=window.siyuan.menus.menu.element.querySelectorAll("textarea");g[0].value?g[1].select():g[0].select(),window.siyuan.menus.menu.removeCB=()=>{const h=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');h&&h.dataset.ocrText!==h.value&&A("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:h.value}),o.setAttribute("alt",g[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,l,s.outerHTML,c)}}},Jo=(t,e,n=!1)=>{var a;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_A);const i=B(e);if(!i)return;cn(),ce(["util","toolbar","hint"],t);const s=i.getAttribute("data-node-id");let l=i.outerHTML;const o=e.getAttribute("data-href");let r;t.disabled||(window.siyuan.menus.menu.append(new N({id:"linkAndAnchorAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea spellcheck="false" rows="1" 
style="margin:4px 0;width: ${Y()?"100%":"360px"}" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="width: ${Y()?"100%":"360px"};margin: 4px 0;" rows="1" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="width: ${Y()?"100%":"360px"};margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(u){u.style.maxWidth="none",r=u.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(o)||"",r[0].addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),r[1].focus();else if(ai(f))return});let m=e.textContent.replace(p.ZWSP,"");!m&&o&&(m=decodeURIComponent(o.replace("https://","").replace("http://","")),m.length>p.SIZE_LINK_TEXT_MAX&&(m=m.substring(0,p.SIZE_LINK_TEXT_MAX)+"..."),e.innerHTML=Lute.EscapeHTMLStr(m)),r[1].value=m,r[1].addEventListener("compositionend",()=>{e.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()||"*")}),r[1].addEventListener("input",f=>{f.isComposing||(e.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim())||"*")}),r[1].addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),f.shiftKey?r[0].focus():r[2].focus();else if(ai(f))return}),r[2].value=Lute.UnEscapeHTMLStr(e.getAttribute("data-title")||""),r[2].addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&f.shiftKey&&!f.isComposing)f.preventDefault(),f.stopPropagation(),r[1].focus();else if(ai(f))return}),u.addEventListener("click",f=>{let g=f.target;for(;g;){if(g.dataset.action==="copy"){Be(g.parentElement.nextElementSibling.value),de(window.siyuan.languages.copied);break}g=g.parentElement}})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const u=document.createRange();u.selectNode(e),ne(u),document.execCommand("copy")}}).element),t.disabled&&window.siyuan.menus.menu.append(new N({id:"copyAHref",label:window.siyuan.languages.copyAHref,icon:"iconLink",click(){Be(o)}}).element),t.disabled||(window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const u=document.createRange();u.selectNode(e),ne(u),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new N({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,i.outerHTML,l),we(i,t.toolbar.range),l=i.outerHTML}}).element),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new N({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Uf(o)}}).element),o!=null&&o.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new N({id:"turnIntoRef",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){e.setAttribute("data-subtype","s");const u=e.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),e.setAttribute("data-type",u.join(" ")),e.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",e.removeAttribute("data-href"),e.removeAttribute("data-title"),i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,i.outerHTML,l),t.toolbar.range.selectNode(e),t.toolbar.range.collapse(!1),ne(t.toolbar.range),l=i.outerHTML}}).element),window.siyuan.menus.menu.append(new N({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),Ih(e,"a",t.toolbar.range),le(t,s,i.outerHTML,l),l=i.outerHTML}}).element)),o&&(window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),Vc(t.app,o,!1,!0),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new N(Rf(o)).element)),!t.disabled&&((a=t==null?void 0:t.app)!=null&&a.plugins)&&zn({plugins:t.app.plugins,type:"open-menu-link",detail:{protyle:t,element:e},separatorPosition:"top"});const c=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:c.left,y:c.top+26,h:26});const d=He(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app"),!t.disabled&&(n||t.lute.GetLinkDest(o)||o!=null&&o.startsWith("assets/")?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?e.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-title"),e.getAttribute("data-type").indexOf("a")>-1?e.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-href"),!r[1].value&&(r[0].value||r[2].value)&&(e.textContent="*");const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);u&&!t.element.contains(u.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),ne(t.toolbar.range)),!r[1].value&&!r[0].value&&!r[2].value&&e.remove(),l!==i.outerHTML&&(i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,s,i.outerHTML,l))})},Uh=(t,e)=>{var n;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_TAG);const a=B(e);if(!a)return;ce(["util","toolbar","hint"],t);const i=a.getAttribute("data-node-id");let s=a.outerHTML;window.siyuan.menus.menu.append(new N({id:"tag",iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__block" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(r){const c=r.querySelector("input");c.value=e.textContent.replace(p.ZWSP,""),c.addEventListener("change",()=>{le(t,i,a.outerHTML,s),s=a.outerHTML}),c.addEventListener("compositionend",()=>{e.innerHTML=p.ZWSP+Lute.EscapeHTMLStr(c.value||"")}),c.addEventListener("input",d=>{d.isComposing||(e.innerHTML=p.ZWSP+Lute.EscapeHTMLStr(c.value||""))}),c.addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing){if(d.preventDefault(),d.stopPropagation(),c.value)t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),ne(t.toolbar.range);else{const u=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,i,a.outerHTML,u),we(a,t.toolbar.range)}window.siyuan.menus.menu.remove()}else if(ai(d))return})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){Si(t.app,`#${e.textContent}#`,!1,{method:0})}}).element),window.siyuan.menus.menu.append(new N({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){dw(e.textContent.replace(p.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){t.toolbar.range.setStart(e.firstChild,0),t.toolbar.range.setEnd(e.lastChild,e.lastChild.textContent.length),t.toolbar.setInlineMark(t,"tag","range")}}).element),window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=document.createRange();r.selectNode(e),ne(r),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new N({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){const r=document.createRange();r.selectNode(e),ne(r),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new N({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const r=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,i,a.outerHTML,r),we(a,t.toolbar.range)}}).element),(n=t==null?void 0:t.app)!=null&&n.plugins&&zn({plugins:t.app.plugins,type:"open-menu-tag",detail:{protyle:t,element:e},separatorPosition:"top"});const l=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const o=He(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},wp=(t,e)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_MATH);const n=B(e);if(!n)return;const a=n.getAttribute("data-node-id"),i=n.outerHTML;window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const l=document.createRange();l.selectNode(e),ne(l),document.execCommand("copy")}}).element),t.disabled||(window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const l=document.createRange();l.selectNode(e),ne(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new N({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,a,n.outerHTML,i),we(n,t.toolbar.range)}}).element));const s=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26})},Ml=(t,e,n,a,i,s)=>({id:t===window.siyuan.languages.default?"default":"width_"+t,iconHTML:"",label:t,click(){i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),$l(e.parentElement.parentElement),e.parentElement.style.width=t===window.siyuan.languages.default?"":`calc(${t} - 8px)`,e.style.height="",le(n,a,i.outerHTML,s),oe(i)}}),Pl=(t,e,n,a,i,s)=>({id:t===window.siyuan.languages.default?"default":"width_"+t,iconHTML:"",label:t,click(){i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),e.style.height=t===window.siyuan.languages.default?"":parseInt(t)+"vh",$l(e.parentElement.parentElement),e.parentElement.style.width="",le(n,a,i.outerHTML,s),oe(i)}}),Fx=(t,e)=>{const n=e.getAttribute("data-node-id"),a=e.querySelector("iframe");let i=e.outerHTML;const s=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(o){o.style.maxWidth="none",o.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim(),d=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||d&&d[1])){const u={bvid:Ie("bvid",c)||d&&d[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((g,h)=>{if(!g)return;h===0&&(g=g.substr(1));const b=g.split("=");u[b[0]]=b[1]});let m="https://player.bilibili.com/player.html?";const f=Object.keys(u);f.forEach((g,h)=>{m+=`${g}=${u[g]}`,h<f.length-1&&(m+="&")}),a.setAttribute("src",m),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",c);le(t,n,e.outerHTML,i),i=e.outerHTML,r.stopPropagation()})}}],l=a.getAttribute("src");return l?(s.push({type:"separator"}),s.concat(Vc(t.app,l,!0,!1))):s},Ux=(t,e,n)=>{const a=e.getAttribute("data-node-id"),i=e.querySelector(n==="NodeVideo"?"video":"audio");let s=e.outerHTML;const l=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",c=>{i.setAttribute("src",c.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()),le(t,a,e.outerHTML,s),s=e.outerHTML,c.stopPropagation()})}}],o=i.getAttribute("src");return o&&o.startsWith("assets/")&&(l.push({type:"separator"}),l.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Uf(o)}})),o&&l.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:Vc(t.app,o,!0,!1)}),o&&o.startsWith("assets/")&&l.push(Rf(o)),l},Pv=(t,e,n,a)=>{var i;const s=[],l=Oa(n);(n.rowSpan>1||n.colSpan>1)&&s.push({id:"cancelMerged",label:window.siyuan.languages.cancelMerged,click:()=>{const D=e.outerHTML;let I=n.rowSpan,q=n.parentElement;const Z=n.colSpan;for(;I>0&&q;){let R=q.children[l],F=Z;for(;F>0&&R;)R.classList.remove("fn__none"),R.colSpan=1,R.rowSpan=1,R=R.nextElementSibling,F--;q=q.nextElementSibling,I--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let R;if(Array.from(e.querySelectorAll("thead tr")).find(F=>{if(R=F,Array.from(F.children).forEach(K=>{(K.rowSpan!==1||K.classList.contains("fn__none"))&&(R=void 0)}),R)return!0}),R){const F=e.querySelector("tbody"),K=e.querySelector("thead");for(;R!==K.lastElementChild;)F.insertAdjacentElement("afterbegin",K.lastElementChild)}}ne(a),le(t,e.getAttribute("data-node-id"),e.outerHTML,D)}});const o=e.querySelectorAll("col")[l];(o.style.width||o.style.minWidth!=="60px")&&s.push({id:"useDefaultWidth",label:window.siyuan.languages.useDefaultWidth,click:()=>{const D=e.outerHTML;o.style.width="",o.style.minWidth="60px",le(t,e.getAttribute("data-node-id"),e.outerHTML,D)}});const r=e.getAttribute("custom-pinthead");s.push({id:r?"unpinTableHead":"pinTableHead",icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const D=e.outerHTML;r?e.removeAttribute("custom-pinthead"):e.setAttribute("custom-pinthead","true"),le(t,e.getAttribute("data-node-id"),e.outerHTML,D)}}),s.push({id:"separator_1",type:"separator"}),s.push({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{ei(t,[n],e,"left",a)}}),s.push({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{ei(t,[n],e,"center",a)}}),s.push({id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{ei(t,[n],e,"right",a)}}),s.push({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{ei(t,[n],e,"",a)}});const c=[];c.push(...s),c.push({type:"separator"});const d=e.querySelector("table"),u=n.parentElement.querySelector(".fn__none");let m=!1,f=!1;Array.from(n.parentElement.children).forEach(D=>{D.colSpan>1&&(m=!0),D.rowSpan>1&&(f=!0)});let g=!1,h=!1,b=!1,y=n.parentElement.previousElementSibling;!y&&n.parentElement.parentElement.tagName==="TBODY"&&(y=d.querySelector("thead").lastElementChild),y&&(g=y.querySelector(".fn__none"),Array.from(y.children).forEach(D=>{D.colSpan>1&&(h=!0),D.rowSpan>1&&(b=!0)}));let w=!1,E=!1,C=!1,$=n.parentElement.nextElementSibling;!$&&n.parentElement.parentElement.tagName==="THEAD"&&($=(i=d.querySelector("tbody"))==null?void 0:i.firstElementChild),$&&(w=$.querySelector(".fn__none"),Array.from($.children).forEach(D=>{D.colSpan>1&&(E=!0),D.rowSpan>1&&(C=!0)}));let M=!0;Array.from(d.rows).find(D=>{const I=D.cells[l];if(I.classList.contains("fn__none")||I.colSpan>1||I.rowSpan>1)return M=!1,!0});let k=!0;Array.from(d.rows).find(D=>{const I=D.cells[l+1];if(I&&(I.classList.contains("fn__none")||I.colSpan>1||I.rowSpan>1))return k=!1,!0});let _=!0;Array.from(d.rows).find(D=>{const I=D.cells[l-1];if(I&&(I.classList.contains("fn__none")||I.colSpan>1||I.rowSpan>1))return _=!1,!0});const v=[];v.push({id:"insertRowAbove",icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{hw(t,a,n,e)}}),(!w||w&&!C&&E)&&v.push({id:"insertRowBelow",icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{oh(t,a,n,e)}}),(M||_)&&v.push({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{Wf(t,e,n,"beforebegin",a)}}),(M||k)&&v.push({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{Wf(t,e,n,"afterend",a)}}),c.push(...v);const S=[];((!u||u&&!f&&m)&&(!g||g&&!b&&h)||(!u||u&&!f&&m)&&(!w||w&&!C&&E)||M&&_||M&&k)&&S.push({id:"separator_2",type:"separator"}),(!u||u&&!f&&m)&&(!g||g&&!b&&h)&&S.push({id:"moveToUp",icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{_w(t,a,n,e)}}),(!u||u&&!f&&m)&&(!w||w&&!C&&E)&&S.push({id:"moveToDown",icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{ww(t,a,n,e)}}),M&&_&&S.push({id:"moveToLeft",icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{vw(t,a,n,e)}}),M&&k&&S.push({id:"moveToRight",icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{Ew(t,a,n,e)}}),c.push(...S),(n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&m)||M)&&c.push({type:"separator"});const L=[];return n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&m)&&L.push({id:"deleteRow",icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{bw(t,a,n,e)}}),M&&L.push({id:"deleteColumn",icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{yw(t,a,e,n)}}),c.push(...L),{menus:c,removeMenus:L,insertMenus:v,otherMenus:s,other2Menus:S}},Wx=(t,e)=>{Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(n=>{if(!G(n)){const a=Nt(e,n,!0,!1,!0,!0);return a.doOperations[0].context={focusId:t.currentNodeID},V(e,a.doOperations,a.undoOperations),!0}})},Nt=(t,e,n,a,i=!0,s=!1)=>{if(e.getAttribute("data-type")==="NodeListItem"&&e.childElementCount<4)return{fold:-1};if(e.getAttribute("data-type")==="NodeThematicBreak")return{fold:-1};const l=e.getAttribute("fold")==="1";if(l){if(typeof n=="boolean"&&!n)return{fold:-1};e.removeAttribute("fold"),e.querySelectorAll(".protyle-linenumber__rows").forEach(d=>{or(d.parentElement)})}else{if(typeof n=="boolean"&&n)return{fold:-1};if(e.setAttribute("fold","1"),getSelection().rangeCount>0){const d=getSelection().getRangeAt(0),u=B(d.startContainer);u&&u.getBoundingClientRect().width===0&&oe(e,void 0,!1)}an(["img","av"],e),Ye(t,e)}const o=e.getAttribute("data-node-id"),r=[],c=[];return e.getAttribute("data-type")==="NodeHeading"?l?(i&&e.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),r.push({action:"unfoldHeading",id:o,data:a?"remove":void 0}),c.push({action:"foldHeading",id:o})):(r.push({action:"foldHeading",id:o}),c.push({action:"unfoldHeading",id:o}),rv(e)):(r.push({action:"setAttrs",id:o,data:JSON.stringify({fold:l?"":"1"})}),c.push({action:"setAttrs",id:o,data:JSON.stringify({fold:l?"1":""})})),s||V(t,r,c),ra(t),{fold:l?0:1,undoOperations:c,doOperations:r}};class Zi extends ia{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&A("/api/block/checkBlockExist",{id:this.blockId},i=>{i.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(i){if(i&&this.type==="local")switch(i.cmd){case"rename":this.rootId===i.data.id&&this.parent.updateTitle(i.data.title);break;case"unmount":this.notebookId===i.data.box&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":i.data.ids.includes(this.rootId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.editors=[],this.status={},this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element=e.tab.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__backlink");const n=window.siyuan.config.editor.backlinkSort,a=window.siyuan.config.editor.backmentionSort;this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount" style="margin-left: 0"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" data-sort="${n}" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand}${Pt(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse}${Pt(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount" style="margin-left: 0;"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mSort" data-sort="${a}" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mExpand" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.expand}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="mCollapse" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.collapse}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="layout" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.down}">
        <svg><use xlink:href="#iconDown"></use></svg>
    </span>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.inputsElement=this.element.querySelectorAll("input"),this.inputsElement.forEach(i=>{i.addEventListener("blur",s=>{const l=s.target;l.classList.add("fn__none");const o=l.nextElementSibling;l.value?(o.classList.add("block__icon--active"),o.setAttribute("aria-label",window.siyuan.languages.filter+" "+l.value)):(o.classList.remove("block__icon--active"),o.setAttribute("aria-label",window.siyuan.languages.filter))}),i.addEventListener("keydown",s=>{!s.isComposing&&s.key==="Enter"&&this.searchBacklinks()})}),this.tree=new kc({element:this.element.querySelector(".backlinkList"),data:null,click:i=>{var s;this.toggleItem(i,!1),this.setFocus(),(s=this.mTree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},ctrlClick:i=>{var s;ve({app:e.app,id:i.getAttribute("data-node-id"),action:[p.CB_GET_CONTEXT]}),(s=this.mTree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},altClick(i){var s;ve({app:e.app,id:i.getAttribute("data-node-id"),position:"right",action:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT]}),(s=this.mTree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},shiftClick(i){var s;ve({app:e.app,id:i.getAttribute("data-node-id"),position:"bottom",action:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT]}),(s=this.mTree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},toggleClick:i=>{var s;this.toggleItem(i,!1),this.setFocus(),(s=this.mTree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")}}),this.mTree=new kc({element:this.element.querySelector(".backlinkMList"),data:null,click:i=>{var s;this.toggleItem(i,!0),this.setFocus(),(s=this.tree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},ctrlClick(i){var s;ve({app:e.app,id:i.getAttribute("data-node-id"),action:[p.CB_GET_CONTEXT]}),(s=this.tree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},altClick(i){var s;ve({app:e.app,id:i.getAttribute("data-node-id"),position:"right",action:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT]}),(s=this.tree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},shiftClick(i){var s;ve({app:e.app,id:i.getAttribute("data-node-id"),position:"bottom",action:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT]}),(s=this.tree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},toggleClick:i=>{var s;this.toggleItem(i,!0),this.setFocus(),(s=this.tree.element.querySelector(".b3-list-item--focus"))==null||s.classList.remove("b3-list-item--focus")},blockExtHTML:`<span class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>`}),this.tree.element.addEventListener("scroll",()=>{this.tree.element.querySelectorAll(".protyle-gutters").forEach(i=>{i.classList.add("fn__none"),i.innerHTML=""}),this.tree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")})}),this.mTree.element.addEventListener("scroll",()=>{this.mTree.element.querySelectorAll(".protyle-gutters").forEach(i=>{i.classList.add("fn__none"),i.innerHTML=""}),this.mTree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")})}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.element.querySelectorAll(".protyle").forEach(i=>{i.classList.add("fn__none")}),this.tree.element.querySelectorAll(".b3-list-item__arrow").forEach(i=>{i.classList.remove("b3-list-item__arrow--open")})}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{Array.from(this.tree.element.firstElementChild.children).forEach(i=>{i.tagName==="LI"&&!i.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(i,!1)})}),this.element.addEventListener("click",i=>{this.setFocus();let s=i.target;for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("block__icon")&&s.parentElement.parentElement===this.element){const l=s.getAttribute("data-type");switch(l){case"refresh":this.refresh();break;case"mExpand":Array.from(this.mTree.element.firstElementChild.children).forEach(o=>{o.tagName==="LI"&&!o.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(o,!0)});break;case"mCollapse":this.mTree.element.querySelectorAll(".protyle").forEach(o=>{o.classList.add("fn__none")}),this.mTree.element.querySelectorAll(".b3-list-item__arrow").forEach(o=>{o.classList.remove("b3-list-item__arrow--open")});break;case"min":nt("backlink").toggleModel("backlink",!1,!0);break;case"search":s.previousElementSibling.classList.remove("fn__none"),s.previousElementSibling.select();break;case"sort":case"mSort":this.showSortMenu(l,s.getAttribute("data-sort")),window.siyuan.menus.menu.popup({x:i.clientX,y:i.clientY}),i.stopPropagation();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),s.setAttribute("aria-label",window.siyuan.languages.up),s.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),s.setAttribute("aria-label",window.siyuan.languages.down),s.querySelector("use").setAttribute("xlink:href","#iconDown")):s.getAttribute("aria-label")===window.siyuan.languages.down?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),s.setAttribute("aria-label",window.siyuan.languages.up),s.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),s.setAttribute("aria-label",window.siyuan.languages.down),s.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.dispatchEvent(new CustomEvent("scroll")),this.mTree.element.dispatchEvent(new CustomEvent("scroll"));break}}s=s.parentElement}}),this.searchBacklinks(!0)}setFocus(){this.type==="local"?gt(this.element.parentElement.parentElement):gt(this.element)}showSortMenu(e,n){const a=i=>{(e==="sort"?this.tree:this.mTree).element.previousElementSibling.querySelector(`[data-type="${e}"]`).setAttribute("data-sort",i);const s=parseInt(i);e==="sort"?window.siyuan.config.editor.backlinkSort=s:window.siyuan.config.editor.backmentionSort=s,A("/api/setting/setEditor",window.siyuan.config.editor),this.searchBacklinks()};window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new N({icon:n==="0"?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{a("0")}}).element),window.siyuan.menus.menu.append(new N({icon:n==="1"?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{a("1")}}).element),window.siyuan.menus.menu.append(new N({icon:n==="4"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{a("4")}}).element),window.siyuan.menus.menu.append(new N({icon:n==="5"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{a("5")}}).element),window.siyuan.menus.menu.append(new N({type:"separator"}).element),window.siyuan.menus.menu.append(new N({icon:n==="9"?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{a("9")}}).element),window.siyuan.menus.menu.append(new N({icon:n==="10"?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{a("10")}}).element),window.siyuan.menus.menu.append(new N({icon:n==="2"?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{a("2")}}).element),window.siyuan.menus.menu.append(new N({icon:n==="3"?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{a("3")}}).element)}toggleItem(e,n){var a;const i=(a=e.firstElementChild)==null?void 0:a.firstElementChild;if(!i||i.getAttribute("disabled"))return;i.setAttribute("disabled","disabled");const s=e.getAttribute("data-node-id");if(i.classList.contains("b3-list-item__arrow--open"))i.classList.remove("b3-list-item__arrow--open"),this.editors.find((l,o)=>{if(l.protyle.block.rootID===s&&e.nextElementSibling&&l.protyle.element===e.nextElementSibling)return l.destroy(),this.editors.splice(o,1),e.nextElementSibling.remove(),!0}),i.removeAttribute("disabled");else{const l=n?this.inputsElement[1].value:this.inputsElement[0].value;A(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:this.blockId,refTreeID:s,highlight:!ca(),keyword:l},o=>{i.removeAttribute("disabled"),i.classList.add("b3-list-item__arrow--open");const r=document.createElement("div");r.style.minHeight="auto",r.setAttribute("data-defid",this.blockId),r.setAttribute("data-ismention",n?"true":"false"),e.after(r);const c=new ba(this.app,r,{blockId:s,click:{preventInsetEmptyBlock:!0},backlinkData:n?o.data.backmentions:o.data.backlinks,render:{background:!1,gutter:!0,scroll:!1,breadcrumb:!1}});c.protyle.notebookId=e.getAttribute("data-notebook-id"),Ac(c.protyle,o.data.keywords),this.editors.push(c)})}}refresh(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');!this.blockId||e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),A("/api/ref/refreshBacklink",{id:this.blockId},()=>{e.classList.remove("fn__rotate"),this.searchBacklinks()}))}searchBacklinks(e=!1){const n=this.element.querySelector('.block__icon[data-type="refresh"] svg');n.classList.contains("fn__rotate")||(n.classList.add("fn__rotate"),A("/api/ref/getBacklink2",{sort:parseInt(this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort")).toString(),mSort:parseInt(this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort")).toString(),k:this.inputsElement[0].value,mk:this.inputsElement[1].value,id:this.blockId},a=>{e||this.saveStatus(),this.render(a.data)}))}saveStatus(){this.status[this.blockId]={sort:parseInt(this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort")),mSort:parseInt(this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort")),scrollTop:this.tree.element.scrollTop,mScrollTop:this.mTree.element.scrollTop,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},this.tree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkMOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?this.status[this.blockId].backlinkMStatus=3:this.status[this.blockId].backlinkMStatus=0:this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]').getAttribute("aria-label")===window.siyuan.languages.down?this.status[this.blockId].backlinkMStatus=1:this.status[this.blockId].backlinkMStatus=2}render(e){e||(e={box:"",backlinks:[],backmentions:[],linkRefsCount:0,mentionsCount:0,k:"",mk:""}),this.editors.forEach(s=>{s.destroy()}),this.editors=[],this.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate"),this.notebookId=e.box,this.inputsElement[0].value=e.k,this.inputsElement[1].value=e.mk,this.tree.updateData(e.backlinks),this.mTree.updateData(e.backmentions);const n=this.element.querySelector(".listCount");e.linkRefsCount===0?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=e.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");e.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=e.mentionsCount.toString()),this.status[this.blockId]||(this.status[this.blockId]={sort:window.siyuan.config.editor.backlinkSort,mSort:window.siyuan.config.editor.backmentionSort,scrollTop:0,mScrollTop:0,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},e.mentionsCount===0||window.siyuan.config.editor.backmentionExpandCount===-1?this.status[this.blockId].backlinkMStatus=3:(Array.from({length:window.siyuan.config.editor.backmentionExpandCount}).forEach((s,l)=>{e.backmentions[l]&&this.status[this.blockId].backlinkMOpenIds.push(e.backmentions[l].id)}),e.mentionsCount===0?this.status[this.blockId].backlinkMStatus=3:e.linkRefsCount===0?this.status[this.blockId].backlinkMStatus=0:this.status[this.blockId].backlinkMStatus=1),e.linkRefsCount>0&&Array.from({length:window.siyuan.config.editor.backlinkExpandCount}).forEach((s,l)=>{e.backlinks[l]&&this.status[this.blockId].backlinkOpenIds.push(e.backlinks[l].id)})),this.status[this.blockId].backlinkOpenIds.forEach(s=>{const l=this.tree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);l&&this.toggleItem(l,!1)}),this.status[this.blockId].backlinkMOpenIds.forEach(s=>{const l=this.mTree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);l&&this.toggleItem(l,!0)});const i=this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]');this.status[this.blockId].backlinkMStatus===2||this.status[this.blockId].backlinkMStatus===1?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),this.status[this.blockId].backlinkMStatus===1?(i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")):(i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp"))):this.status[this.blockId].backlinkMStatus===3?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').setAttribute("data-sort",this.status[this.blockId].sort.toString()),this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').setAttribute("data-sort",this.status[this.blockId].mSort.toString()),setTimeout(()=>{this.tree.element.scrollTop=this.status[this.blockId].scrollTop,this.mTree.element.scrollTop=this.status[this.blockId].mScrollTop},p.TIMEOUT_LOAD)}}var Vx=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Ea=(t,e,n,a)=>Vx(void 0,null,function*(){var i,s,l,o,r,c,d,u,m,f,g;(i=t.observerLoad)==null||i.disconnect(),ra(t);const h=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((h==null?void 0:h.length)>0){const L=[],D=[];let I,q=!1;a==="Backspace"?(I=h[0].previousElementSibling,I||(q=!0,I=h[h.length-1].nextElementSibling)):(I=h[h.length-1].nextElementSibling,q=!0,I||(q=!1,I=h[0].previousElementSibling));let Z,R;ce(["select"],t);const F={};for(let K=0;K<h.length;K++){const X=h[K],J=Et(X);R=J.parentElement;const Me=J.getAttribute("data-node-id");if(L.push({action:"delete",id:Me}),a==="Backspace"?(I=Qe(J),I||(q=!0,I=mt(J))):(I=mt(J),q=!0,I||(q=!1,I=Qe(J))),!I&&!t.options.backlinkData&&(I=J.parentElement||t.wysiwyg.element.firstElementChild,q=!1),J.getAttribute("data-type")==="NodeHeading"&&J.getAttribute("fold")==="1"){const me=yield Ae("/api/block/getHeadingDeleteTransaction",{id:J.getAttribute("data-node-id")});L.push(...me.data.doOperations.slice(1));const Pe=J.previousElementSibling?J.previousElementSibling.getAttribute("data-node-id"):"";me.data.undoOperations.forEach((Je,ze)=>{Je.previousID=Pe,ze>0&&(Je.context={ignoreProcess:"true"})}),D.push(...me.data.undoOperations),J.firstElementChild.removeAttribute("contenteditable"),J.remove()}else{let me=J.outerHTML;(J.classList.contains("render-node")||J.querySelector("div.render-node"))&&(me=t.lute.SpinBlockDOM(J.outerHTML));let Pe=J.previousElementSibling?J.previousElementSibling.getAttribute("data-node-id"):"";if(J.previousElementSibling&&J.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&J.previousElementSibling.getAttribute("fold")==="1"&&(((s=J.nextElementSibling)==null?void 0:s.getAttribute("data-type"))!=="NodeHeading"||((l=J.nextElementSibling)==null?void 0:l.getAttribute("data-type"))==="NodeHeading"&&((o=J.nextElementSibling)==null?void 0:o.getAttribute("data-subtype"))<J.getAttribute("data-subtype"))){const Je=J.previousElementSibling.getAttribute("data-node-id");if(!F[Je]){const ze=yield Ae("/api/block/getHeadingDeleteTransaction",{id:Je});F[Je]={element:J.previousElementSibling,previousID:ze.data.doOperations[ze.data.doOperations.length-1].id}}Pe=F[Je].previousID}D.push({action:"insert",data:me,id:Me,previousID:Pe,parentID:J.parentElement.getAttribute("data-node-id")||t.block.parentID}),J.getAttribute("data-subtype")==="o"&&J.classList.contains("li")?Z=J.parentElement:Z=void 0,J.remove()}}if(Object.keys(F).forEach(K=>{const X=Nt(t,F[K].element,!0,!1,!1,!0);L.push(...X.doOperations),D.splice(0,0,...X.undoOperations)}),I)if(t.block.showAll&&I.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0)setTimeout(()=>{dn({protyle:t,id:t.block.parent2ID,focusId:t.block.parent2ID})},p.TIMEOUT_INPUT*2+100);else{if(I.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0){const K=Lute.NewNodeID(),X=jn(!1,!0,K);I.insertAdjacentElement("afterbegin",X),L.push({action:"insert",data:X.outerHTML,id:K,parentID:I.getAttribute("data-node-id")||t.block.parentID}),D.push({action:"delete",id:K}),I=void 0,we(X,n)}a!=="Backspace"&&q?oe(I):oe(I,void 0,!1),Ye(t,I),Z&&(D.push({action:"update",id:Z.getAttribute("data-node-id"),data:Z.outerHTML}),Tt(Z,1),L.push({action:"update",id:Z.getAttribute("data-node-id"),data:Z.outerHTML}))}if(L.length>0)if(R&&R.getAttribute("data-type")==="NodeSuperBlock"&&R.childElementCount===2){const K=yield Li(t,R,n);V(t,L.concat(K.doOperations),K.undoOperations.concat(D.reverse()))}else V(t,L,D.reverse());if(ce(["util"],t),!I){const K=T(t.element,"sy__backlink",!0);if(K){const X=on(K.getAttribute("data-id"),window.siyuan.layout.layout);if(X instanceof Dt&&X.model instanceof Zi){const J=X.model.editors;J.find((Me,me)=>{if(Me.protyle.element===t.element)return Me.destroy(),J.splice(me,1),Me.protyle.element.previousElementSibling.remove(),Me.protyle.element.remove(),!0})}}}return}const b=e.getAttribute("data-type");if(b==="NodeCodeBlock"&&fe(e).textContent.trim()===""){e.classList.add("protyle-wysiwyg--select"),Ea(t,e,n,a);return}if(!e.previousElementSibling&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){a!=="Delete"&&n.insertNode(document.createElement("wbr"));const L=e.parentElement;L.insertAdjacentElement("beforebegin",e),L.childElementCount===1?(V(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(r=e.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"delete",id:L.getAttribute("data-node-id")}],[{action:"insert",id:L.getAttribute("data-node-id"),data:L.outerHTML,previousID:(c=e.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"move",id:e.getAttribute("data-node-id"),parentID:L.getAttribute("data-node-id")}]),L.remove()):V(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(d=e.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:e.getAttribute("data-node-id"),parentID:L.getAttribute("data-node-id")}]),a==="Delete"?Nl(e,n,!0):we(e,n);return}if(e.parentElement.classList.contains("li")&&e.getAttribute("data-type")!=="NodeHeading"&&e.previousElementSibling.classList.contains("protyle-action")){Yx(t,e,n,a==="Delete");return}const y=Qe(e);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(b)){if(y)if(y.classList.contains("p")&&fe(y).textContent===""){const L=Qe(y);V(t,[{action:"delete",id:y.getAttribute("data-node-id")}],[{action:"insert",data:y.outerHTML,id:y.getAttribute("data-node-id"),parentID:y.parentElement.getAttribute("data-node-id")||t.block.parentID,previousID:L&&(!y.previousElementSibling||!y.previousElementSibling.classList.contains("protyle-action"))?L.getAttribute("data-node-id"):void 0}]),y.remove()}else oe(y,void 0,!1);return}if(b==="NodeHeading"){e.previousElementSibling&&e.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&e.previousElementSibling.getAttribute("fold")==="1"&&Nt(t,e.previousElementSibling,!0,!1,!1),e.getAttribute("data-type")==="NodeHeading"&&e.getAttribute("fold")==="1"&&Nt(t,e,!0,!1,!1),ka({protyle:t,selectsElement:[e],type:"Blocks2Ps",range:Nl(e,n,a==="Delete")});return}if(e.previousElementSibling&&e.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!y){if(t.wysiwyg.element.childElementCount>1&&fe(e).textContent===""){oe(t.wysiwyg.element.firstElementChild.nextElementSibling);const L=Et(e);V(t,[{action:"delete",id:L.getAttribute("data-node-id")}],[{action:"insert",data:L.outerHTML,id:L.getAttribute("data-node-id"),parentID:t.block.parentID}]),L.remove()}return}const w=e.parentElement,E=fe(e),C=$t(y);if(n.toString()===""&&Y()&&C&&C.classList.contains("hr")&&_t(E).start===0){V(t,[{action:"delete",id:C.getAttribute("data-node-id")}],[{action:"insert",data:C.outerHTML,id:C.getAttribute("data-node-id"),previousID:(u=C.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:C.parentElement.getAttribute("data-node-id")}]),C.remove();return}const $=C&&(C.classList.contains("table")||C.classList.contains("render-node")||C.classList.contains("iframe")||C.classList.contains("hr")||C.classList.contains("av")||C.classList.contains("code-block")),M=C.getAttribute("data-node-id");if($){if(C.classList.contains("code-block")){if(E.textContent.trim()===""){const L=e.getAttribute("data-node-id"),D=[{action:"delete",id:L}],I=[{action:"insert",data:e.outerHTML,id:L,previousID:(m=e.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:e.parentElement.getAttribute("data-node-id")}];if(e.remove(),w.getAttribute("data-type")==="NodeSuperBlock"&&w.childElementCount===2){const q=yield Li(t,w);V(t,D.concat(q.doOperations),q.undoOperations.concat(I))}else V(t,D,I);oe(t.wysiwyg.element.querySelector(`[data-node-id="${M}"]`),void 0,!1)}else oe(C,void 0,!1);return}if(E.textContent!==""||e.classList.contains("av")){oe(C,void 0,!1);return}}const k=ys(e),_=k.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const v=[{action:"update",data:C.outerHTML,id:M},{action:"insert",data:k.outerHTML,id:_,previousID:(f=e.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:w.getAttribute("data-node-id")}],S=[{action:"delete",id:_}];if($)k.remove(),oe(C,void 0,!1),v.splice(0,1);else{const L=fe(C);if(E&&(E.textContent!==""||E.querySelector(".emoji"))&&(n.setEndAfter(E.lastChild),(((g=L==null?void 0:L.lastElementChild)==null?void 0:g.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const R=Ge(L==null?void 0:L.lastElementChild);R&&R.textContent===`
`&&R.remove()}if(L){let R=L.lastChild;R&&R.nodeType===3&&(R.textContent||(R=pt(R)),R&&R.nodeType===3&&R.textContent.endsWith(`
`)&&(R.textContent=R.textContent.slice(0,-1)))}const D=t.contentElement.scrollTop,I=n.extractContents();n.selectNodeContents(L),n.collapse(!1),n.insertNode(I);const q=L.innerHTML.trimStart(),Z=L.textContent.trimStart();if((q.startsWith("```")||q.startsWith("\xB7\xB7\xB7")||q.startsWith("~~~")||q.indexOf("\n```")>-1&&Z.indexOf("\n```")>-1||q.indexOf(`
~~~`)>-1&&Z.indexOf(`
~~~`)>-1||q.indexOf(`
\xB7\xB7\xB7`)>-1&&Z.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(q.indexOf(`
`)===-1&&q.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let R=L.innerHTML.replace(/\n(~||`){3,}/g,"\n```").trim().replace(/^(~||`){3,}/g,"```");R.endsWith("\n```")||(R+="\n```"),L.innerHTML=R}C.outerHTML=t.lute.SpinBlockDOM(C.outerHTML),Nn(Qe(k)),k.remove(),t.contentElement.scrollTop=D,t.scroll.lastScrollTop=D-1,S.push({action:"update",data:C.outerHTML,id:M})}if(w.getAttribute("data-type")==="NodeSuperBlock"&&w.childElementCount===2){const L=yield Li(t,w);V(t,S.concat(L.doOperations),L.undoOperations.concat(v))}else V(t,S,v);we(t.wysiwyg.element,n)}),Nl=(t,e,n)=>{if(n){const a=Qe(t);if(a){const i=fe($t(a));if(i)return Yt(i,e,!1)}}},Wh=(t,e,n,a)=>{const i=e.outerHTML,s=pt(t);s&&s.textContent.endsWith(p.ZWSP)&&(s.textContent=s.textContent.substring(0,s.textContent.length-1));const l=Ge(t);l&&l.textContent.startsWith(p.ZWSP)&&(l.textContent=l.textContent.replace(p.ZWSP,"")),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),le(a,e.getAttribute("data-node-id"),e.outerHTML,i),we(e,n);const o=fe(e);o.innerHTML.trim()===""&&(o.innerHTML="")},Yx=(t,e,n,a=!1)=>{var i;if(!e.parentElement.previousElementSibling&&e.parentElement.nextElementSibling&&e.parentElement.nextElementSibling.classList.contains("protyle-attr")){qc(t,[e.parentElement],n,a,e);return}if(!e.parentElement.previousElementSibling&&e.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const m=e.parentElement.parentElement,f=m.outerHTML,g=e.parentElement.parentElement.previousElementSibling.lastElementChild,h=g.parentElement.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove(),g.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),m.getAttribute("data-subtype")==="o"&&Tt(m),V(t,[{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML},{action:"update",data:g.parentElement.outerHTML,id:g.parentElement.getAttribute("data-node-id")}],[{action:"update",data:h,id:g.parentElement.getAttribute("data-node-id")},{action:"update",data:f,id:m.getAttribute("data-node-id")}]),we(g.parentElement,n);return}if(!e.parentElement.previousElementSibling){if(e.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;Nl(e,n,a),n.insertNode(document.createElement("wbr"));const m=e.parentElement.parentElement,f=m.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove();const g=document.createElement("div");g.innerHTML=e.parentElement.innerHTML;const h=[],b=[];if(Array.from(g.children).forEach((y,w)=>{var E;h.push({action:"insert",id:y.getAttribute("data-node-id"),data:y.outerHTML,previousID:w===0?(E=m.previousElementSibling)==null?void 0:E.getAttribute("data-node-id"):h[w-1].id,parentID:m.parentElement.getAttribute("data-node-id")||t.block.parentID}),b.push({action:"delete",id:y.getAttribute("data-node-id")})}),m.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),m.getAttribute("data-subtype")==="o"&&Tt(m,parseInt(m.firstElementChild.getAttribute("data-marker"))-1),h.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML}),b.push({action:"update",data:f,id:m.getAttribute("data-node-id")}),V(t,h,b),m.parentElement.classList.contains("sb")&&m.parentElement.getAttribute("data-sb-layout")==="col"){const y=[];let w=m;for(;w&&(y.push(w),b[0].id!==w.getAttribute("data-node-id"));)w=w.previousElementSibling;ga({protyle:t,selectsElement:y.reverse(),type:"BlocksMergeSuperBlock",level:"row"})}we(t.wysiwyg.element,n);return}const s=e.parentElement;if(s.previousElementSibling&&s.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const l=s.getAttribute("data-node-id"),o=s.parentElement;Nl(e,n,a),n.insertNode(document.createElement("wbr"));const r=o.outerHTML,c=[],d=[{action:"insert",id:l,data:"",previousID:s.previousElementSibling.getAttribute("data-node-id")}],u=s.previousElementSibling.lastElementChild;if(s.previousElementSibling.getAttribute("fold")==="1")if(fe(e).textContent.trim()===""&&e.nextElementSibling.classList.contains("protyle-attr"))c.push({action:"delete",id:l}),d[0].data=s.outerHTML,Yt(fe(s.previousElementSibling),n),n.collapse(!0),s.remove();else{Yt(fe(s.previousElementSibling),n),n.collapse(!0),ne(n),(i=e.querySelector("wbr"))==null||i.remove();return}else{let m=u.previousElementSibling.getAttribute("data-node-id");Array.from(e.parentElement.children).forEach((f,g)=>{if(f.classList.contains("protyle-action")||f.classList.contains("protyle-attr"))return;const h=f.getAttribute("data-node-id");c.push({action:"move",id:h,previousID:m}),d.push({action:"move",id:h,previousID:g===1?void 0:m,parentID:l}),m=h,u.before(f)}),c.push({action:"delete",id:l}),d[0].data=s.outerHTML,s.remove()}o.classList.contains("protyle-wysiwyg")?V(t,c,d):(o.getAttribute("data-subtype")==="o"&&Tt(o),le(t,o.getAttribute("data-node-id"),o.outerHTML,r)),we(u.parentElement,n)},Tt=(t,e)=>{if(t.getAttribute("data-subtype")!=="o")return;let n;Array.from(t.children).forEach((a,i)=>{a.classList.contains("li")&&(i===0?e?(n=e,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."))})},Hl=(t,e=0,n=!1)=>{const a=document.createElement("template"),i=t.getAttribute("data-subtype");if(i==="o"){const s=parseInt(t.getAttribute("data-marker"))+e;a.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${vp(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${vp(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${vp(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},zx=(t,e,n)=>{var a;const i=T(e,"li");if(!i)return;const s=(a=i.querySelector(".list"))==null?void 0:a.lastElementChild.previousElementSibling;if(!s)return;const l=Hl(s,0,!0),o=l.getAttribute("data-node-id");s.after(l),s.parentElement.getAttribute("fold")==="1"&&Nt(t,s.parentElement,!0),i.getAttribute("fold")==="1"&&Nt(t,i,!0),V(t,[{action:"insert",id:o,data:l.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:o}]),we(l,n)},Vh=(t,e,n)=>{if(e.forEach(s=>{s.removeAttribute("select-start"),s.removeAttribute("select-end")}),!e[0].classList.contains("li"))if(e[0].parentElement.childElementCount===e.length+2)e=[e[0].parentElement];else return;const a=e[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr"));const i=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=a.lastElementChild.previousElementSibling.outerHTML,l=[],o=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");e.forEach((d,u)=>{l.push({action:"move",id:d.getAttribute("data-node-id"),previousID:c}),o.push({action:"move",id:d.getAttribute("data-node-id"),previousID:u===0?a.getAttribute("data-node-id"):c}),c=d.getAttribute("data-node-id"),d.setAttribute("data-subtype",r);const m=d.querySelector(".protyle-action");r==="o"?(m.classList.add("protyle-action--order"),m.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d)):r==="t"?(d.setAttribute("data-marker","*"),m.innerHTML=`<svg><use xlink:href="#icon${d.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,m.classList.remove("protyle-action--order"),m.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d)):(d.setAttribute("data-marker","*"),m.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',m.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d))}),r==="o"?(Tt(a.lastElementChild.previousElementSibling),Tt(a.parentElement)):a.getAttribute("data-subtype")==="o"&&Tt(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(l.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),o.push({action:"update",data:s,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),V(t,l,o))}else{const s=a.outerHTML,l=e[0].getAttribute("data-subtype"),o=document.createElement("div"),r=Lute.NewNodeID();o.setAttribute("data-node-id",r),o.setAttribute("data-type","NodeList"),o.setAttribute("class","list"),o.setAttribute("data-subtype",l),o.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:o.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(o);const d=[];let u;e.forEach((m,f)=>{c.push({action:"move",id:m.getAttribute("data-node-id"),parentID:r,previousID:u}),d.push({action:"move",id:m.getAttribute("data-node-id"),previousID:f===0?a.getAttribute("data-node-id"):u}),u=m.getAttribute("data-node-id"),o.lastElementChild.before(m)}),d.push({action:"delete",id:r}),l==="o"&&(Tt(o,1),Tt(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),d.push({action:"update",data:s,id:a.getAttribute("data-node-id")}),V(t,c,d))}a.parentElement.classList.contains("protyle-wysiwyg")||le(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,i),we(a,n)},Gx=(t,e,n)=>{var a,i;const s=e.parentElement;if(!s.previousElementSibling){Ea(t,e,n,"Backspace");return}const l=s.getAttribute("data-node-id"),o=[],r=[];n.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let d="",u=0;Array.from(s.parentElement.children).forEach(f=>{!u&&f===s?u=1:u&&!f.classList.contains("protyle-attr")&&(r.push({id:f.getAttribute("data-node-id"),action:"move",previousID:l}),o.push({id:f.getAttribute("data-node-id"),action:"delete"}),f.getAttribute("data-subtype")==="o"&&(r.push({id:f.getAttribute("data-node-id"),action:"update",data:f.outerHTML}),f.setAttribute("data-marker",u+"."),f.firstElementChild.innerHTML=u+"."),d+=f.outerHTML,f.remove(),u++)}),r.reverse(),d=`<div data-subtype="${s.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${Q().format("YYYYMMDDHHmmss")}">${d}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,s.parentElement.insertAdjacentHTML("afterend",d),o.push({id:c,action:"insert",previousID:s.parentElement.getAttribute("data-node-id"),data:d}),r.push({id:c,action:"delete"}),Array.from(s.children).reverse().forEach(f=>{!f.classList.contains("protyle-action")&&!f.classList.contains("protyle-attr")&&(o.push({id:f.getAttribute("data-node-id"),action:"move",previousID:s.parentElement.getAttribute("data-node-id")}),r.push({id:f.getAttribute("data-node-id"),action:"move",parentID:l}),s.parentElement.after(f))});const m=s.parentElement.getAttribute("data-node-id");s.parentElement.childElementCount===2?(r.splice(0,0,{id:m,action:"insert",data:s.parentElement.outerHTML,previousID:(a=s.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:s.parentElement.parentElement.getAttribute("data-node-id")||t.block.rootID}),s.parentElement.remove(),o.push({id:m,action:"delete"})):(r.splice(0,0,{id:l,action:"insert",data:s.outerHTML,previousID:(i=s.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:m}),s.remove(),o.push({id:l,action:"delete"})),V(t,o,r),we(t.wysiwyg.element,n)},qc=(t,e,n,a=!1,i)=>{var s,l,o,r,c,d,u,m;if(e.forEach(_=>{_.removeAttribute("select-start"),_.removeAttribute("select-end")}),!e[0].classList.contains("li"))if(e[0].parentElement.childElementCount===e.length+2)e=[e[0].parentElement];else return;const f=e[0].parentElement,g=f.getAttribute("data-node-id");if(!g)return;const h=f.parentElement,b=h.parentElement;if((s=f.previousElementSibling)!=null&&s.classList.contains("protyle-action")&&!b.getAttribute("data-node-id"))return;if(h.classList.contains("protyle-wysiwyg")||h.classList.contains("sb")||h.classList.contains("bq")){const _=[],v=[];n.collapse(!1),Nl(i,n,a),n.insertNode(document.createElement("wbr"));let S;!e[0].previousElementSibling&&f.getAttribute("data-subtype")==="o"&&(S=parseInt(e[0].getAttribute("data-marker")));let L=g,D=f,I=e[e.length-1].nextElementSibling,q=e[e.length-1].lastElementChild.previousElementSibling;if(e.forEach(R=>{Array.from(R.children).forEach((F,K)=>{const X=F.getAttribute("data-node-id");X&&(_.push({action:"move",id:X,previousID:L,parentID:h.getAttribute("data-node-id")||t.block.parentID}),v.push({action:"move",id:X,previousID:K===1?void 0:L,parentID:R.getAttribute("data-node-id"),data:F.contains(n.startContainer)?"focus":""}),L=X,D.after(F),D=F)})}),!window.siyuan.config.editor.listLogicalOutdent&&!I.classList.contains("protyle-attr")){let R;q.getAttribute("data-subtype")!==I.getAttribute("data-subtype")&&(R=Lute.NewNodeID(),q=document.createElement("div"),q.classList.add("list"),q.setAttribute("data-subtype",I.getAttribute("data-subtype")),q.setAttribute("data-node-id",R),q.setAttribute("data-type","NodeList"),q.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),q.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,D.after(q),_.push({action:"insert",id:R,data:q.outerHTML,previousID:D.getAttribute("data-node-id")}));let F;for(;I&&!I.classList.contains("protyle-attr");){_.push({action:"move",id:I.getAttribute("data-node-id"),previousID:F||((l=q.lastElementChild.previousElementSibling)==null?void 0:l.getAttribute("data-node-id")),parentID:q.getAttribute("data-node-id")}),v.push({action:"move",id:I.getAttribute("data-node-id"),parentID:q.getAttribute("data-node-id"),previousID:F||((o=I.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"))}),F=I.getAttribute("data-node-id");const K=I;I=I.nextElementSibling,q.lastElementChild.before(K)}q.getAttribute("data-subtype")==="o"&&(Array.from(q.children).forEach(K=>{const X=K.getAttribute("data-node-id");X&&v.push({action:"update",id:X,data:K.outerHTML})}),Tt(q,1),Array.from(q.children).forEach(K=>{const X=K.getAttribute("data-node-id");X&&_.push({action:"update",id:X,data:K.outerHTML})})),R&&v.push({action:"delete",id:R})}const Z=f.outerHTML;e.forEach(R=>{R.remove()}),f.childElementCount===1?(_.push({action:"delete",id:g}),g===t.block.id&&(t.block.id=t.block.parentID),v.splice(0,0,{action:"insert",data:Z,id:g,previousID:(r=f.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:h.getAttribute("data-node-id")||t.block.parentID}),f.remove()):(f.getAttribute("data-subtype")==="o"&&Tt(f,S),_.push({action:"update",id:g,data:f.outerHTML}),v.splice(0,0,{action:"update",id:g,data:Z})),V(t,_,v),f.childElementCount!==1&&h.classList.contains("sb")&&h.getAttribute("data-sb-layout")==="col"&&ga({protyle:t,selectsElement:[f,f.nextElementSibling],type:"BlocksMergeSuperBlock",level:"row"}),we(h,n);return}if(f.childElementCount===2&&h.childElementCount===3){n.collapse(!1),Nl(i,n,a),n.insertNode(document.createElement("wbr"));const _=h.outerHTML;e[0].firstElementChild.remove(),e[0].lastElementChild.remove(),f.outerHTML=e[0].innerHTML,le(t,h.getAttribute("data-node-id"),h.outerHTML,_),we(h,n);return}n.collapse(!1),Nl(i,n,a),n.insertNode(document.createElement("wbr"));const y=[],w=[],E=(c=e[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id");let C;!e[0].previousElementSibling&&f.getAttribute("data-subtype")==="o"&&(C=parseInt(e[0].getAttribute("data-marker")));const $=h.parentElement.outerHTML;let M=e[e.length-1].nextElementSibling,k=e[e.length-1].lastElementChild.previousElementSibling;if(e.reverse().forEach(_=>{const v=_.getAttribute("data-node-id");y.push({action:"move",id:v,previousID:h.getAttribute("data-node-id")}),w.push({action:"move",id:v,previousID:E,parentID:f.getAttribute("data-node-id")}),h.after(_),(_.getAttribute("data-subtype")==="o"||_.getAttribute("data-subtype")==="t")&&h.getAttribute("data-subtype")==="u"?(w.push({action:"update",id:v,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',_.setAttribute("data-subtype","u"),_.setAttribute("data-marker","*"),_.classList.remove("protyle-task--done"),y.push({action:"update",id:v,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="t")&&h.getAttribute("data-subtype")==="o"?(w.push({action:"update",id:v,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',_.setAttribute("data-subtype","o"),_.setAttribute("data-marker","1."),y.push({action:"update",id:v,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="o")&&h.getAttribute("data-subtype")==="t"&&(w.push({action:"update",id:v,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',_.setAttribute("data-subtype","t"),_.setAttribute("data-marker","*"),y.push({action:"update",id:v,data:_.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!M.classList.contains("protyle-attr")){let _;k.classList.contains("list")||(_=Lute.NewNodeID(),k=document.createElement("div"),k.classList.add("list"),k.setAttribute("data-subtype",M.getAttribute("data-subtype")),k.setAttribute("data-node-id",_),k.setAttribute("data-type","NodeList"),k.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),k.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,y.push({action:"insert",id:_,data:k.outerHTML,previousID:e[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),e[0].lastElementChild.before(k));let v;for(;M&&!M.classList.contains("protyle-attr");){const S=M.getAttribute("data-node-id");M.getAttribute("data-subtype")!==k.getAttribute("data-subtype")&&(w.push({action:"update",id:S,data:M.outerHTML}),M.querySelector(".protyle-action").outerHTML=k.querySelector(".protyle-action").outerHTML,M.setAttribute("data-subtype",k.getAttribute("data-subtype")),M.setAttribute("data-marker",k.getAttribute("data-marker")),y.push({action:"update",id:S,data:M.outerHTML})),y.push({action:"move",id:S,previousID:v||((d=k.lastElementChild.previousElementSibling)==null?void 0:d.getAttribute("data-node-id")),parentID:k.getAttribute("data-node-id")}),w.push({action:"move",id:S,previousID:v||((u=k.parentElement)==null?void 0:u.getAttribute("data-node-id"))}),v=S;const L=M;M=M.nextElementSibling,k.lastElementChild.before(L)}k.getAttribute("data-subtype")==="o"&&(Array.from(k.children).forEach(S=>{const L=S.getAttribute("data-node-id");L&&w.push({action:"update",id:L,data:S.outerHTML})}),Tt(k,1),Array.from(k.children).forEach(S=>{const L=S.getAttribute("data-node-id");L&&y.push({action:"update",id:L,data:S.outerHTML})})),_&&w.push({action:"delete",id:_})}if(!window.siyuan.config.editor.listLogicalOutdent&&f.nextElementSibling){M=f.nextElementSibling;let _;for(;M&&!M.classList.contains("protyle-attr");){const v=M.getAttribute("data-node-id");y.push({action:"move",id:v,previousID:_||k.getAttribute("data-node-id")}),w.push({action:"move",id:v,previousID:_||f.getAttribute("data-node-id")}),_=v;const S=M;M=M.nextElementSibling,k.after(S),k=S}}f.childElementCount===1&&h.childElementCount===3?(y.push({action:"delete",id:h.getAttribute("data-node-id")}),w.splice(0,0,{action:"insert",id:h.getAttribute("data-node-id"),data:h.outerHTML,previousID:(m=h.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:h.parentElement.getAttribute("data-node-id")}),h.remove()):f.childElementCount===1?(y.push({action:"delete",id:f.getAttribute("data-node-id")}),w.splice(0,0,{action:"insert",id:f.getAttribute("data-node-id"),data:f.outerHTML,previousID:f.previousElementSibling.getAttribute("data-node-id")}),f.remove()):f.getAttribute("data-subtype")==="o"&&(w.splice(0,0,{action:"update",data:f.outerHTML,id:f.getAttribute("data-node-id")}),Tt(f,C),y.push({action:"update",data:f.outerHTML,id:f.getAttribute("data-node-id")})),b.classList.contains("protyle-wysiwyg")?V(t,y,w):(h&&h.getAttribute("data-subtype")==="o"&&Tt(b),le(t,b.getAttribute("data-node-id"),b.outerHTML,$)),we(b,n)};var jx=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Li=(t,e,n)=>jx(void 0,null,function*(){var a;const i=[],s=[];let l=e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0;e.classList.remove("protyle-wysiwyg--select"),e.removeAttribute("select-start"),e.removeAttribute("select-end");const o=e.getAttribute("data-node-id"),r=e.cloneNode();r.innerHTML=e.lastElementChild.outerHTML;let c=(a=e.parentElement)==null?void 0:a.getAttribute("data-node-id");if(!l&&!c)if(t.block.showAll||t.options.backlinkData){const d=yield Ae("/api/block/getBlockSiblingID",{id:o});l=d.data.previous,c=d.data.parent}else c=t.block.rootID;return s.push({action:"insert",id:o,data:r.outerHTML,previousID:l,parentID:c}),Array.from(e.children).forEach((d,u)=>{if(u===e.childElementCount-1){i.push({action:"delete",id:o}),n&&fe(e).insertAdjacentHTML("afterbegin","<wbr>"),e.lastElementChild.remove(),e.replaceWith(...e.children),n&&we(t.wysiwyg.element,n);return}i.push({action:"move",id:d.getAttribute("data-node-id"),previousID:l,parentID:c}),s.push({action:"move",id:d.getAttribute("data-node-id"),previousID:d.previousElementSibling?d.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:o}),l=d.getAttribute("data-node-id")}),Nn(t.wysiwyg.element),i.forEach(d=>{const u=t.wysiwyg.element.querySelector(`[data-node-id="${d.id}"]`);u&&u.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(u.removeAttribute("data-render"),We(t,u))}),{doOperations:i,undoOperations:s,previousId:l}}),Nv=(t,e,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",e||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",t),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,a},Xo=(t,e,n)=>{A("/api/block/getBlockSiblingID",{id:e.getAttribute("data-node-id")},a=>{const i=a.data[n];i&&ve({app:t.app,id:i,action:i!==t.block.rootID&&t.block.showAll?[p.CB_GET_ALL,p.CB_GET_FOCUS]:[p.CB_GET_FOCUS]})})},Gn=(t,e,n)=>{var a;const i=ke(t.wysiwyg.element);let s;if(n)s=t.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const d=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");d.length>0?(e==="beforebegin"?s=d[0]:s=d[d.length-1],ce(["select"],t)):(s=B(i.startContainer),s=Et(s),s.classList.contains("list")?s=T(i.startContainer,"li"):s.classList.contains("bq")&&(s=B(i.startContainer)))}if(!s)return;(a=t.observerLoad)==null||a.disconnect();let l=jn(!1,!0),o=1;s.getAttribute("data-type")==="NodeListItem"?(l=Hl(s,0,!0),o=parseInt(s.parentElement.firstElementChild.getAttribute("data-marker"))):e==="beforebegin"&&s.previousElementSibling&&s.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&s.previousElementSibling.getAttribute("fold")==="1"?l=Fc(s.previousElementSibling,!1,!0):e==="afterend"&&s&&s.getAttribute("data-type")==="NodeHeading"&&s.getAttribute("fold")==="1"&&(l=Fc(s,!1,!0));const r=s.parentElement.outerHTML,c=l.getAttribute("data-node-id");if(s.insertAdjacentElement(e,l),s.getAttribute("data-type")==="NodeListItem"&&s.getAttribute("data-subtype")==="o"&&!l.parentElement.classList.contains("protyle-wysiwyg"))Tt(l.parentElement,o),le(t,l.parentElement.getAttribute("data-node-id"),l.parentElement.outerHTML,r);else{let d;e==="beforebegin"?d=[{action:"insert",data:l.outerHTML,id:c,nextID:s.getAttribute("data-node-id")}]:d=[{action:"insert",data:l.outerHTML,id:c,previousID:s.getAttribute("data-node-id")}],V(t,d,[{action:"delete",id:c}])}s.parentElement.classList.contains("sb")&&s.parentElement.getAttribute("data-sb-layout")==="col"&&ga({protyle:t,selectsElement:e==="afterend"?[s,s.nextElementSibling]:[s.previousElementSibling,s],type:"BlocksMergeSuperBlock",level:"row"}),we(t.wysiwyg.element,i),Ye(t)},vp=(t=!0,e=!0,n)=>{let a="";return t&&(a=p.ZWSP),e&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${p.ZWSP}</div></div>`},jn=(t=!0,e=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${t?p.ZWSP:""}${e?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,a},Fc=(t,e=!1,n=!1)=>{const a=`<div data-subtype="${t.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeHeading" class="${t.className}"><div contenteditable="true" spellcheck="false">${n?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;if(e)return a;{const i=document.createElement("template");return i.innerHTML=a,i.content.firstElementChild}},Kx=t=>{let e=t;switch(t){case"NodeIFrame":e="IFrame";break;case"NodeAttributeView":e=window.siyuan.languages.database;break;case"NodeThematicBreak":e=window.siyuan.languages.line;break;case"NodeWidget":e=window.siyuan.languages.widget;break;case"NodeVideo":e=window.siyuan.languages.video;break;case"NodeAudio":e=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":e=window.siyuan.languages.blockEmbed;break}return e},Zx=(t,e,n,a,i)=>{var s;if(e!=="NodeCodeBlock"&&!((s=n.previousElementSibling)!=null&&s.classList.contains("protyle-action--task"))&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const l=a.innerHTML.indexOf("\u3011")+1;let o=a.innerHTML.indexOf("]")+1;o===0?o=l:o>0&&l>0&&(o=Math.min(o,l)),a.removeAttribute("placeholder");const r=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const c=n.parentElement.parentElement,d=c.outerHTML;return c.setAttribute("data-subtype","t"),c.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),r&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(o),le(t,c.getAttribute("data-node-id"),c.outerHTML,d),we(t.wysiwyg.element,i),!0}return!1}else{const c=n.getAttribute("data-node-id"),d=Lute.NewNodeID(),u=Lute.NewNodeID(),m=Lute.NewNodeID(),f=n.outerHTML;return a.innerHTML=a.innerHTML.substring(o),V(t,[{action:"update",id:c,data:n.outerHTML},{action:"insert",id:d,data:`<div data-subtype="t" data-node-id="${d}" updated="${d.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${m}" data-type="NodeListItem" class="li${r?" protyle-task--done":""}" updated="${m.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div><div data-node-id="${u}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:c},{action:"move",id:c,previousID:u},{action:"delete",id:u}],[{action:"move",id:c,previousID:d},{action:"delete",id:d},{action:"update",id:c,data:f}]),n.outerHTML=`<div data-subtype="t" data-node-id="${d}" data-type="NodeList" class="list" updated="${d.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${m}" data-type="NodeListItem" class="li${r?" protyle-task--done":""}" updated="${m.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,we(t.wysiwyg.element,i),!0}}return!1},Jx=(t,e,n,a,i)=>{if(e==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=n.getAttribute("data-node-id"),l=Lute.NewNodeID(),o=Lute.NewNodeID(),r=Lute.NewNodeID(),c=n.outerHTML,d=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),V(t,[{action:"update",id:s,data:n.outerHTML},{action:"insert",id:l,data:`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${o}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:o},{action:"delete",id:o}],[{action:"update",id:s,data:c},{action:"move",id:s,previousID:l},{action:"delete",id:l}]),n.outerHTML=`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,we(t.wysiwyg.element,i),!0}return!1};var Xx=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Ep=(t,e,n,a=!0,i)=>Xx(void 0,null,function*(){var s,l,o,r,c,d;if(!e.parentElement)return;if(e.classList.contains("av")){const M=T(n.startContainer,"av__cursor");M?M.textContent=p.ZWSP:Qh(t,e);return}const u=fe(e),m=e.getAttribute("data-type");if(!u){m==="NodeThematicBreak"?e.innerHTML="<div><wbr></div>":m==="NodeBlockQueryEmbed"?e.lastElementChild.previousElementSibling.innerHTML="<wbr>"+p.ZWSP:m==="NodeMathBlock"||m==="NodeHTMLBlock"?(e.firstElementChild.firstChild.nodeType===3&&e.firstElementChild.firstChild.remove(),e.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+p.ZWSP):m==="NodeIFrame"||m==="NodeWidget"?e.innerHTML="<wbr>"+e.firstElementChild.outerHTML+e.lastElementChild.outerHTML:m==="NodeVideo"?e.firstElementChild.innerHTML="<wbr>"+p.ZWSP+e.firstElementChild.firstElementChild.outerHTML+e.firstElementChild.lastElementChild.outerHTML:m==="NodeAudio"?e.firstElementChild.innerHTML=e.firstElementChild.firstElementChild.outerHTML+"<wbr>"+p.ZWSP:m==="NodeCodeBlock"&&(n.startContainer.textContent=p.ZWSP),we(e,n);return}e.setAttribute("updated",Q().format("YYYYMMDDHHmmss"));const f=document.createElement("wbr");if(n.insertNode(f),i){const M=Ge(f);if(i.inputType==="deleteContentForward"&&M&&M.nodeType===1&&!M.textContent.startsWith(p.ZWSP)){const k=(M.getAttribute("data-type")||"").split(" ");(k.includes("code")||k.includes("kbd")||k.includes("tag"))&&M.insertAdjacentElement("afterbegin",f)}if((i.inputType==="deleteContentBackward"||i.inputType==="deleteContentForward")&&M&&M.nodeType===1&&M.tagName==="BR"){const k=Ge(M);k&&k.nodeType===1&&((s=k.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1&&M.remove(),i.inputType==="deleteContentBackward"&&((l=M.previousSibling.previousSibling)!=null&&l.textContent.endsWith(`
`))&&(M.outerHTML=`
`)}}const g=e.getAttribute("data-node-id");if(m!=="NodeCodeBlock"&&m!=="NodeHeading"&&(u.innerHTML.endsWith(`
<wbr>`)||u.innerHTML.endsWith(`
<wbr>
`))){le(t,g,e.outerHTML,t.wysiwyg.lastHTMLs[g]||e.outerHTML.replace(`
<wbr>`,"<wbr>")),f.remove();return}if(Zx(t,m,e,u,n)||Jx(t,m,e,u,n))return;const h=e.querySelector("br");h&&h.parentElement.tagName!=="TD"&&h.parentElement.tagName!=="TH"&&(h.parentElement.textContent.trim()===""||((r=(o=h.previousSibling)==null?void 0:o.previousSibling)==null?void 0:r.textContent)===`
`)&&h.remove(),m!=="NodeHeading"&&(u.innerHTML.startsWith("\u300B<wbr>")||u.innerHTML.startsWith(p.ZWSP+"\u300B<wbr>")||u.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(u.innerHTML=u.innerHTML.replace("\u300B<wbr>","><wbr>"));const b=u.innerHTML.trimStart(),y=u.textContent.trimStart();if(!((b.startsWith("````")||b.startsWith("\xB7\xB7\xB7\xB7")||b.startsWith("~~~~"))&&b.indexOf(`
`)===-1)){if((b.startsWith("```")||b.startsWith("\xB7\xB7\xB7")||b.startsWith("~~~"))&&b.indexOf(`
`)===-1&&b.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){le(t,g,e.outerHTML,t.wysiwyg.lastHTMLs[g]),f.remove();return}}m==="NodeParagraph"&&(u.innerHTML.startsWith("\xA5\xA5<wbr>")||u.innerHTML.startsWith("\uFFE5\uFFE5<wbr>")||b.indexOf(`
\xA5\xA5<wbr>`)>-1||b.indexOf(`
\uFFE5\uFFE5<wbr>`)>-1)&&(u.innerHTML=u.innerHTML.replace("\xA5\xA5<wbr>","$$$$<wbr>").replace("\uFFE5\uFFE5<wbr>","$$$$<wbr>"));const w=j(n.startContainer,"data-type","block-ref");w&&w.getAttribute("data-subtype")==="d"&&(yield Ae("/api/block/getRefText",{id:w.getAttribute("data-id")})).data!==w.innerHTML.replace("<wbr>","")&&w.setAttribute("data-subtype","s");let E=e.outerHTML,C=!1;if(["---","___","***"].includes(u.textContent)&&m!=="NodeCodeBlock"){E=`<div data-node-id="${g}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const M=e.nextElementSibling;M&&M.getAttribute("data-node-id")?An(M)?C=!0:oe(M):E+=vp(!1,!0)}else{if(m!=="NodeCodeBlock"&&(b.startsWith("```")||b.startsWith("~~~")||b.startsWith("\xB7\xB7\xB7")||b.indexOf("\n```")>-1&&y.indexOf("\n```")>-1||b.indexOf(`
~~~`)>-1&&y.indexOf(`
~~~`)>-1||b.indexOf(`
\xB7\xB7\xB7`)>-1&&y.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(b.indexOf(`
`)===-1&&b.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let M=u.innerHTML.trim().replace(/^(~||`){3,}/g,"```").replace(/\n(~||`){3,}/g,"\n```").trim();M.endsWith("\n```")||(M=M.replace("<wbr>","")+"<wbr>\n```"),u.innerHTML=M,E=e.outerHTML}E=t.lute.SpinBlockDOM(E)}ce(["util"],t,!0),m==="NodeTable"&&e.querySelector(".table__select").removeAttribute("style");const $=document.createElement("template");if($.innerHTML=E,a&&(((c=fe($.content.firstElementChild))==null?void 0:c.innerHTML)!==fe(e).innerHTML||$.content.childElementCount===1&&((d=fe($.content.firstElementChild))==null?void 0:d.innerHTML)==="<wbr>")&&!($.content.childElementCount===1&&$.content.firstElementChild.classList.contains("code-block")&&m==="NodeCodeBlock")){e.getAttribute("data-type")==="NodeHeading"&&e.getAttribute("fold")==="1"&&$.content.firstElementChild.getAttribute("data-subtype")!==e.dataset.subtype&&(Nt(t,e,void 0,void 0,!1),E=E.replace(' fold="1"',""),t.wysiwyg.lastHTMLs[g]=e.outerHTML);let M;e.classList.contains("table")&&(M=e.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(E)?e.outerHTML=E:e.outerHTML=E.replace("</span><wbr>","</span>"+p.ZWSP+"<wbr>"),t.wysiwyg.element.querySelectorAll(`[data-node-id="${g}"]`).forEach(k=>{G(k)||(e=k)}),E.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(e.querySelectorAll('[data-type="inline-math"]')).find(k=>{if(k.dataset.content.indexOf("<wbr>")>-1)return k.setAttribute("data-content",k.dataset.content.replace("<wbr>","")),t.toolbar.showRender(t,k),!0}),E="",Array.from($.content.children).forEach((k,_)=>{const v=k.getAttribute("data-node-id");let S;v===g?S=e:S=t.wysiwyg.element.querySelector(`[data-node-id="${v}"]`);const L=S.getAttribute("data-type");if(L==="NodeCodeBlock"){const D=S.querySelector(".protyle-action__language");D?(window.siyuan.storage[p.LOCAL_CODELANG]&&D.textContent===""&&(D.textContent=window.siyuan.storage[p.LOCAL_CODELANG]),rt(S)):$.content.childElementCount===1&&t.toolbar.showRender(t,S)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(L))L==="NodeMathBlock"&&Nn(S),t.toolbar.showRender(t,S);else if(L==="NodeBlockQueryEmbed")We(t,S),S.getAttribute("data-content")||t.toolbar.showRender(t,S),ce(["hint"],t);else if(L==="NodeThematicBreak"&&C)oe(e);else if(S.querySelectorAll('[data-type~="block-ref"][data-subtype="d"]').forEach(D=>{D.textContent===""&&A("/api/block/getRefText",{id:D.getAttribute("data-id")},I=>{D.innerHTML=I.data})}),Nn(S),_===$.content.childElementCount-1){const D=e.querySelector("wbr");if(D&&D.parentElement.tagName==="SPAN"&&D.parentElement.innerHTML==="<wbr>"){const I=D.parentElement.getAttribute("data-type")||"";(I.includes("sup")||I.includes("u")||I.includes("sub"))&&D.insertAdjacentText("beforebegin",p.ZWSP)}we(t.wysiwyg.element,n),t.hint.render(t),M>0&&(e.firstElementChild.scrollLeft=M)}E+=S.outerHTML})}else e.getAttribute("data-type")==="NodeCodeBlock"?(u.parentElement.removeAttribute("data-render"),rt(e)):(we(t.wysiwyg.element,n),t.hint.render(t));ce(["gutter"],t),Qx(E,t,g)}),Qx=(t,e,n)=>{const a=document.createElement("template");a.innerHTML=t;const i=[],s=[];Array.from(a.content.children).forEach((l,o)=>{var r;l.getAttribute("spellcheck")==="false"&&l.getAttribute("contenteditable")==="false"&&l.setAttribute("contenteditable","true");const c=l.getAttribute("data-node-id");if(c===n)i.push({id:n,data:l.outerHTML,action:"update"}),s.push({id:n,data:e.wysiwyg.lastHTMLs[n],action:"update"}),e.wysiwyg.lastHTMLs[n]=l.outerHTML;else{let d;o===0&&(d=e.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),i.push({action:"insert",data:l.outerHTML,id:c,previousID:o===0?(r=d==null?void 0:d.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):l.previousElementSibling.getAttribute("data-node-id"),parentID:(d==null?void 0:d.parentElement.getAttribute("data-node-id"))||e.block.parentID}),s.push({id:c,action:"delete"})}}),V(e,i,s)};var e0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const t0=(t,e,n,a)=>{const i=document.createElement("template");i.innerHTML=e;let s=[];if(e.endsWith("]")&&e.startsWith("["))try{s=JSON.parse(e)}catch(o){console.warn("insert cell: JSON.parse error")}else i.content.querySelector("table")&&i.content.querySelectorAll("tr").forEach(o=>{s.push([]),Array.from(o.children).forEach(r=>{s[s.length-1].push(r.textContent)})});const l=a.dataset.avId;A("/api/av/getAttributeViewKeysByAvID",{avID:l},o=>e0(void 0,null,function*(){var r,c;const d=o.data,u=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select"))||[];if(s&&Array.isArray(s)&&s.length>0){u.length===0&&a.querySelectorAll(".av__row--select:not(.av__row--header)").forEach($=>{$.querySelectorAll(".av__cell").forEach(M=>{u.push(M)})}),u.length===0&&u.push(a.querySelector(".av__row:not(.av__row--header) .av__cell"));const b=[],y=[],w=a.dataset.nodeId;let E;const C=u[0].getAttribute("data-col-id");for(let $=0;$<s.length&&(E?E=E.nextElementSibling:E=T(u[0].parentElement,"av__row"),!!E.classList.contains("av__row"));$++){let M;for(let k=0;k<s[$].length;k++){const _=s[$][k];if(M?M.nextElementSibling?M=M.nextElementSibling:M.parentElement.classList.contains("av__colsticky")&&(M=M.parentElement.nextElementSibling):M=E.querySelector(`.av__cell[data-col-id="${C}"]`),!M.classList.contains("av__cell"))break;const v=yield Bn(n,a,_,[M],d,e,!0);v.doOperations.length>0&&(b.push(...v.doOperations),y.push(...v.undoOperations))}}b.length>0&&(b.push({action:"doUpdateUpdated",id:w,data:Q().format("YYYYMMDDHHmmss")}),y.push({action:"doUpdateUpdated",id:w,data:a.getAttribute("updated")}),V(n,b,y));return}const m=fe(i.content.firstElementChild);if(m&&m.childNodes.length===1&&((r=m.firstElementChild)==null?void 0:r.getAttribute("data-type"))==="block-ref"){const b=a.querySelector(".av__cell--select");if(b){const y=m.firstElementChild.getAttribute("data-id"),w=Ba(b,a.getAttribute("data-av-type"));V(n,[{action:"replaceAttrViewBlock",avID:l,previousID:w,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:l,previousID:y,nextID:w,isDetached:b.dataset.detached==="true"}]),On(b,{type:"block",isDetached:!1,block:{content:m.firstElementChild.textContent,id:y}});return}}const f=n.lute.BlockDOM2Content(e),g=a.querySelectorAll(".av__row--select"),h=[];if(f.split(`
`).forEach(b=>{h.push(b.split("	"))}),g.length>0&&h.length===1&&h[0].length===1){Bn(n,a,f,void 0,d,e);return}if(g.length>0&&g.forEach(b=>{b.querySelectorAll(".av__cell").forEach(y=>{u.push(y)})}),u.length>0){if(h.length===1&&h[0].length===1)Bn(n,a,f,u,d,e);else{let b;const y=[],w=[],E=u[0].getAttribute("data-col-id");for(let C=0;C<h.length&&(b?b=b.nextElementSibling:b=T(u[0].parentElement,"av__row"),!!b.classList.contains("av__row"));C++){let $;for(let M=0;M<h[C].length&&($?$.nextElementSibling?$=$.nextElementSibling:$.parentElement.classList.contains("av__colsticky")&&($=$.parentElement.nextElementSibling):$=b.querySelector(`.av__cell[data-col-id="${E}"]`),!!$.classList.contains("av__cell"));M++){const k=h[C][M],_=yield Bn(n,a,k,[$],d,e,!0);_.doOperations.length>0&&(y.push(..._.doOperations),w.push(..._.undoOperations))}}if(y.length>0){const C=a.getAttribute("data-node-id");y.push({action:"doUpdateUpdated",id:C,data:Q().format("YYYYMMDDHHmmss")}),w.push({action:"doUpdateUpdated",id:C,data:a.getAttribute("updated")}),V(n,y,w)}}(c=document.querySelector(".av__panel"))==null||c.remove()}else if(T(t.startContainer,"av__title")){const b=document.createTextNode(f);t.insertNode(b),t.setEnd(b,f.length),t.collapse(!1),ne(t),Qh(n,a)}}))},n0=(t,e,n,a)=>{const i=document.createElement("template");i.innerHTML=e;const s=i.content.querySelectorAll("th, td");if(s.length===0)return!1;const l=a.firstElementChild.scrollLeft,o=a.querySelector("table").scrollTop,r=a.querySelector(".table__select");let c=0;const d=[];a.querySelectorAll("th, td").forEach(m=>{!m.classList.contains("fn__none")&&s.length>c&&vi({tableSelectElement:r,scrollLeft:l,scrollTop:o,item:m})&&(d.push(m),c++)}),r.removeAttribute("style");const u=a.outerHTML;return a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),d.forEach((m,f)=>{m.innerHTML=s[f].innerHTML,f===d.length-1&&Yt(m,t,!1)}),t.collapse(!1),le(n,a.getAttribute("data-node-id"),a.outerHTML,u),!0},Ht=(t,e,n=!1,a=!1,i=!1)=>{var s,l,o,r;if(t==="")return;const c=a?e.toolbar.range:ke(e.wysiwyg.element);sy(c);let d;j(c.startContainer,"data-type","NodeTable")&&!n&&(U(c.startContainer,"TABLE")?d=e.lute.BlockDOM2InlineBlockDOM(t):n=!0);let u=B(c.startContainer);if(u||(e.toolbar.range?u=B(e.toolbar.range.startContainer):u=e.wysiwyg.element.firstElementChild),!u)return;if(u.classList.contains("av")){c.deleteContents(),t0(c,t,e,u);return}if(u.classList.contains("table")&&u.querySelector(".table__select").clientWidth>0&&n0(c,t,e,u))return;let m=u.getAttribute("data-node-id");c.insertNode(document.createElement("wbr"));let f=u.outerHTML;const g=u.getAttribute("data-type"),h=g==="NodeCodeBlock",b=fe(u);if(!n&&(h||e.toolbar.getCurrentType(c).includes("code"))){c.deleteContents();let L=!1;h&&b.textContent===""&&(L=!0),c.insertNode(document.createTextNode(t.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),c.collapse(!1),c.insertNode(document.createElement("wbr")),L&&(c.collapse(!1),c.insertNode(document.createTextNode(`
`))),h?((s=u.querySelector('[data-render="true"]'))==null||s.removeAttribute("data-render"),rt(u)):we(u,c),u.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(e,m,u.outerHTML,f),setTimeout(()=>{Ye(e,void 0,"nearest","smooth")},p.TIMEOUT_LOAD);return}const y=[],w=[];if(c.toString()!==""){const L=j(c.commonAncestorContainer,"data-type","inline-math");L?L.remove():c.startContainer.nodeType===3&&((l=c.startContainer.parentElement.getAttribute("data-type"))==null?void 0:l.indexOf("block-ref"))>-1?(c.deleteContents(),c.startContainer.nodeType!==3&&c.startContainer.textContent===""&&c.startContainer.remove()):c.deleteContents(),c.insertNode(document.createElement("wbr")),y.push({action:"update",id:m,data:f}),w.push({action:"update",id:m,data:u.outerHTML})}const E=document.createElement("template");/^\s*&gt;|\*|-|\+|\d*.|\[ \]|[x]/.test(t)&&b.textContent.replace(p.ZWSP,"")!==""&&(d=t);let C=d||t;C=C.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),E.innerHTML=C;let $=!1;if((b.textContent.replace(p.ZWSP,"")!==""||g==="NodeHeading")&&E.content.childElementCount===1&&E.content.firstChild.nodeType!==3&&E.content.firstElementChild.getAttribute("data-type")==="NodeHeading"&&(n=!1,$=!0),!n&&(E.content.firstChild.nodeType===3||$||E.content.firstChild.nodeType!==3&&(E.content.firstElementChild.classList.contains("p")&&E.content.childElementCount===1||E.content.firstElementChild.tagName!=="DIV"))){E.content.firstChild.nodeType!==3&&E.content.firstElementChild.classList.contains("p")&&(E.innerHTML=E.content.firstElementChild.firstElementChild.innerHTML.trim());const L=c.startContainer.nodeType===3?c.startContainer.parentElement:c.startContainer;if(L.tagName==="SPAN"&&L===(c.endContainer.nodeType===3?c.endContainer.parentElement:c.endContainer)&&E.content.querySelector("span, img")){const D=document.createElement("span"),I=L.attributes;for(let q=0;q<I.length;q++)D.setAttribute(I[q].name,I[q].value);c.setEnd(L.lastChild,L.lastChild.textContent.length),D.append(c.extractContents()),L.after(D),c.setStartBefore(D),c.collapse(!0)}c.insertNode(E.content.cloneNode(!0)),c.collapse(!1),(o=u.querySelector("wbr"))==null||o.remove(),e.wysiwyg.lastHTMLs[m]=f,Ep(e,u,c);return}const M=T(u,"li");if(((r=E.content.children[0])==null?void 0:r.getAttribute("data-type"))==="NodeListItem")if(M)u=M,m=u.getAttribute("data-node-id"),f=u.outerHTML;else{const D=E.content.children[0].getAttribute("data-subtype");E.innerHTML=`<div${D==="o"?' data-marker="1."':""} data-subtype="${D}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${t}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`}let k,_=!1;!c.toString()&&i&&_t(u,e.wysiwyg.element,c).start===0&&b.textContent!==""&&(_=!0),(E.content.firstChild.nodeType===3||E.content.firstChild.nodeType===1&&E.content.firstElementChild.tagName!=="DIV")&&(E.innerHTML=e.lute.SpinBlockDOM(E.innerHTML)),(_?Array.from(E.content.children):Array.from(E.content.children).reverse()).find(L=>{let D=L.getAttribute("data-node-id");const I=L.getAttribute("parent-heading");if(D===m)w.push({action:"update",data:L.outerHTML,id:D}),y.push({action:"update",id:D,data:f});else{if(L.classList.contains("li")&&!u.parentElement.classList.contains("list")){D=Lute.NewNodeID();const q=document.createElement("div");q.setAttribute("data-subtype",L.getAttribute("data-subtype")),q.setAttribute("data-node-id",D),q.setAttribute("data-type","NodeList"),q.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),q.classList.add("list"),q.append(L),L=q}L.removeAttribute("parent-heading"),w.push({action:"insert",data:L.outerHTML,id:D,context:{ignoreProcess:I?"true":"false"},nextID:_?m:void 0,previousID:_?void 0:m}),y.push({action:"delete",id:D})}if(!I){const q=[];L.classList.contains("render-node")&&L.getAttribute("data-type")==="NodeCodeBlock"?q.push(L):q.push(...L.querySelectorAll('.render-node[data-type="NodeCodeBlock"]')),q.forEach(Z=>{var R;(R=Z.querySelector(".protyle-icons"))==null||R.remove();const F=Z.querySelector('[spin="1"]');F&&(F.innerHTML=""),Z.removeAttribute("data-render")}),sa(L),_?u.before(L):u.after(L)}k||(k=L)}),b&&b.textContent===""&&u.classList.contains("p")&&(w.find((L,D)=>{if(L.id===m)return w.splice(D,1),!0}),w.push({action:"delete",id:m}),y.find((L,D)=>{if(L.id===m&&L.action==="update")return y.splice(D,1),!0}),y.push({action:"insert",data:f,id:m,previousID:u.previousElementSibling?u.previousElementSibling.getAttribute("data-node-id"):"",parentID:u.parentElement.getAttribute("data-node-id")||e.block.parentID}),u.remove()),k&&oe(k,void 0,!1);const v=e.wysiwyg.element.querySelector("wbr");v&&v.remove();let S;u.getAttribute("data-type")==="NodeHeading"&&u.getAttribute("fold")==="1"&&(S=Nt(e,u,!0,!1,!1,!0),w.reverse(),S.doOperations[0].context={focusId:k==null?void 0:k.getAttribute("data-node-id")},w.push(...S.doOperations),y.push(...S.undoOperations)),V(e,w,y),e.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(L=>{L.remove()})},Hv=t=>{var e,n;if(t){ce(["util"],t),ca()&&(t.highlight.markHL.clear(),t.highlight.mark.clear(),t.highlight.ranges=[],t.highlight.rangeIndex=0),(e=t.observer)==null||e.disconnect(),(n=t.observerLoad)==null||n.disconnect(),t.element.classList.remove("protyle"),t.element.removeAttribute("style"),t.wysiwyg&&(t.wysiwyg.lastHTMLs={}),t.undo&&t.undo.clear();try{t.ws.send("closews",{})}catch(a){setTimeout(()=>{t.ws.send("closews",{})},10240)}t.app.plugins.forEach(a=>{a.eventBus.emit("destroy-protyle",{protyle:t})})}};class a0{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const i0=(t,e)=>{const n=[];let a="",i="";for(let l=e.length,o=0;o<l;o++){const r=e[o];let c=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>t.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${t.options.upload.max/1024/1024}M</li>`,c=!1);const d=r.name.lastIndexOf("."),u=d===-1?"":r.name.substr(d),m=d===-1?r.name:t.options.upload.filename(r.name.substr(0,d))+u;t.options.upload.accept&&(t.options.upload.accept.split(",").some(g=>{const h=g.trim();if(h.indexOf(".")===0){if(u.toLowerCase()===h.toLowerCase())return!0}else if(r.type.split("/")[0]===h.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(n.push(r),i+=`<li>${m} ${window.siyuan.languages.uploading}</li>`)}let s;return(a!==""||i!=="")&&(s=de(`<ul>${a}${i}</ul>`,-1)),{files:n,msgId:s}},Ov=(t,e)=>{var n,a,i;const s=JSON.parse(t);let l="";s.code===1&&(l=`${s.msg}`),s.data.errFiles&&s.data.errFiles.length>0&&(l=`<ul><li>${l}</li>`,s.data.errFiles.forEach(g=>{const h=g.lastIndexOf("."),b=h===-1?g:e.options.upload.filename(g.substr(0,h))+g.substr(h);l+=`<li>${b} ${window.siyuan.languages.uploadError}</li>`}),l+="</ul>"),l&&de(l);let o=!0;const r=ke(e.wysiwyg.element);r.toString()===""&&r.startContainer.nodeType===3&&e.toolbar.getCurrentType(r).length>0&&(r.setEndAfter(r.startContainer.parentElement),r.collapse(!1));const c=Object.keys(s.data.succMap),d=B(r.startContainer);if(d)if(d.classList.contains("table"))o=!1;else{const g=fe(d);g&&d.classList.contains("p")&&(g.textContent!==""||c.length<2)&&(o=!1)}let u="";c.sort((g,h)=>g.localeCompare(h,void 0,{numeric:!0}));const m=[];let f=!1;if(c.forEach((g,h)=>{const b=s.data.succMap[g],y=De().extname(g).toLowerCase(),w=e.options.upload.filename(g),E=w.substring(0,w.length-y.length);f=p.SIYUAN_ASSETS_IMAGE.includes(y),m.push({type:p.SIYUAN_ASSETS_IMAGE.includes(y)?"image":"file",content:b,name:E}),u+=fv(y,b,E,w),!p.SIYUAN_ASSETS_AUDIO.includes(y)&&!p.SIYUAN_ASSETS_VIDEO.includes(y)&&c.length-1!==h&&(d&&d.classList.contains("table")?u+="<br>":o?u+=`

`:u+=`
`)}),document.querySelector(".av__panel")){const g=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(g[0]||(g.splice(0,1),e.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(h=>{Zn(h)==="mAsset"&&g.push(h)}),g.length===0&&((a=(n=document.querySelector(".av__panel .b3-menu__items"))==null?void 0:n.getAttribute("data-ids"))==null||a.split(",").forEach(h=>{const b=e.wysiwyg.element.querySelector(`.av__gallery-fields [data-dtype="mAsset"][data-id="${h}"]`);b&&g.push(b)}))),g.length>0){const h=B(g[0]);if(h){Bn(e,h,m,g),(i=document.querySelector(".av__panel"))==null||i.remove();return}}else return}else if(d&&d.classList.contains("av")){const g=[];if(d.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(h=>{h.querySelectorAll(".av__cell").forEach(b=>{Zn(b)==="mAsset"&&g.push(b)})}),g.length===0&&e.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(h=>{Zn(h)==="mAsset"&&g.push(h)}),g.length>0){Bn(e,d,m,g);return}else return}Ht(u,e,o),setTimeout(()=>{Ye(e,void 0,"nearest","smooth")},f?0:p.TIMEOUT_LOAD)},Yh=(t,e,n)=>{const a=de(window.siyuan.languages.uploading,0);A("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:n,id:e.block.rootID},i=>{At(a);let s="";Object.keys(i.data.succMap).forEach(l=>{i.data.succMap[l].startsWith("file:")&&(s+=l+", ")}),s&&de(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${s.substring(0,s.length-2)}</b>`)),Ov(JSON.stringify(i),e)})},Ai=(t,e,n,a)=>{if(!t){const d=new FormData;for(let m=0,f=e.length;m<f;m++)d.append("file[]",e[m]);const u=new XMLHttpRequest;u.open("POST",p.UPLOAD_ADDRESS),u.onreadystatechange=()=>{u.readyState===XMLHttpRequest.DONE&&(u.status===200?a(u.responseText):u.status===0?de(window.siyuan.languages.fileTypeError):de(u.responseText),n&&(n.value=""))},u.send(d);return}let i=[];for(let d=0;d<e.length;d++){let u=e[d];u instanceof DataTransferItem&&(u=u.getAsFile()),u.size===0&&u.type===""&&u.name.indexOf(".")===-1?Yh([u.path],t,!1):i.push(u)}if(t.options.upload.handler){const d=t.options.upload.handler(i);if(typeof d=="string"){de(d);return}return}if(!t.options.upload.url||!t.upload){n&&(n.value=""),de("please config: options.upload.url");return}if(t.options.upload.file&&(i=t.options.upload.file(i)),t.options.upload.validate){const d=t.options.upload.validate(i);if(typeof d=="string"){de(d);return}}const s=t.wysiwyg.element,l=i0(t,i);if(l.files.length===0){n&&(n.value="");return}const o=new FormData,r=t.options.upload.extraData;for(const d of Object.keys(r))o.append(d,r[d]);for(let d=0,u=l.files.length;d<u;d++)o.append(t.options.upload.fieldName,l.files[d]);o.append("id",t.block.rootID);const c=new XMLHttpRequest;c.open("POST",t.options.upload.url),t.options.upload.token&&c.setRequestHeader("X-Upload-Token",t.options.upload.token),t.options.upload.withCredentials&&(c.withCredentials=!0),t.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(t.upload.isUploading=!1,!document.body.contains(t.element)){Hv(t);return}if(c.status===200)if(At(l.msgId),t.options.upload.success)t.options.upload.success(s,c.responseText);else if(a)a(c.responseText);else{let d=c.responseText;t.options.upload.format&&(d=t.options.upload.format(e,c.responseText)),Ov(d,t)}else c.status===0?de(window.siyuan.languages.fileTypeError):t.options.upload.error?t.options.upload.error(c.responseText):de(c.responseText);n&&(n.value=""),t.upload.element.style.display="none"}},c.upload.onprogress=d=>{if(!d.lengthComputable)return;const u=d.loaded/d.total*100;t.upload.element.style.display="block";const m=t.upload.element;m.style.width=u+"%"},c.send(o)},Uc=(t,e,n,a=!1)=>{let i=Lute.UnEscapeHTMLStr(e),s;if(Ro(i)&&!i.startsWith("file://")&&i.indexOf(".pdf")>-1){const l=i.split("/");l.length===3&&l[0]==="assets"&&l[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(l[2])?(i=`assets/${l[1]}`,s=l[2]):(s=parseInt(Ie("page",i)),i=i.split("?page")[0])}Ro(i)?p.SIYUAN_ASSETS_EXTS.includes(De().extname(i))&&(!i.endsWith(".pdf")||i.endsWith(".pdf")&&i.startsWith("assets/"))?n&&n.altKey?ur(t.app,i,s):n&&n.shiftKey||a?nn(i):ur(t.app,i,s,"right"):nn(i):i&&(0>i.indexOf(":")&&(i=`https://${i}`),nn(i))},kp=(t,e)=>{jt(`${p.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{const n=document.createElement("ul");let a="",i=-1;t.forEach((s,l)=>{s&&(a+=`<li><img src="${s}"></li>`,e&&i===-1&&(e.endsWith(encodeURI(s))||e.endsWith(s))&&(i=l))}),n.innerHTML=a,window.siyuan.viewer=new Viewer(n,{initialViewIndex:e?i:0,title:[1,(s,l)=>{let o=s.alt;return o||(o=s.src.substring(s.src.lastIndexOf("/")+1)),o=o.substring(0,o.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${o} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},Bv=(t,e)=>{A("/api/asset/getDocImageAssets",{id:e},n=>{kp(n.data,t)})},zh=(t,e,n,a)=>{A("/api/av/getCurrentAttrViewImages",{id:e,viewID:n,query:a},i=>{kp(i.data,t)})},Wc=t=>t.startsWith("assets/")&&(t.endsWith(".png")||t.endsWith(".jpg")||t.endsWith(".jpeg"))?t+"?style=thumb":t,Gh=t=>t.startsWith("assets/")&&(t.endsWith(".png?style=thumb")||t.endsWith(".jpg?style=thumb")||t.endsWith(".jpeg?style=thumb"))?t.replace("?style=thumb",""):t,Rv=t=>{t.menuElement.querySelector("input").addEventListener("change",e=>{e.target.files.length!==0&&Ai(t.protyle,e.target.files,e.target,n=>{const a=JSON.parse(n),i=[];Object.keys(a.data.succMap).forEach(s=>{i.push({name:s,content:a.data.succMap[s],type:p.SIYUAN_ASSETS_IMAGE.includes(De().extname(a.data.succMap[s]).toLowerCase())?"image":"file"})}),Ol({protyle:t.protyle,cellElements:t.cellElements,addValue:i,blockElement:t.blockElement})})})},qv=t=>{let e="";Ci("mAsset",t[0]).mAsset.forEach((a,i)=>{let s;a.type==="image"?s=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${a.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${Wc(a.content)}"/>
</span>`:s=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${at(a.content)}" style="max-width: 360px">${a.name||a.content}</span>`,e+=`<button class="b3-menu__item" draggable="true" data-index="${i}" data-name="${at(a.name)}" data-type="${a.type}" data-content="${at(a.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${s}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`});const n=[];return t.forEach(a=>{n.push(a.dataset.id)}),`<div class="b3-menu__items" data-ids="${n}">
    ${e}
    <button data-type="addAssetExist" class="b3-menu__item b3-menu__item--current">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},Ol=t=>{const e=t.blockElement.getAttribute("data-av-type"),n=Xn(t.cellElements[0],e),a=[],i=[];let s;t.cellElements.forEach((o,r)=>{var c,d;const u=Ba(o,e);t.blockElement.contains(o)||(e==="table"?o=t.cellElements[r]=t.blockElement.querySelector(`.av__row[data-id="${u}"] .av__cell[data-col-id="${o.dataset.colId}"]`)||t.blockElement.querySelector(`.fn__flex-1[data-col-id="${o.dataset.colId}"]`):o=t.cellElements[r]=t.blockElement.querySelector(`.av__gallery-item[data-id="${u}"] .av__cell[data-field-id="${o.dataset.fieldId}"]`));const m=Ci(Zn(o)||o.dataset.type,o),f=JSON.parse(JSON.stringify(m));r===0?(typeof t.removeIndex=="number"?m.mAsset.splice(t.removeIndex,1):((c=t.addValue)==null?void 0:c.length)>0?m.mAsset=m.mAsset.concat(t.addValue):t.updateValue?m.mAsset.find((h,b)=>{if(b===t.updateValue.index)return h.content=t.updateValue.value.content,h.type=t.updateValue.value.type,h.name=t.updateValue.value.name,!0}):((d=t.replaceValue)==null?void 0:d.length)>0&&(m.mAsset=t.replaceValue),s=m.mAsset):m.mAsset=s;const g=t.blockElement.getAttribute("data-av-id");a.push({action:"updateAttrViewCell",id:m.id,keyID:n,rowID:u,avID:g,data:m}),i.push({action:"updateAttrViewCell",id:m.id,keyID:n,rowID:u,avID:g,data:f}),o.classList.contains("custom-attr__avvalue")?o.innerHTML=Ji(m):On(o,m)}),a.push({action:"doUpdateUpdated",id:t.blockElement.getAttribute("data-node-id"),data:Q().format("YYYYMMDDHHmmss")}),V(t.protyle,a,i);const l=document.querySelector(".av__panel > .b3-menu");if(l){l.innerHTML=qv(t.cellElements),Rv({protyle:t.protyle,menuElement:l,cellElements:t.cellElements,blockElement:t.blockElement});const o=(t.cellElements[0].classList.contains("custom-attr__avvalue")?t.cellElements[0]:t.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${t.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{Te(l,o.left,o.bottom,o.height)},p.TIMEOUT_LOAD)}},Sp=t=>{const e=Gh(t.content),n=t.type,a=new dt(p.MENU_AV_ASSET_EDIT,()=>{!l[1]&&l[0].value===e||l[1]&&l[0].value===e&&l[1].value===t.name||Ol({protyle:t.protyle,cellElements:t.cellElements,blockElement:t.blockElement,updateValue:{index:t.index,value:{content:l[0].value,name:l[1]?l[1].value:"",type:n}}})});if(a.isOpen)return;n==="file"?(a.addItem({id:"linkAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${Y()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${Y()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`,bind(o){o.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){Be(c.parentElement.nextElementSibling.value),de(window.siyuan.languages.copied);break}c=c.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(`[${l[1].value||l[0].value}](${l[0].value})`)}})):(a.addItem({id:"link",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${Y()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`,bind(o){o.addEventListener("click",r=>{let c=r.target;for(;c;){if(c.dataset.action==="copy"){Be(c.parentElement.nextElementSibling.value),de(window.siyuan.languages.copied);break}c=c.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(`![](${e.replace(/%20/g," ")})`)}}),a.addItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){ah(e)}})),a.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Ol({protyle:t.protyle,cellElements:t.cellElements,blockElement:t.blockElement,removeIndex:t.index})}}),e!=null&&e.startsWith("assets/")&&a.addItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){var o;Uf(e),(o=document.querySelector(".av__panel"))==null||o.remove()}});const i=Vc(t.protyle?t.protyle.app:window.siyuan.ws.app,e,!0,!1);(n!=="file"||i.length>0)&&a.addSeparator({id:"separator_2"}),n!=="file"&&a.addItem({id:"cardPreview",icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){var o;zh(e,t.blockElement.getAttribute("data-av-id"),t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),((o=t.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:o.value.trim())||"")}}),i.length>0&&window.siyuan.menus.menu.append(new N({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element),e!=null&&e.startsWith("assets/")&&window.siyuan.menus.menu.append(new N(Rf(e)).element);const s=t.rect;a.open({x:s.right,y:s.top,w:s.width,h:s.height});const l=a.element.querySelectorAll("textarea");l[0].value=e,l[0].focus(),l[0].select(),l.length>1&&(l[1].value=t.name)},s0=(t,e,n,a)=>{const i=new dt(p.MENU_AV_ASSET_EDIT,()=>{const l=i.element.querySelectorAll("textarea");!l[0].value&&!l[1].value||Ol({protyle:t,cellElements:e,blockElement:a,addValue:[{type:"file",name:l[1].value,content:l[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${Y()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${Y()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const s=n.getBoundingClientRect();i.open({x:s.right,y:s.bottom,w:n.parentElement.clientWidth+8,h:s.height}),i.element.querySelector("textarea").focus()},Fv=(t,e,n)=>{const a=de(window.siyuan.languages.uploading,0);A("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:!0,id:e.block.rootID},i=>{const s=B(n);if(s){At(a);const l=[];Object.keys(i.data.succMap).forEach(o=>{const r=De().extname(o).toLowerCase(),c=o.substring(0,o.length-r.length);p.SIYUAN_ASSETS_IMAGE.includes(r)?l.push({type:"image",name:c,content:i.data.succMap[o]}):l.push({type:"file",name:c,content:i.data.succMap[o]})}),Ol({protyle:e,blockElement:s,cellElements:[n],addValue:l})}})},l0=t=>{var e,n;let a="";const i=t[t.type];switch(t.type){case"block":t!=null&&t.isDetached?a=`<span>${((e=t.block)==null?void 0:e.content)||window.siyuan.languages.untitled}</span>`:a=`<span data-type="block-ref" data-id="${t.block.id}" data-subtype="s" class="av__celltext--ref">${((n=t.block)==null?void 0:n.content)||window.siyuan.languages.untitled}</span>`;break;case"text":a=t.text.content;break;case"number":a=t.number.formattedContent||t.number.content.toString();break;case"date":case"updated":case"created":i.formattedContent?a=i.formattedContent:(i&&i.isNotEmpty&&(a=Q(i.content).format(i.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),i&&i.hasEndDate&&i.isNotEmpty&&i.isNotEmpty2&&(a=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(i.content2).format(i.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),a&&(a=`<span class="av__celltext">${a}</span>`);break;case"url":a=t.url.content?`<a class="fn__a" href="${t.url.content}" target="_blank">${t.url.content}</a>`:"";break;case"phone":a=t.phone.content?`<a class="fn__a" href="tel:${t.phone.content}" target="_blank">${t.phone.content}</a>`:"";break;case"email":a=t.email.content?`<a class="fn__a" href="mailto:${t.email.content}" target="_blank">${t.email.content}</a>`:"";break}return a},Ji=t=>{var e,n,a,i,s,l,o,r;let c="";switch(t.type){case"block":c=`<input data-id="${t.block.id}" value="${at(t.block.content)}" type="text" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">`;break;case"text":c=`<textarea style="resize: vertical" rows="${(((e=t.text)==null?void 0:e.content)||"").split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">${((n=t.text)==null?void 0:n.content)||""}</textarea>`;break;case"number":c=`<input value="${t.number.isNotEmpty?t.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${t.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":(a=t.mSelect)==null||a.forEach((d,u)=>{t.type==="select"&&u>0||(c+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${d.color});color:var(--b3-font-color${d.color})">${he(d.content)}</span>`)});break;case"mAsset":(i=t.mAsset)==null||i.forEach(d=>{d.type==="image"?c+=`<img loading="lazy" class="av__cellassetimg ariaLabel" aria-label="${d.content}" src="${Wc(d.content)}">`:c+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${at(d.content)}" data-name="${at(d.name)}" data-url="${at(d.content)}">${d.name||d.content}</span>`});break;case"date":c=`<span class="av__celltext" data-value='${JSON.stringify(t[t.type])}' placeholder="${window.siyuan.languages.empty}">`,t[t.type]&&t[t.type].isNotEmpty&&(c+=Q(t[t.type].content).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),t[t.type]&&t[t.type].hasEndDate&&t[t.type].isNotEmpty&&t[t.type].isNotEmpty2&&(c+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(t[t.type].content2).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),c+="</span>";break;case"created":case"updated":t[t.type].isNotEmpty&&(c=`<span data-content="${t[t.type].content}">${Q(t[t.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":c=`<input value="${t.url.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${t.url.content?`href="${t.url.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":c=`<input value="${t.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${t.phone.content?`href="tel:${t.phone.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":c=`<svg class="av__checkbox"><use xlink:href="#icon${t.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":c=`<div class="fn__flex-1" placeholder="${window.siyuan.languages.empty}">${t.template.content}</div>`;break;case"email":c=`<input value="${t.email.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${t.email.content?`href="mailto:${t.email.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(l=(s=t==null?void 0:t.relation)==null?void 0:s.contents)==null||l.forEach((d,u)=>{if(d&&d.block){const m=t.relation.blockIDs[u];d!=null&&d.isDetached?c+=`<span data-row-id="${m}" class="av__cell--relation"><span>\u2796<span class="fn__space--5"></span></span><span class="av__celltext">${Lute.EscapeHTMLStr(d.block.content||window.siyuan.languages.untitled)}</span></span>`:c+=`<span data-row-id="${m}" class="av__cell--relation" data-block-id="${d.block.id}"><span class="b3-menu__avemoji" data-unicode="${d.block.icon||""}">${be(d.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${d.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(d.block.content||window.siyuan.languages.untitled)}</span></span>`}}),c&&c.endsWith(", ")&&(c=c.substring(0,c.length-2));break;case"rollup":(r=(o=t==null?void 0:t.rollup)==null?void 0:o.contents)==null||r.forEach(d=>{const u=["template","select","mSelect","mAsset","checkbox","relation"].includes(d.type)?Ji(d):l0(d);u&&(c+=u.replace("fn__flex-1","")+",&nbsp;")}),c&&c.endsWith(",&nbsp;")&&(c=c.substring(0,c.length-7));break}return c},jh=(t,e,n,a)=>{A("/api/av/getAttributeViewKeys",{id:e},i=>{let s="";if(i.data.forEach(l=>{var o;let r=`<div class="custom-attr__avheader">
    <div class="block__logo popover__block" style="max-width:calc(100% - 40px)" data-id='${JSON.stringify(l.blockIDs)}'>
        <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__ellipsis">${l.avName||window.siyuan.languages.database}</span>
    </div>
    <div class="fn__flex-1"></div>
    <span data-type="remove" data-row-id="${l.keyValues&&l.keyValues[0].values[0].blockID}" class="block__icon block__icon--warning block__icon--show b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.removeAV}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
</div>`;(o=l.keyValues)==null||o.forEach(c=>{var d;r+=`<div class="block__icons av__row" data-id="${e}" data-col-id="${c.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Zt(c.key.name)}<div class='ft__on-surface'>${Zt(c.key.desc)}</div>">
        ${c.key.icon?be(c.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${Gt(c.key.type)}"></use></svg>`}
        <span>${he(c.key.name)}</span>
    </div>
    <div data-av-id="${l.avID}" data-col-id="${c.values[0].keyID}" data-row-id="${c.values[0].blockID}" data-id="${c.values[0].id}" data-type="${c.values[0].type}" 
data-options="${(d=c.key)!=null&&d.options?at(JSON.stringify(c.key.options)):"[]"}" 
${["text","number","date","url","phone","template","email"].includes(c.values[0].type)?"":`placeholder="${window.siyuan.languages.empty}"`}  
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(c.values[0].type)?"":" custom-attr__avvalue"}${["created","updated"].includes(c.values[0].type)?" custom-attr__avvalue--readonly":""}">${Ji(c.values[0])}</div>
</div>`}),r+=`<div class="fn__hr"></div>
<button data-type="addColumn" class="b3-button b3-button--cancel"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.newCol}</button>
<div class="fn__hr--b"></div><div class="fn__hr--b"></div>`,s+=`<div data-av-id="${l.avID}" data-av-type="table" data-node-id="${e}" data-type="NodeAttributeView">${r}</div>`,t.innerHTML&&(t.querySelector(`[data-node-id="${e}"][data-av-id="${l.avID}"]`).innerHTML=r)}),t.innerHTML===""){let l;t.addEventListener("dragstart",r=>{const c=r.target;window.siyuan.dragElement=c.parentElement,window.siyuan.dragElement.style.opacity=".38",l=B(window.siyuan.dragElement);const d=document.createElement("div");d.className="block__icons",d.innerHTML=c.nextElementSibling.outerHTML,d.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(d),r.dataTransfer.setDragImage(d,0,0),setTimeout(()=>{d.remove()})}),t.addEventListener("drop",r=>{var c,d;if(o=0,n.disabled){r.preventDefault(),r.stopPropagation();return}const u=t.querySelector(".dragover__bottom, .dragover__top");if(u&&l){const m=u.classList.contains("dragover__bottom"),f=m?u.dataset.colId:(c=u.previousElementSibling)==null?void 0:c.getAttribute("data-col-id"),g=(d=window.siyuan.dragElement.previousElementSibling)==null?void 0:d.getAttribute("data-col-id");f!==g&&f!==window.siyuan.dragElement.dataset.colId&&(V(n,[{action:"sortAttrViewKey",avID:l.dataset.avId,previousID:f,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:l.dataset.avId,previousID:g,id:e}]),m?u.after(window.siyuan.dragElement):u.before(window.siyuan.dragElement)),u.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&r.dataTransfer.types[0]==="Files"){const m=t.querySelector(".custom-attr__avvalue--active");if(m&&r.dataTransfer.types[0]==="Files"&&!Ne()){const f=[];for(let g=0;g<r.dataTransfer.files.length;g++)f.push(webUtils.getPathForFile(r.dataTransfer.files[g]));Fv(f,n,m)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),t.addEventListener("dragover",r=>{const c=r.target;let d;if(r.dataTransfer.types.includes("Files")){t.querySelectorAll(".custom-attr__avvalue--active").forEach(f=>{f.classList.remove("custom-attr__avvalue--active")}),d=T(c,"custom-attr__avvalue"),d&&d.getAttribute("data-type")==="mAsset"&&(d.classList.add("custom-attr__avvalue--active"),r.preventDefault());return}if(d=T(c,"av__row"),d||(d=T(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!d||d===window.siyuan.dragElement||!l)return;const u=B(d);if(!u||u!==l)return;r.preventDefault();const m=d.getBoundingClientRect();t.querySelectorAll(".dragover__bottom, .dragover__top").forEach(f=>{f.classList.remove("dragover__bottom","dragover__top")}),r.clientY>m.top+m.height/2?d.classList.add("dragover__bottom"):d.classList.add("dragover__top")});let o=0;t.addEventListener("dragleave",()=>{o--,o===0&&t.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),t.addEventListener("dragenter",r=>{r.preventDefault(),o++}),t.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),t.addEventListener("paste",r=>{var c;const d=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(d&&d.length>0)Ai(n,d);else{const u=r.clipboardData.getData("text/plain"),m=r.target,f=B(m),g=j(m,"data-type","mAsset");f&&g&&u&&(Bn(n,f,u,[g],void 0,n.lute.Md2BlockDOM(u)),(c=document.querySelector(".av__panel"))==null||c.remove())}}),t.addEventListener("click",r=>{const c=j(r.target,"data-type","remove");if(c){const d=B(c);d&&(V(n,[{action:"removeAttrViewBlock",srcIDs:[c.dataset.rowId],avID:d.dataset.avId},{action:"doUpdateUpdated",id:c.dataset.rowId,data:Q().format("YYYYMMDDHHmmss")}]),d.remove(),t.innerHTML||window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===p.DIALOG_ATTR)return u.destroy(),!0})),r.stopPropagation();return}Uv(n,t,r)}),t.addEventListener("contextmenu",r=>{Uv(n,t,r)}),t.innerHTML=s}t.querySelectorAll(".b3-text-field--text").forEach(l=>{l.addEventListener("change",()=>{let o;const r=l.parentElement.dataset.type;if(["url","text","email","phone"].includes(r)){if(o={[r]:{content:l.value}},r!=="text"){const c=l.parentElement.querySelector("a");l.value?c.setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+l.value):c.removeAttribute("href")}}else r==="number"?l.value==="undefined"||!l.value?o={number:{content:null,isNotEmpty:!1}}:o={number:{content:parseFloat(l.value)||0,isNotEmpty:!0}}:r==="block"&&(o={block:{content:l.value,id:l.dataset.id},isDetached:!1});A("/api/av/setAttributeViewBlockAttr",{avID:l.parentElement.dataset.avId,keyID:l.parentElement.dataset.colId,itemID:l.parentElement.dataset.rowId,value:o},c=>{r==="number"?l.parentElement.querySelector(".fn__flex-center").textContent=c.data.value.number.formattedContent:r==="block"&&!l.value&&(l.value=c.data.value.block.content)})})}),a&&a(t)})},Uv=(t,e,n)=>{let a=n.target;const i=B(a);if(i)for(;a&&e!==a;){const s=a.getAttribute("data-type");if(a.classList.contains("b3-menu__avemoji")){const l=a.getBoundingClientRect();return Xa(a.nextElementSibling.getAttribute("data-id"),"doc",{x:l.left,y:l.bottom,h:l.height,w:l.width},o=>{a.innerHTML=be(o||window.siyuan.storage[p.LOCAL_IMAGES].file)},a.querySelector("img")),n.preventDefault(),n.stopPropagation(),!0}else if(a.classList.contains("av__celltext--url")||a.classList.contains("av__cellassetimg")){if(n.type==="contextmenu"||!a.dataset.url&&a.tagName!=="IMG"){let l=0;Array.from(a.parentElement.children).find((o,r)=>{if(o===a)return l=r,!0}),Sp({protyle:t,cellElements:[a.parentElement],blockElement:B(a),content:a.tagName==="IMG"?a.getAttribute("src"):a.getAttribute("data-url"),type:a.tagName==="IMG"?"image":"file",name:a.tagName==="IMG"?"":a.getAttribute("data-name"),index:l,rect:a.getBoundingClientRect()})}else a.tagName==="IMG"?kp([a.getAttribute("src")]):Uc(t,a.dataset.url,n,n.ctrlKey||n.metaKey);n.stopPropagation(),n.preventDefault();break}else if(s==="date"){Jn(t,[a],"date"),n.stopPropagation(),n.preventDefault();break}else if(s==="select"||s==="mSelect"){Jn(t,[a],a.getAttribute("data-type")),n.stopPropagation(),n.preventDefault();break}else if(s==="mAsset"){e.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(l=>{l.removeAttribute("data-active")}),a.setAttribute("data-active","true"),a.focus(),Jn(t,[a],"mAsset"),n.stopPropagation(),n.preventDefault();break}else if(s==="checkbox"){Jn(t,[a],"checkbox"),n.stopPropagation(),n.preventDefault();break}else if(s==="relation"){Jn(t,[a],"relation"),n.stopPropagation(),n.preventDefault();break}else if(s==="template"){Jn(t,[a],"template"),n.stopPropagation(),n.preventDefault();break}else if(s==="rollup"){Jn(t,[a],"rollup"),n.stopPropagation(),n.preventDefault();break}else if(s==="addColumn"){const l=i.querySelectorAll(".av__row"),o=Zc(t,i,l[l.length-1].getAttribute("data-col-id")),r=a.getBoundingClientRect();o.open({x:r.left,y:r.bottom,h:r.height}),n.stopPropagation(),n.preventDefault();break}else if(s==="editCol"){Cn({protyle:t,blockElement:i,type:"edit",colId:a.parentElement.dataset.colId}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}},Wv=t=>!!t.getAttribute("data-av-id");var Kh=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Vv=(t,e)=>{t.addEventListener("change",()=>{A("/api/attr/setBlockAttrs",{id:e,attrs:{[t.dataset.name]:t.value}})})},o0=t=>{const e=t.getAttribute("data-node-id"),n=ke(t),a=t.getAttribute(p.CUSTOM_REMINDER_WECHAT);let i="";a&&(i=Q(a).format("YYYY-MM-DD HH:mm"));const s=new $e({width:Y()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){ne(n)}});s.element.setAttribute("data-key",p.DIALOG_WECHATREMINDER);const l=s.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{s.destroy()}),l[1].addEventListener("click",()=>{l[1].getAttribute("disabled")||(l[1].setAttribute("disabled","disabled"),A("/api/block/setBlockReminder",{id:e,timed:"0"},()=>{t.removeAttribute(p.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),l[2].addEventListener("click",()=>{const o=s.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){de(window.siyuan.languages.reminderTip);return}if(l[2].getAttribute("disabled"))return;l[2].setAttribute("disabled","disabled");const r=Q(o).format("YYYYMMDDHHmmss");A("/api/block/setBlockReminder",{id:e,timed:r},()=>{t.setAttribute(p.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else de(window.siyuan.languages.notEmpty)})},r0=t=>{A("/api/block/getDocInfo",{id:t.block.rootID},e=>{const n=e.data.ial[p.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=Q(n).format("YYYY-MM-DD HH:mm"));const i=new $e({width:Y()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",p.DIALOG_WECHATREMINDER);const s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{A("/api/block/setBlockReminder",{id:t.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const l=i.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){de(window.siyuan.languages.reminderTip);return}A("/api/block/setBlockReminder",{id:t.block.rootID,timed:Q(l).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else de(window.siyuan.languages.notEmpty)})})},fa=(t,e="bookmark",n)=>{let a="",i="",s=!1;const l=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;let o;n||(qn().find(c=>{if(t.id===c.protyle.block.rootID)return n=c.protyle,!0}),n||(o=new ba(window.siyuan.ws.app,document.createElement("div"),{blockId:t.id}))),Object.keys(t).forEach(c=>{p.CUSTOM_RIFF_DECKS===c||c.startsWith("custom-sy-")||(c===p.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${c}" value="${Q(t[c]).format("YYYY-MM-DD HH:mm")}">
</label>`:c.indexOf("custom-av")>-1?s=!0:c.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${c.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${c}">${t[c]}</textarea>
</label>`))});const r=new $e({width:Y()?"92vw":"50vw",containerClassName:"b3-dialog__container--theme",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${t.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--cancel">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){ne(l),n?ce(["select"],n):o.destroy()}});r.element.setAttribute("data-key",p.DIALOG_ATTR),r.element.querySelector('.b3-text-field[data-name="bookmark"]').value=t.bookmark||"",r.element.querySelector('.b3-text-field[data-name="name"]').value=t.name||"",r.element.querySelector('.b3-text-field[data-name="alias"]').value=t.alias||"",r.element.addEventListener("click",c=>{let d=c.target;for(typeof c.detail=="string"&&(d=r.element.querySelector(`.item--full[data-type="${c.detail}"]`));d!==r.element;){const u=d.dataset.action;if(d.classList.contains("item--full"))d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),d.classList.add("item--focus"),r.element.querySelectorAll(".custom-attr").forEach(m=>{m.dataset.type===d.dataset.type?(m.dataset.type==="NodeAttributeView"&&m.innerHTML===""&&jh(m,t.id,n||o.protyle),m.classList.remove("fn__none")):m.classList.add("fn__none")});else if(u==="remove"){A("/api/attr/setBlockAttrs",{id:t.id,attrs:{["custom-"+d.previousElementSibling.textContent]:""}}),d.parentElement.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(u==="bookmark"){A("/api/attr/getBookmarkLabels",{},m=>{window.siyuan.menus.menu.remove(),m.data.length===0?window.siyuan.menus.menu.append(new N({id:"emptyContent",iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):m.data.forEach(f=>{window.siyuan.menus.menu.append(new N({label:f,click(){const g=d.parentElement.parentElement.querySelector("input");g.value=f,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:c.clientX,y:c.clientY+16,w:16})}),c.stopPropagation(),c.preventDefault();break}else if(u==="addCustom"){const m=new $e({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});m.element.setAttribute("data-key",p.DIALOG_SETCUSTOMATTR);const f=m.element.querySelector("input"),g=m.element.querySelectorAll(".b3-button");m.bindInput(f,()=>{g[1].click()}),f.focus(),f.select(),g[0].addEventListener("click",()=>{m.destroy()}),g[1].addEventListener("click",()=>{if(!Lt(f.value))return de(window.siyuan.languages.attrName+" <b>"+he(f.value)+"</b> "+window.siyuan.languages.invalid),!1;d.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${f.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${f.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const h=d.parentElement.previousElementSibling.querySelector(".b3-text-field");h.focus(),Vv(h,t.id),m.destroy()}),c.stopPropagation(),c.preventDefault();break}d=d.parentElement}}),r.element.querySelectorAll(".b3-text-field").forEach(c=>{e!=="av"&&e!=="custom"&&e===c.getAttribute("data-name")&&c.focus(),Vv(c,t.id)}),e==="av"?r.element.dispatchEvent(new CustomEvent("click",{detail:"NodeAttributeView"})):e==="custom"&&r.element.dispatchEvent(new CustomEvent("click",{detail:"custom"}))},xi=(t,e="bookmark",n)=>{if(t.getAttribute("data-type")==="NodeThematicBreak")return;const a=t.getAttribute("data-node-id");A("/api/attr/getBlockAttrs",{id:a},i=>{fa(i.data,e,n)})},xs=(t,e=!0,n,a)=>{const i=[{id:"copyBlockRef",iconHTML:"",accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{Jt(t,"ref"),n&&oe(n)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{Jt(t,"blockEmbed"),n&&oe(n)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{Jt(t,"protocol"),n&&oe(n)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{Jt(t,"protocolMd"),n&&oe(n)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:e?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{Jt(t,"hPath"),n&&oe(n)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:e?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{Jt(t,"id"),n&&oe(n)}}];return a&&i.push({id:"copyMarkdown",iconHTML:"",label:window.siyuan.languages.copyMarkdown,accelerator:void 0,click:()=>Kh(void 0,null,function*(){const l=(yield Ae("/api/export/exportMdContent",{id:a,refMode:3,embedMode:1,yfm:!1,fillCSSVar:!1,adjustHeadingLevel:!1})).data.content;Be(l),n&&oe(n)})}),i},Yv=t=>{if(!window.siyuan.isPublish)return new N({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>Kh(void 0,null,function*(){const e=yield Ae("/api/block/getRefText",{id:t}),n=new $e({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});n.element.setAttribute("data-key",p.DIALOG_EXPORTTEMPLATE);const a=n.element.querySelector("input"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()});let s=oa(e.data);const l=32;s.length>l&&(s=s.substring(0,l)),a.value=s,a.focus(),a.select(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=oa(a.value),s.length>l&&(s=s.substring(0,l)),A("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!1},o=>{if(o.code===1){Re(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{A("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!0},r=>{r.code===0&&de(window.siyuan.languages.exportTplSucc)})});return}de(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=de(window.siyuan.languages.exporting,-1);A("/api/export/exportSY",{id:t},n=>{At(e),nn(n.data.zip)})}},{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const e=de(window.siyuan.languages.exporting,-1);A("/api/export/exportMd",{id:t},n=>{At(e),nn(n.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{RA(t)}},{id:"exportPDF",label:window.siyuan.languages.print,icon:"iconPDF",ignore:!ht()&&!bt(),click:()=>{const e=de(window.siyuan.languages.exporting),n=window.siyuan.storage[p.LOCAL_EXPORTPDF];A("/api/export/exportPreviewHTML",{id:t,keepFold:n.keepFold,merge:n.mergeSubdocs},a=>Kh(void 0,null,function*(){const i=window.location.protocol+"//"+window.location.host+"/",s=yield pw(a,void 0,i,{type:"pdf",id:t});ht()?window.JSAndroid.print(s):bt()&&window.JSHarmony.print(s),setTimeout(()=>{At(e)},3e3)}))}},{id:"exportHTML_SiYuan",label:"HTML (SiYuan)",iconClass:"ft__error",icon:"iconHTML5",click:()=>{fw({type:"html",id:t})}},{id:"exportHTML_Markdown",label:"HTML (Markdown)",icon:"iconHTML5",click:()=>{fw({type:"htmlmd",id:t})}}]}).element},Vc=(t,e,n,a)=>{const i=[];if(Ro(e)?p.SIYUAN_ASSETS_EXTS.includes(De().extname(e).split("?")[0])&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&!e.startsWith("file://"))?(i.push({id:"insertRight",icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:a?window.siyuan.languages.click:"",click(){ur(t,e.trim(),parseInt(Ie("page",e)),"right")}}),i.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",accelerator:a?"\u2325"+window.siyuan.languages.click:"",click(){ur(t,e.trim(),parseInt(Ie("page",e)))}})):i.push({id:ht()||bt()?"useDefault":"useBrowserView",label:ht()||bt()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:a?window.siyuan.languages.click:"",click:()=>{nn(e)}}):e&&(0>e.indexOf(":")&&(e=`https://${e}`),i.push({id:ht()||bt()?"useDefault":"useBrowserView",label:ht()||bt()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:a?window.siyuan.languages.click:"",click:()=>{nn(e)}})),n)return i;window.siyuan.menus.menu.append(new N({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element)},zv=t=>new N({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{sh(t)}}).element,Zh=t=>new N({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){zi((e,n)=>{Jm(t,n[0],e[0])},t)}}).element;var c0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Xt=t=>{t.menu.addItem({iconHTML:"",label:Jh(t.operator,!!t.data),click(){if(!t.data)V(t.protyle,[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.operator},blockID:t.blockID}],[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.oldOperator},blockID:t.blockID}]);else{t.target.querySelector(".b3-menu__accelerator").textContent=Jh(t.operator,!0);const e=yt(t.data).find(n=>{if(n.id===t.colId)return n.rollup||(n.rollup={}),!0});e.rollup.calc={operator:t.operator},V(t.protyle,[{action:"updateAttrViewColRollup",id:t.colId,avID:t.avId,parentID:e.rollup.relationKeyID,keyID:e.rollup.keyID,data:{calc:e.rollup.calc}}],[{action:"updateAttrViewColRollup",id:t.colId,avID:t.avId,parentID:e.rollup.relationKeyID,keyID:e.rollup.keyID,data:{calc:{operator:t.oldOperator}}}])}}})},Gv=(t,e,n,a)=>c0(void 0,null,function*(){let i,s,l,o,r,c;if(n)o=n.data.id,s=e.dataset.colType,r=e.dataset.calc,l=n.colId,c=n.blockID;else{const f=B(e);if(!f||(i=T(e,"av__row--footer"),!i))return;i.classList.add("av__row--show"),s=e.dataset.dtype,l=e.dataset.colId,o=f.dataset.avId,r=e.dataset.operator,c=f.dataset.nodeId}if(s==="lineNumber")return;const d=new dt(p.MENU_AV_CALC,()=>{i&&i.classList.remove("av__row--show")});if(d.isOpen)return;Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"",data:n==null?void 0:n.data,blockID:c,target:e}),n!=null&&n.data&&s!=="checkbox"&&Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Unique values",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Count all",data:n==null?void 0:n.data,blockID:c,target:e}),s!=="checkbox"?(Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Count empty",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Count not empty",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Count values",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Count unique values",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Percent empty",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Percent not empty",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Percent unique values",data:n==null?void 0:n.data,blockID:c,target:e})):(Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Checked",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Unchecked",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Percent checked",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Percent unchecked",data:n==null?void 0:n.data,blockID:c,target:e}));let u=!1;if(s==="rollup"){let f,g,h=n==null?void 0:n.data;if(h||(h=(yield Ae("api/av/renderAttributeView",{id:o})).data),yt(h).find(b=>{var y,w;if(b.id===l)return f=(y=b.rollup)==null?void 0:y.relationKeyID,g=(w=b.rollup)==null?void 0:w.keyID,!0}),f&&g){let b;yt(h).find(y=>{var w;if(y.id===f)return b=(w=y.relation)==null?void 0:w.avID,!0}),b&&(yield Ae("api/av/getAttributeView",{id:b})).data.av.keyValues.find(w=>{if(w.key.id===g)return u=w.key.type==="number",!0})}}["number","template"].includes(s)||u?(Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Sum",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Average",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Median",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Min",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Max",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Range",data:n==null?void 0:n.data,blockID:c,target:e})):["date","created","updated"].includes(s)&&(Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Earliest",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Latest",data:n==null?void 0:n.data,blockID:c,target:e}),Xt({menu:d,protyle:t,colId:l,avId:o,oldOperator:r,operator:"Range",data:n==null?void 0:n.data,blockID:c,target:e}));const m=e.getBoundingClientRect();d.open({x:Math.max(a||0,m.left),y:m.bottom,h:m.height})}),d0=t=>{if(!t.calc||!t.calc.result)return"";let e=t.calc.result.number;(t.calc.operator==="Earliest"||t.calc.operator==="Latest"||t.calc.operator==="Range"&&["date","created","updated"].includes(t.type))&&(e=t.calc.result[t.type]);let n="";switch(t.calc.operator){case"Count all":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountAll}</small>`;break;case"Count values":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountValues}</small>`;break;case"Count unique values":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountUniqueValues}</small>`;break;case"Count empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountEmpty}</small>`;break;case"Count not empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultCountNotEmpty}</small>`;break;case"Percent empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentEmpty}</small>`;break;case"Percent not empty":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentNotEmpty}</small>`;break;case"Percent unique values":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentUniqueValues}</small>`;break;case"Sum":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultSum}</small>`;break;case"Average":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultAverage}</small>`;break;case"Median":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultMedian}</small>`;break;case"Min":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultMin}</small>`;break;case"Max":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultMax}</small>`;break;case"Range":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcResultRange}</small>`;break;case"Earliest":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcOperatorEarliest}</small>`;break;case"Latest":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.calcOperatorLatest}</small>`;break;case"Checked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.checked}</small>`;break;case"Unchecked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.unchecked}</small>`;break;case"Percent checked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.percentChecked}</small>`;break;case"Percent unchecked":n=`<span>${e.formattedContent}</span><small>${window.siyuan.languages.percentUnchecked}</small>`;break}return n},Jh=(t,e)=>{switch(t){case void 0:case"":return e?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Unique values":return window.siyuan.languages.uniqueValues;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Percent unique values":return window.siyuan.languages.calcOperatorPercentUniqueValues;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},u0=t=>{const e=t.nodeElement.getAttribute("data-av-id"),n=t.nodeElement.getAttribute("data-node-id"),a=t.target.querySelector(".b3-menu__accelerator"),i=new dt;i.addItem({iconHTML:"",checked:t.view.coverFrom===0,label:window.siyuan.languages.calcOperatorNone,click(){V(t.protyle,[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:0}],[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:t.view.coverFrom}]),t.view.coverFrom=0,a.textContent=window.siyuan.languages.calcOperatorNone}}),i.addItem({iconHTML:"",checked:t.view.coverFrom===3,label:window.siyuan.languages.contentBlock,click(){V(t.protyle,[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:3}],[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:t.view.coverFrom}]),t.view.coverFrom=3,a.textContent=window.siyuan.languages.contentBlock}}),i.addItem({iconHTML:"",checked:t.view.coverFrom===1,label:window.siyuan.languages.contentImage,click(){V(t.protyle,[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:1}],[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:t.view.coverFrom}]),t.view.coverFrom=1,a.textContent=window.siyuan.languages.contentImage}});let s=!1;t.view.fields.forEach(o=>{o.type==="mAsset"&&(s||(i.addSeparator(),s=!0),i.addItem({iconHTML:o.icon?be(o.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(o.type)}"></use></svg>`,checked:t.view.coverFrom===2&&t.view.coverFromAssetKeyID===o.id,label:o.name,click(){V(t.protyle,[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:2},{action:"setAttrViewCoverFromAssetKeyID",avID:e,blockID:n,keyID:o.id}],[{action:"setAttrViewCoverFrom",avID:e,blockID:n,data:t.view.coverFrom},{action:"setAttrViewCoverFromAssetKeyID",avID:e,blockID:n,keyID:t.view.coverFromAssetKeyID}]),t.view.coverFrom=2,t.view.coverFromAssetKeyID=o.id,a.textContent=o.name}}))});const l=t.target.getBoundingClientRect();i.open({x:l.left,y:l.bottom})},f0=t=>{const e=new dt,n=t.nodeElement.getAttribute("data-av-id"),a=t.nodeElement.getAttribute("data-node-id"),i=t.nodeElement.getAttribute(p.CUSTOM_SY_AV_VIEW),s=t.target.querySelector(".b3-menu__accelerator");e.addItem({iconHTML:"",checked:t.view.cardSize===0,label:window.siyuan.languages.small,click(){V(t.protyle,[{action:"setAttrViewCardSize",avID:n,blockID:a,data:0,viewID:i}],[{action:"setAttrViewCardSize",avID:n,blockID:a,data:t.view.cardSize,viewID:i}]),t.view.cardSize=0,s.textContent=window.siyuan.languages.small}}),e.addItem({iconHTML:"",checked:t.view.cardSize===1,label:window.siyuan.languages.medium,click(){V(t.protyle,[{action:"setAttrViewCardSize",avID:n,blockID:a,data:1,viewID:i}],[{action:"setAttrViewCardSize",avID:n,blockID:a,data:t.view.cardSize,viewID:i}]),t.view.cardSize=1,s.textContent=window.siyuan.languages.medium}}),e.addItem({iconHTML:"",checked:t.view.cardSize===2,label:window.siyuan.languages.large,click(){V(t.protyle,[{action:"setAttrViewCardSize",avID:n,blockID:a,data:2,viewID:i}],[{action:"setAttrViewCardSize",avID:n,blockID:a,data:t.view.cardSize,viewID:i}]),t.view.cardSize=2,s.textContent=window.siyuan.languages.large}});const l=t.target.getBoundingClientRect();e.open({x:l.left,y:l.bottom})},Xh=t=>{switch(t){case 0:return"16:9";case 1:return"9:16";case 2:return"4:3";case 3:return"3:4";case 4:return"3:2";case 5:return"2:3";case 6:return"1:1"}return"16:9"},p0=t=>{const e=new dt,n=t.nodeElement.getAttribute("data-av-id"),a=t.nodeElement.getAttribute("data-node-id"),i=t.nodeElement.getAttribute(p.CUSTOM_SY_AV_VIEW),s=t.target.querySelector(".b3-menu__accelerator");[0,1,2,3,4,5,6].forEach(o=>{e.addItem({iconHTML:"",checked:t.view.cardAspectRatio===o,label:Xh(o),click(){V(t.protyle,[{action:"setAttrViewCardAspectRatio",avID:n,blockID:a,data:o,viewID:i}],[{action:"setAttrViewCardAspectRatio",avID:n,blockID:a,data:t.view.cardAspectRatio,viewID:i}]),t.view.cardAspectRatio=o,s.textContent=Xh(o)}})});const l=t.target.getBoundingClientRect();e.open({x:l.left,y:l.bottom})},jv=t=>{const e=T(t.target,"av__gallery-item");e&&Yc(t.protyle,e,t.position)},g0=t=>{const e=T(t,"av__gallery-item");if(e){const n=e.querySelector(".av__gallery-fields");n&&(t.setAttribute("aria-label",window.siyuan.languages[n.classList.contains("av__gallery-fields--edit")?"displayEmptyFields":"hideEmptyFields"]),n.classList.toggle("av__gallery-fields--edit"))}};var m0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const h0=(t,e)=>{var n,a,i,s,l;if(Wt(e))return!1;const o=B(e.target);if(!o)return!1;const r=o.getAttribute("data-av-type");let c=e.target;for(;c&&!c.isEqualNode(o);){const d=c.getAttribute("data-type");if(d==="av-header-add"&&!t.disabled){const u=Zc(t,o),m=c.getBoundingClientRect();return u.open({x:m.left,y:m.bottom,h:m.height}),e.preventDefault(),e.stopPropagation(),!0}else{if(d==="av-header-more"&&!t.disabled)return Cn({protyle:t,blockElement:o,type:"properties"}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-add-more"&&!t.disabled)return Ss({blockElement:o,protyle:t,count:1,previousID:"",groupID:((n=o.querySelector(".av__body"))==null?void 0:n.getAttribute("data-group-id"))||""}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-more"&&!t.disabled)return Cn({protyle:t,blockElement:o,type:"config"}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-switcher"&&!t.disabled)return Cn({protyle:t,blockElement:o,type:"switcher"}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-sort"&&!t.disabled)return Cn({protyle:t,blockElement:o,type:"sorts"}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-filter"&&!t.disabled)return Cn({protyle:t,blockElement:o,type:"filters"}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-add"&&!t.disabled)return Ow(t,o),e.preventDefault(),e.stopPropagation(),!0;if(d==="block-more"&&!t.disabled)return window.siyuan.menus.menu.remove(),t.toolbar.range=document.createRange(),t.toolbar.range.selectNodeContents(c),ne(t.toolbar.range),r==="table"&&(c.parentElement.classList.add("av__cell--select"),pa(c.parentElement)),As(c.previousElementSibling.textContent.trim(),t,"av"),e.preventDefault(),e.stopPropagation(),!0;if(d==="set-page-size"&&!t.disabled)return Fw({target:c,protyle:t,avID:o.getAttribute("data-av-id"),nodeElement:o}),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-add-bottom"&&!t.disabled){const u=T(c,"av__body");return Ss({blockElement:o,protyle:t,count:1,previousID:u&&((i=(a=u.querySelector(".av__row--util"))==null?void 0:a.previousElementSibling)==null?void 0:i.getAttribute("data-id"))||((s=c.previousElementSibling)==null?void 0:s.getAttribute("data-id"))||void 0,groupID:u?u.getAttribute("data-group-id"):""}),e.preventDefault(),e.stopPropagation(),!0}else if(d==="av-add-top"&&!t.disabled){const u=T(c,"av__group-title");return Ss({blockElement:o,protyle:t,count:1,previousID:"",groupID:u?u.nextElementSibling.getAttribute("data-group-id"):""}),e.preventDefault(),e.stopPropagation(),!0}else{if(c.classList.contains("av__cell--header")&&!t.disabled)return fE(t,o,c),e.preventDefault(),e.stopPropagation(),!0;if(c.classList.contains("av__cell")&&!t.disabled){if(!T(c,"av__row--header")){if(c.querySelector(".av__pulse"))return;const u=Zn(c);if(r==="table"){const m=T(c,"av__scroll");if(!m)return;const f=T(c,"av__row");if(!f)return;u==="updated"||u==="created"||u==="lineNumber"?ti(f.querySelector(".av__firstcol"),"toggle"):(m.querySelectorAll(".av__row--select").forEach(g=>{g.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),g.classList.remove("av__row--select")}),Es(f),Jn(t,[c]))}else T(c,"av__gallery-item")&&u!=="updated"&&u!=="created"&&u!=="lineNumber"&&Jn(t,[c])}return e.preventDefault(),e.stopPropagation(),!0}else{if(c.classList.contains("av__calc")&&!t.disabled)return Gv(t,c,void 0,e.clientX-64),e.preventDefault(),e.stopPropagation(),!0;if(c.classList.contains("b3-menu__avemoji")&&!t.disabled){const u=c.getBoundingClientRect();return Xa(c.nextElementSibling.getAttribute("data-id"),"doc",{x:u.left,y:u.bottom,h:u.height,w:u.width},m=>{c.innerHTML=be(m||window.siyuan.storage[p.LOCAL_IMAGES].file)},c.querySelector("img")),e.preventDefault(),e.stopPropagation(),!0}else{if(d==="av-gallery-edit"&&!t.disabled)return g0(c),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-gallery-more"&&!t.disabled){const u=c.getBoundingClientRect();return jv({target:c,protyle:t,position:{x:u.left,y:u.bottom}}),e.preventDefault(),e.stopPropagation(),!0}else if(d==="av-group-fold"){if(c.getAttribute("data-folding")!=="true"){c.setAttribute("data-folding","true");const u=c.firstElementChild.classList.contains("av__group-arrow--open");V(t,[{action:"foldAttrViewGroup",avID:o.dataset.avId,blockID:o.dataset.nodeId,id:c.dataset.id,data:u}],[{action:"foldAttrViewGroup",avID:o.dataset.avId,blockID:o.dataset.nodeId,id:c.dataset.id,data:!u}]),u?(c.firstElementChild.classList.remove("av__group-arrow--open"),c.parentElement.nextElementSibling.classList.add("fn__none")):(c.firstElementChild.classList.add("av__group-arrow--open"),c.parentElement.nextElementSibling.classList.remove("fn__none"))}return e.preventDefault(),e.stopPropagation(),!0}else if(d==="av-load-more"){o.querySelectorAll(".av__row--footer").forEach(m=>{m.style.transform=""}),o.removeAttribute("data-render");const u=T(c,"av__body");return u.dataset.pageSize=(parseInt(u.dataset.pageSize)+parseInt(u.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),Vt(o,t),e.preventDefault(),e.stopPropagation(),!0}else{if(c.classList.contains("av__firstcol"))return window.siyuan.menus.menu.remove(),ti(c,"toggle"),e.preventDefault(),e.stopPropagation(),!0;if(c.classList.contains("item")&&c.parentElement.classList.contains("layout-tab-bar"))return c.classList.contains("item--focus")?Mc({protyle:t,blockElement:o,element:c}):V(t,[{action:"setAttrViewBlockView",blockID:o.getAttribute("data-node-id"),id:c.dataset.id,avID:o.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:o.getAttribute("data-node-id"),id:c.parentElement.querySelector(".item--focus").getAttribute("data-id"),avID:o.getAttribute("data-av-id")}]),e.preventDefault(),e.stopPropagation(),!0;if(c.classList.contains("av__cellassetimg"))return zh(Gh(c.getAttribute("src")),o.getAttribute("data-av-id"),o.getAttribute(p.CUSTOM_SY_AV_VIEW),((l=o.querySelector('[data-type="av-search"]'))==null?void 0:l.value.trim())||""),e.preventDefault(),e.stopPropagation(),!0;if(c.classList.contains("av__row")&&e.shiftKey&&!c.classList.contains("av__row--header"))return ti(c.querySelector(".av__firstcol"),"toggle"),e.preventDefault(),e.stopPropagation(),!0;if(d==="copy")return Be(Bl(T(c,"av__cell"))),de(window.siyuan.languages.copied),e.preventDefault(),e.stopPropagation(),!0;if(d==="av-search-icon"){const u=o.querySelector('input[data-type="av-search"]');u.style.width="128px",u.style.paddingLeft="",u.style.paddingRight="";const m=T(u,"av__views");return m&&m.classList.add("av__views--show"),setTimeout(()=>{u.focus()},p.TIMEOUT_TRANSITION),e.preventDefault(),e.stopPropagation(),!0}}}}}}c=c.parentElement}return!1},Yc=(t,e,n)=>{var a;if(ce(["hint"],t),e.classList.contains("av__row--header"))return!1;const i=B(e);if(!i)return!1;const s=i.getAttribute("data-av-type");s==="table"?(e.classList.contains("av__row--select")||an(["row"],i),an(["cell"],i),e.classList.add("av__row--select"),e.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),Es(e)):(e.classList.contains("av__gallery-item--select")||an(["galleryItem"],i),e.classList.add("av__gallery-item--select"));const l=new dt,o=i.querySelectorAll(".av__row--select:not(.av__row--header), .av__gallery-item--select"),r=o[0].querySelector('.av__cell[data-dtype="block"]'),c=Array.from(o).map(m=>m.querySelector('[data-dtype="block"] .av__celltext').getAttribute("data-id"));if(o.length===1&&r.getAttribute("data-detached")!=="true"){const m=c[0],f=nh(t.app,[m],void 0,void 0,!0);f.push({id:"separator_3",type:"separator"}),f.push({id:"attr",icon:"iconAttr",label:window.siyuan.languages.attr,click:()=>{A("/api/attr/getBlockAttrs",{id:m},g=>{fa(g.data,"av",t)})}}),l.addItem({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:f})}let d=!1;o.forEach(m=>{m.querySelector('.av__cell[data-dtype="block"]').getAttribute("data-detached")!=="true"&&(d=!0)});const u=[{id:"copyKeyContent",iconHTML:"",label:window.siyuan.languages.copyKeyContent,click(){let m="";o.forEach((f,g)=>{o.length>1&&(m+="- "),m+=f.querySelector('.av__cell[data-dtype="block"] .av__celltext').textContent.trim(),c.length>1&&g!==c.length-1&&(m+=`
`)}),Be(m)}}];if(d&&u.splice(1,0,{id:"copyBlockRef",iconHTML:"",label:window.siyuan.languages.copyBlockRef,click:()=>{let m="";for(let f=0;f<c.length;f++){const g=c[f];let h="";const b=o[f].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?h=b.querySelector(".av__celltext").textContent:h=`((${g} '${b.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}'))`,c.length>1&&(m+="- "),m+=h,c.length>1&&f!==c.length-1&&(m+=`
`)}Be(m)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,click:()=>{let m="";c.forEach((f,g)=>{c.length>1&&(m+="- ");const h=o[g].querySelector(".av__cell[data-dtype='block']");h.getAttribute("data-detached")==="true"?m+=h.querySelector(".av__celltext").textContent:m+=`{{select * from blocks where id='${f}'}}`,c.length>1&&g!==c.length-1&&(m+=`
`)}),Be(m)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,click:()=>{let m="";c.forEach((f,g)=>{c.length>1&&(m+="- ");const h=o[g].querySelector(".av__cell[data-dtype='block']");h.getAttribute("data-detached")==="true"?m+=h.querySelector(".av__celltext").textContent:m+=`siyuan://blocks/${f}`,c.length>1&&g!==c.length-1&&(m+=`
`)}),Be(m)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,click:()=>{let m="";for(let f=0;f<c.length;f++){const g=c[f];let h="";const b=o[f].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?h=b.querySelector(".av__celltext").textContent:h=`[${b.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}](siyuan://blocks/${g})`,c.length>1&&(m+="- "),m+=h,c.length>1&&f!==c.length-1&&(m+=`
`)}Be(m)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,click:()=>m0(void 0,null,function*(){let m="";for(let f=0;f<c.length;f++){const g=c[f];let h="";const b=o[f].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?h=b.querySelector(".av__celltext").textContent:h=(yield Ae("/api/filetree/getHPathByID",{id:g})).data,c.length>1&&(m+="- "),m+=h,c.length>1&&f!==c.length-1&&(m+=`
`)}Be(m)})},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,click:()=>{let m="";c.forEach((f,g)=>{c.length>1&&(m+="- ");const h=o[g].querySelector(".av__cell[data-dtype='block']");h.getAttribute("data-detached")==="true"?m+=h.querySelector(".av__celltext").textContent:m+=f,c.length>1&&g!==c.length-1&&(m+=`
`)}),Be(m)}}),l.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:u}),!t.disabled){l.addItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){Pc(i.getAttribute("data-av-id"),o[0],f=>{const g=[],h=[];o.forEach(w=>{const E=w.getAttribute("data-id"),C=Ci("block",w.querySelector('.av__cell[data-dtype="block"]'));g.push({itemID:Lute.NewNodeID(),content:C.block.content,id:C.block.id||"",isDetached:C.isDetached}),h.push(E)});const b=f.dataset.avId,y=f.dataset.viewId;V(t,[{action:"insertAttrViewBlock",ignoreDefaultFill:!y,viewID:y,avID:b,srcs:g,context:{ignoreTip:"true"},blockID:f.dataset.blockId,groupID:e.parentElement.getAttribute("data-group-id")},{action:"doUpdateUpdated",id:f.dataset.blockId,data:Q().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:h,avID:b}])})}}),o.length===1&&(r.getAttribute("data-detached")!=="true"&&l.addSeparator({id:"separator_1"}),l.addItem({id:s==="table"?"insertRowBefore":"insertItemBefore",icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages[s==="table"?"insertRowBefore":"insertItemBefore"].replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>`)}
</div>`,bind(f){const g=f.querySelector("input");f.addEventListener("click",()=>{var h;document.activeElement!==g&&(Ss({blockElement:i,protyle:t,count:parseInt(g.value),previousID:(h=o[0].previousElementSibling)==null?void 0:h.getAttribute("data-id"),groupID:o[0].parentElement.getAttribute("data-group-id")}),l.close())}),g.addEventListener("keydown",h=>{var b;!h.isComposing&&h.key==="Enter"&&(Ss({blockElement:i,protyle:t,count:parseInt(g.value),previousID:(b=o[0].previousElementSibling)==null?void 0:b.getAttribute("data-id"),groupID:o[0].parentElement.getAttribute("data-group-id")}),l.close())})}}),l.addItem({id:s==="table"?"insertRowAfter":"insertItemAfter",icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages[s==="table"?"insertRowAfter":"insertItemAfter"].replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>`)}
</div>`,bind(f){const g=f.querySelector("input");f.addEventListener("click",()=>{document.activeElement!==g&&(Ss({blockElement:i,protyle:t,count:parseInt(g.value),previousID:o[0].getAttribute("data-id"),groupID:o[0].parentElement.getAttribute("data-group-id")}),l.close())}),g.addEventListener("keydown",h=>{!h.isComposing&&h.key==="Enter"&&(Ss({blockElement:i,protyle:t,count:parseInt(g.value),previousID:o[0].getAttribute("data-id"),groupID:o[0].parentElement.getAttribute("data-group-id")}),l.close())})}}),l.addSeparator({id:"separator_2"}),r.getAttribute("data-detached")!=="true"&&l.addItem({id:"unbindBlock",label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){Bn(t,i,{content:r.querySelector(".av__celltext").textContent},[r])}})),l.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Uw(i,t)}});const m=[];s==="table"?e.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(f=>{const g=Array.from(i.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${f.dataset.colId}"]`)),h=f.getAttribute("data-dtype");if(!["updated","created"].includes(h)){const b=f.dataset.icon;m.push({iconHTML:b?be(b,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(h)}"></use></svg>`,label:he(f.querySelector(".av__celltext").textContent.trim()),click(){Jn(t,g)}})}}):e.querySelectorAll(".av__cell").forEach(f=>{const g=Array.from(i.querySelectorAll(`.av__gallery-item--select .av__cell[data-field-id="${f.dataset.fieldId}"]`)),h=f.getAttribute("data-dtype");if(!["updated","created"].includes(h)){const b=f.parentElement.querySelector(".av__gallery-tip, .av__gallery-name").firstElementChild.cloneNode(!0);b.classList.add("b3-menu__icon"),m.push({iconHTML:b.outerHTML,label:he(f.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]),click(){e.querySelector(".av__gallery-fields").classList.add("av__gallery-fields--edit"),e.querySelector('[data-type="av-gallery-edit"]').setAttribute("aria-label",window.siyuan.languages.hideEmptyFields),Jn(t,g)}})}}),l.addItem({id:"fields",icon:"iconAttr",label:window.siyuan.languages.fields,type:"submenu",submenu:m})}return(a=t==null?void 0:t.app)!=null&&a.plugins&&zn({plugins:t.app.plugins,type:"open-menu-av",detail:{protyle:t,element:i,selectRowElements:o},separatorPosition:"top"}),l.open(n),!0},Qh=(t,e)=>{const n=e.getAttribute("data-av-id"),a=e.getAttribute("data-node-id"),i=e.querySelector(".av__title");i.textContent===""&&i.querySelectorAll("br").forEach(o=>{o.remove()});const s=i.textContent.trim();if(s===i.dataset.title.trim())return;if(s.length>p.SIZE_TITLE)return de(window.siyuan.languages._kernel[106]),!1;const l=Q().format("YYYYMMDDHHmmss");V(t,[{action:"setAttrViewName",id:n,data:s},{action:"doUpdateUpdated",id:a,data:l}],[{action:"setAttrViewName",id:n,data:i.dataset.title},{action:"doUpdateUpdated",id:a,data:e.getAttribute("updated")}]),e.setAttribute("updated",l),i.dataset.title=s,Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-av-id="${n}"]`)).forEach(o=>{if(e===o)return;const r=o.querySelector(".av__title");r&&(r.textContent=s,r.dataset.title=s)})},On=(t,e,n)=>{var a;if(t)if(n)P0(t,n);else{const i=t.querySelector(".av__drag-fill"),s=B(t);if(!s)return;const l=s.getAttribute("data-av-type"),o=t.querySelector(".b3-menu__avemoji");["gallery","kanban"].includes(l)?(e.type==="checkbox"&&(e.checkbox={checked:((a=e.checkbox)==null?void 0:a.checked)||!1,content:t.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]}),t.innerHTML=li(e,0,o?!o.classList.contains("fn__none"):!1,l),t.parentElement.setAttribute("data-empty",nb(e).toString())):t.innerHTML=li(e,0,o?!o.classList.contains("fn__none"):!1),i&&pa(t),Cp(t,e)}},Kv=(t,e)=>{t.querySelectorAll(`.av__cell[data-col-id="${e}"]`).forEach(n=>{n.remove()})},Zv=(t,e)=>{A("/api/av/duplicateAttributeViewBlock",{avID:e.getAttribute("data-av-id")},n=>{e.classList.remove("protyle-wysiwyg--select");const a=document.createElement("template");a.innerHTML=t.lute.SpinBlockDOM(`<div data-node-id="${n.data.blockID}" data-av-id="${n.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const i=a.content.firstElementChild;e.after(i),Vt(i,t,()=>{oe(i),Ye(t)}),V(t,[{action:"insert",data:i.outerHTML,id:n.data.blockID,previousID:e.dataset.nodeId}],[{action:"delete",id:n.data.blockID}])})};let Kn;const eb=(t,e,n=[])=>{var a;let i="",s=!1;if(n.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(l=>{n.push(l.dataset.content)}),e){const l=((a=document.querySelector(".av__panel .b3-menu__item--current"))==null?void 0:a.getAttribute("data-name"))||"";e.forEach(o=>{if(!t||t.toLowerCase().indexOf(o.name.toLowerCase())>-1||o.name.toLowerCase().indexOf(t.toLowerCase())>-1){const r=o.desc?`${Zt(o.name)}<div class='ft__on-surface'>${Zt(o.desc||"")}</div>`:"";i+=`<button data-type="addColOptionOrCell" class="b3-menu__item${l===o.name?" b3-menu__item--current":""}" data-name="${at(o.name)}" data-desc="${at(o.desc||"")}" draggable="true" data-color="${o.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${r}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${o.color});color:var(--b3-font-color${o.color})">
            <span class="fn__ellipsis">${he(o.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${n.includes(o.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`}t===o.name&&(s=!0)})}if(!s&&t){i=i.replace('class="b3-menu__item b3-menu__item--current"','class="b3-menu__item"');const l=((e==null?void 0:e.length)||0)%14+1;i=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${t}" data-color="${l}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${l});color:var(--b3-font-color${l})">
        <span class="fn__ellipsis">${he(t)}</span>
    </span>
</div>
<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${window.siyuan.languages.enterKey}</span>
</button>${i}`}else i.indexOf("b3-menu__item--current")===-1&&(i=i.replace('class="b3-menu__item"','class="b3-menu__item b3-menu__item--current"'));return i},Lp=(t,e,n,a)=>{if(!n)return;const i=a.getAttribute("data-av-type"),s=Xn(e[0],i),l=[],o=[];let r;const c=a.getAttribute("data-av-id");e.forEach((d,u)=>{var m;const f=Ba(d,i);if(!f)return;a.contains(d)||(i==="table"?d=e[u]=a.querySelector(`.av__row[data-id="${f}"] .av__cell[data-col-id="${d.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${d.dataset.colId}"]`):d=e[u]=a.querySelector(`.av__gallery-item[data-id="${f}"] .av__cell[data-field-id="${d.dataset.fieldId}"]`));const g=Kn[u],h=JSON.parse(JSON.stringify(g));u===0?((m=g.mSelect)==null||m.find((b,y)=>{if(b.content===n.dataset.content)return g.mSelect.splice(y,1),!0}),r=g.mSelect):g.mSelect=r,l.push({action:"updateAttrViewCell",id:g.id,keyID:s,rowID:f,avID:c,data:g}),o.push({action:"updateAttrViewCell",id:g.id,keyID:s,rowID:f,avID:c,data:h}),d.classList.contains("custom-attr__avvalue")?d.innerHTML=Ji(g):On(d,g)}),l.push({action:"doUpdateUpdated",id:a.getAttribute("data-node-id"),data:Q().format("YYYYMMDDHHmmss")}),V(t,l,o),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(d=>{var u;if(d.dataset.name===n.dataset.content)return(u=d.querySelector(".b3-menu__checked"))==null||u.remove(),!0}),n.remove()},b0=(t,e,n,a,i,s)=>{const l=T(n,"b3-menu");if(!l)return;const o=a.getAttribute("data-node-id"),r=a.getAttribute("data-av-type"),c=s&&s[0]?Xn(s[0],r):l.querySelector(".b3-menu__item").getAttribute("data-col-id");let d=n.parentElement.dataset.name,u=n.parentElement.dataset.desc,m=n.parentElement.dataset.color;const f=yt(e),g=new dt(p.MENU_AV_COL_OPTION,()=>{if(d===y.value&&u===w.value||!y.value)return;V(t,[{action:"updateAttrViewColOption",id:c,avID:e.id,data:{newColor:m,oldName:d,newName:y.value,newDesc:w.value}},{action:"doUpdateUpdated",id:o,data:Q().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOption",id:c,avID:e.id,data:{newColor:m,oldName:y.value,newName:d,newDesc:u}}]),f.find(M=>{if(M.id===c)return M.options.find(_=>{if(_.name===y.value&&_.desc===w.value)return!0})||M.options.find(_=>{if(_.name===d)return _.name=y.value,_.desc=w.value,!0}),!0});const E=l.querySelector(".b3-menu__items").scrollTop,C=l.querySelector(".b3-chips"),$=C?C.clientHeight:0;s?(s.forEach((M,k)=>{const _=Ba(M,r);r==="table"||i?M=s[k]=a.querySelector(`.av__row[data-id="${_}"] .av__cell[data-col-id="${M.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${M.dataset.colId}"]`):M=s[k]=a.querySelector(`.av__gallery-item[data-id="${_}"] .av__cell[data-field-id="${M.dataset.fieldId}"]`),Kn[k].mSelect.find(v=>{if(v.content===d)return v.content=y.value,!0}),M.classList.contains("custom-attr__avvalue")?M.innerHTML=Ji(Kn[k]):On(M,Kn[k])}),l.innerHTML=er(f,s,!1,a),Qo(t,e,l,s,a)):(l.innerHTML=oi({protyle:t,data:e,colId:c,isCustomAttr:i}),ri({protyle:t,data:e,menuElement:l,isCustomAttr:i,blockID:o})),C&&(l.querySelector(".b3-menu__items").scrollTop=E+(l.querySelector(".b3-chips").clientHeight-$))});if(g.isOpen)return;g.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div>
<div class="b3-form__icona fn__block">
    <input class="b3-text-field b3-form__icona-input" type="text" size="16">
    <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${u?Zt(u):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea rows="1" placeholder="${window.siyuan.languages.addDesc}" class="b3-text-field fn__block" type="text" data-value="${at(u)}">${u}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(E){const C=E.querySelector("input");C.addEventListener("keydown",M=>{M.isComposing||M.key==="Enter"&&g.close()}),C.value=d;const $=E.querySelector("textarea");C.nextElementSibling.addEventListener("click",()=>{const M=$.parentElement;M.classList.toggle("fn__none"),M.classList.contains("fn__none")||$.focus()}),$.addEventListener("keydown",M=>{M.isComposing||M.key==="Enter"&&g.close()}),$.addEventListener("input",()=>{C.nextElementSibling.setAttribute("aria-label",$.value?he($.value):window.siyuan.languages.addDesc)})}}),g.addItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){Re(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let E=[];f.find(_=>{if(_.id===c)return E=_.options,!0});const C=n.parentElement.dataset.name;V(t,[{action:"removeAttrViewColOption",id:c,avID:e.id,data:C},{action:"doUpdateUpdated",id:o,data:Q().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOptions",id:c,avID:e.id,data:E}]),E.find((_,v)=>{if(_.name===C)return E.splice(v,1),!0});const $=l.querySelector(".b3-menu__items").scrollTop,M=l.querySelector(".b3-chips"),k=M?M.clientHeight:0;s?(s.forEach((_,v)=>{const S=Ba(_,r);r==="table"||i?_=s[v]=a.querySelector(`.av__row[data-id="${S}"] .av__cell[data-col-id="${_.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${_.dataset.colId}"]`):_=s[v]=a.querySelector(`.av__gallery-item[data-id="${S}"] .av__cell[data-field-id="${_.dataset.fieldId}"]`),Kn[v].mSelect.find((L,D)=>{if(L.content===C)return Kn[v].mSelect.splice(D,1),!0}),_.classList.contains("custom-attr__avvalue")?_.innerHTML=Ji(Kn[v]):On(_,Kn[v])}),l.innerHTML=er(f,s,!1,a),Qo(t,e,l,s,a)):(l.innerHTML=oi({protyle:t,data:e,colId:c,isCustomAttr:i}),ri({protyle:t,data:e,menuElement:l,isCustomAttr:i,blockID:o})),M&&(l.querySelector(".b3-menu__items").scrollTop=$+(l.querySelector(".b3-chips").clientHeight-k))},void 0,!0)}}),g.addSeparator();let h='<div class="fn__flex fn__flex-wrap" style="width: 238px">';Array.from(Array(14).keys()).forEach(E=>{h+=`<button data-color="${E+1}" class="color__square${parseInt(m)===E+1?" color__square--current":""}" style="color: var(--b3-font-color${E+1});background-color: var(--b3-font-background${E+1});">A</button>`}),g.addItem({type:"empty",iconHTML:"",label:h+"</div>",bind(E){E.addEventListener("click",C=>{var $;const M=C.target;if(M.classList.contains("color__square")&&!M.classList.contains("color__square--current")){($=E.querySelector(".color__square--current"))==null||$.classList.remove("color__square--current"),M.classList.add("color__square--current");const k=M.getAttribute("data-color");V(t,[{action:"updateAttrViewColOption",id:c,avID:e.id,data:{oldName:d,newName:y.value,oldColor:m,newColor:k,newDesc:w.value}},{action:"doUpdateUpdated",id:o,data:Q().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOption",id:c,avID:e.id,data:{oldName:y.value,newName:d,oldColor:k,newColor:m,newDesc:w.value}}]),f.find(v=>{if(v.id===c)return v.options.find(S=>{if(S.name===d)return S.name=y.value,S.color=k,!0}),!0});const _=l.querySelector(".b3-menu__items").scrollTop;s?(s.forEach((v,S)=>{const L=Ba(v,r);r==="table"?v=s[S]=a.querySelector(`.av__row[data-id="${L}"] .av__cell[data-col-id="${v.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${v.dataset.colId}"]`):v=s[S]=a.querySelector(`.av__gallery-item[data-id="${L}"] .av__cell[data-field-id="${v.dataset.fieldId}"]`),Kn[S].mSelect.find(D=>{if(D.content===d)return D.content=y.value,D.color=k,!0}),v.classList.contains("custom-attr__avvalue")?v.innerHTML=Ji(Kn[S]):On(v,Kn[S])}),l.innerHTML=er(f,s,!1,a),Qo(t,e,l,s,a)):(l.innerHTML=oi({protyle:t,data:e,colId:c,isCustomAttr:i}),ri({protyle:t,data:e,menuElement:l,isCustomAttr:i,blockID:o})),l.querySelector(".b3-menu__items").scrollTop=_,d=y.value,u=w.value,m=k}})}});const b=n.getBoundingClientRect();g.open({x:b.right,y:b.bottom,w:b.width,h:b.height});const y=window.siyuan.menus.menu.element.querySelector("input");y.select();const w=window.siyuan.menus.menu.element.querySelector("textarea")},Qo=(t,e,n,a,i)=>{const s=n.querySelector("input"),l=Xn(a[0],i.getAttribute("data-av-type"));let o;yt(e).find(c=>{if(c.id===l){o=c;return}}),o.options||(o.options=[]);const r=n.lastElementChild.lastElementChild;s.addEventListener("input",c=>{c.isComposing||(r.innerHTML=eb(s.value,o.options))}),s.addEventListener("compositionend",()=>{r.innerHTML=eb(s.value,o.options)}),s.addEventListener("keydown",c=>{if(c.isComposing)return;let d=xn(r,c,"b3-menu__item--current",r.firstElementChild);c.key==="Enter"?(d||(d=n.querySelector(".b3-menu__item--current")),d.querySelector(".b3-menu__checked")?Lp(t,a,n.querySelector(`.b3-chips .b3-chip[data-content="${at(d.dataset.name)}"]`),i):Jv(t,e,a,d,n,i)):c.key==="Backspace"&&s.value===""&&Lp(t,a,s.previousElementSibling,i)})},Jv=(t,e,n,a,i,s)=>{let l=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(g=>{if(g.dataset.content===a.dataset.name)return l=!0,!0}),l){i.querySelector("input").focus();return}B(n[0])||n.forEach((g,h)=>{const b=Ba(g,e.viewType);e.viewType==="table"||Wv(g)?n[h]=s.querySelector(`.av__row[data-id="${b}"] .av__cell[data-col-id="${g.dataset.colId}"]`)||s.querySelector(`.fn__flex-1[data-col-id="${g.dataset.colId}"]`):n[h]=s.querySelector(`.av__gallery-item[data-id="${b}"] .av__cell[data-field-id="${g.dataset.fieldId}"]`)});const r=Xn(n[0],s.getAttribute("data-av-type"));let c;const d=yt(e);d.find(g=>{if(g.id===r){c=g,c.options||(c.options=[]);return}});const u=[],m=[];let f;if(n.forEach((g,h)=>{const b=Ba(g,e.viewType);if(!b)return;const y=Kn[h],w=JSON.parse(JSON.stringify(y));if(h===0){if(c.type==="mSelect"){let E=!1;y.mSelect.find(C=>{if(C.content===a.dataset.name)return E=!0,!0}),E||y.mSelect.push({color:a.dataset.color,content:a.dataset.name})}else y.mSelect=[{color:a.dataset.color,content:a.dataset.name}];f=y.mSelect}else y.mSelect=f;u.push({action:"updateAttrViewCell",id:y.id,keyID:r,rowID:b,avID:e.id,data:y}),m.push({action:"updateAttrViewCell",id:y.id,keyID:r,rowID:b,avID:e.id,data:w}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=Ji(y):On(g,y)}),a.querySelector(".b3-menu__accelerator")?(c.options.push({color:a.dataset.color,name:a.dataset.name}),u.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:e.id,data:c.options}),u.push({action:"doUpdateUpdated",id:s.getAttribute("data-node-id"),data:Q().format("YYYYMMDDHHmmss")}),V(t,u,[{action:"removeAttrViewColOption",id:r,avID:e.id,data:a.dataset.name}])):(u.push({action:"doUpdateUpdated",id:s.getAttribute("data-node-id"),data:Q().format("YYYYMMDDHHmmss")}),V(t,u,m)),c.type==="select")s.setAttribute("data-rendering","true"),i.parentElement.dispatchEvent(new CustomEvent("click",{detail:"close"}));else{const g=i.querySelector(".b3-menu__items").scrollTop,h=i.querySelector(".b3-chips").clientHeight;i.innerHTML=er(d,n,!1,s),Qo(t,e,i,n,s),i.querySelector("input").focus(),i.querySelector(".b3-menu__items").scrollTop=g+(i.querySelector(".b3-chips").clientHeight-h)}},er=(t,e,n=!1,a)=>{var i;if(n){Kn=[];const c=e[0].classList.contains("custom-attr__avvalue");e.forEach(d=>{Kn.push(Ci(c?d.dataset.type:Zn(d),d))})}const s=Xn(e[0],a.getAttribute("data-av-type")),l=t.find(c=>{if(c.id===s)return c});let o="";const r=[];return(i=Kn[0].mSelect)==null||i.forEach(c=>{r.push(c.content),o+=`<div class="b3-chip b3-chip--middle" data-content="${at(c.content)}" style="white-space: nowrap;max-width:100%;background-color:var(--b3-font-background${c.color});color:var(--b3-font-color${c.color})"><span class="fn__ellipsis">${he(c.content)}</span><svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${o}
    <input>
</div>
<div>${eb("",l.options,r)}</div>
</div>`},y0=(t,e,n)=>{const a=[],i=[];return e.mSelect.forEach(s=>{var l;if(t.options||(t.options=[]),!t.options.find(r=>{if(r.name===s.content)return s.color=r.color,!0})){const r=((((l=t.options)==null?void 0:l.length)||0)%14+1).toString();t.options.push({name:s.content,color:r}),s.color=r,a.push({action:"updateAttrViewColOptions",id:t.id,avID:n,data:t.options}),i.push({action:"removeAttrViewColOption",id:t.id,avID:n,data:s.content})}}),{doOperations:a,undoOperations:i}},_0=t=>{const e=new dt(p.MENU_AV_ADD_SORT),n=yt(t.data);n.forEach(a=>{let i=!1;a.type==="lineNumber"?i=!0:t.data.view.sorts.find(s=>{if(s.column===a.id)return i=!0,!0}),i||e.addItem({label:a.name,iconHTML:a.icon?be(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(a.type)}"></use></svg>`,click:()=>{const s=Object.assign([],t.data.view.sorts);t.data.view.sorts.push({column:a.id,order:"ASC"}),V(t.protyle,[{action:"setAttrViewSorts",avID:t.data.id,data:t.data.view.sorts,blockID:t.blockID}],[{action:"setAttrViewSorts",avID:t.data.id,data:s,blockID:t.blockID}]),t.menuElement.innerHTML=nr(n,t.data.view.sorts),tr(t.protyle,t.menuElement,t.data,t.blockID),Te(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height)}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},tr=(t,e,n,a)=>{e.querySelectorAll("select").forEach(i=>{i.addEventListener("change",()=>{const s=i.parentElement.getAttribute("data-id"),l=JSON.parse(JSON.stringify(n.view.sorts));i.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(o=>{if(o.column===s)return o.column=i.value,i.parentElement.setAttribute("data-id",i.value),!0}):n.view.sorts.find(o=>o.column===s).order=i.value,V(t,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts,blockID:a}],[{action:"setAttrViewSorts",avID:n.id,data:l,blockID:a}])})})},nr=(t,e)=>{let n="";const a=i=>{let s="";return t.forEach(l=>{s+=`<option value="${l.id}" ${l.id===i?"selected":""}>${l.icon&&be(l.icon)}${l.name}</option>`}),s};return e.forEach(i=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select fn__flex-1" style="margin: 4px 0">
        ${a(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${e.length===t.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addSort}</span>
</button>
<button class="b3-menu__item b3-menu__item--warning${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeSorts}</span>
</button>
</div>`},w0=t=>{const e=Ci("date",t[0]).date,n=e.isNotTime;let a="";const i=new Date().getTime();if(e.isNotEmpty){a=Q(e.content).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const l=a.split("-")[0];l.length!==4&&(a=new Array(4-l.length).fill(0).join("")+a)}else a=Q(i).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let s="";if(e.isNotEmpty2){s=Q(e.content2).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const l=s.split("-")[0];l.length!==4&&(s=new Array(4-l.length).fill(0).join("")+s)}else e.hasEndDate&&(s=Q(i).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));return`<div class="b3-menu__items">
<div>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${a}" data-value="${Q(e.content||i).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${s}" data-value="${e.isNotEmpty2?Q(e.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${e.hasEndDate?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${e.hasEndDate?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${n?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},v0=t=>{const e=t.menuElement.querySelectorAll("input");return e.forEach(n=>{n.addEventListener("keydown",a=>{var i;a.isComposing||a.key==="Enter"&&(Bn(t.protyle,t.blockElement,{content:Ap(e[0].dataset.value)||0,isNotEmpty:e[0].value!=="",content2:Ap(e[1].dataset.value)||0,isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements),(i=document.querySelector(".av__panel"))==null||i.dispatchEvent(new CustomEvent("click",{detail:"close"})))})}),e[0].addEventListener("change",()=>{e[0].dataset.value=e[0].value.length>10?e[0].value:e[0].value+" 00:00"}),e[1].addEventListener("change",()=>{e[1].dataset.value=e[1].value.length>10?e[1].value:e[1].value+" 00:00"}),e[2].addEventListener("change",()=>{if(e[2].checked){if(!e[1].dataset.value){const n=new Date().getTime();e[1].dataset.value=Q(n).format("YYYY-MM-DD HH:mm"),e[1].value=Q(n).format(e[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}e[1].classList.remove("fn__none")}else e[1].classList.add("fn__none")}),e[3].addEventListener("change",()=>{e[0].value="",e[1].value="",e[3].checked?(e[0].setAttribute("type","datetime-local"),e[1].setAttribute("type","datetime-local"),e[0].setAttribute("max","9999-12-31 23:59"),e[1].setAttribute("max","9999-12-31 23:59"),e[0].value=e[0].dataset.value,e[1].value=e[1].dataset.value):(e[0].setAttribute("type","date"),e[1].setAttribute("type","date"),e[0].setAttribute("max","9999-12-31"),e[1].setAttribute("max","9999-12-31"),e[0].value=e[0].dataset.value.substring(0,10),e[1].value=e[1].dataset.value.substring(0,10))}),()=>{Bn(t.protyle,t.blockElement,{content:Ap(e[0].dataset.value)||0,isNotEmpty:e[0].value!=="",content2:Ap(e[1].dataset.value)||0,isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements)}},Ap=t=>{const e=t.split("-")[0],n=new Date(t);return(e.startsWith("00")||e.startsWith("000")||e.length<3)&&n.setFullYear(parseInt(e)),n.getTime()},gn=t=>{t.menu.addItem({iconHTML:"",label:Xv(t.format),click(){V(t.protyle,[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.oldFormat,type:"number"}]),t.avPanelElement.remove()}})},E0=t=>{const e=new dt(p.MENU_AV_COL_FORMAT_NUMBER);gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"commas",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"percent",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"USD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"CNY",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"EUR",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"GBP",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"JPY",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"RUB",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"INR",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"KRW",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"CAD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"CHF",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"THB",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"AUD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"HKD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"TWD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"MOP",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"SGD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),gn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"NZD",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},Xv=t=>t===""?window.siyuan.languages.numberFormatNone:t==="commas"?window.siyuan.languages.numberFormatCommas:t==="percent"?window.siyuan.languages.numberFormatPercent:window.siyuan.languages["numberFormat"+t],Qv=(t,e)=>{var n,a;if(e.classList.contains("b3-list--empty"))return;t.target.querySelector(".b3-menu__accelerator").textContent=e.querySelector(".b3-list-item__text").textContent;const i=yt(t.data).find(l=>{if(l.id===t.colId)return l.rollup||(l.rollup={}),!0});if(t.isRelation){if(e.dataset.colId===((n=i.rollup)==null?void 0:n.relationKeyID))return;i.rollup={relationKeyID:e.dataset.colId};const l=t.target.nextElementSibling;l.querySelector(".b3-menu__accelerator").textContent="",l.setAttribute("data-av-id",e.dataset.targetAvId);const o=l.nextElementSibling;o.removeAttribute("data-col-type"),o.removeAttribute("data-calc"),o.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(e.dataset.colId===((a=i.rollup)==null?void 0:a.keyID))return;i.rollup.keyID=e.dataset.colId,delete i.rollup.calc;const l=t.target.nextElementSibling;l.removeAttribute("data-calc"),l.setAttribute("data-col-type",e.dataset.colType),l.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const s=JSON.parse(JSON.stringify(i.rollup));V(t.protyle,[{action:"updateAttrViewColRollup",id:t.colId,avID:t.data.id,parentID:i.rollup.relationKeyID,keyID:i.rollup.keyID,data:{calc:i.rollup.calc}}],[{action:"updateAttrViewColRollup",id:t.colId,avID:t.data.id,parentID:s.relationKeyID,keyID:s.keyID,data:{calc:s.calc}}])},eE=(t,e,n,a,i)=>{if(!a&&!n){de(window.siyuan.languages.selectRelation);return}A(a?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewRollupDestKeys",{avID:n,keyword:e},s=>{let l="";s.data.keys.forEach((o,r)=>{l+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${o.id}" ${a?`data-target-av-id="${o.relation.avID}"`:`data-col-type="${o.type}"`}>
        ${o.icon?be(o.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${Gt(o.type)}"></use></svg>`}
        <span class="b3-list-item__text">${he(o.name||window.siyuan.languages.title)}</span>
</div>`}),t.innerHTML=l||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,i&&i()})},tE=t=>{window.siyuan.menus.menu.remove();const e=new dt;e.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[t.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const a=n.querySelector(".b3-list"),i=n.querySelector("input");i.addEventListener("keydown",s=>{if(s.isComposing)return;xn(a,s)&&s.stopPropagation(),s.key==="Enter"&&(s.preventDefault(),s.stopPropagation(),Qv(t,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),i.addEventListener("input",s=>{s.stopPropagation(),eE(a,i.value,t.isRelation?t.data.id:t.target.dataset.avId,t.isRelation)}),n.lastElementChild.addEventListener("click",s=>{const l=T(s.target,"b3-list-item");l&&(s.stopPropagation(),Qv(t,l),window.siyuan.menus.menu.remove())}),eE(a,"",t.isRelation?t.data.id:t.target.dataset.avId,t.isRelation,()=>{const s=t.target.getBoundingClientRect();e.open({x:s.left,y:s.bottom,h:s.height}),n.querySelector("input").focus()})}}),e.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},nE=t=>{var e,n;let a;return t.colData?a=t.colData:yt(t.data).find(i=>{if(i.id===Xn(t.cellElements[0],t.data.viewType))return a=i,!0}),`<button class="b3-menu__item b3-menu__item--current" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(a.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${Jh((n=(e=a.rollup)==null?void 0:e.calc)==null?void 0:n.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},aE=t=>{const e=t.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(e){const n=JSON.parse(e.dataset.oldValue),a=t.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let i="";n.relationKeyID&&yt(t.data).find(s=>{if(s.id===n.relationKeyID)return e.querySelector(".b3-menu__accelerator").textContent=s.name,i=s.relation.avID,a.dataset.avId=i,!0}),n.keyID&&i&&A("/api/av/getAttributeView",{id:i},s=>{s.data.av.keyValues.find(l=>{if(l.key.id===n.keyID){a.querySelector(".b3-menu__accelerator").textContent=l.key.name;const o=t.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return o.dataset.colType=l.key.type,n.calc&&(o.dataset.calc=n.calc.operator),!0}})})}};var k0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const iE=t=>{var e;let n="";const a=t.view;if(["gallery","kanban"].includes(t.viewType)){let i="";a.coverFrom===0?i=window.siyuan.languages.calcOperatorNone:a.coverFrom===1?i=window.siyuan.languages.contentImage:a.coverFrom===3?i=window.siyuan.languages.contentBlock:a.fields.find(s=>{if(s.type==="mAsset"&&s.id===a.coverFromAssetKeyID)return i=s.name,!0}),n=`<button class="b3-menu__item" data-type="set-gallery-cover">
    <span class="fn__flex-center">${window.siyuan.languages.cardPreview1}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${i}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-gallery-ratio">
    <span class="fn__flex-center">${window.siyuan.languages.cardAspectRatio}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${Xh(a.cardAspectRatio)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-gallery-size">
    <span class="fn__flex-center">${window.siyuan.languages.cardSize}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${a.cardSize===0?window.siyuan.languages.small:a.cardSize===1?window.siyuan.languages.medium:window.siyuan.languages.large}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fitImage}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-gallery-fit" type="checkbox" class="b3-switch b3-switch--menu" ${a.fitImage?"checked":""}>
</label>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.displayFieldName}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-gallery-name" type="checkbox" class="b3-switch b3-switch--menu" ${a.displayFieldName?"checked":""}>
</label>`}return n=`<div class="b3-menu__items">
    <button class="b3-menu__item" data-type="nobg">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.layout}</span>
    </button>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="nobg">
        <div class="av__layout">
            <div data-type="set-layout" data-view-type="table" class="av__layout-item${t.viewType==="table"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconTable"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.table}</div>
            </div>
            <div data-type="set-layout" data-view-type="kanban" class="av__layout-item${t.viewType==="kanban"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconBoard"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.kanban}</div>
            </div>
            <div data-type="set-layout" data-view-type="gallery" class="av__layout-item${t.viewType==="gallery"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconGallery"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.gallery}</div>
            </div>
        </div>
    </button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${a.hideAttrViewName?"":"checked"}>
    </label>
    ${n}
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.showAllEntriesIcons}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-entries-icons" type="checkbox" class="b3-switch b3-switch--menu" ${a.showIcon?"checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.wrapAllFields}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-entries-wrap" type="checkbox" class="b3-switch b3-switch--menu" ${a.wrapField?"checked":""}>
    </label>`,t.viewType==="kanban"&&["select","mSelect"].includes((e=t.view.groups[0].groupValue)==null?void 0:e.type)&&(n+=`<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.useBackground}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-kanban-bg" type="checkbox" class="b3-switch b3-switch--menu" ${a.fillColBackgroundColor?"checked":""}>
</label>`),n+`<button class="b3-menu__item" data-type="set-page-size" data-size="${a.pageSize}">
        <span class="fn__flex-center">${window.siyuan.languages.entryNum}</span>
        <span class="fn__flex-1"></span>
        <span class="b3-menu__accelerator">${a.pageSize===p.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:a.pageSize}</span>
        <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
    </button>
</div>`},sE=t=>{const e=t.blockElement.getAttribute("data-av-id"),n=t.blockElement.getAttribute("data-node-id"),a=t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),i=t.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');i.addEventListener("change",()=>{const d=i.checked;V(t.protyle,[{action:"hideAttrViewName",avID:e,blockID:n,data:!d,viewID:a}],[{action:"hideAttrViewName",avID:e,blockID:n,data:d,viewID:a}]),t.data.view.hideAttrViewName=!d});const s=t.menuElement.querySelector('.b3-switch[data-type="toggle-entries-icons"]');s.addEventListener("change",()=>{const d=s.checked;V(t.protyle,[{action:"setAttrViewShowIcon",avID:e,blockID:n,data:d,viewID:a}],[{action:"setAttrViewShowIcon",avID:e,blockID:n,data:!d,viewID:a}]),t.data.view.showIcon=d});const l=t.menuElement.querySelector('.b3-switch[data-type="toggle-entries-wrap"]');if(l.addEventListener("change",()=>{const d=l.checked;V(t.protyle,[{action:"setAttrViewWrapField",avID:e,blockID:n,data:d,viewID:a}],[{action:"setAttrViewWrapField",avID:e,blockID:n,data:!d,viewID:a}]),yt(t.data).forEach(u=>{u.wrap=d}),t.data.view.wrapField=d}),t.data.viewType==="table")return;const o=t.menuElement.querySelector('.b3-switch[data-type="toggle-gallery-fit"]');o.addEventListener("change",()=>{const d=o.checked;V(t.protyle,[{action:"setAttrViewFitImage",avID:e,blockID:n,data:d,viewID:a}],[{action:"setAttrViewFitImage",avID:e,blockID:n,data:!d,viewID:a}]),t.data.view.fitImage=d});const r=t.menuElement.querySelector('.b3-switch[data-type="toggle-gallery-name"]');if(r.addEventListener("change",()=>{const d=r.checked;V(t.protyle,[{action:"setAttrViewDisplayFieldName",avID:e,blockID:n,data:d}],[{action:"setAttrViewDisplayFieldName",avID:e,blockID:n,data:!d}]),t.data.view.displayFieldName=d}),t.data.viewType==="gallery")return;const c=t.menuElement.querySelector('.b3-switch[data-type="toggle-kanban-bg"]');c.addEventListener("change",()=>{const d=c.checked;V(t.protyle,[{action:"setAttrViewFillColBackgroundColor",avID:e,blockID:n,data:d,viewID:a}],[{action:"setAttrViewFillColBackgroundColor",avID:e,blockID:n,data:!d,viewID:a}]),t.data.view.fillColBackgroundColor=d})},S0=t=>k0(void 0,null,function*(){if(t.target.classList.contains("av__layout-item--select")||t.target.dataset.load==="true")return;t.target.dataset.load="true",t.target.parentElement.querySelector(".av__layout-item--select").classList.remove("av__layout-item--select"),t.target.classList.add("av__layout-item--select");const e=yield Ae("/api/av/changeAttrViewLayout",{blockID:t.nodeElement.getAttribute("data-node-id"),avID:t.nodeElement.getAttribute("data-av-id"),layoutType:t.target.getAttribute("data-view-type")}),n=document.querySelector(".av__panel").lastElementChild;return n.innerHTML=iE(e.data),sE({protyle:t.protyle,data:e.data,menuElement:n,blockElement:t.nodeElement}),t.target.removeAttribute("data-load"),e.data});var zc=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const xp=t=>{const e={};let n;return t.querySelectorAll(".av__body").forEach(a=>{const i=a.dataset.groupId,s=parseInt(a.dataset.pageSize);i?e[i]={pageSize:s}:n||(n=s)}),{groupPageSize:e,unGroupPageSize:n}},L0=t=>zc(void 0,null,function*(){const e=t.blockElement.getAttribute("data-node-id"),n=yt(t.data).find(l=>l.id===t.fieldId),a=n?{field:t.fieldId,method:n.type==="number"?1:["date","updated","created"].includes(n.type)?2:0,order:0,range:n.type==="number"?{numStart:0,numEnd:1e3,numStep:100}:null,hideEmpty:!0}:{field:null,method:null,order:null,range:null,hideEmpty:null},i=yield Ae("/api/av/setAttrViewGroup",{blockID:e,avID:t.blockElement.getAttribute("data-av-id"),group:a});t.data.view=i.data.view,t.menuElement.innerHTML=ar(yt(t.data),t.data.view),jc({protyle:t.protyle,menuElement:t.menuElement,blockElement:t.blockElement,data:t.data});const s=t.blockElement.querySelector(".av__views").getBoundingClientRect();Te(t.menuElement,s.right-t.menuElement.clientWidth,s.bottom,s.height)}),lE=(t,e,n)=>{const a='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>';let i=n==="kanban"?"":`<button class="b3-menu__item" data-type="setGroupMethod">
    <div class="b3-menu__label">${window.siyuan.languages.calcOperatorNone}</div>
    ${!e||!e.field?a:""}
</button>`;return t.forEach(s=>{["rollup","mAsset","lineNumber"].includes(s.type)||(i+=`<button class="b3-menu__item" data-id="${s.id}" data-type="setGroupMethod">
    <div class="b3-menu__label fn__flex">
        ${s.icon?be(s.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(s.type)}"></use></svg>`}
        ${he(s.name)||"&nbsp;"}
    </div>
    ${(e==null?void 0:e.field)===s.id?a:""}
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="${!e||!e.field?"go-config":"goGroups"}">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.groupMethod}</span>
</button>
<button class="b3-menu__separator"></button>
${i}
</div>`},Gc=(t,e)=>{if(e==="sort")switch(t){case 0:return window.siyuan.languages.asc;case 1:return window.siyuan.languages.desc;case 2:return window.siyuan.languages.customSort;case 3:return window.siyuan.languages.sortBySelectOption;default:return""}else if(e==="date")switch(t){case 2:return window.siyuan.languages.groupMethodDateRelative;case 3:return window.siyuan.languages.groupMethodDateDay;case 4:return window.siyuan.languages.groupMethodDateWeek;case 5:return window.siyuan.languages.groupMethodDateMonth;case 6:return window.siyuan.languages.groupMethodDateYear;default:return""}},A0=t=>{var e,n,a;return`<div class="b3-menu__items">
    <button class="b3-menu__item" data-type="nobg">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goGroups">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.numberFormatNone}</span>
    </button>
    <button class="b3-menu__separator"></button>
    <div class="b3-menu__item" data-type="nobg">
        <div class="fn__block">
            <div class="b3-menu__labels">${window.siyuan.languages.groupRange}</div>
            <div class="fn__flex">
                <input data-type="avGroupRange" class="b3-text-field fn__flex-1" value="${((e=t==null?void 0:t.range)==null?void 0:e.numStart)||0}">
                <span class="fn__space"></span>-<span class="fn__space"></span>
                <input class="b3-text-field fn__flex-1" value="${((n=t==null?void 0:t.range)==null?void 0:n.numEnd)||1e3}">            
            </div>
            <div class="fn__hr"></div>
            <div class="b3-menu__labels">${window.siyuan.languages.groupStep}</div>
            <input class="b3-text-field fn__block" value="${((a=t==null?void 0:t.range)==null?void 0:a.numStep)||100}">
            <div class="fn__hr--small"></div>
        </div>
    </div>
</div>`},x0=t=>()=>zc(void 0,null,function*(){if(!t.menuElement.querySelector('[data-type="avGroupRange"]'))return;const e=t.blockElement.getAttribute("data-node-id"),n=t.menuElement.querySelectorAll("input"),a={numStart:n[0].value?parseFloat(n[0].value):t.data.view.group.range.numStart,numEnd:n[1].value?parseFloat(n[1].value):t.data.view.group.range.numEnd,numStep:n[2].value?parseFloat(n[2].value):t.data.view.group.range.numStep};if(rn(t.data.view.group.range,a))return;Object.assign(t.data.view.group.range,a);const i=yield Ae("/api/av/setAttrViewGroup",{blockID:e,avID:t.blockElement.getAttribute("data-av-id"),group:t.data.view.group});t.data.view=i.data.view}),ar=(t,e)=>{var n;let a="",i;if(e.group&&e.group.field){let s="";if(i=t.find(l=>l.id===e.group.field),((n=e.groups)==null?void 0:n.length)>0){const l=["created","date","created","updated"].includes(i.type);let o=0;e.groups.forEach(r=>{var c,d,u;r.groupHidden===0&&o++;let m=`<div class="b3-menu__label fn__flex-1 fn__ellipsis">${r.name||""}</div>`;((d=(c=r.groupValue)==null?void 0:c.mSelect)==null?void 0:d.length)>0?m=`<div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${r.groupValue.mSelect[0].color});color:var(--b3-font-color${r.groupValue.mSelect[0].color})">
            <span class="fn__ellipsis">${he(r.groupValue.mSelect[0].content)}</span>
        </span>
    </div>`:((u=r.groupValue)==null?void 0:u.type)=="checkbox"&&(m=`<div class="b3-menu__label fn__flex">
<svg class="b3-menu__icon"><use xlink:href="#icon${r.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg> ${i.name||""}
</div>`),s+=`<button class="b3-menu__item${r.groupHidden===0?"":" b3-menu__item--hidden"}" draggable="${l?"false":"true"}" data-id="${r.id}">
    ${l?"":'<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>'}
    ${m}
    <svg class="b3-menu__action b3-menu__action--show" data-type="hideGroup" data-id="${r.id}"><use xlink:href="#iconEye${r.groupHidden===0?"":"off"}"></use></svg>
</button>`}),s=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label"></span>
    <span class="block__icon" data-type="hideGroups">
        ${window.siyuan.languages[o===0?"showAll":"hideAll"]}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye${o===0?"":"off"}"></use></svg>
    </span>
</button>`+s}a=`<button class="b3-menu__item${["date","updated","created"].includes(i.type)?"":" fn__none"}" data-type="goGroupsDate">
    <span class="b3-menu__label">${window.siyuan.languages.date}</span>
    <span class="b3-menu__accelerator">${Gc(e.group.method,"date")}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item${i.type==="number"?"":" fn__none"}" data-type="getGroupsNumber">
    <span class="b3-menu__label">${window.siyuan.languages.numberFormatNone}</span>
    <span class="b3-menu__accelerator">${e.group.range&&typeof e.group.range.numStart=="number"?`${e.group.range.numStart} - ${e.group.range.numEnd}`:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item${["checkbox","rollup","mAsset"].includes(i.type)?" fn__none":""}" data-type="goGroupsSort">
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${Gc(e.group.order,"sort")}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.hideEmptyGroup}</span>
    <span class="fn__space fn__flex-1"></span>
    <input type="checkbox" class="b3-switch b3-switch--menu"${e.group.hideEmpty?" checked":""}>
</label>
${s}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item b3-menu__item--warning" data-type="removeGroups">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeGroup}</span>
</button>`}return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.group}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="goGroupsMethod">
    <span class="b3-menu__label">${window.siyuan.languages.groupMethod}</span>
    <span class="b3-menu__accelerator">${i?i.name:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
${a}
</div>`},jc=t=>{const e=t.menuElement.querySelector("input");if(!e)return;const n=t.blockElement.getAttribute("data-node-id");e.addEventListener("change",()=>zc(void 0,null,function*(){t.data.view.group.hideEmpty=e.checked;const a=yield Ae("/api/av/setAttrViewGroup",{blockID:n,avID:t.blockElement.getAttribute("data-av-id"),group:t.data.view.group});t.data.view=a.data.view,t.menuElement.innerHTML=ar(yt(t.data),t.data.view),jc({protyle:t.protyle,menuElement:t.menuElement,blockElement:t.blockElement,data:t.data});const i=t.blockElement.querySelector(".av__views").getBoundingClientRect();Te(t.menuElement,i.right-t.menuElement.clientWidth,i.bottom,i.height)}))},C0=t=>{const e=new dt(p.MENU_AV_GROUP_DATE);if(e.isOpen)return;const n=t.blockElement.getAttribute("data-node-id");[2,3,4,5,6].forEach(i=>{const s=Gc(i,"date");e.addItem({iconHTML:"",checked:t.data.view.group.method===i,label:s,click(){return zc(this,null,function*(){t.data.view.group.method=i,t.target.querySelector(".b3-menu__accelerator").textContent=s;const l=yield Ae("/api/av/setAttrViewGroup",{blockID:n,avID:t.blockElement.getAttribute("data-av-id"),group:t.data.view.group});t.data.view=l.data.view,t.menuElement.innerHTML=ar(yt(t.data),t.data.view),jc({protyle:t.protyle,menuElement:t.menuElement,blockElement:t.blockElement,data:t.data});const o=t.blockElement.querySelector(".av__views").getBoundingClientRect();Te(t.menuElement,o.right-t.menuElement.clientWidth,o.bottom,o.height)})}})});const a=t.target.getBoundingClientRect();e.open({isLeft:!0,x:a.right,y:a.bottom})},T0=t=>{const e=new dt(p.MENU_AV_GROUP_SORT);if(e.isOpen)return;const n=t.blockElement.getAttribute("data-node-id"),a=yt(t.data).find(s=>s.id===t.data.view.group.field);(["created","date","created","updated"].includes(a.type)?[0,1]:["mSelect","select"].includes(a.type)?[3,2,0,1]:[2,0,1]).forEach(s=>{const l=Gc(s,"sort");e.addItem({iconHTML:"",checked:t.data.view.group.order===s,label:l,click(){return zc(this,null,function*(){t.target.querySelector(".b3-menu__accelerator").textContent=l,t.data.view.group.order=s;const o=yield Ae("/api/av/setAttrViewGroup",{blockID:n,avID:t.blockElement.getAttribute("data-av-id"),group:t.data.view.group});t.data.view=o.data.view,t.menuElement.innerHTML=ar(yt(t.data),t.data.view),jc({protyle:t.protyle,menuElement:t.menuElement,blockElement:t.blockElement,data:t.data});const r=t.blockElement.querySelector(".av__views").getBoundingClientRect();Te(t.menuElement,r.right-t.menuElement.clientWidth,r.bottom,r.height)})}})});const i=t.target.getBoundingClientRect();e.open({isLeft:!0,x:i.right,y:i.bottom})};var D0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Cn=t=>{var e;let n=document.querySelector(".av__panel");if(n){n.remove();return}const a=t.blockElement.getAttribute("data-av-id"),i=xp(t.blockElement);A("/api/av/renderAttributeView",{id:a,query:((e=t.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:e.value.trim())||"",pageSize:i.unGroupPageSize,groupPaging:i.groupPageSize,viewID:t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW)},s=>{var l;if(n=document.querySelector(".av__panel"),n){n.remove();return}window.siyuan.menus.menu.remove();const o=t.blockElement.getAttribute("data-node-id"),r=!t.blockElement.classList.contains("av");let c=s.data,d,u=yt(c);if(t.type==="config")d=Nw(c);else if(t.type==="properties")d=Cs(u);else if(t.type==="sorts")d=nr(u,c.view.sorts);else if(t.type==="switcher")d=KA(c.views,c.viewID);else if(t.type==="filters")d=Ts(c);else if(t.type==="select")d=er(u,t.cellElements,!0,t.blockElement);else if(t.type==="asset")d=qv(t.cellElements);else if(t.type==="edit")t.editData&&(typeof t.editData.colData.wrap=="undefined"&&(t.editData.colData.wrap=c.view.wrapField),t.editData.previousID?u.find((y,w)=>{if(y.id===t.editData.previousID)return u.splice(w+1,0,t.editData.colData),!0}):c.viewType==="table"?u.splice(0,0,t.editData.colData):u.push(t.editData.colData)),d=oi({protyle:t.protyle,data:c,colId:t.colId,isCustomAttr:r});else if(t.type==="date")d=w0(t.cellElements);else if(t.type==="rollup")d=`<div class="b3-menu__items">${nE({data:c,cellElements:t.cellElements})}</div>`;else if(t.type==="relation"&&(d=QA(c,t.cellElements),!d)){Cn({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:Xn(t.cellElements[0],c.viewType)});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex};">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu" ${["select","date","asset","relation","rollup"].includes(t.type)?`style="min-width: 200px;${Y()?"max-width: 90vw;":"max-width: 50vw;"}"`:""}>${d}</div>
</div>`),n=document.querySelector(".av__panel");let m;const f=n.lastElementChild;let g=(l=t.blockElement.querySelector(`.av__views, .av__row[data-col-id="${t.colId}"] > .block__logo`))==null?void 0:l.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(t.type)){let y=t.cellElements[t.cellElements.length-1];if(!t.blockElement.contains(y)){const E=Ba(y,c.viewType);c.viewType==="table"?y=t.blockElement.querySelector(`.av__row[data-id="${E}"] .av__cell[data-col-id="${y.dataset.colId}"]`):y=t.blockElement.querySelector(`.av__gallery-item[data-id="${E}"] .av__cell[data-field-id="${y.dataset.fieldId}"]`)}const w=(y||t.cellElements[t.cellElements.length-1]).getBoundingClientRect();if(t.type==="select"?Qo(t.protyle,c,f,t.cellElements,t.blockElement):t.type==="date"?m=v0({protyle:t.protyle,data:c,menuElement:f,cellElements:t.cellElements,blockElement:t.blockElement}):t.type==="asset"?(Rv({protyle:t.protyle,menuElement:f,cellElements:t.cellElements,blockElement:t.blockElement}),setTimeout(()=>{Te(f,w.left,w.bottom,w.height)},p.TIMEOUT_LOAD)):t.type==="relation"?XA({menuElement:f,cellElements:t.cellElements,protyle:t.protyle,blockElement:t.blockElement}):t.type==="rollup"&&aE({protyle:t.protyle,data:c,menuElement:f}),["select","date","relation","rollup"].includes(t.type)){const E=f.querySelector("input");E&&(E.select(),E.focus()),Te(f,w.left,w.bottom,w.height)}}else Te(f,g.right-f.clientWidth,g.bottom,g.height),t.type==="sorts"?tr(t.protyle,f,c,o):t.type==="edit"?ri({protyle:t.protyle,data:c,menuElement:f,isCustomAttr:r,blockID:o}):t.type==="config"?Pw({protyle:t.protyle,data:c,menuElement:f,blockElement:t.blockElement}):t.type==="switcher"&&jA({protyle:t.protyle,menuElement:f,blockElement:t.blockElement});t.cb&&t.cb(n),n.addEventListener("dragstart",y=>{window.siyuan.dragElement=y.target,window.siyuan.dragElement.style.opacity=".38"}),n.addEventListener("drop",y=>{var w,E,C,$,M,k;if(b=0,!window.siyuan.dragElement){y.preventDefault(),y.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const _=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,t.protyle&&t.protyle.disabled){y.preventDefault(),y.stopPropagation();return}if(!t.protyle&&window.siyuan.config.readonly){y.preventDefault(),y.stopPropagation();return}const v=n.querySelector(".dragover__bottom, .dragover__top");if(!v)return;const S=v.classList.contains("dragover__top"),L=_.dataset.id,D=v.dataset.id;if(v.querySelector('[data-type="removeSort"]')){const I=c.view.sorts,q=Object.assign([],I);let Z;I.find((R,F)=>{if(R.column===L)return Z=I.splice(F,1)[0],!0}),I.find((R,F)=>{if(R.column===D)return S?I.splice(F,0,Z):I.splice(F+1,0,Z),!0}),V(t.protyle,[{action:"setAttrViewSorts",avID:a,data:I,blockID:o}],[{action:"setAttrViewSorts",avID:a,data:q,blockID:o}]),f.innerHTML=nr(u,c.view.sorts),tr(t.protyle,f,c,o);return}if(v.querySelector('[data-type="removeFilter"]')){const I=c.view.filters,q=Object.assign([],I);let Z;I.find((R,F)=>{if(R.column===L)return Z=I.splice(F,1)[0],!0}),I.find((R,F)=>{if(R.column===D)return S?I.splice(F,0,Z):I.splice(F+1,0,Z),!0}),V(t.protyle,[{action:"setAttrViewFilters",avID:a,data:I,blockID:o}],[{action:"setAttrViewFilters",avID:a,data:q,blockID:o}]),f.innerHTML=Ts(c);return}if(v.querySelector('[data-type="av-view-edit"]')){V(t.protyle,[{action:"sortAttrViewView",avID:a,blockID:o,id:L,previousID:S?(w=v.previousElementSibling)==null?void 0:w.getAttribute("data-id"):v.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:a,blockID:o,id:L,previousID:(E=_.previousElementSibling)==null?void 0:E.getAttribute("data-id")}]),S?(v.before(_),v.classList.remove("dragover__top")):(v.after(_),v.classList.remove("dragover__bottom"));return}if(v.querySelector('[data-type="editAssetItem"]')){S?v.before(_):v.after(_);const I=[];Array.from(v.parentElement.children).forEach(q=>{["image","file"].includes(q.dataset.type)&&I.push({content:q.dataset.content,name:q.dataset.name,type:q.dataset.type})}),Ol({protyle:t.protyle,cellElements:t.cellElements,replaceValue:I,blockElement:t.blockElement});return}if(v.querySelector('[data-type="setColOption"]')){const I=t.cellElements?Xn(t.cellElements[0],c.viewType):f.querySelector(".b3-menu__item").getAttribute("data-col-id"),q=u.find(K=>K.id===I).options,Z=Object.assign([],q);let R;q.find((K,X)=>{if(K.name===_.dataset.name)return R=q.splice(X,1)[0],!0}),q.find((K,X)=>{if(K.name===v.dataset.name)return S?q.splice(X,0,R):q.splice(X+1,0,R),!0}),V(t.protyle,[{action:"updateAttrViewColOptions",id:I,avID:a,data:q}],[{action:"updateAttrViewColOptions",id:I,avID:a,data:Z}]);const F=f.querySelector(".b3-menu__items").scrollTop;t.cellElements?(f.innerHTML=er(u,t.cellElements,!1,t.blockElement),Qo(t.protyle,c,f,t.cellElements,t.blockElement)):(f.innerHTML=oi({protyle:t.protyle,data:c,colId:I,isCustomAttr:r}),ri({protyle:t.protyle,data:c,menuElement:f,isCustomAttr:r,blockID:o})),f.querySelector(".b3-menu__items").scrollTop=F;return}if(v.getAttribute("data-type")==="setRelationCell"){S?v.before(_):v.after(_),v.classList.remove("dragover__bottom","dragover__top");const I=[],q=[];v.parentElement.querySelectorAll(".fn__grab").forEach(Z=>{const R=Z.nextElementSibling;I.push(R.parentElement.dataset.rowId),q.push({isDetached:!R.style.color,type:"block",block:{content:R.textContent,id:R.dataset.id}})}),Bn(t.protyle,t.blockElement,{blockIDs:I,contents:q},t.cellElements);return}if(v.getAttribute("data-type")==="editCol"){const I=(S?(C=v.previousElementSibling)==null?void 0:C.getAttribute("data-id"):v.getAttribute("data-id"))||"",q=(($=_.previousElementSibling)==null?void 0:$.getAttribute("data-id"))||"";if(I!==q&&I!==L){V(t.protyle,[{action:"sortAttrViewCol",avID:a,previousID:I,id:L,blockID:o}],[{action:"sortAttrViewCol",avID:a,previousID:q,id:L,blockID:o}]);let Z;u.find((R,F)=>{if(R.id===L)return Z=u.splice(F,1)[0],!0}),u.find((R,F)=>{if(R.id===D)return S?u.splice(F,0,Z):u.splice(F+1,0,Z),!0})}f.innerHTML=Cs(u);return}if(v.querySelector('[data-type="hideGroup"]')){const I=(S?(M=v.previousElementSibling)==null?void 0:M.getAttribute("data-id"):v.getAttribute("data-id"))||"",q=((k=_.previousElementSibling)==null?void 0:k.getAttribute("data-id"))||"";I!==q&&I!==L&&(V(t.protyle,[{action:"sortAttrViewGroup",avID:a,blockID:o,previousID:I,id:L}],[{action:"sortAttrViewGroup",avID:a,blockID:o,previousID:q,id:L}]),f.querySelector('[data-type="goGroupsSort"] .b3-menu__accelerator').textContent=Gc(2,"sort"),c.view.group.order=2,c.view.groups.find((Z,R)=>{if(Z.id===L){const F=c.view.groups.splice(R,1)[0];return c.view.groups.find((K,X)=>{if(K.id===D)return S?c.view.groups.splice(X,0,F):c.view.groups.splice(X+1,0,F),!0}),!0}}),S?v.before(_):v.after(_)),v.classList.remove("dragover__top","dragover__bottom");return}});let h;n.addEventListener("dragover",y=>{if(y.dataTransfer.types.includes("Files")){y.preventDefault();return}const w=y.target;let E=j(w,"draggable","true");if(E||(E=j(document.elementFromPoint(y.clientX,y.clientY-1),"draggable","true")),!(!E||E===window.siyuan.dragElement)){if(y.preventDefault(),h&&E===h){const C=E.getBoundingClientRect();n.querySelectorAll(".dragover__bottom, .dragover__top").forEach($=>{$.classList.remove("dragover__bottom","dragover__top")}),y.clientY>C.top+C.height/2?E.classList.add("dragover__bottom"):E.classList.add("dragover__top");return}h=E}});let b=0;n.addEventListener("dragleave",()=>{b--,b===0&&n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(y=>{y.classList.remove("dragover__bottom","dragover__top")})}),n.addEventListener("dragenter",y=>{y.preventDefault(),b++}),n.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),n.addEventListener("mousedown",y=>{y.button===1&&!T(y.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),n.addEventListener("click",y=>D0(void 0,null,function*(){var w,E,C,$,M,k;let _,v=y.target;for(typeof y.detail=="string"?_=y.detail:typeof y.detail=="object"&&(_=y.detail.type,v=y.detail.target);v&&v!==n||_;){if(_=(v==null?void 0:v.dataset.type)||_,_==="close"){t.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")&&(m==null||m(),n.remove(),setTimeout(()=>{oe(t.blockElement)},p.TIMEOUT_TRANSITION)):ce(["util"],t.protyle),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="go-config"){f.innerHTML=Nw(c),Te(f,g.right-f.clientWidth,g.bottom,g.height),Pw({protyle:t.protyle,data:c,menuElement:f,blockElement:t.blockElement}),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="go-properties"){g=t.blockElement.querySelector(".av__views").getBoundingClientRect(),f.innerHTML=Cs(u),Te(f,g.right-f.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="go-layout"){f.innerHTML=iE(c),Te(f,g.right-f.clientWidth,g.bottom,g.height),sE({protyle:t.protyle,data:c,menuElement:f,blockElement:t.blockElement}),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="goSorts"){f.innerHTML=nr(u,c.view.sorts),tr(t.protyle,f,c,o),Te(f,g.right-f.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="removeSorts"){V(t.protyle,[{action:"setAttrViewSorts",avID:a,data:[],blockID:o}],[{action:"setAttrViewSorts",avID:a,data:c.view.sorts,blockID:o}]),c.view.sorts=[],f.innerHTML=nr(u,c.view.sorts),tr(t.protyle,f,c,o),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="addSort"){_0({data:c,rect:v.getBoundingClientRect(),menuElement:f,tabRect:g,avId:a,protyle:t.protyle,blockID:o}),y.preventDefault(),y.stopPropagation();break}else if(_==="removeSort"){const S=Object.assign([],c.view.sorts);c.view.sorts.find((L,D)=>{if(L.column===v.parentElement.dataset.id)return c.view.sorts.splice(D,1),!0}),V(t.protyle,[{action:"setAttrViewSorts",avID:a,data:c.view.sorts,blockID:o}],[{action:"setAttrViewSorts",avID:a,data:S,blockID:o}]),f.innerHTML=nr(u,c.view.sorts),tr(t.protyle,f,c,o),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="goFilters"){f.innerHTML=Ts(c),Te(f,g.right-f.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="removeFilters"){V(t.protyle,[{action:"setAttrViewFilters",avID:a,data:[],blockID:o}],[{action:"setAttrViewFilters",avID:a,data:c.view.filters,blockID:o}]),c.view.filters=[],f.innerHTML=Ts(c),Te(f,g.right-f.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="addFilter"){O0({data:c,rect:v.getBoundingClientRect(),menuElement:f,tabRect:g,avId:a,protyle:t.protyle,blockElement:t.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(_==="removeFilter"){window.siyuan.menus.menu.remove();const S=Object.assign([],c.view.filters);c.view.filters.find((L,D)=>{if(L.column===v.parentElement.dataset.id&&L.value.type===v.parentElement.dataset.filterType)return c.view.filters.splice(D,1),!0}),V(t.protyle,[{action:"setAttrViewFilters",avID:a,data:c.view.filters,blockID:o}],[{action:"setAttrViewFilters",avID:a,data:S,blockID:o}]),f.innerHTML=Ts(c),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="setFilter"){c.view.filters.find(S=>{if(S.column===v.parentElement.parentElement.dataset.id&&S.value.type===v.parentElement.parentElement.dataset.filterType)return ab({empty:!1,filter:S,protyle:t.protyle,data:c,target:v,blockElement:t.blockElement}),!0}),y.preventDefault(),y.stopPropagation();break}else if(_==="numberFormat"){E0({avPanelElement:n,element:v,protyle:t.protyle,oldFormat:v.dataset.format,colId:f.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:a}),y.preventDefault(),y.stopPropagation();break}else if(_==="newCol"){n.remove(),Zc(t.protyle,t.blockElement).open({x:g.right,y:g.bottom,h:g.height,isLeft:!0}),y.preventDefault(),y.stopPropagation();break}else if(_==="update-view-icon"){const S=v.getBoundingClientRect();Xa("","av",{x:S.left,y:S.bottom+4,h:S.height,w:S.width},L=>{V(t.protyle,[{action:"setAttrViewViewIcon",avID:a,id:c.viewID,data:L}],[{action:"setAttrViewViewIcon",id:c.viewID,avID:a,data:v.dataset.icon}]),v.innerHTML=L?be(L):'<svg style="width: 14px;height: 14px;"><use xlink:href="#iconTable"></use></svg>',v.dataset.icon=L},v.querySelector("img")),y.preventDefault(),y.stopPropagation();break}else if(_==="set-page-size"){Fw({target:v,protyle:t.protyle,avID:a,nodeElement:t.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(_==="duplicate-view"){const S=Lute.NewNodeID();V(t.protyle,[{action:"duplicateAttrViewView",avID:a,previousID:c.viewID,id:S,blockID:o}],[{action:"removeAttrViewView",avID:a,id:S,blockID:o}]),n.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="delete-view"){V(t.protyle,[{action:"removeAttrViewView",avID:a,id:c.viewID,blockID:o}]),n.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="update-icon"){const S=v.getBoundingClientRect();Xa("","av",{x:S.left,y:S.bottom+4,h:S.height,w:S.width},L=>{const D=f.querySelector(".b3-menu__item").getAttribute("data-col-id");if(V(t.protyle,[{action:"setAttrViewColIcon",id:D,avID:a,data:L}],[{action:"setAttrViewColIcon",id:D,avID:a,data:v.dataset.icon}]),v.innerHTML=L?be(L):`<svg style="height: 14px;width: 14px"><use xlink:href="#${Gt(v.dataset.colType)}"></use></svg>`,r){const I=t.blockElement.querySelector(`.av__row[data-col-id="${D}"] .block__logoicon`);I.outerHTML=L?be(L,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${Gt(I.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else On(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${D}"]`),void 0,{icon:L});v.dataset.icon=L},v.querySelector("img")),y.preventDefault(),y.stopPropagation();break}else if(_==="showAllCol"){const S=[],L=[];u.forEach(D=>{D.hidden&&(S.push({action:"setAttrViewColHidden",id:D.id,avID:a,data:!1,blockID:o}),L.push({action:"setAttrViewColHidden",id:D.id,avID:a,data:!0,blockID:o}),D.hidden=!1)}),S.length>0&&(V(t.protyle,S,L),f.innerHTML=Cs(u),Te(f,g.right-f.clientWidth,g.bottom,g.height)),y.preventDefault(),y.stopPropagation();break}else if(_==="hideAllCol"){const S=[],L=[];u.forEach(D=>{!D.hidden&&D.type!=="block"&&(S.push({action:"setAttrViewColHidden",id:D.id,avID:a,data:!0,blockID:o}),L.push({action:"setAttrViewColHidden",id:D.id,avID:a,data:!1,blockID:o}),D.hidden=!0)}),S.length>0&&(V(t.protyle,S,L),f.innerHTML=Cs(u),Te(f,g.right-f.clientWidth,g.bottom,g.height)),y.preventDefault(),y.stopPropagation();break}else if(_==="editCol"){f.innerHTML=oi({protyle:t.protyle,data:c,colId:v.dataset.id,isCustomAttr:r}),ri({protyle:t.protyle,data:c,menuElement:f,isCustomAttr:r,blockID:o}),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="updateColType"){const S=t.colId||f.querySelector(".b3-menu__item").getAttribute("data-col-id");if(v.dataset.newType!==v.dataset.oldType){const D=n.querySelector('.b3-text-field[data-type="name"]').value;let I=D;if(u.find(q=>{if(q.id===S)return q.type=v.dataset.newType,Ti(v.dataset.oldType)===D&&(I=Ti(v.dataset.newType),q.name=I),!0}),V(t.protyle,[{action:"updateAttrViewCol",id:S,avID:a,name:I,type:v.dataset.newType}],[{action:"updateAttrViewCol",id:S,avID:a,name:D,type:v.dataset.oldType}]),v.dataset.newType==="lineNumber"){if(c.view.sorts.find(R=>R.column===S)){const R=Object.assign([],c.view.sorts),F=c.view.sorts.filter(K=>K.column!==S);V(t.protyle,[{action:"setAttrViewSorts",avID:c.id,data:F,blockID:o}],[{action:"setAttrViewSorts",avID:c.id,data:R,blockID:o}])}if(c.view.filters.find(R=>R.column===S)){const R=JSON.parse(JSON.stringify(c.view.filters)),F=c.view.filters.filter(K=>K.column!==S);V(t.protyle,[{action:"setAttrViewFilters",avID:c.id,data:F,blockID:o}],[{action:"setAttrViewFilters",avID:c.id,data:R,blockID:o}])}}}f.innerHTML=oi({protyle:t.protyle,data:c,colId:S,isCustomAttr:r}),ri({protyle:t.protyle,data:c,menuElement:f,isCustomAttr:r,blockID:o}),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="goUpdateColType"){const S=T(v,"b3-menu");S&&(S.firstElementChild.classList.add("fn__none"),S.lastElementChild.classList.remove("fn__none")),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="goSearchAV"){Pc(a,v,void 0,!1),y.preventDefault(),y.stopPropagation();break}else if(_==="goSearchRollupCol"){tE({target:v,data:c,isRelation:!0,protyle:t.protyle,colId:t.colId||f.querySelector(".b3-menu__item").getAttribute("data-col-id")}),y.preventDefault(),y.stopPropagation();break}else if(_==="goSearchRollupTarget"){tE({target:v,data:c,isRelation:!1,protyle:t.protyle,colId:t.colId||f.querySelector(".b3-menu__item").getAttribute("data-col-id")}),y.preventDefault(),y.stopPropagation();break}else if(_==="goSearchRollupCalc"){Gv(t.protyle,v,{data:c,colId:t.colId||f.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:o}),y.preventDefault(),y.stopPropagation();break}else if(_==="updateRelation"){JA({protyle:t.protyle,avElement:n,avID:a,colsData:u,blockElement:t.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(_==="goEditCol"){const S=T(v,"b3-menu");S&&(S.firstElementChild.classList.remove("fn__none"),S.lastElementChild.classList.add("fn__none")),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="hideCol"){const S=f.querySelector('[data-type="go-properties"]'),L=S?f.querySelector(".b3-menu__item").getAttribute("data-col-id"):v.parentElement.getAttribute("data-id");V(t.protyle,[{action:"setAttrViewColHidden",id:L,avID:a,data:!0,blockID:o}],[{action:"setAttrViewColHidden",id:L,avID:a,data:!1,blockID:o}]),u.find(D=>D.id===L).hidden=!0,S?(f.innerHTML=oi({protyle:t.protyle,data:c,colId:L,isCustomAttr:r}),ri({protyle:t.protyle,data:c,menuElement:f,isCustomAttr:r,blockID:o})):f.innerHTML=Cs(u),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="showCol"){const S=f.querySelector('[data-type="go-properties"]'),L=S?f.querySelector(".b3-menu__item").getAttribute("data-col-id"):v.parentElement.getAttribute("data-id");V(t.protyle,[{action:"setAttrViewColHidden",id:L,avID:a,data:!1,blockID:o}],[{action:"setAttrViewColHidden",id:L,avID:a,data:!0,blockID:o}]),u.find(D=>D.id===L).hidden=!1,S?(f.innerHTML=oi({protyle:t.protyle,data:c,colId:L,isCustomAttr:r}),ri({protyle:t.protyle,data:c,menuElement:f,isCustomAttr:r,blockID:o})):f.innerHTML=Cs(u),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="duplicateCol"){uE({blockElement:t.blockElement,protyle:t.protyle,colId:f.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:c,viewID:c.viewID}),y.preventDefault(),y.stopPropagation();break}else if(_==="removeCol"){r||(g=t.blockElement.querySelector(".av__views").getBoundingClientRect());const S=f.querySelector(".b3-menu__item").getAttribute("data-col-id"),L=u.find(I=>{if(I.id===S)return!0}),D=L.type==="relation"&&((w=L.relation)==null?void 0:w.isTwoWay);if(r||D){const I=new $e({title:D?window.siyuan.languages.removeColConfirm:window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${D?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",f.querySelector("input").value||window.siyuan.languages._kernel[272]).replace("${y}",f.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent).replace("${z}",f.querySelector('input[data-type="colName"]').value||window.siyuan.languages._kernel[272]):window.siyuan.languages.removeCol.replace("${x}",f.querySelector("input").value||window.siyuan.languages._kernel[272])}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${D?window.siyuan.languages.removeBothRelationField:window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove${D?"":" fn__none"}" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`,width:"520px"});I.element.addEventListener("click",q=>{let Z=q.target;const R=typeof q.detail=="string";for(;Z&&Z!==I.element||R;){const F=Z.getAttribute("data-action");if(F==="delete"||R&&q.detail==="Enter"){sb({protyle:t.protyle,fields:u,avID:a,blockID:o,menuElement:f,isCustomAttr:r,blockElement:t.blockElement,avPanelElement:n,tabRect:g,isTwoWay:!0}),I.destroy();break}else if(F==="keep-relation"){sb({protyle:t.protyle,fields:u,avID:a,blockID:o,menuElement:f,isCustomAttr:r,blockElement:t.blockElement,avPanelElement:n,tabRect:g,isTwoWay:!1}),I.destroy();break}else if(Z.classList.contains("b3-button--cancel")||R&&q.detail==="Escape"){I.destroy();break}Z=Z.parentElement}}),I.element.setAttribute("data-key",p.DIALOG_CONFIRM)}else sb({protyle:t.protyle,fields:u,avID:a,blockID:o,menuElement:f,isCustomAttr:r,blockElement:t.blockElement,avPanelElement:n,tabRect:g,isTwoWay:!1});y.preventDefault(),y.stopPropagation();break}else if(_==="setColOption"){b0(t.protyle,c,v,t.blockElement,r,t.cellElements),y.preventDefault(),y.stopPropagation();break}else if(_==="setRelationCell"){(E=f.querySelector(".b3-menu__item--current"))==null||E.classList.remove("b3-menu__item--current"),v.classList.add("b3-menu__item--current"),Yw(t.protyle,t.blockElement,v,t.cellElements),y.preventDefault(),y.stopPropagation();break}else if(_==="addColOptionOrCell"){(C=f.querySelector(".b3-menu__item--current"))==null||C.classList.remove("b3-menu__item--current"),v.classList.add("b3-menu__item--current"),v.querySelector(".b3-menu__checked")?Lp(t.protyle,t.cellElements,f.querySelector(`.b3-chips .b3-chip[data-content="${at(v.dataset.name)}"]`),t.blockElement):Jv(t.protyle,c,t.cellElements,v,f,t.blockElement),window.siyuan.menus.menu.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="removeCellOption"){Lp(t.protyle,t.cellElements,v.parentElement,t.blockElement),y.preventDefault(),y.stopPropagation();break}else if(_==="addAssetLink"){s0(t.protyle,t.cellElements,v,t.blockElement),y.preventDefault(),y.stopPropagation();break}else if(_==="addAssetExist"){const S=v.getBoundingClientRect();Oh(t.protyle,{x:S.right,y:S.bottom,w:v.parentElement.clientWidth+8,h:S.height},(L,D)=>{let I;p.SIYUAN_ASSETS_IMAGE.includes(De().extname(L).toLowerCase())?I={type:"image",content:L,name:""}:I={type:"file",content:L,name:D},Ol({protyle:t.protyle,cellElements:t.cellElements,addValue:[I],blockElement:t.blockElement}),window.siyuan.menus.menu.remove()}),y.preventDefault(),y.stopPropagation();break}else if(_==="openAssetItem"){const S=v.parentElement.dataset.content,L=De().extname(S);Ro(S)&&[".pdf"].concat(p.SIYUAN_ASSETS_AUDIO).concat(p.SIYUAN_ASSETS_VIDEO).includes(L)&&(L!==".pdf"||L===".pdf"&&!S.startsWith("file://"))?ur(t.protyle.app,S.trim(),parseInt(Ie("page",S)),"right"):p.SIYUAN_ASSETS_IMAGE.includes(L)?zh(S,a,t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),(($=t.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:$.value.trim())||""):window.open(S),y.preventDefault(),y.stopPropagation();break}else if(_==="editAssetItem"){Sp({protyle:t.protyle,cellElements:t.cellElements,blockElement:t.blockElement,content:v.parentElement.dataset.content,type:v.parentElement.dataset.type,name:v.parentElement.dataset.name,index:parseInt(v.parentElement.dataset.index),rect:v.parentElement.getBoundingClientRect()}),y.preventDefault(),y.stopPropagation();break}else if(_==="clearDate"){const S=u.find(L=>{if(L.id===Xn(t.cellElements[0],c.viewType))return!0});Bn(t.protyle,t.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:S.date?!S.date.fillSpecificTime:!0},t.cellElements),n.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="av-add"){window.siyuan.menus.menu.remove(),Ow(t.protyle,t.blockElement),n.remove(),y.preventDefault(),y.stopPropagation();break}else if(_==="av-view-switch"){v.parentElement.classList.contains("b3-menu__item--current")||((M=n.querySelector(".b3-menu__item--current"))==null||M.classList.remove("b3-menu__item--current"),v.parentElement.classList.add("b3-menu__item--current"),V(t.protyle,[{action:"setAttrViewBlockView",blockID:o,id:v.parentElement.dataset.id,avID:a}],[{action:"setAttrViewBlockView",blockID:o,id:t.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:a}])),y.preventDefault(),y.stopPropagation();break}else if(_==="av-view-edit"){v.parentElement.classList.contains("b3-menu__item--current")?Mc({protyle:t.protyle,blockElement:t.blockElement,element:v.parentElement}):((k=n.querySelector(".b3-menu__item--current"))==null||k.classList.remove("b3-menu__item--current"),v.parentElement.classList.add("b3-menu__item--current"),V(t.protyle,[{action:"setAttrViewBlockView",blockID:o,id:v.parentElement.dataset.id,avID:a}],[{action:"setAttrViewBlockView",blockID:o,id:t.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:a}]),window.siyuan.menus.menu.remove(),Mc({protyle:t.protyle,blockElement:t.blockElement,element:v.parentElement})),y.preventDefault(),y.stopPropagation();break}else if(_==="set-gallery-cover"){u0({target:v,protyle:t.protyle,nodeElement:t.blockElement,view:c.view}),y.preventDefault(),y.stopPropagation();break}else if(_==="set-gallery-size"){f0({target:v,protyle:t.protyle,nodeElement:t.blockElement,view:c.view}),y.preventDefault(),y.stopPropagation();break}else if(_==="set-gallery-ratio"){p0({target:v,protyle:t.protyle,nodeElement:t.blockElement,view:c.view}),y.preventDefault(),y.stopPropagation();break}else if(_==="set-layout"){c=yield S0({target:v,protyle:t.protyle,nodeElement:t.blockElement,data:c}),u=yt(c),y.preventDefault(),y.stopPropagation();break}else if(_==="goGroupsDate"){C0({target:v,menuElement:f,protyle:t.protyle,blockElement:t.blockElement,data:c}),u=yt(c),y.stopPropagation(),y.preventDefault();break}else if(_==="goGroupsSort"){T0({target:v,menuElement:f,protyle:t.protyle,blockElement:t.blockElement,data:c}),u=yt(c),y.stopPropagation(),y.preventDefault();break}else if(_==="setGroupMethod"){L0({protyle:t.protyle,fieldId:v.getAttribute("data-id"),data:c,menuElement:f,blockElement:t.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(_==="goGroups"){f.querySelector('[data-type="avGroupRange"]')&&m&&(yield m()),m=void 0,c.view.group&&c.view.group.field||v.classList.contains("block__icon")?(f.innerHTML=ar(u,c.view),jc({protyle:t.protyle,menuElement:f,blockElement:t.blockElement,data:c})):f.innerHTML=lE(u,c.view.group,c.viewType),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="goGroupsMethod"){window.siyuan.menus.menu.remove(),f.innerHTML=lE(u,c.view.group,c.viewType),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}else if(_==="getGroupsNumber"){window.siyuan.menus.menu.remove(),f.innerHTML=A0(c.view.group),Te(f,g.right-f.clientWidth,g.bottom,g.height),m=x0({protyle:t.protyle,data:c,menuElement:f,blockElement:t.blockElement}),y.preventDefault(),y.stopPropagation();break}else if(_==="hideGroup"){window.siyuan.menus.menu.remove();const S=v.firstElementChild,L=S.getAttribute("xlink:href")!=="#iconEye";S.setAttribute("xlink:href",L?"#iconEye":"#iconEyeoff");let D,I=0;c.view.groups.forEach(q=>{q.id===v.dataset.id&&(D=q.groupHidden,q.groupHidden=L?0:2),q.groupHidden===0&&I++}),v.parentElement.classList[L?"remove":"add"]("b3-menu__item--hidden"),f.querySelector('[data-type="hideGroups"]').innerHTML=`${window.siyuan.languages[I===0?"showAll":"hideAll"]}
<span class="fn__space"></span>
<svg><use xlink:href="#iconEye${I===0?"":"off"}"></use></svg>`,V(t.protyle,[{action:"hideAttrViewGroup",avID:c.id,blockID:o,id:v.dataset.id,data:L?0:2}],[{action:"hideAttrViewGroup",avID:c.id,blockID:o,id:v.dataset.id,data:D}]),y.preventDefault(),y.stopPropagation();break}else if(_==="hideGroups"){window.siyuan.menus.menu.remove();const S=v.querySelector("use").getAttribute("xlink:href")==="#iconEyeoff";v.innerHTML=`${window.siyuan.languages[S?"showAll":"hideAll"]}
<span class="fn__space"></span>
<svg><use xlink:href="#iconEye${S?"":"off"}"></use></svg>`,c.view.groups.forEach(L=>{var D;L.groupHidden=S?2:0;const I=v.parentElement.parentElement.querySelector(`.b3-menu__item[data-id="${L.id}"]`);I.classList[S?"add":"remove"]("b3-menu__item--hidden"),(D=I.querySelector(".b3-menu__action use"))==null||D.setAttribute("xlink:href",`#iconEye${S?"off":""}`)}),V(t.protyle,[{action:"hideAttrViewAllGroups",avID:c.id,blockID:o,data:S}],[{action:"hideAttrViewAllGroups",avID:c.id,blockID:o,data:!S}]),y.preventDefault(),y.stopPropagation();break}else if(_==="removeGroups"){window.siyuan.menus.menu.remove(),V(t.protyle,[{action:"removeAttrViewGroup",avID:c.id,blockID:o}],[{action:"setAttrViewGroup",avID:c.id,blockID:o,data:c.view.group}]),c.view.group=null,delete c.view.groups,f.innerHTML=ar(u,c.view),Te(f,g.right-f.clientWidth,g.bottom,g.height),y.preventDefault(),y.stopPropagation();break}if(!v||!v.parentElement)break;v=v.parentElement}}))})},Cs=t=>{let e="",n="";return t.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?be(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(a.type)}"></use></svg>`}
        ${he(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:e+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?be(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(a.type)}"></use></svg>`}
        ${he(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.fields}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${e}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`};var I0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const oE=t=>{let e=t,n="";try{const a=new URL(t);a.protocol.startsWith("http")&&(e=a.host,n=a.href.replace(a.origin,""),n.length>12&&(n=n.substring(0,4)+"..."+n.substring(n.length-6)))}catch(a){e=Lute.EscapeHTMLStr(t)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${at(t)}"><span>${e}</span><span class="ft__on-surface">${n}</span></span>`},Bl=t=>{if(!t)return"";let e="";const n=t.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return n.length>0?(n.forEach(a=>{a.querySelector(".av__cellicon")?e+=`${a.firstChild.textContent} \u2192 ${a.lastChild.textContent}, `:a.getAttribute("data-type")==="url"?e=a.getAttribute("data-href")+", ":a.getAttribute("data-type")!=="block-more"&&(e+=a.textContent+", ")}),e=e.substring(0,e.length-2)):e=t.textContent,e},Ci=(t,e)=>{var n;const a={type:t,id:e.dataset.id};if(t==="number"){const i=e.querySelector(".av__celltext").getAttribute("data-content");a.number={content:parseFloat(i)||0,isNotEmpty:!!i}}else if(["text","block","url","phone","email","template"].includes(t)){const i=e.querySelector(".av__celltext");if(a[t]={content:t==="url"?i.dataset.href:i.textContent},t==="block"&&i.dataset.id&&(a.block.id=i.dataset.id,(n=i.previousElementSibling)!=null&&n.classList.contains("b3-menu__avemoji"))){const s=i.previousElementSibling.getAttribute("data-unicode");s&&(a.block.icon=s)}}else if(t==="mSelect"||t==="select"){const i=[];e.querySelectorAll(".b3-chip").forEach(s=>{i.push({content:s.textContent.trim(),color:s.style.color.replace("var(--b3-font-color","").replace(")","")})}),a.mSelect=i}else if(["date","created","updated"].includes(t))a[t]=JSON.parse(e.querySelector(".av__celltext").getAttribute("data-value"));else if(t==="checkbox")a.checkbox={checked:e.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(t==="relation"){const i=[],s=[];Array.from(e.querySelectorAll(".av__cell--relation")).forEach(l=>{const o=l.querySelector(".av__celltext");i.push(l.dataset.rowId),s.push({isDetached:!o.classList.contains("av__celltext--ref"),block:{content:o.textContent,id:o.dataset.id},type:"block"})}),a.relation={blockIDs:i,contents:s}}else if(t==="mAsset"){const i=[];Array.from(e.children).forEach(s=>{if(!s.classList.contains("av__celltext--url")&&!s.classList.contains("av__cellassetimg"))return;const l=s.classList.contains("av__cellassetimg");i.push({type:l?"image":"file",content:l?Gh(s.getAttribute("src")):s.getAttribute("data-url"),name:l?"":s.getAttribute("data-name")})}),a.mAsset=i}return t==="block"&&(a.isDetached=e.dataset.detached==="true"),a},ir=t=>{if(["number","text","block","url","phone","email","template","mAsset"].includes(t.type))return t[t.type].content;if(["mSelect","select"].includes(t.type))return t.mSelect[0].content;if(t.type==="rollup")return ir(t.relation.contents[0]);if(t.type==="checkbox")return t.checkbox.checked?"true":"false";if(t.type==="relation")return ir(t.relation.contents[0]);if(["date","created","updated"].includes(t.type))return Q(t[t.type].content).format("YYYY-MM-DD HH:mm");if(t.type==="lineNumber")return""},$0=(t,e)=>{if(t===e.type)return e;const n={type:t};if(t==="number")["date","created","updated"].includes(t)?n.number={content:e[e.type].content,isNotEmpty:e[e.type].isNotEmpty}:n.number={content:parseFloat(ir(e))||0,isNotEmpty:!0};else if(["text","block","url","phone","email","template"].includes(t))n[t]={content:ir(e).toString()};else if(t==="mSelect"||t==="select")n.mSelect=[{content:ir(e).toString(),color:"1"}],n.mSelect[0].content||(n.mSelect=[]);else if(t==="rollup")n.rollup={contents:[e]};else if(t==="checkbox")n.checkbox={checked:!0};else if(t==="relation")e.type==="block"?n.relation={blockIDs:[e.blockID],contents:[e]}:n.relation={blockIDs:[],contents:[]};else if(t==="mAsset"){const a=ir(e).toString();n.mAsset=[{type:p.SIYUAN_ASSETS_IMAGE.includes(De().extname(a).toLowerCase())?"image":"file",content:a,name:""}]}else if(["date","created","updated"].includes(t))["date","created","updated"].includes(e.type)?n[t]=JSON.parse(JSON.stringify(e[e.type])):n[t]={content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0};else if(t==="lineNumber")return{type:"lineNumber"};return n},si=(t,e)=>{let n={type:t,[t==="select"?"mSelect":t]:e};if(typeof e=="string"&&e){if(t==="number")n={type:t,number:{content:parseFloat(e)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(t))n={type:t,[t]:{content:e}};else if(t==="mSelect"||t==="select")n={type:t,mSelect:[{content:e,color:"1"}]};else if(t==="checkbox")n={type:t,checkbox:{checked:!0}};else if(t==="date"){let a=e.split("\u2192");a.length!==2&&(a=e.split("-"),a.length!==2&&(a=e.split("~")));const i=Q(a[0]),s=Q(a[1]||"");isNaN(i.valueOf())?n={type:t,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:n={type:t,date:{content:i.valueOf(),isNotEmpty:!0,content2:s.valueOf()||0,isNotEmpty2:!isNaN(s.valueOf()),hasEndDate:!isNaN(s.valueOf()),isNotTime:i.hour()===0&&a[0].split(":").length===1,formattedContent:""}}}else if(t==="relation")n={type:t,relation:{blockIDs:[e],contents:[]}};else if(t==="mAsset"){const a=De().extname(e).toLowerCase();n={type:t,mAsset:[{type:p.SIYUAN_ASSETS_IMAGE.includes(a)?"image":"file",content:e,name:""}]}}}else(typeof e=="undefined"||!e)&&(t==="number"?n={type:t,number:{content:0,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(t)?n={type:t,[t]:{content:""}}:t==="mSelect"||t==="select"||t==="mAsset"?n={type:t,[t==="select"?"mSelect":t]:[]}:["date","created","updated"].includes(t)?n={type:t,[t]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:t==="checkbox"?n={type:t,checkbox:{checked:!1}}:t==="relation"?n={type:t,relation:{blockIDs:[],contents:[]}}:t==="rollup"&&(n={type:t,rollup:{contents:[]}}));return t==="block"&&(typeof e=="object"&&e&&e.id?n.isDetached=!1:n.isDetached=!0),n},Xi=(t,e,n=!0)=>{const a=e.getBoundingClientRect();if(!n){const l=t.querySelector(".av__scroll"),o=T(e,"av__row");if(l&&o){const r=o.querySelector(".av__colsticky");if(!r.contains(e)){const c=r.getBoundingClientRect().right,d=l.getBoundingClientRect();c>a.left||d.right<a.left?l.scrollLeft=l.scrollLeft+a.left-c:c<a.left&&d.right<a.right&&(a.width+c>d.right?l.scrollLeft=l.scrollLeft+a.left-c:l.scrollLeft=l.scrollLeft+a.right-d.right)}}}if(!t.querySelector(".av__header"))return;const i=T(e,"av__body");if(!i)return;const s=i.querySelector(".av__row--header").getBoundingClientRect();if(s.bottom>a.top){const l=T(t,"protyle-content",!0);l&&(l.scrollTop=l.scrollTop+a.top-s.bottom)}else{const l=i.querySelector(".av__row--footer");if(l!=null&&l.querySelector(".av__calc--ashow")){const o=l.getBoundingClientRect();if(o.top<a.bottom){const r=T(t,"protyle-content",!0);r&&(r.scrollTop=r.scrollTop+a.bottom-o.top)}}else{const o=T(t,"protyle-content",!0);if(o){const r=o.getBoundingClientRect();a.bottom>r.bottom&&(o.scrollTop=o.scrollTop+(a.bottom-r.bottom))}}}},Zn=t=>{if(t.parentElement.classList.contains("av__gallery-field"))return t.getAttribute("data-dtype");const e=T(t,"av__scroll");if(e)return e.querySelector(".av__row--header").querySelector(`[data-col-id="${t.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},Jn=(t,e,n)=>{var a;if(e.length===0||e.length===1&&!e[0]||(n||(n=Zn(e[0])),n==="updated"||n==="created"||document.querySelector(".av__mask")))return;const i=B(e[0]);if(!i)return;const s=i.getAttribute("data-av-type");let l=e[0].getBoundingClientRect();const o=T(i,"protyle-content",!0);s==="table"&&Xi(i,e[0],!1),l=e[0].getBoundingClientRect();let r="",c=l.height;const d=getComputedStyle(e[0]);let u=`font-family:${d.fontFamily};font-size:${d.fontSize};line-height:${d.lineHeight};padding:${d.padding};position:absolute;top: ${l.top}px;`;if(o){const h=o.getBoundingClientRect();l.bottom>h.bottom&&(c=h.bottom-l.top);const b=Math.min(Math.max(l.width,25),h.width);u=`style='height: ${c}px;width:${b}px;left: ${l.left<h.left||l.left+b>h.right?h.left:l.left}px;${u}'`}else u=`style='height: ${c}px;width:${Math.max(l.width,25)}px;left: ${l.left}px;${u}'`;if(["text","email","phone","block","template"].includes(n))r=`<textarea ${u} spellcheck="false" class="b3-text-field"></textarea>`;else if(n==="url")r=`<textarea ${u} spellcheck="false" class="b3-text-field">${e[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(n==="number")r=`<input type="number" spellcheck="false" value="${e[0].firstElementChild.getAttribute("data-content")}" ${u} class="b3-text-field">`;else{if(["select","mSelect"].includes(n)){if(i.getAttribute("data-rendering")==="true")return;Cn({protyle:t,blockElement:i,type:"select",cellElements:e})}else n==="mAsset"?(Cn({protyle:t,blockElement:i,type:"asset",cellElements:e}),oe(i)):n==="date"?Cn({protyle:t,blockElement:i,type:"date",cellElements:e}):n==="checkbox"?tb(t,n,i,e):n==="relation"?Cn({protyle:t,blockElement:i,type:"relation",cellElements:e}):n==="rollup"&&Cn({protyle:t,blockElement:i,type:"rollup",cellElements:e,colId:Xn(e[0],s)});s==="table"&&!T(e[0],"custom-attr")&&(e[0].classList.add("av__cell--select"),pa(e[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${r}
</div>`);const m=document.querySelector(".av__mask"),f=m.querySelector(".b3-text-field");f&&(["text","email","phone","block","template"].includes(n)&&(f.value=((a=e[0].querySelector(".av__celltext"))==null?void 0:a.textContent)||""),f.select(),f.focus(),n==="template"&&A("/api/av/renderAttributeView",{id:i.dataset.avId,viewID:i.getAttribute(p.CUSTOM_SY_AV_VIEW)},h=>{yt(h.data).find(b=>{if(b.id===Xn(e[0],s))return f.value=b.template,f.dataset.template=b.template,!0})}),n==="block"&&f.addEventListener("input",h=>{if(p.BLOCK_HINT_KEYS.includes(f.value.substring(0,2))){if(t.toolbar.range=document.createRange(),e[0]&&!i.contains(e[0])){const y=Ba(e[0],s);s==="table"?e[0]=i.querySelector(`.av__row[data-id="${y}"] .av__cell[data-col-id="${e[0].dataset.colId}"]`):e[0]=i.querySelector(`.av__gallery-item[data-id="${y}"] .av__cell[data-field-id="${e[0].dataset.fieldId}"]`)}t.toolbar.range.selectNodeContents(e[0].lastChild),ne(t.toolbar.range),s==="table"&&(e[0].classList.add("av__cell--select"),pa(e[0]));let b=f.value;pn(b)?b=b.substring(2,24):b=b.substring(2),As(b,t,"av"),m==null||m.remove(),h.preventDefault(),h.stopPropagation()}}),f.addEventListener("keydown",h=>{h.isComposing||ai(h)||(h.key==="Escape"||h.key==="Tab"||h.key==="Enter"&&!h.shiftKey&&et(h))&&(tb(t,n,i,e),h.key==="Tab"&&t.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:h.shiftKey,ctrlKey:h.ctrlKey,altKey:h.altKey,metaKey:h.metaKey,key:"Tab",keyCode:9})),h.preventDefault(),h.stopPropagation())}));const g=h=>{h.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(tb(t,n,i,e),m==null||m.remove())};m.addEventListener("click",h=>{g(h)}),m.addEventListener("contextmenu",h=>{g(h)}),m.addEventListener("mousedown",h=>{h.button===1&&(h.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),g(h))})},tb=(t,e,n,a)=>{const i=n.getAttribute("data-av-type");if(i==="table"){const o=T(a[0],"av__row");if(!o||a.length===1&&a[0].dataset.detached==="true"&&!o.dataset.id)return}const s=document.querySelector(".av__mask"),l=n.getAttribute("data-av-id");if(e==="template"){const o=Xn(a[0],i),r=s.querySelector(".b3-text-field");r.value!==r.dataset.template&&!n.getAttribute("data-loading")&&(V(t,[{action:"updateAttrViewColTemplate",id:o,avID:l,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:o,avID:l,data:r.dataset.template,type:"template"}]),n.setAttribute("data-loading","true"))}else Bn(t,n,e==="checkbox"?{checked:a[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:s.querySelector(".b3-text-field").value,a);i==="table"&&a[0]&&!T(a[0],"custom-attr")&&(a[0].classList.add("av__cell--select"),pa(a[0])),document.querySelector(".b3-dialog")||oe(n),document.querySelectorAll(".av__mask").forEach(o=>{o.remove()})},Bn=(t,e,n,a,i,s,l=!1)=>I0(void 0,null,function*(){const o=[],r=[],c=e.dataset.avId,d=e.dataset.nodeId;let u="";const m=[];let f;(a==null?void 0:a.length)>0?f=a:(f=Array.from(e.querySelectorAll(".av__cell--active, .av__cell--select")),f.length===0&&e.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(b=>{b.querySelectorAll(".av__cell").forEach(y=>{f.push(y)})}));const g=T(f[0],"custom-attr"),h=e.getAttribute("data-av-type");for(let b=0;b<f.length;b++){let y=f[b];const w=Ba(y,h);if(!w||(e.contains(y)||(h==="table"?y=f[b]=e.querySelector(`.av__row[data-id="${w}"] .av__cell[data-col-id="${y.dataset.colId}"]`)||e.querySelector(`.fn__flex-1[data-col-id="${y.dataset.colId}"]`):y=f[b]=e.querySelector(`.av__gallery-item[data-id="${w}"] .av__cell[data-field-id="${y.dataset.fieldId}"]`)),!y))break;const E=Zn(y)||y.dataset.type;if(["created","updated","template","rollup"].includes(E))break;const C=y.dataset.id,$=Xn(y,h);u+=Bl(y)+(f[b+1]&&y.nextElementSibling&&y.nextElementSibling===f[b+1]?"	":`

`);const M=Ci(E,y);(b===0||f[b-1]!==y.previousElementSibling)&&m.push([]),m[m.length-1].push(M);let k=n;if(E==="mAsset"){if(Array.isArray(n))k=M.mAsset.concat(n);else if(typeof n!="undefined"&&typeof n!="object"){let v=t.lute.GetLinkDest(n),S="",L="";if(!v&&n.startsWith("assets/")&&(v=n,S=Bf(n)+De().extname(n)),s){const D=document.createElement("template");D.innerHTML=s;const I=D.content.querySelector('[data-type~="a"]');if(I)v=I.getAttribute("data-href"),S=I.textContent;else{const q=D.content.querySelector(".img img");q&&(L=q.getAttribute("data-src"))}}if(v||(S=n),!v&&!S&&!L)break;L?k=M.mAsset.concat({type:"image",content:L,name:""}):k=M.mAsset.concat({type:"file",content:v,name:S})}}else if(E==="mSelect"||E==="select"){if(typeof n=="string"){const v=[];let S=M.mSelect.length;[...new Set(n.split(",").map(L=>L.trim().replace(/\n|\r\n|\r|\u2028|\u2029/g,"")))].forEach(L=>{if(!L)return;let D=!1;M.mSelect.find(I=>{if(I.content===L)return D=!0,!0}),!D&&(S++,v.push({content:L,color:S.toString()}))}),k=M.mSelect.concat(v)}}else E==="block"&&typeof n=="string"&&M.block.id&&(k={content:n,id:M.block.id},M.block.icon&&(k.icon=M.block.icon));let _;if(typeof k=="object"&&k.type?_=$0(E,k):_=si(E,k),_.id=C,_.type==="date"&&typeof _.date=="string"||_.type==="relation"&&typeof _.relation=="string")break;if(i&&(E==="select"||E==="mSelect")){const v=y0(i.find(S=>S.id===$),_,c);o.push(...v.doOperations),r.push(...v.undoOperations)}if(E==="date"){if(!(n&&typeof n=="object"&&typeof n.isNotTime=="boolean")){const v=yield Ae("/api/av/getAttributeViewKeysByID",{avID:c,keyIDs:[$]});v.data[0].date&&(_.date.isNotTime=!v.data[0].date.fillSpecificTime)}_.date.formattedContent=M.date.formattedContent}if(rn(_,M))break;o.push({action:"updateAttrViewCell",id:C,avID:c,keyID:$,rowID:w,data:_}),r.push({action:"updateAttrViewCell",id:C,avID:c,keyID:$,rowID:w,data:M}),g?y.innerHTML=Ji(_):On(y,_)}return l?{doOperations:o,undoOperations:r}:(o.length>0&&(o.push({action:"doUpdateUpdated",id:d,data:Q().format("YYYYMMDDHHmmss")}),r.push({action:"doUpdateUpdated",id:d,data:e.getAttribute("updated")}),V(t,o,r)),{text:u.substring(0,u.length-2),json:m})}),Cp=(t,e)=>{e.type==="checkbox"?e.checkbox.checked?(t.classList.add("av__cell-check"),t.classList.remove("av__cell-uncheck")):(t.classList.remove("av__cell-check"),t.classList.add("av__cell-uncheck")):e.type==="block"&&(e.isDetached?t.setAttribute("data-detached","true"):(t.querySelector(".av__celltext").setAttribute("data-id",e.block.id),t.removeAttribute("data-detached")))},li=(t,e=0,n=!0,a="table")=>{var i,s,l,o,r,c,d,u,m,f,g,h,b;let y="";if(t.type==="template")y=`<span class="av__celltext">${t&&t.template.content||""}</span>`;else if(t.type==="text")y=`<span class="av__celltext">${t?Lute.EscapeHTMLStr(t.text.content||""):""}</span>`;else if(["email","phone"].includes(t.type))y=`<span class="av__celltext av__celltext--url" data-type="${t.type}">${t?Lute.EscapeHTMLStr(t[t.type].content||""):""}</span>`;else if(t.type==="url")y=oE(((i=t==null?void 0:t.url)==null?void 0:i.content)||"");else if(t.type==="block")t!=null&&t.isDetached?y=`<span class="av__celltext">${Lute.EscapeHTMLStr(t.block.content||"")}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:y=`<span class="b3-menu__avemoji${n?"":" fn__none"}" data-unicode="${t.block.icon||""}">${be(t.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${t.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(t.block.content)}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(t.type==="number")y=`<span class="av__celltext" data-content="${t!=null&&t.number.isNotEmpty?t==null?void 0:t.number.content:""}">${(t==null?void 0:t.number.formattedContent)||(t==null?void 0:t.number.content)||""}</span>`;else if(t.type==="mSelect"||t.type==="select")(s=t==null?void 0:t.mSelect)==null||s.forEach((w,E)=>{t.type==="select"&&E>0||(y+=`<span class="b3-chip" style="background-color:var(--b3-font-background${w.color});color:var(--b3-font-color${w.color})">${he(w.content)}</span>`)});else if(t.type==="date"){const w=t?t.date:null;y=`<span class="av__celltext" data-value='${JSON.stringify(w)}'>`,w&&w.isNotEmpty&&(y+=Q(w.content).format(w.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),w&&w.hasEndDate&&w.isNotEmpty&&w.isNotEmpty2&&(y+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(w.content2).format(w.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),y+="</span>"}else if(["created","updated"].includes(t.type)){const w=t?t[t.type]:null;y=`<span class="av__celltext" data-value='${JSON.stringify(w)}'>`,w&&w.isNotEmpty&&(y+=w.formattedContent),y+="</span>"}else if(["lineNumber"].includes(t.type))y=`<span class="av__celltext" data-value='${e+1}'>${e+1}</span>`;else if(t.type==="mAsset")(l=t==null?void 0:t.mAsset)==null||l.forEach(w=>{w.type==="image"?y+=`<img loading="lazy" class="av__cellassetimg ariaLabel" aria-label="${w.content}" src="${Wc(w.content)}">`:y+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${at(w.content)}" data-name="${at(w.name)}" data-url="${at(w.content)}">${w.name||w.content}</span>`});else if(t.type==="checkbox")y+=`<div class="fn__flex"><svg class="av__checkbox"><use xlink:href="#icon${(o=t==null?void 0:t.checkbox)!=null&&o.checked?"Check":"Uncheck"}"></use></svg>`,["gallery","kanban"].includes(a)&&((r=t==null?void 0:t.checkbox)!=null&&r.content)&&(y+=`<span class="fn__space"></span>${(c=t==null?void 0:t.checkbox)==null?void 0:c.content}`),y+="</div>";else if(t.type==="rollup"){let w;(u=(d=t==null?void 0:t.rollup)==null?void 0:d.contents)==null||u.forEach(E=>{const C=["template","select","mSelect","mAsset","relation"].includes(E.type)?li(E,e,n,a):M0(E,n);C&&(y+=C+(E.type==="checkbox"?"":", ")),w=E.type}),y&&(w==="checkbox"?y=`<div class="fn__flex">${y}</div>`:y.endsWith(", ")&&(y=y.substring(0,y.length-2)))}else t.type==="relation"&&((f=(m=t==null?void 0:t.relation)==null?void 0:m.contents)==null||f.forEach((w,E)=>{if(w&&w.block){const C=t.relation.blockIDs[E];w!=null&&w.isDetached?y+=`<span data-row-id="${C}" class="av__cell--relation"><span class="${n?"":" fn__none"}">\u2796<span class="fn__space--5"></span></span><span class="av__celltext">${Lute.EscapeHTMLStr(w.block.content||window.siyuan.languages.untitled)}</span></span>`:y+=`<span data-row-id="${C}" class="av__cell--relation" data-block-id="${w.block.id}"><span class="b3-menu__avemoji${n?"":" fn__none"}" data-unicode="${w.block.icon||""}">${be(w.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${w.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(w.block.content||window.siyuan.languages.untitled)}</span></span>`}}),y&&y.endsWith(", ")&&(y=y.substring(0,y.length-2)));return(["text","template","url","email","phone","date","created","updated"].includes(t.type)&&((g=t[t.type])!=null&&g.content)||t.type==="lineNumber"||t.type==="number"&&((h=t.number)!=null&&h.isNotEmpty)||t.type==="block"&&((b=t.block)!=null&&b.content))&&(y+=`<span ${t.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),y},M0=(t,e)=>{var n,a,i,s,l;let o="";if(["text"].includes(t.type))o=t&&t[t.type].content||"";else if(["email","phone"].includes(t.type)){const r=t?t[t.type].content:"";r&&(o=`<span class="av__celltext av__celltext--url" data-type="${t.type}">${r}</span>`)}else if(t.type==="url"){const r=((n=t==null?void 0:t.url)==null?void 0:n.content)||"";r&&(o=oE(r))}else if(t.type==="block")t!=null&&t.isDetached?o=`<span class="av__celltext">${Lute.EscapeHTMLStr(((a=t.block)==null?void 0:a.content)||window.siyuan.languages.untitled)}</span>`:o=`<span class="b3-menu__avemoji${e?"":" fn__none"}" data-unicode="${t.block.icon||""}">${be(t.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${(i=t.block)==null?void 0:i.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(((s=t.block)==null?void 0:s.content)||window.siyuan.languages.untitled)}</span>`;else if(t.type==="number")o=(t==null?void 0:t.number.formattedContent)||(t==null?void 0:t.number.content.toString())||"";else if(t.type==="checkbox")o+=`<svg class="av__checkbox"><use xlink:href="#icon${(l=t==null?void 0:t.checkbox)!=null&&l.checked?"Check":"Uncheck"}"></use></svg><span class="fn__space"></span>`;else if(["date","updated","created"].includes(t.type)){const r=t?t[t.type]:null;r.formattedContent?o=r.formattedContent:(r&&r.isNotEmpty&&(o=Q(r.content).format(r.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),r&&r.hasEndDate&&r.isNotEmpty&&r.isNotEmpty2&&(o=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(r.content2).format(r.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),o&&(o=`<span class="av__celltext">${o}</span>`)}return o},P0=(t,e)=>{var n;if(typeof e.icon!="undefined"&&(t.dataset.icon=e.icon,t.querySelector(".av__cellheadericon").outerHTML=e.icon?be(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Gt(t.dataset.dtype)}"></use></svg>`),typeof e.name!="undefined"&&(t.querySelector(".av__celltext").textContent=e.name),typeof e.pin!="undefined"){const a=t.querySelector(".av__celltext");e.pin?t.querySelector(".av__cellheadericon--pin")||a.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(n=t.querySelector(".av__cellheadericon--pin"))==null||n.remove()}},Kc=t=>{let e=T(t,"av__row");if(!e)return;let n=-1;for(;e;)e=e.previousElementSibling,n++;let a=-2;for(;t;)t=t.previousElementSibling,t&&t.classList.contains("av__colsticky")&&(t=t.lastElementChild),a++;return{rowIndex:n,celIndex:a}},N0=(t,e,n,a,i)=>{var s;(s=e.querySelector(".av__drag-fill"))==null||s.remove();const l={};e.querySelectorAll(".av__cell--active").forEach(m=>{if(a.includes(m.dataset.id))return;const f=T(m,"av__row");if(!f)return;l[f.dataset.id]||(l[f.dataset.id]=[]);const g=Ci(Zn(m),m);g.colId=m.dataset.colId,g.element=m,l[f.dataset.id].push(g)});const o=[],r=[],c=e.dataset.avId,d=Object.keys(n),u=!!i.querySelector(".b3-menu__avemoji");Object.keys(l).forEach((m,f)=>{l[m].forEach((g,h)=>{if(["rollup","template","created","updated"].includes(g.type)||g.type==="block"&&g.element.getAttribute("data-detached")!=="true")return;const b=JSON.parse(JSON.stringify(n[d[f%d.length]][h]));b.id=g.id;const y=g.colId;b.type==="block"&&(b.isDetached=!0,delete b.block.id),o.push({action:"updateAttrViewCell",id:g.id,avID:c,keyID:y,rowID:m,data:b}),g.element.innerHTML=li(b,0,u),Cp(g.element,b),delete g.colId,delete g.element,r.push({action:"updateAttrViewCell",id:g.id,avID:c,keyID:y,rowID:m,data:g})})}),oe(e),o.length>0&&V(t,o,r)},pa=t=>{if(t&&(t.classList.add("av__cell--active"),!t.querySelector(".av__drag-fill"))){const e=t.getAttribute("data-dtype");if(["template","rollup","lineNumber","created","updated"].includes(e))return;t.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`)}},nb=t=>{var e,n,a,i,s,l;if(t.type==="checkbox")return!1;if(["text","block","url","phone","email","template"].includes(t.type))return!((e=t[t.type])!=null&&e.content);if(t.type==="number")return t.number?!t.number.isNotEmpty:!0;if(["mSelect","mAsset","select"].includes(t.type))return!(((n=t[t.type==="select"?"mSelect":t.type])==null?void 0:n.length)>0);if(["date","created","updated"].includes(t.type))return!((a=t[t.type])!=null&&a.isNotEmpty)&&!((i=t[t.type])!=null&&i.isNotEmpty2);if(t.type==="relation")return!((s=t.relation)!=null&&s.blockIDs&&t.relation.blockIDs.length>0);if(t.type==="rollup")return!((l=t.rollup)!=null&&l.contents&&t.rollup.contents.length>0)};var H0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const rE=t=>{if(["select","number","date","created","updated"].includes(t))return"=";if(["checkbox"].includes(t))return"Is false";if(["rollup","relation","mAsset","text","mSelect","url","block","email","phone","template"].includes(t))return"Contains"},cE=(t,e,n)=>{const a=T(t,"b3-menu");if(a){if(["date","updated","created"].includes(n)){const i=a.querySelector('.b3-menu__item div[data-type="filter1"]'),s=i.nextElementSibling;e==="Is between"?(s.classList.remove("fn__none"),i.classList.remove("fn__none")):e==="Is empty"||e==="Is not empty"?(s.classList.add("fn__none"),i.classList.add("fn__none")):(i.classList.remove("fn__none"),s.classList.add("fn__none"));return}a.querySelectorAll("input, .b3-chip").forEach(i=>{const s=T(i,"b3-menu__item");s&&(e!=="Is empty"&&e!=="Is not empty"?s.classList.remove("fn__none"):s.classList.add("fn__none"))})}},dE=t=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(e=>{const n=e.querySelector(".b3-chip.b3-chip--middle");if(n){const a=n.dataset.name.toLowerCase();!t||t.indexOf(a)>-1||a.indexOf(t)>-1?e.classList.remove("fn__none"):e.classList.add("fn__none")}})},ab=t=>H0(void 0,null,function*(){var e,n,a,i,s,l,o,r,c,d,u,m,f,g,h,b,y,w,E,C,$;let M=t.target.getBoundingClientRect();M.height===0&&(M=t.protyle.wysiwyg.element.querySelector(`[data-col-id="${t.target.dataset.colId}"]`).getBoundingClientRect());const k=t.blockElement.getAttribute("data-node-id");let _;const v=new dt("set-filter-"+t.filter.column,()=>{const F=JSON.parse(JSON.stringify(t.data.view.filters));if(!_||!_.value)return;const K={column:t.filter.column,value:{type:t.filter.value.type},operator:_.value};let X=!1,J;if(I.type==="select"||I.type==="mSelect"){const Pe=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(Je=>{if(Je.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const ze=Je.nextElementSibling.firstElementChild;Pe.push({color:ze.dataset.color,content:ze.dataset.name})}}),J=si(I.type,Pe)}else if(["date","updated","created"].includes(I.type)){const Pe=v.element.querySelector('.b3-select[data-type="dateType"]'),Je=v.element.querySelectorAll('.b3-select[data-type="dataDirection"]');Pe.value==="custom"?(K.relativeDate={count:parseInt(Je[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(Je[0].parentElement.lastElementChild.value),direction:parseInt(Je[0].value)},K.relativeDate2={count:parseInt(Je[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(Je[1].parentElement.lastElementChild.value),direction:parseInt(Je[1].value)},J={type:I.type}):(J=si(I.type,{isNotEmpty2:R[2].value!=="",isNotEmpty:R[0].value!=="",content:R[0].value?new Date(R[0].value+" 00:00").getTime():0,content2:R[2].value?new Date(R[2].value+" 00:00").getTime():0,hasEndDate:K.operator==="Is between",isNotTime:!0}),K.relativeDate=null,K.relativeDate2=null)}else["text","mAsset","url","block","email","phone","template","relation","number"].includes(I.type)?J=si(I.type,R[0].value):I.type==="checkbox"?J=si(I.type,{checked:K.operator==="Is true"}):J=si(I.type,void 0);t.filter.value.type==="rollup"?K.value={rollup:{contents:[J]},type:"rollup"}:K.value=J,["rollup","mAsset"].includes(t.filter.value.type)&&(K.quantifier=v.element.querySelector('.b3-select[data-type="quantifier"]').value);let Me=!1;if(t.data.view.filters.find((Pe,Je)=>{if(Pe.column===t.filter.column&&Pe.value.type===t.filter.value.type)return Pe.value.type==="checkbox"?(X=!0,t.data.view.filters[Je]=K,!0):rn(Pe,K)?(Me=!0,!0):(t.data.view.filters[Je]=K,X=!0,!0)}),!t.empty&&(Me||!X))return;V(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters,blockID:k}],[{action:"setAttrViewFilters",avID:t.data.id,data:F,blockID:k}]);const me=T(t.target,"b3-menu");me&&(me.innerHTML=Ts(t.data))});if(v.isOpen)return;let S="",L;const D=yt(t.data);D.find(F=>{if(F.id===t.filter.column)return L=F,!0});let I=JSON.parse(JSON.stringify(t.filter.value));if(L.type==="rollup"){if(!L.rollup||!L.rollup.relationKeyID||!L.rollup.keyID){de(window.siyuan.languages.plsChoose),(e=document.querySelector(".av__panel"))==null||e.remove(),Cn({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:L.id});return}if((n=L.rollup.calc)!=null&&n.operator&&!["Range","Unique values"].includes(L.rollup.calc.operator))["Count all","Count empty","Count not empty","Count values","Count unique values","Percent empty","Percent not empty","Percent unique values","Percent checked","Percent unchecked","Sum","Average","Median","Min","Max"].includes(L.rollup.calc.operator)?I.type="number":["Checked","Unchecked"].includes(L.rollup.calc.operator)?I.type="checkbox":["Earliest","Latest"].includes(L.rollup.calc.operator)&&(I.type="date");else{let F="";D.find(X=>{if(X.id===L.rollup.relationKeyID)return F=X.relation.avID,!0}),(yield Ae("/api/av/getAttributeView",{id:F})).data.av.keyValues.find(X=>{if(X.key.id===L.rollup.keyID)return I.type=X.key.type,X.key.type==="select"&&(L.options=X.key.options),!0})}t.data.view.filters.find(F=>{if(F.column===L.id&&F.value.type==="rollup"){if(!F.value.rollup||!F.value.rollup.contents||F.value.rollup.contents.length===0){const K=I.type==="select"?"mSelect":I.type;I={[K]:si(I.type,I.type==="checkbox"?{checked:void 0}:"")[K],type:I.type}}else I=F.value.rollup.contents[0];return!0}})}let q=!1;switch(I.type==="checkbox"&&(q=typeof I.checkbox=="undefined"||typeof I.checkbox.checked=="undefined"),I.type){case"checkbox":S=`<option ${t.filter.operator==="Is true"&&!q?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${t.filter.operator==="Is false"&&!q?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,q&&(S=`<option selected></option>${S}`);break;case"block":case"mAsset":case"text":case"url":case"phone":case"email":S=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":S=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":S=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${t.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":S=`<option ${t.filter.operator==="="?"selected":""} value="=">=</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":S=`<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":S=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(["rollup","mAsset"].includes(t.filter.value.type)&&v.addItem({iconHTML:"",type:"readonly",label:` <select style="margin: 4px 0" class="b3-select fn__size200" data-type="quantifier">
    <option ${t.filter.quantifier===""||t.filter.quantifier==="Any"?"selected":""} value="Any">${window.siyuan.languages.filterQuantifierAny}</option>
    <option ${t.filter.quantifier==="All"?"selected":""} value="All">${window.siyuan.languages.filterQuantifierAll}</option>
    <option ${t.filter.quantifier==="None"?"selected":""} value="None">${window.siyuan.languages.filterQuantifierNone}</option>
</select>`}),v.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200" data-type="operation">${S}</select>`}),I.type==="select"||I.type==="mSelect")((a=L.options)==null?void 0:a.length)>0&&v.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(F){const K=F.querySelector("input");K.addEventListener("keydown",X=>{if(X.isComposing)return;let J=xn(v.element.querySelector(".b3-menu__items"),X,"b3-menu__item--current",F.nextElementSibling);X.key==="Enter"&&(J||(J=v.element.querySelector(".b3-menu__item--current")),J.dispatchEvent(new CustomEvent("click")))}),K.addEventListener("input",X=>{X.isComposing||dE(K.value.toLowerCase())}),K.addEventListener("compositionend",()=>{dE(K.value.toLowerCase())})}}),(i=L.options)==null||i.forEach(F=>{var K;let X="iconUncheck";(K=I==null?void 0:I.mSelect)==null||K.find(J=>{J.content===F.name&&(X="iconCheck")}),v.addItem({icon:X,label:`<span class="b3-chip b3-chip--middle" data-name="${F.name}" data-color="${F.color}" style="max-width: 178px;margin:3px 0;background-color:var(--b3-font-background${F.color});color:var(--b3-font-color${F.color})">
    <span class="fn__ellipsis">${F.name}</span>
</span>`,bind(J){J.addEventListener("click",()=>{const Me=J.querySelector("use");Me.getAttribute("xlink:href")==="#iconUncheck"?Me.setAttribute("xlink:href","#iconCheck"):Me.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","mAsset","email","phone","template"].includes(I.type)){let F="";I&&(I.type==="mAsset"?I.mAsset&&(F=((s=I.mAsset[0])==null?void 0:s.content)||""):F=I[I.type].content||""),v.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${F}" class="b3-text-field fn__size200">`})}else if(I.type==="relation"){let F="";I&&(F=I.relation.blockIDs[0]||""),v.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${F}" class="b3-text-field fn__size200"><div style="position:fixed" class="protyle-hint b3-list b3-list--background fn__none"></div>`,bind(K){const X=K.querySelector("input"),J=X.nextElementSibling,Me=()=>{!L.relation||!L.relation.avID||A("/api/av/getAttributeViewPrimaryKeyValues",{id:L.relation.avID,keyword:X.value},me=>{let Pe="";(me.data.rows.values||[]).forEach((ze,wt)=>{Pe+=`<div class="b3-list-item${wt===0?" b3-list-item--focus":""}">${ze.block.content||window.siyuan.languages.untitled}</div>`}),J.innerHTML=Pe,Pe===""?J.classList.add("fn__none"):J.classList.remove("fn__none");const Je=X.getBoundingClientRect();Te(J,Je.left,Je.bottom+4,Je.height+4)})};X.addEventListener("input",me=>{me.isComposing||Me()}),X.addEventListener("compositionend",()=>{Me()}),X.addEventListener("keydown",me=>{me.isComposing||(me.key!=="Enter"&&J.innerHTML!==""&&J.classList.remove("fn__none"),xn(J,me),me.key==="Enter"&&(J.classList.contains("fn__none")?v.close():(X.value=J.querySelector(".b3-list-item--focus").textContent.replace(/\n/g," "),J.classList.add("fn__none")),me.preventDefault(),me.stopPropagation()))}),J.addEventListener("click",me=>{const Pe=T(me.target,"b3-list-item");Pe&&(X.value=Pe.textContent.replace(/\n/g," "),J.classList.add("fn__none"))})}})}else if(I.type==="number")v.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${I!=null&&I.number.isNotEmpty?I.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(I.type)){const F=I?I[I.type]:null,K=!((l=t.filter.relativeDate)!=null&&l.direction),X=!((o=t.filter.relativeDate2)!=null&&o.direction);v.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${t.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${t.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${t.filter.relativeDate?"fn__none":""}">
        <input value="${F&&(F.isNotEmpty||I.type!=="date")?Q(F.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${t.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((r=t.filter.relativeDate)==null?void 0:r.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((c=t.filter.relativeDate)==null?void 0:c.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${K?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" oninput="this.value = Math.max(this.value, 1)" step="1" value="${((d=t.filter.relativeDate)==null?void 0:d.count)||1}" class="b3-text-field fn__flex-1${K?" fn__none":""}"/>
        <span class="fn__space${K?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((u=t.filter.relativeDate)==null?void 0:u.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!t.filter.relativeDate||((m=t.filter.relativeDate)==null?void 0:m.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((f=t.filter.relativeDate)==null?void 0:f.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((g=t.filter.relativeDate)==null?void 0:g.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${t.filter.relativeDate2?"fn__none":""}">
        <input value="${F&&F.isNotEmpty2?Q(F.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${t.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((h=t.filter.relativeDate2)==null?void 0:h.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((b=t.filter.relativeDate2)==null?void 0:b.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${X?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" oninput="this.value = Math.max(this.value, 1)" value="${((y=t.filter.relativeDate2)==null?void 0:y.count)||1}" class="b3-text-field fn__flex-1${X?" fn__none":""}"/>
        <span class="fn__space${X?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((w=t.filter.relativeDate2)==null?void 0:w.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!t.filter.relativeDate2||((E=t.filter.relativeDate2)==null?void 0:E.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((C=t.filter.relativeDate2)==null?void 0:C.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${(($=t.filter.relativeDate2)==null?void 0:$.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}v.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const F=Object.assign([],t.data.view.filters);t.data.view.filters.find((X,J)=>{if(X.column===t.filter.column&&t.filter.value.type===X.value.type)return t.data.view.filters.splice(J,1),!0}),V(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters,blockID:k}],[{action:"setAttrViewFilters",avID:t.data.id,data:F,blockID:k}]);const K=T(t.target,"b3-menu");K&&(K.innerHTML=Ts(t.data))}}),_=v.element.querySelector('.b3-select[data-type="operation"]'),_==null||_.addEventListener("change",()=>{cE(_,_.value,I.type)});const Z=v.element.querySelector('.b3-select[data-type="dateType"]');Z==null||Z.addEventListener("change",()=>{const F=v.element.querySelectorAll('[data-type="dataDirection"]'),K=F[0].parentElement,X=F[1].parentElement,J=K.previousElementSibling,Me=X.previousElementSibling;Z.value==="custom"?(K.classList.remove("fn__none"),X.classList.remove("fn__none"),J.classList.add("fn__none"),Me.classList.add("fn__none")):(K.classList.add("fn__none"),X.classList.add("fn__none"),J.classList.remove("fn__none"),Me.classList.remove("fn__none"))}),v.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(F=>{F.addEventListener("change",()=>{const K=F.nextElementSibling.nextElementSibling;F.value==="0"?(K.classList.add("fn__none"),K.nextElementSibling.classList.add("fn__none")):(K.classList.remove("fn__none"),K.nextElementSibling.classList.remove("fn__none"))})});const R=v.element.querySelectorAll(".b3-text-field");["relation","select","mSelect"].includes(I.type)||R.forEach(F=>{F.addEventListener("keydown",K=>{if(K.isComposing){K.preventDefault();return}K.key==="Enter"&&(v.close(),K.preventDefault())})}),cE(_,_.value,I.type),v.open({x:M.left,y:M.bottom}),R.length>0&&R[0].select()}),O0=t=>{const e=new dt(p.MENU_AV_ADD_FILTER);yt(t.data).forEach(n=>{let a;t.data.view.filters.find(i=>{if(i.column===n.id&&i.value.type===n.type)return a=i,!0}),!a&&n.type!=="lineNumber"&&e.addItem({label:n.name,iconHTML:n.icon?be(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Gt(n.type)}"></use></svg>`,click:()=>{const i=si(n.type,n.type==="checkbox"?{checked:void 0}:"");a={column:n.id,operator:rE(n.type),value:i},t.data.view.filters.push(a),t.menuElement.innerHTML=Ts(t.data),Te(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height);const s=t.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);ab({empty:!0,filter:a,protyle:t.protyle,data:t.data,target:s,blockElement:t.blockElement})}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},Ts=t=>{let e="";const n=yt(t),a=i=>{let s="";return n.find(l=>{var o,r,c,d,u,m;if(l.id===i.column&&l.type===i.value.type){let f="";["rollup","mAsset"].includes(l.type)&&(i.quantifier===""||i.quantifier==="Any"?f=window.siyuan.languages.filterQuantifierAny+" ":i.quantifier==="All"?f=window.siyuan.languages.filterQuantifierAll+" ":i.quantifier==="None"&&(f=window.siyuan.languages.filterQuantifierNone+" "));const g=l.type==="rollup"?((r=(o=i.value.rollup)==null?void 0:o.contents)==null?void 0:r.length)>0?i.value.rollup.contents[0]:{type:"rollup"}:i.value;if(i.operator==="Is empty")f=": "+f+window.siyuan.languages.filterOperatorIsEmpty;else if(i.operator==="Is not empty")f=": "+f+window.siyuan.languages.filterOperatorIsNotEmpty;else if(i.operator==="Is false")(g.type!=="checkbox"||typeof g.checkbox.checked=="boolean")&&(f=": "+f+window.siyuan.languages.unchecked);else if(i.operator==="Is true")(g.type!=="checkbox"||typeof g.checkbox.checked=="boolean")&&(f=": "+f+window.siyuan.languages.checked);else if(["created","updated","date"].includes(g.type)){let h="",b="";i.relativeDate?(h=`${window.siyuan.languages[["pastDate","current","nextDate"][i.relativeDate.direction+1]]}
 ${i.relativeDate.direction?i.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][i.relativeDate.unit]]}`,i.relativeDate2&&(b=`${window.siyuan.languages[["pastDate","current","nextDate"][i.relativeDate2.direction+1]]}
 ${i.relativeDate2.direction?i.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][i.relativeDate2.unit]]}`)):g&&((c=g[g.type])!=null&&c.content&&(h=Q(g[g.type].content).format("YYYY-MM-DD")),g&&((d=g[g.type])!=null&&d.content2)&&(b=Q(g[g.type].content2).format("YYYY-MM-DD"))),h&&(i.operator==="Is between"&&b?f=` ${f}${window.siyuan.languages.filterOperatorIsBetween} ${h} ${b}`:i.operator==="="?f=`: ${f}${h}`:[">","<"].includes(i.operator)?f=` ${f}${i.operator} ${h}`:i.operator===">="?f=` ${f}\u2265 ${h}`:i.operator==="<="&&(f=` ${f}\u2264 ${h}`))}else if(["mSelect","select"].includes(g.type)){let h="";((u=g.mSelect)==null?void 0:u.length)>0&&(g.mSelect.forEach((b,y)=>{h+=b.content,y!==g.mSelect.length-1&&(h+=", ")}),h&&(i.operator==="Contains"?f=`: ${f}${h}`:i.operator==="Does not contains"?f=` ${f}${window.siyuan.languages.filterOperatorDoesNotContain} ${h}`:i.operator==="="?f=`: ${f}${h}`:i.operator==="!="&&(f=` ${f}${window.siyuan.languages.filterOperatorIsNot} ${h}`))),!h&&["rollup","mAsset"].includes(l.type)&&!["Is empty","Is not empty"].includes(i.operator)&&(f="")}else if(g.type==="number"&&g.number&&g.number.isNotEmpty)["=","!=",">","<"].includes(i.operator)?f=` ${f}${i.operator} ${g.number.content}`:i.operator===">="?f=` ${f}\u2265 ${g.number.content}`:i.operator==="<="&&(f=` ${f}\u2264 ${g.number.content}`);else if(["text","block","url","mAsset","phone","email","relation","template"].includes(g.type)){let h;g[g.type]&&(g.type==="relation"?h=g.relation.blockIDs[0]||"":g.type==="mAsset"?h=((m=g.mAsset[0])==null?void 0:m.content)||"":h=g[g.type].content||"",h&&(["=","Contains"].includes(i.operator)?f=`: ${f}${h}`:i.operator==="Does not contains"?f=` ${f}${window.siyuan.languages.filterOperatorDoesNotContain} ${h}`:i.operator==="!="?f=` ${f}${window.siyuan.languages.filterOperatorIsNot} ${h}`:i.operator==="Starts with"?f=` ${f}${window.siyuan.languages.filterOperatorStartsWith} ${h}`:i.operator==="Ends with"?f=` ${f}${window.siyuan.languages.filterOperatorEndsWith} ${h}`:[">","<"].includes(i.operator)?f=` ${f}${i.operator} ${h}`:i.operator===">="?f=` ${f}\u2265 ${h}`:i.operator==="<="&&(f=` ${f}\u2264 ${h}`))),!h&&["rollup","mAsset"].includes(l.type)&&!["Is empty","Is not empty"].includes(i.operator)&&(f="")}return s+=`<span data-type="setFilter" class="b3-chip${f?" b3-chip--primary":""}">
    ${l.icon?be(l.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Gt(l.type)}"></use></svg>`}
    <span class="fn__ellipsis">${l.name}${f}</span>
</span>`,!0}}),s};return t.view.filters.forEach(i=>{const s=a(i);s&&(e+=`<button class="b3-menu__item" draggable="true" data-id="${i.column}" data-filter-type="${i.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${s}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${e}
<button class="b3-menu__item${t.view.filters.length===n.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item b3-menu__item--warning${e?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`};var B0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Xn=(t,e)=>{if(e==="table"||T(t,"custom-attr"))return t.getAttribute("data-col-id");if(["gallery","kanban"].includes(e))return t.getAttribute("data-field-id")},uE=t=>{let e;const n=yt(t.data);n.find((s,l)=>{if(s.id===t.colId)return e=JSON.parse(JSON.stringify(s)),n.splice(l+1,0,e),!0}),e.name=Ma(e.name),e.id=Lute.NewNodeID();const a=Q().format("YYYYMMDDHHmmss"),i=t.blockElement.getAttribute("data-node-id");V(t.protyle,[{action:"duplicateAttrViewKey",keyID:t.colId,nextID:e.id,avID:t.data.id},{action:"doUpdateUpdated",id:i,data:a}],[{action:"removeAttrViewCol",id:e.id,avID:t.data.id},{action:"doUpdateUpdated",id:i,data:t.blockElement.getAttribute("updated")}]),Mn({blockElement:t.blockElement,protyle:t.protyle,type:e.type,name:e.name,icon:e.icon,previousID:t.colId,data:t.data,id:e.id}),t.blockElement.setAttribute("updated",a)},oi=t=>{var e,n,a,i,s;let l;yt(t.data).find(r=>{if(r.id===t.colId)return l=r,!0});let o=`<button class="b3-menu__item" data-type="nobg" data-col-id="${t.colId}">
    <span class="block__icon${t.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator" data-id="separator_1"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-col-type="${l.type}" data-icon="${l.icon}" data-type="update-icon">${l.icon?be(l.icon):`<svg style="width: 14px;height: 14px"><use xlink:href="#${Gt(l.type)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${l.desc?Zt(l.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__block" type="text" data-value="${at(l.desc)}">${l.desc}</textarea>
        </div>
        <div class="fn__hr--small"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${l.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${Gt(l.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${Ti(l.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(l.type))o+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <input data-type="addOption" class="b3-text-field fn__block" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}" style="margin: 4px 0">
</button>`,l.options||(l.options=[]),l.options.forEach(r=>{const c=r.desc?`${Zt(r.name)}<div class='ft__on-surface'>${Zt(r.desc||"")}</div>`:"";o+=`<button class="b3-menu__item${o?"":" b3-menu__item--current"}" draggable="true" data-name="${at(r.name)}" data-desc="${at(r.desc||"")}" data-color="${r.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${c}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">
            <span class="fn__ellipsis">${he(r.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(l.type==="number")o+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${l.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${Xv(l.numberFormat)}</span>
</button>`;else if(l.type==="template")o+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(l.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${l.template}</textarea>
</button>`;else if(l.type==="relation"){const r=((e=l.relation)==null?void 0:e.avID)===t.data.id;o+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((n=l.relation)==null?void 0:n.avID)||""}" data-old-value='${JSON.stringify(l.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${r?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(a=l.relation)!=null&&a.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${t.data.name} ${l.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else l.type==="rollup"?o+='<button class="b3-menu__separator" data-id="separator_2"></button>'+nE({colData:l}):l.type==="date"?o+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${(i=l.date)!=null&&i.autoFillNow?"checked":""}>
</label>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillSpecificTime}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillSpecificTime" type="checkbox" class="b3-switch b3-switch--menu" ${(s=l.date)!=null&&s.fillSpecificTime?"checked":""}>
</label>`:["updated","created"].includes(l.type)&&(o+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="includeTime" type="checkbox" class="b3-switch b3-switch--menu" ${!l[l.type]||l[l.type].includeTime?"checked":""}>
</label>`);return o+=`<button class="b3-menu__separator" data-id="separator_3"></button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconSoftWrap"></use></svg>
    <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
    <span class="fn__space fn__flex-1"></span>
    <input type="checkbox" data-type="wrap" class="b3-switch b3-switch--menu"${l.wrap?" checked":""}>
</label>`,l.type!=="block"&&(o+=`<button class="b3-menu__item${l.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item  b3-menu__item--warning" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${o}
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${l.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${Rn("text",l.type)}
    ${Rn("number",l.type)}
    ${Rn("select",l.type)}
    ${Rn("mSelect",l.type)}
    ${Rn("date",l.type)}
    ${Rn("mAsset",l.type)}
    ${Rn("checkbox",l.type)}
    ${Rn("url",l.type)}
    ${Rn("email",l.type)}
    ${Rn("phone",l.type)}
    ${Rn("template",l.type)}
    ${Rn("relation",l.type)}
    ${Rn("rollup",l.type)}
    ${Rn("lineNumber",l.type)}
    ${Rn("created",l.type)}
    ${Rn("updated",l.type)}
</div>`},ri=t=>{const e=t.data.id,n=t.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=yt(t.data).find(f=>f.id===n),i=t.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const f=i.value;f!==a.name&&(V(t.protyle,[{action:"updateAttrViewCol",id:n,avID:e,name:f,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:e,name:a.name,type:a.type}]),a.name=f,On(t.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:f}))}),i.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"?t.menuElement.parentElement.remove():f.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}),i.addEventListener("keyup",f=>{if(f.isComposing)return;const g=t.menuElement.querySelector('[data-type="colName"]');g&&g.setAttribute("placeholder",`${t.data.name} ${i.value}`)}),i.select(),i.value=a.name;const s=t.menuElement.querySelector('.b3-text-field[data-type="desc"]');i.nextElementSibling.addEventListener("click",()=>{const f=s.parentElement;f.classList.toggle("fn__none"),f.classList.contains("fn__none")||s.focus()}),s.addEventListener("blur",()=>{const f=s.value;f!==a.desc&&(V(t.protyle,[{action:"setAttrViewColDesc",id:n,avID:e,data:f}],[{action:"setAttrViewColDesc",id:n,avID:e,data:a.desc}]),a.desc=f)}),s.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"?t.menuElement.parentElement.remove():f.key==="Enter"&&(s.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}),s.addEventListener("input",()=>{i.nextElementSibling.setAttribute("aria-label",s.value?he(s.value):window.siyuan.languages.addDesc)});const l=t.menuElement.querySelector('[data-type="updateTemplate"]');l&&(l.addEventListener("blur",()=>{const f=l.value;f!==a.template&&(V(t.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:e,data:f,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:e,data:a.template,type:a.type}]),a.template=f)}),l.addEventListener("keydown",f=>{f.isComposing||(f.key==="Escape"?t.menuElement.parentElement.remove():f.key==="Enter"&&!f.shiftKey&&(l.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}));const o=t.menuElement.querySelector('.b3-switch[data-type="includeTime"]');o&&o.addEventListener("change",()=>{V(t.protyle,[{action:a.type==="updated"?"setAttrViewUpdatedIncludeTime":"setAttrViewCreatedIncludeTime",id:n,avID:e,data:o.checked}],[{action:a.type==="updated"?"setAttrViewUpdatedIncludeTime":"setAttrViewCreatedIncludeTime",id:n,avID:e,data:!o.checked}]),a[a.type]?a[a.type].includeTime=o.checked:a[a.type]={includeTime:o.checked}});const r=t.menuElement.querySelector('.b3-switch[data-type="wrap"]');r&&r.addEventListener("change",()=>{V(t.protyle,[{action:"setAttrViewColWrap",id:n,avID:e,data:r.checked,blockID:t.blockID,viewID:t.data.viewID}],[{action:"setAttrViewColWrap",id:n,avID:e,data:!r.checked,viewID:t.data.viewID,blockID:t.blockID}]),a.wrap=r.checked,t.data.view.wrapField=t.data.view.wrapField&&r.checked});const c=t.menuElement.querySelector('[data-type="addOption"]');c&&c.addEventListener("keydown",f=>{if(!f.isComposing&&(f.key==="Escape"&&t.menuElement.parentElement.remove(),f.key==="Enter")){let g=!1;if(a.options.find(h=>{if(c.value===h.name)return g=!0,!0}),g||!c.value)return;a.options.push({color:((a.options.length||0)%14+1).toString(),name:c.value}),V(t.protyle,[{action:"updateAttrViewColOptions",id:n,avID:e,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:e,data:c.value}]),t.menuElement.innerHTML=oi({protyle:t.protyle,colId:n,data:t.data,isCustomAttr:t.isCustomAttr}),ri({protyle:t.protyle,menuElement:t.menuElement,data:t.data,isCustomAttr:t.isCustomAttr,blockID:t.blockID}),t.menuElement.querySelector('[data-type="addOption"]').focus()}});const d=t.menuElement.querySelector('[data-type="fillCreated"]');d&&d.addEventListener("change",()=>{V(t.protyle,[{avID:e,action:"setAttrViewColDateFillCreated",id:n,data:d.checked}],[{avID:e,action:"setAttrViewColDateFillCreated",id:n,data:!d.checked}])});const u=t.menuElement.querySelector('[data-type="fillSpecificTime"]');u&&u.addEventListener("change",()=>{V(t.protyle,[{avID:e,action:"setAttrViewColDateFillSpecificTime",id:n,data:u.checked}],[{avID:e,action:"setAttrViewColDateFillSpecificTime",id:n,data:!u.checked}])});const m=t.menuElement.querySelector('[data-type="backRelation"]');if(m){m.addEventListener("change",()=>{Nc(t.menuElement,e)});const f=t.menuElement.querySelector('[data-type="goSearchAV"]'),g=JSON.parse(f.getAttribute("data-old-value")),h=t.menuElement.querySelector('[data-type="colName"]');h.addEventListener("input",()=>{Nc(t.menuElement,e)}),g.avID?A("/api/av/getAttributeView",{id:g.avID},b=>{f.querySelector(".b3-menu__accelerator").textContent=g.avID===e?window.siyuan.languages.thisDatabase:b.data.av.name||window.siyuan.languages._kernel[267],b.data.av.keyValues.find(y=>{if(y.key.id===g.backKeyID)return h.setAttribute("data-old-value",y.key.name||window.siyuan.languages._kernel[272]),h.value=y.key.name||window.siyuan.languages._kernel[272],!0}),Nc(t.menuElement,e)}):Nc(t.menuElement,e)}aE(t)},Ti=t=>{switch(t){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[t];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},Gt=t=>{switch(t){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},Mn=t=>{if(!t.blockElement)return;const e=t.blockElement.getAttribute("data-node-id");t.blockElement.classList.contains("av")?t.blockElement.querySelectorAll(".av__row").forEach(i=>{let s;t.previousID?s=i.querySelector(`[data-col-id="${t.previousID}"]`):s=i.querySelector(".av__cell").previousElementSibling;let l="";i.classList.contains("av__row--header")?l=`<div class="av__cell av__cell--header" draggable="true" data-icon="${t.icon||""}" data-col-id="${t.id}" data-dtype="${t.type}" data-wrap="false" style="width: 200px;">
    ${t.icon?be(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Gt(t.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${t.name}</span>
    <div class="av__widthdrag"></div>
</div>`:l='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',s.insertAdjacentHTML("afterend",l)}):t.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${e}" data-col-id="${t.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Ti(t.type)}">
        <svg class="block__logoicon"><use xlink:href="#${Gt(t.type)}"></use></svg>
        <span>${Ti(t.type)}</span>
    </div>
    <div data-col-id="${t.id}" data-block-id="${e}" data-type="${t.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const n=document.querySelector(".av__panel .b3-menu");if(n&&t.data&&t.blockElement.classList.contains("av")){n.innerHTML=oi({protyle:t.protyle,data:t.data,colId:t.id,isCustomAttr:!1}),ri({protyle:t.protyle,data:t.data,menuElement:n,isCustomAttr:!1,blockID:e});const i=t.blockElement.querySelector(".av__views").getBoundingClientRect();i&&Te(n,i.right-n.clientWidth,i.bottom,i.height);return}let a;t.data&&(a=yt(t.data).find(i=>i.id===t.id)),Cn({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:t.id,editData:{previousID:t.previousID,colData:a||R0(t.type,t.id,t.name)}}),window.siyuan.menus.menu.remove()},fE=(t,e,n)=>{const a=n.getAttribute("data-dtype"),i=n.getAttribute("data-col-id"),s=e.getAttribute("data-av-id"),l=e.getAttribute("data-node-id"),o=e.getAttribute(p.CUSTOM_SY_AV_VIEW),r=n.querySelector(".av__celltext").textContent.trim(),c=n.dataset.desc,d=new dt(p.MENU_AV_HEADER_CELL,()=>{const g=d.element.querySelector(".b3-text-field").value;g!==r&&(V(t,[{action:"updateAttrViewCol",id:i,avID:s,name:g,type:a}],[{action:"updateAttrViewCol",id:i,avID:s,name:r,type:a}]),On(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:g}));const h=d.element.querySelector("textarea").value;h!==c&&V(t,[{action:"setAttrViewColDesc",id:i,avID:s,data:h}],[{action:"setAttrViewColDesc",id:i,avID:s,data:c}]),oe(e)});d.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div><div class="fn__flex">
    <div class="fn__space"></div>
    <span class="b3-menu__avemoji">${n.dataset.icon?be(n.dataset.icon):`<svg style="height: 14px;width: 14px;"><use xlink:href="#${Gt(a)}"></use></svg>`}</span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field b3-form__icona-input" type="text">
        <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${c?Zt(c):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
    </div>
    <div class="fn__space"></div>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <div class="fn__flex">
        <span class="fn__space"></span>
        <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" class="b3-text-field fn__block" type="text" data-value="${at(c)}">${c}</textarea>
        <span class="fn__space"></span>    
    </div>
</div>
<div class="fn__hr--small"></div>`,bind(g){const h=g.querySelector(".b3-menu__avemoji");h.addEventListener("click",w=>{const E=h.getBoundingClientRect();Xa("","av",{x:E.left,y:E.bottom+4,h:E.height,w:E.width},C=>{V(t,[{action:"setAttrViewColIcon",id:i,avID:s,data:C}],[{action:"setAttrViewColIcon",id:i,avID:s,data:n.dataset.icon}]),h.innerHTML=C?be(C):`<svg style="height: 14px;width: 14px"><use xlink:href="#${Gt(a)}"></use></svg>`,On(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{icon:C})},h.querySelector("img")),w.preventDefault(),w.stopPropagation()});const b=g.querySelector("input");b.value=r,b.addEventListener("keydown",w=>{w.isComposing||w.key==="Enter"&&(d.close(),w.preventDefault())});const y=g.querySelector("textarea");b.nextElementSibling.addEventListener("click",()=>{const w=y.parentElement.parentElement;w.classList.toggle("fn__none"),w.classList.contains("fn__none")||y.focus()}),y.addEventListener("keydown",w=>{w.isComposing||w.key==="Enter"&&(d.close(),w.preventDefault())}),y.addEventListener("input",()=>{b.nextElementSibling.setAttribute("aria-label",y.value?he(y.value):window.siyuan.languages.addDesc)})}}),d.addItem({id:"edit",icon:"iconEdit",label:window.siyuan.languages.edit,click(){const g=d.element.querySelector(".b3-text-field").value;Cn({protyle:t,blockElement:e,type:"edit",colId:i,cb(h){const b=h.querySelector('.b3-text-field[data-type="name"]');b.value=g,b.select()}})}}),d.addSeparator({id:"separator_1"}),a!=="lineNumber"&&(d.addItem({id:"filter",icon:"iconFilter",label:window.siyuan.languages.filter,click(){A("/api/av/renderAttributeView",{id:s},g=>{const h=g.data;let b;h.view.filters.find(w=>{if(w.column===i&&w.value.type===a)return b=w,!0});let y=!1;b||(y=!0,b={column:i,operator:rE(a),value:si(a,"")},h.view.filters.push(b)),ab({empty:y,filter:b,protyle:t,data:h,blockElement:e,target:e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),d.addItem({id:"asc",icon:"iconUp",label:window.siyuan.languages.asc,click(){A("/api/av/renderAttributeView",{id:s},g=>{V(t,[{action:"setAttrViewSorts",avID:g.data.id,data:[{column:i,order:"ASC"}],blockID:l}],[{action:"setAttrViewSorts",avID:g.data.id,data:g.data.view.sorts,blockID:l}])})}}),d.addItem({id:"desc",icon:"iconDown",label:window.siyuan.languages.desc,click(){A("/api/av/renderAttributeView",{id:s},g=>{V(t,[{action:"setAttrViewSorts",avID:g.data.id,data:[{column:i,order:"DESC"}],blockID:l}],[{action:"setAttrViewSorts",avID:g.data.id,data:g.data.view.sorts,blockID:l}])})}}));const u=n.dataset.pin==="true";if(d.addItem({id:u?"unfreezeCol":"freezeCol",icon:u?"iconUnpin":"iconPin",label:u?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){V(t,[{action:"setAttrViewColPin",id:i,avID:s,data:!u,blockID:l}],[{action:"setAttrViewColPin",id:i,avID:s,data:u,blockID:l}]),On(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{pin:!u})}}),a!=="block"&&d.addItem({id:"hide",icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){V(t,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0,blockID:l}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1,blockID:l}])}}),d.addItem({icon:"iconRefresh",label:window.siyuan.languages.syncColWidth,click(){V(t,[{action:"syncAttrViewTableColWidth",keyID:i,avID:s,id:o}])}}),d.addItem({icon:"iconSoftWrap",label:`<label class="fn__flex fn__pointer"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(g){const h=g.querySelector(".b3-switch");h.addEventListener("change",()=>{n.dataset.wrap=h.checked.toString(),V(t,[{action:"setAttrViewColWrap",id:i,avID:s,data:h.checked,blockID:l,viewID:o}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!h.checked,blockID:l,viewID:o}]),d.close()})}}),d.addSeparator({id:"separator_2"}),d.addItem({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var g;const h=Zc(t,e,((g=n.previousElementSibling)==null?void 0:g.getAttribute("data-col-id"))||"");e.contains(n)||(n=e.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const b=n.getBoundingClientRect();h.open({x:b.left,y:b.bottom,h:b.height})}}),d.addItem({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const g=Zc(t,e,i);e.contains(n)||(n=e.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const h=n.getBoundingClientRect();g.open({x:h.left,y:h.bottom,h:h.height})}}),a!=="block"){let g;a!=="relation"&&d.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){A("/api/av/renderAttributeView",{id:s},h=>{uE({blockElement:e,viewID:o,protyle:t,colId:i,data:h.data})})}}),d.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){return B0(this,null,function*(){var h;if(a==="relation"){const y=(yield Ae("/api/av/getAttributeView",{id:s})).data.av.keyValues.find(w=>w.key.id===i);if((h=y.key.relation)!=null&&h.isTwoWay){const w=yield Ae("/api/av/getAttributeView",{id:y.key.relation.avID}),E=new $e({title:window.siyuan.languages.removeColConfirm,content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",y.key.name||window.siyuan.languages._kernel[272]).replace("${y}",w.data.av.name||window.siyuan.languages._kernel[267]).replace("${z}",w.data.av.keyValues.find(C=>C.key.id===y.key.relation.backKeyID).key.name||window.siyuan.languages._kernel[272])}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.removeBothRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`,width:"520px"});E.element.addEventListener("click",C=>{let $=C.target;const M=typeof C.detail=="string";for(;$&&$!==E.element||M;){const k=$.getAttribute("data-action");if(k==="delete"||M&&C.detail==="Enter"){ib({protyle:t,colId:i,avID:s,blockID:l,oldValue:r,type:a,cellElement:n,blockElement:e,removeDest:!0}),E.destroy();break}else if(k==="keep-relation"){ib({protyle:t,colId:i,avID:s,blockID:l,oldValue:r,type:a,cellElement:n,blockElement:e,removeDest:!1}),E.destroy();break}else if($.classList.contains("b3-button--cancel")||M&&C.detail==="Escape"){E.destroy();break}$=$.parentElement}}),E.element.querySelector("button").focus(),E.element.setAttribute("data-key",p.DIALOG_CONFIRM);return}}ib({protyle:t,colId:i,avID:s,blockID:l,oldValue:r,type:a,cellElement:n,blockElement:e,removeDest:!1})})}})}const m=n.getBoundingClientRect();d.open({x:m.left,y:m.bottom,h:m.height});const f=window.siyuan.menus.menu.element.querySelector(".b3-text-field");f&&(f.select(),f.focus())},ib=t=>{var e;const n=Q().format("YYYYMMDDHHmmss");V(t.protyle,[{action:"removeAttrViewCol",id:t.colId,avID:t.avID,removeDest:t.removeDest},{action:"doUpdateUpdated",id:t.blockID,data:n}],[{action:"addAttrViewCol",name:t.oldValue,avID:t.avID,type:t.type,id:t.colId,previousID:((e=t.cellElement.previousElementSibling)==null?void 0:e.getAttribute("data-col-id"))||""},{action:"doUpdateUpdated",id:t.blockID,data:t.blockElement.getAttribute("updated")}]),Kv(t.blockElement,t.colId),t.blockElement.setAttribute("updated",n)},sb=t=>{const e=t.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let n="";const a=t.fields.find((s,l)=>{var o;if(s.id===e)return n=(o=t.fields[l-1])==null?void 0:o.id,t.fields.splice(l,1),!0}),i=Q().format("YYYYMMDDHHmmss");V(t.protyle,[{action:"removeAttrViewCol",id:e,avID:t.avID,removeDest:t.isTwoWay},{action:"doUpdateUpdated",id:t.blockID,data:i}],[{action:"addAttrViewCol",name:a.name,avID:t.avID,type:a.type,id:e,previousID:n},{action:"doUpdateUpdated",id:t.blockID,data:t.blockElement.getAttribute("updated")}]),Kv(t.blockElement,e),t.blockElement.setAttribute("updated",i),t.isCustomAttr?t.avPanelElement.remove():(t.menuElement.innerHTML=Cs(t.fields),Te(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height))},Rn=(t,e)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${e}" data-new-type="${t}">
    <svg class="b3-menu__icon"><use xlink:href="#${Gt(t)}"></use></svg>
    <span class="b3-menu__label">${Ti(t)}</span>
    ${t===e?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,Zc=(t,e,n)=>{const a=new dt(p.MENU_AV_HEADER_ADD),i=e.getAttribute("data-av-id");typeof n=="undefined"&&e.getAttribute("data-av-type")==="table"&&(n=Array.from(e.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const s=e.getAttribute("data-node-id");return a.addItem({id:"text",icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:i,type:"text",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"text",name:window.siyuan.languages.text,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"number",icon:"iconNumber",label:window.siyuan.languages.number,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:i,type:"number",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"number",name:window.siyuan.languages.number,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"select",icon:"iconListItem",label:window.siyuan.languages.select,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:i,type:"select",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"select",name:window.siyuan.languages.select,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"multiSelect",icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:i,type:"mSelect",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"mSelect",name:window.siyuan.languages.multiSelect,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"date",icon:"iconCalendar",label:window.siyuan.languages.date,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:i,type:"date",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"date",name:window.siyuan.languages.date,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"assets",icon:"iconImage",label:window.siyuan.languages.assets,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:i,type:"mAsset",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"mAsset",name:window.siyuan.languages.assets,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"checkbox",icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:i,type:"checkbox",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"checkbox",name:window.siyuan.languages.checkbox,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"link",icon:"iconLink",label:window.siyuan.languages.link,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:i,type:"url",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"url",name:window.siyuan.languages.link,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"email",icon:"iconEmail",label:window.siyuan.languages.email,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:i,type:"email",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"email",name:window.siyuan.languages.email,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"phone",icon:"iconPhone",label:window.siyuan.languages.phone,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:i,type:"phone",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"phone",name:window.siyuan.languages.phone,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"template",icon:"iconMath",label:window.siyuan.languages.template,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:i,type:"template",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"template",name:window.siyuan.languages.template,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"relation",icon:"iconOpen",label:window.siyuan.languages.relation,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:i,type:"relation",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"relation",name:window.siyuan.languages.relation,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"rollup",icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:i,type:"rollup",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"rollup",name:window.siyuan.languages.rollup,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"lineNumber",icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:i,type:"lineNumber",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"createdTime",icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:i,type:"created",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"created",name:window.siyuan.languages.createdTime,id:l,previousID:n}),e.setAttribute("updated",o)}}),a.addItem({id:"updatedTime",icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const l=Lute.NewNodeID(),o=Q().format("YYYYMMDDHHmmss");V(t,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:i,type:"updated",id:l,previousID:n},{action:"doUpdateUpdated",id:s,data:o}],[{action:"removeAttrViewCol",id:l,avID:i},{action:"doUpdateUpdated",id:s,data:e.getAttribute("updated")}]),Mn({blockElement:e,protyle:t,type:"updated",name:window.siyuan.languages.updatedTime,id:l,previousID:n}),e.setAttribute("updated",o)}}),a},R0=(t,e,n)=>({hidden:!1,icon:"",id:e,name:n,desc:"",numberFormat:"",pin:!1,template:"",type:t,width:"",wrap:void 0,calc:null});var q0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const F0=(t,e)=>{let n="";return["mSelect","select"].includes(t.groupValue.type)?t.groupValue.mSelect.forEach(a=>{n+=`<span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">${he(a.content)}</span>`}):t.groupValue.type==="checkbox"?n=`<svg style="width:calc(1.625em - 12px);height:calc(1.625em - 12px);margin: 4px 0;float: left;"><use xlink:href="#icon${t.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg>`:n=t.name,`<div class="av__group-title">
    <span class="av__group-name fn__ellipsis" style="white-space: nowrap;">${n}</span>
    ${e===0?'<span class="fn__space"></span>':`<span aria-label="${window.siyuan.languages.entryNum}" data-position="north" class="av__group-counter ariaLabel">${e}</span>`}
    <span class="fn__flex-1"></span>
    <span class="av__group-icon av__group-icon--hover ariaLabel" data-type="av-add-top" data-position="north" aria-label="${window.siyuan.languages.newRow}"><svg><use xlink:href="#iconAdd"></use></svg></span>
</div>`},U0=t=>{let e="";return t.cards.forEach((n,a)=>{if(e+=`<div data-id="${n.id}" draggable="true" class="av__gallery-item">`,t.coverFrom!==0){const i="av__gallery-cover av__gallery-cover--"+t.cardAspectRatio;n.coverURL?n.coverURL.startsWith("background")?e+=`<div class="${i}"><img class="av__gallery-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" style="${n.coverURL}"></div>`:e+=`<div class="${i}"><img loading="lazy" class="av__gallery-img${t.fitImage?" av__gallery-img--fit":""}" src="${Wc(n.coverURL)}"></div>`:n.coverContent.trim()&&(e+=`<div class="${i}"><div class="av__gallery-content">${n.coverContent}</div><div></div></div>`)}e+='<div class="av__gallery-fields">',n.values.forEach((i,s)=>{var l,o,r;if(t.fields[s].hidden)return;let c="";i.valueType==="checkbox"&&(c=(o=(l=i.value)==null?void 0:l.checkbox)!=null&&o.checked?" av__cell-check":" av__cell-uncheck");const d=nb(i.value);let u=at(t.fields[s].name)||Ti(t.fields[s].type);t.fields[s].desc&&(u+=at(`<div class="ft__on-surface">${t.fields[s].desc}</div>`)),i.valueType==="checkbox"&&!t.displayFieldName&&(i.value.checkbox.content=t.fields[s].name||Ti(t.fields[s].type));const m=`<div class="av__cell${c}${t.displayFieldName?"":" ariaLabel"}" 
data-wrap="${t.fields[s].wrap}" 
aria-label="${u}" 
data-position="5west"
data-id="${i.id}" 
data-field-id="${t.fields[s].id}" 
data-dtype="${i.valueType}" 
${(r=i.value)!=null&&r.isDetached?' data-detached="true"':""} 
style="${i.bgColor?`background-color:${i.bgColor};`:""}
${i.color?`color:${i.color};`:""}">${li(i.value,a,t.showIcon,"kanban")}</div>`;t.displayFieldName?e+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${d}">
    <div class="av__gallery-name">
        ${t.fields[s].icon?be(t.fields[s].icon,void 0,!0):`<svg><use xlink:href="#${Gt(t.fields[s].type)}"></use></svg>`}${Lute.EscapeHTMLStr(t.fields[s].name)}
        ${t.fields[s].desc?`<svg aria-label="${t.fields[s].desc}" data-position="north" class="ariaLabel"><use xlink:href="#iconInfo"></use></svg>`:""}
    </div>
    ${m}
</div>`:e+=`<div class="av__gallery-field" data-empty="${d}">
    <div class="av__gallery-tip">
        ${t.fields[s].icon?be(t.fields[s].icon,void 0,!0):`<svg><use xlink:href="#${Gt(t.fields[s].type)}"></use></svg>`}${window.siyuan.languages.edit} ${Lute.EscapeHTMLStr(t.fields[s].name)}
    </div>
    ${m}
</div>`}),e+=`</div>
    <div class="av__gallery-actions">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.displayEmptyFields}" data-type="av-gallery-edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.more}" data-type="av-gallery-more"><svg><use xlink:href="#iconMore"></use></svg></span>
    </div>
</div>`}),e+=`<div class="av__gallery-add" data-type="av-add-bottom"><svg class="svg"><use xlink:href="#iconAdd"></use></svg><span class="fn__space"></span>${window.siyuan.languages.newRow}</div>`,`<div class="av__gallery av__gallery--small">
    ${e}
</div>
<div class="av__gallery-load${t.cardCount>t.cards.length?"":" fn__none"}">
    <button class="b3-button av__button" data-type="av-load-more">
        <svg><use xlink:href="#iconArrowDown"></use></svg>
        <span>${window.siyuan.languages.loadMore}</span>
        <svg data-type="set-page-size" data-size="${t.pageSize}"><use xlink:href="#iconMore"></use></svg>
    </button>
</div>`},lb=t=>q0(void 0,null,function*(){var e,n,a;const i=t.blockElement.querySelector('[data-type="av-search"]'),s=[];t.blockElement.querySelectorAll(".av__gallery-fields--edit").forEach(h=>{s.push({groupId:T(h,"av__body").dataset.groupId||"",fieldId:h.parentElement.getAttribute("data-id")})});const l=[];t.blockElement.querySelectorAll(".av__gallery-item--select").forEach(h=>{const b=h.getAttribute("data-id");b&&l.push({groupId:T(h,"av__body").dataset.groupId||"",fieldId:b})});const o={};t.blockElement.querySelectorAll(".av__body").forEach(h=>{o[h.dataset.groupId||"unGroup"]=h.dataset.pageSize});const r={isSearching:i&&document.activeElement===i,query:(i==null?void 0:i.value)||"",alignSelf:t.blockElement.style.alignSelf,oldOffset:t.protyle.contentElement.scrollTop,editIds:s,selectItemIds:l,pageSizes:o,left:(e=t.blockElement.querySelector(".av__kanban"))==null?void 0:e.scrollLeft};t.blockElement.firstElementChild.innerHTML===""&&(t.blockElement.style.alignSelf="",t.blockElement.firstElementChild.outerHTML=`<div class="av__kanban fn__flex">
    <span style="width: 260px;height: 178px;" class="av__pulse"></span>
    <span style="width: 260px;height: 178px;" class="av__pulse"></span>
    <span style="width: 260px;height: 178px;" class="av__pulse"></span>
</div>`);const c=(n=t.protyle.options.history)==null?void 0:n.created,d=(a=t.protyle.options.history)==null?void 0:a.snapshot;let u=t.data;if(!u){const h=xp(t.blockElement);u=(yield Ae(c?"/api/av/renderHistoryAttributeView":d?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:t.blockElement.getAttribute("data-av-id"),created:c,snapshot:d,pageSize:h.unGroupPageSize,groupPaging:h.groupPageSize,viewID:t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW)||"",query:r.query.trim()})).data}if(u.viewType==="table"){t.blockElement.setAttribute("data-av-type","table"),Vt(t.blockElement,t.protyle,t.cb,t.renderAll,u);return}if(u.viewType==="gallery"){t.blockElement.setAttribute("data-av-type",u.viewType),rb({blockElement:t.blockElement,protyle:t.protyle,cb:t.cb,renderAll:t.renderAll,data:u});return}const m=u.view;let f="",g=!1;if(m.groups.forEach(h=>{var b;if(h.groupHidden===0){let y="";h.fillColBackgroundColor&&(["mSelect","select"].includes(h.groupValue.type)&&(g=!0),g&&(h.groupValue.mSelect&&h.groupValue.mSelect.length>0?y=`style="--b3-av-kanban-background: var(--b3-font-background${h.groupValue.mSelect[0].color});"`:y='style="--b3-av-kanban-background: var(--b3-border-color);"')),f+=`<div class="av__kanban-group${h.cardSize===0?" av__kanban-group--small":h.cardSize===2?" av__kanban-group--big":""}"${y}>
    ${F0(h,h.cardCount)}
    <div data-group-id="${h.id}" data-page-size="${h.pageSize}" data-dtype="${h.groupKey.type}" data-content="${Lute.EscapeHTMLStr(((b=h.groupValue.text)==null?void 0:b.content)||"")}" class="av__body">${U0(h)}</div>
</div>`}}),t.renderAll)t.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${Jc(u,r.isSearching||!!r.query,!t.protyle.disabled&&!j(t.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__kanban${g?" av__kanban--bg":""}">
        ${f}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`;else{const h=t.blockElement.querySelector(".av__kanban");h.innerHTML=f,g?h.classList.add("av__kanban--bg"):h.classList.remove("av__kanban--bg")}ob({resetData:r,renderAll:t.renderAll,data:u,cb:t.cb,protyle:t.protyle,blockElement:t.blockElement}),m.hideAttrViewName&&t.blockElement.querySelector(".av__gallery").classList.add("av__gallery--top")});var W0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const pE=t=>{let e="";return t.cards.forEach((n,a)=>{if(e+=`<div data-id="${n.id}" draggable="true" class="av__gallery-item">`,t.coverFrom!==0){const i="av__gallery-cover av__gallery-cover--"+t.cardAspectRatio;n.coverURL?n.coverURL.startsWith("background")?e+=`<div class="${i}"><img class="av__gallery-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" style="${n.coverURL}"></div>`:e+=`<div class="${i}"><img loading="lazy" class="av__gallery-img${t.fitImage?" av__gallery-img--fit":""}" src="${Wc(n.coverURL)}"></div>`:n.coverContent?e+=`<div class="${i}"><div class="av__gallery-content">${n.coverContent}</div><div></div></div>`:e+=`<div class="${i}"></div>`}e+='<div class="av__gallery-fields">',n.values.forEach((i,s)=>{var l,o,r;if(t.fields[s].hidden)return;let c="";i.valueType==="checkbox"&&(c=(o=(l=i.value)==null?void 0:l.checkbox)!=null&&o.checked?" av__cell-check":" av__cell-uncheck");const d=nb(i.value);let u=at(t.fields[s].name)||Ti(t.fields[s].type);t.fields[s].desc&&(u+=at(`<div class="ft__on-surface">${t.fields[s].desc}</div>`)),i.valueType==="checkbox"&&!t.displayFieldName&&(i.value.checkbox.content=t.fields[s].name||Ti(t.fields[s].type));const m=`<div class="av__cell${c}${t.displayFieldName?"":" ariaLabel"}" 
data-wrap="${t.fields[s].wrap}" 
aria-label="${u}" 
data-position="5west"
data-id="${i.id}" 
data-field-id="${t.fields[s].id}" 
data-dtype="${i.valueType}" 
${(r=i.value)!=null&&r.isDetached?' data-detached="true"':""} 
style="${i.bgColor?`background-color:${i.bgColor};`:""}
${i.color?`color:${i.color};`:""}">${li(i.value,a,t.showIcon,"gallery")}</div>`;t.displayFieldName?e+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${d}">
    <div class="av__gallery-name">
        ${t.fields[s].icon?be(t.fields[s].icon,void 0,!0):`<svg><use xlink:href="#${Gt(t.fields[s].type)}"></use></svg>`}${Lute.EscapeHTMLStr(t.fields[s].name)}
        ${t.fields[s].desc?`<svg aria-label="${t.fields[s].desc}" data-position="north" class="ariaLabel"><use xlink:href="#iconInfo"></use></svg>`:""}
    </div>
    ${m}
</div>`:e+=`<div class="av__gallery-field" data-empty="${d}">
    <div class="av__gallery-tip">
        ${t.fields[s].icon?be(t.fields[s].icon,void 0,!0):`<svg><use xlink:href="#${Gt(t.fields[s].type)}"></use></svg>`}${window.siyuan.languages.edit} ${Lute.EscapeHTMLStr(t.fields[s].name)}
    </div>
    ${m}
</div>`}),e+=`</div>
    <div class="av__gallery-actions">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.displayEmptyFields}" data-type="av-gallery-edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.more}" data-type="av-gallery-more"><svg><use xlink:href="#iconMore"></use></svg></span>
    </div>
</div>`}),e+=`<div class="av__gallery-add" data-type="av-add-bottom"><svg class="svg"><use xlink:href="#iconAdd"></use></svg><span class="fn__space"></span>${window.siyuan.languages.newRow}</div>`,`<div class="av__gallery${t.cardSize===0?" av__gallery--small":t.cardSize===2?" av__gallery--big":""}">
    ${e}
</div>
<div class="av__gallery-load${t.cardCount>t.cards.length?"":" fn__none"}">
    <button class="b3-button av__button" data-type="av-load-more">
        <svg><use xlink:href="#iconArrowDown"></use></svg>
        <span>${window.siyuan.languages.loadMore}</span>
        <svg data-type="set-page-size" data-size="${t.pageSize}"><use xlink:href="#iconMore"></use></svg>
    </button>
</div>`},V0=t=>{const e=t.blockElement.querySelector('[data-type="av-search"]'),n=e&&document.activeElement===e,a=(e==null?void 0:e.value)||"";let i="";t.data.view.groups.forEach(s=>{var l;s.groupHidden===0&&(i+=`${mE(s,s.cardCount)}
<div data-group-id="${s.id}" data-page-size="${s.pageSize}" data-dtype="${s.groupKey.type}" data-content="${Lute.EscapeHTMLStr(((l=s.groupValue.text)==null?void 0:l.content)||"")}" class="av__body${s.groupFolded?" fn__none":""}">${pE(s)}</div>`)}),t.renderAll?t.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${Jc(t.data,n||!!a,!t.protyle.disabled&&!j(t.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div>
        ${i}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`:t.blockElement.querySelector(".av__header").nextElementSibling.innerHTML=i,ob(t)},ob=t=>{const e=t.data.view;if((e.coverFrom===1||e.coverFrom===3)&&Ct(t.blockElement),typeof t.resetData.oldOffset=="number"&&(t.protyle.contentElement.scrollTop=t.resetData.oldOffset),t.blockElement.getAttribute("data-need-focus")==="true"&&(oe(t.blockElement),t.blockElement.removeAttribute("data-need-focus")),t.blockElement.setAttribute("data-render","true"),t.resetData.alignSelf&&(t.blockElement.style.alignSelf=t.resetData.alignSelf),t.resetData.left&&(t.blockElement.querySelector(".av__kanban").scrollLeft=t.resetData.left),t.resetData.selectItemIds.find(i=>{let s=t.blockElement.querySelector(`.av__body[data-group-id="${i.groupId}"] .av__gallery-item[data-id="${i.fieldId}"]`);s||(s=t.blockElement.querySelector(`.av__gallery-item[data-id="${i.fieldId}"]`)),s&&s.classList.add("av__gallery-item--select")}),t.resetData.editIds.find(i=>{let s=t.blockElement.querySelector(`.av__body[data-group-id="${i.groupId}"] .av__gallery-item[data-id="${i.fieldId}"]`);s||(s=t.blockElement.querySelector(`.av__gallery-item[data-id="${i.fieldId}"]`)),s&&(s.querySelector(".av__gallery-fields").classList.add("av__gallery-fields--edit"),s.querySelector('.protyle-icon[data-type="av-gallery-edit"]').setAttribute("aria-label",window.siyuan.languages.hideEmptyFields))}),Object.keys(t.resetData.pageSizes).forEach(i=>{const s=t.blockElement.querySelector(`.av__body[data-group-id="${i==="unGroup"?"":i}"]`);s&&(s.dataset.pageSize=t.resetData.pageSizes[i])}),getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(!T(i.startContainer,"av__title")){const s=B(i.startContainer);s&&t.blockElement===s&&!t.resetData.isSearching&&oe(t.blockElement)}}if(t.blockElement.querySelector(".layout-tab-bar").scrollLeft=t.blockElement.querySelector(".layout-tab-bar .item--focus").offsetLeft-30,t.cb&&t.cb(t.data),!t.renderAll)return;const n=t.blockElement.querySelector(".av__views"),a=t.blockElement.querySelector('[data-type="av-search"]');a.value=t.resetData.query||"",t.resetData.isSearching&&a.focus(),a.addEventListener("compositionstart",i=>{i.stopPropagation()}),a.addEventListener("keydown",i=>{i.isComposing||ai(i)}),a.addEventListener("input",i=>{i.stopPropagation(),!i.isComposing&&(a.value||document.activeElement===a?n.classList.add("av__views--show"):n.classList.remove("av__views--show"),sr(t.blockElement,t.protyle))}),a.addEventListener("compositionend",()=>{sr(t.blockElement,t.protyle)}),a.addEventListener("blur",i=>{i.isComposing||a.value||(n.classList.remove("av__views--show"),a.style.width="0",a.style.paddingLeft="0",a.style.paddingRight="0")}),Hc({inputElement:a,right:0,width:"1em",height:a.clientHeight,clearCB(){n.classList.remove("av__views--show"),a.style.width="0",a.style.paddingLeft="0",a.style.paddingRight="0",oe(t.blockElement),sr(t.blockElement,t.protyle)}})},rb=t=>W0(void 0,null,function*(){var e,n,a;const i=t.blockElement.querySelector('[data-type="av-search"]'),s=[];t.blockElement.querySelectorAll(".av__gallery-fields--edit").forEach(g=>{s.push({groupId:T(g,"av__body").dataset.groupId||"",fieldId:g.parentElement.getAttribute("data-id")})});const l=[];t.blockElement.querySelectorAll(".av__gallery-item--select").forEach(g=>{const h=g.getAttribute("data-id");h&&l.push({groupId:T(g,"av__body").dataset.groupId||"",fieldId:h})});const o={};t.blockElement.querySelectorAll(".av__body").forEach(g=>{o[g.dataset.groupId||"unGroup"]=g.dataset.pageSize});const r={isSearching:i&&document.activeElement===i,query:(i==null?void 0:i.value)||"",alignSelf:t.blockElement.style.alignSelf,oldOffset:t.protyle.contentElement.scrollTop,editIds:s,selectItemIds:l,pageSizes:o};t.blockElement.firstElementChild.innerHTML===""&&(t.blockElement.style.alignSelf="",t.blockElement.firstElementChild.outerHTML=`<div class="av__gallery">
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
</div>`);const c=(e=t.protyle.options.history)==null?void 0:e.created,d=(n=t.protyle.options.history)==null?void 0:n.snapshot;let u=t.data;if(!u){const g=xp(t.blockElement);u=(yield Ae(c?"/api/av/renderHistoryAttributeView":d?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:t.blockElement.getAttribute("data-av-id"),created:c,snapshot:d,pageSize:g.unGroupPageSize,groupPaging:g.groupPageSize,viewID:t.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW)||"",query:r.query.trim()})).data}if(u.viewType==="table"){t.blockElement.setAttribute("data-av-type",u.viewType),Vt(t.blockElement,t.protyle,t.cb,t.renderAll,u);return}if(u.viewType==="kanban"){t.blockElement.setAttribute("data-av-type",u.viewType),lb({blockElement:t.blockElement,protyle:t.protyle,cb:t.cb,renderAll:t.renderAll,data:u});return}const m=u.view;if(((a=m.groups)==null?void 0:a.length)>0){V0({blockElement:t.blockElement,protyle:t.protyle,cb:t.cb,renderAll:t.renderAll,data:u,resetData:r});return}const f=pE(m);if(t.renderAll)t.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${Jc(u,r.isSearching||!!r.query,!t.protyle.disabled&&!j(t.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div>
        <div class="av__body" data-group-id="" data-page-size="${m.pageSize}">
            ${f}
        </div>
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`;else{const g=t.blockElement.querySelector(".av__body");g.innerHTML=f,g.dataset.pageSize=m.pageSize.toString()}ob({resetData:r,renderAll:t.renderAll,data:u,cb:t.cb,protyle:t.protyle,blockElement:t.blockElement}),m.hideAttrViewName&&t.blockElement.querySelector(".av__gallery").classList.add("av__gallery--top")});var Y0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Jc=(t,e,n)=>{let a="",i,s=!1;return yt(t).forEach(l=>{s||t.view.filters.find(o=>{if(o.value.type===l.type&&l.id===o.column)return s=!0,!0})}),t.views.forEach(l=>{a+=`<div draggable="true" data-position="north" data-av-type="${l.type}" data-id="${l.id}" data-page="${l.pageSize}" data-desc="${Zt(l.desc||"")}" class="ariaLabel item${l.id===t.viewID?" item--focus":""}">
    ${l.icon?be(l.icon,"item__graphic",!0):`<svg class="item__graphic"><use xlink:href="#${np(l.type)}"></use></svg>`}
    <span class="item__text">${he(l.name)}</span>
</div>`,l.id===t.viewID&&(i=l)}),`<div class="av__header">
        <div class="fn__flex av__views${e?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${a}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" aria-label="${window.siyuan.languages.allViews}" data-position="8south" class="ariaLabel block__icon${t.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${t.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" aria-label="${window.siyuan.languages.filter}" data-position="8south" class="ariaLabel block__icon${s?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" aria-label="${window.siyuan.languages.sort}" data-position="8south" class="ariaLabel block__icon${t.view.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <button data-type="av-search-icon" aria-label="${window.siyuan.languages.search}" data-position="8south" class="ariaLabel block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </button>
            <div style="position: relative" class="fn__flex">
                <input style="${e?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" aria-label="${window.siyuan.languages.config}" data-position="8south" class="ariaLabel block__icon">
                <svg><use xlink:href="#iconSettings"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${t.isMirror?` <span data-av-id="${t.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${n}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${i.hideAttrViewName?" fn__none":""}" data-title="${t.name||""}" data-tip="${window.siyuan.languages._kernel[267]}">${t.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>`},gE=(t,e)=>{let n="",a='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',i=-1,s=-1,l=0;const o=e.clientWidth;t.columns.forEach((c,d)=>{c.hidden||(c.pin&&(i=d),l<o-200&&(l+=parseInt(c.width)||200,s=d))}),o===0&&(s=i),i=Math.min(i,s),i>-1&&(a='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',n='<div class="av__colsticky">');let r=!1;return t.columns.forEach((c,d)=>{var u;c.hidden||(a+=`<div class="av__cell av__cell--header" data-col-id="${c.id}"  draggable="true" 
data-icon="${c.icon}" data-dtype="${c.type}" data-wrap="${c.wrap}" data-pin="${c.pin}" 
data-desc="${at(c.desc)}" data-position="north" 
style="width: ${c.width||"200px"};">
    ${c.icon?be(c.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Gt(c.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${he(c.name)}</span>
    ${c.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,i===d&&(a+="</div>"),c.type==="lineNumber"?n+=`<div data-col-id="${c.id}" data-dtype="${c.type}" class="av__calc" style="width: ${c.width||"200px"}">&nbsp;</div>`:n+=`<div class="av__calc${c.calc&&c.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${c.id}" data-dtype="${c.type}" data-operator="${((u=c.calc)==null?void 0:u.operator)||""}" 
style="width: ${c.width||"200px"}">${d0(c)||`<svg><use xlink:href="#iconDown"></use></svg><small>${window.siyuan.languages.calc}</small>`}</div>`,c.calc&&c.calc.operator!==""&&(r=!0),i===d&&(n+="</div>"))}),a+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4south"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,t.rows.forEach((c,d)=>{a+=`<div class="av__row" data-id="${c.id}">`,i>-1?a+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':a+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',c.cells.forEach((u,m)=>{var f,g,h;if(t.columns[m].hidden)return;let b="";u.valueType==="checkbox"&&(b=(g=(f=u.value)==null?void 0:f.checkbox)!=null&&g.checked?" av__cell-check":" av__cell-uncheck"),a+=`<div class="av__cell${b}" data-id="${u.id}" data-col-id="${t.columns[m].id}" 
data-wrap="${t.columns[m].wrap}" 
data-dtype="${t.columns[m].type}" 
${(h=u.value)!=null&&h.isDetached?' data-detached="true"':""} 
style="width: ${t.columns[m].width||"200px"};
${u.valueType==="number"?"text-align: right;":""}
${u.bgColor?`background-color:${u.bgColor};`:""}
${u.color?`color:${u.color};`:""}">${li(u.value,d,t.showIcon)}</div>`,i===m&&(a+="</div>")}),a+="<div></div></div>"}),`${a}<div class="av__row--util${t.rowCount>t.rows.length?" av__readonly--show":""}">
    <div class="av__colsticky">
        <button class="b3-button av__button" data-type="av-add-bottom">
            <svg><use xlink:href="#iconAdd"></use></svg>
            <span>${window.siyuan.languages.newRow}</span>
        </button>
        <span class="fn__space"></span>
        <button class="b3-button av__button${t.rowCount>t.rows.length?"":" fn__none"}" data-type="av-load-more">
            <svg><use xlink:href="#iconArrowDown"></use></svg>
            <span>${window.siyuan.languages.loadMore}</span>
            <svg data-type="set-page-size" data-size="${t.pageSize}"><use xlink:href="#iconMore"></use></svg>
        </button>
    </div>
</div>
<div class="av__row--footer${r?" av__readonly--show":""}">${n}</div>`},mE=(t,e)=>{let n="";return["mSelect","select"].includes(t.groupValue.type)?t.groupValue.mSelect.forEach(a=>{n+=`<span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">${he(a.content)}</span>`}):t.groupValue.type==="checkbox"?n=`<svg style="width:calc(1.625em - 12px);height:calc(1.625em - 12px)"><use xlink:href="#icon${t.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg>`:n=t.name,`<div class="av__group-title">
    <div class="av__group-icon" data-type="av-group-fold" data-id="${t.id}">
        <svg class="${t.groupFolded?"":"av__group-arrow--open"}"><use xlink:href="#iconRight"></use></svg>
    </div>
    <span class="fn__space"></span>
    <span class="av__group-name">${n}</span>
    ${e===0?'<span class="fn__space"></span>':`<span aria-label="${window.siyuan.languages.entryNum}" data-position="north" class="av__group-counter ariaLabel">${e}</span>`}
    <span class="av__group-icon av__group-icon--hover ariaLabel" data-type="av-add-top" data-position="north" aria-label="${window.siyuan.languages.newRow}"><svg><use xlink:href="#iconAdd"></use></svg></span>
</div>`},z0=t=>{const e=t.blockElement.querySelector('[data-type="av-search"]'),n=e&&document.activeElement===e,a=(e==null?void 0:e.value)||"";let i="";t.data.view.groups.forEach(s=>{var l;s.groupHidden===0&&(i+=`${mE(s,s.rowCount)}
<div data-group-id="${s.id}" data-page-size="${s.pageSize}" data-dtype="${s.groupKey.type}" data-content="${Lute.EscapeHTMLStr(((l=s.groupValue.text)==null?void 0:l.content)||"")}" style="float: left" class="av__body${s.groupFolded?" fn__none":""}">${gE(s,t.blockElement)}</div>`)}),t.renderAll?t.blockElement.firstElementChild.outerHTML=`<div class="av__container">
    ${Jc(t.data,n||!!a,!t.protyle.disabled&&!j(t.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__scroll">
        ${i}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`:t.blockElement.firstElementChild.querySelector(".av__scroll").innerHTML=i,hE(t)},hE=t=>{var e;t.blockElement.getAttribute("data-need-focus")==="true"&&(oe(t.blockElement),t.blockElement.removeAttribute("data-need-focus")),t.blockElement.setAttribute("data-render","true"),t.blockElement.querySelector(".av__scroll").scrollLeft=t.resetData.left,t.blockElement.style.alignSelf=t.resetData.alignSelf;const n=t.protyle.contentElement.getBoundingClientRect();if(t.resetData.headerTransform){const s=t.blockElement.querySelector(`.av__body[data-group-id="${t.resetData.headerTransform.groupId}"] .av__row--header`);s&&(s.style.transform=t.resetData.headerTransform.transform)}else setTimeout(()=>{ks(t.blockElement,n,"top")},p.TIMEOUT_LOAD);if(t.resetData.footerTransform){const s=t.blockElement.querySelector(`.av__body[data-group-id="${t.resetData.footerTransform.groupId}"] .av__row--footer`);s&&(s.style.transform=t.resetData.footerTransform.transform)}else setTimeout(()=>{ks(t.blockElement,n,"bottom")},p.TIMEOUT_LOAD);if(t.resetData.selectCellId){let s=t.blockElement.querySelector(`.av__body[data-group-id="${t.resetData.selectCellId.groupId}"] .av__row[data-id="${t.resetData.selectCellId.rowId}"] .av__cell[data-col-id="${t.resetData.selectCellId.colId}"]`);s||(s=t.blockElement.querySelector(`.av__row[data-id="${t.resetData.selectCellId.rowId}"] .av__cell[data-col-id="${t.resetData.selectCellId.colId}"]`)),s&&(s.classList.add("av__cell--select"),Xi(t.blockElement,s));const l=document.querySelector(".av__mask"),o=document.querySelector(".av__panel");if(l)(e=l.querySelector("textarea, input"))==null||e.focus();else if(!o&&!t.resetData.isSearching&&getSelection().rangeCount>0){const r=getSelection().getRangeAt(0),c=B(r.startContainer);c&&t.blockElement===c&&oe(t.blockElement)}else o&&!s&&o.remove()}if(t.resetData.selectRowIds.forEach((s,l)=>{let o=t.blockElement.querySelector(`.av__body[data-group-id="${s.groupId}"] .av__row[data-id="${s.rowId}"]`);o||(o=t.blockElement.querySelector(`.av__row[data-id="${s.rowId}"]`)),o&&(o.classList.add("av__row--select"),o.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),l===t.resetData.selectRowIds.length-1&&o&&Es(o)}),Object.keys(t.resetData.pageSizes).forEach(s=>{const l=t.blockElement.querySelector(`.av__body[data-group-id="${s==="unGroup"?"":s}"]`);l&&(l.dataset.pageSize=t.resetData.pageSizes[s])}),t.resetData.dragFillId){let s=t.blockElement.querySelector(`.av__body[data-group-id="${t.resetData.dragFillId.groupId}"] .av__row[data-id="${t.resetData.dragFillId.rowId}"] .av__cell[data-col-id="${t.resetData.dragFillId.colId}"]`);s||(s=t.blockElement.querySelector(`.av__row[data-id="${t.resetData.dragFillId.rowId}"] .av__cell[data-col-id="${t.resetData.dragFillId.colId}"]`)),pa(s)}if(t.resetData.activeIds.forEach(s=>{let l=t.blockElement.querySelector(`.av__body[data-group-id="${s.groupId}"] .av__row[data-id="${s.rowId}"] .av__cell[data-col-id="${s.colId}"]`);l||(l=t.blockElement.querySelector(`.av__row[data-id="${s.rowId}"] .av__cell[data-col-id="${s.colId}"]`)),l==null||l.classList.add("av__cell--active")}),getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(!T(s.startContainer,"av__title")){const l=B(s.startContainer);l&&t.blockElement===l&&!t.resetData.isSearching&&oe(t.blockElement)}}if(t.blockElement.querySelector(".layout-tab-bar").scrollLeft=t.blockElement.querySelector(".layout-tab-bar .item--focus").offsetLeft-30,t.cb&&t.cb(t.data),!t.renderAll)return;const a=t.blockElement.querySelector(".av__views"),i=t.blockElement.querySelector('[data-type="av-search"]');i.value=t.resetData.query||"",t.resetData.isSearching&&i.focus(),i.addEventListener("compositionstart",s=>{s.stopPropagation()}),i.addEventListener("keydown",s=>{s.isComposing||ai(s)}),i.addEventListener("input",s=>{s.stopPropagation(),!s.isComposing&&(i.value||document.activeElement===i?a.classList.add("av__views--show"):a.classList.remove("av__views--show"),sr(t.blockElement,t.protyle))}),i.addEventListener("compositionend",()=>{sr(t.blockElement,t.protyle)}),i.addEventListener("blur",s=>{s.isComposing||i.value||(a.classList.remove("av__views--show"),i.style.width="0",i.style.paddingLeft="0",i.style.paddingRight="0")}),Hc({inputElement:i,right:0,width:"1em",height:i.clientHeight,clearCB(){a.classList.remove("av__views--show"),i.style.width="0",i.style.paddingLeft="0",i.style.paddingRight="0",oe(t.blockElement),sr(t.blockElement,t.protyle)}})},Vt=(t,e,n,a=!0,i)=>Y0(void 0,null,function*(){var s,l,o,r;let c=[];if(t.getAttribute("data-type")==="NodeAttributeView"?c=[t]:c=Array.from(t.querySelectorAll('[data-type="NodeAttributeView"]')),c.length!==0)for(let d=0;d<c.length;d++){const u=c[d];if(u.removeAttribute("data-rendering"),u.getAttribute("data-render")==="true"||T(u,"av__gallery-content"))continue;if((Y()||$n()||ht()||bt())&&u.classList.add("av--touch"),u.getAttribute("data-av-type")==="gallery"){yield rb({blockElement:u,protyle:e,cb:n,renderAll:a});continue}if(u.getAttribute("data-av-type")==="kanban"){yield lb({blockElement:u,protyle:e,cb:n,renderAll:a});continue}let m;const f=u.querySelector(".av__cell--select");f&&(m={groupId:T(f,"av__body").dataset.groupId||"",rowId:T(f,"av__row").dataset.id,colId:f.getAttribute("data-col-id")});const g=[];u.querySelectorAll(".av__row--select").forEach(I=>{const q=I.getAttribute("data-id");q&&g.push({groupId:T(I,"av__body").dataset.groupId||"",rowId:q})});let h;const b=u.querySelector(".av__drag-fill");b&&(h={groupId:T(b,"av__body").dataset.groupId||"",rowId:T(b,"av__row").dataset.id,colId:b.parentElement.getAttribute("data-col-id")});const y=[];u.querySelectorAll(".av__cell--active").forEach(I=>{y.push({groupId:T(I,"av__body").dataset.groupId||"",rowId:T(I,"av__row").dataset.id,colId:I.getAttribute("data-col-id")})});const w=u.querySelector('[data-type="av-search"]'),E={};u.querySelectorAll(".av__body").forEach(I=>{E[I.dataset.groupId||"unGroup"]=I.dataset.pageSize});const C=u.querySelector('.av__row--header[style^="transform"]'),$=u.querySelector('.av__row--footer[style^="transform"]'),M={selectCellId:m,alignSelf:u.style.alignSelf,left:((s=u.querySelector(".av__scroll"))==null?void 0:s.scrollLeft)||0,headerTransform:C?{groupId:C.parentElement.getAttribute("data-group-id"),transform:C.style.transform}:null,footerTransform:$?{groupId:$.parentElement.getAttribute("data-group-id"),transform:$.style.transform}:null,isSearching:w&&document.activeElement===w,selectRowIds:g,dragFillId:h,activeIds:y,query:(w==null?void 0:w.value)||"",pageSizes:E};if(u.firstElementChild.innerHTML===""){u.style.alignSelf="";let I="";[1,2,3].forEach(()=>{I+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),u.firstElementChild.innerHTML=I}const k=(l=e.options.history)==null?void 0:l.created,_=(o=e.options.history)==null?void 0:o.snapshot,v=xp(u);let S;if(i?S=i:S=(yield Ae(k?"/api/av/renderHistoryAttributeView":_?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:u.getAttribute("data-av-id"),created:k,snapshot:_,pageSize:v.unGroupPageSize,groupPaging:v.groupPageSize,viewID:u.getAttribute(p.CUSTOM_SY_AV_VIEW)||"",query:M.query.trim(),blockID:u.getAttribute("data-node-id")})).data,S.viewType==="gallery"){u.setAttribute("data-av-type",S.viewType),yield rb({blockElement:u,protyle:e,cb:n,renderAll:a,data:S});continue}if(S.viewType==="kanban"){u.setAttribute("data-av-type",S.viewType),yield lb({blockElement:u,protyle:e,cb:n,renderAll:a,data:S});continue}const L=S.view;if(((r=L.groups)==null?void 0:r.length)>0){z0({blockElement:u,protyle:e,cb:n,renderAll:a,data:S,resetData:M});continue}const D=`<div class="av__body" data-group-id="" data-page-size="${L.pageSize}" style="float: left">
    ${gE(L,u)}
</div>`;a?u.firstElementChild.outerHTML=`<div class="av__container">
    ${Jc(S,M.isSearching||!!M.query,!e.disabled&&!j(u,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__scroll">
        ${D}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`:u.firstElementChild.querySelector(".av__scroll").innerHTML=D,hE({renderAll:a,data:S,cb:n,protyle:e,blockElement:u,resetData:M}),u.style.margin=""}});let bE;const sr=(t,e)=>{clearTimeout(bE),bE=window.setTimeout(()=>{t.removeAttribute("data-render"),Vt(t,e,void 0,!1)},p.TIMEOUT_INPUT)},yE={},qa=(t,e,n)=>{const a=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-av-id="${e}"]`));return n?a.filter(i=>_E(i)===n):a},_E=t=>{var e;return t.getAttribute(p.CUSTOM_SY_AV_VIEW)||((e=t.querySelector(".layout-tab-bar .item--focus"))==null?void 0:e.getAttribute("data-id"))||null},G0=(t,e)=>{if(e.action==="setAttrViewName"){qa(t,e.id).forEach(n=>{const a=n.querySelector(".av__title");a&&(a.textContent=e.data,a.dataset.title=e.data)});return}if(e.action==="setAttrViewColWidth"){qa(t,e.avID,e.viewID).forEach(n=>{const a=n.querySelector(`.av__cell[data-col-id="${e.id}"]`);!a||a.style.width===e.data||n.querySelectorAll(".av__row").forEach(i=>{i.querySelector(`[data-col-id="${e.id}"]`).style.width=e.data})});return}if(e.action==="setAttrViewCardSize"){qa(t,e.avID,e.viewID).forEach(n=>{n.getAttribute("data-av-type")==="kanban"?n.querySelectorAll(".av__kanban-group").forEach(a=>{a.classList.remove("av__kanban-group--small","av__kanban-group--big"),e.data===0?a.classList.add("av__kanban-group--small"):e.data===2&&a.classList.add("av__kanban-group--big")}):n.querySelectorAll(".av__gallery").forEach(a=>{a.classList.remove("av__gallery--small","av__gallery--big"),e.data===0?a.classList.add("av__gallery--small"):e.data===2&&a.classList.add("av__gallery--big")})});return}if(e.action==="setAttrViewCardAspectRatio"){qa(t,e.avID,e.viewID).forEach(n=>{n.querySelectorAll(".av__gallery-cover").forEach(a=>{a.className="av__gallery-cover av__gallery-cover--"+e.data})});return}if(e.action==="hideAttrViewName"){qa(t,e.avID,e.viewID).forEach(n=>{const a=n.querySelector(".av__title");if(a&&(e.data?a.classList.add("fn__none"):a.classList.remove("fn__none"),n.getAttribute("data-av-type")==="gallery"&&!n.querySelector(".av__group-title"))){const i=n.querySelector(".av__gallery");e.data?i.classList.add("av__gallery--top"):i.classList.remove("av__gallery--top")}});return}if(e.action==="setAttrViewWrapField"){qa(t,e.avID,e.viewID).forEach(n=>{n.querySelectorAll(".av__cell").forEach(a=>{a.setAttribute("data-wrap",e.data.toString())})});return}if(e.action==="setAttrViewFillColBackgroundColor"){qa(t,e.avID,e.viewID).forEach(n=>{const a=n.querySelector(".av__group-title .b3-chip"),i=n.querySelector(".av__kanban");e.data&&a?i.classList.add("av__kanban--bg"):i.classList.remove("av__kanban--bg"),n.querySelectorAll(".av__kanban-group").forEach(s=>{if(e.data&&a){const l=s.querySelector(".av__group-title .b3-chip");l?s.setAttribute("style",`--b3-av-kanban-background:var(--b3-font-background${l.style.backgroundColor.slice(-2,-1)})`):s.setAttribute("style","--b3-av-kanban-background: var(--b3-border-color)")}else s.removeAttribute("style")})});return}if(e.action==="setAttrViewFitImage"){qa(t,e.avID,e.viewID).forEach(n=>{const a=n.querySelector(".av__gallery-img");e.data?a.classList.add("av__gallery-img--fit"):a.classList.remove("av__gallery-img--fit")});return}if(e.action==="setAttrViewShowIcon"){qa(t,e.avID,e.viewID).forEach(n=>{n.querySelectorAll('.av__cell[data-dtype="block"] .b3-menu__avemoji, .av__cell[data-dtype="relation"] .b3-menu__avemoji').forEach(a=>{e.data?a.classList.remove("fn__none"):a.classList.add("fn__none")})});return}if(e.action==="setAttrViewColWrap"){qa(t,e.avID,e.viewID).forEach(n=>{n.querySelectorAll(`.av__cell[data-col-id="${e.id}"],.av__cell[data-field-id="${e.id}"]`).forEach(a=>{a.setAttribute("data-wrap",e.data.toString())})});return}if(e.action==="foldAttrViewGroup"){qa(t,e.avID).forEach(n=>{const a=n.querySelector(`[data-type="av-group-fold"][data-id="${e.id}"]`);a&&(e.data?(a.firstElementChild.classList.remove("av__group-arrow--open"),a.parentElement.nextElementSibling.classList.add("fn__none")):(a.firstElementChild.classList.add("av__group-arrow--open"),a.parentElement.nextElementSibling.classList.remove("fn__none")),a.removeAttribute("data-folding"))});return}clearTimeout(yE[t.id]),yE[t.id]=window.setTimeout(()=>{const n=e.action==="setAttrViewName"?e.id:e.avID,a=document.querySelector(`.b3-dialog--open[data-key="${p.DIALOG_ATTR}"] .custom-attr > [data-av-id="${n}"]`);a&&(a.removeAttribute("data-rendering"),jh(a.parentElement,a.dataset.nodeId,t)),qa(t,n).forEach(i=>{var s;if(i.removeAttribute("data-render"),e.action==="sortAttrViewRow")an(["cell"],i);else if(e.action==="sortAttrViewCol")i.querySelectorAll(".av__cell--active").forEach(o=>{var r;o.classList.remove("av__cell--active"),(r=o.querySelector(".av__drag-fill"))==null||r.remove()}),pa(i.querySelector(".av__cell--select"));else if(e.action==="setAttrViewBlockView"){const o=i.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${e.id}"]`);o&&i.querySelectorAll(".av__body").forEach(r=>{r.dataset.pageSize=o.dataset.page})}else if(e.action==="addAttrViewView")i.querySelectorAll(".av__body").forEach(o=>{o.dataset.pageSize="50"});else if(e.action==="removeAttrViewView")i.querySelectorAll(".av__body").forEach(o=>{var r;o.dataset.pageSize=(r=i.querySelector(`.av__views > .layout-tab-bar .item[data-id="${_E(i)}"]`))==null?void 0:r.getAttribute("data-page")});else if(e.action==="sortAttrViewView"&&e.data==="unRefresh"){const o=i.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${e.id}"]`);if(o&&!e.previousID&&!o.previousElementSibling)return;if(o&&e.previousID&&((s=o.previousElementSibling)==null?void 0:s.getAttribute("data-id"))===e.previousID)return}const l=i.querySelector('[data-type="ghost"]');Vt(i,t,()=>{var o,r;if(e.action==="insertAttrViewBlock"&&((o=e.context)==null?void 0:o.ignoreTip)!=="true")if((r=e.context)!=null&&r.message)de(e.context.message);else{const c=e.groupID?`[data-group-id="${e.groupID}"]`:"";if(["gallery","kanban"].includes(i.getAttribute("data-av-type"))&&e.srcs.forEach(d=>{var u,m;const f=(u=i.querySelector(`.av__body${c} .av__gallery-item[data-id="${d.itemID}"]`))==null?void 0:u.querySelector(".av__gallery-fields");f&&((m=f.querySelector('[data-dtype="block"]'))==null?void 0:m.parentElement.getAttribute("data-empty"))==="true"&&f.classList.add("av__gallery-fields--edit")}),e.srcs.length===1){let d=i.querySelector(`.av__body${c} [data-id="${e.srcs[0].itemID}"] .av__cell[data-dtype="block"]`);if(!d){const u=i.querySelectorAll(`.av__body [data-id="${e.srcs[0].itemID}"] .av__cell[data-dtype="block"]`);u.length===1&&(d=u[0])}d&&d.getAttribute("data-detached")==="true"&&d.querySelector(".av__celltext").textContent===""&&d.getBoundingClientRect().height!==0&&l&&Jn(t,[d],"block")}e.srcs.find(d=>{if(!i.querySelector(`.av__body [data-id="${d.itemID}"]`)&&!i.querySelector(`.av__body [data-dtype="block"] .av__celltext--ref[data-id="${d.id}"]`))return de(window.siyuan.languages.insertRowTip),!0})}else e.action==="addAttrViewView"&&i.getAttribute("data-node-id")===e.blockID&&Cn({protyle:t,blockElement:i,type:"config"});i.removeAttribute("data-loading")})})},["insertAttrViewBlock"].includes(e.action)?2:100)},wE=(t,e)=>{t.block.showAll=!0;let n="";e.forEach((a,i)=>{n+=kE(a.blockPaths,!1,i)+EE(a.dom,a.expand)}),t.wysiwyg.element.innerHTML=n,cb(t.wysiwyg.element),Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t),We(t,t.wysiwyg.element),ad(t),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&Sa(t)},vE=(t,e)=>{e.firstElementChild.classList.contains("li")?t?e.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):e.firstElementChild.setAttribute("fold","1"):e.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(e.children).forEach((n,a)=>{(t&&a>2||!t&&a>1)&&((t&&a===3||!t&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg style="transform: rotate(90deg);"><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},EE=(t,e)=>{const n=document.createElement("template");return n.innerHTML=t,vE(e,n.content),n.innerHTML},j0=(t,e)=>{A("/api/filetree/getDoc",{id:e.getAttribute("data-id"),size:p.SIZE_GET_MAX},n=>{e.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),e.classList.add("protyle-breadcrumb__item--active");let a=e.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const i=a;a=a.nextElementSibling,i.remove()}e.parentElement.insertAdjacentHTML("afterend",EE(n.data.content,!0)),Ct(e.parentElement.parentElement),Vt(e.parentElement.parentElement,t),We(t,e.parentElement.parentElement),n.data.isSyncing?RE(t):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?Sa(t):e.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&e.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},K0=t=>{let e=t.nextElementSibling;for(;e&&!e.classList.contains("protyle-breadcrumb__bar");)e.classList.remove("fn__none"),e=e.nextElementSibling;t.remove()},kE=(t,e,n)=>{if(1>t.length)return`<div contenteditable="false" style="border-top: ${n===0?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let a="";return t.forEach((i,s)=>{s===0&&!e||(a+=`<span class="protyle-breadcrumb__item${s===t.length-1?" protyle-breadcrumb__item--active":""}" data-id="${i.id}">
    <svg class="popover__block" data-id="${i.id}"><use xlink:href="#${la(i.type,i.subType)}"></use></svg>
    ${i.name?`<span class="protyle-breadcrumb__text" title="${i.name}">${i.name}</span>`:""}
</span>`,s!==t.length-1&&(a+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${a}</div>`},cb=t=>{t.querySelectorAll(".protyle-breadcrumb__bar").forEach(e=>{e.classList.remove("protyle-breadcrumb__bar--nowrap");const n=Array.from(e.querySelectorAll(".protyle-breadcrumb__text"));if(n.length===0)return;let a=!1;const i=j(e,"data-type","NodeBlockQueryEmbed");for(;e.scrollHeight>30&&!a&&n.length>1;)n.find((s,l)=>{if(l>(i?0:-1)){if(!s.classList.contains("protyle-breadcrumb__text--ellipsis"))return s.classList.add("protyle-breadcrumb__text--ellipsis"),!0;l===n.length-1&&s.classList.contains("protyle-breadcrumb__text--ellipsis")&&(a=!0)}});e.classList.add("protyle-breadcrumb__bar--nowrap"),e.lastElementChild&&(e.scrollLeft=e.lastElementChild.offsetLeft-e.clientWidth+14)})},We=(t,e,n)=>{let a=[];e.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;if(i.setAttribute("data-render","true"),vc(i),i.childElementCount>3){i.style.height=i.clientHeight-4+"px";for(let o=1;o<i.children.length-1;o++)i.children[o].classList.contains("protyle-cursor")||(i.children[o].remove(),o--)}const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let l=i.getAttribute("breadcrumb");if(l?l=l==="true":l=window.siyuan.config.editor.embedBlockBreadcrumb,s.startsWith("//!js"))try{const o=new Function("fetchSyncPost","item","protyle","top",s)(Ae,i,t,n);if(o instanceof Promise)o.then(r=>{if(Array.isArray(r))A("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:r,headingMode:["0","1","2"].includes(i.getAttribute("custom-heading-mode"))?parseInt(i.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,breadcrumb:l},c=>{Xc(c.data.blocks||[],t,i,n)});else return}).catch(r=>{Xc([],t,i,n,r)});else if(Array.isArray(o))A("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:o,headingMode:["0","1","2"].includes(i.getAttribute("custom-heading-mode"))?parseInt(i.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,breadcrumb:l},r=>{Xc(r.data.blocks||[],t,i,n)});else return}catch(o){Xc([],t,i,n,o)}else A("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:["0","1","2"].includes(i.getAttribute("custom-heading-mode"))?parseInt(i.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,excludeIDs:[i.getAttribute("data-node-id"),t.block.rootID],breadcrumb:l},o=>{Xc(o.data.blocks,t,i,n)})})},Xc=(t,e,n,a,i)=>{const s=n.querySelector(".fn__rotate");s&&s.classList.remove("fn__rotate");let l="";t.forEach(c=>{let d="";c.blockPaths.length!==0&&(d=kE(c.blockPaths,!0)),l+=`<div class="protyle-wysiwyg__embed" data-id="${c.block.id}">${d}${c.block.content}</div>`}),t.length>0?(n.firstElementChild.insertAdjacentHTML("afterend",l),cb(n.querySelector(".protyle-wysiwyg__embed"))):n.firstElementChild.insertAdjacentHTML("afterend",`<div class="protyle-wysiwyg__embed ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${i||window.siyuan.languages.refExpired}</div>`),Ct(n),rt(n),Vt(n,e),a&&(e.contentElement.scrollTop=a);let o=0,r=n;for(;o<4&&r;)r=j(r.parentElement,"data-type","NodeBlockQueryEmbed"),o++;o<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{We(e,c)}),n.style.height=""};var SE=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),Z0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())}),J0=(t,e,n)=>(e=t[SE("asyncIterator")])?e.call(t):(t=t[SE("iterator")](),e={},n=(a,i)=>(i=t[a])&&(e[a]=s=>new Promise((l,o,r)=>(s=i.call(t,s),r=s.done,Promise.resolve(s.value).then(c=>l({value:c,done:r}),o)))),n("next"),n("return"),e);const LE=(t,e)=>{const n=Et(t),a=[];if(n!==t&&(t.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),e.wysiwyg.element.childElementCount===0)if(e.block.rootID===e.block.id){const i=Lute.NewNodeID(),s=jn(!1,!1,i);a.push({action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}),e.wysiwyg.element.innerHTML=s.outerHTML}else dn({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:e.block.id});a.length>0&&V(e,a,[])},AE=()=>{if(window.siyuan.transactions.length===0)return;const t=window.siyuan.transactions[0].protyle,e=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),A("/api/transactions",{session:t.id,app:p.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},a=>{window.siyuan.transactions.length===0?Pn([],t.block.rootID,!0):AE();let i;if(getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){IE(s,t);return}if(s.action==="update"){t.options.backlinkData&&(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(l=>{G(l)||i&&(l===i.startContainer||l.contains(i.startContainer))||(l.outerHTML=s.data.replace("<wbr>",""))}),Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t),We(t,t.wysiwyg.element)),db(t,s);return}if(s.action==="delete"||s.action==="append"){t.options.backlinkData&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(l=>{!G(l)&&!l.contains(i.startContainer)&&l.remove()}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${s.id}"]`)&&(l.removeAttribute("data-render"),We(t,l))}),ce(["gutter"],t);return}if(s.action==="move"){if(t.options.backlinkData){const l=[];Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(!G(r)){const c=Le(r,"data-node-id",null);c&&!c.contains(i.startContainer)&&l.push(r)}});let o=!1;s.previousID&&l.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{!G(r)&&!r.nextElementSibling.contains(i.startContainer)&&(r.after(sa(l[0].cloneNode(!0))),o=!0)}):l.length>0&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{var c;!G(r)&&!Ut(r).contains(i.startContainer)&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(sa(l[0].cloneNode(!0))):r.prepend(sa(l[0].cloneNode(!0))),o=!0)}),l.forEach(r=>{o?r.remove():!o&&r.parentElement&&LE(r,t)})}t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${s.id}"],[data-node-id="${s.parentID}"],[data-node-id="${s.previousID}"]`)&&(l.removeAttribute("data-render"),We(t,l))});return}if(s.action==="insert"){if(t.options.backlinkData){const l=[];s.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(o=>{var r;((r=o.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==s.id&&!o.contains(i.startContainer)&&!j(o,"data-node-id",s.id)&&!G(o)&&(o.insertAdjacentHTML("afterend",s.data),l.push(o.nextElementSibling))}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(o=>{!G(o)&&!o.contains(i.startContainer)&&(o.firstElementChild&&o.firstElementChild.classList.contains("protyle-action")&&o.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(o.firstElementChild.insertAdjacentHTML("afterend",s.data),l.push(o.firstElementChild.nextElementSibling)):o.firstElementChild&&o.firstElementChild.getAttribute("data-node-id")!==s.id&&(o.insertAdjacentHTML("afterbegin",s.data),l.push(o.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(o=>{o.lastElementChild.getAttribute("spin")==="1"&&o.lastElementChild.remove()}),l.forEach(o=>{Ct(o),rt(o),Vt(o,t),We(t,o);const r=o.querySelector("wbr");r&&r.remove()})}t.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(l=>{l.remove()})}}),t.wysiwyg.element.childElementCount===0&&!t.block.showAll){const s=Lute.NewNodeID(),l=jn(!1,!0,s);t.wysiwyg.element.insertAdjacentElement("afterbegin",l),V(t,[{action:"insert",data:l.outerHTML,id:s,parentID:t.block.parentID}]),we(l,i)}})},db=(t,e)=>{let n=!1;const a=(s,l)=>{const o=document.createElement("template");o.innerHTML=t.lute.SpinBlockDOM(l),o.content.querySelectorAll('[contenteditable="true"]').forEach(c=>{c.setAttribute("contenteditable","false")}),o.content.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("protyle-wysiwyg--select")});const r=o.content.querySelector("wbr");r&&r.remove(),s.outerHTML=o.innerHTML,n=!0},i=document.createElement("template");i.innerHTML=e.data,t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{const l=s.querySelectorAll(`[data-node-id="${e.id}"]`);l.length>0?l.forEach(o=>{a(o,e.data)}):s.querySelectorAll(".protyle-wysiwyg__embed").forEach(o=>{const r=i.content.querySelector(`[data-node-id="${o.getAttribute("data-id")}"]`);r&&!G(r)&&a(o.querySelector("[data-node-id]"),r.outerHTML)})}),n&&(Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t))},xE=(t,e,n,a)=>{a&&oy(t[0]),t.forEach(i=>{if(a)i.remove();else{const s=Et(i);s&&s.remove()}}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${e}"]`)&&(i.removeAttribute("data-render"),We(n,i))})},CE=(t,e,n,a)=>{t.forEach(s=>{s.getAttribute("data-subtype")==="echarts"?s.outerHTML=e.lute.SpinBlockDOM(n.data):s.outerHTML=n.data}),Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(s=>{if(!G(s))return t[0]=s,!0});const i=t[0].querySelector("wbr");if(a){const s=ke(t[0]);i?we(t[0],s):oe(t[0])}else i&&i.remove();Ct(t.length===1?t[0]:e.wysiwyg.element),rt(t.length===1?t[0]:e.wysiwyg.element),Vt(t.length===1?t[0]:e.wysiwyg.element,e),We(e,t.length===1?t[0]:e.wysiwyg.element),db(e,n)},Tp=(t,e,n)=>{var a,i,s,l;const o=[];if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(r=>{G(r)||o.push(r)}),e.action==="setAttrs"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(r=>{JSON.parse(e.data).fold==="1"?r.setAttribute("fold","1"):r.removeAttribute("fold")});return}if(e.action==="unfoldHeading"){const r=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(c=>{if(c.removeAttribute("fold"),n)return;const d=G(c);if(d){d.removeAttribute("data-render"),We(t,d);return}e.retData&&(TE(e.retData,t),c.insertAdjacentHTML("afterend",e.retData)),e.data==="remove"&&c.remove()}),e.retData&&(t.disabled&&Sa(t),Ct(t.wysiwyg.element),rt(t.wysiwyg.element),Vt(t.wysiwyg.element,t),We(t,t.wysiwyg.element),t.contentElement.scrollTop=r,t.scroll.lastScrollTop=r);return}if(e.action==="foldHeading"){if(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(r=>{r.setAttribute("fold","1"),e.retData||rv(r)}),n)return;e.retData&&(e.retData.forEach(r=>{let c;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(d=>{if(c=G(d),c)return!0;d.remove()}),c&&(c.removeAttribute("data-render"),We(t,c))}),t.wysiwyg.element.childElementCount===0&&dn({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id}));return}if(e.action==="delete"){o.length>0||!n?xE(o,e.id,t,n):n&&dn({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(r=>{G(r)||o.push(r)}),xE(o,e.id,t,n)}});return}if(e.action==="update"){if(o.length===0){const r=t.wysiwyg.element.querySelector("[data-node-id]");if(r){const c=r.getAttribute("data-node-id"),d=document.createElement("template");d.innerHTML=e.data;const u=d.content.querySelector(`[data-node-id="${c}"]`);if(u){o.push(r),e.data=u.outerHTML,e.id=c;for(let m=1;m<t.wysiwyg.element.childElementCount;m++)t.wysiwyg.element.childNodes[m].remove(),m--}}}o.length>0?CE(o,t,e,n):n?dn({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(r=>{G(r)||o.push(r)}),CE(o,t,e,n)}}):db(t,e);return}if(e.action==="updateAttrs"){const r=e.data,c={};let d="",u="",m="",f="",g="";Object.keys(r.new).forEach(b=>{c[b]=r.new[b];const y=Lute.EscapeHTMLStr(r.new[b]);b==="bookmark"?d=`<div class="protyle-attr--bookmark">${y}</div>`:b==="name"?u=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${y}</div>`:b==="alias"?m=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${y}</div>`:b==="memo"?f=`<div class="protyle-attr--memo ariaLabel" aria-label="${y}" data-position="north"><svg><use xlink:href="#iconM"></use></svg></div>`:b==="custom-avs"&&r.new["av-names"]&&(g=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${r.new["av-names"]}</div>`)});let h=d+u+m+f+g;if(t.block.rootID===e.id){if(t.title){r.new["custom-avs"]&&!r.new["av-names"]&&(h+=((a=t.title.element.querySelector(".protyle-attr--av"))==null?void 0:a.outerHTML)||"");const b=t.title.element.querySelector(".protyle-attr--refcount");b&&(h+=b.outerHTML),r.new[p.CUSTOM_RIFF_DECKS]&&r.new[p.CUSTOM_RIFF_DECKS]!==r.old[p.CUSTOM_RIFF_DECKS]?(t.title.element.style.animation="addCard 450ms linear",t.title.element.setAttribute(p.CUSTOM_RIFF_DECKS,r.new[p.CUSTOM_RIFF_DECKS]),setTimeout(()=>{t.title.element.style.animation=""},450)):r.new[p.CUSTOM_RIFF_DECKS]||t.title.element.removeAttribute(p.CUSTOM_RIFF_DECKS),t.title.element.querySelector(".protyle-attr").innerHTML=h}if(t.wysiwyg.renderCustom(c),r.new[p.CUSTOM_SY_FULLWIDTH]!==r.old[p.CUSTOM_SY_FULLWIDTH]&&mn(t),r.new[p.CUSTOM_SY_READONLY]!==r.old[p.CUSTOM_SY_READONLY]){let b=r.new[p.CUSTOM_SY_READONLY];b||(b=window.siyuan.config.editor.readOnly?"true":"false"),b==="true"?Sa(t):nd(t)}(r.new.icon!==r.old.icon||r.new["title-img"]!==r.old["title-img"]||r.new.tags!==r.old.tags&&t.background)&&(t.background.ial.icon=r.new.icon,t.background.ial.tags=r.new.tags,t.background.ial["title-img"]=r.new["title-img"],t.background.render(t.background.ial,t.block.rootID),(i=t.model)==null||i.parent.setDocIcon(r.new.icon));return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(b=>{var y;if(b.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(r.old).forEach($=>{b.removeAttribute($)}),r.new.style&&r.new[p.CUSTOM_RIFF_DECKS]&&r.new[p.CUSTOM_RIFF_DECKS]!==r.old[p.CUSTOM_RIFF_DECKS]&&(r.new.style+=";animation:addCard 450ms linear"),Object.keys(r.new).forEach($=>{$!=="id"&&(b.setAttribute($,r.new[$]),$===p.CUSTOM_RIFF_DECKS&&r.new[p.CUSTOM_RIFF_DECKS]!==r.old[p.CUSTOM_RIFF_DECKS]&&(b.style.animation="addCard 450ms linear",setTimeout(()=>{b.parentElement?b.style.animation="":t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(M=>{M.style.animation=""})},450)))}),r["data-av-type"]&&b.setAttribute("data-av-type",r["data-av-type"]);const w=b.querySelectorAll(".protyle-attr"),E=w[w.length-1];r.new["custom-avs"]&&!r.new["av-names"]&&(h+=((y=E.querySelector(".protyle-attr--av"))==null?void 0:y.outerHTML)||"");const C=E.querySelector(".protyle-attr--refcount");C&&(h+=C.outerHTML),E.innerHTML=h+p.ZWSP});return}if(e.action==="move"){if(((s=e.context)==null?void 0:s.ignoreProcess)==="true")return;o.length===0&&Oe().editor.forEach(d=>{const u=d.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.id}"]`);u&&o.push(u.cloneNode(!0))}),o.length===0&&window.siyuan.blockPanels.forEach(d=>{const u=d.element.querySelector(`[data-node-id="${e.id}"]`);u&&o.push(u.cloneNode(!0))});let r;if(n&&getSelection().rangeCount>0){r=getSelection().getRangeAt(0);const d=B(r.startContainer);d&&(fe(d)?r.insertNode(document.createElement("wbr")):fe(o[0]).insertAdjacentHTML("afterbegin","<wbr>"))}let c=!1;if(e.previousID&&o.length>0){const d=t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`);if(d.length===0&&t.options.backlinkData&&n&&getSelection().rangeCount>0){const u=Le(r.startContainer,"data-node-id",null);u&&(u.before(sa(o[0].cloneNode(!0))),c=!0)}else d.forEach(u=>{G(u)||(u.after(sa(o[0].cloneNode(!0))),c=!0)})}else if(o.length>0){const d=t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`);if(!t.options.backlinkData&&e.parentID===t.block.parentID&&!t.block.showAll)t.wysiwyg.element.prepend(sa(o[0].cloneNode(!0))),c=!0;else if(d.length===0&&t.options.backlinkData&&n&&getSelection().rangeCount>0){const u=Le(getSelection().getRangeAt(0).startContainer,"data-node-id",null);u&&(u.before(sa(o[0].cloneNode(!0))),c=!0)}else d.forEach(u=>{var m;G(u)||((m=u.firstElementChild)!=null&&m.classList.contains("protyle-action")?u.firstElementChild.after(sa(o[0].cloneNode(!0))):u.prepend(sa(o[0].cloneNode(!0))),c=!0)})}o.forEach(d=>{c?d.remove():!c&&d.parentElement&&LE(d,t)}),n&&r&&(e.data==="focus"?(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(d=>{if(!G(d))return oe(d),!0}),document.querySelectorAll("wbr").forEach(d=>{d.remove()})):we(t.wysiwyg.element,r)),n||t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(d=>{d.querySelector(`[data-node-id="${e.id}"],[data-node-id="${e.parentID}"],[data-node-id="${e.previousID}"]`)&&(d.removeAttribute("data-render"),We(t,d))});return}if(e.action==="insert"){if(((l=e.context)==null?void 0:l.ignoreProcess)==="true")return;const r=[];if(e.previousID){const c=t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`);if(c.length===0&&n&&t.wysiwyg.element.childElementCount===0)t.wysiwyg.element.innerHTML=e.data;else if(c.length===0&&t.options.backlinkData&&n&&getSelection().rangeCount>0){const d=B(getSelection().getRangeAt(0).startContainer);d&&(d.insertAdjacentHTML("beforebegin",e.data),r.push(d.previousElementSibling))}else c.forEach(d=>{const u=G(d);u?(u.removeAttribute("data-render"),We(t,u)):(d.insertAdjacentHTML("afterend",e.data),r.push(d.nextElementSibling))})}else if(e.nextID)Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.nextID}"]`)).forEach(c=>{const d=G(c);d?(d.removeAttribute("data-render"),We(t,d)):(c.insertAdjacentHTML("beforebegin",e.data),r.push(c.previousElementSibling))});else{const c=t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`);if(!t.options.backlinkData&&e.parentID===t.block.parentID&&!t.block.showAll)t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.data),r.push(t.wysiwyg.element.firstElementChild);else if(c.length===0&&t.options.backlinkData&&n&&getSelection().rangeCount>0){const d=B(getSelection().getRangeAt(0).startContainer);d&&(d.insertAdjacentHTML("beforebegin",e.data),r.push(d.previousElementSibling))}else c.forEach(d=>{var u;G(d)||((u=d.firstElementChild)!=null&&u.classList.contains("protyle-action")?(d.firstElementChild.insertAdjacentHTML("afterend",e.data),r.push(d.firstElementChild.nextElementSibling)):(d.insertAdjacentHTML("afterbegin",e.data),r.push(d.firstElementChild)))})}if(t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(c=>{c.lastElementChild.getAttribute("spin")==="1"&&c.lastElementChild.remove()}),r.length===0)return;r.forEach(c=>{Ct(c),rt(c),Vt(c,t),We(t,c);const d=c.querySelector("wbr");if(n){const u=ke(c);d?we(c,u):oe(c)}else d&&d.remove()}),t.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(c=>{c.remove()});return}if(e.action==="append"){t.options.backlinkData||Ei(t,!1);return}if(["addAttrViewCol","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","setAttrViewColDesc","duplicateAttrViewKey","setAttrViewViewDesc","setAttrViewCoverFrom","setAttrViewCoverFromAssetKeyID","setAttrViewBlockView","setAttrViewCardSize","setAttrViewCardAspectRatio","hideAttrViewName","setAttrViewShowIcon","setAttrViewWrapField","setAttrViewGroup","removeAttrViewGroup","hideAttrViewGroup","sortAttrViewGroup","foldAttrViewGroup","hideAttrViewAllGroups","setAttrViewFitImage","setAttrViewDisplayFieldName","insertAttrViewBlock","setAttrViewColDateFillSpecificTime","setAttrViewFillColBackgroundColor","setAttrViewUpdatedIncludeTime","setAttrViewCreatedIncludeTime"].includes(e.action)){n?e.action==="setAttrViewName"&&Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-av-id="${e.id}"]`)).forEach(r=>{const c=r.querySelector(".av__title");c&&(c.textContent=e.data,c.dataset.title=e.data)}):G0(t,e);return}if(e.action==="doUpdateUpdated"){o.forEach(r=>{r.setAttribute("updated",e.data)});return}},ga=t=>{let e;const n=Lute.NewNodeID();if(t.type==="BlocksMergeSuperBlock")e=Nv(t.level,n);else if(t.type==="Blocks2Blockquote")e=document.createElement("div"),e.classList.add("bq"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeBlockquote"),e.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(t.type.endsWith("Ls")){e=document.createElement("div"),e.classList.add("list"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeList"),t.type==="Blocks2ULs"?e.setAttribute("data-subtype","u"):t.type==="Blocks2OLs"?e.setAttribute("data-subtype","o"):e.setAttribute("data-subtype","t");let r="";t.selectsElement.forEach((c,d)=>{t.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:t.type==="Blocks2OLs"?r+=`<div data-marker="${d+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${d+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),e.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=t.selectsElement[0].getAttribute("data-node-id"),i=t.selectsElement[0].parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,s=[{action:"insert",id:n,data:e.outerHTML,nextID:a,parentID:i}],l=[];t.selectsElement[0].previousElementSibling?t.selectsElement[0].before(e):t.selectsElement[0].parentElement.prepend(e);let o;t.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const d=r.getAttribute("data-node-id");l.push({action:"move",id:d,previousID:o||n,parentID:i}),t.type.endsWith("Ls")?(s.push({action:"move",id:d,parentID:e.children[c].getAttribute("data-node-id")}),e.children[c].firstElementChild.after(r)):(s.push({action:"move",id:d,previousID:o,parentID:n}),e.lastElementChild.before(r)),o=r.getAttribute("data-node-id"),c===t.selectsElement.length-1&&l.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),We(t.protyle,r))}),V(t.protyle,s,l),oe(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.selectsElement[0].getAttribute("data-node-id")}"]`)),ce(["gutter"],t.protyle)},TE=(t,e)=>{const n=document.createElement("template");n.innerHTML=t,Array.from(n.content.children).forEach(a=>{var i;(i=e.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||i.remove()})},ka=t=>{var e;(e=t.protyle.observerLoad)==null||e.disconnect();let n=t.selectsElement,a;if(t.nodeElement){a=getSelection().getRangeAt(0),a.insertNode(document.createElement("wbr")),n=Array.from(t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),n.length===0&&(n=[t.nodeElement]);let r=!1,c=!1;if(n.find((d,u)=>{if(d.classList.contains("li"))return c=!0,!0;if(d.nextElementSibling&&n[u+1]&&d.nextElementSibling===n[u+1])r=!0;else if(u!==n.length-1)return r=!1,!0}),c)return;n.length===1&&t.type==="Blocks2Hs"&&n[0].getAttribute("data-type")==="NodeHeading"&&t.level===parseInt(n[0].getAttribute("data-subtype").substr(1))&&(t.type="Blocks2Ps"),t.isContinue=r}let i="";const s=[],l=[];let o;n.forEach((r,c)=>{var d,u,m,f,g,h,b,y;r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end"),i+=r.outerHTML;const w=r.getAttribute("data-node-id"),E=document.createElement("template");if(t.isContinue)if(l.push({action:"insert",id:w,previousID:((h=s[s.length-1])==null?void 0:h.id)||((b=r.previousElementSibling)==null?void 0:b.getAttribute("data-node-id")),data:r.outerHTML,parentID:((y=r.parentElement)==null?void 0:y.getAttribute("data-node-id"))||t.protyle.block.parentID||t.protyle.block.rootID}),s.push({action:"delete",id:w}),c===n.length-1){const C=t.protyle.lute[t.type](i,t.level);E.innerHTML=C,Array.from(E.content.children).forEach($=>{var M,k,_;const v=$.getAttribute("data-node-id");s.push({action:"insert",id:v,previousID:((M=$.previousElementSibling)==null?void 0:M.getAttribute("data-node-id"))||((k=r.previousElementSibling)==null?void 0:k.getAttribute("data-node-id")),data:$.outerHTML,parentID:((_=r.parentElement)==null?void 0:_.getAttribute("data-node-id"))||t.protyle.block.parentID||t.protyle.block.rootID}),l.splice(0,0,{action:"delete",id:v})}),r.outerHTML=C}else r.remove();else{let C=t.protyle.lute[t.type](r.outerHTML,t.level);if(E.innerHTML=C,!E.content.querySelector(`[data-node-id="${w}"]`))l.push({action:"insert",id:w,previousID:o||((d=r.previousElementSibling)==null?void 0:d.getAttribute("data-node-id")),data:r.outerHTML,parentID:((u=r.parentElement)==null?void 0:u.getAttribute("data-node-id"))||t.protyle.block.parentID||t.protyle.block.rootID}),Array.from(E.content.children).forEach($=>{var M,k,_;const v=$.getAttribute("data-node-id");s.push({action:"insert",id:v,previousID:((M=$.previousElementSibling)==null?void 0:M.getAttribute("data-node-id"))||((k=r.previousElementSibling)==null?void 0:k.getAttribute("data-node-id")),data:$.outerHTML,parentID:((_=r.parentElement)==null?void 0:_.getAttribute("data-node-id"))||t.protyle.block.parentID||t.protyle.block.rootID}),l.splice(0,0,{action:"delete",id:v})}),s.push({action:"delete",id:w}),r===((m=n[c+1])==null?void 0:m.previousElementSibling)?o=w:o=void 0;else{let $;r.getAttribute("data-type")==="NodeHeading"&&r.getAttribute("fold")==="1"&&E.content.firstElementChild.getAttribute("data-subtype")!==r.dataset.subtype&&($=Nt(t.protyle,r,void 0,void 0,!1,!0),C=C.replace(' fold="1"',"")),$&&((f=$.doOperations)==null?void 0:f.length)>0&&s.push(...$.doOperations),l.push({action:"update",id:w,data:r.outerHTML}),s.push({action:"update",id:w,data:C}),$&&((g=$.undoOperations)==null?void 0:g.length)>0&&l.push(...$.undoOperations)}r.outerHTML=C}}),V(t.protyle,s,l),Ct(t.protyle.wysiwyg.element),rt(t.protyle.wysiwyg.element),Vt(t.protyle.wysiwyg.element,t.protyle),We(t.protyle,t.protyle.wysiwyg.element),a||t.range?we(t.protyle.wysiwyg.element,a||t.range):oe(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${n[0].getAttribute("data-node-id")}"]`)),ce(["gutter"],t.protyle)},lr=t=>Z0(void 0,null,function*(){var e,n;if(t.nodeElement.querySelector("wbr")||(e=fe(t.nodeElement))==null||e.insertAdjacentHTML("afterbegin","<wbr>"),t.type==="CancelList"||t.type==="CancelBlockquote")try{for(var a=J0(t.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),i,s,l;i=!(s=yield a.next()).done;i=!1){const u=s.value,m=u.getAttribute("data-node-id");u.removeAttribute("fold");const f=yield Ae("/api/transactions",{session:t.protyle.id,app:p.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:m}],undoOperations:[{action:"foldHeading",id:m}]}]});t.protyle.undo.add([{action:"unfoldHeading",id:m}],[{action:"foldHeading",id:m}],t.protyle),u.insertAdjacentHTML("afterend",f.data[0].doOperations[0].retData)}}catch(u){l=[u]}finally{try{i&&(s=a.return)&&(yield s.call(a))}finally{if(l)throw l[0]}}const o=t.nodeElement.outerHTML;let r=(n=t.nodeElement.previousElementSibling)==null?void 0:n.getAttribute("data-node-id");!t.nodeElement.previousElementSibling&&t.protyle.block.showAll&&(r=(yield Ae("/api/block/getBlockRelevantIDs",{id:t.id})).data.previousID);const c=t.nodeElement.parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,d=t.protyle.lute[t.type](t.nodeElement.outerHTML,t.level);if(t.nodeElement.outerHTML=d,t.type==="CancelList"||t.type==="CancelBlockquote"){const u=document.createElement("template");u.innerHTML=d;const m=[{action:"delete",id:t.id}],f=[];let g=r;Array.from(u.content.children).forEach(h=>{const b=h.getAttribute("data-node-id");m.push({action:"insert",data:h.outerHTML,id:b,previousID:g,parentID:c}),f.push({action:"delete",id:b}),g=b}),f.push({action:"insert",data:o,id:t.id,previousID:r,parentID:c}),V(t.protyle,m,f)}else le(t.protyle,t.id,d,o);we(t.protyle.wysiwyg.element,ke(t.protyle.wysiwyg.element)),t.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(u=>{u.textContent===""&&A("/api/block/getRefText",{id:u.getAttribute("data-id")},m=>{u.innerHTML=m.data})}),We(t.protyle,t.protyle.wysiwyg.element),Ct(t.protyle.wysiwyg.element),rt(t.protyle.wysiwyg.element),Vt(t.protyle.wysiwyg.element,t.protyle)});let DE;const V=(t,e,n)=>{if(e.length===0)return;if(!t){A("/api/transactions",{session:p.SIYUAN_APPID,app:p.SIYUAN_APPID,transactions:[{doOperations:e}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();if(a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&e.length===1&&e[0].action==="update"&&a.doOperations[0].id===e[0].id&&t.transactionTime-s<p.TIMEOUT_INPUT&&(i=!0),n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.model&&t.model.headElement.classList.remove("item--unupdate"),t.updated=!0,i?t.undo.replace(e,t):t.undo.add(e,n,t)),e.length===1&&(e[0].action==="unfoldHeading"||e[0].action==="setAttrViewBlockView"||e[0].action==="setAttrs"&&e[0].data.startsWith('{"fold":'))||e.length===2&&e[0].action==="insertAttrViewBlock"){t.transactionTime=s+p.TIMEOUT_INPUT*2,A("/api/transactions",{session:t.id,app:p.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},l=>{l.data[0].doOperations.forEach(o=>{if(o.action==="unfoldHeading"||o.action==="foldHeading")IE(o,t);else if(o.action==="setAttrs"){const r=t.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{c.querySelector(`[data-node-id="${o.id}"]`)&&(c.removeAttribute("data-render"),We(t,c))})}})});return}window.clearTimeout(DE),i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=t,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=e):window.siyuan.transactions.push({protyle:t,doOperations:e,undoOperations:n}),t.transactionTime=s,DE=window.setTimeout(()=>{AE()},p.TIMEOUT_INPUT*2),e.find(l=>{var o;if(l.action==="insert")return(o=t.observerLoad)==null||o.disconnect(),!0})},IE=(t,e)=>{var n;if(t.action==="unfoldHeading"||t.action==="foldHeading"){const a=e.gutter.element.querySelector('[data-type="fold"]');if(a&&a.removeAttribute("disabled"),t.action==="unfoldHeading"){const i=e.contentElement.scrollTop;if(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(s=>{const l=G(s);if(l){l.removeAttribute("data-render"),We(e,l);return}if(s.lastElementChild.classList.contains("protyle-attr")||s.lastElementChild.remove(),TE(t.retData,e),s.insertAdjacentHTML("afterend",t.retData),t.data==="remove"){const o=getSelection();o.rangeCount>0&&s.contains(o.getRangeAt(0).startContainer)&&oe(s.nextElementSibling,void 0,!0),s.remove()}}),e.disabled&&Sa(e),Ct(e.wysiwyg.element),rt(e.wysiwyg.element),Vt(e.wysiwyg.element,e),We(e,e.wysiwyg.element),(n=t.context)!=null&&n.focusId){const s=e.wysiwyg.element.querySelector(`[data-node-id="${t.context.focusId}"]`);oe(s),Ye(e,s)}else e.contentElement.scrollTop=i,e.scroll.lastScrollTop=i;return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(i=>{const s=G(i);s&&(s.removeAttribute("data-render"),We(e,s))}),e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.scrollHeight-e.contentElement.scrollTop<e.contentElement.clientHeight*2&&A("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{kt({data:i,protyle:e,action:[p.CB_GET_APPEND,p.CB_GET_UNCHANGEID]})});return}},le=(t,e,n,a)=>{n!==a&&V(t,[{id:e,data:n,action:"update"}],[{id:e,data:a,action:"update"}])},Ds=(t,e,n)=>{const a=[],i=[];t.forEach(s=>{const l=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:l,data:s.outerHTML}),n(s),a.push({action:"update",id:l,data:s.outerHTML})}),V(e,a,i)},$E=()=>{var t;const e=document.getElementById("dragGhost");if(e){if(e.dataset.ghostType==="dock")e.parentElement.querySelectorAll(".dock__item").forEach(n=>{n.style.opacity=""}),(t=document.querySelector("#dockMoveItem"))==null||t.remove();else{const n=e.parentElement.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);n&&(n.style.opacity=""),e.parentElement.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(a=>{a.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current"),a.style.opacity=""})}e.remove(),document.onmousemove=null,ub()}},Tn={},ub=()=>{Tn.animationId&&(cancelAnimationFrame(Tn.animationId),Tn.animationId=null,Tn.element=null,Tn.space=null,Tn.lastTime=null)},ME=t=>{Tn.lastTime||(Tn.lastTime=t-8),Tn.element.scroll({top:Tn.element.scrollTop+(t-Tn.lastTime)*Tn.space/64}),Tn.animationId=requestAnimationFrame(ME),Tn.lastTime=t},X0=(t,e,n)=>{const a=t.clientY<e.top+p.SIZE_SCROLL_TB;a||t.clientY>e.bottom-p.SIZE_SCROLL_TB?(Tn.space=a?t.clientY-e.top-p.SIZE_SCROLL_TB:t.clientY-e.bottom+p.SIZE_SCROLL_TB,Tn.animationId||(Tn.element=n,Tn.animationId=requestAnimationFrame(ME))):ub()};class Is extends ia{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&A("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(a){if(a)switch(a.cmd){case"savedoc":this.onTransaction(a);break;case"rename":this.type==="local"&&this.blockId===a.data.id?this.parent.updateTitle(a.data.title):this.updateDocTitle({title:a.data.title,icon:p.ZWSP},-1);break;case"unmount":this.type==="local"&&A("/api/block/checkBlockExist",{id:this.blockId},i=>{i.data||this.parent.parent.removeTab(this.parent.id)});break;case"removeDoc":a.data.ids.includes(this.blockId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.preFilterExpandIds=null,this.isPreview=e.isPreview,this.blockId=e.blockId,this.type=e.type,e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__outline"),e.tab.panelElement.innerHTML=`<div class="block__icons fn__hidescrollbar">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconAlignCenter"></use></svg>${window.siyuan.languages.outline}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon ariaLabel" aria-label="${window.siyuan.languages.filter}">
        <svg><use xlink:href='#iconFilter'></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="keepCurrentExpand" class="block__icon ariaLabel${window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand?" block__icon--active":""}" aria-label="${window.siyuan.languages.outlineKeepCurrentExpand}">
        <svg><use xlink:href="#iconFocus"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="expandLevel" class="block__icon ariaLabel" aria-label="${window.siyuan.languages.expandLevel}">
        <svg><use xlink:href="#iconList"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon ariaLabel" aria-label="${window.siyuan.languages.expandAll}${Pt(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon ariaLabel" aria-label="${window.siyuan.languages.foldAll}${Pt(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon ariaLabel" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}">
        <svg><use xlink:href='#iconMin'></use></svg>
    </span>
</div>
<div class="b3-list-item fn__none"></div>
<div class="fn__flex-1" style="padding: 3px 0 8px"></div>`,this.element=e.tab.panelElement.lastElementChild,this.headerElement=e.tab.panelElement.firstElementChild;const n=this.headerElement.querySelector("input.b3-text-field.search__label");n.addEventListener("blur",()=>{n.classList.add("fn__none");const a=n.nextElementSibling,i=n.value;i?(a.classList.add("block__icon--active"),a.setAttribute("aria-label",window.siyuan.languages.filter+" "+at(i))):(a.classList.remove("block__icon--active"),a.setAttribute("aria-label",window.siyuan.languages.filter)),n.dataset.value!==i&&this.setFilter()}),n.addEventListener("keydown",a=>{!a.isComposing&&a.key==="Enter"&&(n.dataset.value=n.value,this.setFilter())}),this.tree=new kc({element:this.element,data:null,click:a=>{const i=a.getAttribute("data-node-id");if(this.isPreview){const s=document.getElementById(i);if(s){const l=He(s,"protyle");if(l){const o=on(l.getAttribute("data-id"));o.parent.switchTab(o.headElement)}s.scrollIntoView()}else ve({app:e.app,id:this.blockId,mode:"preview"})}else ft(i,s=>{ve({app:e.app,id:i,action:s?[p.CB_GET_FOCUS,p.CB_GET_ALL,p.CB_GET_HTML,p.CB_GET_OUTLINE]:[p.CB_GET_FOCUS,p.CB_GET_OUTLINE,p.CB_GET_SETID,p.CB_GET_CONTEXT,p.CB_GET_HTML]})})},ctrlClick:(a,i)=>{const s=T(i.target,"b3-list-item__toggle");if(s&&!s.classList.contains("fn__hidden")){this.collapseChildren(a);return}const l=a.getAttribute("data-node-id");ve({app:e.app,id:l,action:[p.CB_GET_FOCUS,p.CB_GET_ALL,p.CB_GET_HTML],zoomIn:!0})},altClick:(a,i)=>{T(i.target,"b3-list-item__toggle")&&this.collapseSameLevel(a)},rightClick:(a,i)=>{this.showContextMenu(a,i)},toggleClick:a=>{if(!a.nextElementSibling)return;const i=a.firstElementChild.firstElementChild;i.classList.contains("b3-list-item__arrow--open")?(i.classList.remove("b3-list-item__arrow--open"),a.nextElementSibling.classList.add("fn__none"),a.nextElementSibling.nextElementSibling&&a.nextElementSibling.nextElementSibling.tagName==="UL"&&a.nextElementSibling.nextElementSibling.classList.add("fn__none")):(i.classList.add("b3-list-item__arrow--open"),a.nextElementSibling.classList.remove("fn__none"),a.nextElementSibling.nextElementSibling&&a.nextElementSibling.nextElementSibling.tagName==="UL"&&a.nextElementSibling.nextElementSibling.classList.remove("fn__none")),this.saveExpendIds()}}),e.tab.panelElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll(),this.saveExpendIds()}),e.tab.panelElement.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll(),this.saveExpendIds()}),e.tab.panelElement.querySelector('[data-type="keepCurrentExpand"]').addEventListener("click",a=>{const i=T(a.target,"block__icon");if(i){if(i.classList.contains("block__icon--active"))i.classList.remove("block__icon--active"),window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand=!1;else{i.classList.add("block__icon--active"),window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand=!0;let s;Oe().editor.find(l=>{if(l.editor.protyle.block.rootID===this.blockId){const o=getSelection();if(o.rangeCount>0){const r=B(o.getRangeAt(0).startContainer);if(r)return s=r,!0}}}),s&&this.setCurrent(s)}Ee(p.LOCAL_OUTLINE,window.siyuan.storage[p.LOCAL_OUTLINE])}}),e.tab.panelElement.addEventListener("click",a=>{let i=a.target;if(i.tagName==="INPUT")return;let s=!0;for(;i&&!i.isEqualNode(e.tab.panelElement);){if(i.classList.contains("block__icon")){switch(i.getAttribute("data-type")){case"min":nt("outline").toggleModel("outline",!1,!0);break;case"search":n.classList.remove("fn__none"),n.select();break;case"expandLevel":this.showExpandLevelMenu(i),a.preventDefault(),a.stopPropagation();break}break}else if(this.blockId&&(i===this.headerElement.nextElementSibling||i.classList.contains("block__icons"))){ve({app:e.app,id:this.blockId,afterOpen:l=>{l&&(this.isPreview?l.editor.protyle.preview.element.querySelector(".b3-typography").scrollTop=0:$h(l.editor.protyle))}}),s=!1;break}i=i.parentElement}s&&(this.type==="local"?gt(e.tab.panelElement.parentElement.parentElement):gt(e.tab.panelElement))}),this.bindSort(),A("/api/outline/getDocOutline",{id:this.blockId,preview:this.isPreview},a=>{var i,s,l,o;this.update(a),this.updateDocTitle((l=(s=(i=e.tab.model)==null?void 0:i.editor.protyle)==null?void 0:s.background)==null?void 0:l.ial,((o=a.data)==null?void 0:o.length)||0)})}bindSort(){this.element.addEventListener("mousedown",e=>{const n=T(e.target,"b3-list-item");if(!n||n.tagName!=="LI"||this.element.getAttribute("data-loading")==="true")return;const a=document;a.ondragstart=()=>!1;let i,s,l;Oe().editor.find(r=>{if(r.editor.protyle.block.rootID===this.blockId)return l=r.editor.protyle,!0});const o=this.element.getBoundingClientRect();a.onmousemove=r=>{if(!l||l.disabled||Math.abs(r.clientY-e.clientY)<3&&Math.abs(r.clientX-e.clientX)<3)return;if(r.preventDefault(),r.stopPropagation(),i||(n.style.opacity="0.38",i=n.cloneNode(!0),this.element.append(i),i.setAttribute("id","dragGhost"),i.firstElementChild.setAttribute("style","padding-left:4px"),i.setAttribute("style",`border-radius: var(--b3-border-radius);background-color: var(--b3-list-hover);position: fixed; top: ${e.clientY}px; left: ${e.clientX}px; z-index:999997;`)),i.style.top=r.clientY+"px",i.style.left=r.clientX+"px",X0(r,o,this.element),!this.element.contains(r.target)){this.element.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(u=>{u.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current")});return}if(s=T(r.target,"b3-list-item"),!s||s.tagName!=="LI"||s.style.position==="fixed")return;if(this.element.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(u=>{u.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current")}),s===n){s.classList.add("dragover__current");return}const c=s.getBoundingClientRect(),d=c.height*.2;r.clientY>c.bottom-d?s.classList.add("dragover__bottom"):r.clientY<c.top+d?s.classList.add("dragover__top"):s.classList.add("dragover")},a.onmouseup=()=>{var r,c,d,u,m;a.onmousemove=null,a.onmouseup=null,a.ondragstart=null,a.onselectstart=null,a.onselect=null,i==null||i.remove(),n.style.opacity="",ub(),s||(s=this.element.querySelector(".dragover__top, .dragover__bottom, .dragover"));let f=!0;if(s&&l&&(s.classList.contains("dragover__top")||s.classList.contains("dragover__bottom")||s.classList.contains("dragover"))){let g,h;const b=n.previousElementSibling&&n.previousElementSibling.tagName==="UL"?n.previousElementSibling.previousElementSibling.getAttribute("data-node-id"):(r=n.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),y=(c=n.parentElement.previousElementSibling)==null?void 0:c.getAttribute("data-node-id");if(s.classList.contains("dragover")?(h=s.getAttribute("data-node-id"),s.nextElementSibling&&s.nextElementSibling.tagName==="UL"?s.nextElementSibling.insertAdjacentElement("afterbegin",n):(s.insertAdjacentHTML("afterend",`<ul>${n.outerHTML}</ul>`),n.remove())):s.classList.contains("dragover__top")?(h=(d=s.parentElement.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),s.previousElementSibling&&s.previousElementSibling.tagName==="UL"?g=s.previousElementSibling.previousElementSibling.getAttribute("data-node-id"):g=(u=s.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),g===n.dataset.nodeId||h===n.dataset.nodeId?f=!1:s.before(n)):s.classList.contains("dragover__bottom")&&(g=s.getAttribute("data-node-id"),g===((m=n.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"))?f=!1:s.after(n)),f)return this.element.setAttribute("data-loading","true"),V(l,[{action:"moveOutlineHeading",id:n.dataset.nodeId,previousID:g,parentID:h}],[{action:"moveOutlineHeading",id:n.dataset.nodeId,previousID:b,parentID:y}]),l.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"] [contenteditable="true"][spellcheck]').forEach(w=>{w.setAttribute("contenteditable","false")}),!0}this.element.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(g=>{g.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current")})}})}updateDocTitle(e,n){var a;const i=this.headerElement.nextElementSibling;if(this.type==="pin"){if(!e&&typeof n=="undefined"){i.classList.add("fn__none");return}if(e){let s=`${be(e.icon||window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}`;e.icon===p.ZWSP&&i.firstElementChild&&(s=i.firstElementChild.outerHTML),i.innerHTML=`${s}<span class="b3-list-item__text">${he(e.title)}</span>${((a=i.querySelector(".counter"))==null?void 0:a.outerHTML)||""}`,i.setAttribute("title",e.title),i.classList.remove("fn__none")}if(typeof n=="number"&&n!==-1){const s=i.querySelector(".counter");n>0?s?s.textContent=n.toString():i.insertAdjacentHTML("beforeend",`<span class="counter">${n.toString()}</span>`):s==null||s.remove()}}else i.classList.add("fn__none")}onTransaction(e){if(e.data.rootID!==this.blockId)return;let n=!1;const a=e.data.sources[0];a.doOperations.find(i=>{if(i.action==="update"&&(this.element.querySelector(`.b3-list-item[data-node-id="${i.id}"]`)||i.data.indexOf('data-type="NodeHeading"')>-1))return n=!0,!0;if(i.action==="insert"&&i.data.indexOf('data-type="NodeHeading"')>-1)return n=!0,!0;if(i.action==="delete"||i.action==="move")return n=!0,!0}),!n&&a.undoOperations&&a.undoOperations.find(i=>{var s;if(i.action==="update"&&((s=i.data)==null?void 0:s.indexOf('data-type="NodeHeading"'))>-1)return n=!0,!0}),n&&A("/api/outline/getDocOutline",{id:this.blockId,preview:this.isPreview},i=>{var s;if(e.data.rootID===this.blockId&&(this.update(i),this.updateDocTitle(null,((s=i.data)==null?void 0:s.length)||0),getSelection().rangeCount>0)){const l=B(getSelection().getRangeAt(0).startContainer);l&&l.getAttribute("data-type")==="NodeHeading"&&this.setCurrent(l)}})}setCurrent(e){if(e)if(e.getAttribute("data-type")==="NodeHeading")this.setCurrentById(e.getAttribute("data-node-id"));else{let n=Qe(e);for(;n&&n.getAttribute("data-type")!=="NodeHeading";)n=Qe(n);n?this.setCurrentById(n.getAttribute("data-node-id")):A("/api/block/getBlockBreadcrumb",{id:e.getAttribute("data-node-id"),excludeTypes:[]},a=>{a.data.reverse().find(i=>{if(i.type==="NodeHeading")return this.setCurrentById(i.id),!0})})}}setCurrentByPreview(e){if(!e)return;let n=e;for(;n&&!n.classList.contains("b3-typography")&&!["H1","H2","H3","H4","H5","H6"].includes(n.tagName);)n=n.previousElementSibling||n.parentElement;n&&n.id&&this.setCurrentById(n.id)}setCurrentById(e){this.element.querySelectorAll(".b3-list-item.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")});let n=this.element.querySelector(`.b3-list-item[data-node-id="${e}"]`);if(window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand){let a=n.parentElement;for(;a&&!a.classList.contains("b3-list")&&a.tagName==="UL";)a.classList.remove("fn__none"),a.previousElementSibling.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),a=a.parentElement;this.saveExpendIds()}else for(;n&&n.clientHeight===0;)n=n.parentElement.previousElementSibling;if(n){n.classList.add("b3-list-item--focus");const a=this.element.getBoundingClientRect();this.element.scrollTop=this.element.scrollTop+(n.getBoundingClientRect().top-(a.top+a.height/2))}}update(e,n){let a=this.element.querySelector(".b3-list-item--focus"),i;a&&(i=a.getAttribute("data-node-id"));const s=this.element.scrollTop;typeof n!="undefined"&&(this.blockId=n),this.tree.updateData(e.data),this.isPreview?(this.tree.element.querySelectorAll(".popover__block").forEach(l=>{l.classList.remove("popover__block")}),this.element.scrollTop=s):this.blockId&&(this.headerElement.querySelector("input.b3-text-field.search__label").value&&this.setFilter(),this.element.scrollTop=s),i&&(a=this.element.querySelector(`[data-node-id="${i}"]`),a&&a.classList.add("b3-list-item--focus")),this.element.removeAttribute("data-loading")}saveExpendIds(){window.siyuan.config.readonly||window.siyuan.isPublish||!this.isPreview&&this.type==="pin"&&A("/api/storage/setOutlineStorage",{docID:this.blockId,val:{expandIds:this.tree.getExpandIds()}})}setFilter(){this.element.querySelectorAll('li.b3-list-item[style$="display: none;"]').forEach(n=>{n.style.display=""}),this.element.querySelectorAll("ul.fn__none").forEach(n=>{n.previousElementSibling.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden")});const e=this.headerElement.querySelector("input.b3-text-field.search__label").value.toLowerCase();if(e){this.preFilterExpandIds||(this.preFilterExpandIds=this.tree.getExpandIds());const n=a=>{let i=!1,s=!1;return a.querySelectorAll(":scope > li.b3-list-item").forEach(o=>{var r;const c=o.nextElementSibling&&o.nextElementSibling.tagName==="UL"?o.nextElementSibling:void 0;let d={hasMatch:!1,hasChildMatch:!1};c&&(d=n(c));const u=o.querySelector(".b3-list-item__arrow");(((r=o.querySelector(".b3-list-item__text"))==null?void 0:r.textContent)||"").trim().toLowerCase().includes(e)?(o.style.display="",i=!0,c&&(c.classList.remove("fn__none"),d.hasMatch||d.hasChildMatch?(u.classList.add("b3-list-item__arrow--open"),c.classList.remove("fn__none")):(u.classList.remove("b3-list-item__arrow--open"),u.parentElement.classList.add("fn__hidden"),c.classList.add("fn__none")))):d.hasMatch||d.hasChildMatch?(o.style.display="",s=!0,c&&(c.classList.remove("fn__none"),u.classList.add("b3-list-item__arrow--open"))):(o.style.display="none",c&&c.classList.add("fn__none"))}),{hasMatch:i,hasChildMatch:s}};n(this.element.firstElementChild);return}this.tree.setExpandIds(this.preFilterExpandIds),this.preFilterExpandIds=null}getHeadingLevel(e){var n;return parseInt(((n=e.getAttribute("data-subtype"))==null?void 0:n.replace("h",""))||"0")}expandToLevel(e){e>=6?this.tree.expandAll():this.element.querySelectorAll("li.b3-list-item").forEach(n=>{const a=this.getHeadingLevel(n),i=n.querySelector(".b3-list-item__arrow");n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&i&&(a>0&&a<e?(i.classList.add("b3-list-item__arrow--open"),n.nextElementSibling.classList.remove("fn__none")):a>=e&&(i.classList.remove("b3-list-item__arrow--open"),n.nextElementSibling.classList.add("fn__none")))}),this.saveExpendIds()}showExpandLevelMenu(e){window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_OUTLINE_EXPAND_LEVEL);for(let a=1;a<=6;a++)window.siyuan.menus.menu.append(new N({id:`heading${a}`,icon:`iconH${a}`,label:window.siyuan.languages[`heading${a}`],click:()=>this.expandToLevel(a)}).element);const n=e.getBoundingClientRect();return window.siyuan.menus.menu.popup({x:n.left,y:n.bottom,h:n.height}),window.siyuan.menus.menu}collapseSameLevel(e,n){this.element.querySelectorAll(`li.b3-list-item[data-subtype="${e.getAttribute("data-subtype")}"]`).forEach(a=>{const i=a.querySelector(".b3-list-item__arrow");if(typeof n=="undefined"&&(n=!e.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")),n){a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&(a.nextElementSibling.classList.remove("fn__none"),i.classList.add("b3-list-item__arrow--open"));let s=a.parentElement;for(;s&&!s.classList.contains("b3-list")&&s.tagName==="UL";)s.classList.remove("fn__none"),s.previousElementSibling.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),s=s.parentElement}else a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&(a.nextElementSibling.classList.add("fn__none"),i.classList.remove("b3-list-item__arrow--open"))}),this.saveExpendIds()}collapseChildren(e,n){const a=e.nextElementSibling;if(!a||a.tagName!=="UL")return;const i=e.querySelector(".b3-list-item__arrow");typeof n=="undefined"&&(n=!i.classList.contains("b3-list-item__arrow--open")),n?(i.classList.add("b3-list-item__arrow--open"),a.classList.remove("fn__none"),a.querySelectorAll("ul").forEach(s=>{s.previousElementSibling.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),s.classList.remove("fn__none")})):(i.classList.remove("b3-list-item__arrow--open"),a.classList.add("fn__none")),this.saveExpendIds()}showContextMenu(e,n){if(this.isPreview)return;const a=this.getHeadingLevel(e);window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_OUTLINE_CONTEXT);const i=e.getAttribute("data-node-id");if(!window.siyuan.config.readonly){a>1&&window.siyuan.menus.menu.append(new N({id:"upgrade",icon:"iconUp",label:window.siyuan.languages.upgrade,click:()=>{const l=this.getProtyleAndBlockElement(e);l&&ka({protyle:l.protyle,selectsElement:[l.blockElement],type:"Blocks2Hs",level:a-1})}}).element),a<6&&window.siyuan.menus.menu.append(new N({id:"downgrade",icon:"iconDown",label:window.siyuan.languages.downgrade,click:()=>{const l=this.getProtyleAndBlockElement(e);l&&ka({protyle:l.protyle,selectsElement:[l.blockElement],type:"Blocks2Hs",level:a+1})}}).element),ft(i,l=>{ve({app:this.app,id:i,action:l?[p.CB_GET_FOCUS,p.CB_GET_ALL,p.CB_GET_HTML,p.CB_GET_OUTLINE]:[p.CB_GET_FOCUS,p.CB_GET_OUTLINE,p.CB_GET_SETID,p.CB_GET_CONTEXT,p.CB_GET_HTML]})}),this.setCurrentById(i);const s=[];a!==1&&s.push(this.genHeadingTransform(i,1)),a!==2&&s.push(this.genHeadingTransform(i,2)),a!==3&&s.push(this.genHeadingTransform(i,3)),a!==4&&s.push(this.genHeadingTransform(i,4)),a!==5&&s.push(this.genHeadingTransform(i,5)),a!==6&&s.push(this.genHeadingTransform(i,6)),s.length>0&&window.siyuan.menus.menu.append(new N({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:s}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"insertSameLevelHeadingBefore",icon:"iconBefore",label:window.siyuan.languages.insertSameLevelHeadingBefore,click:()=>{var l;const o=this.getProtyleAndBlockElement(e),r=Lute.NewNodeID(),c=`<div data-subtype="h${a}" data-node-id="${r}" data-type="NodeHeading" class="h${a}"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;V(o.protyle,[{action:"insert",data:c,id:r,previousID:(l=o.blockElement.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:o.blockElement.parentElement.getAttribute("data-node-id")||o.protyle.block.parentID}],[{action:"delete",id:r}]),o.blockElement.insertAdjacentHTML("beforebegin",c),o.blockElement.previousElementSibling.scrollIntoView(),we(o.blockElement.previousElementSibling,document.createRange())}}).element),window.siyuan.menus.menu.append(new N({id:"insertSameLevelHeadingAfter",icon:"iconAfter",label:window.siyuan.languages.insertSameLevelHeadingAfter,click:()=>{A("/api/block/getHeadingDeleteTransaction",{id:i},l=>{const o=this.getProtyleAndBlockElement(e),r=l.data.doOperations[l.data.doOperations.length-1].id,c=Lute.NewNodeID(),d=`<div data-subtype="h${a}" data-node-id="${c}" data-type="NodeHeading" class="h${a}"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;V(o.protyle,[{action:"insert",data:d,id:c,previousID:r}],[{action:"delete",id:c}]);const u=o.protyle.wysiwyg.element.querySelector(`[data-node-id="${r}"]`);u&&(u.insertAdjacentHTML("afterend",d),u.nextElementSibling.scrollIntoView(),we(u.nextElementSibling,document.createRange()))})}}).element),a<6&&window.siyuan.menus.menu.append(new N({id:"addChildHeading",icon:"iconAdd",label:window.siyuan.languages.addChildHeading,click:()=>{A("/api/block/getHeadingDeleteTransaction",{id:i},l=>{let o=l.data.doOperations[l.data.doOperations.length-1].id;l.data.undoOperations.find((m,f)=>{const g=m.data.indexOf(' data-subtype="h');if(g>-1&&g<260&&parseInt(m.data.substring(g+16,g+17))===a+1)return o=l.data.undoOperations[f-1].id,!0});const r=this.getProtyleAndBlockElement(e),c=Lute.NewNodeID(),d=`<div data-subtype="h${a+1}" data-node-id="${c}" data-type="NodeHeading" class="h${a+1}"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;V(r.protyle,[{action:"insert",data:d,id:c,previousID:o}],[{action:"delete",id:c}]);const u=r.protyle.wysiwyg.element.querySelector(`[data-node-id="${o}"]`);u&&(u.insertAdjacentHTML("afterend",d),u.nextElementSibling.scrollIntoView(),we(u.nextElementSibling,document.createRange()))})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element)}window.siyuan.menus.menu.append(new N({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click:()=>{const s=this.getProtyleAndBlockElement(e);A("/api/block/getHeadingChildrenDOM",{id:i,removeFoldAttr:s.blockElement.getAttribute("fold")!=="1"},l=>{ht()?window.JSAndroid.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(l.data).trimEnd(),l.data+p.ZWSP):bt()?window.JSHarmony.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(l.data).trimEnd(),l.data+p.ZWSP):Be(l.data+p.ZWSP)})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new N({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click:()=>{const s=this.getProtyleAndBlockElement(e);A("/api/block/getHeadingChildrenDOM",{id:i,removeFoldAttr:s.blockElement.getAttribute("fold")!=="1"},l=>{ht()?window.JSAndroid.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(l.data).trimEnd(),l.data+p.ZWSP):bt()?window.JSHarmony.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(l.data).trimEnd(),l.data+p.ZWSP):Be(l.data+p.ZWSP),A("/api/block/getHeadingDeleteTransaction",{id:i},o=>{if(o.data.doOperations.forEach(r=>{s.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${r.id}"]`).forEach(c=>{c.remove()})}),s.protyle.wysiwyg.element.childElementCount===0){const r=Lute.NewNodeID(),c=jn(!1,!1,r);s.protyle.wysiwyg.element.insertAdjacentElement("afterbegin",c),o.data.doOperations.push({action:"insert",data:c.outerHTML,id:r,parentID:s.protyle.block.parentID}),o.data.undoOperations.push({action:"delete",id:r}),oe(c)}V(s.protyle,o.data.doOperations,o.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new N({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click:()=>{const s=this.getProtyleAndBlockElement(e);A("/api/block/getHeadingDeleteTransaction",{id:i},l=>{if(l.data.doOperations.forEach(o=>{s.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${o.id}"]`).forEach(r=>{r.remove()})}),s.protyle.wysiwyg.element.childElementCount===0){const o=Lute.NewNodeID(),r=jn(!1,!1,o);s.protyle.wysiwyg.element.insertAdjacentElement("afterbegin",r),l.data.doOperations.push({action:"insert",data:r.outerHTML,id:o,parentID:s.protyle.block.parentID}),l.data.undoOperations.push({action:"delete",id:o}),oe(r)}V(s.protyle,l.data.doOperations,l.data.undoOperations)})}}).element)),window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"expandChildHeading",icon:"iconExpand",label:window.siyuan.languages.expandChildHeading,accelerator:"\u2318"+window.siyuan.languages.clickArrow,click:()=>this.collapseChildren(e,!0)}).element),window.siyuan.menus.menu.append(new N({id:"foldChildHeading",icon:"iconContract",label:window.siyuan.languages.foldChildHeading,accelerator:"\u2318"+window.siyuan.languages.clickArrow,click:()=>this.collapseChildren(e,!1)}).element),window.siyuan.menus.menu.append(new N({id:"expandSameLevelHeading",icon:"iconExpand",label:window.siyuan.languages.expandSameLevelHeading,accelerator:"\u2325"+window.siyuan.languages.clickArrow,click:()=>this.collapseSameLevel(e,!0)}).element),window.siyuan.menus.menu.append(new N({id:"foldSameLevelHeading",icon:"iconContract",label:window.siyuan.languages.foldSameLevelHeading,accelerator:"\u2325"+window.siyuan.languages.clickArrow,click:()=>this.collapseSameLevel(e,!1)}).element),window.siyuan.menus.menu.append(new N({id:"expandAll",icon:"iconExpand",label:window.siyuan.languages.expandAll,click:()=>{this.tree.expandAll(),this.saveExpendIds()}}).element),window.siyuan.menus.menu.append(new N({id:"foldAll",icon:"iconContract",label:window.siyuan.languages.foldAll,click:()=>{this.tree.collapseAll(),this.saveExpendIds()}}).element),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY})}getProtyleAndBlockElement(e){const n=e.getAttribute("data-node-id");let a,i;if(Oe().editor.find(s=>{if(s.editor.protyle.block.rootID===this.blockId)return a=s.editor.protyle,i=a.wysiwyg.element.querySelector(`[data-node-id="${n}"]`),!0}),!(!a||!i))return{protyle:a,blockElement:i}}genHeadingTransform(e,n){return{id:"heading"+n,iconHTML:"",icon:"iconHeading"+n,label:window.siyuan.languages["heading"+n],click:()=>{let a;Oe().editor.find(i=>{if(i.editor.protyle.block.rootID===this.blockId)return a=i.editor.protyle,!0}),a&&A("/api/block/getHeadingLevelTransaction",{id:e,level:n},i=>{i.data.doOperations.forEach((s,l)=>{if(a.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(o=>{o.outerHTML=s.data}),a.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(o=>{Nn(o)}),l===0){const o=a.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`);o&&o.scrollIntoView({behavior:"smooth",block:"center"})}}),V(a,i.data.doOperations,i.data.undoOperations)})}}}}var Dp=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Qc=t=>Dp(void 0,null,function*(){if(Oe().backlink.find(s=>{if(s.blockId===t.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=on(a.getAttribute("data-id"))),n||(n=br(window.siyuan.layout.centerLayout)),t.rootId){if(!t.title){const s=yield Ae("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.title=s.data.name||window.siyuan.languages.untitled}}else{const s=yield Ae("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.rootId=s.data.rootID,t.useBlockId=s.data.rootID!==s.data.id,t.title=s.data.name||window.siyuan.languages.untitled}n.split("lr").addTab(new Dt({icon:"iconLink",title:t.title,callback(s){s.addModel(new Zi({app:t.app,type:"local",tab:s,blockId:t.useBlockId?t.blockId:t.rootId,rootId:t.rootId}))}}))}),ed=t=>Dp(void 0,null,function*(){if(Oe().graph.find(s=>{if(s.blockId===t.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=on(a.getAttribute("data-id"))),n||(n=br(window.siyuan.layout.centerLayout)),t.rootId){if(!t.title){const s=yield Ae("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.title=s.data.name||window.siyuan.languages.untitled}}else{const s=yield Ae("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.rootId=s.data.rootID,t.useBlockId=s.data.rootID!==s.data.id,t.title=s.data.name||window.siyuan.languages.untitled}n.split("lr").addTab(new Dt({icon:"iconGraph",title:t.title,callback(s){s.addModel(new Ii({app:t.app,type:"local",tab:s,blockId:t.blockId,rootId:t.rootId}))}}))}),fb=t=>Dp(void 0,null,function*(){if(Oe().outline.find(s=>{if(s.blockId===t.rootId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");a&&(n=on(a.getAttribute("data-id"))),n||(n=br(window.siyuan.layout.centerLayout));const i=n.split("lr");if(t.title){const s=yield Ae("api/block/getDocInfo",{id:t.rootId});t.title=s.data.name||window.siyuan.languages.untitled}i.addTab(new Dt({icon:"iconAlignCenter",title:t.title,callback(s){s.addModel(new Is({app:t.app,type:"local",tab:s,blockId:t.rootId,isPreview:t.isPreview}))}}),!1,!1),i.element.style.width="200px",i.element.classList.remove("fn__flex-1"),Ay(i,n),Ty(i.parent),bn()}),pb=()=>{!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.style.opacity==="1"&&window.siyuan.layout.leftDock.showDock(!0),!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.style.opacity==="1"&&window.siyuan.layout.rightDock.showDock(!0),!window.siyuan.layout.bottomDock.pin&&window.siyuan.layout.bottomDock.layout.element.style.opacity==="1"&&window.siyuan.layout.bottomDock.showDock(!0)},gb=t=>{const e=t.getAttribute("xlink:href")==="#iconHideDock";e?t.setAttribute("xlink:href","#iconDock"):t.setAttribute("xlink:href","#iconHideDock"),window.siyuan.config.uiLayout.hideDock=e,document.querySelectorAll(".dock").forEach(n=>{e?n.classList.add("fn__none"):n.querySelectorAll(".dock__item").length>1&&n.classList.remove("fn__none")}),Sn(),pb()},Qi=()=>{const t=Oe();t.outline.find(e=>{if(e.type==="pin"){if(e.blockId==="")return;e.isPreview=!1,e.update({data:[],msg:"",code:0},""),e.updateDocTitle()}}),t.graph.forEach(e=>{if(e.type!=="global"){if(e.type==="local"||e.blockId==="")return;e.blockId="",e.graphData=void 0,e.onGraph(!1)}}),t.backlink.forEach(e=>{e.type!=="local"&&e.blockId!==""&&(e.saveStatus(),e.blockId="",e.render(void 0))})},PE=()=>Dp(void 0,null,function*(){const t=nt("file");if(!t)return!1;const e=t.data.file,n=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus")||document.querySelector("ul.layout-tab-bar > .item--focus");if(n){const a=on(n.getAttribute("data-id"));a&&a.model instanceof Ot&&(a.model.editor.protyle.wysiwyg.element.blur(),a.model.editor.protyle.title.editElement.blur(),yield e.selectItem(a.model.editor.protyle.notebookId,a.model.editor.protyle.path),e.lastSelectedElement=e.element.querySelector(".b3-list-item--focus"))}t.toggleModel("file",!0)});var Q0=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const It={element:void 0,genHTML:()=>`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance4}
        <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
</div>
<div class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-center fn__flex-1">${window.siyuan.languages.theme}</div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200${Ne()?" fn__none":""}" id="appearanceOpenTheme">
            <svg><use xlink:href="#iconFolder"></use></svg>
            ${window.siyuan.languages.appearance9}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme11}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeLight">
          ${ws(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme12}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeDark">
           ${ws(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
        </select>
    </div>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1">
            ${window.siyuan.languages.icon}
        </div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200${Ne()?" fn__none":""}" id="appearanceOpenIcon">
            <svg><use xlink:href="#iconFolder"></use></svg>
            ${window.siyuan.languages.appearance8}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.theme2}</div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="icon">
            ${ws(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
        </select>
    </div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__block">
        <div>
            ${window.siyuan.languages.appearance1}
        </div>
        <div class="fn__hr"></div>
        <div class="fn__flex config__item">
            <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance2}</div>
            <span class="fn__space"></span>
            <select id="codeBlockThemeLight" class="b3-select fn__size200">
                ${ws(p.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE,window.siyuan.config.appearance.codeBlockThemeLight)}
            </select>
        </div>
        <div class="fn__hr"></div>
        <div class="fn__flex config__item">
            <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance3}</div>
            <span class="fn__space"></span>
            <select id="codeBlockThemeDark" class="b3-select fn__size200">
                ${ws(p.SIYUAN_CONFIG_APPEARANCE_DARK_CODE,window.siyuan.config.appearance.codeBlockThemeDark)}
            </select>
        </div>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.language}
        <div class="b3-label__text">${window.siyuan.languages.language1}</div>
    </div>
    <span class="fn__space"></span>
    <select id="lang" class="b3-select fn__flex-center fn__size200">${AA(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
</div>
<div class="b3-label config__item${Ne()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.customEmoji}
        <div class="b3-label__text">${window.siyuan.languages.customEmojiTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="appearanceOpenEmoji">
        <svg><use xlink:href="#iconFolder"></use></svg>
        ${window.siyuan.languages.showInFolder}
    </button>
</div>
<div class="b3-label fn__flex config__item">
   <div class="fn__flex-1">
        ${window.siyuan.languages.resetLayout}
        <div class="b3-label__text">${window.siyuan.languages.appearance6}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="resetLayout">
        <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.reset}
    </button>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.codeSnippet}
        </div>
        <span class="fn__space"></span>
        <a class="b3-button b3-button--outline fn__flex-center fn__size200${window.siyuan.config.lang!=="zh_CN"?" fn__none":""}" target="_blank" href="https://ld246.com/tag/code-snippet">
            <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.visitCommunityShare}
        </a>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.codeSnippetTip}
        </div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="codeSnippet">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.appearance16}
    <div class="fn__hr"></div>
    <label class="fn__flex">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
           ${window.siyuan.languages.appearance17}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" id="hideStatusBar" type="checkbox"${window.siyuan.config.appearance.hideStatusBar?" checked":""}>
    </label>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.appearance18}
        </div>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="statusBarSetting">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance10}
        <div class="b3-label__text">${window.siyuan.languages.appearance11}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeButtonBehavior" type="checkbox"${window.siyuan.config.appearance.closeButtonBehavior===0?"":" checked"}>
</label>`,_send:t=>{const e=It.element.querySelector("#themeLight").value,n=It.element.querySelector("#themeDark").value,a=parseInt(It.element.querySelector("#mode").value),i=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";A("/api/setting/setAppearance",{icon:It.element.querySelector("#icon").value,mode:a===2?i==="light"?0:1:a,modeOS:a===2,codeBlockThemeDark:It.element.querySelector("#codeBlockThemeDark").value,codeBlockThemeLight:It.element.querySelector("#codeBlockThemeLight").value,themeDark:n,themeLight:e,darkThemes:window.siyuan.config.appearance.darkThemes,lightThemes:window.siyuan.config.appearance.lightThemes,icons:window.siyuan.config.appearance.icons,lang:It.element.querySelector("#lang").value,closeButtonBehavior:It.element.querySelector("#closeButtonBehavior").checked?1:0,hideStatusBar:It.element.querySelector("#hideStatusBar").checked,statusBar:{msgTaskDatabaseIndexCommitDisabled:t?t.msgTaskDatabaseIndexCommitDisabled:window.siyuan.config.appearance.statusBar.msgTaskDatabaseIndexCommitDisabled,msgTaskHistoryDatabaseIndexCommitDisabled:t?t.msgTaskHistoryDatabaseIndexCommitDisabled:window.siyuan.config.appearance.statusBar.msgTaskHistoryDatabaseIndexCommitDisabled,msgTaskAssetDatabaseIndexCommitDisabled:t?t.msgTaskAssetDatabaseIndexCommitDisabled:window.siyuan.config.appearance.statusBar.msgTaskAssetDatabaseIndexCommitDisabled,msgTaskHistoryGenerateFileDisabled:t?t.msgTaskHistoryGenerateFileDisabled:window.siyuan.config.appearance.statusBar.msgTaskHistoryGenerateFileDisabled}},s=>Q0(void 0,null,function*(){if((s.data.mode!==window.siyuan.config.appearance.mode||s.data.mode===window.siyuan.config.appearance.mode&&(s.data.mode===0&&window.siyuan.config.appearance.themeLight!==s.data.themeLight||s.data.mode===1&&window.siyuan.config.appearance.themeDark!==s.data.themeDark)||s.data.lang!==window.siyuan.config.appearance.lang)&&pd(),window.siyuan.config.appearance.themeJS&&(s.data.mode!==window.siyuan.config.appearance.mode||s.data.mode===window.siyuan.config.appearance.mode&&(s.data.mode===0&&window.siyuan.config.appearance.themeLight!==s.data.themeLight||s.data.mode===1&&window.siyuan.config.appearance.themeDark!==s.data.themeDark)))if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(l){console.error("destroyTheme error: "+l)}else{Un({errorExit:!1,cb(){window.location.reload()}});return}It.onSetAppearance(s.data),s.data.hideStatusBar?document.getElementById("status").classList.add("fn__none"):document.getElementById("status").classList.remove("fn__none"),pb()}))},bindEvent:()=>{It.element.querySelector("#statusBarSetting").addEventListener("click",()=>{const t=new $e({width:"360px",height:"80vh",title:"\u{1F507} "+window.siyuan.languages.appearance18,content:`<div class="fn__hr"></div>
<div class="b3-label">
    ${window.siyuan.languages.statusBarMsgPushTip}
    <div class="fn__hr"></div>
    <div class="b3-tab-bar b3-list b3-list--background">
        <label class="b3-list-item">
            <div class="fn__flex-1 ft__on-surface">
               ${window.siyuan.languages._taskAction["task.database.index.commit"]}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch fn__flex-center" id="msgTaskDatabaseIndexCommitDisabled" type="checkbox"${window.siyuan.config.appearance.statusBar.msgTaskDatabaseIndexCommitDisabled?"":" checked"}>
        </label>    
        <label class="b3-list-item">
            <div class="fn__flex-1 ft__on-surface">
               ${window.siyuan.languages._taskAction["task.asset.database.index.commit"]}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch fn__flex-center" id="msgTaskAssetDatabaseIndexCommitDisabled" type="checkbox"${window.siyuan.config.appearance.statusBar.msgTaskAssetDatabaseIndexCommitDisabled?"":" checked"}>
        </label>
        <label class="b3-list-item">
            <div class="fn__flex-1 ft__on-surface">
               ${window.siyuan.languages._taskAction["task.history.database.index.commit"]}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch fn__flex-center" id="msgTaskHistoryDatabaseIndexCommitDisabled" type="checkbox"${window.siyuan.config.appearance.statusBar.msgTaskHistoryDatabaseIndexCommitDisabled?"":" checked"}>
        </label>
        <label class="b3-list-item">
            <div class="fn__flex-1 ft__on-surface">
               ${window.siyuan.languages._taskAction["task.history.generateFile"]}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch fn__flex-center" id="msgTaskHistoryGenerateFileDisabled" type="checkbox"${window.siyuan.config.appearance.statusBar.msgTaskHistoryGenerateFileDisabled?"":" checked"}>
        </label>
    </div>
</div>`});t.element.querySelectorAll(".b3-switch").forEach(e=>{e.addEventListener("change",()=>{It._send({msgTaskDatabaseIndexCommitDisabled:!t.element.querySelector("#msgTaskDatabaseIndexCommitDisabled").checked,msgTaskAssetDatabaseIndexCommitDisabled:!t.element.querySelector("#msgTaskAssetDatabaseIndexCommitDisabled").checked,msgTaskHistoryDatabaseIndexCommitDisabled:!t.element.querySelector("#msgTaskHistoryDatabaseIndexCommitDisabled").checked,msgTaskHistoryGenerateFileDisabled:!t.element.querySelector("#msgTaskHistoryGenerateFileDisabled").checked})})})}),It.element.querySelector("#codeSnippet").addEventListener("click",()=>{xA()}),It.element.querySelector("#resetLayout").addEventListener("click",()=>{Re("\u26A0\uFE0F "+window.siyuan.languages.reset,window.siyuan.languages.appearance6,()=>{BS()})}),It.element.querySelectorAll("select").forEach(t=>{t.addEventListener("change",()=>{It._send()})}),It.element.querySelectorAll(".b3-switch").forEach(t=>{t.addEventListener("change",()=>{It._send()})})},onSetAppearance(t){var e;if(t.lang!==window.siyuan.config.appearance.lang){Un({cb(){window.location.reload()},errorExit:!1});return}if(window.siyuan.config.appearance=t,It.element){const n=It.element.querySelector("#mode");n&&(t.modeOS?n.value="2":n.value=t.mode===0?"0":"1");const a=It.element.querySelector("#themeLight");a&&(a.innerHTML=ws(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight));const i=It.element.querySelector("#themeDark");i&&(i.innerHTML=ws(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark));const s=It.element.querySelector("#icon");s&&(s.innerHTML=ws(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon))}Ip(t),(e=document.querySelector("#barMode use"))==null||e.setAttribute("xlink:href",`#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}`)}};var mb=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Ip=t=>{var e;const n=document.getElementsByTagName("html")[0];n.setAttribute("lang",window.siyuan.config.appearance.lang),n.setAttribute("data-theme-mode",OE()),n.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),n.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&a==="light"||window.siyuan.config.appearance.mode===0&&a==="dark")&&(A("/api/system/setAppearanceMode",{mode:a==="light"?0:1}),window.siyuan.config.appearance.mode=a==="light"?0:1);const i=document.getElementById("themeDefaultStyle"),s=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${p.SIYUAN_VERSION}`;if(i){if(!i.getAttribute("href").startsWith(s)){const h=document.createElement("link");new Promise(b=>{h.rel="stylesheet",h.href=s,h.onload=b,i.parentNode.insertBefore(h,i)}).then(()=>{i.remove(),h.id="themeDefaultStyle"})}}else Ec(s,"themeDefaultStyle");const l=document.getElementById("themeStyle");if(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight"){const h=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.css?v=${t.themeVer}`;l?l.getAttribute("href").startsWith(h)||l.setAttribute("href",h):Ec(h,"themeStyle")}else l&&l.remove();Oe().graph.forEach(h=>{h.searchGraph(!1)});const o=window.siyuan.config.appearance.mode===0?window.siyuan.storage[p.LOCAL_PDFTHEME].light:window.siyuan.storage[p.LOCAL_PDFTHEME].dark;document.querySelectorAll(".pdf__outer").forEach(h=>{const b=h.querySelector("#pdfDark"),y=h.querySelector("#pdfLight");o==="dark"?(h.classList.add("pdf__outer--dark"),y.classList.remove("toggled"),b.classList.add("toggled")):(h.classList.remove("pdf__outer--dark"),y.classList.add("toggled"),b.classList.remove("toggled"))}),!((e=window.webkit)!=null&&e.messageHandlers)&&!window.JSAndroid&&!window.JSHarmony&&"serviceWorker"in window.navigator&&"caches"in window&&"fetch"in window&&navigator.serviceWorker&&document.head.insertAdjacentHTML("afterbegin",`<meta name="theme-color" content="${getComputedStyle(document.body).getPropertyValue("--b3-toolbar-background").trim()}">`),NE();const r=document.getElementById("themeScript"),c=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.js?v=${t.themeVer}`;r?r.getAttribute("src").startsWith(c)||(r.remove(),jt(c,"themeScript")):jt(c,"themeScript");const d=["ant","material"].includes(t.icon),u=document.getElementById("iconScript"),m=document.getElementById("iconDefaultScript"),f=`/appearance/icons/${d?t.icon:"material"}/icon.js?v=${p.SIYUAN_VERSION}`,g=`/appearance/icons/${t.icon}/icon.js?v=${t.iconVer}`;if(d&&m&&m.getAttribute("src").startsWith(f)||!d&&u&&u.getAttribute("src").startsWith(g)){d&&(u==null||u.remove(),Array.from(document.body.children).forEach(h=>{h.tagName==="svg"&&!h.getAttribute("data-name")&&!["iconsMaterial","iconsAnt"].includes(h.id)&&h.remove()}));return}m&&!m.getAttribute("src").startsWith(f)&&(m.remove(),t.icon==="ant"?document.querySelectorAll("#iconsMaterial").forEach(h=>{h.remove()}):document.querySelectorAll("#iconsAnt").forEach(h=>{h.remove()})),jt(f,"iconDefaultScript").then(()=>{u==null||u.remove(),d||jt(g,"iconScript").then(()=>{Array.from(document.body.children).forEach((h,b)=>{h.tagName==="svg"&&b!==0&&!h.getAttribute("data-name")&&!["iconsMaterial","iconsAnt"].includes(h.id)&&h.remove()})})})},eC=()=>{const t=document.getElementById("loading");t&&setTimeout(()=>{t.remove()},160),HE(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{const n=e.matches?"dark":"light";HE(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||A("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>mb(void 0,null,function*(){if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(i){console.error("destroyTheme error: "+i)}else{Un({cb(){window.location.reload()},errorExit:!1});return}window.siyuan.config.appearance=a.data.appearance,Ip(a.data.appearance)})))})},td=(t=!0,e="../../../")=>mb(void 0,null,function*(){let n;if(Mt()||Ha()||If()?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(${e}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1fa8f;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+21a9, U+21aa, U+2122, U+2194-2199, U+23cf, U+25b6, U+25c0, U+25fb, U+25fc, U+25aa, U+25ab, U+2600-2603,
  U+260e, U+2611, U+261d, U+2639, U+263a, U+2640, U+2642, U+2660, U+2663, U+2665, U+2666, U+2668, U+267b, U+26aa, U+26ab, 
  U+2702, U+2708, U+2934, U+2935, U+1f170, U+1f171, U+1f17e, U+1f17f, U+1f202, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, 
  U+1f251, U+1fae4, U+2049, U+203c, U+3030, U+303d, U+24c2, U+26a0, U+26a1, U+26be, U+27a1, U+2b05-2b07, U+3297, U+3299, U+a9, U+ae;
  size-adjust: 115%;
}
@font-face {
  font-family: "Emojis";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 115%;
}`:(yield R_())?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(${e}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}`:n=`@font-face {
  font-family: "Emojis Reset";
  src: url(${e}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1f170-1f171, U+1f17e, U+1f17f, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, U+1f251, U+1f32b, U+1f3bc,
  U+1f411, U+1f42d, U+1f42e, U+1f431, U+1f435, U+1f441, U+1f4a8, U+1f4ab, U+1f525, U+1f600-1f60d, U+1f60f-1f623,
  U+1f625-1f62b, U+1f62d-1f63f, U+1F643, U+1F640, U+1f79, U+1f8f, U+1fa79, U+1fae4, U+1fae9, U+1fac6, U+1fabe, U+1fadf,
  U+200d, U+203c, U+2049, U+2122, U+2139, U+2194-2199, U+21a9, U+21aa, U+23cf, U+25aa, U+25ab, U+25b6, U+25c0, U+25fb-25fe,
  U+2611, U+2615, U+2618, U+261d, U+2620, U+2622, U+2623, U+2626, U+262a, U+262e, U+2638-263a, U+2640, U+2642, U+2648-2653,
  U+265f, U+2660, U+2663, U+2665, U+2666, U+267b, U+267e, U+267f, U+2692-2697, U+2699, U+269b, U+269c, U+26a0, U+26a1,
  U+26a7, U+26aa, U+26ab, U+26b0, U+26b1, U+2702, U+2708, U+2709, U+270c, U+270d, U+2712, U+2714, U+2716, U+271d, U+2733,
  U+2734, U+2744, U+2747, U+2763, U+2764, U+2934-2935, U+3030, U+303d, U+3297, U+3299, U+fe0f, U+e50a, U+a9, U+ae;
  size-adjust: 92%;
}
@font-face {
  font-family: "Emojis";
  src: url(${e}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol"),
  local("Apple Color Emoji"),
  local("Twemoji Mozilla"),
  local("Noto Color Emoji"),
  local("Android Emoji"),
  local("EmojiSymbols");
  size-adjust: 92%;
}`,n+=`
:root { --b3-font-size-editor: ${window.siyuan.config.editor.fontSize}px }
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }${window.siyuan.config.editor.justify?`
.protyle-wysiwyg [data-node-id] { text-align: justify }`:""}`,window.siyuan.config.editor.rtl&&(n+=`
.protyle-title__input,
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {direction: rtl}
.protyle-wysiwyg [data-node-id].li > .protyle-action {
    right: 0;
    left: auto;
    direction: rtl;
}
.protyle-wysiwyg [data-node-id].li > [data-node-id] {
    margin-right: 34px;
    margin-left: 0;
}
.protyle-wysiwyg [data-node-id].li::before {
    right: 17px;
    left: auto;
}
.b3-typography table:not([style*="text-align: left"]) {
  margin-left: auto;
}`),window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "Emojis Additional", "Emojis Reset", "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),t){const a=document.getElementById("siyuanStyle");a?a.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n}),NE=(t=p.PROTYLE_CDN)=>{const e=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,p.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,p.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${t}/js/highlight.js/styles/${n}.min.css?v=11.11.1`;e?e.href.includes(a)||(e.remove(),Ec(a,"protyleHljsStyle")):Ec(a,"protyleHljsStyle")},hb=t=>{let e=t;t===2&&(window.matchMedia("(prefers-color-scheme: dark)").matches?e=1:e=0),A("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:e,modeOS:t===2}),n=>mb(void 0,null,function*(){if((n.data.mode!==window.siyuan.config.appearance.mode||n.data.mode===window.siyuan.config.appearance.mode&&(n.data.mode===0&&window.siyuan.config.appearance.themeLight!==n.data.themeLight||n.data.mode===1&&window.siyuan.config.appearance.themeDark!==n.data.themeDark))&&pd(),window.siyuan.config.appearance.themeJS&&(n.data.mode!==window.siyuan.config.appearance.mode||n.data.mode===window.siyuan.config.appearance.mode&&(n.data.mode===0&&window.siyuan.config.appearance.themeLight!==n.data.themeLight||n.data.mode===1&&window.siyuan.config.appearance.themeDark!==n.data.themeDark)))if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(a){console.error("destroyTheme error: "+a)}else{Un({errorExit:!1,cb(){window.location.reload()}});return}It.onSetAppearance(n.data)}))},tC=t=>{if(t.startsWith("#"))return t;let e;const n=t.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),a=(n&&n[4]||"").trim();let i=n?(n[1]|256).toString(16).slice(1)+(n[2]|256).toString(16).slice(1)+(n[3]|256).toString(16).slice(1):t;return a!==""?e=a:e=1,e=(e*255|256).toString(16).slice(1),i=i+e,i},HE=t=>{($n()||ht()||bt())&&setTimeout(()=>{const e=tC(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(t==="dark"?n=1:n=0),$n()?window.webkit.messageHandlers.changeStatusBar.postMessage((e||(n===0?"#fff":"#1e1e1e"))+" "+n):ht()?window.JSAndroid.changeStatusBarColor(e,n):bt()&&window.JSHarmony.changeStatusBarColor(e,n)},500)},OE=()=>{const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?t:window.siyuan.config.appearance.mode===0?"light":"dark"},rt=(t,e=p.PROTYLE_CDN,n=1)=>{let a,i=!1;t.classList.contains("code-block")?a=t.querySelectorAll(".hljs"):t.classList.contains("item__readme")?(a=t.querySelectorAll("pre code"),a.forEach(s=>{s.parentElement.setAttribute("linenumber","false")})):t.classList.contains("b3-typography")?(a=t.querySelectorAll(".code-block code"),i=!0):a=t.querySelectorAll(".code-block .hljs"),a.length!==0&&(NE(e),jt(`${e}/js/highlight.js/highlight.min.js?v=11.11.1`,"protyleHljsScript").then(()=>{jt(`${e}/js/highlight.js/third-languages.js?v=2.0.1`,"protyleHljsThirdScript").then(()=>{a.forEach(s=>{const l=s.parentElement.querySelectorAll(".protyle-icon");if(l.length===2&&(l[0].setAttribute("aria-label",window.siyuan.languages.copy),l[1].setAttribute("aria-label",window.siyuan.languages.more)),s.getAttribute("data-render")==="true")return;const o=s.querySelector("wbr");let r=0;if(o){let h=o.previousSibling;for(;h;){for(r+=h.textContent.length;!h.previousSibling&&h.parentElement.tagName!=="DIV";)h=h.parentElement;h=h.previousSibling}o.remove()}let c;i?c=s.parentElement.getAttribute("data-language"):s.previousElementSibling?c=s.previousElementSibling.firstElementChild.textContent:c=s.className.replace("language-",""),window.hljs.getLanguage(c)||(c="plaintext"),s.classList.add("hljs"),s.setAttribute("data-render","true");const d=s.parentElement.getAttribute("linewrap"),u=s.parentElement.getAttribute("ligatures"),m=s.parentElement.getAttribute("linenumber"),f=s.lastElementChild?s.lastElementChild:s;d==="true"||d!=="false"&&window.siyuan.config.editor.codeLineWrap?(f.style.setProperty("white-space","pre-wrap"),f.style.setProperty("word-break","break-word")):(f.style.setProperty("white-space","pre"),f.style.setProperty("word-break","initial")),u==="true"||u!=="false"&&window.siyuan.config.editor.codeLigatures?f.style.fontVariantLigatures="normal":f.style.fontVariantLigatures="none";const g=f.textContent;s.firstElementChild&&(!i&&(m==="true"||m!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(s.firstElementChild.className="protyle-linenumber__rows",s.firstElementChild.setAttribute("contenteditable","false"),or(s,n),s.style.display=""):(s.firstElementChild.className="fn__none",s.firstElementChild.innerHTML="",f.style.paddingLeft="",s.style.display="block")),f.innerHTML=window.hljs.highlight(g+(g.endsWith(`
`)?"":`
`),{language:c,ignoreIllegals:!0}).value,o&&getSelection().rangeCount>0&&ha(s,r,r)})})}))},or=(t,e=1)=>{const n=t.parentElement.getAttribute("lineNumber");if(n==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&n!=="true")return;t.parentElement.style.lineHeight=`${((parseInt(t.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const a=t.lastElementChild,i=a.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);i[i.length-1]===""&&i.length>1&&i.pop(),t.firstElementChild.innerHTML=`<span>${i.length}</span>`,a.style.paddingLeft=`${t.firstElementChild.clientWidth+16}px`;let s="";if(a.style.wordBreak==="break-word"){const l=window.getComputedStyle(a),o=document.createElement("div");o.className="hljs",o.setAttribute("style",`padding-left:${a.style.paddingLeft};
width: ${a.getBoundingClientRect().width/e}px;
white-space:${l.whiteSpace};
word-break:${l.wordBreak};
font-variant-ligatures:${l.fontVariantLigatures};
padding-right:0;max-height: none;box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),o.setAttribute("contenteditable","true"),t.insertAdjacentElement("afterend",o),i.map(r=>{o.textContent=r.trim()?r:"<br>",s+=`<span style="height:${o.clientHeight}px"></span>`}),o.remove()}else s="<span></span>".repeat(i.length);if(t.firstElementChild.innerHTML=s,t.scrollHeight>t.clientHeight&&getSelection().rangeCount>0){const l=getSelection().getRangeAt(0);if(t.contains(l.startContainer)){const o=document.createElement("br");l.insertNode(o),o.scrollIntoView({block:"nearest"}),o.remove()}}};var bb=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});let ma=[],rr=!1;const $p=(t,e)=>bb(void 0,null,function*(){ce(["gutter","toolbar","hint","util","dialog"],e.protyle);let n;if(!document.contains(e.protyle.element)){if(!(yield Ae("/api/block/checkBlockExist",{id:e.protyle.block.rootID})).data)return!1;let i;const s=document.querySelector(".layout__wnd--active");if(s&&(i=on(s.getAttribute("data-id"))),i||(i=br(window.siyuan.layout.centerLayout)),i){const l=yield Ae("/api/block/getBlockInfo",{id:e.id});if(l.code===3){de(l.msg);return}const o=new Dt({title:l.data.rootTitle,docIcon:l.data.rootIcon,callback(c){const d=xc(e.protyle,!0);d.rootId=e.protyle.block.rootID,d.focusId=e.id,d.focusStart=e.position.start,d.focusEnd=e.position.end,window.siyuan.storage[p.LOCAL_FILEPOSITION][e.protyle.block.rootID]=d;const u=new Ot({app:t,tab:c,blockId:e.zoomId||e.id||e.protyle.block.rootID,rootId:e.protyle.block.rootID,action:e.zoomId?[p.CB_GET_FOCUS,p.CB_GET_SCROLL,p.CB_GET_ALL,p.CB_GET_UNUNDO]:[p.CB_GET_FOCUS,p.CB_GET_SCROLL,p.CB_GET_UNUNDO]});c.addModel(u)}});if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let c;i.children.forEach(d=>{d.headElement&&d.headElement.classList.contains("item--unupdate")&&!d.headElement.classList.contains("item--pin")&&(c=d)}),i.addTab(o),c&&i.removeTab(c.id)}else i.addTab(o);i.showHeading();const r=o.model.editor.protyle;return e.protyle=r,ma.forEach(c=>{!document.contains(c.protyle.element)&&c.protyle.block.rootID===l.data.rootID&&(c.protyle=r)}),window.siyuan.backStack.forEach(c=>{!document.contains(c.protyle.element)&&c.protyle.block.rootID===l.data.rootID&&(c.protyle=r)}),l.data.rootID===e.id?ha(r.title.editElement,e.position.start,e.position.end):(Array.from(r.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(c=>{if(!G(c))return n=c,!0}),ha(fe(n),e.position.start,e.position.end),Ye(r)),!0}else return!1}if(e.protyle.block.rootID===e.id)return e.protyle.title.editElement.getBoundingClientRect().height===0&&(e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),e.protyle.toolbar.range=void 0),ha(e.protyle.title.editElement,e.position.start,e.position.end),!0;if(Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(a=>{if(!G(a))return n=a,!0}),n&&(!e.zoomId||e.zoomId&&e.zoomId===e.protyle.block.id))return n.getBoundingClientRect().height===0&&e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),ha(fe(n),e.position.start,e.position.end),Ye(e.protyle),Oe().outline.forEach(a=>{a.blockId===e.protyle.block.rootID&&a.setCurrent(n)}),!0;if(e.protyle.element.parentElement)return(yield Ae("/api/block/checkBlockExist",{id:e.id})).data?!n&&!e.zoomId&&!e.protyle.scroll.element.classList.contains("fn__none")?(A("/api/filetree/getDoc",{id:e.id,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{kt({data:i,protyle:e.protyle,afterCB(){Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(s=>{if(!G(s))return n=s,!0}),n&&(Oe().outline.forEach(s=>{s.blockId===e.protyle.block.rootID&&s.setCurrent(n)}),ha(fe(n),e.position.start,e.position.end),Ye(e.protyle))}})}),!0):(dn({protyle:e.protyle,id:e.zoomId||e.protyle.block.rootID,isPushBack:!1,callback:()=>{Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(!G(i))return n=i,!0}),n&&(Oe().outline.forEach(i=>{i.blockId===e.protyle.block.rootID&&i.setCurrent(n)}),ha(fe(n),e.position.start,e.position.end),Ye(e.protyle))}}),!0):(getSelection().rangeCount>0&&ne(getSelection().getRangeAt(0)),!1)}),Mp=t=>bb(void 0,null,function*(){var e,n;if(window.siyuan.backStack.length===0){ma.length>0&&(yield $p(t,ma[ma.length-1]));return}(e=document.querySelector("#barForward"))==null||e.classList.remove("toolbar__item--disabled"),!rr&&document.contains(window.siyuan.backStack[window.siyuan.backStack.length-1].protyle.element)&&ma.push(window.siyuan.backStack.pop());let a=window.siyuan.backStack.pop();for(;a;)if(yield $p(t,a)){ma.push(a);break}else a=window.siyuan.backStack.pop();rr=!0,window.siyuan.backStack.length===0&&((n=document.querySelector("#barBack"))==null||n.classList.add("toolbar__item--disabled"))}),Pp=t=>bb(void 0,null,function*(){var e,n;if(ma.length===0){window.siyuan.backStack.length>0&&(yield $p(t,window.siyuan.backStack[window.siyuan.backStack.length-1]));return}(e=document.querySelector("#barBack"))==null||e.classList.remove("toolbar__item--disabled"),rr&&window.siyuan.backStack.push(ma.pop());let a=ma.pop();for(;a;)if(yield $p(t,a)){window.siyuan.backStack.push(a);break}else a=ma.pop();rr=!1,ma.length===0&&((n=document.querySelector("#barForward"))==null||n.classList.add("toolbar__item--disabled"))}),cr=(t,e,n)=>{var a,i;if(!t.model||(!n&&e&&(n=B(e.startContainer)),!n))return;let s;if(n.classList.contains("protyle-title__input")?s=n:s=fe(n),s){const l=_t(s,void 0,e),o=n.getAttribute("data-node-id")||t.block.rootID,r=window.siyuan.backStack[window.siyuan.backStack.length-1];r&&r.id===o&&(t.block.showAll&&r.zoomId===t.block.id||!r.zoomId&&!t.block.showAll)?r.position=l:(ma.length>0&&(rr&&window.siyuan.backStack.push(ma.pop()),ma=[],(a=document.querySelector("#barForward"))==null||a.classList.add("toolbar__item--disabled")),window.siyuan.backStack.push({position:l,id:o,protyle:t,zoomId:t.block.showAll?t.block.id:void 0}),window.siyuan.backStack.length>p.SIZE_UNDO&&window.siyuan.backStack.shift(),rr=!1),window.siyuan.backStack.length>1&&((i=document.querySelector("#barBack"))==null||i.classList.remove("toolbar__item--disabled"))}},kt=t=>{if(t.action||(t.action=[]),t.protyle.wysiwyg.element.removeAttribute("data-top"),t.data.code===1){t.action.includes(p.CB_GET_APPEND)||(t.protyle.model?t.protyle.model.parent.parent.removeTab(t.protyle.model.parent.id,!1):t.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(t.data.code!==3&&(t.protyle.notebookId=t.data.data.box,t.protyle.path=t.data.data.path,!(t.data.data.eof&&!t.scrollAttr&&(t.action.includes(p.CB_GET_BEFORE)?t.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):t.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),t.data.data.mode!==4)))){if(ce(["gutterOnly"],t.protyle),t.protyle.block.parentID=t.data.data.parentID,t.protyle.block.parent2ID=t.data.data.parent2ID,t.protyle.block.rootID=t.data.data.rootID,t.protyle.block.showAll=t.action.includes(p.CB_GET_ALL),t.protyle.block.mode=t.data.data.mode,t.protyle.block.blockCount=t.data.data.blockCount,t.protyle.block.scroll=t.data.data.scroll,t.protyle.block.action=t.action,t.action.includes(p.CB_GET_UNCHANGEID)||(t.protyle.block.id=t.data.data.id,t.protyle.scroll.lastScrollTop=0,t.protyle.contentElement.scrollTop=0,t.protyle.wysiwyg.element.setAttribute("data-doc-type",t.data.data.type)),!(t.protyle.options.render.title&&t.protyle.title.element.getAttribute("data-render")!=="true")){if(t.action.includes(p.CB_GET_APPEND)||t.action.includes(p.CB_GET_BEFORE)||t.action.includes(p.CB_GET_HTML)){t.protyle.options.render.title&&t.protyle.options.render.hideTitleOnZoom&&(t.protyle.block.showAll?t.protyle.title.element.classList.add("fn__none"):t.protyle.title.element.classList.remove("fn__none")),BE({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,updateReadonly:t.updateReadonly,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),ad(t.protyle);return}}A("/api/block/getDocInfo",{id:t.protyle.block.rootID},e=>{t.protyle.options.render.title?t.protyle.title.render(t.protyle,e):(t.protyle.options.render.background&&t.protyle.background.render(e.data.ial,t.protyle.block.rootID),t.protyle.wysiwyg.renderCustom(e.data.ial)),BE({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,updateReadonly:t.updateReadonly,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),ad(t.protyle)})}},BE=(t,e)=>{var n;if(e.contentElement.classList.contains("fn__none")&&e.wysiwyg.element.innerHTML!=="")return;const i=new DOMParser().parseFromString(t.content,"text/html");i.querySelectorAll("[data-inline-memo-content]").forEach(o=>{const r=o.getAttribute("data-inline-memo-content");r&&o.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(r))}),t.content=i.body.innerHTML;const s=e.contentElement.clientHeight*8,l=typeof t.updateReadonly=="undefined"?e.wysiwyg.element.innerHTML==="":t.updateReadonly;if(t.action.includes(p.CB_GET_APPEND)){if(!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad&&e.contentElement.scrollHeight>s){let o=e.wysiwyg.element.firstElementChild;const r=[];for(;e.wysiwyg.element.childElementCount>2&&r&&e.wysiwyg.element.lastElementChild!==o&&e.contentElement.scrollHeight-o.offsetTop>s;){r.push(o);o=o.nextElementSibling}const c=o.getBoundingClientRect().top;r.forEach(d=>{d.remove()}),e.contentElement.scrollTop=e.contentElement.scrollTop+(o.getBoundingClientRect().top-c)-1,e.scroll.lastScrollTop=e.contentElement.scrollTop,ce(["toolbar"],e)}e.wysiwyg.element.insertAdjacentHTML("beforeend",t.content)}else if(t.action.includes(p.CB_GET_BEFORE)){const o=e.wysiwyg.element.firstElementChild,r=o.getBoundingClientRect().top;if(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.content),e.contentElement.scrollTop=e.contentElement.scrollTop+(o.getBoundingClientRect().top-r),e.scroll.lastScrollTop=e.contentElement.scrollTop,!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad){const c=[];let d=e.wysiwyg.element.childElementCount,u=e.contentElement.scrollHeight,m=e.wysiwyg.element.lastElementChild;for(;d>2&&u>s&&m.getBoundingClientRect().top>window.innerHeight;)c.push(m),m=m.previousElementSibling,d--,u-=m.clientHeight+8;c.forEach(f=>{f.remove()}),ce(["toolbar"],e)}}else e.wysiwyg.element.innerHTML=t.content;if(!e.block.showAll&&e.wysiwyg.element.childElementCount===1&&e.wysiwyg.element.firstElementChild.classList.contains("p")){const o=fe(e.wysiwyg.element.firstElementChild);o&&o.textContent===""&&(o.classList.add("protyle-wysiwyg--empty"),o.setAttribute("placeholder",window.siyuan.languages.emptyPlaceholder))}if(t.action.includes(p.CB_GET_BACKLINK)&&vE(t.expand,e.wysiwyg.element),Ct(e.wysiwyg.element),rt(e.wysiwyg.element),Vt(e.wysiwyg.element,e),We(e,e.wysiwyg.element),!t.action.includes(p.CB_GET_HISTORY)){if(e.options.render.scroll&&e.scroll.update(e),t.action.includes(p.CB_GET_FOCUSFIRST)){const o=e.wysiwyg.element.offsetTop-16;ra(e,o,p.TIMEOUT_INPUT),e.contentElement.scrollTop=o}if(t.isSyncing?RE(e):(e.breadcrumb&&(e.breadcrumb.element.nextElementSibling.textContent=""),e.element.removeAttribute("disabled-forever"),t.action.includes(p.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly?nd(e):qE(e,l)),nC(e,t.action,t.scrollAttr),t.action.includes(p.CB_GET_SETID)&&(e.block.id=e.block.rootID,e.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),(n=e.options.defIds)==null||n.forEach(o=>{e.wysiwyg.element.querySelectorAll(`[data-id="${o}"]`).forEach(r=>{r.classList.add("def--mark")})}),e.options.defIds=[],t.action.includes(p.CB_GET_APPEND)||t.action.includes(p.CB_GET_BEFORE)){e.app.plugins.forEach(o=>{o.eventBus.emit("loaded-protyle-dynamic",{protyle:e,position:t.action.includes(p.CB_GET_APPEND)?"afterend":"beforebegin"})});return}e.options.render.breadcrumb&&(e.breadcrumb.toggleExit(!t.action.includes(p.CB_GET_ALL)),e.breadcrumb.render(e)),t.afterCB&&t.afterCB(),t.scrollAttr&&!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("block__edit")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&e.contentElement.scrollHeight>0&&!t.action.includes(p.CB_GET_FOCUSFIRST)&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&A("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{kt({data:o,protyle:e,action:[p.CB_GET_APPEND,p.CB_GET_UNCHANGEID]})}),t.scrollAttr&&!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("fn__none")&&e.scroll.updateIndex(e,t.scrollAttr.startId,o=>{o>1&&e.block.blockCount>1&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&de(window.siyuan.languages.scrollGetMore)}),e.app.plugins.forEach(o=>{o.eventBus.emit("loaded-protyle-static",{protyle:e})})}},RE=t=>{Sa(t),t.breadcrumb&&!Y()?t.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:de(window.siyuan.languages._kernel[81]),t.element.setAttribute("disabled-forever","true")},Sa=t=>{if(window.siyuan.menus.menu.remove(),ce(["gutter","toolbar","select","hint","util"],t),t.disabled=!0,t.title&&t.title.editElement&&(t.title.editElement.setAttribute("contenteditable","false"),t.title.editElement.style.userSelect="text"),t.background&&(t.background.element.classList.remove("protyle-background--enable"),t.background.element.classList.remove("protyle-background--mobileshow")),t.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(e=>{e.classList.remove("protyle-icons--show")}),t.wysiwyg.element.querySelectorAll(".av__gallery-fields--edit").forEach(e=>{e.classList.remove("av__gallery-fields--edit")}),t.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(e=>{var n;e.classList.add("fn__none"),e.classList.contains("protyle-icon--first")&&((n=e.nextElementSibling)==null||n.classList.add("protyle-icon--first"))}),t.wysiwyg.element.style.userSelect="text",t.wysiwyg.element.setAttribute("contenteditable","false"),t.wysiwyg.element.setAttribute("data-readonly","true"),t.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(e=>{e.setAttribute("contenteditable","false")}),t.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(e=>{e.setAttribute("draggable","false")}),t.breadcrumb){const e=t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]');e.querySelector("use").setAttribute("xlink:href","#iconLock"),e.setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit),e.setAttribute("data-subtype","lock");const n=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&!n.classList.contains("fn__none")&&(n.classList.add("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}cn()},nd=t=>{if(t.element.getAttribute("disabled-forever")==="true")return;t.disabled=!1,Y()?document.getElementById("toolbarName").removeAttribute("readonly"):(t.wysiwyg.element.setAttribute("contenteditable","true"),t.wysiwyg.element.style.userSelect=""),t.wysiwyg.element.setAttribute("data-readonly","false"),t.title&&t.title.editElement&&(t.title.editElement.setAttribute("contenteditable","true"),t.title.editElement.style.userSelect=""),t.background&&t.background.element.classList.add("protyle-background--enable"),t.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(n=>{var a;n.classList.remove("fn__none"),n.classList.contains("protyle-icon--first")&&((a=n.nextElementSibling)==null||a.classList.remove("protyle-icon--first"))}),t.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{T(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),t.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const e=t.contentElement.getBoundingClientRect();if(t.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__scroll")&&ks(n,e,"all")}),t.breadcrumb){const n=t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]');n.querySelector("use").setAttribute("xlink:href","#iconUnlock"),n.setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit),n.setAttribute("data-subtype","unlock");const a=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&a.classList.contains("fn__none")&&(a.classList.remove("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}cn()},nC=(t,e,n)=>{var a;let i;if(n&&n.focusId?i=t.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${t.block.id}"]`)).find(l=>{if(!j(l,"data-type","block-render",!0))return i=l,!0}),t.block.mode===4?(ra(t),i=t.wysiwyg.element.lastElementChild):(!i||e.includes(p.CB_GET_FOCUSFIRST))&&(i=t.wysiwyg.element.firstElementChild),e.includes(p.CB_GET_HL)&&(ra(t),$f(i)),e.includes(p.CB_GET_FOCUS)||e.includes(p.CB_GET_FOCUSFIRST)){let l;n&&n.focusId?l=ha(i,n.focusStart,n.focusEnd):oe(i,void 0,!e.includes(p.CB_GET_OUTLINE)),e.includes(p.CB_GET_UNUNDO)||cr(t,l,i)}const s=n&&typeof n.scrollTop=="number";if(s&&(t.contentElement.scrollTop=n.scrollTop),(a=t.observerLoad)==null||a.disconnect(),e.includes(p.CB_GET_FOCUS)||e.includes(p.CB_GET_SCROLL)||e.includes(p.CB_GET_HL)||e.includes(p.CB_GET_FOCUSFIRST))s||Ye(t,i);else return;t.observerLoad=new ResizeObserver(()=>{s&&(t.contentElement.scrollTop=n.scrollTop),(e.includes(p.CB_GET_FOCUS)||e.includes(p.CB_GET_HL)||e.includes(p.CB_GET_FOCUSFIRST))&&(s||Ye(t,i))}),t.observerLoad.observe(t.wysiwyg.element),t.observer.unobserve(t.wysiwyg.element),setTimeout(()=>{t.observerLoad.disconnect(),t.observer.observe(t.wysiwyg.element)},1e3*3),i===t.wysiwyg.element.firstElementChild&&!s&&t.observerLoad.disconnect()},qE=(t,e)=>{let n=window.siyuan.config.readonly?"true":"false";e?n==="false"&&(n=window.siyuan.config.editor.readOnly?"true":"false",n==="false"&&(n=t.wysiwyg.element.getAttribute(p.CUSTOM_SY_READONLY))):n=t.disabled?"true":"false",n==="true"?Sa(t):nd(t)};let FE;const aC=(t,e)=>{e.addEventListener("scroll",()=>{const n=e.getBoundingClientRect();if(!t.toolbar.element.classList.contains("fn__none")){const a=t.toolbar.element.getAttribute("data-inity").split(p.ZWSP),i=parseInt(a[0])+(parseInt(a[1])-e.scrollTop);i<n.top-t.toolbar.toolbarHeight||i>n.bottom-t.toolbar.toolbarHeight?t.toolbar.element.style.display="none":(t.toolbar.element.style.top=i+"px",t.toolbar.element.style.display="")}if(t.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.dataset.render==="true"&&ks(a,n,"all")}),!t.element.classList.contains("block__edit")&&!Y()&&t.contentElement.setAttribute("data-scrolltop",e.scrollTop.toString()),window.siyuan.dragElement||ce(["gutterOnly"],t),t.scroll&&!t.scroll.element.classList.contains("fn__none")&&(clearTimeout(FE),FE=window.setTimeout(()=>{let a=document.elementFromPoint(n.left+n.width/2,n.top+10);a.classList.contains("protyle-wysiwyg")&&(a=document.elementFromPoint(n.left+n.width/2,n.top+20));const i=B(a);if(!i){if((t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(T(a,"protyle-background")||T(a,"protyle-title"))){const s=t.scroll.element.querySelector(".b3-slider");s.value="1",t.scroll.element.setAttribute("aria-label",`Blocks 1/${t.block.blockCount}`)}return}t.scroll.updateIndex(t,i.getAttribute("data-node-id"))},p.TIMEOUT_LOAD)),!(t.wysiwyg.element.getAttribute("data-top")||t.block.showAll||t.scroll&&t.scroll.element.classList.contains("fn__none")||!t.scroll||t.scroll.lastScrollTop===e.scrollTop||t.scroll.lastScrollTop===-1||!t.wysiwyg.element.firstElementChild)){if(t.scroll.lastScrollTop>e.scrollTop){if(e.scrollTop===0)return;e.scrollTop<e.clientHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(t.contentElement.style.width=t.contentElement.offsetWidth+"px",t.contentElement.style.overflow="hidden",t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),A("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{t.contentElement.style.overflow="",t.contentElement.style.width="",kt({data:a,protyle:t,action:[p.CB_GET_BEFORE,p.CB_GET_UNCHANGEID]})}))}else if(e.scrollTop>e.scrollHeight-e.clientHeight*1.8&&t.wysiwyg.element.lastElementChild&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"){if(t.scroll.lastScrollTop>768&&e.scrollTop>t.scroll.lastScrollTop*2){e.scrollTop=t.scroll.lastScrollTop;return}t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),A("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{kt({data:a,protyle:t,action:[p.CB_GET_APPEND,p.CB_GET_UNCHANGEID]})})}t.scroll.lastScrollTop=Math.max(e.scrollTop,0)}},{capture:!1,passive:!0,once:!1})},iC=t=>{t.contentElement=document.createElement("div"),t.contentElement.className="protyle-content",(t.options.render.background||t.options.render.title)&&(t.contentElement.innerHTML='<div class="protyle-top"></div>',t.options.render.background&&t.contentElement.firstElementChild.appendChild(t.background.element),t.options.render.title&&t.contentElement.firstElementChild.appendChild(t.title.element)),t.contentElement.appendChild(t.wysiwyg.element),t.options.action.includes(p.CB_GET_HISTORY)||aC(t,t.contentElement),t.element.append(t.contentElement),t.element.appendChild(t.preview.element),t.upload&&t.element.appendChild(t.upload.element),t.options.render.scroll&&t.element.appendChild(t.scroll.element.parentElement),t.gutter&&t.element.appendChild(t.gutter.element),t.element.appendChild(t.hint.element),t.selectElement=document.createElement("div"),t.selectElement.className="protyle-select fn__none",t.element.appendChild(t.selectElement),t.element.appendChild(t.toolbar.element),t.element.appendChild(t.toolbar.subElement),jm(t.toolbar.subElement,()=>{const s=t.toolbar.subElement.querySelector('.block__icons [data-type="pin"]');s&&(s.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),s.setAttribute("aria-label",window.siyuan.languages.unpin),t.toolbar.subElement.firstElementChild.setAttribute("data-drag","true"))}),t.element.append(t.highlight.styleElement),Rl(t),ql(t,t.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let e;const n=ee(),a=Mt();t.contentElement.addEventListener("mousewheel",s=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||a&&!s.metaKey||!a&&!s.ctrlKey||s.deltaX!==0)){if(s.stopPropagation(),s.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(s.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;td(),clearTimeout(e),de(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,n),e=window.setTimeout(()=>{var l;A("/api/setting/setEditor",window.siyuan.config.editor),t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{or(o.parentElement)}),(l=document.querySelector(`#message [data-id="${n}"] button`))==null||l.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,td(),A("/api/setting/setEditor",window.siyuan.config.editor),At(n),t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{or(o.parentElement)})})},p.TIMEOUT_LOAD)}},{passive:!0}),t.contentElement.addEventListener("click",s=>{t.disabled||t.contentElement.querySelector(".protyle-wysiwyg--select")||!s.target.classList.contains("protyle-content")&&!s.target.classList.contains("protyle-wysiwyg")||setTimeout(()=>{if(window.getSelection().rangeCount>0){const c=window.getSelection().getRangeAt(0);if(c.toString()!==""&&t.wysiwyg.element.contains(c.startContainer))return}const l=t.wysiwyg.element.lastElementChild,o=l.getBoundingClientRect(),r=document.createRange();if(s.y>o.bottom){const c=fe($t(l));if(!t.options.click.preventInsetEmptyBlock&&(!c||l.getAttribute("data-type")!=="NodeParagraph"&&t.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||l.getAttribute("data-type")==="NodeParagraph"&&fe(c).innerHTML!=="")){let d;l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"?d=Fc(l):d=jn(!1,!1),t.wysiwyg.element.insertAdjacentElement("beforeend",d),V(t,[{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:d.previousElementSibling.getAttribute("data-node-id"),parentID:t.block.parentID}],[{action:"delete",id:d.getAttribute("data-node-id")}]);const u=fe(d);r.selectNodeContents(u),r.collapse(!0),ne(r),t.options.render.breadcrumb&&setTimeout(()=>{t.breadcrumb.render(t)},p.TIMEOUT_TRANSITION)}else c&&(r.selectNodeContents(c),r.collapse(!1),ne(r));t.toolbar.range=r}})});let i=!1;t.element.addEventListener("mouseover",s=>{const l=T(s.target,"protyle-attr");if(l&&!l.parentElement.classList.contains("protyle-title")){const c=t.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),i=!0,l.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const c=t.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),i=!1}const o=B(s.target);if(t.options.render.gutter&&o){if(o&&(o.classList.contains("list")||o.classList.contains("li")))return;const c=G(o);if(c){t.gutter.render(t,c,t.wysiwyg.element);return}t.gutter.render(t,o,t.wysiwyg.element,s.target);return}const r=U(s.target,"BUTTON");if(r&&r.parentElement.classList.contains("protyle-gutters")){const c=r.getAttribute("data-type");if(c==="fold"||c==="NodeAttributeViewRow"){Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(d=>{d.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${r.getAttribute("data-node-id")}"]`)).find(d=>{if(!G(d)&&t.gutter.isMatchNode(d)){const u=r.dataset.groupId&&r.dataset.groupId!=="undefined"?`.av__body[data-group-id="${r.dataset.groupId}"] `:"",m=d.querySelector(u+`.av__row[data-id="${r.dataset.rowId}"]`);return Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(f=>{d!==f&&f.classList.remove("protyle-wysiwyg--hl"),m&&m!==f&&m.classList.remove("av__row--hl")}),c==="NodeAttributeViewRowMenu"?m.classList.add("av__row--hl"):d.classList.add("protyle-wysiwyg--hl"),!0}}),s.preventDefault();return}if(t.selectElement.classList.contains("fn__none")){const c=j(s.target,"data-node-id",null);if(c&&c.parentElement.classList.contains("protyle-breadcrumb__bar")){t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(u=>{u.classList.remove("protyle-wysiwyg--hl")});const d=t.wysiwyg.element.querySelector(`[data-node-id="${c.getAttribute("data-node-id")}"]`);d&&d.classList.add("protyle-wysiwyg--hl")}}})},Rl=(t,e)=>{t.element.removeAttribute("data-loading"),setTimeout(()=>{t.element.getAttribute("data-loading")!=="finished"&&t.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${e||""}</div>
</div>`)},p.TIMEOUT_LOAD)},ad=t=>{t.element.setAttribute("data-loading","finished"),t.element.querySelectorAll(".wysiwygLoading").forEach(e=>{e.remove()})},yb=t=>{if(t.options.action.includes(p.CB_GET_HISTORY))return{width:0,padding:0};const e=UE(t),n=e.left,a=e.right;t.options.backlinkData?t.wysiwyg.element.style.padding=`4px ${a}px 4px ${n}px`:t.wysiwyg.element.style.padding=`${e.top}px ${a}px ${e.bottom}px ${n}px`,t.options.render.background&&t.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${n}px;margin-right:${a}px`),t.options.render.title&&(t.title.element.style.margin=`16px ${a}px 0 ${n}px`),t.element.style.setProperty("--b3-width-protyle",t.element.clientWidth+"px"),t.element.style.setProperty("--b3-width-protyle-content",t.contentElement.clientWidth+"px");const i=t.wysiwyg.element.getAttribute("data-realwidth"),s=t.wysiwyg.element.clientWidth-n-a;return t.wysiwyg.element.setAttribute("data-realwidth",s.toString()),t.element.style.setProperty("--b3-width-protyle-wysiwyg",s.toString()+"px"),{width:i?Math.abs(parseFloat(i)-s):0}},UE=t=>{let e=16,n=24,a=16;if(t.options.typewriterMode&&(Y()?a=window.innerHeight/5:a=t.element.clientHeight/2),!Y()){let i=t.wysiwyg.element.getAttribute(p.CUSTOM_SY_FULLWIDTH);i||(i=window.siyuan.config.editor.fullWidth?"true":"false");let s=(t.element.clientWidth-p.SIZE_EDITOR_WIDTH)/2;i==="false"&&s>96?(s>p.SIZE_EDITOR_WIDTH&&(s=t.element.clientWidth*.382/1.382),s=Math.ceil(s),n=s,e=s):t.element.clientWidth>p.SIZE_EDITOR_WIDTH&&(n=96,e=96)}return{left:n,right:e,bottom:a,top:16}},sC=()=>{Oe().editor.forEach(t=>{var e;t.editor&&t.editor.protyle&&t.element.parentElement&&!t.element.classList.contains("fn__none")&&((e=t.editor.protyle.wysiwyg.element.querySelector("[data-resize-top]"))==null||e.removeAttribute("data-resize-top"))})},id=()=>{Oe().editor.forEach(t=>{var e;if(t.editor&&t.editor.protyle&&t.element.parentElement&&!t.element.classList.contains("fn__none")){(e=t.editor.protyle.wysiwyg.element.querySelector("[data-resize-top]"))==null||e.removeAttribute("data-resize-top");const n=t.editor.protyle.contentElement.getBoundingClientRect();let a=document.elementFromPoint(n.left+n.width/2,n.top);if(T(a,"b3-menu")&&(window.siyuan.menus.menu.remove(),a=document.elementFromPoint(n.left+n.width/2,n.top)),a||(a=document.elementFromPoint(n.left+n.width/2,n.top+17)),!a||(a=B(a),!a))return;a.setAttribute("data-resize-top",(n.top-a.getBoundingClientRect().top).toString())}})},mn=t=>{ce(["gutterOnly"],t);const e=yb(t),n=4;setTimeout(()=>{if(t.scroll&&t.scroll.element.parentElement.getAttribute("style")&&t.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(t.contentElement.clientHeight-49,200)}px`),!t.disabled){const i=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(s=>{s.querySelector(".av__scroll")&&ks(s,i,"all")})}(e.width>n||isNaN(e.width))&&typeof window.echarts!="undefined"&&t.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(i=>{const s=window.echarts.getInstanceById(i.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));s&&s.resize()}),t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(i=>{i.nextElementSibling.style.wordBreak==="break-word"&&or(i.parentElement)});const a=t.wysiwyg.element.querySelector("[data-resize-top]");a&&(a.scrollIntoView(),t.contentElement.scrollTop+=parseInt(a.getAttribute("data-resize-top")),a.removeAttribute("data-resize-top"))},p.TIMEOUT_TRANSITION+100)},ql=(t,e)=>{var n,a,i,s;if(e==="preview"){if(!t.preview.element.classList.contains("fn__none"))return;t.preview.element.classList.remove("fn__none"),t.contentElement.classList.add("fn__none"),(n=t.scroll)==null||n.element.classList.add("fn__none"),t.options.render.breadcrumb&&((a=t.breadcrumb)==null||a.element.classList.add("fn__none"),t.breadcrumb.toggleExit(!0)),t.preview.render(t),Qb(Oe(),t,!0)}else if(e==="wysiwyg"){if(!t.contentElement.classList.contains("fn__none"))return;t.preview.element.classList.add("fn__none"),t.contentElement.classList.remove("fn__none"),t.options.render.scroll&&((i=t.scroll)==null||i.element.classList.remove("fn__none")),t.options.render.breadcrumb&&((s=t.breadcrumb)==null||s.element.classList.remove("fn__none"),t.breadcrumb.toggleExit(!t.block.showAll)),Qb(Oe(),t,!0),mn(t)}ce(["gutterOnly","toolbar","select","hint","util"],t),t.app.plugins.forEach(l=>{l.eventBus.emit("switch-protyle-mode",{protyle:t})})},sd="auto",_b=1,WE=1.1,VE=.1,YE=10,wb=0,lC=1.25,zE=40,GE=5,it={INITIAL:0,RUNNING:1,PAUSED:2,FINISHED:3},kn={UNKNOWN:0,NORMAL:1,CHANGING:2,FULLSCREEN:3},Ke={UNKNOWN:-1,NONE:0,THUMBS:1,OUTLINE:2,ATTACHMENTS:3,LAYERS:4},ci={DISABLE:0,ENABLE:1,ENABLE_PERMISSIONS:2},Ve={UNKNOWN:-1,VERTICAL:0,HORIZONTAL:1,WRAPPED:2,PAGE:3},Bt={UNKNOWN:-1,NONE:0,ODD:1,EVEN:2},Qn={SELECT:0,HAND:1,ZOOM:2},oC=/\bprint\s*\(/;function vb(t,e,n=!1){let a=t.offsetParent;if(!a){console.error("offsetParent is not set -- cannot scroll");return}let i=t.offsetTop+t.clientTop,s=t.offsetLeft+t.clientLeft;for(;a.clientHeight===a.scrollHeight&&a.clientWidth===a.scrollWidth||n&&(a.classList.contains("markedContent")||getComputedStyle(a).overflow==="hidden");)if(i+=a.offsetTop,s+=a.offsetLeft,a=a.offsetParent,!a)return;e&&(e.top!==void 0&&(i+=e.top),e.left!==void 0&&(s+=e.left,a.scrollLeft=s)),a.scrollTop=i}function jE(t,e,n=void 0){const a=function(l){s||(s=window.requestAnimationFrame(function(){s=null;const r=t.scrollLeft,c=i.lastX;r!==c&&(i.right=r>c),i.lastX=r;const d=t.scrollTop,u=i.lastY;d!==u&&(i.down=d>u),i.lastY=d,e(i),t.dataset.scrolltop=t.scrollTop}))},i={right:!0,down:!0,lastX:t.scrollLeft,lastY:t.scrollTop,_eventHandler:a};let s=null;return t.addEventListener("scroll",a,{useCapture:!0,signal:n}),n==null||n.addEventListener("abort",()=>window.cancelAnimationFrame(s),{once:!0}),i}function ld(t){const e=new Map;for(const[n,a]of new URLSearchParams(t))e.set(n.toLowerCase(),a);return e}const KE=/[\x00-\x1F]/g;function dr(t,e=!1){return KE.test(t)?e?t.replaceAll(KE,n=>n==="\0"?"":" "):t.replaceAll("\0",""):t}function od(t,e,n=0){let a=n,i=t.length-1;if(i<0||!e(t[i]))return t.length;if(e(t[a]))return a;for(;a<i;){const s=a+i>>1,l=t[s];e(l)?i=s:a=s+1}return a}function ZE(t){if(Math.floor(t)===t)return[t,1];const e=1/t,n=8;if(e>n)return[1,n];if(Math.floor(e)===e)return[1,e];const a=t>1?e:t;let i=0,s=1,l=1,o=1;for(;;){const c=i+l,d=s+o;if(d>n)break;a<=c/d?(l=c,o=d):(i=c,s=d)}let r;return a-i/s<l/o-a?r=a===t?[i,s]:[s,i]:r=a===t?[l,o]:[o,l],r}function Np(t,e){return t-t%e}function rC({view:t,userUnit:e,rotate:n}){const[a,i,s,l]=t,o=n%180!==0,r=(s-a)/72*e,c=(l-i)/72*e;return{width:o?c:r,height:o?r:c}}function cC(t,e,n){if(t<2)return t;let a=e[t].div,i=a.offsetTop+a.clientTop;i>=n&&(a=e[t-1].div,i=a.offsetTop+a.clientTop);for(let s=t-2;s>=0&&(a=e[s].div,!(a.offsetTop+a.clientTop+a.clientHeight<=i));--s)t=s;return t}function JE({scrollEl:t,views:e,sortByVisibility:n=!1,horizontal:a=!1,rtl:i=!1}){const s=t.scrollTop,l=s+t.clientHeight,o=t.scrollLeft,r=o+t.clientWidth;function c(w){const E=w.div;return E.offsetTop+E.clientTop+E.clientHeight>s}function d(w){const E=w.div,C=E.offsetLeft+E.clientLeft,$=C+E.clientWidth;return i?C<r:$>o}const u=[],m=new Set,f=e.length;let g=od(e,a?d:c);g>0&&g<f&&!a&&(g=cC(g,e,s));let h=a?r:-1;for(let w=g;w<f;w++){const E=e[w],C=E.div,$=C.offsetLeft+C.clientLeft,M=C.offsetTop+C.clientTop,k=C.clientWidth,_=C.clientHeight,v=$+k,S=M+_;if(h===-1)S>=l&&(h=S);else if((a?$:M)>h)break;if(S<=s||M>=l||v<=o||$>=r)continue;const L=Math.max(0,s-M)+Math.max(0,S-l),D=Math.max(0,o-$)+Math.max(0,v-r),I=(_-L)/_,q=(k-D)/k,Z=I*q*100|0;u.push({id:E.id,x:$,y:M,view:E,percent:Z,widthPercent:q*100|0}),m.add(E.id)}const b=u[0],y=u.at(-1);return n&&u.sort(function(w,E){const C=w.percent-E.percent;return Math.abs(C)>.001?-C:w.id-E.id}),{first:b,last:y,views:u,ids:m}}function XE(t){let e=Math.hypot(t.deltaX,t.deltaY);const n=Math.atan2(t.deltaY,t.deltaX);return-.25*Math.PI<n&&n<.75*Math.PI&&(e=-e),e}function dC(t){const e=t.deltaMode;let n=XE(t);const a=30,i=30;return e===WheelEvent.DOM_DELTA_PIXEL?n/=a*i:e===WheelEvent.DOM_DELTA_LINE&&(n/=i),n}function Hp(t){return Number.isInteger(t)&&t%90===0}function QE(t){return Number.isInteger(t)&&Object.values(Ve).includes(t)&&t!==Ve.UNKNOWN}function ek(t){return Number.isInteger(t)&&Object.values(Bt).includes(t)&&t!==Bt.UNKNOWN}function Eb(t){return t.width<=t.height}const uC=new Promise(function(t){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof window=="undefined"){setTimeout(t,20);return}window.requestAnimationFrame(t)}),tk=typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof document=="undefined"?null:document.documentElement.style;function fC(t,e,n){return Math.min(Math.max(t,e),n)}class pC{constructor(e){O(this,Os,null);O(this,Jl,null);O(this,Bs,0);O(this,_r,null);O(this,Xl,!0);z(this,Os,e.classList),z(this,_r,e.style)}get percent(){return x(this,Bs)}set percent(e){if(z(this,Bs,fC(e,0,100)),isNaN(e)){x(this,Os).add("indeterminate");return}x(this,Os).remove("indeterminate"),x(this,_r).setProperty("--progressBar-percent",`${x(this,Bs)}%`)}setWidth(e){if(!e)return;const a=e.parentNode.offsetWidth-e.offsetWidth;a>0&&x(this,_r).setProperty("--progressBar-end-offset",`${a}px`)}setDisableAutoFetch(e=5e3){x(this,Bs)===100||isNaN(x(this,Bs))||(x(this,Jl)&&clearTimeout(x(this,Jl)),this.show(),z(this,Jl,setTimeout(()=>{z(this,Jl,null),this.hide()},e)))}hide(){x(this,Xl)&&(z(this,Xl,!1),x(this,Os).add("fn__hidden"))}show(){x(this,Xl)||(z(this,Xl,!0),x(this,Os).remove("fn__hidden"))}}Os=new WeakMap,Jl=new WeakMap,Bs=new WeakMap,_r=new WeakMap,Xl=new WeakMap;function gC(){let t=document,e=t.activeElement||t.querySelector(":focus");for(;e!=null&&e.shadowRoot;)t=e.shadowRoot,e=t.activeElement||t.querySelector(":focus");return e}function nk(t){let e=Ve.VERTICAL,n=Bt.NONE;switch(t){case"SinglePage":e=Ve.PAGE;break;case"OneColumn":break;case"TwoPageLeft":e=Ve.PAGE;case"TwoColumnLeft":n=Bt.ODD;break;case"TwoPageRight":e=Ve.PAGE;case"TwoColumnRight":n=Bt.EVEN;break}return{scrollMode:e,spreadMode:n}}function mC(t){switch(t){case"UseNone":return Ke.NONE;case"UseThumbs":return Ke.THUMBS;case"UseOutlines":return Ke.OUTLINE;case"UseAttachments":return Ke.ATTACHMENTS;case"UseOC":return Ke.LAYERS}return Ke.NONE}function La(t,e,n=null){t.classList.toggle("toggled",e),t.setAttribute("aria-checked",e),n==null||n.classList.toggle("fn__hidden",!e)}function Di(t,e,n=null){t.classList.toggle("toggled",e),t.setAttribute("aria-expanded",e),n==null||n.classList.toggle("fn__hidden",!e)}const Op=typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?Math.fround:function(){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof document=="undefined")return e=>e;const t=document.createElement("div");return t.style.width="round(down, calc(1.6666666666666665 * 792px), 1px)",t.style.width==="calc(1320px)"?Math.fround:e=>e}();if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){var Fl=new Map;typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof navigator=="undefined"&&(globalThis.navigator=Object.create(null));const t=navigator.userAgent||"",e=navigator.platform||"",n=navigator.maxTouchPoints||1,a=/Android/.test(t),i=/\b(iPad|iPhone|iPod)(?=;)/.test(t)||e==="MacIntel"&&n>1;(function(){(i||a)&&Fl.set("maxCanvasPixels",5242880)})(),function(){a&&Fl.set("useSystemFonts",!1)}()}const te={BROWSER:1,VIEWER:2,API:4,WORKER:8,EVENT_DISPATCH:16,PREFERENCE:128},kb={BOOLEAN:1,NUMBER:2,OBJECT:4,STRING:8,UNDEFINED:16},Aa={allowedGlobalEvents:{value:null,kind:te.BROWSER},canvasMaxAreaInBytes:{value:-1,kind:te.BROWSER+te.API},isInAutomation:{value:!1,kind:te.BROWSER},localeProperties:{value:typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?{lang:navigator.language||"en-US"}:null,kind:te.BROWSER},nimbusDataStr:{value:"",kind:te.BROWSER},supportsCaretBrowsingMode:{value:!1,kind:te.BROWSER},supportsDocumentFonts:{value:!0,kind:te.BROWSER},supportsIntegratedFind:{value:!1,kind:te.BROWSER},supportsMouseWheelZoomCtrlKey:{value:!0,kind:te.BROWSER},supportsMouseWheelZoomMetaKey:{value:!0,kind:te.BROWSER},supportsPinchToZoom:{value:!0,kind:te.BROWSER},toolbarDensity:{value:0,kind:te.BROWSER+te.EVENT_DISPATCH},altTextLearnMoreUrl:{value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?"https://support.mozilla.org/1/firefox/%VERSION%/%OS%/%LOCALE%/pdf-alt-text":"",kind:te.VIEWER+te.PREFERENCE},annotationEditorMode:{value:0,kind:te.VIEWER+te.PREFERENCE},annotationMode:{value:2,kind:te.VIEWER+te.PREFERENCE},cursorToolOnLoad:{value:0,kind:te.VIEWER+te.PREFERENCE},debuggerSrc:{value:"./debugger.mjs",kind:te.VIEWER},defaultZoomDelay:{value:400,kind:te.VIEWER+te.PREFERENCE},defaultZoomValue:{value:"",kind:te.VIEWER+te.PREFERENCE},disableHistory:{value:!1,kind:te.VIEWER},disablePageLabels:{value:!1,kind:te.VIEWER+te.PREFERENCE},enableAltText:{value:!1,kind:te.VIEWER+te.PREFERENCE},enableAltTextModelDownload:{value:!0,kind:te.VIEWER+te.PREFERENCE+te.EVENT_DISPATCH},enableGuessAltText:{value:!0,kind:te.VIEWER+te.PREFERENCE+te.EVENT_DISPATCH},enableHighlightFloatingButton:{value:typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"),kind:te.VIEWER+te.PREFERENCE},enableNewAltTextWhenAddingImage:{value:!0,kind:te.VIEWER+te.PREFERENCE},enablePermissions:{value:!1,kind:te.VIEWER+te.PREFERENCE},enablePrintAutoRotate:{value:!0,kind:te.VIEWER+te.PREFERENCE},enableScripting:{value:typeof PDFJSDev=="undefined"||!PDFJSDev.test("CHROME"),kind:te.VIEWER+te.PREFERENCE},enableUpdatedAddImage:{value:!1,kind:te.VIEWER+te.PREFERENCE},externalLinkRel:{value:"noopener noreferrer nofollow",kind:te.VIEWER},externalLinkTarget:{value:0,kind:te.VIEWER+te.PREFERENCE},highlightEditorColors:{value:"yellow=#FFFF98,green=#53FFBC,blue=#80EBFF,pink=#FFCBE6,red=#FF4F5F",kind:te.VIEWER+te.PREFERENCE},historyUpdateUrl:{value:!1,kind:te.VIEWER+te.PREFERENCE},ignoreDestinationZoom:{value:!1,kind:te.VIEWER+te.PREFERENCE},imageResourcesPath:{value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/web/images/":"./images/",kind:te.VIEWER},maxCanvasPixels:{value:GS(2,25),kind:te.VIEWER},forcePageColors:{value:!1,kind:te.VIEWER+te.PREFERENCE},pageColorsBackground:{value:"Canvas",kind:te.VIEWER+te.PREFERENCE},pageColorsForeground:{value:"CanvasText",kind:te.VIEWER+te.PREFERENCE},pdfBugEnabled:{value:typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"),kind:te.VIEWER+te.PREFERENCE},printResolution:{value:150,kind:te.VIEWER},sidebarViewOnLoad:{value:-1,kind:te.VIEWER+te.PREFERENCE},scrollModeOnLoad:{value:-1,kind:te.VIEWER+te.PREFERENCE},spreadModeOnLoad:{value:-1,kind:te.VIEWER+te.PREFERENCE},textLayerMode:{value:1,kind:te.VIEWER+te.PREFERENCE},viewOnLoad:{value:0,kind:te.VIEWER+te.PREFERENCE},cMapPacked:{value:!0,kind:te.API},cMapUrl:{value:typeof PDFJSDev=="undefined"?"../external/bcmaps/":PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/web/cmaps/":"../web/cmaps/",kind:te.API},disableAutoFetch:{value:!1,kind:te.API+te.PREFERENCE},disableFontFace:{value:!1,kind:te.API+te.PREFERENCE},disableRange:{value:!1,kind:te.API+te.PREFERENCE},disableStream:{value:!1,kind:te.API+te.PREFERENCE},docBaseUrl:{value:typeof PDFJSDev=="undefined"?document.URL.split("#",1)[0]:"",kind:te.API},enableHWA:{value:typeof PDFJSDev!="undefined"&&!PDFJSDev.test("MOZCENTRAL"),kind:te.API+te.VIEWER+te.PREFERENCE},enableXfa:{value:!0,kind:te.API+te.PREFERENCE},fontExtraProperties:{value:!1,kind:te.API},isEvalSupported:{value:!0,kind:te.API},isOffscreenCanvasSupported:{value:!0,kind:te.API},maxImageSize:{value:-1,kind:te.API},pdfBug:{value:!1,kind:te.API},standardFontDataUrl:{value:typeof PDFJSDev=="undefined"?"../external/standard_fonts/":PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/web/standard_fonts/":"../web/standard_fonts/",kind:te.API},useSystemFonts:{value:(typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))?!1:void 0,kind:te.API,type:kb.BOOLEAN+kb.UNDEFINED},verbosity:{value:1,kind:te.API},workerPort:{value:null,kind:te.WORKER},workerSrc:{value:typeof PDFJSDev=="undefined"?"../src/pdf.worker.js":PDFJSDev.test("MOZCENTRAL")?"resource://pdf.js/build/pdf.worker.mjs":"../build/pdf.worker.mjs",kind:te.WORKER}};if((typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&(Aa.defaultUrl={value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")?"":"compressed.tracemonkey-pldi-09.pdf",kind:te.VIEWER},Aa.sandboxBundleSrc={value:typeof PDFJSDev=="undefined"?"../build/dev-sandbox/pdf.sandbox.mjs":"../build/pdf.sandbox.mjs",kind:te.VIEWER},Aa.viewerCssTheme={value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")?2:0,kind:te.VIEWER+te.PREFERENCE},Aa.enableFakeMLManager={value:!0,kind:te.VIEWER}),typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?Aa.disablePreferences={value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("TESTING"),kind:te.VIEWER}:PDFJSDev.test("CHROME")&&(Aa.disableTelemetry={value:!1,kind:te.VIEWER+te.PREFERENCE}),typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING || LIB"))for(const t in Aa){const{value:e,kind:n,type:a}=Aa[t];if(n&te.PREFERENCE){if(n===te.PREFERENCE)throw new Error(`Cannot use only "PREFERENCE" kind: ${t}`);if(n&te.BROWSER)throw new Error(`Cannot mix "PREFERENCE" and "BROWSER" kind: ${t}`);if(a!==void 0)throw new Error(`Cannot have \`type\`-field for "PREFERENCE" kind: ${t}`);if(typeof Fl=="object"&&Fl.has(t))throw new Error(`Should not have compatibility-value for "PREFERENCE" kind: ${t}`);if(typeof e!="boolean"&&typeof e!="string"&&!Number.isInteger(e))throw new Error(`Invalid value for "PREFERENCE" kind: ${t}`)}else if(n&te.BROWSER){if(a!==void 0)throw new Error(`Cannot have \`type\`-field for "BROWSER" kind: ${t}`);if(typeof Fl=="object"&&Fl.has(t))throw new Error(`Should not have compatibility-value for "BROWSER" kind: ${t}`);if(e===void 0)throw new Error(`Invalid value for "BROWSER" kind: ${t}`)}}const Mi=class Mi{constructor(){if(typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"))throw new Error("Cannot initialize AppOptions.")}static get(e){return x(this,Rs).get(e)}static getAll(e=null,n=!1){const a=Object.create(null);for(const i in Aa){const s=Aa[i];e&&!(e&s.kind)||(a[i]=n?s.value:x(this,Rs).get(i))}return a}static set(e,n){this.setAll({[e]:n})}static setAll(e,n=!1){(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this._hasInvokedSet||(this._hasInvokedSet=!0));let a;for(const i in e){const s=Aa[i],l=e[i];if(!s||!(typeof l==typeof s.value||kb[(typeof l).toUpperCase()]&s.type))continue;const{kind:o}=s;n&&!(o&te.BROWSER||o&te.PREFERENCE)||(this.eventBus&&o&te.EVENT_DISPATCH&&(a||(a=new Map)).set(i,l),x(this,Rs).set(i,l))}if(a)for(const[i,s]of a)this.eventBus.dispatch(i.toLowerCase(),{source:this,value:s})}};Rs=new WeakMap,bf(Mi,"eventBus"),O(Mi,Rs,new Map),(()=>{for(const e in Aa)x(Mi,Rs).set(e,Aa[e].value);if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){for(const[e,n]of Fl)x(Mi,Rs).set(e,n);Mi._hasInvokedSet=!1,Mi._checkDisablePreferences=()=>Mi.get("disablePreferences")?!0:(Mi._hasInvokedSet&&console.warn('The Preferences may override manually set AppOptions; please use the "disablePreferences"-option to prevent that.'),!1)}})();let ge=Mi;const hC="noopener noreferrer nofollow",es={NONE:0,SELF:1,BLANK:2,PARENT:3,TOP:4},fg=class fg{constructor({eventBus:e,externalLinkTarget:n=null,externalLinkRel:a=null,ignoreDestinationZoom:i=!1}={}){bf(this,"externalLinkEnabled",!0);this.eventBus=e,this.externalLinkTarget=n,this.externalLinkRel=a,this._ignoreDestinationZoom=i,this.baseUrl=null,this.pdfDocument=null,this.pdfViewer=null,this.pdfHistory=null}setDocument(e,n=null){this.baseUrl=n,this.pdfDocument=e}setViewer(e){this.pdfViewer=e}setHistory(e){this.pdfHistory=e}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfDocument?this.pdfViewer.currentPageNumber:1}set page(e){this.pdfDocument&&(this.pdfViewer.currentPageNumber=e)}get rotation(){return this.pdfDocument?this.pdfViewer.pagesRotation:0}set rotation(e){this.pdfDocument&&(this.pdfViewer.pagesRotation=e)}get isInPresentationMode(){return this.pdfDocument?this.pdfViewer.isInPresentationMode:!1}goToDestination(e){return se(this,null,function*(){if(!this.pdfDocument)return;let n,a,i;if(typeof e=="string"?(n=e,a=yield this.pdfDocument.getDestination(e)):(n=null,a=yield e),!Array.isArray(a)){console.error(`goToDestination: "${a}" is not a valid destination array, for dest="${e}".`);return}const[s]=a;if(s&&typeof s=="object"){if(i=this.pdfDocument.cachedPageNumber(s),!i)try{i=(yield this.pdfDocument.getPageIndex(s))+1}catch(l){console.error(`goToDestination: "${s}" is not a valid page reference, for dest="${e}".`);return}}else Number.isInteger(s)&&(i=s+1);if(!i||i<1||i>this.pagesCount){console.error(`goToDestination: "${i}" is not a valid page number, for dest="${e}".`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.push({namedDest:n,explicitDest:a,pageNumber:i})),this.pdfViewer.scrollPageIntoView({pageNumber:i,destArray:a,ignoreDestinationZoom:this._ignoreDestinationZoom})})}goToPage(e){if(!this.pdfDocument)return;const n=typeof e=="string"&&this.pdfViewer.pageLabelToPageNumber(e)||e|0;if(!(Number.isInteger(n)&&n>0&&n<=this.pagesCount)){console.error(`PDFLinkService.goToPage: "${e}" is not a valid page.`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.pushPage(n)),this.pdfViewer.scrollPageIntoView({pageNumber:n})}addLinkAttributes(e,n,a=!1){if(!n||typeof n!="string")throw new Error('A valid "url" parameter must provided.');const i=a?es.BLANK:this.externalLinkTarget,s=this.externalLinkRel;this.externalLinkEnabled?e.href=e.title=n:(e.href="",e.title=`Disabled: ${n}`,e.onclick=()=>!1);let l="";switch(i){case es.NONE:break;case es.SELF:l="_self";break;case es.BLANK:l="_blank";break;case es.PARENT:l="_parent";break;case es.TOP:l="_top";break}e.target=l,e.rel=typeof s=="string"?s:hC}getDestinationHash(e){if(typeof e=="string"){if(e.length>0)return this.getAnchorUrl("#"+escape(e))}else if(Array.isArray(e)){const n=JSON.stringify(e);if(n.length>0)return this.getAnchorUrl("#"+escape(n))}return this.getAnchorUrl("")}getAnchorUrl(e){return this.baseUrl?this.baseUrl+e:e}setHash(e){var i;if(!this.pdfDocument)return;let n,a;if(e.includes("=")){const s=ld(e);if(s.has("search")){const l=s.get("search").replaceAll('"',""),o=s.get("phrase")==="true";this.eventBus.dispatch("findfromurlhash",{source:this,query:o?l:l.match(/\S+/g)})}if(s.has("page")&&(n=s.get("page")|0||1),s.has("zoom")){const l=s.get("zoom").split(","),o=l[0],r=parseFloat(o);o.includes("Fit")?o==="Fit"||o==="FitB"?a=[null,{name:o}]:o==="FitH"||o==="FitBH"||o==="FitV"||o==="FitBV"?a=[null,{name:o},l.length>1?l[1]|0:null]:o==="FitR"?l.length!==5?console.error('PDFLinkService.setHash: Not enough parameters for "FitR".'):a=[null,{name:o},l[1]|0,l[2]|0,l[3]|0,l[4]|0]:console.error(`PDFLinkService.setHash: "${o}" is not a valid zoom value.`):a=[null,{name:"XYZ"},l.length>1?l[1]|0:null,l.length>2?l[2]|0:null,r?r/100:o]}if(a?this.pdfViewer.scrollPageIntoView({pageNumber:n||this.page,destArray:a,allowNegativeOffset:!0}):n&&(this.page=n),s.has("pagemode")&&this.eventBus.dispatch("pagemode",{source:this,mode:s.get("pagemode")}),s.has("nameddest")&&this.goToDestination(s.get("nameddest")),typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL")||!s.has("filename")||!s.has("filedest"))return;e=s.get("filedest")}a=unescape(e);try{a=JSON.parse(a),Array.isArray(a)||(a=a.toString())}catch(s){}if(typeof a=="string"||H(i=fg,ug,jS).call(i,a)){this.goToDestination(a);return}console.error(`PDFLinkService.setHash: "${unescape(e)}" is not a valid destination.`)}executeNamedAction(e){var n,a;if(this.pdfDocument){switch(e){case"GoBack":(n=this.pdfHistory)==null||n.back();break;case"GoForward":(a=this.pdfHistory)==null||a.forward();break;case"NextPage":this.pdfViewer.nextPage();break;case"PrevPage":this.pdfViewer.previousPage();break;case"LastPage":this.page=this.pagesCount;break;case"FirstPage":this.page=1;break;default:break}this.eventBus.dispatch("namedaction",{source:this,action:e})}}executeSetOCGState(e){return se(this,null,function*(){if(!this.pdfDocument)return;const n=this.pdfDocument,a=yield this.pdfViewer.optionalContentConfigPromise;n===this.pdfDocument&&(a.setOCGState(e),this.pdfViewer.optionalContentConfigPromise=Promise.resolve(a))})}};ug=new WeakSet,jS=function(e){if(!Array.isArray(e)||e.length<2)return!1;const[n,a,...i]=e;if(!(typeof n=="object"&&Number.isInteger(n==null?void 0:n.num)&&Number.isInteger(n==null?void 0:n.gen))&&!Number.isInteger(n)||!(typeof a=="object"&&typeof(a==null?void 0:a.name)=="string"))return!1;const s=i.length;let l=!0;switch(a.name){case"XYZ":if(s<2||s>3)return!1;break;case"Fit":case"FitB":return s===0;case"FitH":case"FitBH":case"FitV":case"FitBV":if(s>1)return!1;break;case"FitR":if(s!==4)return!1;l=!1;break;default:return!1}for(const o of i)if(!(typeof o=="number"||l&&o===null))return!1;return!0},O(fg,ug);let Bp=fg;class Sb extends Bp{setDocument(e,n=null){}}var ae=Ue(119);const ak={EVENT:"event",TIMEOUT:"timeout"};function ik(a){return se(this,arguments,function*({target:t,name:e,delay:n=0}){if(typeof t!="object"||!(e&&typeof e=="string")||!(Number.isInteger(n)&&n>=0))throw new Error("waitOnEventOrTimeout - invalid parameters.");const{promise:i,resolve:s}=Promise.withResolvers(),l=new AbortController;function o(d){l.abort(),clearTimeout(c),s(d)}const r=t instanceof Lb?"_on":"addEventListener";t[r](e,o.bind(null,ak.EVENT),{signal:l.signal});const c=setTimeout(o.bind(null,ak.TIMEOUT),n);return i})}class Lb{constructor(){O(this,wr,Object.create(null))}on(e,n,a=null){this._on(e,n,{external:!0,once:a==null?void 0:a.once,signal:a==null?void 0:a.signal})}off(e,n,a=null){this._off(e,n)}dispatch(e,n){const a=x(this,wr)[e];if(!a||a.length===0)return;let i;for(const{listener:s,external:l,once:o}of a.slice(0)){if(o&&this._off(e,s),l){(i||(i=[])).push(s);continue}s(n)}if(i){for(const s of i)s(n);i=null}}_on(e,n,a=null){var l;let i=null;if((a==null?void 0:a.signal)instanceof AbortSignal){const{signal:o}=a;if(o.aborted){console.error("Cannot use an `aborted` signal.");return}const r=()=>this._off(e,n);i=()=>o.removeEventListener("abort",r),o.addEventListener("abort",r)}((l=x(this,wr))[e]||(l[e]=[])).push({listener:n,external:(a==null?void 0:a.external)===!0,once:(a==null?void 0:a.once)===!0,rmAbort:i})}_off(e,n,a=null){var s;const i=x(this,wr)[e];if(i)for(let l=0,o=i.length;l<o;l++){const r=i[l];if(r.listener===n){(s=r.rmAbort)==null||s.call(r),i.splice(l,1);return}}}}wr=new WeakMap;class bC extends Lb{constructor(n,a,i){super();O(this,Sd,void 0);O(this,Ld,void 0);O(this,Ad,void 0);z(this,Ld,n),z(this,Sd,a),z(this,Ad,i)}dispatch(n,a){var i;if(typeof PDFJSDev!="undefined"&&!PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: FirefoxEventBus.dispatch");if(super.dispatch(n,a),x(this,Ad)){const s=Object.create(null);if(a)for(const o in a){const r=a[o];if(o==="source"){if(r===window||r===document)return;continue}s[o]=r}const l=new CustomEvent(n,{bubbles:!0,cancelable:!0,detail:s});document.dispatchEvent(l)}(i=x(this,Ld))!=null&&i.has(n)&&x(this,Sd).dispatchGlobalEvent({eventName:n,detail:a})}}Sd=new WeakMap,Ld=new WeakMap,Ad=new WeakMap;class Ab{constructor(){if((typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"))&&this.constructor===Ab)throw new Error("Cannot initialize BaseExternalServices.")}updateFindControlState(e){}updateFindMatchesCount(e){}initPassiveLoading(){}reportTelemetry(e){}createL10n(){return se(this,null,function*(){throw new Error("Not implemented: createL10n")})}createScripting(){throw new Error("Not implemented: createScripting")}updateEditorStates(e){throw new Error("Not implemented: updateEditorStates")}dispatchGlobalEvent(e){}}const Iy=class Iy{constructor(){O(this,Ql,Object.freeze(typeof PDFJSDev=="undefined"?ge.getAll(te.PREFERENCE,!0):PDFJSDev.eval("DEFAULT_PREFERENCES")));O(this,ls,null);if((typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"))&&this.constructor===Iy)throw new Error("Cannot initialize BasePreferences.");typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&Object.defineProperty(this,"defaults",{get(){return x(this,Ql)}}),z(this,ls,this._readFromStorage(x(this,Ql)).then(({browserPrefs:e,prefs:n})=>{(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&ge._checkDisablePreferences()||ge.setAll(aa(aa({},e),n),!0)})),typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")&&window.addEventListener("updatedPreference",a=>se(this,[a],function*({detail:{name:e,value:n}}){yield x(this,ls),ge.setAll({[e]:n},!0)}))}_writeToStorage(e){return se(this,null,function*(){throw new Error("Not implemented: _writeToStorage")})}_readFromStorage(e){return se(this,null,function*(){throw new Error("Not implemented: _readFromStorage")})}reset(){return se(this,null,function*(){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Please use `about:config` to change preferences.");yield x(this,ls),ge.setAll(x(this,Ql),!0),yield this._writeToStorage(x(this,Ql))})}set(e,n){return se(this,null,function*(){yield x(this,ls),ge.setAll({[e]:n},!0),yield this._writeToStorage(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?{[e]:ge.get(e)}:ge.getAll(te.PREFERENCE))})}get(e){return se(this,null,function*(){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: get");return yield x(this,ls),ge.get(e)})}get initializedPromise(){return x(this,ls)}};Ql=new WeakMap,ls=new WeakMap;let xb=Iy;const kr=class kr{constructor({lang:e,isRTL:n},a=null){O(this,xd,void 0);O(this,vr,new Set);O(this,Er,void 0);O(this,wa,void 0);var i,s;z(this,Er,H(i=kr,pg,KS).call(i,e)),z(this,wa,a),z(this,xd,(n!=null?n:H(s=kr,gg,ZS).call(s,x(this,Er)))?"rtl":"ltr")}_setL10n(e){z(this,wa,e),typeof PDFJSDev!="undefined"&&PDFJSDev.test("TESTING")&&(document.l10n=e)}getLanguage(){return x(this,Er)}getDirection(){return x(this,xd)}get(e,n=null,a){return se(this,null,function*(){var s;return Array.isArray(e)?(e=e.map(o=>({id:o})),(yield x(this,wa).formatMessages(e)).map(o=>o.value)):((s=(yield x(this,wa).formatMessages([{id:e,args:n}]))[0])==null?void 0:s.value)||a})}translate(e){return se(this,null,function*(){x(this,vr).add(e);try{x(this,wa).connectRoot(e),yield x(this,wa).translateRoots()}catch(n){}})}translateOnce(e){return se(this,null,function*(){try{yield x(this,wa).translateElements([e])}catch(n){console.error(`translateOnce: "${n}".`)}})}destroy(){return se(this,null,function*(){for(const e of x(this,vr))x(this,wa).disconnectRoot(e);x(this,vr).clear(),x(this,wa).pauseObserving()})}pause(){x(this,wa).pauseObserving()}resume(){x(this,wa).resumeObserving()}};xd=new WeakMap,vr=new WeakMap,Er=new WeakMap,wa=new WeakMap,pg=new WeakSet,KS=function(e){return e=(e==null?void 0:e.toLowerCase())||"en-us",{en:"en-us",es:"es-es",fy:"fy-nl",ga:"ga-ie",gu:"gu-in",hi:"hi-in",hy:"hy-am",nb:"nb-no",ne:"ne-np",nn:"nn-no",pa:"pa-in",pt:"pt-pt",sv:"sv-se",zh:"zh-cn"}[e]||e},gg=new WeakSet,ZS=function(e){const n=e.split("-",1)[0];return["ar","he","fa","ps","ur"].includes(n)},O(kr,pg),O(kr,gg);let Cb=kr;const ED=null;class yC extends Cb{constructor(e){super({lang:e}),this._setL10n({formatMessages:n=>new Promise(a=>{let i=window.siyuan.languages[n[0].id]||n[0].id;n[0].args&&Object.keys(n[0].args).forEach(s=>{i=i.replace("${"+s+"}",n[0].args[s])}),a([{value:i}])}),connectRoot:()=>{},translateRoots:()=>{},translateElements:()=>{},disconnectRoot:()=>{},pauseObserving:()=>{},resumeObserving:()=>{}})}}function kD(t){return se(this,null,function*(){const e="",n=e.split("#",1)[0];let{info:a,metadata:i,contentDispositionFilename:s,contentLength:l}=yield t.getMetadata();if(!l){const{length:o}=yield t.getDownloadInfo();l=o}return ml(aa({},a),{baseURL:n,filesize:l,filename:s||getPdfFilenameFromUrl(e),metadata:i==null?void 0:i.getRaw(),authors:i==null?void 0:i.get("dc:creator"),numPages:t.numPages,URL:e})})}class _C{constructor(e){this._ready=new Promise((n,a)=>{})}createSandbox(e){return se(this,null,function*(){(yield this._ready).create(e)})}dispatchEventInSandbox(e){return se(this,null,function*(){const n=yield this._ready;setTimeout(()=>n.dispatchEvent(e),0)})}destroySandbox(){return se(this,null,function*(){(yield this._ready).nukeSandbox()})}}if(typeof PDFJSDev!="undefined"&&!PDFJSDev.test("GENERIC"))throw new Error('Module "pdfjs-web/genericcom" shall not be used outside GENERIC build.');function SD(t){}class wC extends xb{_writeToStorage(e){return se(this,null,function*(){localStorage.setItem("pdfjs.preferences",JSON.stringify(e))})}_readFromStorage(e){return se(this,null,function*(){return{prefs:JSON.parse(localStorage.getItem("pdfjs.preferences"))}})}}class vC extends Ab{createL10n(){return se(this,null,function*(){var e;return new yC((e=ge.get("localeProperties"))==null?void 0:e.lang)})}createScripting(){return new _C(ge.get("sandboxBundleSrc"))}}class Rp{isEnabledFor(e){return se(this,null,function*(){return!1})}deleteModel(e){return se(this,null,function*(){return null})}isReady(e){return!1}guess(e){}toggleService(e,n){}static getFakeMLManager(e){return new EC(e)}}class EC{constructor({enableGuessAltText:e,enableAltTextModelDownload:n}){bf(this,"eventBus",null);bf(this,"hasProgress",!1);this.enableGuessAltText=e,this.enableAltTextModelDownload=n}setEventBus(e,n){this.eventBus=e}isEnabledFor(e){return se(this,null,function*(){return this.enableGuessAltText})}deleteModel(e){return se(this,null,function*(){return this.enableAltTextModelDownload=!1,null})}loadModel(e){return se(this,null,function*(){})}downloadModel(e){return se(this,null,function*(){this.hasProgress=!0;const{promise:n,resolve:a}=Promise.withResolvers(),i=1e8,s=1.5*i,l=5e6;let o=0;const r=setInterval(()=>{if(o+=l,o<=s){this.eventBus.dispatch("loadaiengineprogress",{source:this,detail:{total:i,totalLoaded:o,finished:o+l>=s}});return}clearInterval(r),this.hasProgress=!1,this.enableAltTextModelDownload=!0,a(!0)},900);return n})}isReady(e){return this.enableAltTextModelDownload}guess({request:{data:e}}){return new Promise(n=>{setTimeout(()=>{n(e?{output:"Fake alt text"}:{error:!0})},3e3)})}toggleService(e,n){this.enableGuessAltText=n}}class LD{constructor({descriptionContainer:e,dialog:n,imagePreview:a,cancelButton:i,disclaimer:s,notNowButton:l,saveButton:o,textarea:r,learnMore:c,errorCloseButton:d,createAutomaticallyButton:u,downloadModel:m,downloadModelDescription:f,title:g},h,b){O(this,os);O(this,Tr);O(this,ao);O(this,mg);O(this,Od);O(this,za);O(this,hg);O(this,Bd);O(this,bg);O(this,yg);O(this,Dr);O(this,Rd);O(this,_g);O(this,Cd,H(this,yg,eL).bind(this));O(this,Td,void 0);O(this,yn,null);O(this,Dd,void 0);O(this,Id,void 0);O(this,Pi,void 0);O(this,$d,void 0);O(this,eo,void 0);O(this,to,void 0);O(this,Sr,void 0);O(this,qs,!1);O(this,Ta,void 0);O(this,Md,null);O(this,Pd,null);O(this,Lr,void 0);O(this,Ar,void 0);O(this,Ya,!1);O(this,xr,!1);O(this,Cr,void 0);O(this,Nd,void 0);O(this,Fs,void 0);O(this,Da,void 0);O(this,Hd,void 0);O(this,un,void 0);O(this,no,null);z(this,Dd,i),z(this,Td,u),z(this,Id,e),z(this,Pi,n),z(this,$d,s),z(this,Nd,l),z(this,Lr,a),z(this,Da,r),z(this,Cr,c),z(this,Hd,g),z(this,eo,m),z(this,to,f),z(this,Fs,h),z(this,Sr,b),n.addEventListener("close",H(this,Rd,Hy).bind(this)),n.addEventListener("contextmenu",y=>{y.target!==x(this,Da)&&y.preventDefault()}),i.addEventListener("click",x(this,Cd)),l.addEventListener("click",x(this,Cd)),o.addEventListener("click",H(this,_g,tL).bind(this)),d.addEventListener("click",()=>{H(this,Tr,Dm).call(this,!1)}),u.addEventListener("click",()=>se(this,null,function*(){const y=u.getAttribute("aria-pressed")!=="true";x(this,yn)._reportTelemetry({action:"pdfjs.image.alt_text.ai_generation_check",data:{status:y}}),x(this,un)&&(x(this,un).setPreference("enableGuessAltText",y),yield x(this,un).mlManager.toggleService("altText",y)),H(this,ao,yf).call(this,y,!1)})),r.addEventListener("focus",()=>{z(this,xr,x(this,Ya)),H(this,os,Ho).call(this,!1),H(this,za,Wi).call(this)}),r.addEventListener("blur",()=>{r.value||H(this,os,Ho).call(this,x(this,xr)),H(this,za,Wi).call(this)}),r.addEventListener("input",()=>{H(this,za,Wi).call(this)}),b._on("enableguessalttext",({value:y})=>{H(this,ao,yf).call(this,y,!1)}),x(this,Fs).register(n),x(this,Cr).addEventListener("click",()=>{x(this,yn)._reportTelemetry({action:"pdfjs.image.alt_text.info",data:{topic:"alt_text"}})})}editAltText(e,n,a){return se(this,null,function*(){var f;if(x(this,yn)||!n)return;if(a&&n.hasAltTextData()){n.altTextFinish();return}z(this,qs,a);let{mlManager:i}=e,s=!!i;H(this,za,Wi).call(this),i&&!i.isReady("altText")?(s=!1,i.hasProgress?H(this,bg,QS).call(this):i=null):x(this,eo).classList.toggle("hidden",!0);const l=i==null?void 0:i.isEnabledFor("altText");z(this,yn,n),z(this,un,e),x(this,un).removeEditListeners(),{altText:Tm(this,no)._}=n.altTextData,x(this,Da).value=(f=x(this,no))!=null?f:"";const o=224,r=180;let c,d,u;i?({canvas:c,width:d,height:u,imageData:Tm(this,Ar)._}=n.copyCanvas(o,r,!0),s&&H(this,ao,yf).call(this,yield l,!0)):{canvas:c,width:d,height:u}=n.copyCanvas(o,r,!1),c.setAttribute("role","presentation");const{style:m}=c;m.width=`${d}px`,m.height=`${u}px`,x(this,Lr).append(c),H(this,mg,JS).call(this),H(this,Od,Py).call(this,s),H(this,Tr,Dm).call(this,!1);try{yield x(this,Fs).open(x(this,Pi))}catch(g){throw H(this,Rd,Hy).call(this),g}})}destroy(){z(this,un,null),H(this,Dr,Im).call(this)}}Cd=new WeakMap,Td=new WeakMap,yn=new WeakMap,Dd=new WeakMap,Id=new WeakMap,Pi=new WeakMap,$d=new WeakMap,eo=new WeakMap,to=new WeakMap,Sr=new WeakMap,qs=new WeakMap,Ta=new WeakMap,Md=new WeakMap,Pd=new WeakMap,Lr=new WeakMap,Ar=new WeakMap,Ya=new WeakMap,xr=new WeakMap,Cr=new WeakMap,Nd=new WeakMap,Fs=new WeakMap,Da=new WeakMap,Hd=new WeakMap,un=new WeakMap,no=new WeakMap,os=new WeakSet,Ho=function(e){!x(this,un)||x(this,Ya)===e||(z(this,Ya,e),x(this,Id).classList.toggle("loading",e))},Tr=new WeakSet,Dm=function(e){x(this,un)&&x(this,Pi).classList.toggle("error",e)},ao=new WeakSet,yf=function(e,n=!1){return se(this,null,function*(){if(x(this,un))if(x(this,Pi).classList.toggle("aiDisabled",!e),x(this,Td).setAttribute("aria-pressed",e),e){const{altTextLearnMoreUrl:a}=x(this,un).mlManager;a&&(x(this,Cr).href=a),H(this,hg,XS).call(this,n)}else H(this,os,Ho).call(this,!1),z(this,Ya,!1),H(this,za,Wi).call(this)})},mg=new WeakSet,JS=function(){x(this,Nd).classList.toggle("hidden",!x(this,qs)),x(this,Dd).classList.toggle("hidden",x(this,qs))},Od=new WeakSet,Py=function(e){!x(this,un)||x(this,Md)===e||(z(this,Md,e),x(this,Pi).classList.toggle("noAi",!e),H(this,za,Wi).call(this))},za=new WeakSet,Wi=function(){const e=x(this,Ya)||x(this,Ta)&&x(this,Ta)===x(this,Da).value;x(this,$d).hidden=!e;const n=x(this,Ya)||!!x(this,Da).value;x(this,Pd)!==n&&(z(this,Pd,n),x(this,Hd).setAttribute("data-l10n-id",n?"pdfjs-editor-new-alt-text-dialog-edit-label":"pdfjs-editor-new-alt-text-dialog-add-label"))},hg=new WeakSet,XS=function(e){return se(this,null,function*(){if(x(this,Ya)||x(this,Da).value||e&&x(this,no)!==null)return;if(z(this,Ta,x(this,yn).guessedAltText),x(this,no)===null&&x(this,Ta)){H(this,Bd,Ny).call(this,x(this,Ta));return}H(this,os,Ho).call(this,!0),H(this,za,Wi).call(this);let n=!1;try{const a=yield x(this,yn).mlGuessAltText(x(this,Ar),!1);a&&(z(this,Ta,a),z(this,xr,x(this,Ya)),x(this,Ya)&&H(this,Bd,Ny).call(this,a))}catch(a){console.error(a),n=!0}H(this,os,Ho).call(this,!1),H(this,za,Wi).call(this),n&&x(this,un)&&H(this,Tr,Dm).call(this,!0)})},Bd=new WeakSet,Ny=function(e){!x(this,un)||x(this,Da).value||(x(this,Da).value=e,H(this,za,Wi).call(this))},bg=new WeakSet,QS=function(){x(this,eo).classList.toggle("hidden",!1);const e=s=>se(this,[s],function*({detail:{finished:n,total:a,totalLoaded:i}}){i=Math.min(.99*a,i);const o=x(this,to).ariaValueMax=Math.round(a/1e6),r=x(this,to).ariaValueNow=Math.round(i/1e6);if(x(this,to).setAttribute("data-l10n-args",JSON.stringify({totalSize:o,downloadedSize:r})),!n||(x(this,Sr)._off("loadaiengineprogress",e),x(this,eo).classList.toggle("hidden",!0),H(this,Od,Py).call(this,!0),!x(this,un)))return;const{mlManager:c}=x(this,un);c.toggleService("altText",!0),H(this,ao,yf).call(this,yield c.isEnabledFor("altText"),!0)});x(this,Sr)._on("loadaiengineprogress",e)},yg=new WeakSet,eL=function(){x(this,yn).altTextData={cancel:!0};const e=x(this,Da).value.trim();x(this,yn)._reportTelemetry({action:"pdfjs.image.alt_text.dismiss",data:{alt_text_type:e?"present":"empty",flow:x(this,qs)?"image_add":"alt_text_edit"}}),x(this,yn)._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!0,alt_text_type:"skipped"}}),H(this,Dr,Im).call(this)},Dr=new WeakSet,Im=function(){x(this,Fs).active===x(this,Pi)&&x(this,Fs).close(x(this,Pi))},Rd=new WeakSet,Hy=function(){var n,a;const e=x(this,Lr).firstChild;e.remove(),e.width=e.height=0,z(this,Ar,null),H(this,os,Ho).call(this,!1),(n=x(this,un))==null||n.addEditListeners(),x(this,yn).altTextFinish(),(a=x(this,un))==null||a.setSelected(x(this,yn)),z(this,yn,null),z(this,un,null)},_g=new WeakSet,tL=function(){const e=x(this,Da).value.trim();if(x(this,yn).altTextData={altText:e,decorative:!1},x(this,yn).altTextData.guessedAltText=x(this,Ta),x(this,Ta)&&x(this,Ta)!==e){const n=new Set(x(this,Ta).split(/\s+/)),a=new Set(e.split(/\s+/));x(this,yn)._reportTelemetry({action:"pdfjs.image.alt_text.user_edit",data:{total_words:n.size,words_removed:n.difference(a).size,words_added:a.difference(n).size}})}x(this,yn)._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!0,alt_text_type:e?"present":"empty"}}),x(this,yn)._reportTelemetry({action:"pdfjs.image.alt_text.save",data:{alt_text_type:e?"present":"empty",flow:x(this,qs)?"image_add":"alt_text_edit"}}),H(this,Dr,Im).call(this)};class AD{constructor({dialog:e,createModelButton:n,aiModelSettings:a,learnMore:i,closeButton:s,deleteModelButton:l,downloadModelButton:o,showAltTextDialogButton:r},c,d,u){O(this,oo);O(this,Fd);O(this,Ud);O(this,Wd);O(this,Vs);O(this,wg);O(this,io,void 0);O(this,Ni,void 0);O(this,so,void 0);O(this,lo,void 0);O(this,Ir,void 0);O(this,Us,void 0);O(this,Ws,void 0);O(this,qd,void 0);z(this,lo,e),z(this,io,a),z(this,Ni,n),z(this,so,o),z(this,qd,r),z(this,Ws,c),z(this,Ir,d),z(this,Us,u);const{altTextLearnMoreUrl:m}=u;m&&(i.href=m),e.addEventListener("contextmenu",noContextMenu),n.addEventListener("click",f=>se(this,null,function*(){const g=H(this,Wd,Ry).call(this,"enableGuessAltText",f);yield u.toggleService("altText",g),H(this,oo,_f).call(this,{type:"stamp",action:"pdfjs.image.alt_text.settings_ai_generation_check",data:{status:g}})})),r.addEventListener("click",f=>{const g=H(this,Wd,Ry).call(this,"enableNewAltTextWhenAddingImage",f);H(this,oo,_f).call(this,{type:"stamp",action:"pdfjs.image.alt_text.settings_edit_alt_text_check",data:{status:g}})}),l.addEventListener("click",H(this,Ud,By).bind(this,!0)),o.addEventListener("click",H(this,Fd,Oy).bind(this,!0)),s.addEventListener("click",H(this,wg,nL).bind(this)),i.addEventListener("click",()=>{H(this,oo,_f).call(this,{type:"stamp",action:"pdfjs.image.alt_text.info",data:{topic:"ai_generation"}})}),d._on("enablealttextmodeldownload",({value:f})=>{f?H(this,Fd,Oy).call(this,!1):H(this,Ud,By).call(this,!1)}),x(this,Ws).register(e)}open(a){return se(this,arguments,function*({enableGuessAltText:e,enableNewAltTextWhenAddingImage:n}){const{enableAltTextModelDownload:i}=x(this,Us);x(this,Ni).disabled=!i,x(this,Ni).setAttribute("aria-pressed",i&&e),x(this,qd).setAttribute("aria-pressed",n),x(this,io).classList.toggle("download",!i),yield x(this,Ws).open(x(this,lo)),H(this,oo,_f).call(this,{type:"stamp",action:"pdfjs.image.alt_text.settings_displayed"})})}}io=new WeakMap,Ni=new WeakMap,so=new WeakMap,lo=new WeakMap,Ir=new WeakMap,Us=new WeakMap,Ws=new WeakMap,qd=new WeakMap,oo=new WeakSet,_f=function(e){x(this,Ir).dispatch("reporttelemetry",{source:this,details:{type:"editing",data:e}})},Fd=new WeakSet,Oy=function(e=!1){return se(this,null,function*(){if(e){x(this,so).disabled=!0;const n=x(this,so).firstChild;n.setAttribute("data-l10n-id","pdfjs-editor-alt-text-settings-downloading-model-button"),yield x(this,Us).downloadModel("altText"),n.setAttribute("data-l10n-id","pdfjs-editor-alt-text-settings-download-model-button"),x(this,Ni).disabled=!1,H(this,Vs,dc).call(this,"enableGuessAltText",!0),x(this,Us).toggleService("altText",!0),H(this,Vs,dc).call(this,"enableAltTextModelDownload",!0),x(this,so).disabled=!1}x(this,io).classList.toggle("download",!1),x(this,Ni).setAttribute("aria-pressed",!0)})},Ud=new WeakSet,By=function(e=!1){return se(this,null,function*(){e&&(yield x(this,Us).deleteModel("altText"),H(this,Vs,dc).call(this,"enableGuessAltText",!1),H(this,Vs,dc).call(this,"enableAltTextModelDownload",!1)),x(this,io).classList.toggle("download",!0),x(this,Ni).disabled=!0,x(this,Ni).setAttribute("aria-pressed",!1)})},Wd=new WeakSet,Ry=function(e,{target:n}){const a=n.getAttribute("aria-pressed")!=="true";return H(this,Vs,dc).call(this,e,a),n.setAttribute("aria-pressed",a),a},Vs=new WeakSet,dc=function(e,n){x(this,Ir).dispatch("setpreference",{source:this,name:e,value:n})},wg=new WeakSet,nL=function(){x(this,Ws).active===x(this,lo)&&x(this,Ws).close(x(this,lo))};class kC{constructor(e,n){O(this,vg);this.eventBus=n,H(this,vg,aL).call(this,e)}}vg=new WeakSet,aL=function({editorFreeTextFontSize:e,editorFreeTextColor:n,editorInkColor:a,editorInkThickness:i,editorInkOpacity:s,editorStampAddImage:l,editorFreeHighlightThickness:o,editorHighlightShowAll:r}){const c=(d,u)=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:ae.AnnotationEditorParamsType[d],value:u})};e.addEventListener("input",function(){c("FREETEXT_SIZE",this.valueAsNumber)}),n.addEventListener("input",function(){c("FREETEXT_COLOR",this.value)}),a.addEventListener("input",function(){c("INK_COLOR",this.value)}),i.addEventListener("input",function(){c("INK_THICKNESS",this.valueAsNumber)}),s.addEventListener("input",function(){c("INK_OPACITY",this.valueAsNumber)}),l.addEventListener("click",()=>{this.eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{action:"pdfjs.image.add_image_click"}}}),c("CREATE")}),o.addEventListener("input",function(){c("HIGHLIGHT_THICKNESS",this.valueAsNumber)}),r.addEventListener("click",function(){const d=this.getAttribute("aria-pressed")==="true";this.setAttribute("aria-pressed",!d),c("HIGHLIGHT_SHOW_ALL",!d)}),this.eventBus._on("annotationeditorparamschanged",d=>{for(const[u,m]of d.details)switch(u){case ae.AnnotationEditorParamsType.FREETEXT_SIZE:e.value=m;break;case ae.AnnotationEditorParamsType.FREETEXT_COLOR:n.value=m;break;case ae.AnnotationEditorParamsType.INK_COLOR:a.value=m;break;case ae.AnnotationEditorParamsType.INK_THICKNESS:i.value=m;break;case ae.AnnotationEditorParamsType.INK_OPACITY:s.value=m;break;case ae.AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:o.value=m;break;case ae.AnnotationEditorParamsType.HIGHLIGHT_FREE:o.disabled=!m;break;case ae.AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL:r.setAttribute("aria-pressed",m);break}})};const qp=.1,Jd=class Jd{constructor(e,n,a,i){O(this,zd);O(this,Gd);O(this,Eg);O(this,jd);O(this,Zd);O(this,ro);O(this,kg);O(this,Vd,void 0);O(this,$r,0);O(this,Yd,void 0);if(z(this,Vd,n),z(this,Yd,a),!i)return;z(this,$r,i.getBoundingClientRect().height);const s=new ResizeObserver(l=>{for(const o of l)if(o.target===i){z(this,$r,Math.floor(o.borderBoxSize[0].blockSize));break}});s.observe(i),e.addEventListener("abort",()=>s.disconnect(),{once:!0})}moveCaret(e,n){const a=document.getSelection();if(a.rangeCount===0)return;const{focusNode:i}=a,s=i.nodeType!==Node.ELEMENT_NODE?i.parentElement:i,l=s.closest(".textLayer");if(!l)return;const o=document.createTreeWalker(l,NodeFilter.SHOW_TEXT);o.currentNode=i;const r=s.getBoundingClientRect();let c=null;const d=(e?o.previousSibling:o.nextSibling).bind(o);for(;d();){const g=o.currentNode.parentElement;if(!H(this,zd,qy).call(this,r,g.getBoundingClientRect())){c=g;break}}if(!c){const g=H(this,kg,sL).call(this,l,e);if(!g)return;if(n){const y=(e?o.firstChild():o.lastChild())||i;a.extend(y,e?0:y.length);const w=document.createRange();w.setStart(g,e?g.length:0),w.setEnd(g,e?g.length:0),a.addRange(w);return}const[h]=H(this,jd,Uy).call(this,a,e),{parentElement:b}=g;H(this,ro,wf).call(this,n,a,b,b.getBoundingClientRect(),h);return}const[u,m]=H(this,jd,Uy).call(this,a,e),f=c.getBoundingClientRect();if(H(this,Gd,Fy).call(this,f,u,m,e)){H(this,ro,wf).call(this,n,a,c,f,u);return}for(;d();){const g=o.currentNode.parentElement,h=g.getBoundingClientRect();if(!H(this,zd,qy).call(this,f,h))break;if(H(this,Gd,Fy).call(this,h,u,m,e)){H(this,ro,wf).call(this,n,a,g,h,u);return}}H(this,ro,wf).call(this,n,a,c,f,u)}};Vd=new WeakMap,$r=new WeakMap,Yd=new WeakMap,zd=new WeakSet,qy=function(e,n){const a=e.y,i=e.bottom,s=e.y+e.height/2,l=n.y,o=n.bottom,r=n.y+n.height/2;return a<=r&&r<=i||l<=s&&s<=o},Gd=new WeakSet,Fy=function(e,n,a,i){const s=e.y+e.height/2;return(i?a>=s:a<=s)&&e.x-qp<=n&&n<=e.right+qp},Eg=new WeakSet,iL=function(e){return e.top>=x(this,$r)&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)},jd=new WeakSet,Uy=function(e,n){const{focusNode:a,focusOffset:i}=e,s=document.createRange();s.setStart(a,i),s.setEnd(a,i);const l=s.getBoundingClientRect();return[l.x,n?l.top:l.bottom]},Kd=new WeakSet,Wy=function(e,n){if((typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&!document.caretPositionFromPoint){const{startContainer:a,startOffset:i}=document.caretRangeFromPoint(e,n);return{offsetNode:a,offset:i}}return document.caretPositionFromPoint(e,n)},Zd=new WeakSet,Vy=function(e,n,a,i,s){var c,d,u,m;if(s||(s=i.getBoundingClientRect()),n<=s.x+qp){a?e.extend(i.firstChild,0):e.setPosition(i.firstChild,0);return}if(s.right-qp<=n){const{lastChild:f}=i;a?e.extend(f,f.length):e.setPosition(f,f.length);return}const l=s.y+s.height/2;let o=H(c=Jd,Kd,Wy).call(c,n,l),r=(d=o.offsetNode)==null?void 0:d.parentElement;if(r&&r!==i){const f=document.elementsFromPoint(n,l),g=[];for(const h of f){if(h===i)break;const{style:b}=h;g.push([h,b.visibility]),b.visibility="hidden"}o=H(u=Jd,Kd,Wy).call(u,n,l),r=(m=o.offsetNode)==null?void 0:m.parentElement;for(const[h,b]of g)h.style.visibility=b}if(r!==i){a?e.extend(i.firstChild,0):e.setPosition(i.firstChild,0);return}a?e.extend(o.offsetNode,o.offset):e.setPosition(o.offsetNode,o.offset)},ro=new WeakSet,wf=function(e,n,a,i,s){if(H(this,Eg,iL).call(this,i)){H(this,Zd,Vy).call(this,n,s,e,a,i);return}x(this,Vd).addEventListener("scrollend",H(this,Zd,Vy).bind(this,n,s,e,a,null),{once:!0}),a.scrollIntoView()},kg=new WeakSet,sL=function(e,n){for(;;){const a=e.closest(".page"),i=parseInt(a.getAttribute("data-page-number")),s=n?i-1:i+1;if(e=x(this,Yd).querySelector(`.page[data-page-number="${s}"] .textLayer`),!e)return null;const l=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),o=n?l.lastChild():l.firstChild();if(o)return o}},O(Jd,Kd);let Tb=Jd;if(typeof PDFJSDev!="undefined"&&!PDFJSDev.test("CHROME || GENERIC"))throw new Error('Module "pdfjs-web/download_manager" shall not be used outside CHROME and GENERIC builds.');function sk(t,e){const n=document.createElement("a");if(!n.click)throw new Error('DownloadManager: "a.click()" is not supported.');n.href=t,n.target="_parent","download"in n&&(n.download=e),(document.body||document.documentElement).append(n),n.click(),n.remove()}class SC{constructor(){O(this,Mr,new WeakMap)}downloadData(e,n,a){const i=URL.createObjectURL(new Blob([e],{type:a}));sk(i,n)}openOrDownloadData(e,n,a=null){const i=(0,ae.isPdfFile)(n),s=i?"application/pdf":"";if((typeof PDFJSDev=="undefined"||!PDFJSDev.test("COMPONENTS"))&&i){let l=x(this,Mr).get(e);l||(l=URL.createObjectURL(new Blob([e],{type:s})),x(this,Mr).set(e,l));let o;typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?o="?file="+encodeURIComponent(l+"#"+n):PDFJSDev.test("CHROME")&&(o=chrome.runtime.getURL("/content/web/viewer.html")+"?file="+encodeURIComponent(l+"#"+n)),a&&(o+=`#${escape(a)}`);try{return window.open(o),!0}catch(r){console.error(`openOrDownloadData: ${r}`),URL.revokeObjectURL(l),x(this,Mr).delete(e)}}return this.downloadData(e,n,s),!1}download(e,n,a){let i;if(e)i=URL.createObjectURL(new Blob([e],{type:"application/pdf"}));else{if(!(0,ae.createValidAbsoluteUrl)(n,"http://example.com")){console.error(`download - not a valid URL: ${n}`);return}i=n+"#pdfjs.action=download"}sk(i,a)}}Mr=new WeakMap;class LC{constructor(){O(this,Ys,new WeakMap);O(this,Ga,null)}get active(){return x(this,Ga)}register(e,n=!1){return se(this,null,function*(){if(typeof e!="object")throw new Error("Not enough parameters.");if(x(this,Ys).has(e))throw new Error("The overlay is already registered.");x(this,Ys).set(e,{canForceClose:n}),e.addEventListener("cancel",a=>{z(this,Ga,null)})})}open(e){return se(this,null,function*(){if(x(this,Ys).has(e)){if(x(this,Ga)){if(x(this,Ga)===e)throw new Error("The overlay is already active.");if(x(this,Ys).get(e).canForceClose)yield this.close();else throw new Error("Another overlay is currently active.")}}else throw new Error("The overlay does not exist.");z(this,Ga,e),e.classList.add("dialog--open")})}close(){return se(this,arguments,function*(e=x(this,Ga)){if(x(this,Ys).has(e))if(x(this,Ga)){if(x(this,Ga)!==e)throw new Error("Another overlay is currently active.")}else throw new Error("The overlay is currently not active.");else throw new Error("The overlay does not exist.");e.classList.remove("dialog--open"),z(this,Ga,null)})}}Ys=new WeakMap,Ga=new WeakMap;class AC{constructor(e,n,a=!1){O(this,Qd);O(this,Sg);O(this,eu);O(this,rs,null);O(this,co,null);O(this,Xd,null);this.dialog=e.dialog,this.label=e.label,this.input=e.input,this.submitButton=e.submitButton,this.cancelButton=e.cancelButton,this.overlayManager=n,this._isViewerEmbedded=a,this.submitButton.addEventListener("click",H(this,Qd,Yy).bind(this)),this.cancelButton.addEventListener("click",this.close.bind(this)),this.input.addEventListener("keydown",i=>{i.keyCode===13&&H(this,Qd,Yy).call(this)}),this.overlayManager.register(this.dialog,!0),this.dialog.addEventListener("close",H(this,Sg,lL).bind(this))}open(){return se(this,null,function*(){var n;yield(n=x(this,rs))==null?void 0:n.promise,z(this,rs,Promise.withResolvers());try{yield this.overlayManager.open(this.dialog)}catch(a){throw x(this,rs).resolve(),a}const e=x(this,Xd)===ae.PasswordResponses.INCORRECT_PASSWORD;(!this._isViewerEmbedded||e)&&this.input.focus(),this.label.textContent=window.siyuan.languages[`password_${e?"invalid":"label"}`]})}close(){return se(this,null,function*(){this.overlayManager.active===this.dialog&&this.overlayManager.close(this.dialog)})}setUpdateCallback(e,n){return se(this,null,function*(){x(this,rs)&&(yield x(this,rs).promise),z(this,co,e),z(this,Xd,n)})}}rs=new WeakMap,co=new WeakMap,Xd=new WeakMap,Qd=new WeakSet,Yy=function(){const e=this.input.value;(e==null?void 0:e.length)>0&&H(this,eu,zy).call(this,e)},Sg=new WeakSet,lL=function(){H(this,eu,zy).call(this,new Error("PasswordPrompt cancelled.")),x(this,rs).resolve()},eu=new WeakSet,zy=function(e){x(this,co)&&(this.close(),this.input.value="",x(this,co).call(this,e),z(this,co,null))};const xC=-100,lk="selected";class rd{constructor(e){if((typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"))&&this.constructor===rd)throw new Error("Cannot initialize BaseTreeViewer.");this.container=e.container,this.eventBus=e.eventBus,this._l10n=e.l10n,this.reset()}reset(){this._pdfDocument=null,this._lastToggleIsShow=!0,this._currentTreeItem=null,this.container.textContent="",this.container.classList.remove("treeWithDeepNesting")}_dispatchEvent(e){throw new Error("Not implemented: _dispatchEvent")}_bindLink(e,n){throw new Error("Not implemented: _bindLink")}_normalizeTextContent(e){return dr(e,!0)||"\u2013"}_addToggleButton(e,n=!1){const a=document.createElement("div");a.innerHTML='<svg><use xlink:href="#iconDown"></use></svg>',a.className="treeItemToggler",n&&a.classList.add("treeItemsHidden"),a.onclick=i=>{if(i.stopPropagation(),a.classList.toggle("treeItemsHidden"),i.shiftKey){const s=!a.classList.contains("treeItemsHidden");this._toggleTreeItem(e,s)}},e.prepend(a)}_toggleTreeItem(e,n=!1){this._l10n.pause(),this._lastToggleIsShow=n;for(const a of e.querySelectorAll(".treeItemToggler"))a.classList.toggle("treeItemsHidden",!n);this._l10n.resume()}_toggleAllTreeItems(){this._toggleTreeItem(this.container,!this._lastToggleIsShow)}_finishRendering(e,n,a=!1){a&&(this.container.classList.add("treeWithDeepNesting"),this._lastToggleIsShow=!e.querySelector(".treeItemsHidden")),this._l10n.pause(),this.container.append(e),this._l10n.resume(),this._dispatchEvent(n)}render(e){throw new Error("Not implemented: render")}_updateCurrentTreeItem(e=null){this._currentTreeItem&&(this._currentTreeItem.classList.remove(lk),this._currentTreeItem=null),e&&(e.classList.add(lk),this._currentTreeItem=e)}_scrollToCurrentTreeItem(e){if(!e)return;this._l10n.pause();let n=e.parentNode;for(;n&&n!==this.container;){if(n.classList.contains("treeItem")){const a=n.firstElementChild;a==null||a.classList.remove("treeItemsHidden")}n=n.parentNode}this._l10n.resume(),this._updateCurrentTreeItem(e),this.container.scrollTo(e.offsetLeft,e.offsetTop+xC)}}class CC extends rd{constructor(n){super(n);O(this,Lg);this.downloadManager=n.downloadManager,this.eventBus._on("fileattachmentannotation",H(this,Lg,oL).bind(this))}reset(n=!1){super.reset(),this._attachments=null,n||(this._renderedCapability=Promise.withResolvers()),this._pendingDispatchEvent=!1}_dispatchEvent(n){return se(this,null,function*(){this._renderedCapability.resolve(),!(n===0&&!this._pendingDispatchEvent&&(this._pendingDispatchEvent=!0,yield ik({target:this.eventBus,name:"annotationlayerrendered",delay:1e3}),!this._pendingDispatchEvent))&&(this._pendingDispatchEvent=!1,this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:n}))})}_bindLink(n,{content:a,description:i,filename:s}){i&&(n.title=i),n.onclick=()=>(this.downloadManager.openOrDownloadData(a,s),!1)}render({attachments:n,keepRenderedCapability:a=!1}){if(this._attachments&&this.reset(a),this._attachments=n||null,!n){this._dispatchEvent(0);return}const i=document.createDocumentFragment();let s=0;for(const l in n){const o=n[l],r=document.createElement("div");r.className="treeItem";const c=document.createElement("a");this._bindLink(c,o),c.textContent=this._normalizeTextContent(o.filename),r.append(c),i.append(r),s++}this._finishRendering(i,s)}}Lg=new WeakSet,oL=function(n){const a=this._renderedCapability.promise;a.then(()=>{if(a!==this._renderedCapability.promise)return;const i=this._attachments||Object.create(null);for(const s in i)if(n.filename===s)return;i[n.filename]=n,this.render({attachments:i,keepRenderedCapability:!0})})};const ok="grab-to-pan-grab";class TC{constructor({element:e}){O(this,Ag);O(this,xg);O(this,Cg);this.element=e,this.document=e.ownerDocument,this.activate=this.activate.bind(this),this.deactivate=this.deactivate.bind(this),this.toggle=this.toggle.bind(this),this._onMouseDown=H(this,Ag,rL).bind(this),this._onMouseMove=H(this,xg,cL).bind(this),this._endPan=H(this,Cg,dL).bind(this);const n=this.overlay=document.createElement("div");n.className="grab-to-pan-grabbing"}activate(){this.active||(this.active=!0,this.element.addEventListener("mousedown",this._onMouseDown,!0),this.element.classList.add(ok))}deactivate(){this.active&&(this.active=!1,this.element.removeEventListener("mousedown",this._onMouseDown,!0),this._endPan(),this.element.classList.remove(ok))}toggle(){this.active?this.deactivate():this.activate()}ignoreTarget(e){return e.matches("a[href], a[href] *, input, textarea, button, button *, select, option")}}Ag=new WeakSet,rL=function(e){if(e.button!==0||this.ignoreTarget(e.target))return;if(e.originalTarget)try{e.originalTarget.tagName}catch(a){return}this.scrollLeftStart=this.element.scrollLeft,this.scrollTopStart=this.element.scrollTop,this.clientXStart=e.clientX,this.clientYStart=e.clientY,this.document.addEventListener("mousemove",this._onMouseMove,!0),this.document.addEventListener("mouseup",this._endPan,!0),this.element.addEventListener("scroll",this._endPan,!0),e.preventDefault(),e.stopPropagation();const n=document.activeElement;n&&!n.contains(e.target)&&n.blur()},xg=new WeakSet,cL=function(e){if(this.element.removeEventListener("scroll",this._endPan,!0),!(e.buttons&1)){this._endPan();return}const n=e.clientX-this.clientXStart,a=e.clientY-this.clientYStart;this.element.scrollTo({top:this.scrollTopStart-a,left:this.scrollLeftStart-n,behavior:"instant"}),this.overlay.parentNode||document.body.append(this.overlay)},Cg=new WeakSet,dL=function(){this.element.removeEventListener("scroll",this._endPan,!0),this.document.removeEventListener("mousemove",this._onMouseMove,!0),this.document.removeEventListener("mouseup",this._endPan,!0),this.overlay.remove()};class DC{constructor({container:e,eventBus:n,cursorToolOnLoad:a=Qn.SELECT}){O(this,Pr);O(this,Tg);O(this,zs,Qn.SELECT);O(this,Hi,null);this.container=e,this.eventBus=n,H(this,Tg,uL).call(this),Promise.resolve().then(()=>{this.switchTool(a)})}get activeTool(){return x(this,zs)}switchTool(e){x(this,Hi)===null&&H(this,Pr,$m).call(this,e)}get _handTool(){return(0,ae.shadow)(this,"_handTool",new TC({element:this.container}))}}zs=new WeakMap,Hi=new WeakMap,Pr=new WeakSet,$m=function(e,n=!1){if(e===x(this,zs)){x(this,Hi)!==null&&this.eventBus.dispatch("cursortoolchanged",{source:this,tool:e,disabled:n});return}const a=()=>{switch(x(this,zs)){case Qn.SELECT:break;case Qn.HAND:this._handTool.deactivate();break;case Qn.ZOOM:}};switch(e){case Qn.SELECT:a();break;case Qn.HAND:a(),this._handTool.activate();break;case Qn.ZOOM:default:console.error(`switchTool: "${e}" is an unsupported value.`);return}z(this,zs,e),this.eventBus.dispatch("cursortoolchanged",{source:this,tool:e,disabled:n})},Tg=new WeakSet,uL=function(){this.eventBus._on("switchcursortool",s=>{s.reset?x(this,Hi)!==null&&(e=ae.AnnotationEditorType.NONE,n=kn.NORMAL,i()):this.switchTool(s.tool)});let e=ae.AnnotationEditorType.NONE,n=kn.NORMAL;const a=()=>{var s;(s=x(this,Hi))!=null||z(this,Hi,x(this,zs)),H(this,Pr,$m).call(this,Qn.SELECT,!0)},i=()=>{x(this,Hi)!==null&&e===ae.AnnotationEditorType.NONE&&n===kn.NORMAL&&(H(this,Pr,$m).call(this,x(this,Hi)),z(this,Hi,null))};this.eventBus._on("annotationeditormodechanged",({mode:s})=>{e=s,s===ae.AnnotationEditorType.NONE?i():a()}),this.eventBus._on("presentationmodechanged",({state:s})=>{n=s,s===kn.NORMAL?i():s===kn.FULLSCREEN&&a()})};const IC=["en-us","en-lr","my"],$C={"8.5x11":"pdfjs-document-properties-page-size-name-letter","8.5x14":"pdfjs-document-properties-page-size-name-legal"},rk={"297x420":"pdfjs-document-properties-page-size-name-a-three","210x297":"pdfjs-document-properties-page-size-name-a-four"};function Db(t,e,n){const a=e?t.width:t.height,i=e?t.height:t.width;return n[`${a}x${i}`]}class MC{constructor({dialog:e,fields:n,closeButton:a},i,s,l,o){O(this,tu);O(this,uo);O(this,nu);O(this,Dg);O(this,au);O(this,Ig);O(this,ja,null);this.dialog=e,this.fields=n,this.overlayManager=i,this.l10n=l,this._fileNameLookup=o,H(this,tu,Gy).call(this),a.addEventListener("click",this.close.bind(this)),this.overlayManager.register(this.dialog),s._on("pagechanging",r=>{this._currentPageNumber=r.pageNumber}),s._on("rotationchanging",r=>{this._pagesRotation=r.pagesRotation})}open(){return se(this,null,function*(){yield Promise.all([this.overlayManager.open(this.dialog),this._dataAvailableCapability.promise]);const e=this._currentPageNumber,n=this._pagesRotation;if(x(this,ja)&&e===x(this,ja)._currentPageNumber&&n===x(this,ja)._pagesRotation){H(this,uo,vf).call(this);return}const{info:a,contentLength:i}=yield this.pdfDocument.getMetadata(),[s,l,o,r,c,d]=yield Promise.all([this._fileNameLookup(),H(this,nu,jy).call(this,i),H(this,au,Ky).call(this,a.CreationDate),H(this,au,Ky).call(this,a.ModDate),this.pdfDocument.getPage(e).then(f=>H(this,Dg,fL).call(this,rC(f),n)),H(this,Ig,pL).call(this,a.IsLinearized)]);z(this,ja,Object.freeze({fileName:s,fileSize:l,title:a.Title,author:a.Author,subject:a.Subject,keywords:a.Keywords,creationDate:o,modificationDate:r,creator:a.Creator,producer:a.Producer,version:a.PDFFormatVersion,pageCount:this.pdfDocument.numPages,pageSize:c,linearized:d,_currentPageNumber:e,_pagesRotation:n})),H(this,uo,vf).call(this);const{length:u}=yield this.pdfDocument.getDownloadInfo();if(i===u)return;const m=Object.assign(Object.create(null),x(this,ja));m.fileSize=yield H(this,nu,jy).call(this,u),z(this,ja,Object.freeze(m)),H(this,uo,vf).call(this)})}close(){return se(this,null,function*(){this.overlayManager.close(this.dialog)})}setDocument(e){this.pdfDocument&&(H(this,tu,Gy).call(this),H(this,uo,vf).call(this)),e&&(this.pdfDocument=e,this._dataAvailableCapability.resolve())}}ja=new WeakMap,tu=new WeakSet,Gy=function(){this.pdfDocument=null,z(this,ja,null),this._dataAvailableCapability=Promise.withResolvers(),this._currentPageNumber=1,this._pagesRotation=0},uo=new WeakSet,vf=function(){var e;if(!(x(this,ja)&&this.overlayManager.active!==this.dialog))for(const n in this.fields){const a=(e=x(this,ja))==null?void 0:e[n];this.fields[n].textContent=a||a===0?a:"-"}},nu=new WeakSet,jy=function(e=0){return se(this,null,function*(){const n=e/1024,a=n/1024;return n?a>=1?`${a.toPrecision(3)} MB ${e} bytes`:`${n.toPrecision(3)} KB ${e} bytes`:void 0})},Dg=new WeakSet,fL=function(e,n){return se(this,null,function*(){if(!e)return;n%180!==0&&(e={width:e.height,height:e.width});const a=Eb(e),i=IC.includes(this.l10n.getLanguage());let s={width:Math.round(e.width*100)/100,height:Math.round(e.height*100)/100},l={width:Math.round(e.width*25.4*10)/10,height:Math.round(e.height*25.4*10)/10},o=Db(s,a,$C)||Db(l,a,rk);if(!o&&!(Number.isInteger(l.width)&&Number.isInteger(l.height))){const f={width:e.width*25.4,height:e.height*25.4},g={width:Math.round(l.width),height:Math.round(l.height)};Math.abs(f.width-g.width)<.1&&Math.abs(f.height-g.height)<.1&&(o=Db(g,a,rk),o&&(s={width:Math.round(g.width/25.4*100)/100,height:Math.round(g.height/25.4*100)/100},l=g))}const[{width:r,height:c},d,u,m]=yield Promise.all([i?s:l,this.l10n.get(i?"unitInches":"unitMillimeters"),o&&this.l10n.get(o),this.l10n.get(a?"document_properties_page_size_orientation_portrait":"document_properties_page_size_orientation_landscape")]);return u?`${r.toLocaleString()} \xD7 ${c.toLocaleString()} ${d} (${u}, ${m})`:`${r.toLocaleString()} \xD7 ${c.toLocaleString()} ${d} (${m})`})},au=new WeakSet,Ky=function(e){return se(this,null,function*(){const n=ae.PDFDateString.toDateObject(e);return n?`${n.toLocaleDateString()}, ${n.toLocaleTimeString()}`:void 0})},Ig=new WeakSet,pL=function(e){return this.l10n.get(e?"Yes":"No")};const di={SPACE:0,ALPHA_LETTER:1,PUNCT:2,HAN_LETTER:3,KATAKANA_LETTER:4,HIRAGANA_LETTER:5,HALFWIDTH_KATAKANA_LETTER:6,THAI_LETTER:7};function PC(t){return t<11904}function NC(t){return(t&65408)===0}function HC(t){return t>=97&&t<=122||t>=65&&t<=90}function OC(t){return t>=48&&t<=57}function BC(t){return t===32||t===9||t===13||t===10}function RC(t){return t>=13312&&t<=40959||t>=63744&&t<=64255}function qC(t){return t>=12448&&t<=12543}function FC(t){return t>=12352&&t<=12447}function UC(t){return t>=65376&&t<=65439}function WC(t){return(t&65408)===3584}function Fp(t){return PC(t)?NC(t)?BC(t)?di.SPACE:HC(t)||OC(t)||t===95?di.ALPHA_LETTER:di.PUNCT:WC(t)?di.THAI_LETTER:t===160?di.SPACE:di.ALPHA_LETTER:RC(t)?di.HAN_LETTER:qC(t)?di.KATAKANA_LETTER:FC(t)?di.HIRAGANA_LETTER:UC(t)?di.HALFWIDTH_KATAKANA_LETTER:di.ALPHA_LETTER}let Ib;function VC(){if(Ib||(Ib="\xA0\xA8\xAA\xAF\xB2-\xB5\xB8-\xBA\xBC-\xBE\u0132-\u0133\u013F-\u0140\u0149\u017F\u01C4-\u01CC\u01F1-\u01F3\u02B0-\u02B8\u02D8-\u02DD\u02E0-\u02E4\u0374\u037A\u037E\u0384-\u0385\u0387\u03D0-\u03D6\u03F0-\u03F2\u03F4-\u03F5\u03F9\u0587\u0675-\u0678\u0958-\u095F\u09DC-\u09DD\u09DF\u0A33\u0A36\u0A59-\u0A5B\u0A5E\u0B5C-\u0B5D\u0E33\u0EB3\u0EDC-\u0EDD\u0F0C\u0F43\u0F4D\u0F52\u0F57\u0F5C\u0F69\u10FC\u1D2C-\u1D2E\u1D30-\u1D3A\u1D3C-\u1D4D\u1D4F-\u1D6A\u1D78\u1D9B-\u1DBF\u1E9A-\u1E9B\u1F71\u1F73\u1F75\u1F77\u1F79\u1F7B\u1F7D\u1FBB\u1FBD-\u1FC1\u1FC9\u1FCB\u1FCD-\u1FCF\u1FD3\u1FDB\u1FDD-\u1FDF\u1FE3\u1FEB\u1FED-\u1FEF\u1FF9\u1FFB\u1FFD-\u1FFE\u2000-\u200A\u2011\u2017\u2024-\u2026\u202F\u2033-\u2034\u2036-\u2037\u203C\u203E\u2047-\u2049\u2057\u205F\u2070-\u2071\u2074-\u208E\u2090-\u209C\u20A8\u2100-\u2103\u2105-\u2107\u2109-\u2113\u2115-\u2116\u2119-\u211D\u2120-\u2122\u2124\u2126\u2128\u212A-\u212D\u212F-\u2131\u2133-\u2139\u213B-\u2140\u2145-\u2149\u2150-\u217F\u2189\u222C-\u222D\u222F-\u2230\u2329-\u232A\u2460-\u24EA\u2A0C\u2A74-\u2A76\u2ADC\u2C7C-\u2C7D\u2D6F\u2E9F\u2EF3\u2F00-\u2FD5\u3000\u3036\u3038-\u303A\u309B-\u309C\u309F\u30FF\u3131-\u318E\u3192-\u319F\u3200-\u321E\u3220-\u3247\u3250-\u327E\u3280-\u33FF\uA69C-\uA69D\uA770\uA7F2-\uA7F4\uA7F8-\uA7F9\uAB5C-\uAB5F\uAB69\uF900-\uFA0D\uFA10\uFA12\uFA15-\uFA1E\uFA20\uFA22\uFA25-\uFA26\uFA2A-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFC\uFE10-\uFE19\uFE30-\uFE44\uFE47-\uFE52\uFE54-\uFE66\uFE68-\uFE6B\uFE70-\uFE72\uFE74\uFE76-\uFEFC\uFF01-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\uFFE0-\uFFE6"),typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING")){const t=[],e=[],n=new RegExp("^\\p{M}$","u");for(let a=0;a<65536;a++){const i=String.fromCharCode(a);if(i.normalize("NFKC")!==i&&!n.test(i)){if(e.length!==2){e[0]=e[1]=a;continue}e[1]+1!==a?(e[0]===e[1]?t.push(String.fromCharCode(e[0])):t.push(`${String.fromCharCode(e[0])}-${String.fromCharCode(e[1])}`),e[0]=e[1]=a):e[1]=a}}if(t.join("")!==Ib)throw new Error("getNormalizeWithNFKC - update the `NormalizeWithNFKC` string.")}return Ib}const Fa={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3},YC=250,zC=-50,GC=-400,ck={"\u2010":"-","\u2018":"'","\u2019":"'","\u201A":"'","\u201B":"'","\u201C":'"',"\u201D":'"',"\u201E":'"',"\u201F":'"',"\xBC":"1/4","\xBD":"1/2","\xBE":"3/4"},dk=new Set([12441,12442,2381,2509,2637,2765,2893,3021,3149,3277,3387,3388,3405,3530,3642,3770,3972,4153,4154,5908,5940,6098,6752,6980,7082,7083,7154,7155,11647,43014,43052,43204,43347,43456,43766,44013,3158,3953,3954,3962,3963,3964,3965,3968,3956]);let uk;const jC=new RegExp("\\p{M}+","gu"),KC=new RegExp("([.*+?^${}()|[\\]\\\\])|(\\p{P})|(\\s+)|(\\p{M})|(\\p{L})","gu"),ZC=new RegExp("([^\\p{M}])\\p{M}*$","u"),JC=new RegExp("^\\p{M}*([^\\p{M}])","u"),XC=/[\uAC00-\uD7AF\uFA6C\uFACF-\uFAD1\uFAD5-\uFAD7]+/g,fk=new Map,QC="[\\u1100-\\u1112\\ud7a4-\\ud7af\\ud84a\\ud84c\\ud850\\ud854\\ud857\\ud85f]",pk=new Map;let $b=null,Mb=null;function Pb(t){const e=[];let n;for(;(n=XC.exec(t))!==null;){let{index:f}=n;for(const g of n[0]){let h=fk.get(g);h||(h=g.normalize("NFD").length,fk.set(g,h)),e.push([h,f++])}}let a;if(e.length===0&&$b)a=$b;else if(e.length>0&&Mb)a=Mb;else{const f=Object.keys(ck).join(""),g=VC(),w=`([${f}])|([${g}])|((?:\u3099|\u309A)\\n)|(\\p{M}+(?:-\\n)?)|(\\p{Ll}-\\n\\p{Lu})|(\\S-\\n)|((?:\\p{Ideographic}|[\u3040-\u30FF])\\n)|(\\n)`;e.length===0?a=$b=new RegExp(w+"|(\\u0000)","gum"):a=Mb=new RegExp(w+`|(${QC})`,"gum")}const i=[];for(;(n=jC.exec(t))!==null;)i.push([n[0].length,n.index]);let s=t.normalize("NFD");const l=[[0,0]];let o=0,r=0,c=0,d=0,u=0,m=!1;return s=s.replace(a,(f,g,h,b,y,w,E,C,$,M,k)=>{var _,v,S;if(k-=d,g){const L=ck[g],D=L.length;for(let I=1;I<D;I++)l.push([k-c+I,c-I]);return c-=D-1,L}if(h){let L=pk.get(h);L||(L=h.normalize("NFKC"),pk.set(h,L));const D=L.length;for(let I=1;I<D;I++)l.push([k-c+I,c-I]);return c-=D-1,L}if(b)return m=!0,k+u===((_=i[o])==null?void 0:_[1])?++o:(l.push([k-1-c+1,c-1]),c-=1,d+=1),l.push([k-c+1,c]),d+=1,u+=1,b.charAt(0);if(y){const L=y.endsWith(`
`),D=L?y.length-2:y.length;m=!0;let I=D;k+u===((v=i[o])==null?void 0:v[1])&&(I-=i[o][0],++o);for(let q=1;q<=I;q++)l.push([k-1-c+q,c-q]);return c-=I,d+=I,L?(k+=D-1,l.push([k-c+1,1+c]),c+=1,d+=1,u+=1,y.slice(0,D)):y}if(w)return l.push([k-c+3,1+c]),c+=1,d+=1,u+=1,w.replace(`
`,"");if(E){const L=E.length-2;return l.push([k-c+L,1+c]),c+=1,d+=1,u+=1,E.slice(0,-2)}if(C){const L=C.length-1;return l.push([k-c+L,c]),d+=1,u+=1,C.slice(0,-1)}if($)return l.push([k-c+1,c-1]),c-=1,d+=1,u+=1," ";if(k+u===((S=e[r])==null?void 0:S[1])){const L=e[r][0]-1;++r;for(let D=1;D<=L;D++)l.push([k-(c-D),c-D]);c-=L,d+=L}return M}),l.push([s.length,c]),[s,l,m]}function eT(t,e,n){if(!t)return[e,n];const a=e,i=e+n-1;let s=od(t,d=>d[0]>=a);t[s][0]>a&&--s;let l=od(t,d=>d[0]>=i,s);t[l][0]>i&&--l;const o=a+t[s][1],c=i+t[l][1]+1-o;return[o,c]}class tT{constructor({linkService:e,eventBus:n,updateMatchesCountOnProgress:a=!0}){O(this,$g);O(this,iu);O(this,su);O(this,Mg);O(this,Pg);O(this,lu);O(this,Ng);O(this,Hg);O(this,Hr);O(this,po);O(this,Gs);O(this,Og);O(this,ou);O(this,ru);O(this,Or);O(this,Bg);O(this,cu);O(this,du);O(this,go);O(this,Dn,null);O(this,Nr,!0);O(this,fo,0);this._linkService=e,this._eventBus=n,z(this,Nr,a),this.onIsPageVisible=null,H(this,iu,Zy).call(this),n._on("find",H(this,$g,gL).bind(this)),n._on("findbarclose",H(this,Bg,wL).bind(this))}get highlightMatches(){return this._highlightMatches}get pageMatches(){return this._pageMatches}get pageMatchesLength(){return this._pageMatchesLength}get selected(){return this._selected}get state(){return x(this,Dn)}setDocument(e){this._pdfDocument&&H(this,iu,Zy).call(this),e&&(this._pdfDocument=e,this._firstPageCapability.resolve())}scrollMatchIntoView({element:e=null,selectedLeft:n=0,pageIndex:a=-1,matchIndex:i=-1}){if(!this._scrollMatches||!e)return;if(i===-1||i!==this._selected.matchIdx)return;if(a===-1||a!==this._selected.pageIdx)return;this._scrollMatches=!1;const s={top:zC,left:n+GC};vb(e,s,!0)}match(e,n,a){const i=this._hasDiacritics[a];let s=!1;if(typeof e=="string"?[s,e]=H(this,lu,Xy).call(this,e,i):e=e.sort().reverse().map(u=>{const[m,f]=H(this,lu,Xy).call(this,u,i);return s||(s=m),`(${f})`}).join("|"),!e)return;const{caseSensitive:l,entireWord:o}=x(this,Dn),r=`g${s?"u":""}${l?"":"i"}`;e=new RegExp(e,r);const c=[];let d;for(;(d=e.exec(n))!==null;)o&&!H(this,Pg,hL).call(this,n,d.index,d[0].length)||c.push({index:d.index,length:d[0].length});return c}}Dn=new WeakMap,Nr=new WeakMap,fo=new WeakMap,$g=new WeakSet,gL=function(e){if(!e)return;const n=this._pdfDocument,{type:a}=e;(x(this,Dn)===null||H(this,Mg,mL).call(this,e))&&(this._dirtyMatch=!0),z(this,Dn,e),a!=="highlightallchange"&&H(this,go,kf).call(this,Fa.PENDING),this._firstPageCapability.promise.then(()=>{if(!this._pdfDocument||n&&this._pdfDocument!==n)return;H(this,Hg,yL).call(this);const i=!this._highlightMatches,s=!!this._findTimeout;this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),a?this._dirtyMatch?H(this,Gs,uc).call(this):a==="again"?(H(this,Gs,uc).call(this),i&&x(this,Dn).highlightAll&&H(this,po,Ef).call(this)):a==="highlightallchange"?(s?H(this,Gs,uc).call(this):this._highlightMatches=!0,H(this,po,Ef).call(this)):H(this,Gs,uc).call(this):this._findTimeout=setTimeout(()=>{H(this,Gs,uc).call(this),this._findTimeout=null},YC)})},iu=new WeakSet,Zy=function(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],z(this,fo,0),z(this,Dn,null),this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._hasDiacritics=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=new Set,this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=Promise.withResolvers()},su=new WeakSet,Jy=function(){const{query:e}=x(this,Dn);return typeof e=="string"?(e!==this._rawQuery&&(this._rawQuery=e,[this._normalizedQuery]=Pb(e)),this._normalizedQuery):(e||[]).filter(n=>!!n).map(n=>Pb(n)[0])},Mg=new WeakSet,mL=function(e){var l,o;const n=e.query,a=x(this,Dn).query,i=typeof n;if(i!==typeof a)return!0;if(i==="string"){if(n!==a)return!0}else if(JSON.stringify(n)!==JSON.stringify(a))return!0;switch(e.type){case"again":const r=this._selected.pageIdx+1,c=this._linkService;return r>=1&&r<=c.pagesCount&&r!==c.page&&!((o=(l=this.onIsPageVisible)==null?void 0:l.call(this,r))==null||o);case"highlightallchange":return!1}return!0},Pg=new WeakSet,hL=function(e,n,a){let i=e.slice(0,n).match(ZC);if(i){const s=e.charCodeAt(n),l=i[1].charCodeAt(0);if(Fp(s)===Fp(l))return!1}if(i=e.slice(n+a).match(JC),i){const s=e.charCodeAt(n+a-1),l=i[1].charCodeAt(0);if(Fp(s)===Fp(l))return!1}return!0},lu=new WeakSet,Xy=function(e,n){const{matchDiacritics:a}=x(this,Dn);let i=!1;e=e.replaceAll(KC,(l,o,r,c,d,u)=>o?`[ ]*\\${o}[ ]*`:r?`[ ]*${r}[ ]*`:c?"[ ]+":a?d||u:d?dk.has(d.charCodeAt(0))?d:"":n?(i=!0,`${u}\\p{M}*`):u);const s="[ ]*";return e.endsWith(s)&&(e=e.slice(0,e.length-s.length)),a&&n&&(uk||(uk=String.fromCharCode(...dk)),i=!0,e=`${e}(?=[${uk}]|[^\\p{M}]|$)`),[i,e]},Ng=new WeakSet,bL=function(e){const n=x(this,su,Jy);if(n.length===0)return;const a=this._pageContents[e],i=this.match(n,a,e),s=this._pageMatches[e]=[],l=this._pageMatchesLength[e]=[],o=this._pageDiffs[e];i==null||i.forEach(({index:c,length:d})=>{const[u,m]=eT(o,c,d);m&&(s.push(u),l.push(m))}),x(this,Dn).highlightAll&&H(this,Hr,Mm).call(this,e),this._resumePageIdx===e&&(this._resumePageIdx=null,H(this,ou,Qy).call(this));const r=s.length;this._matchesCountTotal+=r,x(this,Nr)?r>0&&H(this,du,n_).call(this):++Tm(this,fo)._===this._linkService.pagesCount&&H(this,du,n_).call(this)},Hg=new WeakSet,yL=function(){if(this._extractTextPromises.length>0)return;let e=Promise.resolve();const n={disableNormalization:!0};for(let a=0,i=this._linkService.pagesCount;a<i;a++){const{promise:s,resolve:l}=Promise.withResolvers();this._extractTextPromises[a]=s,e=e.then(()=>this._pdfDocument.getPage(a+1).then(o=>o.getTextContent(n)).then(o=>{const r=[];for(const c of o.items)r.push(c.str),c.hasEOL&&r.push(`
`);[this._pageContents[a],this._pageDiffs[a],this._hasDiacritics[a]]=Pb(r.join("")),l()},o=>{console.error(`Unable to get text content for page ${a+1}`,o),this._pageContents[a]="",this._pageDiffs[a]=null,this._hasDiacritics[a]=!1,l()}))}},Hr=new WeakSet,Mm=function(e){this._scrollMatches&&this._selected.pageIdx===e&&(this._linkService.page=e+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:e})},po=new WeakSet,Ef=function(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})},Gs=new WeakSet,uc=function(){const e=x(this,Dn).findPrevious,n=this._linkService.page-1,a=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=n,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,z(this,fo,0),this._matchesCountTotal=0,H(this,po,Ef).call(this);for(let l=0;l<a;l++)this._pendingFindMatches.has(l)||(this._pendingFindMatches.add(l),this._extractTextPromises[l].then(()=>{this._pendingFindMatches.delete(l),H(this,Ng,bL).call(this,l)}))}if(x(this,su,Jy).length===0){H(this,go,kf).call(this,Fa.FOUND);return}if(this._resumePageIdx)return;const s=this._offset;if(this._pagesToSearch=a,s.matchIdx!==null){const l=this._pageMatches[s.pageIdx].length;if(!e&&s.matchIdx+1<l||e&&s.matchIdx>0){s.matchIdx=e?s.matchIdx-1:s.matchIdx+1,H(this,Or,Pm).call(this,!0);return}H(this,ru,e_).call(this,e)}H(this,ou,Qy).call(this)},Og=new WeakSet,_L=function(e){const n=this._offset,a=e.length,i=x(this,Dn).findPrevious;return a?(n.matchIdx=i?a-1:0,H(this,Or,Pm).call(this,!0),!0):(H(this,ru,e_).call(this,i),n.wrapped&&(n.matchIdx=null,this._pagesToSearch<0)?(H(this,Or,Pm).call(this,!1),!0):!1)},ou=new WeakSet,Qy=function(){this._resumePageIdx!==null&&console.error("There can only be one pending page.");let e=null;do{const n=this._offset.pageIdx;if(e=this._pageMatches[n],!e){this._resumePageIdx=n;break}}while(!H(this,Og,_L).call(this,e))},ru=new WeakSet,e_=function(e){const n=this._offset,a=this._linkService.pagesCount;n.pageIdx=e?n.pageIdx-1:n.pageIdx+1,n.matchIdx=null,this._pagesToSearch--,(n.pageIdx>=a||n.pageIdx<0)&&(n.pageIdx=e?a-1:0,n.wrapped=!0)},Or=new WeakSet,Pm=function(e=!1){let n=Fa.NOT_FOUND;const a=this._offset.wrapped;if(this._offset.wrapped=!1,e){const i=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,n=a?Fa.WRAPPED:Fa.FOUND,i!==-1&&i!==this._selected.pageIdx&&H(this,Hr,Mm).call(this,i)}H(this,go,kf).call(this,n,x(this,Dn).findPrevious),this._selected.pageIdx!==-1&&(this._scrollMatches=!0,H(this,Hr,Mm).call(this,this._selected.pageIdx))},Bg=new WeakSet,wL=function(e){const n=this._pdfDocument;this._firstPageCapability.promise.then(()=>{!this._pdfDocument||n&&this._pdfDocument!==n||(this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),this._resumePageIdx&&(this._resumePageIdx=null,this._dirtyMatch=!0),H(this,go,kf).call(this,Fa.FOUND),this._highlightMatches=!1,H(this,po,Ef).call(this))})},cu=new WeakSet,t_=function(){var s;const{pageIdx:e,matchIdx:n}=this._selected;let a=0,i=this._matchesCountTotal;if(n!==-1){for(let l=0;l<e;l++)a+=((s=this._pageMatches[l])==null?void 0:s.length)||0;a+=n+1}return(a<1||a>i)&&(a=i=0),{current:a,total:i}},du=new WeakSet,n_=function(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:H(this,cu,t_).call(this)})},go=new WeakSet,kf=function(e,n=!1){var a,i,s,l;!x(this,Nr)&&(x(this,fo)!==this._linkService.pagesCount||e===Fa.PENDING)||this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:e,previous:n,entireWord:(i=(a=x(this,Dn))==null?void 0:a.entireWord)!=null?i:null,matchesCount:H(this,cu,t_).call(this),rawQuery:(l=(s=x(this,Dn))==null?void 0:s.query)!=null?l:null})};const nT=1e3;class aT{constructor(e,n,a){O(this,Rg);O(this,uu,void 0);O(this,Br,new ResizeObserver(H(this,Rg,vL).bind(this)));this.opened=!1,this.bar=e.bar,this.toggleButton=e.toggleButton,this.findField=e.findField,this.highlightAll=e.highlightAllCheckbox,this.caseSensitive=e.caseSensitiveCheckbox,this.matchDiacritics=e.matchDiacriticsCheckbox,this.entireWord=e.entireWordCheckbox,this.findMsg=e.findMsg,this.findResultsCount=e.findResultsCount,this.findPreviousButton=e.findPreviousButton,this.findNextButton=e.findNextButton,this.eventBus=a,z(this,uu,n),this.toggleButton.addEventListener("click",()=>{this.toggle()}),this.findField.addEventListener("input",()=>{this.dispatchEvent("")}),this.bar.addEventListener("keydown",i=>{switch(i.keyCode){case 13:i.target===this.findField&&this.dispatchEvent("again",i.shiftKey);break;case 27:this.close();break}}),this.findPreviousButton.addEventListener("click",()=>{this.dispatchEvent("again",!0)}),this.findNextButton.addEventListener("click",()=>{this.dispatchEvent("again",!1)}),this.highlightAll.addEventListener("click",()=>{this.dispatchEvent("highlightallchange"),this.highlightAll.checked?this.highlightAll.parentElement.classList.remove("b3-button--outline"):this.highlightAll.parentElement.classList.add("b3-button--outline")}),this.caseSensitive.addEventListener("click",()=>{this.dispatchEvent("casesensitivitychange"),this.caseSensitive.checked?this.caseSensitive.parentElement.classList.remove("b3-button--outline"):this.caseSensitive.parentElement.classList.add("b3-button--outline")}),this.entireWord.addEventListener("click",()=>{this.dispatchEvent("entirewordchange"),this.entireWord.checked?this.entireWord.parentElement.classList.remove("b3-button--outline"):this.entireWord.parentElement.classList.add("b3-button--outline")}),this.matchDiacritics.addEventListener("click",()=>{this.dispatchEvent("diacriticmatchingchange"),this.matchDiacritics.checked?this.matchDiacritics.parentElement.classList.remove("b3-button--outline"):this.matchDiacritics.parentElement.classList.add("b3-button--outline")})}reset(){this.updateUIState()}dispatchEvent(e,n=!1){this.eventBus.dispatch("find",{source:this,type:e,query:this.findField.value,caseSensitive:this.caseSensitive.checked,entireWord:this.entireWord.checked,highlightAll:this.highlightAll.checked,findPrevious:n,matchDiacritics:this.matchDiacritics.checked})}updateUIState(e,n,a){const{findField:i,findMsg:s}=this;let l="",o="";switch(e){case Fa.FOUND:break;case Fa.PENDING:o="pending";break;case Fa.NOT_FOUND:l=window.siyuan.languages.find_not_found,o="notFound";break;case Fa.WRAPPED:l=window.siyuan.languages.find_not_found[`find_reached_${n?"top":"bottom"}`];break}i.setAttribute("data-status",o),i.setAttribute("aria-invalid",e===Fa.NOT_FOUND),s.setAttribute("data-status",o),l?s.textContent=l:(s.removeAttribute("data-l10n-id"),s.textContent=""),this.updateResultsCount(a)}updateResultsCount({current:e=0,total:n=0}={}){const{findResultsCount:a}=this;if(n>0){const i=nT;a.textContent=n>i?window.siyuan.languages.find_match_count_limit.replace("{{limit}}",i):window.siyuan.languages.find_match_count.replace("{{current}}",e).replace("{{total}}",n)}else a.removeAttribute("data-l10n-id"),a.textContent=""}open(){this.opened||(x(this,Br).observe(x(this,uu)),x(this,Br).observe(this.bar),this.opened=!0,Di(this.toggleButton,!0,this.bar)),this.findField.select(),this.findField.focus()}close(){this.opened&&(x(this,Br).disconnect(),this.opened=!1,Di(this.toggleButton,!1,this.bar),this.eventBus.dispatch("findbarclose",{source:this}))}toggle(){this.opened?this.close():this.open()}}uu=new WeakMap,Br=new WeakMap,Rg=new WeakSet,vL=function(){const{bar:e}=this;e.classList.remove("wrapContainers");const n=e.clientHeight,a=e.firstElementChild.clientHeight;n>a&&e.classList.add("wrapContainers")};const iT=1e3,Nb=50,gk=1e3;function Hb(){return document.location.hash}class sT{constructor({linkService:e,eventBus:n}){O(this,hi);O(this,Rr);O(this,qr);O(this,Ks);O(this,Fr);O(this,fu);O(this,qg);O(this,Fg);O(this,pu);O(this,Ug);O(this,Wg);O(this,js,null);this.linkService=e,this.eventBus=n,this._initialized=!1,this._fingerprint="",this.reset(),this.eventBus._on("pagesinit",()=>{this._isPagesLoaded=!1,this.eventBus._on("pagesloaded",a=>{this._isPagesLoaded=!!a.pagesCount},{once:!0})})}initialize({fingerprint:e,resetHistory:n=!1,updateUrl:a=!1}){if(!e||typeof e!="string"){console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.');return}this._initialized&&this.reset();const i=this._fingerprint!==""&&this._fingerprint!==e;this._fingerprint=e,this._updateUrl=a===!0,this._initialized=!0,H(this,Ug,SL).call(this);const s=window.history.state;if(this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=Hb(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!H(this,Ks,fc).call(this,s,!0)||n){const{hash:o,page:r,rotation:c}=H(this,fu,a_).call(this,!0);if(!o||i||n){H(this,hi,bs).call(this,null,!0);return}H(this,hi,bs).call(this,{hash:o,page:r,rotation:c},!0);return}const l=s.destination;H(this,Fr,Om).call(this,l,s.uid,!0),l.rotation!==void 0&&(this._initialRotation=l.rotation),l.dest?(this._initialBookmark=JSON.stringify(l.dest),this._destination.page=null):l.hash?this._initialBookmark=l.hash:l.page&&(this._initialBookmark=`page=${l.page}`)}reset(){this._initialized&&(H(this,pu,i_).call(this),this._initialized=!1,H(this,Wg,LL).call(this)),this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._initialBookmark=null,this._initialRotation=null}push({namedDest:e=null,explicitDest:n,pageNumber:a}){if(!this._initialized)return;if(e&&typeof e!="string"){console.error(`PDFHistory.push: "${e}" is not a valid namedDest parameter.`);return}else if(Array.isArray(n)){if(!H(this,qr,Hm).call(this,a)&&(a!==null||this._destination)){console.error(`PDFHistory.push: "${a}" is not a valid pageNumber parameter.`);return}}else{console.error(`PDFHistory.push: "${n}" is not a valid explicitDest parameter.`);return}const i=e||JSON.stringify(n);if(!i)return;let s=!1;if(this._destination&&(lT(this._destination.hash,i)||oT(this._destination.dest,n))){if(this._destination.page)return;s=!0}this._popStateInProgress&&!s||(H(this,hi,bs).call(this,{dest:n,hash:i,page:a,rotation:this.linkService.rotation},s),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1})))}pushPage(e){var n;if(this._initialized){if(!H(this,qr,Hm).call(this,e)){console.error(`PDFHistory.pushPage: "${e}" is not a valid page number.`);return}((n=this._destination)==null?void 0:n.page)!==e&&(this._popStateInProgress||(H(this,hi,bs).call(this,{dest:null,hash:`page=${e}`,page:e,rotation:this.linkService.rotation}),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1}))))}}pushCurrentPosition(){!this._initialized||this._popStateInProgress||H(this,Rr,Nm).call(this)}back(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;H(this,Ks,fc).call(this,e)&&e.uid>0&&window.history.back()}forward(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;H(this,Ks,fc).call(this,e)&&e.uid<this._maxUid&&window.history.forward()}get popStateInProgress(){return this._initialized&&(this._popStateInProgress||this._blockHashChange>0)}get initialBookmark(){return this._initialized?this._initialBookmark:null}get initialRotation(){return this._initialized?this._initialRotation:null}}js=new WeakMap,hi=new WeakSet,bs=function(e,n=!1){var l;const a=n||!this._destination,i={fingerprint:this._fingerprint,uid:a?this._uid:this._uid+1,destination:e};typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&((l=window.history.state)!=null&&l.chromecomState)&&(i.chromecomState=window.history.state.chromecomState),H(this,Fr,Om).call(this,e,i.uid);let s;if(this._updateUrl&&(e!=null&&e.hash)){const o=document.location.href.split("#",1)[0];o.startsWith("file://")||(s=`${o}#${e.hash}`)}a?window.history.replaceState(i,"",s):window.history.pushState(i,"",s)},Rr=new WeakSet,Nm=function(e=!1){if(!this._position)return;let n=this._position;if(e&&(n=Object.assign(Object.create(null),this._position),n.temporary=!0),!this._destination){H(this,hi,bs).call(this,n);return}if(this._destination.temporary){H(this,hi,bs).call(this,n,!0);return}if(this._destination.hash===n.hash||!this._destination.page&&(Nb<=0||this._numPositionUpdates<=Nb))return;let a=!1;if(this._destination.page>=n.first&&this._destination.page<=n.page){if(this._destination.dest!==void 0||!this._destination.first)return;a=!0}H(this,hi,bs).call(this,n,a)},qr=new WeakSet,Hm=function(e){return Number.isInteger(e)&&e>0&&e<=this.linkService.pagesCount},Ks=new WeakSet,fc=function(e,n=!1){if(!e)return!1;if(e.fingerprint!==this._fingerprint)if(n){if(typeof e.fingerprint!="string"||e.fingerprint.length!==this._fingerprint.length)return!1;const[a]=performance.getEntriesByType("navigation");if((a==null?void 0:a.type)!=="reload")return!1}else return!1;return!(!Number.isInteger(e.uid)||e.uid<0||e.destination===null||typeof e.destination!="object")},Fr=new WeakSet,Om=function(e,n,a=!1){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),a&&(e!=null&&e.temporary)&&delete e.temporary,this._destination=e,this._uid=n,this._maxUid=Math.max(this._maxUid,n),this._numPositionUpdates=0},fu=new WeakSet,a_=function(e=!1){const n=unescape(Hb()).substring(1),a=ld(n),i=a.get("nameddest")||"";let s=a.get("page")|0;return(!H(this,qr,Hm).call(this,s)||e&&i.length>0)&&(s=null),{hash:n,page:s,rotation:this.linkService.rotation}},qg=new WeakSet,EL=function({location:e}){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:e.pdfOpenParams.substring(1),page:this.linkService.page,first:e.pageNumber,rotation:e.rotation},!this._popStateInProgress&&(Nb>0&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,gk>0&&(this._updateViewareaTimeout=setTimeout(()=>{this._popStateInProgress||H(this,Rr,Nm).call(this,!0),this._updateViewareaTimeout=null},gk)))},Fg=new WeakSet,kL=function({state:e}){const n=Hb(),a=this._currentHash!==n;if(this._currentHash=n,typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&(e!=null&&e.chromecomState)&&!H(this,Ks,fc).call(this,e)||!e){this._uid++;const{hash:s,page:l,rotation:o}=H(this,fu,a_).call(this);H(this,hi,bs).call(this,{hash:s,page:l,rotation:o},!0);return}if(!H(this,Ks,fc).call(this,e))return;this._popStateInProgress=!0,a&&(this._blockHashChange++,ik({target:window,name:"hashchange",delay:iT}).then(()=>{this._blockHashChange--}));const i=e.destination;H(this,Fr,Om).call(this,i,e.uid,!0),Hp(i.rotation)&&(this.linkService.rotation=i.rotation),i.dest?this.linkService.goToDestination(i.dest):i.hash?this.linkService.setHash(i.hash):i.page&&(this.linkService.page=i.page),Promise.resolve().then(()=>{this._popStateInProgress=!1})},pu=new WeakSet,i_=function(){(!this._destination||this._destination.temporary)&&H(this,Rr,Nm).call(this)},Ug=new WeakSet,SL=function(){if(x(this,js))return;z(this,js,new AbortController);const{signal:e}=x(this,js);this.eventBus._on("updateviewarea",H(this,qg,EL).bind(this),{signal:e}),window.addEventListener("popstate",H(this,Fg,kL).bind(this),{signal:e}),window.addEventListener("pagehide",H(this,pu,i_).bind(this),{signal:e})},Wg=new WeakSet,LL=function(){var e;(e=x(this,js))==null||e.abort(),z(this,js,null)};function lT(t,e){return typeof t!="string"||typeof e!="string"?!1:t===e||ld(t).get("nameddest")===e}function oT(t,e){function n(a,i){if(typeof a!=typeof i||Array.isArray(a)||Array.isArray(i))return!1;if(a!==null&&typeof a=="object"&&i!==null){if(Object.keys(a).length!==Object.keys(i).length)return!1;for(const s in a)if(!n(a[s],i[s]))return!1;return!0}return a===i||Number.isNaN(a)&&Number.isNaN(i)}if(!(Array.isArray(t)&&Array.isArray(e))||t.length!==e.length)return!1;for(let a=0,i=t.length;a<i;a++)if(!n(t[a],e[a]))return!1;return!0}class rT extends rd{constructor(n){super(n);O(this,gu);this.eventBus._on("optionalcontentconfigchanged",a=>{H(this,gu,s_).call(this,a.promise)}),this.eventBus._on("resetlayers",()=>{H(this,gu,s_).call(this)}),this.eventBus._on("togglelayerstree",this._toggleAllTreeItems.bind(this))}reset(){var n;super.reset(),this._optionalContentConfig=null,(n=this._optionalContentVisibility)==null||n.clear(),this._optionalContentVisibility=null}_dispatchEvent(n){this.eventBus.dispatch("layersloaded",{source:this,layersCount:n})}_bindLink(n,{groupId:a,input:i}){const s=()=>{const l=i.checked;this._optionalContentConfig.setVisibility(a,l);const o=this._optionalContentVisibility.get(a);o&&(o.visible=l),this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(this._optionalContentConfig)})};n.onclick=l=>l.target===i?(s(),!0):l.target!==n?!0:(i.checked=!i.checked,s(),!1)}_setNestedName(n,{name:a=null}){if(typeof a=="string"){n.textContent=this._normalizeTextContent(a);return}n.textContent=window.siyuan.languages.additionalLayers,n.style.fontStyle="italic",this._l10n.translateOnce(n)}_addToggleButton(n,{name:a=null}){super._addToggleButton(n,a===null)}_toggleAllTreeItems(){this._optionalContentConfig&&super._toggleAllTreeItems()}render({optionalContentConfig:n,pdfDocument:a}){this._optionalContentConfig&&this.reset(),this._optionalContentConfig=n||null,this._pdfDocument=a||null;const i=n==null?void 0:n.getOrder();if(!i){this._dispatchEvent(0);return}this._optionalContentVisibility=new Map;const s=document.createDocumentFragment(),l=[{parent:s,groups:i}];let o=0,r=!1;for(;l.length>0;){const c=l.shift();for(const d of c.groups){const u=document.createElement("div");u.className="treeItem";const m=document.createElement("a");if(u.append(m),typeof d=="object"){r=!0,this._addToggleButton(u,d),this._setNestedName(m,d);const f=document.createElement("div");f.className="treeItems",u.append(f),l.push({parent:f,groups:d.order})}else{const f=n.getGroup(d),g=document.createElement("input");this._bindLink(m,{groupId:d,input:g}),g.type="checkbox",g.checked=f.visible,this._optionalContentVisibility.set(d,{input:g,visible:g.checked});const h=document.createElement("label");h.textContent=this._normalizeTextContent(f.name),h.append(g),m.append(h),o++}c.parent.append(u)}}this._finishRendering(s,o,r)}}gu=new WeakSet,s_=function(n=null){return se(this,null,function*(){if(!this._optionalContentConfig)return;const a=this._pdfDocument,i=yield n||a.getOptionalContentConfig({intent:"display"});if(a===this._pdfDocument){if(n){for(const[s,l]of this._optionalContentVisibility){const o=i.getGroup(s);o&&l.visible!==o.visible&&(l.input.checked=l.visible=!l.visible)}return}this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(i)}),this.render({optionalContentConfig:i,pdfDocument:this._pdfDocument})}})};class cT extends rd{constructor(e){super(e),this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.eventBus._on("toggleoutlinetree",this._toggleAllTreeItems.bind(this)),this.eventBus._on("currentoutlineitem",this._currentOutlineItem.bind(this)),this.eventBus._on("pagechanging",n=>{this._currentPageNumber=n.pageNumber}),this.eventBus._on("pagesloaded",n=>{var a;this._isPagesLoaded=!!n.pagesCount,(a=this._currentOutlineItemCapability)==null||a.resolve(this._isPagesLoaded)}),this.eventBus._on("sidebarviewchanged",n=>{this._sidebarView=n.view})}reset(){var e;super.reset(),this._outline=null,this._pageNumberToDestHashCapability=null,this._currentPageNumber=1,this._isPagesLoaded=null,(e=this._currentOutlineItemCapability)==null||e.resolve(!1),this._currentOutlineItemCapability=null}_dispatchEvent(e){var n;this._currentOutlineItemCapability=Promise.withResolvers(),e===0||(n=this._pdfDocument)!=null&&n.loadingParams.disableAutoFetch?this._currentOutlineItemCapability.resolve(!1):this._isPagesLoaded!==null&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded),this.eventBus.dispatch("outlineloaded",{source:this,outlineCount:e,currentOutlineItemPromise:this._currentOutlineItemCapability.promise})}_bindLink(e,{url:n,newWindow:a,action:i,attachment:s,dest:l,setOCGState:o}){const{linkService:r}=this;if(n){r.addLinkAttributes(e,n,a);return}if(i){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeNamedAction(i),!1);return}if(s){e.href=r.getAnchorUrl(""),e.onclick=()=>(this.downloadManager.openOrDownloadData(s.content,s.filename),!1);return}if(o){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeSetOCGState(o),!1);return}e.href=r.getDestinationHash(l),e.onclick=c=>(this._updateCurrentTreeItem(c.target.parentNode),l&&r.goToDestination(l),!1)}_setStyles(e,{bold:n,italic:a}){n&&(e.style.fontWeight="bold"),a&&(e.style.fontStyle="italic")}_addToggleButton(e,{count:n,items:a}){let i=!1;if(n<0){let s=a.length;if(s>0){const l=[...a];for(;l.length>0;){const{count:o,items:r}=l.shift();o>0&&r.length>0&&(s+=r.length,l.push(...r))}}Math.abs(n)===s&&(i=!0)}super._addToggleButton(e,i)}_toggleAllTreeItems(){this._outline&&super._toggleAllTreeItems()}render({outline:e,pdfDocument:n}){if(this._outline&&this.reset(),this._outline=e||null,this._pdfDocument=n||null,!e){this._dispatchEvent(0);return}const a=document.createDocumentFragment(),i=[{parent:a,items:e}];let s=0,l=!1;for(;i.length>0;){const o=i.shift();for(const r of o.items){const c=document.createElement("div");c.className="treeItem";const d=document.createElement("a");if(this._bindLink(d,r),this._setStyles(d,r),d.textContent=this._normalizeTextContent(r.title),c.append(d),r.items.length>0){l=!0,this._addToggleButton(c,r);const u=document.createElement("div");u.className="treeItems",c.append(u),i.push({parent:u,items:r.items})}o.parent.append(c),s++}}this._finishRendering(a,s,l)}_currentOutlineItem(){return se(this,null,function*(){if(!this._isPagesLoaded)throw new Error("_currentOutlineItem: All pages have not been loaded.");if(!this._outline||!this._pdfDocument)return;const e=yield this._getPageNumberToDestHash(this._pdfDocument);if(e&&(this._updateCurrentTreeItem(null),this._sidebarView===Ke.OUTLINE))for(let n=this._currentPageNumber;n>0;n--){const a=e.get(n);if(!a)continue;const i=this.container.querySelector(`a[href="${a}"]`);if(i){this._scrollToCurrentTreeItem(i.parentNode);break}}})}_getPageNumberToDestHash(e){return se(this,null,function*(){if(this._pageNumberToDestHashCapability)return this._pageNumberToDestHashCapability.promise;this._pageNumberToDestHashCapability=Promise.withResolvers();const n=new Map,a=new Map,i=[{nesting:0,items:this._outline}];for(;i.length>0;){const s=i.shift(),l=s.nesting;for(const{dest:o,items:r}of s.items){let c,d;if(typeof o=="string"){if(c=yield e.getDestination(o),e!==this._pdfDocument)return null}else c=o;if(Array.isArray(c)){const[u]=c;if(u&&typeof u=="object"?d=e.cachedPageNumber(u):Number.isInteger(u)&&(d=u+1),Number.isInteger(d)&&(!n.has(d)||l>a.get(d))){const m=this.linkService.getDestinationHash(o);n.set(d,m),a.set(d,l)}}r.length>0&&i.push({nesting:l+1,items:r})}}return this._pageNumberToDestHashCapability.resolve(n.size>0?n:null),this._pageNumberToDestHashCapability.promise})}}const dT=3e3,mk="pdfPresentationMode",Ob="pdfPresentationModeControls",uT=50,fT=.1,hk=50,Bb=Math.PI/6;class pT{constructor({container:e,pdfViewer:n,eventBus:a}){O(this,Vg);O(this,mo);O(this,Yg);O(this,zg);O(this,Gg);O(this,jg);O(this,mu);O(this,Kg);O(this,ho);O(this,Zg);O(this,Jg);O(this,Xg);O(this,Qg);O(this,hu);O(this,Ur,kn.UNKNOWN);O(this,Wn,null);O(this,Zs,null);O(this,Js,null);this.container=e,this.pdfViewer=n,this.eventBus=a,this.contextMenuOpen=!1,this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0,this.touchSwipeState=null}request(){return se(this,null,function*(){const{container:e,pdfViewer:n}=this;if(this.active||!n.pagesCount||!e.requestFullscreen)return!1;H(this,Qg,NL).call(this),H(this,mo,Sf).call(this,kn.CHANGING);const a=e.requestFullscreen();z(this,Wn,{pageNumber:n.currentPageNumber,scaleValue:n.currentScaleValue,scrollMode:n.scrollMode,spreadMode:null,annotationEditorMode:null}),n.spreadMode!==Bt.NONE&&!(n.pageViewsReady&&n.hasEqualPageSizes)&&(console.warn("Ignoring Spread modes when entering PresentationMode, since the document may contain varying page sizes."),x(this,Wn).spreadMode=n.spreadMode),n.annotationEditorMode!==ae.AnnotationEditorType.DISABLE&&(x(this,Wn).annotationEditorMode=n.annotationEditorMode);try{return yield a,n.focus(),!0}catch(i){H(this,hu,o_).call(this),H(this,mo,Sf).call(this,kn.NORMAL)}return!1})}get active(){return x(this,Ur)===kn.CHANGING||x(this,Ur)===kn.FULLSCREEN}}Ur=new WeakMap,Wn=new WeakMap,Zs=new WeakMap,Js=new WeakMap,Vg=new WeakSet,AL=function(e){if(!this.active)return;e.preventDefault();const n=dC(e),a=Date.now(),i=this.mouseScrollTimeStamp;if(!(a>i&&a-i<uT)&&((this.mouseScrollDelta>0&&n<0||this.mouseScrollDelta<0&&n>0)&&H(this,ho,Lf).call(this),this.mouseScrollDelta+=n,Math.abs(this.mouseScrollDelta)>=fT)){const s=this.mouseScrollDelta;H(this,ho,Lf).call(this),(s>0?this.pdfViewer.previousPage():this.pdfViewer.nextPage())&&(this.mouseScrollTimeStamp=a)}},mo=new WeakSet,Sf=function(e){z(this,Ur,e),this.eventBus.dispatch("presentationmodechanged",{source:this,state:e})},Yg=new WeakSet,xL=function(){H(this,mo,Sf).call(this,kn.FULLSCREEN),this.container.classList.add(mk),setTimeout(()=>{this.pdfViewer.scrollMode=Ve.PAGE,x(this,Wn).spreadMode!==null&&(this.pdfViewer.spreadMode=Bt.NONE),this.pdfViewer.currentPageNumber=x(this,Wn).pageNumber,this.pdfViewer.currentScaleValue="page-fit",x(this,Wn).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode={mode:ae.AnnotationEditorType.NONE})},0),H(this,Jg,ML).call(this),H(this,mu,l_).call(this),this.contextMenuOpen=!1,document.getSelection().empty()},zg=new WeakSet,CL=function(){const e=this.pdfViewer.currentPageNumber;this.container.classList.remove(mk),setTimeout(()=>{H(this,hu,o_).call(this),H(this,mo,Sf).call(this,kn.NORMAL),this.pdfViewer.scrollMode=x(this,Wn).scrollMode,x(this,Wn).spreadMode!==null&&(this.pdfViewer.spreadMode=x(this,Wn).spreadMode),this.pdfViewer.currentScaleValue=x(this,Wn).scaleValue,this.pdfViewer.currentPageNumber=e,x(this,Wn).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode={mode:x(this,Wn).annotationEditorMode}),z(this,Wn,null)},0),H(this,Xg,PL).call(this),H(this,Kg,IL).call(this),H(this,ho,Lf).call(this),this.contextMenuOpen=!1},Gg=new WeakSet,TL=function(e){var n;if(this.contextMenuOpen){this.contextMenuOpen=!1,e.preventDefault();return}e.button===0&&(e.target.href&&((n=e.target.parentNode)!=null&&n.hasAttribute("data-internal-link"))||(e.preventDefault(),e.shiftKey?this.pdfViewer.previousPage():this.pdfViewer.nextPage()))},jg=new WeakSet,DL=function(){this.contextMenuOpen=!0},mu=new WeakSet,l_=function(){this.controlsTimeout?clearTimeout(this.controlsTimeout):this.container.classList.add(Ob),this.controlsTimeout=setTimeout(()=>{this.container.classList.remove(Ob),delete this.controlsTimeout},dT)},Kg=new WeakSet,IL=function(){this.controlsTimeout&&(clearTimeout(this.controlsTimeout),this.container.classList.remove(Ob),delete this.controlsTimeout)},ho=new WeakSet,Lf=function(){this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0},Zg=new WeakSet,$L=function(e){if(this.active){if(e.touches.length>1){this.touchSwipeState=null;return}switch(e.type){case"touchstart":this.touchSwipeState={startX:e.touches[0].pageX,startY:e.touches[0].pageY,endX:e.touches[0].pageX,endY:e.touches[0].pageY};break;case"touchmove":if(this.touchSwipeState===null)return;this.touchSwipeState.endX=e.touches[0].pageX,this.touchSwipeState.endY=e.touches[0].pageY,e.preventDefault();break;case"touchend":if(this.touchSwipeState===null)return;let n=0;const a=this.touchSwipeState.endX-this.touchSwipeState.startX,i=this.touchSwipeState.endY-this.touchSwipeState.startY,s=Math.abs(Math.atan2(i,a));Math.abs(a)>hk&&(s<=Bb||s>=Math.PI-Bb)?n=a:Math.abs(i)>hk&&Math.abs(s-Math.PI/2)<=Bb&&(n=i),n>0?this.pdfViewer.previousPage():n<0&&this.pdfViewer.nextPage();break}}},Jg=new WeakSet,ML=function(){if(x(this,Js))return;z(this,Js,new AbortController);const{signal:e}=x(this,Js),n=H(this,Zg,$L).bind(this);window.addEventListener("mousemove",H(this,mu,l_).bind(this),{signal:e}),window.addEventListener("mousedown",H(this,Gg,TL).bind(this),{signal:e}),window.addEventListener("wheel",H(this,Vg,AL).bind(this),{passive:!1,signal:e}),window.addEventListener("keydown",H(this,ho,Lf).bind(this),{signal:e}),window.addEventListener("contextmenu",H(this,jg,DL).bind(this),{signal:e}),window.addEventListener("touchstart",n,{signal:e}),window.addEventListener("touchmove",n,{signal:e}),window.addEventListener("touchend",n,{signal:e})},Xg=new WeakSet,PL=function(){var e;(e=x(this,Js))==null||e.abort(),z(this,Js,null)},Qg=new WeakSet,NL=function(){x(this,Zs)||(z(this,Zs,new AbortController),window.addEventListener("fullscreenchange",()=>{document.fullscreenElement?H(this,Yg,xL).call(this):H(this,zg,CL).call(this)},{signal:x(this,Zs).signal}))},hu=new WeakSet,o_=function(){var e;(e=x(this,Zs))==null||e.abort(),z(this,Zs,null)};class bk{constructor({pdfPage:e,annotationStorage:n=null,linkService:a,xfaHtml:i=null}){this.pdfPage=e,this.annotationStorage=n,this.linkService=a,this.xfaHtml=i,this.div=null,this._cancelled=!1}render(e,n="display"){return se(this,null,function*(){if(n==="print"){const s={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:this.xfaHtml,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:n};return this.div=document.createElement("div"),s.div=this.div,ae.XfaLayer.render(s)}const a=yield this.pdfPage.getXfa();if(this._cancelled||!a)return{textDivs:[]};const i={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:a,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:n};return this.div?ae.XfaLayer.update(i):(this.div=document.createElement("div"),i.div=this.div,ae.XfaLayer.render(i))})}cancel(){this._cancelled=!0}hide(){this.div&&(this.div.hidden=!0)}}function gT(t,e){const n=e.allXfaHtml,a=new Sb,i=Math.round(ae.PixelsPerInch.PDF_TO_CSS_UNITS*100)/100;for(const s of n.children){const l=document.createElement("div");l.className="xfaPrintedPage",t.append(l);const o=new bk({pdfPage:null,annotationStorage:e.annotationStorage,linkService:a,xfaHtml:s}),r=(0,ae.getXfaPageViewport)(s,{scale:i});o.render(r,"print"),l.append(o.div)}}let xa=null,ui=null,$s=null,yk={initialized:!1};function mT(t,e,n,a,i,s,l){const o=xa.scratchCanvas,r=i/ae.PixelsPerInch.PDF;o.width=Math.floor(a.width*r),o.height=Math.floor(a.height*r);const c=o.getContext("2d");return c.save(),c.fillStyle="rgb(255, 255, 255)",c.fillRect(0,0,o.width,o.height),c.restore(),Promise.all([e.getPage(n),l]).then(function([d,u]){const m={canvasContext:c,transform:[r,0,0,r,0,0],viewport:d.getViewport({scale:1,rotation:a.rotation}),intent:"print",annotationMode:ae.AnnotationMode.ENABLE_STORAGE,optionalContentConfigPromise:s,printAnnotationStorage:u};return d.render(m).promise.catch(g=>{throw g instanceof ae.RenderingCancelledException||console.error(g),g})})}class hT{constructor({pdfDocument:e,pagesOverview:n,printContainer:a,printResolution:i,printAnnotationStoragePromise:s=null}){this.pdfDocument=e,this.pagesOverview=n,this.printContainer=a,this._printResolution=i||150,this._optionalContentConfigPromise=e.getOptionalContentConfig({intent:"print"}),this._printAnnotationStoragePromise=s||Promise.resolve(),this.currentPage=-1,this.scratchCanvas=document.createElement("canvas")}layout(){this.throwIfInactive();const e=document.querySelector("body");e.setAttribute("data-pdfjsprinting",!0);const{width:n,height:a}=this.pagesOverview[0];this.pagesOverview.every(s=>s.width===n&&s.height===a)||console.warn("Not all pages have the same size. The printed result may be incorrect!"),this.pageStyleSheet=document.createElement("style"),this.pageStyleSheet.textContent=`@page { size: ${n}pt ${a}pt;}`,e.append(this.pageStyleSheet)}destroy(){if(xa!==this)return;this.printContainer.textContent="",document.querySelector("body").removeAttribute("data-pdfjsprinting"),this.pageStyleSheet&&(this.pageStyleSheet.remove(),this.pageStyleSheet=null),this.scratchCanvas.width=this.scratchCanvas.height=0,this.scratchCanvas=null,xa=null,Fb().then(function(){$s.active===ui&&$s.close(ui)})}renderPages(){if(this.pdfDocument.isPureXfa)return gT(this.printContainer,this.pdfDocument),Promise.resolve();const e=this.pagesOverview.length,n=(a,i)=>{if(this.throwIfInactive(),++this.currentPage>=e){wk(e,e),a();return}const s=this.currentPage;wk(s,e),mT(this,this.pdfDocument,s+1,this.pagesOverview[s],this._printResolution,this._optionalContentConfigPromise,this._printAnnotationStoragePromise).then(this.useRenderedPage.bind(this)).then(function(){n(a,i)},i)};return new Promise(n)}useRenderedPage(){this.throwIfInactive();const e=document.createElement("img");this.scratchCanvas.toBlob(l=>{e.src=URL.createObjectURL(l)});const n=document.createElement("div");n.className="printedPage",n.append(e),this.printContainer.append(n);const{promise:a,resolve:i,reject:s}=Promise.withResolvers();return e.onload=i,e.onerror=s,a.catch(()=>{}).then(()=>{URL.revokeObjectURL(e.src)}),a}performPrint(){return this.throwIfInactive(),new Promise(e=>{setTimeout(()=>{if(!this.active){e();return}bT.call(window),setTimeout(e,20)},0)})}get active(){return this===xa}throwIfInactive(){if(!this.active)throw new Error("This print request was cancelled or completed.")}}const bT=window.print;window.print=function(){if(xa){console.warn("Ignored window.print() because of a pending print job.");return}Fb().then(function(){xa&&$s.open(ui)});try{_k("beforeprint")}finally{if(!xa){console.error("Expected print service to be initialized."),Fb().then(function(){$s.active===ui&&$s.close(ui)});return}const t=xa;xa.renderPages().then(function(){return t.performPrint()}).catch(function(){}).then(function(){t.active&&Rb()})}};function _k(t){const e=new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:"custom"});window.dispatchEvent(e)}function Rb(){xa&&(xa.destroy(),_k("afterprint"))}function wk(t,e){if(typeof PDFJSDev=="undefined"&&window.isGECKOVIEW)return;ui||(ui=document.getElementById("printServiceDialog"));const n=Math.round(100*t/e),a=ui.querySelector("progress"),i=ui.querySelector(".relative-progress");a.value=n,i.setAttribute("data-l10n-args",JSON.stringify({progress:n}))}if("onbeforeprint"in window){const t=function(e){e.detail!=="custom"&&e.stopImmediatePropagation()};window.addEventListener("beforeprint",t),window.addEventListener("afterprint",t)}let qb;function Fb(){if(typeof PDFJSDev=="undefined"&&window.isGECKOVIEW)return Promise.reject(new Error("ensureOverlay not implemented in GECKOVIEW development mode."));if(!qb){if($s=yk.overlayManager,!$s)throw new Error("The overlay manager has not yet been initialized.");ui||(ui=document.getElementById("printServiceDialog")),qb=$s.register(ui,!0),document.getElementById("printCancel").onclick=Rb,ui.addEventListener("close",Rb)}return qb}class vk{static initGlobals(e){yk=e}static get supportsPrinting(){return(0,ae.shadow)(this,"supportsPrinting",!0)}static createPrintService(e){if(xa)throw new Error("The print service is created and active.");return xa=new hT(e)}}const yT=3e4;class Ek{constructor(){this.pdfViewer=null,this.pdfThumbnailViewer=null,this.onIdle=null,this.highestPriorityPage=null,this.idleTimeout=null,this.printing=!1,this.isThumbnailViewEnabled=!1,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&Object.defineProperty(this,"hasViewer",{value:()=>!!this.pdfViewer})}setViewer(e){this.pdfViewer=e}setThumbnailViewer(e){this.pdfThumbnailViewer=e}isHighestPriority(e){return this.highestPriorityPage===e.renderingId}renderHighestPriority(e){var n;this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null),!this.pdfViewer.forceRendering(e)&&(this.isThumbnailViewEnabled&&((n=this.pdfThumbnailViewer)!=null&&n.forceRendering())||this.printing||this.onIdle&&(this.idleTimeout=setTimeout(this.onIdle.bind(this),yT)))}getHighestPriority(e,n,a,i=!1){const s=e.views,l=s.length;if(l===0)return null;for(let u=0;u<l;u++){const m=s[u].view;if(!this.isViewFinished(m))return m}const o=e.first.id,r=e.last.id;if(r-o+1>l){const u=e.ids;for(let m=1,f=r-o;m<f;m++){const g=a?o+m:r-m;if(u.has(g))continue;const h=n[g-1];if(!this.isViewFinished(h))return h}}let c=a?r:o-2,d=n[c];return d&&!this.isViewFinished(d)||i&&(c+=a?1:-1,d=n[c],d&&!this.isViewFinished(d))?d:null}isViewFinished(e){return e.renderingState===it.FINISHED}renderView(e){switch(e.renderingState){case it.FINISHED:return!1;case it.PAUSED:this.highestPriorityPage=e.renderingId,e.resume();break;case it.RUNNING:this.highestPriorityPage=e.renderingId;break;case it.INITIAL:this.highestPriorityPage=e.renderingId,e.draw().finally(()=>{this.renderHighestPriority()}).catch(n=>{n instanceof ae.RenderingCancelledException||console.error(`renderView: "${n}"`)});break}return!0}}class _T{constructor({eventBus:e,externalServices:n=null,docProperties:a=null}){O(this,em);O(this,Vr);O(this,_u);O(this,tm);O(this,wo);O(this,Oi,null);O(this,bo,null);O(this,bu,null);O(this,yo,null);O(this,_o,null);O(this,yu,null);O(this,na,null);O(this,cs,null);O(this,Wr,!1);O(this,_n,null);O(this,Ka,null);z(this,_o,e),z(this,yu,n),z(this,bu,a),typeof PDFJSDev!="undefined"&&PDFJSDev.test("TESTING")&&Object.defineProperty(this,"sandboxTrip",{value:()=>setTimeout(()=>{var i;return(i=x(this,_n))==null?void 0:i.dispatchEventInSandbox({name:"sandboxtripbegin"})},0)})}setViewer(e){z(this,cs,e)}setDocument(e){return se(this,null,function*(){var o;if(x(this,na)&&(yield H(this,wo,Af).call(this)),z(this,na,e),!e)return;const[n,a,i]=yield Promise.all([e.getFieldObjects(),e.getCalculationOrderIds(),e.getJSActions()]);if(!n&&!i){yield H(this,wo,Af).call(this);return}if(e!==x(this,na))return;try{z(this,_n,H(this,tm,OL).call(this))}catch(r){console.error(`setDocument: "${r.message}".`),yield H(this,wo,Af).call(this);return}const s=x(this,_o);z(this,yo,new AbortController);const{signal:l}=x(this,yo);s._on("updatefromsandbox",r=>{(r==null?void 0:r.source)===window&&H(this,em,HL).call(this,r.detail)},{signal:l}),s._on("dispatcheventinsandbox",r=>{var c;(c=x(this,_n))==null||c.dispatchEventInSandbox(r.detail)},{signal:l}),s._on("pagechanging",({pageNumber:r,previous:c})=>{r!==c&&(H(this,_u,r_).call(this,c),H(this,Vr,Bm).call(this,r))},{signal:l}),s._on("pagerendered",({pageNumber:r})=>{this._pageOpenPending.has(r)&&r===x(this,cs).currentPageNumber&&H(this,Vr,Bm).call(this,r)},{signal:l}),s._on("pagesdestroy",()=>se(this,null,function*(){var r,c;yield H(this,_u,r_).call(this,x(this,cs).currentPageNumber),yield(r=x(this,_n))==null?void 0:r.dispatchEventInSandbox({id:"doc",name:"WillClose"}),(c=x(this,Oi))==null||c.resolve()}),{signal:l});try{const r=yield x(this,bu).call(this,e);if(e!==x(this,na))return;yield x(this,_n).createSandbox({objects:n,calculationOrder:a,appInfo:{platform:navigator.platform,language:navigator.language},docInfo:ml(aa({},r),{actions:i})}),s.dispatch("sandboxcreated",{source:this})}catch(r){console.error(`setDocument: "${r.message}".`),yield H(this,wo,Af).call(this);return}yield(o=x(this,_n))==null?void 0:o.dispatchEventInSandbox({id:"doc",name:"Open"}),yield H(this,Vr,Bm).call(this,x(this,cs).currentPageNumber,!0),Promise.resolve().then(()=>{e===x(this,na)&&z(this,Wr,!0)})})}dispatchWillSave(){return se(this,null,function*(){var e;return(e=x(this,_n))==null?void 0:e.dispatchEventInSandbox({id:"doc",name:"WillSave"})})}dispatchDidSave(){return se(this,null,function*(){var e;return(e=x(this,_n))==null?void 0:e.dispatchEventInSandbox({id:"doc",name:"DidSave"})})}dispatchWillPrint(){return se(this,null,function*(){var e;if(x(this,_n)){yield(e=x(this,Ka))==null?void 0:e.promise,z(this,Ka,Promise.withResolvers());try{yield x(this,_n).dispatchEventInSandbox({id:"doc",name:"WillPrint"})}catch(n){throw x(this,Ka).resolve(),z(this,Ka,null),n}yield x(this,Ka).promise}})}dispatchDidPrint(){return se(this,null,function*(){var e;return(e=x(this,_n))==null?void 0:e.dispatchEventInSandbox({id:"doc",name:"DidPrint"})})}get destroyPromise(){var e;return((e=x(this,bo))==null?void 0:e.promise)||null}get ready(){return x(this,Wr)}get _pageOpenPending(){return(0,ae.shadow)(this,"_pageOpenPending",new Set)}get _visitedPages(){return(0,ae.shadow)(this,"_visitedPages",new Map)}}Oi=new WeakMap,bo=new WeakMap,bu=new WeakMap,yo=new WeakMap,_o=new WeakMap,yu=new WeakMap,na=new WeakMap,cs=new WeakMap,Wr=new WeakMap,_n=new WeakMap,Ka=new WeakMap,em=new WeakSet,HL=function(e){return se(this,null,function*(){var c,d;const n=x(this,cs),a=n.isInPresentationMode||n.isChangingPresentationMode,{id:i,siblings:s,command:l,value:o}=e;if(!i){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("TESTING")&&l==="sandboxTripEnd"){window.setTimeout(()=>{window.dispatchEvent(new CustomEvent("sandboxtripend"))},0);return}switch(l){case"clear":console.clear();break;case"error":console.error(o);break;case"layout":if(!a){const u=nk(o);n.spreadMode=u.spreadMode}break;case"page-num":n.currentPageNumber=o+1;break;case"print":yield n.pagesPromise,x(this,_o).dispatch("print",{source:this});break;case"println":console.log(o);break;case"zoom":a||(n.currentScaleValue=o);break;case"SaveAs":x(this,_o).dispatch("download",{source:this});break;case"FirstPage":n.currentPageNumber=1;break;case"LastPage":n.currentPageNumber=n.pagesCount;break;case"NextPage":n.nextPage();break;case"PrevPage":n.previousPage();break;case"ZoomViewIn":a||n.increaseScale();break;case"ZoomViewOut":a||n.decreaseScale();break;case"WillPrintFinished":(c=x(this,Ka))==null||c.resolve(),z(this,Ka,null);break}return}if(a&&e.focus)return;delete e.id,delete e.siblings;const r=s?[i,...s]:[i];for(const u of r){const m=document.querySelector(`[data-element-id="${u}"]`);m?m.dispatchEvent(new CustomEvent("updatefromsandbox",{detail:e})):(d=x(this,na))==null||d.annotationStorage.setValue(u,e)}})},Vr=new WeakSet,Bm=function(e,n=!1){return se(this,null,function*(){const a=x(this,na),i=this._visitedPages;if(n&&z(this,Oi,Promise.withResolvers()),!x(this,Oi))return;const s=x(this,cs).getPageView(e-1);if((s==null?void 0:s.renderingState)!==it.FINISHED){this._pageOpenPending.add(e);return}this._pageOpenPending.delete(e);const l=se(this,null,function*(){var r,c;const o=yield i.has(e)?null:(r=s.pdfPage)==null?void 0:r.getJSActions();a===x(this,na)&&(yield(c=x(this,_n))==null?void 0:c.dispatchEventInSandbox({id:"page",name:"PageOpen",pageNumber:e,actions:o}))});i.set(e,l)})},_u=new WeakSet,r_=function(e){return se(this,null,function*(){var s;const n=x(this,na),a=this._visitedPages;if(!x(this,Oi)||this._pageOpenPending.has(e))return;const i=a.get(e);i&&(a.set(e,null),yield i,n===x(this,na)&&(yield(s=x(this,_n))==null?void 0:s.dispatchEventInSandbox({id:"page",name:"PageClose",pageNumber:e})))})},tm=new WeakSet,OL=function(){if(z(this,bo,Promise.withResolvers()),x(this,_n))throw new Error("#initScripting: Scripting already exists.");return x(this,yu).createScripting()},wo=new WeakSet,Af=function(){return se(this,null,function*(){var e,n,a,i;if(!x(this,_n)){z(this,na,null),(e=x(this,bo))==null||e.resolve();return}x(this,Oi)&&(yield Promise.race([x(this,Oi).promise,new Promise(s=>{setTimeout(s,1e3)})]).catch(()=>{}),z(this,Oi,null)),z(this,na,null);try{yield x(this,_n).destroySandbox()}catch(s){}(n=x(this,Ka))==null||n.reject(new Error("Scripting destroyed.")),z(this,Ka,null),(a=x(this,yo))==null||a.abort(),z(this,yo,null),this._pageOpenPending.clear(),this._visitedPages.clear(),z(this,_n,null),z(this,Wr,!1),(i=x(this,bo))==null||i.resolve()})};const wT="--sidebar-width",kk=200,Up="sidebarResizing",Sk="pdfSidebarNotification";class vT{constructor({elements:e,eventBus:n,l10n:a}){O(this,Qs);O(this,nm);O(this,Eu);O(this,am);O(this,Yr);O(this,im);O(this,ku);O(this,wu,!1);O(this,vo,null);O(this,vu,null);O(this,Xs,null);this.isOpen=!1,this.active=Ke.THUMBS,this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,this.onToggled=null,this.onUpdateThumbnails=null,this.outerContainer=e.outerContainer,this.sidebarContainer=e.sidebarContainer,this.toggleButton=e.toggleButton,this.resizer=e.resizer,this.thumbnailButton=e.thumbnailButton,this.outlineButton=e.outlineButton,this.attachmentsButton=e.attachmentsButton,this.layersButton=e.layersButton,this.thumbnailView=e.thumbnailView,this.outlineView=e.outlineView,this.attachmentsView=e.attachmentsView,this.layersView=e.layersView,this._currentOutlineItemButton=e.currentOutlineItemButton,this.eventBus=n,z(this,wu,!1),H(this,am,RL).call(this)}reset(){this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,H(this,Eu,c_).call(this,!0),this.switchView(Ke.THUMBS),this.outlineButton.disabled=!1,this.attachmentsButton.disabled=!1,this.layersButton.disabled=!1,this._currentOutlineItemButton.disabled=!0}get visibleView(){return this.isOpen?this.active:Ke.NONE}setInitialView(e=Ke.NONE){if(!this.isInitialViewSet){if(this.isInitialViewSet=!0,e===Ke.NONE||e===Ke.UNKNOWN){H(this,Qs,pc).call(this);return}this.switchView(e,!0),this.isInitialEventDispatched||H(this,Qs,pc).call(this)}}switchView(e,n=!1){const a=e!==this.active;let i=!1;switch(e){case Ke.NONE:this.isOpen&&this.close();return;case Ke.THUMBS:this.isOpen&&a&&(i=!0);break;case Ke.OUTLINE:if(this.outlineButton.disabled)return;break;case Ke.ATTACHMENTS:if(this.attachmentsButton.disabled)return;break;case Ke.LAYERS:if(this.layersButton.disabled)return;break;default:console.error(`PDFSidebar.switchView: "${e}" is not a valid view.`);return}if(this.active=e,La(this.thumbnailButton,e===Ke.THUMBS,this.thumbnailView),La(this.outlineButton,e===Ke.OUTLINE,this.outlineView),La(this.attachmentsButton,e===Ke.ATTACHMENTS,this.attachmentsView),La(this.layersButton,e===Ke.LAYERS,this.layersView),n&&!this.isOpen){this.open();return}i&&(this.onUpdateThumbnails(),this.onToggled()),a&&H(this,Qs,pc).call(this)}open(){this.isOpen||(this.isOpen=!0,Di(this.toggleButton,!0),this.outerContainer.classList.add("sidebarMoving","sidebarOpen"),this.active===Ke.THUMBS&&this.onUpdateThumbnails(),this.onToggled(),H(this,Qs,pc).call(this),H(this,Eu,c_).call(this))}close(e=null){this.isOpen&&(this.isOpen=!1,Di(this.toggleButton,!1),this.outerContainer.classList.add("sidebarMoving"),this.outerContainer.classList.remove("sidebarOpen"),this.onToggled(),H(this,Qs,pc).call(this),(e==null?void 0:e.detail)>0&&this.toggleButton.blur())}toggle(e=null){this.isOpen?this.close(e):this.open()}get outerContainerWidth(){return x(this,vu)||z(this,vu,this.outerContainer.clientWidth)}}wu=new WeakMap,vo=new WeakMap,vu=new WeakMap,Xs=new WeakMap,Qs=new WeakSet,pc=function(){this.isInitialViewSet&&(this.isInitialEventDispatched||(this.isInitialEventDispatched=!0)),this.eventBus.dispatch("sidebarviewchanged",{source:this,view:this.visibleView})},nm=new WeakSet,BL=function(){this.toggleButton.title=window.siyuan.languages.toggleSidebarNotification2Title,this.isOpen||this.toggleButton.classList.add(Sk)},Eu=new WeakSet,c_=function(e=!1){(this.isOpen||e)&&this.toggleButton.classList.remove(Sk),e&&(this.toggleButton.title=window.siyuan.languages.toggleSidebarTitle)},am=new WeakSet,RL=function(){const{eventBus:e,outerContainer:n}=this;this.sidebarContainer.addEventListener("transitionend",i=>{i.target===this.sidebarContainer&&(n.classList.remove("sidebarMoving"),e.dispatch("resize",{source:this}))}),this.toggleButton.addEventListener("click",i=>{this.toggle(i)}),this.thumbnailButton.addEventListener("click",()=>{this.switchView(Ke.THUMBS)}),this.outlineButton.addEventListener("click",()=>{this.switchView(Ke.OUTLINE)}),this.outlineButton.addEventListener("dblclick",()=>{e.dispatch("toggleoutlinetree",{source:this})}),this.attachmentsButton.addEventListener("click",()=>{this.switchView(Ke.ATTACHMENTS)}),this.layersButton.addEventListener("click",()=>{this.switchView(Ke.LAYERS)}),this.layersButton.addEventListener("dblclick",()=>{e.dispatch("resetlayers",{source:this})}),this._currentOutlineItemButton.addEventListener("click",()=>{e.dispatch("currentoutlineitem",{source:this})});const a=(i,s,l)=>{s.disabled=!i,i?H(this,nm,BL).call(this):this.active===l&&this.switchView(Ke.THUMBS)};e._on("outlineloaded",i=>{a(i.outlineCount,this.outlineButton,Ke.OUTLINE),i.currentOutlineItemPromise.then(s=>{this.isInitialViewSet&&(this._currentOutlineItemButton.disabled=!s)})}),e._on("attachmentsloaded",i=>{a(i.attachmentsCount,this.attachmentsButton,Ke.ATTACHMENTS)}),e._on("layersloaded",i=>{a(i.layersCount,this.layersButton,Ke.LAYERS)}),e._on("presentationmodechanged",i=>{i.state===kn.NORMAL&&this.visibleView===Ke.THUMBS&&this.onUpdateThumbnails()}),this.resizer.addEventListener("mousedown",i=>{if(i.button!==0)return;n.classList.add(Up),z(this,vo,new AbortController);const s={signal:x(this,vo).signal};window.addEventListener("mousemove",H(this,im,qL).bind(this),s),window.addEventListener("mouseup",H(this,ku,d_).bind(this),s),window.addEventListener("blur",H(this,ku,d_).bind(this),s)}),e._on("resize",i=>{if(i.source!==window||(z(this,vu,null),!x(this,Xs)))return;if(!this.isOpen){H(this,Yr,Rm).call(this,x(this,Xs));return}n.classList.add(Up);const s=H(this,Yr,Rm).call(this,x(this,Xs));Promise.resolve().then(()=>{n.classList.remove(Up),s&&e.dispatch("resize",{source:this})})})},Yr=new WeakSet,Rm=function(e=0){const n=Math.floor(this.outerContainerWidth/2);return e>n&&(e=n),e<kk&&(e=kk),e===x(this,Xs)?!1:(z(this,Xs,e),tk.setProperty(wT,`${e}px`),!0)},im=new WeakSet,qL=function(e){let n=e.clientX-this.outerContainer.getBoundingClientRect().left;x(this,wu)&&(n=this.outerContainerWidth-n),H(this,Yr,Rm).call(this,n)},ku=new WeakSet,d_=function(e){var n;this.outerContainer.classList.remove(Up),this.eventBus.dispatch("resize",{source:this}),(n=x(this,vo))==null||n.abort(),z(this,vo,null)};const Lk=2,Ak=3,ET=98;class Ub{static getCanvas(e,n){const a=x(this,zr)||z(this,zr,document.createElement("canvas"));a.width=e,a.height=n;const i=a.getContext("2d",{alpha:!1});return i.save(),i.fillStyle="rgb(255, 255, 255)",i.fillRect(0,0,e,n),i.restore(),[a,a.getContext("2d")]}static destroyCanvas(){const e=x(this,zr);e&&(e.width=0,e.height=0),z(this,zr,null)}}zr=new WeakMap,O(Ub,zr,null);class kT{constructor({container:e,eventBus:n,id:a,defaultViewport:i,optionalContentConfigPromise:s,linkService:l,renderingQueue:o,pageColors:r,enableHWA:c}){O(this,Su);O(this,Lu);O(this,Au);O(this,xu);O(this,sm);O(this,ds);this.id=a,this.renderingId="thumbnail"+a,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=i,this.pdfPageRotate=i.rotation,this._optionalContentConfigPromise=s||null,this.pageColors=r||null,this.enableHWA=c||!1,this.eventBus=n,this.linkService=l,this.renderingQueue=o,this.renderTask=null,this.renderingState=it.INITIAL,this.resume=null;const d=document.createElement("a");d.href=l.getAnchorUrl("#page="+a),d.title=window.siyuan.languages.thumbPageTitle.replace("{{page}}",JSON.parse(x(this,ds,Oo)).page),d.setAttribute("data-l10n-id","pdfjs-thumb-page-title"),d.setAttribute("data-l10n-args",x(this,ds,Oo)),d.onclick=function(){return l.goToPage(a),!1},this.anchor=d;const u=document.createElement("div");u.className="thumbnail",u.setAttribute("data-page-number",this.id),this.div=u,H(this,Su,u_).call(this);const m=document.createElement("div");m.className="thumbnailImage",this._placeholderImg=m,u.append(m),d.append(u),e.append(d)}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:1,rotation:n}),this.reset()}reset(){var e;this.cancelRendering(),this.renderingState=it.INITIAL,this.div.removeAttribute("data-loaded"),(e=this.image)==null||e.replaceWith(this._placeholderImg),H(this,Su,u_).call(this),this.image&&(this.image.removeAttribute("src"),delete this.image)}update({rotation:e=null}){typeof e=="number"&&(this.rotation=e);const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:n}),this.reset()}cancelRendering(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.resume=null}draw(){return se(this,null,function*(){if(this.renderingState!==it.INITIAL){console.error("Must be in new state before drawing");return}const{pdfPage:e}=this;if(!e)throw this.renderingState=it.FINISHED,new Error("pdfPage is not loaded");this.renderingState=it.RUNNING;const{ctx:n,canvas:a,transform:i}=H(this,Lu,f_).call(this,Lk),s=this.viewport.clone({scale:Lk*this.scale}),l=d=>{if(!this.renderingQueue.isHighestPriority(this)){this.renderingState=it.PAUSED,this.resume=()=>{this.renderingState=it.RUNNING,d()};return}d()},o={canvasContext:n,transform:i,viewport:s,optionalContentConfigPromise:this._optionalContentConfigPromise,pageColors:this.pageColors},r=this.renderTask=e.render(o);r.onContinue=l;const c=r.promise.then(()=>H(this,xu,g_).call(this,r,a),d=>H(this,xu,g_).call(this,r,a,d));return c.finally(()=>{a.width=0,a.height=0,this.eventBus.dispatch("thumbnailrendered",{source:this,pageNumber:this.id,pdfPage:this.pdfPage})}),c})}setImage(e){if(this.renderingState!==it.INITIAL)return;const{thumbnailCanvas:n,pdfPage:a,scale:i}=e;n&&(this.pdfPage||this.setPdfPage(a),!(i<this.scale)&&(this.renderingState=it.FINISHED,H(this,Au,p_).call(this,n)))}setPageLabel(e){var n;this.pageLabel=typeof e=="string"?e:null,this.anchor.title=window.siyuan.languages.thumbPageTitle.replace("{{page}}",JSON.parse(x(this,ds,Oo)).page),this.anchor.setAttribute("data-l10n-args",x(this,ds,Oo)),this.renderingState===it.FINISHED&&((n=this.image)==null||n.setAttribute("data-l10n-args",x(this,ds,Oo)))}}Su=new WeakSet,u_=function(){const{width:e,height:n}=this.viewport,a=e/n;this.canvasWidth=ET,this.canvasHeight=this.canvasWidth/a|0,this.scale=this.canvasWidth/e;const{style:i}=this.div;i.setProperty("--thumbnail-width",`${this.canvasWidth}px`),i.setProperty("--thumbnail-height",`${this.canvasHeight}px`)},Lu=new WeakSet,f_=function(e=1,n=this.enableHWA){const a=document.createElement("canvas"),i=a.getContext("2d",{alpha:!1,willReadFrequently:!n}),s=new ae.OutputScale;a.width=e*this.canvasWidth*s.sx|0,a.height=e*this.canvasHeight*s.sy|0;const l=s.scaled?[s.sx,0,0,s.sy,0,0]:null;return{ctx:i,canvas:a,transform:l}},Au=new WeakSet,p_=function(e){if(this.renderingState!==it.FINISHED)throw new Error("#convertCanvasToImage: Rendering has not finished.");const n=H(this,sm,FL).call(this,e),a=document.createElement("img");a.className="thumbnailImage",a.setAttribute("data-l10n-id","pdfjs-thumb-page-canvas"),a.setAttribute("data-l10n-args",x(this,ds,Oo)),a.src=n.toDataURL(),this.image=a,this.div.setAttribute("data-loaded",!0),this._placeholderImg.replaceWith(a),n.width=0,n.height=0},xu=new WeakSet,g_=function(e,n,a=null){return se(this,null,function*(){if(e===this.renderTask&&(this.renderTask=null),!(a instanceof ae.RenderingCancelledException)&&(this.renderingState=it.FINISHED,H(this,Au,p_).call(this,n),a))throw a})},sm=new WeakSet,FL=function(e){const{ctx:n,canvas:a}=H(this,Lu,f_).call(this,1,!0);if(e.width<=2*a.width)return n.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),a;let i=a.width<<Ak,s=a.height<<Ak;const[l,o]=Ub.getCanvas(i,s);for(;i>e.width||s>e.height;)i>>=1,s>>=1;for(o.drawImage(e,0,0,e.width,e.height,0,0,i,s);i>2*a.width;)o.drawImage(l,0,0,i,s,0,0,i>>1,s>>1),i>>=1,s>>=1;return n.drawImage(l,0,0,i,s,0,0,a.width,a.height),a},ds=new WeakSet,Oo=function(){var e;return JSON.stringify({page:(e=this.pageLabel)!=null?e:this.id})};const ST=-19,Wb="selected";class LT{constructor({container:e,eventBus:n,linkService:a,renderingQueue:i,pageColors:s,abortSignal:l,enableHWA:o}){O(this,lm);O(this,Cu);O(this,Tu);O(this,om);O(this,rm);O(this,cm);this.container=e,this.eventBus=n,this.linkService=a,this.renderingQueue=i,this.pageColors=s||null,this.enableHWA=o||!1,this.scroll=jE(this.container,H(this,lm,UL).bind(this),l),H(this,Tu,h_).call(this)}getThumbnail(e){return this._thumbnails[e]}scrollThumbnailIntoView(e){if(!this.pdfDocument)return;const n=this._thumbnails[e-1];if(!n){console.error('scrollThumbnailIntoView: Invalid "pageNumber" parameter.');return}e!==this._currentPageNumber&&(this._thumbnails[this._currentPageNumber-1].div.classList.remove(Wb),n.div.classList.add(Wb));const{first:a,last:i,views:s}=H(this,Cu,m_).call(this);if(s.length>0){let l=!1;if(e<=a.id||e>=i.id)l=!0;else for(const{id:o,percent:r}of s)if(o===e){l=r<100;break}l&&vb(n.div,{top:ST})}this._currentPageNumber=e}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!Hp(e))throw new Error("Invalid thumbnails rotation angle.");if(!this.pdfDocument||this._pagesRotation===e)return;this._pagesRotation=e;const n={rotation:e};for(const a of this._thumbnails)a.update(n)}cleanup(){for(const e of this._thumbnails)e.renderingState!==it.FINISHED&&e.reset();Ub.destroyCanvas()}setDocument(e){if(this.pdfDocument&&(H(this,om,WL).call(this),H(this,Tu,h_).call(this)),this.pdfDocument=e,!e)return;const n=e.getPage(1),a=e.getOptionalContentConfig({intent:"display"});n.then(i=>{var r;const s=e.numPages,l=i.getViewport({scale:1});for(let c=1;c<=s;++c){const d=new kT({container:this.container,eventBus:this.eventBus,id:c,defaultViewport:l.clone(),optionalContentConfigPromise:a,linkService:this.linkService,renderingQueue:this.renderingQueue,pageColors:this.pageColors,enableHWA:this.enableHWA});this._thumbnails.push(d)}(r=this._thumbnails[0])==null||r.setPdfPage(i),this._thumbnails[this._currentPageNumber-1].div.classList.add(Wb)}).catch(i=>{console.error("Unable to initialize thumbnail viewer",i)})}setPageLabels(e){var n,a;if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("PDFThumbnailViewer_setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let i=0,s=this._thumbnails.length;i<s;i++)this._thumbnails[i].setPageLabel((a=(n=this._pageLabels)==null?void 0:n[i])!=null?a:null)}}forceRendering(){const e=H(this,Cu,m_).call(this),n=H(this,cm,YL).call(this,e),a=this.renderingQueue.getHighestPriority(e,this._thumbnails,n);return a?(H(this,rm,VL).call(this,a).then(()=>{this.renderingQueue.renderView(a)}),!0):!1}}lm=new WeakSet,UL=function(){this.renderingQueue.renderHighestPriority()},Cu=new WeakSet,m_=function(){return JE({scrollEl:this.container,views:this._thumbnails})},Tu=new WeakSet,h_=function(){this._thumbnails=[],this._currentPageNumber=1,this._pageLabels=null,this._pagesRotation=0,this.container.textContent=""},om=new WeakSet,WL=function(){for(const e of this._thumbnails)e.cancelRendering()},rm=new WeakSet,VL=function(e){return se(this,null,function*(){if(e.pdfPage)return e.pdfPage;try{const n=yield this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(n),n}catch(n){return console.error("Unable to get page for thumb view",n),null}})},cm=new WeakSet,YL=function(e){var n,a;return((n=e.first)==null?void 0:n.id)===1?!0:((a=e.last)==null?void 0:a.id)===this._thumbnails.length?!1:this.scroll.down};class AT{constructor(e){O(this,Du,null);O(this,Iu,null);O(this,$u,null);O(this,Mu,null);O(this,Pu,null);O(this,Gr,void 0);this.pdfPage=e.pdfPage,this.accessibilityManager=e.accessibilityManager,this.l10n=e.l10n,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this.l10n||(this.l10n=new GenericL10n)),this.annotationEditorLayer=null,this.div=null,this._cancelled=!1,z(this,Gr,e.uiManager),z(this,Du,e.annotationLayer||null),z(this,Pu,e.textLayer||null),z(this,Iu,e.drawLayer||null),z(this,$u,e.onAppend||null),z(this,Mu,e.structTreeLayer||null)}render(e,n="display"){return se(this,null,function*(){var l;if(n!=="display"||this._cancelled)return;const a=e.clone({dontFlip:!0});if(this.div){this.annotationEditorLayer.update({viewport:a}),this.show();return}const i=this.div=document.createElement("div");i.className="annotationEditorLayer",i.hidden=!0,i.dir=x(this,Gr).direction,(l=x(this,$u))==null||l.call(this,i),this.annotationEditorLayer=new ae.AnnotationEditorLayer({uiManager:x(this,Gr),div:i,structTreeLayer:x(this,Mu),accessibilityManager:this.accessibilityManager,pageIndex:this.pdfPage.pageNumber-1,l10n:this.l10n,viewport:a,annotationLayer:x(this,Du),textLayer:x(this,Pu),drawLayer:x(this,Iu)});const s={viewport:a,div:i,annotations:null,intent:n};this.annotationEditorLayer.render(s),this.show()})}cancel(){this._cancelled=!0,this.div&&this.annotationEditorLayer.destroy()}hide(){this.div&&(this.div.hidden=!0)}show(){!this.div||this.annotationEditorLayer.isInvisible||(this.div.hidden=!1)}}Du=new WeakMap,Iu=new WeakMap,$u=new WeakMap,Mu=new WeakMap,Pu=new WeakMap,Gr=new WeakMap;class xT{constructor({pdfPage:e,linkService:n,downloadManager:a,annotationStorage:i=null,imageResourcesPath:s="",renderForms:l=!0,enableScripting:o=!1,hasJSActionsPromise:r=null,fieldObjectsPromise:c=null,annotationCanvasMap:d=null,accessibilityManager:u=null,annotationEditorUIManager:m=null,onAppend:f=null}){O(this,Hu);O(this,Nu,null);O(this,el,null);this.pdfPage=e,this.linkService=n,this.downloadManager=a,this.imageResourcesPath=s,this.renderForms=l,this.annotationStorage=i,this.enableScripting=o,this._hasJSActionsPromise=r||Promise.resolve(!1),this._fieldObjectsPromise=c||Promise.resolve(null),this._annotationCanvasMap=d,this._accessibilityManager=u,this._annotationEditorUIManager=m,z(this,Nu,f),this.annotationLayer=null,this.div=null,this._cancelled=!1,this._eventBus=n.eventBus}render(e,n,a="display"){return se(this,null,function*(){var r,c;if(this.div){if(this._cancelled||!this.annotationLayer)return;this.annotationLayer.update({viewport:e.clone({dontFlip:!0})});return}const[i,s,l]=yield Promise.all([this.pdfPage.getAnnotations({intent:a}),this._hasJSActionsPromise,this._fieldObjectsPromise]);if(this._cancelled)return;const o=this.div=document.createElement("div");if(o.className="annotationLayer",(r=x(this,Nu))==null||r.call(this,o),i.length===0){this.hide();return}this.annotationLayer=new ae.AnnotationLayer({div:o,accessibilityManager:this._accessibilityManager,annotationCanvasMap:this._annotationCanvasMap,annotationEditorUIManager:this._annotationEditorUIManager,page:this.pdfPage,viewport:e.clone({dontFlip:!0}),structTreeLayer:(n==null?void 0:n.structTreeLayer)||null}),yield this.annotationLayer.render({annotations:i,imageResourcesPath:this.imageResourcesPath,renderForms:this.renderForms,linkService:this.linkService,downloadManager:this.downloadManager,annotationStorage:this.annotationStorage,enableScripting:this.enableScripting,hasJSActions:s,fieldObjects:l}),this.linkService.isInPresentationMode&&H(this,Hu,b_).call(this,kn.FULLSCREEN),x(this,el)||(z(this,el,new AbortController),(c=this._eventBus)==null||c._on("presentationmodechanged",d=>{H(this,Hu,b_).call(this,d.state)},{signal:x(this,el).signal}))})}cancel(){var e;this._cancelled=!0,(e=x(this,el))==null||e.abort(),z(this,el,null)}hide(){this.div&&(this.div.hidden=!0)}hasEditableAnnotations(){var e;return!!((e=this.annotationLayer)!=null&&e.hasEditableAnnotations())}}Nu=new WeakMap,el=new WeakMap,Hu=new WeakSet,b_=function(e){if(!this.div)return;let n=!1;switch(e){case kn.FULLSCREEN:n=!0;break;case kn.NORMAL:break;default:return}for(const a of this.div.childNodes)a.hasAttribute("data-internal-link")||(a.inert=n)};class CT{constructor(e){O(this,Bi,null);this.pageIndex=e.pageIndex}render(e="display"){return se(this,null,function*(){e!=="display"||x(this,Bi)||this._cancelled||z(this,Bi,new ae.DrawLayer({pageIndex:this.pageIndex}))})}cancel(){this._cancelled=!0,x(this,Bi)&&(x(this,Bi).destroy(),z(this,Bi,null))}setParent(e){var n;(n=x(this,Bi))==null||n.setParent(e)}getDrawLayer(){return x(this,Bi)}}Bi=new WeakMap;const xk={Document:null,DocumentFragment:null,Part:"group",Sect:"group",Div:"group",Aside:"note",NonStruct:"none",P:null,H:"heading",Title:null,FENote:"note",Sub:"group",Lbl:null,Span:null,Em:null,Strong:null,Link:"link",Annot:"note",Form:"form",Ruby:null,RB:null,RT:null,RP:null,Warichu:null,WT:null,WP:null,L:"list",LI:"listitem",LBody:null,Table:"table",TR:"row",TH:"columnheader",TD:"cell",THead:"columnheader",TBody:null,TFoot:null,Caption:null,Figure:"figure",Formula:null,Artifact:null},TT=/^H(\d+)$/;class DT{constructor(e,n){O(this,Ou);O(this,dm);O(this,Bu);O(this,jr,void 0);O(this,bi,null);O(this,Kr,void 0);O(this,Zr,new Map);O(this,Jr,void 0);O(this,tl,null);z(this,jr,e.getStructTree()),z(this,Jr,n)}render(){return se(this,null,function*(){var i;if(x(this,Kr))return x(this,Kr);const{promise:e,resolve:n,reject:a}=Promise.withResolvers();z(this,Kr,e);try{z(this,bi,H(this,Bu,__).call(this,yield x(this,jr)))}catch(s){a(s)}return z(this,jr,null),(i=x(this,bi))==null||i.classList.add("structTree"),n(x(this,bi)),e})}getAriaAttributes(e){return se(this,null,function*(){return yield this.render(),x(this,Zr).get(e)})}hide(){x(this,bi)&&!x(this,bi).hidden&&(x(this,bi).hidden=!0)}show(){var e;(e=x(this,bi))!=null&&e.hidden&&(x(this,bi).hidden=!1)}addElementsToTextLayer(){var e;if(x(this,tl)){for(const[n,a]of x(this,tl))(e=document.getElementById(n))==null||e.append(a);x(this,tl).clear(),z(this,tl,null)}}}jr=new WeakMap,bi=new WeakMap,Kr=new WeakMap,Zr=new WeakMap,Jr=new WeakMap,tl=new WeakMap,Ou=new WeakSet,y_=function(e,n){const{alt:a,id:i,lang:s}=e;if(a!==void 0){let l=!1;const o=dr(a);for(const r of e.children)if(r.type==="annotation"){let c=x(this,Zr).get(r.id);c||(c=new Map,x(this,Zr).set(r.id,c)),c.set("aria-label",o),l=!0}l||n.setAttribute("aria-label",o)}i!==void 0&&n.setAttribute("aria-owns",i),s!==void 0&&n.setAttribute("lang",dr(s,!0))},dm=new WeakSet,zL=function(e,n){const{alt:a,bbox:i,children:s}=e,l=s==null?void 0:s[0];if(!x(this,Jr)||!a||!i||(l==null?void 0:l.type)!=="content")return!1;const{id:o}=l;if(!o)return!1;n.setAttribute("aria-owns",o);const r=document.createElement("span");(x(this,tl)||z(this,tl,new Map)).set(o,r),r.setAttribute("role","img"),r.setAttribute("aria-label",dr(a));const{pageHeight:c,pageX:d,pageY:u}=x(this,Jr),m="calc(var(--scale-factor)*",{style:f}=r;return f.width=`${m}${i[2]-i[0]}px)`,f.height=`${m}${i[3]-i[1]}px)`,f.left=`${m}${i[0]-d}px)`,f.top=`${m}${c-i[3]+u}px)`,!0},Bu=new WeakSet,__=function(e){if(!e)return null;const n=document.createElement("span");if("role"in e){const{role:a}=e,i=a.match(TT);if(i?(n.setAttribute("role","heading"),n.setAttribute("aria-level",i[1])):xk[a]&&n.setAttribute("role",xk[a]),a==="Figure"&&H(this,dm,zL).call(this,e,n))return n}if(H(this,Ou,y_).call(this,e,n),e.children)if(e.children.length===1&&"id"in e.children[0])H(this,Ou,y_).call(this,e.children[0],n);else for(const a of e.children)n.append(H(this,Bu,__).call(this,a));return n};const Qr=class Qr{constructor(){O(this,Ru);O(this,us,!1);O(this,Za,null);O(this,fs,new Map);O(this,nl,new Map)}setTextMapping(e){z(this,Za,e)}enable(){if(x(this,us))throw new Error("TextAccessibilityManager is already enabled.");if(!x(this,Za))throw new Error("Text divs and strings have not been set.");if(z(this,us,!0),z(this,Za,x(this,Za).slice()),x(this,Za).sort(H(Qr,Xr,qm)),x(this,fs).size>0){const e=x(this,Za);for(const[n,a]of x(this,fs)){if(!document.getElementById(n)){x(this,fs).delete(n);continue}H(this,Ru,w_).call(this,n,e[a])}}for(const[e,n]of x(this,nl))this.addPointerInTextLayer(e,n);x(this,nl).clear()}disable(){x(this,us)&&(x(this,nl).clear(),z(this,Za,null),z(this,us,!1))}removePointerInTextLayer(e){if(!x(this,us)){x(this,nl).delete(e);return}const n=x(this,Za);if(!n||n.length===0)return;const{id:a}=e,i=x(this,fs).get(a);if(i===void 0)return;const s=n[i];x(this,fs).delete(a);let l=s.getAttribute("aria-owns");l!=null&&l.includes(a)&&(l=l.split(" ").filter(o=>o!==a).join(" "),l?s.setAttribute("aria-owns",l):(s.removeAttribute("aria-owns"),s.setAttribute("role","presentation")))}addPointerInTextLayer(e,n){const{id:a}=e;if(!a)return null;if(!x(this,us))return x(this,nl).set(e,n),null;n&&this.removePointerInTextLayer(e);const i=x(this,Za);if(!i||i.length===0)return null;const s=od(i,c=>{var d;return H(d=Qr,Xr,qm).call(d,e,c)<0}),l=Math.max(0,s-1),o=i[l];H(this,Ru,w_).call(this,a,o),x(this,fs).set(a,l);const r=o.parentNode;return r!=null&&r.classList.contains("markedContent")?r.id:null}moveElementInDOM(e,n,a,i){const s=this.addPointerInTextLayer(a,i);if(!e.hasChildNodes())return e.append(n),s;const l=Array.from(e.childNodes).filter(c=>c!==n);if(l.length===0)return s;const o=a||n,r=od(l,c=>{var d;return H(d=Qr,Xr,qm).call(d,o,c)<0});return r===0?l[0].before(n):l[r-1].after(n),s}};us=new WeakMap,Za=new WeakMap,fs=new WeakMap,nl=new WeakMap,Xr=new WeakSet,qm=function(e,n){const a=e.getBoundingClientRect(),i=n.getBoundingClientRect();if(a.width===0&&a.height===0)return 1;if(i.width===0&&i.height===0)return-1;const s=a.y,l=a.y+a.height,o=a.y+a.height/2,r=i.y,c=i.y+i.height,d=i.y+i.height/2;if(o<=r&&d>=l)return-1;if(d<=s&&o>=c)return 1;const u=a.x+a.width/2,m=i.x+i.width/2;return u-m},Ru=new WeakSet,w_=function(e,n){const a=n.getAttribute("aria-owns");a!=null&&a.includes(e)||n.setAttribute("aria-owns",a?`${a} ${e}`:e),n.removeAttribute("role")},O(Qr,Xr);let Vb=Qr;class IT{constructor({findController:e,eventBus:n,pageIndex:a}){O(this,al,null);this.findController=e,this.matches=[],this.eventBus=n,this.pageIdx=a,this.textDivs=null,this.textContentItemsStr=null,this.enabled=!1}setTextMapping(e,n){this.textDivs=e,this.textContentItemsStr=n}enable(){if(!this.textDivs||!this.textContentItemsStr)throw new Error("Text divs and strings have not been set.");if(this.enabled)throw new Error("TextHighlighter is already enabled.");this.enabled=!0,x(this,al)||(z(this,al,new AbortController),this.eventBus._on("updatetextlayermatches",e=>{(e.pageIndex===this.pageIdx||e.pageIndex===-1)&&this._updateMatches()},{signal:x(this,al).signal})),this._updateMatches()}disable(){var e;this.enabled&&(this.enabled=!1,(e=x(this,al))==null||e.abort(),z(this,al,null),this._updateMatches(!0))}_convertMatches(e,n){if(!e)return[];const{textContentItemsStr:a}=this;let i=0,s=0;const l=a.length-1,o=[];for(let r=0,c=e.length;r<c;r++){let d=e[r];for(;i!==l&&d>=s+a[i].length;)s+=a[i].length,i++;i===a.length&&console.error("Could not find a matching mapping");const u={begin:{divIdx:i,offset:d-s}};for(d+=n[r];i!==l&&d>s+a[i].length;)s+=a[i].length,i++;u.end={divIdx:i,offset:d-s},o.push(u)}return o}_renderMatches(e){if(e.length===0)return;const{findController:n,pageIdx:a}=this,{textContentItemsStr:i,textDivs:s}=this,l=a===n.selected.pageIdx,o=n.selected.matchIdx,r=n.state.highlightAll;let c=null;const d={divIdx:-1,offset:void 0};function u(y,w){const E=y.divIdx;return s[E].textContent="",m(E,0,y.offset,w)}function m(y,w,E,C){let $=s[y];if($.nodeType===Node.TEXT_NODE){const _=document.createElement("span");$.before(_),_.append($),s[y]=_,$=_}const M=i[y].substring(w,E),k=document.createTextNode(M);if(C){const _=document.createElement("span");return _.className=`${C} appended`,_.append(k),$.append(_),C.includes("selected")?_.offsetLeft:0}return $.append(k),0}let f=o,g=f+1;if(r)f=0,g=e.length;else if(!l)return;let h=-1,b=-1;for(let y=f;y<g;y++){const w=e[y],E=w.begin;if(E.divIdx===h&&E.offset===b)continue;h=E.divIdx,b=E.offset;const C=w.end,$=l&&y===o,M=$?" selected":"";let k=0;if(!c||E.divIdx!==c.divIdx?(c!==null&&m(c.divIdx,c.offset,d.offset),u(E)):m(c.divIdx,c.offset,E.offset),E.divIdx===C.divIdx)k=m(E.divIdx,E.offset,C.offset,"highlight"+M);else{k=m(E.divIdx,E.offset,d.offset,"highlight begin"+M);for(let _=E.divIdx+1,v=C.divIdx;_<v;_++)s[_].className="highlight middle"+M;u(C,"highlight end"+M)}c=C,$&&n.scrollMatchIntoView({element:s[E.divIdx],selectedLeft:k,pageIndex:a,matchIndex:o})}c&&m(c.divIdx,c.offset,d.offset)}_updateMatches(e=!1){if(!this.enabled&&!e)return;const{findController:n,matches:a,pageIdx:i}=this,{textContentItemsStr:s,textDivs:l}=this;let o=-1;for(const d of a){const u=Math.max(o,d.begin.divIdx);for(let m=u,f=d.end.divIdx;m<=f;m++){const g=l[m];g.textContent=s[m],g.className=""}o=d.end.divIdx+1}if(!(n!=null&&n.highlightMatches)||e)return;const r=n.pageMatches[i]||null,c=n.pageMatchesLength[i]||null;this.matches=this._convertMatches(r,c),this._renderMatches(this.matches)}}al=new WeakMap;var Ck=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const $T=(t,e)=>{Ul(e);const n=e.appConfig,a=n.toolbar.rectAnno;a.addEventListener("click",()=>{a.classList.contains("toggled")?(a.classList.remove("toggled"),n.mainContainer.classList.remove("rect-to-annotation")):(e.pdfCursorTools.switchTool(0),a.classList.add("toggled"),n.mainContainer.classList.add("rect-to-annotation"),getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0),Ms(t))});const i=n.mainContainer.lastElementChild;return n.mainContainer.addEventListener("mousedown",s=>{if(s.button===2||!a.classList.contains("toggled"))return;let l=e.pdfViewer._getVisiblePages().first.view.canvas.getBoundingClientRect();s.clientX>l.right&&(l=e.pdfViewer._getVisiblePages().last.view.canvas.getBoundingClientRect());const o=n.mainContainer.getBoundingClientRect(),r=l.left,c=l.right,d=o.bottom;let u=s.clientX;s.clientX>c?u=c:s.clientX<r&&(u=r);const m=o.top,f=s.clientY,g=document;g.onmousemove=h=>{i.classList.remove("fn__none");let b=0,y=0,w=0,E=0;h.clientX<u?(h.clientX<r?y=r:y=h.clientX,w=u-y):h.clientX>c?(y=u,w=c-y):(y=u,w=h.clientX-u),h.clientY>f?h.clientY>d?(b=f,E=d-f):(b=f,E=h.clientY-f):(h.clientY<m?b=m:b=h.clientY,E=f-b),i.setAttribute("style",`top:${b}px;height:${E}px;left:${y}px;width:${w}px;background-color:${h.altKey?"var(--b3-pdf-background1)":""}`)},g.onmouseup=()=>{g.onmousemove=null,g.onmouseup=null,g.ondragstart=null,g.onselectstart=null,g.onselect=null,a.classList.remove("toggled"),n.mainContainer.classList.remove("rect-to-annotation");const h=PT(e,window.siyuan.storage[p.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)",i,i.style.backgroundColor?"text":"border");i.classList.add("fn__none"),h?h.forEach((b,y)=>{const w=Wp(b,e);y===0&&(Kt=w,Vp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Kt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}):Kt=null}}),t.addEventListener("click",s=>{let l=!1,o=s.target;if(typeof s.detail=="string"){window.siyuan.storage[p.LOCAL_PDFTHEME].annoColor=s.detail==="0"?window.siyuan.storage[p.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)":`var(--b3-pdf-background${s.detail})`,Ee(p.LOCAL_PDFTHEME,window.siyuan.storage[p.LOCAL_PDFTHEME]);const r=Ik(e,window.siyuan.storage[p.LOCAL_PDFTHEME].annoColor);r&&r.forEach((c,d)=>{const u=Wp(c,e);d===0&&(Kt=u,Vp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Kt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}),Ms(t);return}for(;o&&!o.classList.contains("pdf__outer");){const r=o.getAttribute("data-type");if(o.classList.contains("color__square")){const c=o.style.backgroundColor;if(window.siyuan.storage[p.LOCAL_PDFTHEME].annoColor=c,Ee(p.LOCAL_PDFTHEME,window.siyuan.storage[p.LOCAL_PDFTHEME]),Kt){const d=Ul(e),u=d[Kt.getAttribute("data-node-id")];u.color=c,t.querySelectorAll(`.pdf__rect[data-node-id="${Kt.getAttribute("data-node-id")}"]`).forEach(m=>{Array.from(m.children).forEach(f=>{f.style.border="2px solid "+c,u.type==="text"?f.style.backgroundColor=c:f.style.backgroundColor="transparent"})}),A("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(d)})}else{const d=Ik(e,c);d&&d.forEach((u,m)=>{const f=Wp(u,e);m===0&&(Kt=f,Vp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Kt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))})}Ms(t),l=!0,s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("pdf__rect")){Tk(t,void 0,o),s.preventDefault(),s.stopPropagation(),l=!0;break}else if(r==="remove"){const c=e.appConfig.file.replace(location.origin,"").substr(1),d=Ul(e),u=Kt.getAttribute("data-node-id");delete d[u],t.querySelectorAll(`[data-node-id="${u}"]`).forEach(m=>{m.remove()}),A("/api/asset/setFileAnnotation",{path:c+".sya",data:JSON.stringify(d)}),Ms(t),s.preventDefault(),s.stopPropagation(),l=!0;break}else if(r==="copy"){Ms(t),Vp(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Kt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e),s.preventDefault(),s.stopPropagation(),l=!0;break}else if(r==="relate"){MT(e),Ms(t),s.preventDefault(),s.stopPropagation(),l=!0;break}else if(r==="toggle"){const c=Ul(e),d=c[Kt.getAttribute("data-node-id")];d.type==="border"?d.type="text":d.type="border",t.querySelectorAll(`.pdf__rect[data-node-id="${Kt.getAttribute("data-node-id")}"]`).forEach(u=>{Array.from(u.children).forEach(m=>{d.type==="text"?m.style.backgroundColor=m.style.border.replace("2px solid ",""):m.style.backgroundColor=""})}),A("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(c)}),s.preventDefault(),s.stopPropagation(),l=!0,Ms(t);break}o=o.parentElement}l||setTimeout(()=>{let r=!1;const c=window.getSelection();if(c.rangeCount>0){const d=c.getRangeAt(0);d.toString()!==""&&T(d.commonAncestorContainer,"pdfViewer")&&(Tk(t,d),r=!0)}r||Ms(t)})}),e},Yb=t=>{if(!t)return`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let e="";return t.forEach(n=>{e+=`<li data-id="${n}" class="popover__block b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${n}</span>
    <span data-type="clear" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`}),e},MT=t=>{const e=Ul(t),n=e[Kt.getAttribute("data-node-id")];n.ids||(n.ids=[]);const a=new $e({title:window.siyuan.languages.relation,content:`<div class="b3-dialog__content">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1" placeholder="${window.siyuan.languages.fileAnnoRefPlaceholder}">
        <div class="fn__space"></div>
        <button class="b3-button b3-button--text" data-type="add">${window.siyuan.languages.addAttr}</button>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background">${Yb(n.ids)}</ul>
</div>`,width:"520px"}),i=()=>{/\d{14}-\w{7}/.test(l.value)?(n.ids.includes(l.value)||(n.ids.push(l.value),s(t,e),Kt.dataset.relations=n.ids,a.element.querySelector(".b3-list").innerHTML=Yb(n.ids)),l.value=""):de("ID "+window.siyuan.languages.invalid)},s=(o,r)=>{A("/api/asset/setFileAnnotation",{path:o.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(r)})},l=a.element.querySelector(".b3-text-field");l.focus(),l.addEventListener("keydown",o=>{o.isComposing||o.key==="Enter"&&i()}),a.element.addEventListener("click",o=>{let r=o.target;for(;r&&!r.classList.contains("b3-dialog__content");){const c=r.getAttribute("data-type");if(c==="add"){i(),o.preventDefault(),o.stopPropagation();break}else c==="clear"&&(n.ids.splice(n.ids.indexOf(r.parentElement.textContent.trim()),1),s(t,e),Kt.dataset.relations=n.ids,a.element.querySelector(".b3-list").innerHTML=Yb(n.ids));r=r.parentElement}})},Ms=t=>{t.querySelector(".pdf__util").classList.add("fn__none")};let Kt;const Tk=(t,e,n)=>{n&&(n.setAttribute("prevent-popover","true"),setTimeout(()=>{n.removeAttribute("prevent-popover")},620));const a=t.querySelector(".pdf__util");if(a.classList.remove("fn__none"),e){a.classList.add("pdf__util--hide");const s=e.getClientRects(),l=s[s.length-1];Te(a,l.left,l.bottom),Kt=null;return}Kt=n,a.classList.remove("pdf__util--hide");const i=n.firstElementChild.getBoundingClientRect();Te(a,i.left,i.top+i.height+4)},Dk=(t,e)=>{const n=t.querySelectorAll('span[role="presentation"]');let a=e?0:n.length-1;for(;n[a]&&!n[a].textContent;)e?a++:a--;return n[a]},Ik=(t,e)=>{const n=window.getSelection().getRangeAt(0),a=T(n.startContainer,"page");if(!a)return;const i=parseInt(a.getAttribute("data-page-number"))-1,s=T(n.endContainer,"page");if(!s)return;const l=parseInt(s.getAttribute("data-page-number"))-1,o=n.cloneContents();Array.from(o.children).forEach(w=>{if(w.tagName==="BR"&&w.previousElementSibling&&w.nextElementSibling){const E=w.previousElementSibling.textContent,C=w.nextElementSibling.textContent;/^[A-Za-z]$/.test(E.substring(E.length-2,E.length-1))&&/^[A-Za-z]$/.test(C.substring(0,1))&&(E.endsWith("-")?w.previousElementSibling.textContent=E.substring(0,E.length-1):w.insertAdjacentText("afterend"," "))}});const r=Lute.EscapeHTMLStr(o.textContent.replace(/[\x00]|\n/g,"")),c=t.pdfViewer.getPageView(i),d=c.canvas.getClientRects()[0],u=c.viewport,m=n.cloneRange();i!==l&&n.setEndAfter(Dk(c.textLayer.div,!1));const f=[];$k(n).forEach(function(w){f.push(u.convertToPdfPoint(w.left-d.x,w.top-d.y).concat(u.convertToPdfPoint(w.right-d.x,w.bottom-d.y)))});const g=[];if(i!==l){ne(m);const w=t.pdfViewer.getPageView(l),E=w.canvas.getClientRects()[0],C=w.viewport;m.setStart(Dk(w.textLayer.div,!0),0),$k(m).forEach(function($){g.push(C.convertToPdfPoint($.left-E.x,$.top-E.y).concat(C.convertToPdfPoint($.right-E.x,$.bottom-E.y)))})}const h=Lute.NewNodeID(),b=[],y=[];if(f.length>0&&(b.push({index:i,positions:f}),y.push({index:i,coords:f,id:h,color:e,content:r,type:"text",mode:"text"})),g.length>0&&(b.push({index:l,positions:g}),y.push({index:l,coords:g,id:h,color:e,content:r,type:"text",mode:"text"})),b.length!==0)return Nk(t,h,{pages:b,content:r,color:e,type:"text",mode:"text"}),y},PT=(t,e,n,a)=>{const i=n.getBoundingClientRect(),s=T(document.elementFromPoint(i.left,i.top-1),"page");if(!s)return;const l=parseInt(s.getAttribute("data-page-number"))-1,o=t.pdfViewer.getPageView(l),r=o.canvas.getClientRects()[0],c=o.viewport,d=c.convertToPdfPoint(i.left-r.x,i.top-r.y).concat(c.convertToPdfPoint(i.right-r.x,i.bottom-r.y)),u=[{index:o.id-1,positions:[d]}],m=Lute.NewNodeID(),f=`${t.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,"")}-P${o.id}-${m}`,g=[{index:o.id-1,coords:[d],id:m,color:e,content:f,type:a,mode:"rect"}];let h=document.elementFromPoint(i.right,i.bottom+1);if(h=T(h,"page"),h){const b=parseInt(h.getAttribute("data-page-number"))-1;if(b!==l){const y=t.pdfViewer.getPageView(b),w=y.canvas.getClientRects()[0],E=y.viewport,C=E.convertToPdfPoint(i.left-w.x,i.top-w.y).concat(E.convertToPdfPoint(i.right-w.x,i.bottom-w.y));u.push({index:y.id-1,positions:[C]}),g.push({index:y.id-1,coords:[C],id:m,color:e,content:f,type:a,mode:"rect"})}}return Nk(t,m,{pages:u,content:f,color:e,type:a,mode:"rect"}),g},$k=t=>{const e=t.getClientRects(),n=[];let a;return Array.from(e).forEach(i=>{i.height===0||i.width===0||(typeof a=="undefined"||Math.abs(a-i.top)>4?(n.push({left:i.left,top:i.top,right:i.right,bottom:i.bottom}),a=i.top):n[n.length-1].right=i.right)}),n},zb=t=>{let e;return Oe().asset.find(n=>{if(n.pdfObject&&t&&n.element&&typeof n.element.contains!="undefined"&&n.element.contains(t))return e=n.pdfObject,!0}),e},Mk=t=>{const e=zb(t);if(!e)return;const n=parseInt(t.parentElement.getAttribute("data-page-number"))-1,a=Ul(e);Object.keys(a).find(i=>{const s=a[i],l=s.pages.find(o=>{if(o.index===n)return!0});l&&Wp({index:n,coords:l.positions,id:i,color:s.color,content:s.content,type:s.type,mode:s.mode||"",ids:s.ids},e,e.annoId===i)})},Wp=(t,e,n)=>{const a=t.index,i=e.pdfViewer.getPageView(a),s=i.textLayer.div;if(!s.lastElementChild)return;const l=i.viewport.clone({rotation:0});let o=s.querySelector(".pdf__rects");o||(s.insertAdjacentHTML("beforeend","<div class='pdf__rects'></div>"),o=s.querySelector(".pdf__rects"));let r=`<div class="pdf__rect popover__block" data-node-id="${t.id}" data-relations="${t.ids||""}" data-mode="${t.mode}">`;return t.coords.forEach(c=>{const d=l.convertToViewportRectangle(c),u=Math.abs(d[0]-d[2]);if(u<=0)return;let m=`border: 2px solid ${t.color};background-color: ${t.color};`;t.type==="border"&&(m=`border: 2px solid ${t.color};`),r+=`<div style="${m}
left:${Math.min(d[0],d[2])}px;
top:${Math.min(d[1],d[3])}px;
width:${u}px;
height: ${Math.abs(d[1]-d[3])}px"></div>`}),o.insertAdjacentHTML("beforeend",r+"</div>"),o.lastElementChild.setAttribute("data-content",t.content),n&&Pk(o,t.id),o.lastElementChild},Pk=(t,e)=>{t.querySelectorAll(`.pdf__rect[data-node-id="${e}"]`).forEach(n=>{if(n&&n.firstElementChild){const a=j(n,"id","viewerContainer");if(a){const i=n.firstElementChild.getBoundingClientRect(),s=a.getBoundingClientRect();i.top<s.top?a.scrollTop=a.scrollTop-(s.top-i.top)-(s.height-i.height)/2:i.bottom>s.bottom&&(a.scrollTop=a.scrollTop+(i.bottom-s.bottom)+(s.height-i.height)/2)}n.classList.add("pdf__rect--hl"),setTimeout(()=>{n.classList.remove("pdf__rect--hl")},1500)}})},Vp=(t,e,n)=>{const a=Kt.getAttribute("data-mode"),i=Kt.getAttribute("data-content");setTimeout(()=>{a==="rect"||a===""&&Kt.childElementCount===1&&i.startsWith(e)?HT(n).then(s=>{fetch(s).then(l=>l.blob()).then(l=>{const o=new FormData,r=i+".png";o.append("file[]",l,r),o.append("skipIfDuplicated","true"),A(p.UPLOAD_ADDRESS,o,c=>{Be(`<<${t} "${i}">>
![](${c.data.succMap[r]})`)})})}):Be(`<<${t} "${i}">>`)},p.TIMEOUT_DBLCLICK)},NT=(t,e)=>Ck(void 0,null,function*(){const n=yield t.pdfDocument.getPage(e),a=n.getViewport({scale:1.5*t.pdfViewer.currentScale*window.pdfjsLib.PixelsPerInch.PDF_TO_CSS_UNITS}),i=document.createElement("canvas");return i.width=Math.floor(a.width),i.height=Math.floor(a.height),yield n.render({canvasContext:i.getContext("2d"),viewport:a}).promise,i});function HT(t){return Ck(this,null,function*(){const e=T(Kt,"page");if(!e)return;const n=yield NT(t,parseInt(e.getAttribute("data-page-number"))),a=Kt.firstElementChild.style,i=1.5,s=n.getContext("2d").getImageData(i*parseFloat(a.left),i*parseFloat(a.top),i*parseFloat(a.width),i*parseFloat(a.height)),l=document.createElement("canvas");return l.width=s.width,l.height=s.height,l.getContext("2d").putImageData(s,0,0),l.toDataURL()})}const Nk=(t,e,n)=>{const a=Ul(t);a[e]=n,A("/api/asset/setFileAnnotation",{path:t.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(a)})},Ul=t=>{if(t.appConfig.config)return t.appConfig.config;const e=t.appConfig.file.replace(location.origin,"").substr(1)+".sya";A("/api/asset/getFileAnnotation",{path:e},n=>{let a={};n.code!==1&&(a=JSON.parse(n.data.data)),t.appConfig.config=a})},ps=class ps{constructor({pdfPage:e,highlighter:n=null,accessibilityManager:a=null,enablePermissions:i=!1,onAppend:s=null}){O(this,um);O(this,qu,!1);O(this,Fu,null);O(this,Eo,!1);O(this,Ri,null);this.pdfPage=e,this.highlighter=n,this.accessibilityManager=a,z(this,qu,i===!0),z(this,Fu,s),this.div=document.createElement("div"),this.div.tabIndex=0,this.div.className="textLayer"}render(e,n=null){return se(this,null,function*(){var l,o,r,c,d,u;if(x(this,Eo)&&x(this,Ri)){x(this,Ri).update({viewport:e,onBefore:this.hide.bind(this)}),this.show(),(l=this.div.querySelector(".pdf__rects"))==null||l.remove(),Mk(this.div);return}this.cancel(),z(this,Ri,new ae.TextLayer({textContentSource:this.pdfPage.streamTextContent(n||{includeMarkedContent:!0,disableNormalization:!0}),container:this.div,viewport:e}));const{textDivs:a,textContentItemsStr:i}=x(this,Ri);(o=this.highlighter)==null||o.setTextMapping(a,i),(r=this.accessibilityManager)==null||r.setTextMapping(a),yield x(this,Ri).render(),z(this,Eo,!0);const s=document.createElement("div");s.className="endOfContent",this.div.append(s),H(this,um,GL).call(this,s),(c=x(this,Fu))==null||c.call(this,this.div),(d=this.highlighter)==null||d.enable(),Mk(this.div),(u=this.accessibilityManager)==null||u.enable()})}hide(){var e;!this.div.hidden&&x(this,Eo)&&((e=this.highlighter)==null||e.disable(),this.div.hidden=!0)}show(){var e;this.div.hidden&&x(this,Eo)&&(this.div.hidden=!1,(e=this.highlighter)==null||e.enable())}cancel(){var e,n,a,i;(e=x(this,Ri))==null||e.cancel(),z(this,Ri,null),(n=this.highlighter)==null||n.disable(),(a=this.accessibilityManager)==null||a.disable(),H(i=ps,fm,jL).call(i,this.div)}};qu=new WeakMap,Fu=new WeakMap,Eo=new WeakMap,Ri=new WeakMap,va=new WeakMap,il=new WeakMap,um=new WeakSet,GL=function(e){var a;const{div:n}=this;n.addEventListener("mousedown",()=>{n.classList.add("selecting")}),n.addEventListener("copy",i=>{if(!x(this,qu)){const s=document.getSelection();i.clipboardData.setData("text/plain",dr((0,ae.normalizeUnicode)(s.toString())))}i.preventDefault(),i.stopPropagation()}),x(ps,va).set(n,e),H(a=ps,pm,KL).call(a)},fm=new WeakSet,jL=function(e){var n;x(this,va).delete(e),x(this,va).size===0&&((n=x(this,il))==null||n.abort(),z(this,il,null))},pm=new WeakSet,KL=function(){if(x(this,il))return;z(this,il,new AbortController);const{signal:e}=x(this,il),n=(l,o)=>{(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&(o.append(l),l.style.width="",l.style.height=""),o.classList.remove("selecting")};let a=!1;if(document.addEventListener("pointerdown",()=>{a=!0},{signal:e}),document.addEventListener("pointerup",()=>{a=!1,x(this,va).forEach(n)},{signal:e}),window.addEventListener("blur",()=>{a=!1,x(this,va).forEach(n)},{signal:e}),document.addEventListener("keyup",()=>{a||x(this,va).forEach(n)},{signal:e}),typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))var i,s;document.addEventListener("selectionchange",()=>{const l=document.getSelection();if(l.rangeCount===0){x(this,va).forEach(n);return}const o=new Set;for(let f=0;f<l.rangeCount;f++){const g=l.getRangeAt(f);for(const h of x(this,va).keys())!o.has(h)&&g.intersectsNode(h)&&o.add(h)}for(const[f,g]of x(this,va))o.has(f)?f.classList.add("selecting"):n(g,f);if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")||(typeof PDFJSDev=="undefined"||!PDFJSDev.test("CHROME"))&&(i!=null||(i=getComputedStyle(x(this,va).values().next().value).getPropertyValue("-moz-user-select")==="none"),i))return;const r=l.getRangeAt(0),c=s&&(r.compareBoundaryPoints(Range.END_TO_END,s)===0||r.compareBoundaryPoints(Range.START_TO_END,s)===0);let d=c?r.startContainer:r.endContainer;d.nodeType===Node.TEXT_NODE&&(d=d.parentNode);const u=d.parentElement.closest(".textLayer"),m=x(this,va).get(u);m&&(m.style.width=u.style.width,m.style.height=u.style.height,d.parentElement.insertBefore(m,c?d:d.nextSibling)),s=r.cloneRange()},{signal:e})},O(ps,fm),O(ps,pm),O(ps,va,new Map),O(ps,il,null);let Gb=ps;const OT=typeof PDFJSDev=="undefined"||!PDFJSDev.test("COMPONENTS")?null:{annotationEditorUIManager:null,annotationStorage:null,downloadManager:null,enableScripting:!1,fieldObjectsPromise:null,findController:null,hasJSActionsPromise:null,get linkService(){return new Sb}},BT=new Map([["canvasWrapper",0],["textLayer",1],["annotationLayer",2],["annotationEditorLayer",3],["xfaLayer",3]]);class RT{constructor(e){O(this,rl);O(this,nc);O(this,xo);O(this,Gu);O(this,ju);O(this,Ku);O(this,Zu);O(this,Ju);O(this,gm);O(this,mm);O(this,Xu);O(this,ko,ae.AnnotationMode.ENABLE_FORMS);O(this,Uu,!1);O(this,So,!1);O(this,Wu,!1);O(this,sl,null);O(this,ll,null);O(this,Vu,null);O(this,Yu,1);O(this,zu,1);O(this,Lo,null);O(this,ec,it.INITIAL);O(this,tc,ci.ENABLE);O(this,gs,{directDrawing:!0,initialOptionalContent:!0,regularAnnotations:!0});O(this,Ao,new WeakMap);O(this,ol,[null,null,null,null]);var s,l,o,r,c;const n=e.container,a=e.defaultViewport;this.id=e.id,this.renderingId="page"+this.id,z(this,sl,e.layerProperties||OT),this.pdfPage=null,this.pageLabel=null,this.rotation=0,this.scale=e.scale||_b,this.viewport=a,this.pdfPageRotate=a.rotation,this._optionalContentConfigPromise=e.optionalContentConfigPromise||null,z(this,tc,(s=e.textLayerMode)!=null?s:ci.ENABLE),z(this,ko,(l=e.annotationMode)!=null?l:ae.AnnotationMode.ENABLE_FORMS),this.imageResourcesPath=e.imageResourcesPath||"",this.maxCanvasPixels=(o=e.maxCanvasPixels)!=null?o:ge.get("maxCanvasPixels"),this.pageColors=e.pageColors||null,z(this,Uu,e.enableHWA||!1),this.eventBus=e.eventBus,this.renderingQueue=e.renderingQueue,this.l10n=e.l10n,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this.l10n||(this.l10n=new GenericL10n)),this.renderTask=null,this.resume=null,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this._isStandalone=!((r=this.renderingQueue)!=null&&r.hasViewer()),this._container=n),this._annotationCanvasMap=null,this.annotationLayer=null,this.annotationEditorLayer=null,this.textLayer=null,this.zoomLayer=null,this.xfaLayer=null,this.structTreeLayer=null,this.drawLayer=null;const i=document.createElement("div");if(i.className="page",i.setAttribute("data-page-number",this.id),i.setAttribute("role","region"),i.setAttribute("aria-label",window.siyuan.languages.thumbPageTitle.replace("{{page}}",this.id)),this.div=i,H(this,nc,Fm).call(this),n==null||n.append(i),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this._isStandalone){n==null||n.style.setProperty("--scale-factor",this.scale*ae.PixelsPerInch.PDF_TO_CSS_UNITS),(c=this.pageColors)!=null&&c.background&&(n==null||n.style.setProperty("--page-bg-color",this.pageColors.background));const{optionalContentConfigPromise:d}=e;d&&d.then(u=>{d===this._optionalContentConfigPromise&&(x(this,gs).initialOptionalContent=u.hasInitialVisibility)}),e.l10n||this.l10n.translate(this.div)}}get renderingState(){return x(this,ec)}set renderingState(e){if(e!==x(this,ec))switch(z(this,ec,e),x(this,ll)&&(clearTimeout(x(this,ll)),z(this,ll,null)),e){case it.PAUSED:this.div.classList.remove("loading");break;case it.RUNNING:this.div.classList.add("loadingIcon"),z(this,ll,setTimeout(()=>{this.div.classList.add("loading"),z(this,ll,null)},0));break;case it.INITIAL:case it.FINISHED:this.div.classList.remove("loadingIcon","loading");break}}setPdfPage(e){var a,i,s,l;(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this._isStandalone&&(((a=this.pageColors)==null?void 0:a.foreground)==="CanvasText"||((i=this.pageColors)==null?void 0:i.background)==="Canvas")&&((s=this._container)==null||s.style.setProperty("--hcm-highlight-filter",e.filterFactory.addHighlightHCMFilter("highlight","CanvasText","Canvas","HighlightText","Highlight")),(l=this._container)==null||l.style.setProperty("--hcm-highlight-selected-filter",e.filterFactory.addHighlightHCMFilter("highlight_selected","CanvasText","Canvas","HighlightText","Highlight"))),this.pdfPage=e,this.pdfPageRotate=e.rotate;const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:this.scale*ae.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:n}),H(this,nc,Fm).call(this),this.reset()}destroy(){var e;this.reset(),(e=this.pdfPage)==null||e.cleanup()}hasEditableAnnotations(){var e;return!!((e=this.annotationLayer)!=null&&e.hasEditableAnnotations())}get _textHighlighter(){return(0,ae.shadow)(this,"_textHighlighter",new IT({pageIndex:this.id-1,eventBus:this.eventBus,findController:x(this,sl).findController}))}_resetZoomLayer(e=!1){if(!this.zoomLayer)return;const n=this.zoomLayer.firstChild;x(this,Ao).delete(n),n.width=0,n.height=0,e&&this.zoomLayer.remove(),this.zoomLayer=null}reset({keepZoomLayer:e=!1,keepAnnotationLayer:n=!1,keepAnnotationEditorLayer:a=!1,keepXfaLayer:i=!1,keepTextLayer:s=!1}={}){var f,g,h,b,y;this.cancelRendering({keepAnnotationLayer:n,keepAnnotationEditorLayer:a,keepXfaLayer:i,keepTextLayer:s}),this.renderingState=it.INITIAL;const l=this.div,o=l.childNodes,r=e&&this.zoomLayer||null,c=n&&((f=this.annotationLayer)==null?void 0:f.div)||null,d=a&&((g=this.annotationEditorLayer)==null?void 0:g.div)||null,u=i&&((h=this.xfaLayer)==null?void 0:h.div)||null,m=s&&((b=this.textLayer)==null?void 0:b.div)||null;for(let w=o.length-1;w>=0;w--){const E=o[w];switch(E){case r:case c:case d:case u:case m:continue}E.remove();const C=x(this,ol).indexOf(E);C>=0&&(x(this,ol)[C]=null)}l.removeAttribute("data-loaded"),c&&this.annotationLayer.hide(),d&&this.annotationEditorLayer.hide(),u&&this.xfaLayer.hide(),m&&this.textLayer.hide(),(y=this.structTreeLayer)==null||y.hide(),r||(this.canvas&&(x(this,Ao).delete(this.canvas),this.canvas.width=0,this.canvas.height=0,delete this.canvas),this._resetZoomLayer())}toggleEditingMode(e){this.hasEditableAnnotations()&&(z(this,Wu,e),this.reset({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0}))}update({scale:e=0,rotation:n=null,optionalContentConfigPromise:a=null,drawingDelay:i=-1}){var l;this.scale=e||this.scale,typeof n=="number"&&(this.rotation=n),a instanceof Promise&&(this._optionalContentConfigPromise=a,a.then(o=>{a===this._optionalContentConfigPromise&&(x(this,gs).initialOptionalContent=o.hasInitialVisibility)})),x(this,gs).directDrawing=!0;const s=(this.rotation+this.pdfPageRotate)%360;if(this.viewport=this.viewport.clone({scale:this.scale*ae.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:s}),H(this,nc,Fm).call(this),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this._isStandalone&&((l=this._container)==null||l.style.setProperty("--scale-factor",this.viewport.scale)),this.canvas){let o=!1;if(x(this,So)){if((typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.maxCanvasPixels===0)o=!0;else if(this.maxCanvasPixels>0){const{width:c,height:d}=this.viewport,{sx:u,sy:m}=this.outputScale;o=(Math.floor(c)*u|0)*(Math.floor(d)*m|0)>this.maxCanvasPixels}}const r=i>=0&&i<1e3;if(r||o){if(r&&!o&&this.renderingState!==it.FINISHED&&(this.cancelRendering({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0,cancelExtraDelay:i}),this.renderingState=it.FINISHED,x(this,gs).directDrawing=!1),this.cssTransform({target:this.canvas,redrawAnnotationLayer:!0,redrawAnnotationEditorLayer:!0,redrawXfaLayer:!0,redrawTextLayer:!r,hideTextLayer:r}),r)return;this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:x(this,Lo)});return}!this.zoomLayer&&!this.canvas.hidden&&(this.zoomLayer=this.canvas.parentNode,this.zoomLayer.style.position="absolute")}this.zoomLayer&&this.cssTransform({target:this.zoomLayer.firstChild}),this.reset({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0})}cancelRendering({keepAnnotationLayer:e=!1,keepAnnotationEditorLayer:n=!1,keepXfaLayer:a=!1,keepTextLayer:i=!1,cancelExtraDelay:s=0}={}){var l;this.renderTask&&(this.renderTask.cancel(s),this.renderTask=null),this.resume=null,this.textLayer&&(!i||!this.textLayer.div)&&(this.textLayer.cancel(),this.textLayer=null),this.annotationLayer&&(!e||!this.annotationLayer.div)&&(this.annotationLayer.cancel(),this.annotationLayer=null,this._annotationCanvasMap=null),this.structTreeLayer&&!this.textLayer&&(this.structTreeLayer=null),this.annotationEditorLayer&&(!n||!this.annotationEditorLayer.div)&&(this.drawLayer&&(this.drawLayer.cancel(),this.drawLayer=null),this.annotationEditorLayer.cancel(),this.annotationEditorLayer=null),this.xfaLayer&&(!a||!this.xfaLayer.div)&&(this.xfaLayer.cancel(),this.xfaLayer=null,(l=this._textHighlighter)==null||l.disable())}cssTransform({target:e,redrawAnnotationLayer:n=!1,redrawAnnotationEditorLayer:a=!1,redrawXfaLayer:i=!1,redrawTextLayer:s=!1,hideTextLayer:l=!1}){var r;if((typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"))&&!(e instanceof HTMLCanvasElement))throw new Error("Expected `target` to be a canvas.");if(!e.hasAttribute("zooming")){e.setAttribute("zooming",!0);const{style:c}=e;c.width=c.height=""}const o=x(this,Ao).get(e);if(this.viewport!==o){const c=this.viewport.rotation-o.rotation,d=Math.abs(c);let u=1,m=1;if(d===90||d===270){const{width:f,height:g}=this.viewport;u=g/f,m=f/g}e.style.transform=`rotate(${c}deg) scale(${u}, ${m})`}n&&this.annotationLayer&&H(this,Gu,v_).call(this),a&&this.annotationEditorLayer&&(this.drawLayer&&H(this,Ku,k_).call(this),H(this,ju,E_).call(this)),i&&this.xfaLayer&&H(this,Zu,S_).call(this),this.textLayer&&(l?(this.textLayer.hide(),(r=this.structTreeLayer)==null||r.hide()):s&&H(this,Ju,L_).call(this))}get width(){return this.viewport.width}get height(){return this.viewport.height}getPagePoint(e,n){return this.viewport.convertToPdfPoint(e,n)}draw(){return se(this,null,function*(){this.renderingState!==it.INITIAL&&(console.error("Must be in new state before drawing"),this.reset());const{div:e,l10n:n,pageColors:a,pdfPage:i,viewport:s}=this;if(!i)throw this.renderingState=it.FINISHED,new Error("pdfPage is not loaded");this.renderingState=it.RUNNING;const l=document.createElement("div");if(l.classList.add("canvasWrapper"),H(this,rl,gc).call(this,l,"canvasWrapper"),!this.textLayer&&x(this,tc)!==ci.DISABLE&&!i.isPureXfa&&(this._accessibilityManager||(this._accessibilityManager=new Vb),this.textLayer=new Gb({pdfPage:i,highlighter:this._textHighlighter,accessibilityManager:this._accessibilityManager,enablePermissions:x(this,tc)===ci.ENABLE_PERMISSIONS,onAppend:v=>{this.l10n.pause(),H(this,rl,gc).call(this,v,"textLayer"),this.l10n.resume()}})),!this.annotationLayer&&x(this,ko)!==ae.AnnotationMode.DISABLE){const{annotationStorage:v,annotationEditorUIManager:S,downloadManager:L,enableScripting:D,fieldObjectsPromise:I,hasJSActionsPromise:q,linkService:Z}=x(this,sl);this._annotationCanvasMap||(this._annotationCanvasMap=new Map),this.annotationLayer=new xT({pdfPage:i,annotationStorage:v,imageResourcesPath:this.imageResourcesPath,renderForms:x(this,ko)===ae.AnnotationMode.ENABLE_FORMS,linkService:Z,downloadManager:L,enableScripting:D,hasJSActionsPromise:q,fieldObjectsPromise:I,annotationCanvasMap:this._annotationCanvasMap,accessibilityManager:this._accessibilityManager,annotationEditorUIManager:S,onAppend:R=>{H(this,rl,gc).call(this,R,"annotationLayer")}})}const o=v=>{if(m==null||m(!1),this.renderingQueue&&!this.renderingQueue.isHighestPriority(this)){this.renderingState=it.PAUSED,this.resume=()=>{this.renderingState=it.RUNNING,v()};return}v()},{width:r,height:c}=s,d=document.createElement("canvas");d.setAttribute("role","presentation"),d.hidden=!0;const u=!!(a!=null&&a.background&&(a!=null&&a.foreground));let m=v=>{(!u||v)&&(d.hidden=!1,m=null)};l.append(d),this.canvas=d;const f=d.getContext("2d",{alpha:!1,willReadFrequently:!x(this,Uu)}),g=this.outputScale=new ae.OutputScale;if((typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.maxCanvasPixels===0){const v=1/this.scale;g.sx*=v,g.sy*=v,z(this,So,!0)}else if(this.maxCanvasPixels>0){const v=r*c,S=Math.sqrt(this.maxCanvasPixels/v);g.sx>S||g.sy>S?(g.sx=S,g.sy=S,z(this,So,!0)):z(this,So,!1)}const h=ZE(g.sx),b=ZE(g.sy),y=d.width=Np(Op(r*g.sx),h[0]),w=d.height=Np(Op(c*g.sy),b[0]),E=Np(Op(r),h[1]),C=Np(Op(c),b[1]);g.sx=y/E,g.sy=w/C,x(this,Yu)!==h[1]&&(e.style.setProperty("--scale-round-x",`${h[1]}px`),z(this,Yu,h[1])),x(this,zu)!==b[1]&&(e.style.setProperty("--scale-round-y",`${b[1]}px`),z(this,zu,b[1])),x(this,Ao).set(d,s);const $=g.scaled?[g.sx,0,0,g.sy,0,0]:null,M={canvasContext:f,transform:$,viewport:s,annotationMode:x(this,ko),optionalContentConfigPromise:this._optionalContentConfigPromise,annotationCanvasMap:this._annotationCanvasMap,pageColors:a,isEditing:x(this,Wu)},k=this.renderTask=i.render(M);k.onContinue=o;const _=k.promise.then(()=>se(this,null,function*(){var S;m==null||m(!0),yield H(this,Xu,A_).call(this,k),this.structTreeLayer||(this.structTreeLayer=new DT(i,s.rawDims)),H(this,Ju,L_).call(this),this.annotationLayer&&(yield H(this,Gu,v_).call(this));const{annotationEditorUIManager:v}=x(this,sl);v&&(this.drawLayer||(this.drawLayer=new CT({pageIndex:this.id})),yield H(this,Ku,k_).call(this),this.drawLayer.setParent(l),this.annotationEditorLayer||(this.annotationEditorLayer=new AT({uiManager:v,pdfPage:i,l10n:n,structTreeLayer:this.structTreeLayer,accessibilityManager:this._accessibilityManager,annotationLayer:(S=this.annotationLayer)==null?void 0:S.annotationLayer,textLayer:this.textLayer,drawLayer:this.drawLayer.getDrawLayer(),onAppend:L=>{H(this,rl,gc).call(this,L,"annotationEditorLayer")}})),H(this,ju,E_).call(this))}),v=>(v instanceof ae.RenderingCancelledException||m==null||m(!0),H(this,Xu,A_).call(this,k,v)));if(i.isPureXfa){if(!this.xfaLayer){const{annotationStorage:v,linkService:S}=x(this,sl);this.xfaLayer=new bk({pdfPage:i,annotationStorage:v,linkService:S})}H(this,Zu,S_).call(this)}return e.setAttribute("data-loaded",!0),this.eventBus.dispatch("pagerender",{source:this,pageNumber:this.id}),_})}setPageLabel(e){var n;this.pageLabel=typeof e=="string"?e:null,this.div.setAttribute("data-l10n-args",JSON.stringify({page:(n=this.pageLabel)!=null?n:this.id})),this.pageLabel!==null?this.div.setAttribute("data-page-label",this.pageLabel):this.div.removeAttribute("data-page-label")}get thumbnailCanvas(){const{directDrawing:e,initialOptionalContent:n,regularAnnotations:a}=x(this,gs);return e&&n&&a?this.canvas:null}}ko=new WeakMap,Uu=new WeakMap,So=new WeakMap,Wu=new WeakMap,sl=new WeakMap,ll=new WeakMap,Vu=new WeakMap,Yu=new WeakMap,zu=new WeakMap,Lo=new WeakMap,ec=new WeakMap,tc=new WeakMap,gs=new WeakMap,Ao=new WeakMap,ol=new WeakMap,rl=new WeakSet,gc=function(e,n){const a=BT.get(n),i=x(this,ol)[a];if(x(this,ol)[a]=e,i){i.replaceWith(e);return}for(let s=a-1;s>=0;s--){const l=x(this,ol)[s];if(l){l.after(e);return}}this.div.prepend(e)},nc=new WeakSet,Fm=function(){const{viewport:e}=this;if(this.pdfPage){if(x(this,Vu)===e.rotation)return;z(this,Vu,e.rotation)}(0,ae.setLayerDimensions)(this.div,e,!0,!1)},xo=new WeakSet,xf=function(e,n){this.eventBus.dispatch(e,{source:this,pageNumber:this.id,error:n})},Gu=new WeakSet,v_=function(){return se(this,null,function*(){let e=null;try{yield this.annotationLayer.render(this.viewport,{structTreeLayer:this.structTreeLayer},"display")}catch(n){console.error(`#renderAnnotationLayer: "${n}".`),e=n}finally{H(this,xo,xf).call(this,"annotationlayerrendered",e)}})},ju=new WeakSet,E_=function(){return se(this,null,function*(){let e=null;try{yield this.annotationEditorLayer.render(this.viewport,"display")}catch(n){console.error(`#renderAnnotationEditorLayer: "${n}".`),e=n}finally{H(this,xo,xf).call(this,"annotationeditorlayerrendered",e)}})},Ku=new WeakSet,k_=function(){return se(this,null,function*(){try{yield this.drawLayer.render("display")}catch(e){console.error(`#renderDrawLayer: "${e}".`)}})},Zu=new WeakSet,S_=function(){return se(this,null,function*(){var n;let e=null;try{const a=yield this.xfaLayer.render(this.viewport,"display");a!=null&&a.textDivs&&this._textHighlighter&&H(this,mm,JL).call(this,a.textDivs)}catch(a){console.error(`#renderXfaLayer: "${a}".`),e=a}finally{(n=this.xfaLayer)!=null&&n.div&&(this.l10n.pause(),H(this,rl,gc).call(this,this.xfaLayer.div,"xfaLayer"),this.l10n.resume()),H(this,xo,xf).call(this,"xfalayerrendered",e)}})},Ju=new WeakSet,L_=function(){return se(this,null,function*(){if(!this.textLayer)return;let e=null;yield this.textLayer.render(this.viewport),H(this,xo,xf).call(this,"textlayerrendered",e),H(this,gm,ZL).call(this)})},gm=new WeakSet,ZL=function(){return se(this,null,function*(){var n,a,i;if(!this.textLayer)return;const e=yield(n=this.structTreeLayer)==null?void 0:n.render();e&&(this.l10n.pause(),(a=this.structTreeLayer)==null||a.addElementsToTextLayer(),this.canvas&&e.parentNode!==this.canvas&&this.canvas.append(e),this.l10n.resume()),(i=this.structTreeLayer)==null||i.show()})},mm=new WeakSet,JL=function(e){return se(this,null,function*(){const n=yield this.pdfPage.getTextContent(),a=[];for(const i of n.items)a.push(i.str);this._textHighlighter.setTextMapping(e,a),this._textHighlighter.enable()})},Xu=new WeakSet,A_=function(e,n=null){return se(this,null,function*(){if(e===this.renderTask&&(this.renderTask=null),n instanceof ae.RenderingCancelledException){z(this,Lo,null);return}if(z(this,Lo,n),this.renderingState=it.FINISHED,this._resetZoomLayer(!0),x(this,gs).regularAnnotations=!e.separateAnnots,this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!1,timestamp:performance.now(),error:x(this,Lo)}),n)throw n})};const Hk=10,cd={FORCE_SCROLL_MODE_PAGE:1e4,FORCE_LAZY_PAGE_INIT:5e3,PAUSE_EAGER_PAGE_INIT:250};function Ok(t){return Object.values(ae.AnnotationEditorType).includes(t)&&t!==ae.AnnotationEditorType.DISABLE}class qT{constructor(e){O(this,Qu);O(this,ms,new Set);O(this,Co,0);z(this,Co,e)}push(e){const n=x(this,ms);n.has(e)&&n.delete(e),n.add(e),n.size>x(this,Co)&&H(this,Qu,x_).call(this)}resize(e,n=null){z(this,Co,e);const a=x(this,ms);if(n){const i=a.size;let s=1;for(const l of a)if(n.has(l.id)&&(a.delete(l),a.add(l)),++s>i)break}for(;a.size>x(this,Co);)H(this,Qu,x_).call(this)}has(e){return x(this,ms).has(e)}[Symbol.iterator](){return x(this,ms).keys()}}ms=new WeakMap,Co=new WeakMap,Qu=new WeakSet,x_=function(){const e=x(this,ms).keys().next().value;e==null||e.destroy(),x(this,ms).delete(e)};class FT{constructor(e){O(this,hm);O(this,bm);O(this,ym);O(this,Po);O(this,oc);O(this,_m);O(this,df);O(this,wm);O(this,Fi);O(this,uf);O(this,vm);O(this,Em);O(this,km);O(this,ff);O(this,Sm);O(this,rc);O(this,cl,null);O(this,ef,null);O(this,tf,null);O(this,qi,ae.AnnotationEditorType.NONE);O(this,Ia,null);O(this,To,ae.AnnotationMode.ENABLE_FORMS);O(this,nf,null);O(this,af,!1);O(this,sf,!1);O(this,lf,!1);O(this,of,!1);O(this,rf,!1);O(this,dl,null);O(this,Do,null);O(this,Io,null);O(this,$o,null);O(this,ac,!1);O(this,ul,null);O(this,ic,!1);O(this,cf,0);O(this,sc,new ResizeObserver(H(this,Sm,lA).bind(this)));O(this,Mo,null);O(this,fl,null);O(this,lc,ci.ENABLE);var a,i,s,l,o;if(this.container=e.container,this.viewer=e.viewer||e.container.firstElementChild,typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){if(((a=this.container)==null?void 0:a.tagName)!=="DIV"||((i=this.viewer)==null?void 0:i.tagName)!=="DIV")throw new Error("Invalid `container` and/or `viewer` option.");if(this.container.offsetParent&&getComputedStyle(this.container).position!=="absolute")throw new Error("The `container` must be absolutely positioned.")}x(this,sc).observe(this.container),this.eventBus=e.eventBus,this.linkService=e.linkService||new Sb,this.downloadManager=e.downloadManager||null,this.findController=e.findController||null,z(this,ef,e.altTextManager||null),this.findController&&(this.findController.onIsPageVisible=r=>this._getVisiblePages().ids.has(r)),this._scriptingManager=e.scriptingManager||null,z(this,lc,(s=e.textLayerMode)!=null?s:ci.ENABLE),z(this,To,(l=e.annotationMode)!=null?l:ae.AnnotationMode.ENABLE_FORMS),z(this,qi,(o=e.annotationEditorMode)!=null?o:ae.AnnotationEditorType.NONE),z(this,tf,e.annotationEditorHighlightColors||null),z(this,sf,e.enableHighlightFloatingButton===!0),z(this,of,e.enableUpdatedAddImage===!0),z(this,rf,e.enableNewAltTextWhenAddingImage===!0),this.imageResourcesPath=e.imageResourcesPath||"",this.enablePrintAutoRotate=e.enablePrintAutoRotate||!1,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this.removePageBorders=e.removePageBorders||!1),this.maxCanvasPixels=e.maxCanvasPixels,this.l10n=e.l10n,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this.l10n||(this.l10n=new GenericL10n)),z(this,lf,e.enablePermissions||!1),this.pageColors=e.pageColors||null,z(this,Do,e.mlManager||null),z(this,af,e.enableHWA||!1),this.defaultRenderingQueue=!e.renderingQueue,(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.defaultRenderingQueue?(this.renderingQueue=new Ek,this.renderingQueue.setViewer(this)):this.renderingQueue=e.renderingQueue;const{abortSignal:n}=e;n==null||n.addEventListener("abort",()=>{x(this,sc).disconnect(),z(this,sc,null)},{once:!0}),this.scroll=jE(this.container,this._scrollUpdate.bind(this),n),this.presentationModeState=kn.UNKNOWN,this._resetView(),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&this.viewer.classList.add("removePageBorders"),H(this,ff,D_).call(this),this.eventBus._on("thumbnailrendered",({pageNumber:r,pdfPage:c})=>{const d=this._pages[r-1];x(this,cl).has(d)||c==null||c.cleanup()}),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&!e.l10n&&this.l10n.translate(this.container)}get pagesCount(){return this._pages.length}getPageView(e){return this._pages[e]}getCachedPageViews(){return new Set(x(this,cl))}get pageViewsReady(){return this._pages.every(e=>e==null?void 0:e.pdfPage)}get renderForms(){return x(this,To)===ae.AnnotationMode.ENABLE_FORMS}get enableScripting(){return!!this._scriptingManager}get currentPageNumber(){return this._currentPageNumber}set currentPageNumber(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&(this._setCurrentPageNumber(e,!0)||console.error(`currentPageNumber: "${e}" is not a valid page.`))}_setCurrentPageNumber(e,n=!1){var i,s;if(this._currentPageNumber===e)return n&&H(this,uf,T_).call(this),!0;if(!(0<e&&e<=this.pagesCount))return!1;const a=this._currentPageNumber;return this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",{source:this,pageNumber:e,pageLabel:(s=(i=this._pageLabels)==null?void 0:i[e-1])!=null?s:null,previous:a}),n&&H(this,uf,T_).call(this),!0}get currentPageLabel(){var e,n;return(n=(e=this._pageLabels)==null?void 0:e[this._currentPageNumber-1])!=null?n:null}set currentPageLabel(e){if(!this.pdfDocument)return;let n=e|0;if(this._pageLabels){const a=this._pageLabels.indexOf(e);a>=0&&(n=a+1)}this._setCurrentPageNumber(n,!0)||console.error(`currentPageLabel: "${e}" is not a valid page.`)}get currentScale(){return this._currentScale!==wb?this._currentScale:_b}set currentScale(e){if(isNaN(e))throw new Error("Invalid numeric scale.");this.pdfDocument&&H(this,Fi,hl).call(this,e,{noScroll:!1})}get currentScaleValue(){return this._currentScaleValue}set currentScaleValue(e){this.pdfDocument&&H(this,Fi,hl).call(this,e,{noScroll:!1})}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!Hp(e))throw new Error("Invalid pages rotation angle.");if(!this.pdfDocument||(e%=360,e<0&&(e+=360),this._pagesRotation===e))return;this._pagesRotation=e;const n=this._currentPageNumber;this.refresh(!0,{rotation:e}),this._currentScaleValue&&H(this,Fi,hl).call(this,this._currentScaleValue,{noScroll:!0}),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:n}),this.defaultRenderingQueue&&this.update()}get firstPagePromise(){return this.pdfDocument?this._firstPageCapability.promise:null}get onePageRendered(){return this.pdfDocument?this._onePageRenderedCapability.promise:null}get pagesPromise(){return this.pdfDocument?this._pagesCapability.promise:null}get _layerProperties(){const e=this;return(0,ae.shadow)(this,"_layerProperties",{get annotationEditorUIManager(){return x(e,Ia)},get annotationStorage(){var n;return(n=e.pdfDocument)==null?void 0:n.annotationStorage},get downloadManager(){return e.downloadManager},get enableScripting(){return!!e._scriptingManager},get fieldObjectsPromise(){var n;return(n=e.pdfDocument)==null?void 0:n.getFieldObjects()},get findController(){return e.findController},get hasJSActionsPromise(){var n;return(n=e.pdfDocument)==null?void 0:n.hasJSActions()},get linkService(){return e.linkService}})}getAllText(){return se(this,null,function*(){const e=[],n=[];for(let a=1,i=this.pdfDocument.numPages;a<=i;++a){if(x(this,ic))return null;n.length=0;const s=yield this.pdfDocument.getPage(a),{items:l}=yield s.getTextContent();for(const o of l)o.str&&n.push(o.str),o.hasEOL&&n.push(`
`);e.push(dr(n.join("")))}return e.join(`
`)})}setDocument(e){var m,f,g;if(this.pdfDocument&&(this.eventBus.dispatch("pagesdestroy",{source:this}),this._cancelRendering(),this._resetView(),(m=this.findController)==null||m.setDocument(null),(f=this._scriptingManager)==null||f.setDocument(null),(g=x(this,Ia))==null||g.destroy(),z(this,Ia,null)),this.pdfDocument=e,!e)return;const n=e.numPages,a=e.getPage(1),i=e.getOptionalContentConfig({intent:"display"}),s=x(this,lf)?e.getPermissions():Promise.resolve(),{eventBus:l,pageColors:o,viewer:r}=this;z(this,dl,new AbortController);const{signal:c}=x(this,dl);if(n>cd.FORCE_SCROLL_MODE_PAGE){console.warn("Forcing PAGE-scrolling for performance reasons, given the length of the document.");const h=this._scrollMode=Ve.PAGE;l.dispatch("scrollmodechanged",{source:this,mode:h})}this._pagesCapability.promise.then(()=>{l.dispatch("pagesloaded",{source:this,pagesCount:n})},()=>{});const d=h=>{const b=this._pages[h.pageNumber-1];b&&x(this,cl).push(b)};l._on("pagerender",d,{signal:c});const u=h=>{h.cssTransform||(this._onePageRenderedCapability.resolve({timestamp:h.timestamp}),l._off("pagerendered",u))};l._on("pagerendered",u,{signal:c}),Promise.all([a,s]).then(([h,b])=>{var k,_;if(e!==this.pdfDocument)return;this._firstPageCapability.resolve(h),this._optionalContentConfigPromise=i;const{annotationEditorMode:y,annotationMode:w,textLayerMode:E}=H(this,hm,XL).call(this,b);if(E!==ci.DISABLE){const v=z(this,ul,document.createElement("div"));v.id="hiddenCopyElement",r.before(v)}if((typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")||typeof AbortSignal.any=="function")&&y!==ae.AnnotationEditorType.DISABLE){const v=y;e.isPureXfa?console.warn("Warning: XFA-editing is not implemented."):Ok(v)?(z(this,Ia,new ae.AnnotationEditorUIManager(this.container,r,x(this,ef),l,e,o,x(this,tf),x(this,sf),x(this,of),x(this,rf),x(this,Do))),l.dispatch("annotationeditoruimanager",{source:this,uiManager:x(this,Ia)}),v!==ae.AnnotationEditorType.NONE&&(v===ae.AnnotationEditorType.STAMP&&((k=x(this,Do))==null||k.loadModel("altText")),x(this,Ia).updateMode(v))):console.error(`Invalid AnnotationEditor mode: ${v}`)}const C=this._scrollMode===Ve.PAGE?null:r,$=this.currentScale,M=h.getViewport({scale:$*ae.PixelsPerInch.PDF_TO_CSS_UNITS});r.style.setProperty("--scale-factor",M.scale),o!=null&&o.background&&r.style.setProperty("--page-bg-color",o.background),((o==null?void 0:o.foreground)==="CanvasText"||(o==null?void 0:o.background)==="Canvas")&&(r.style.setProperty("--hcm-highlight-filter",e.filterFactory.addHighlightHCMFilter("highlight","CanvasText","Canvas","HighlightText","Highlight")),r.style.setProperty("--hcm-highlight-selected-filter",e.filterFactory.addHighlightHCMFilter("highlight_selected","CanvasText","Canvas","HighlightText","ButtonText")));for(let v=1;v<=n;++v){const S=new RT({container:C,eventBus:l,id:v,scale:$,defaultViewport:M.clone(),optionalContentConfigPromise:i,renderingQueue:this.renderingQueue,textLayerMode:E,annotationMode:w,imageResourcesPath:this.imageResourcesPath,maxCanvasPixels:this.maxCanvasPixels,pageColors:o,l10n:this.l10n,layerProperties:this._layerProperties,enableHWA:x(this,af)});this._pages.push(S)}(_=this._pages[0])==null||_.setPdfPage(h),this._scrollMode===Ve.PAGE?H(this,Po,Cf).call(this):this._spreadMode!==Bt.NONE&&this._updateSpreadMode(),H(this,bm,QL).call(this,c).then(()=>se(this,null,function*(){var S,L;if(e!==this.pdfDocument)return;if((S=this.findController)==null||S.setDocument(e),(L=this._scriptingManager)==null||L.setDocument(e),x(this,ul)&&document.addEventListener("copy",H(this,ym,eA).bind(this,E),{signal:c}),x(this,Ia)&&l.dispatch("annotationeditormodechanged",{source:this,mode:x(this,qi)}),e.loadingParams.disableAutoFetch||n>cd.FORCE_LAZY_PAGE_INIT){this._pagesCapability.resolve();return}let v=n-1;if(v<=0){this._pagesCapability.resolve();return}for(let D=2;D<=n;++D){const I=e.getPage(D).then(q=>{const Z=this._pages[D-1];Z.pdfPage||Z.setPdfPage(q),--v===0&&this._pagesCapability.resolve()},q=>{console.error(`Unable to get page ${D} to initialize viewer`,q),--v===0&&this._pagesCapability.resolve()});D%cd.PAUSE_EAGER_PAGE_INIT===0&&(yield I)}})),l.dispatch("pagesinit",{source:this}),e.getMetadata().then(({info:v})=>{e===this.pdfDocument&&v.Language&&(r.lang=v.Language)}),this.defaultRenderingQueue&&this.update()}).catch(h=>{console.error("Unable to initialize viewer",h),this._pagesCapability.reject(h)})}setPageLabels(e){var n,a;if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let i=0,s=this._pages.length;i<s;i++)this._pages[i].setPageLabel((a=(n=this._pageLabels)==null?void 0:n[i])!=null?a:null)}}_resetView(){var e,n;this._pages=[],this._currentPageNumber=1,this._currentScale=wb,this._currentScaleValue=null,this._pageLabels=null,z(this,cl,new qT(Hk)),this._location=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._firstPageCapability=Promise.withResolvers(),this._onePageRenderedCapability=Promise.withResolvers(),this._pagesCapability=Promise.withResolvers(),this._scrollMode=Ve.VERTICAL,this._previousScrollMode=Ve.UNKNOWN,this._spreadMode=Bt.NONE,z(this,Mo,{previousPageNumber:1,scrollDown:!0,pages:[]}),(e=x(this,dl))==null||e.abort(),z(this,dl,null),this.viewer.textContent="",this._updateScrollMode(),this.viewer.removeAttribute("lang"),(n=x(this,ul))==null||n.remove(),z(this,ul,null),H(this,rc,Wm).call(this)}_scrollUpdate(){this.pagesCount!==0&&this.update()}pageLabelToPageNumber(e){if(!this._pageLabels)return null;const n=this._pageLabels.indexOf(e);return n<0?null:n+1}scrollPageIntoView({pageNumber:e,destArray:n=null,allowNegativeOffset:a=!1,ignoreDestinationZoom:i=!1}){if(!this.pdfDocument)return;const s=Number.isInteger(e)&&this._pages[e-1];if(!s){console.error(`scrollPageIntoView: "${e}" is not a valid pageNumber parameter.`);return}if(this.isInPresentationMode||!n){this._setCurrentPageNumber(e,!0);return}let l=0,o=0,r=0,c=0,d,u;const m=s.rotation%180!==0,f=(m?s.height:s.width)/s.scale/ae.PixelsPerInch.PDF_TO_CSS_UNITS,g=(m?s.width:s.height)/s.scale/ae.PixelsPerInch.PDF_TO_CSS_UNITS;let h=0;switch(n[1].name){case"XYZ":l=n[2],o=n[3],h=n[4],l=l!==null?l:0,o=o!==null?o:g;break;case"Fit":case"FitB":h="page-fit";break;case"FitH":case"FitBH":o=n[2],h="page-width",o===null&&this._location?(l=this._location.left,o=this._location.top):(typeof o!="number"||o<0)&&(o=g);break;case"FitV":case"FitBV":l=n[2],r=f,c=g,h="page-height";break;case"FitR":l=n[2],o=n[3],r=n[4]-l,c=n[5]-o;let E=zE,C=GE;(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&(E=C=0),d=(this.container.clientWidth-E)/r/ae.PixelsPerInch.PDF_TO_CSS_UNITS,u=(this.container.clientHeight-C)/c/ae.PixelsPerInch.PDF_TO_CSS_UNITS,h=Math.min(Math.abs(d),Math.abs(u));break;default:console.error(`scrollPageIntoView: "${n[1].name}" is not a valid destination type.`);return}if(i||(h&&h!==this._currentScale?this.currentScaleValue=h:this._currentScale===wb&&(this.currentScaleValue=sd)),h==="page-fit"&&!n[4]){H(this,oc,Um).call(this,s);return}const b=[s.viewport.convertToViewportPoint(l,o),s.viewport.convertToViewportPoint(l+r,o+c)];let y=Math.min(b[0][0],b[1][0]),w=Math.min(b[0][1],b[1][1]);a||(y=Math.max(y,0),w=Math.max(w,0)),H(this,oc,Um).call(this,s,{left:y,top:w})}_updateLocation(e){const n=this._currentScale,a=this._currentScaleValue,i=parseFloat(a)===n?Math.round(n*1e4)/100:a,s=e.id,l=this._pages[s-1],o=this.container,r=l.getPagePoint(o.scrollLeft-e.x,o.scrollTop-e.y),c=Math.round(r[0]),d=Math.round(r[1]);let u=`#page=${s}`;this.isInPresentationMode||(u+=`&zoom=${i},${c},${d}`),this._location={pageNumber:s,scale:i,top:d,left:c,rotation:this._pagesRotation,pdfOpenParams:u}}update(){const e=this._getVisiblePages(),n=e.views,a=n.length;if(a===0)return;const i=Math.max(Hk,2*a+1);x(this,cl).resize(i,e.ids),this.renderingQueue.renderHighestPriority(e);const s=this._spreadMode===Bt.NONE&&(this._scrollMode===Ve.PAGE||this._scrollMode===Ve.VERTICAL),l=this._currentPageNumber;let o=!1;for(const r of n){if(r.percent<100)break;if(r.id===l&&s){o=!0;break}}this._setCurrentPageNumber(o?l:n[0].id),this._updateLocation(e.first),this.eventBus.dispatch("updateviewarea",{source:this,location:this._location})}containsElement(e){return this.container.contains(e)}focus(){this.container.focus(),this.container.parentElement.querySelector("#sidebarToggleButton").focus()}get _isContainerRtl(){return getComputedStyle(this.container).direction==="rtl"}get isInPresentationMode(){return this.presentationModeState===kn.FULLSCREEN}get isChangingPresentationMode(){return this.presentationModeState===kn.CHANGING}get isHorizontalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollWidth>this.container.clientWidth}get isVerticalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollHeight>this.container.clientHeight}_getVisiblePages(){const e=this._scrollMode===Ve.PAGE?x(this,Mo).pages:this._pages,n=this._scrollMode===Ve.HORIZONTAL,a=n&&this._isContainerRtl;return JE({scrollEl:this.container,views:e,sortByVisibility:!0,horizontal:n,rtl:a})}cleanup(){for(const e of this._pages)e.renderingState!==it.FINISHED&&e.reset()}_cancelRendering(){for(const e of this._pages)e.cancelRendering()}forceRendering(e){const n=e||this._getVisiblePages(),a=H(this,km,sA).call(this,n),i=this._spreadMode!==Bt.NONE&&this._scrollMode!==Ve.HORIZONTAL,s=this.renderingQueue.getHighestPriority(n,this._pages,a,i);return s?(H(this,Em,iA).call(this,s).then(()=>{this.renderingQueue.renderView(s)}),!0):!1}get hasEqualPageSizes(){const e=this._pages[0];for(let n=1,a=this._pages.length;n<a;++n){const i=this._pages[n];if(i.width!==e.width||i.height!==e.height)return!1}return!0}getPagesOverview(){let e;return this._pages.map(n=>{const a=n.pdfPage.getViewport({scale:1}),i=Eb(a);if(e===void 0)e=i;else if(this.enablePrintAutoRotate&&i!==e)return{width:a.height,height:a.width,rotation:(a.rotation-90)%360};return{width:a.width,height:a.height,rotation:a.rotation}})}get optionalContentConfigPromise(){return this.pdfDocument?this._optionalContentConfigPromise?this._optionalContentConfigPromise:(console.error("optionalContentConfigPromise: Not initialized yet."),this.pdfDocument.getOptionalContentConfig({intent:"display"})):Promise.resolve(null)}set optionalContentConfigPromise(e){if(!(e instanceof Promise))throw new Error(`Invalid optionalContentConfigPromise: ${e}`);this.pdfDocument&&this._optionalContentConfigPromise&&(this._optionalContentConfigPromise=e,this.refresh(!1,{optionalContentConfigPromise:e}),this.eventBus.dispatch("optionalcontentconfigchanged",{source:this,promise:e}))}get scrollMode(){return this._scrollMode}set scrollMode(e){if(!(typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))&&this._scrollMode!==e){if(!QE(e))throw new Error(`Invalid scroll mode: ${e}`);this.pagesCount>cd.FORCE_SCROLL_MODE_PAGE||(this._previousScrollMode=this._scrollMode,this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber))}}_updateScrollMode(e=null){const n=this._scrollMode,a=this.viewer;a.classList.toggle("scrollHorizontal",n===Ve.HORIZONTAL),a.classList.toggle("scrollWrapped",n===Ve.WRAPPED),!(!this.pdfDocument||!e)&&(n===Ve.PAGE?H(this,Po,Cf).call(this):this._previousScrollMode===Ve.PAGE&&this._updateSpreadMode(),this._currentScaleValue&&isNaN(this._currentScaleValue)&&H(this,Fi,hl).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}get spreadMode(){return this._spreadMode}set spreadMode(e){if(!(typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))&&this._spreadMode!==e){if(!ek(e))throw new Error(`Invalid spread mode: ${e}`);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}_updateSpreadMode(e=null){if(!this.pdfDocument)return;const n=this.viewer,a=this._pages;if(this._scrollMode===Ve.PAGE)H(this,Po,Cf).call(this);else if(n.textContent="",this._spreadMode===Bt.NONE)for(const i of this._pages)n.append(i.div);else{const i=this._spreadMode-1;let s=null;for(let l=0,o=a.length;l<o;++l)s===null?(s=document.createElement("div"),s.className="spread",n.append(s)):l%2===i&&(s=s.cloneNode(!1),n.append(s)),s.append(a[l].div)}e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&H(this,Fi,hl).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}_getPageAdvance(e,n=!1){switch(this._scrollMode){case Ve.WRAPPED:{const{views:a}=this._getVisiblePages(),i=new Map;for(const{id:s,y:l,percent:o,widthPercent:r}of a){if(o===0||r<100)continue;let c=i.get(l);c||i.set(l,c||(c=[])),c.push(s)}for(const s of i.values()){const l=s.indexOf(e);if(l===-1)continue;const o=s.length;if(o===1)break;if(n)for(let r=l-1,c=0;r>=c;r--){const d=s[r],u=s[r+1]-1;if(d<u)return e-u}else for(let r=l+1,c=o;r<c;r++){const d=s[r],u=s[r-1]+1;if(d>u)return u-e}if(n){const r=s[0];if(r<e)return e-r+1}else{const r=s[o-1];if(r>e)return r-e+1}break}break}case Ve.HORIZONTAL:break;case Ve.PAGE:case Ve.VERTICAL:{if(this._spreadMode===Bt.NONE)break;const a=this._spreadMode-1;if(n&&e%2!==a)break;if(!n&&e%2===a)break;const{views:i}=this._getVisiblePages(),s=n?e-1:e+1;for(const{id:l,percent:o,widthPercent:r}of i)if(l===s){if(o>0&&r===100)return 2;break}break}}return 1}nextPage(){const e=this._currentPageNumber,n=this.pagesCount;if(e>=n)return!1;const a=this._getPageAdvance(e,!1)||1;return this.currentPageNumber=Math.min(e+a,n),!0}previousPage(){const e=this._currentPageNumber;if(e<=1)return!1;const n=this._getPageAdvance(e,!0)||1;return this.currentPageNumber=Math.max(e-n,1),!0}updateScale({drawingDelay:e,scaleFactor:n=null,steps:a=null,origin:i}){if(a===null&&n===null)throw new Error("Invalid updateScale options: either `steps` or `scaleFactor` must be provided.");if(!this.pdfDocument)return;let s=this._currentScale;if(n>0&&n!==1)s=Math.round(s*n*100)/100;else if(a){const l=a>0?WE:1/WE,o=a>0?Math.ceil:Math.floor;a=Math.abs(a);do s=o((s*l).toFixed(2)*10)/10;while(--a>0)}s=Math.max(VE,Math.min(YE,s)),H(this,Fi,hl).call(this,s,{noScroll:!1,drawingDelay:e,origin:i})}increaseScale(e={}){var n;this.updateScale(ml(aa({},e),{steps:(n=e.steps)!=null?n:1}))}decreaseScale(e={}){var n;this.updateScale(ml(aa({},e),{steps:-((n=e.steps)!=null?n:1)}))}get containerTopLeft(){return x(this,nf)||z(this,nf,[this.container.offsetTop,this.container.offsetLeft])}get annotationEditorMode(){return x(this,Ia)?x(this,qi):ae.AnnotationEditorType.DISABLE}set annotationEditorMode({mode:e,editId:n=null,isFromKeyboard:a=!1}){var l;if(!x(this,Ia))throw new Error("The AnnotationEditor is not enabled.");if(x(this,qi)===e)return;if(!Ok(e))throw new Error(`Invalid AnnotationEditor mode: ${e}`);if(!this.pdfDocument)return;e===ae.AnnotationEditorType.STAMP&&((l=x(this,Do))==null||l.loadModel("altText"));const{eventBus:i}=this,s=()=>{H(this,rc,Wm).call(this),z(this,qi,e),x(this,Ia).updateMode(e,n,a),i.dispatch("annotationeditormodechanged",{source:this,mode:e})};if(e===ae.AnnotationEditorType.NONE||x(this,qi)===ae.AnnotationEditorType.NONE){const o=e!==ae.AnnotationEditorType.NONE;o||this.pdfDocument.annotationStorage.resetModifiedIds();for(const c of this._pages)c.toggleEditingMode(o);const r=H(this,vm,aA).call(this);if(o&&r){H(this,rc,Wm).call(this),z(this,Io,new AbortController);const c=AbortSignal.any([x(this,dl).signal,x(this,Io).signal]);i._on("pagerendered",({pageNumber:d})=>{r.delete(d),r.size===0&&z(this,$o,setTimeout(s,0))},{signal:c});return}}s()}refresh(e=!1,n=Object.create(null)){if(this.pdfDocument){for(const a of this._pages)a.update(n);x(this,fl)!==null&&(clearTimeout(x(this,fl)),z(this,fl,null)),e||this.update()}}}cl=new WeakMap,ef=new WeakMap,tf=new WeakMap,qi=new WeakMap,Ia=new WeakMap,To=new WeakMap,nf=new WeakMap,af=new WeakMap,sf=new WeakMap,lf=new WeakMap,of=new WeakMap,rf=new WeakMap,dl=new WeakMap,Do=new WeakMap,Io=new WeakMap,$o=new WeakMap,ac=new WeakMap,ul=new WeakMap,ic=new WeakMap,cf=new WeakMap,sc=new WeakMap,Mo=new WeakMap,fl=new WeakMap,lc=new WeakMap,hm=new WeakSet,XL=function(e){const n={annotationEditorMode:x(this,qi),annotationMode:x(this,To),textLayerMode:x(this,lc)};return e&&(!e.includes(ae.PermissionFlag.COPY)&&x(this,lc)===ci.ENABLE&&(n.textLayerMode=ci.ENABLE_PERMISSIONS),e.includes(ae.PermissionFlag.MODIFY_CONTENTS)||(n.annotationEditorMode=ae.AnnotationEditorType.DISABLE),!e.includes(ae.PermissionFlag.MODIFY_ANNOTATIONS)&&!e.includes(ae.PermissionFlag.FILL_INTERACTIVE_FORMS)&&x(this,To)===ae.AnnotationMode.ENABLE_FORMS&&(n.annotationMode=ae.AnnotationMode.ENABLE)),n},bm=new WeakSet,QL=function(e){return se(this,null,function*(){if(document.visibilityState==="hidden"||!this.container.offsetParent||this._getVisiblePages().views.length===0)return;const n=Promise.withResolvers(),a=new AbortController;document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&n.resolve()},{signal:typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")||typeof AbortSignal.any=="function"?AbortSignal.any([e,a.signal]):e}),yield Promise.race([this._onePageRenderedCapability.promise,n.promise]),a.abort()})},ym=new WeakSet,eA=function(e,n){const a=document.getSelection(),{focusNode:i,anchorNode:s}=a;if(s&&i&&a.containsNode(x(this,ul))){if(x(this,ac)||e===ci.ENABLE_PERMISSIONS){n.preventDefault(),n.stopPropagation();return}z(this,ac,!0);const{classList:l}=this.viewer;l.add("copyAll");const o=new AbortController;window.addEventListener("keydown",r=>z(this,ic,r.key==="Escape"),{signal:o.signal}),this.getAllText().then(r=>se(this,null,function*(){r!==null&&(yield navigator.clipboard.writeText(r))})).catch(r=>{console.warn(`Something goes wrong when extracting the text: ${r.message}`)}).finally(()=>{z(this,ac,!1),z(this,ic,!1),o.abort(),l.remove("copyAll")}),n.preventDefault(),n.stopPropagation()}},Po=new WeakSet,Cf=function(){if(this._scrollMode!==Ve.PAGE)throw new Error("#ensurePageViewVisible: Invalid scrollMode value.");const e=this._currentPageNumber,n=x(this,Mo),a=this.viewer;if(a.textContent="",n.pages.length=0,this._spreadMode===Bt.NONE&&!this.isInPresentationMode){const i=this._pages[e-1];a.append(i.div),n.pages.push(i)}else{const i=new Set,s=this._spreadMode-1;s===-1?i.add(e-1):e%2!==s?(i.add(e-1),i.add(e)):(i.add(e-2),i.add(e-1));const l=document.createElement("div");if(l.className="spread",this.isInPresentationMode){const o=document.createElement("div");o.className="dummyPage",l.append(o)}for(const o of i){const r=this._pages[o];r&&(l.append(r.div),n.pages.push(r))}a.append(l)}n.scrollDown=e>=n.previousPageNumber,n.previousPageNumber=e},oc=new WeakSet,Um=function(e,n=null){const{div:a,id:i}=e;if(this._currentPageNumber!==i&&this._setCurrentPageNumber(i),this._scrollMode===Ve.PAGE&&(H(this,Po,Cf).call(this),this.update()),!n&&!this.isInPresentationMode){const s=a.offsetLeft+a.clientLeft,l=s+a.clientWidth,{scrollLeft:o,clientWidth:r}=this.container;(this._scrollMode===Ve.HORIZONTAL||s<o||l>o+r)&&(n={left:0,top:0})}vb(a,n),!this._currentScaleValue&&this._location&&(this._location=null)},_m=new WeakSet,tA=function(e){return e===this._currentScale||Math.abs(e-this._currentScale)<1e-15},df=new WeakSet,C_=function(e,n,{noScroll:a=!1,preset:i=!1,drawingDelay:s=-1,origin:l=null}){if(this._currentScaleValue=n.toString(),H(this,_m,tA).call(this,e)){i&&this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:n});return}this.viewer.style.setProperty("--scale-factor",e*ae.PixelsPerInch.PDF_TO_CSS_UNITS);const o=s>=0&&s<1e3;this.refresh(!0,{scale:e,drawingDelay:o?s:-1}),o&&z(this,fl,setTimeout(()=>{z(this,fl,null),this.refresh()},s));const r=this._currentScale;if(this._currentScale=e,!a){let c=this._currentPageNumber,d;if(this._location&&!(this.isInPresentationMode||this.isChangingPresentationMode)&&(c=this._location.pageNumber,d=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:c,destArray:d,allowNegativeOffset:!0}),Array.isArray(l)){const u=e/r-1,[m,f]=this.containerTopLeft;this.container.scrollLeft+=(l[0]-f)*u,this.container.scrollTop+=(l[1]-m)*u}}this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:i?n:void 0}),this.defaultRenderingQueue&&this.update()},wm=new WeakSet,nA=function(){return this._spreadMode!==Bt.NONE&&this._scrollMode!==Ve.HORIZONTAL?2:1},Fi=new WeakSet,hl=function(e,n){let a=parseFloat(e);if(a>0)n.preset=!1,H(this,df,C_).call(this,a,e,n);else{const i=this._pages[this._currentPageNumber-1];if(!i)return;let s=zE,l=GE;this.isInPresentationMode?(s=l=4,this._spreadMode!==Bt.NONE&&(s*=2)):(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.removePageBorders?s=l=0:this._scrollMode===Ve.HORIZONTAL&&([s,l]=[l,s]);const o=(this.container.clientWidth-s)/i.width*i.scale/x(this,wm,nA),r=(this.container.clientHeight-l)/i.height*i.scale;switch(e){case"page-actual":a=1;break;case"page-width":a=o;break;case"page-height":a=r;break;case"page-fit":a=Math.min(o,r);break;case"auto":const c=Eb(i)?o:Math.min(r,o);a=Math.min(lC,c);break;default:console.error(`#setScale: "${e}" is an unknown zoom value.`);return}n.preset=!0,H(this,df,C_).call(this,a,e,n)}},uf=new WeakSet,T_=function(){const e=this._pages[this._currentPageNumber-1];this.isInPresentationMode&&H(this,Fi,hl).call(this,this._currentScaleValue,{noScroll:!0}),H(this,oc,Um).call(this,e)},vm=new WeakSet,aA=function(){const e=this._getVisiblePages(),n=[],{ids:a,views:i}=e;for(const s of i){const{view:l}=s;if(!l.hasEditableAnnotations()){a.delete(l.id);continue}n.push(s)}return n.length===0?null:(this.renderingQueue.renderHighestPriority({first:n[0],last:n.at(-1),views:n,ids:a}),a)},Em=new WeakSet,iA=function(e){return se(this,null,function*(){if(e.pdfPage)return e.pdfPage;try{const n=yield this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(n),n}catch(n){return console.error("Unable to get page for page view",n),null}})},km=new WeakSet,sA=function(e){var n,a;if(((n=e.first)==null?void 0:n.id)===1)return!0;if(((a=e.last)==null?void 0:a.id)===this.pagesCount)return!1;switch(this._scrollMode){case Ve.PAGE:return x(this,Mo).scrollDown;case Ve.HORIZONTAL:return this.scroll.right}return this.scroll.down},ff=new WeakSet,D_=function(e=this.container.clientHeight){e!==x(this,cf)&&(z(this,cf,e),tk.setProperty("--viewer-container-height",`${e}px`))},Sm=new WeakSet,lA=function(e){for(const n of e)if(n.target===this.container){H(this,ff,D_).call(this,Math.floor(n.borderBoxSize[0].blockSize)),z(this,nf,null);break}},rc=new WeakSet,Wm=function(){var e;(e=x(this,Io))==null||e.abort(),z(this,Io,null),x(this,$o)!==null&&(clearTimeout(x(this,$o)),z(this,$o,null))};class UT{constructor(e,n){O(this,cc);O(this,Lm);O(this,Am);O(this,pf);O(this,gf);O(this,yi,void 0);z(this,yi,e);const a=[{element:e.presentationModeButton,eventName:"presentationmode",close:!0},{element:e.printButton,eventName:"print",close:!0},{element:e.downloadButton,eventName:"download",close:!0},{element:e.viewBookmarkButton,eventName:null,close:!0},{element:e.firstPageButton,eventName:"firstpage",close:!0},{element:e.lastPageButton,eventName:"lastpage",close:!0},{element:e.pageRotateCwButton,eventName:"rotatecw",close:!1},{element:e.pageRotateCcwButton,eventName:"rotateccw",close:!1},{element:e.cursorSelectToolButton,eventName:"switchcursortool",eventDetails:{tool:Qn.SELECT},close:!0},{element:e.cursorHandToolButton,eventName:"switchcursortool",eventDetails:{tool:Qn.HAND},close:!0},{element:e.scrollPageButton,eventName:"switchscrollmode",eventDetails:{mode:Ve.PAGE},close:!0},{element:e.scrollVerticalButton,eventName:"switchscrollmode",eventDetails:{mode:Ve.VERTICAL},close:!0},{element:e.scrollHorizontalButton,eventName:"switchscrollmode",eventDetails:{mode:Ve.HORIZONTAL},close:!0},{element:e.scrollWrappedButton,eventName:"switchscrollmode",eventDetails:{mode:Ve.WRAPPED},close:!0},{element:e.spreadNoneButton,eventName:"switchspreadmode",eventDetails:{mode:Bt.NONE},close:!0},{element:e.spreadOddButton,eventName:"switchspreadmode",eventDetails:{mode:Bt.ODD},close:!0},{element:e.spreadEvenButton,eventName:"switchspreadmode",eventDetails:{mode:Bt.EVEN},close:!0},{element:e.imageAltTextSettingsButton,eventName:"imagealttextsettings",close:!0},{element:e.documentPropertiesButton,eventName:"documentproperties",close:!0}];(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&a.push({element:e.openFileButton,eventName:"openfile",close:!0}),this.eventBus=n,this.opened=!1,H(this,Lm,oA).call(this,a),this.reset()}get isOpen(){return this.opened}setPageNumber(e){this.pageNumber=e,H(this,cc,Vm).call(this)}setPagesCount(e){this.pagesCount=e,H(this,cc,Vm).call(this)}reset(){this.pageNumber=0,this.pagesCount=0,H(this,cc,Vm).call(this),this.eventBus.dispatch("switchcursortool",{source:this,reset:!0}),H(this,pf,I_).call(this,{mode:Ve.VERTICAL}),H(this,gf,$_).call(this,{mode:Bt.NONE})}open(){if(this.opened)return;this.opened=!0;const{toggleButton:e,toolbar:n}=x(this,yi);Di(e,!0,n)}close(){if(!this.opened)return;this.opened=!1;const{toggleButton:e,toolbar:n}=x(this,yi);Di(e,!1,n)}toggle(){this.opened?this.close():this.open()}}yi=new WeakMap,cc=new WeakSet,Vm=function(){const{firstPageButton:e,lastPageButton:n,pageRotateCwButton:a,pageRotateCcwButton:i}=x(this,yi);e.disabled=this.pageNumber<=1,n.disabled=this.pageNumber>=this.pagesCount,a.disabled=this.pagesCount===0,i.disabled=this.pagesCount===0},Lm=new WeakSet,oA=function(e){const{eventBus:n}=this,{toggleButton:a}=x(this,yi);a.addEventListener("click",this.toggle.bind(this));for(const{element:i,eventName:s,close:l,eventDetails:o}of e)i.addEventListener("click",r=>{s!==null&&n.dispatch(s,aa({source:this},o)),l&&this.close(),n.dispatch("reporttelemetry",{source:this,details:{type:"buttons",data:{id:i.id}}})});n._on("cursortoolchanged",H(this,Am,rA).bind(this)),n._on("scrollmodechanged",H(this,pf,I_).bind(this)),n._on("spreadmodechanged",H(this,gf,$_).bind(this))},Am=new WeakSet,rA=function({tool:e,disabled:n}){const{cursorSelectToolButton:a,cursorHandToolButton:i}=x(this,yi);La(a,e===Qn.SELECT),La(i,e===Qn.HAND),a.disabled=n,i.disabled=n},pf=new WeakSet,I_=function({mode:e}){const{scrollPageButton:n,scrollVerticalButton:a,scrollHorizontalButton:i,scrollWrappedButton:s,spreadNoneButton:l,spreadOddButton:o,spreadEvenButton:r}=x(this,yi);La(n,e===Ve.PAGE),La(a,e===Ve.VERTICAL),La(i,e===Ve.HORIZONTAL),La(s,e===Ve.WRAPPED);const c=this.pagesCount>cd.FORCE_SCROLL_MODE_PAGE;n.disabled=c,a.disabled=c,i.disabled=c,s.disabled=c;const d=e===Ve.HORIZONTAL;l.disabled=d,o.disabled=d,r.disabled=d},gf=new WeakSet,$_=function({mode:e}){const{spreadNoneButton:n,spreadOddButton:a,spreadEvenButton:i}=x(this,yi);La(n,e===Bt.NONE),La(a,e===Bt.ODD),La(i,e===Bt.EVEN)};class Bk{constructor(e,n,a=0){O(this,mf);O(this,xm);O(this,Cm);O(this,hf);O(this,No);O(this,pl,void 0);z(this,pl,e),this.eventBus=n;const i=[{element:e.previous,eventName:"previouspage"},{element:e.next,eventName:"nextpage"},{element:e.zoomIn,eventName:"zoomin"},{element:e.zoomOut,eventName:"zoomout"},{element:e.print,eventName:"print"},{element:e.download,eventName:"download"},{element:e.editorFreeTextButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorFreeTextButton;return s.contains("toggled")?ae.AnnotationEditorType.NONE:ae.AnnotationEditorType.FREETEXT}}},{element:e.editorHighlightButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorHighlightButton;return s.contains("toggled")?ae.AnnotationEditorType.NONE:ae.AnnotationEditorType.HIGHLIGHT}}},{element:e.editorInkButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorInkButton;return s.contains("toggled")?ae.AnnotationEditorType.NONE:ae.AnnotationEditorType.INK}}},{element:e.editorStampButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:s}=e.editorStampButton;return s.contains("toggled")?ae.AnnotationEditorType.NONE:ae.AnnotationEditorType.STAMP}},telemetry:{type:"editing",data:{action:"pdfjs.image.icon_click"}}}];H(this,Cm,dA).call(this,i),H(this,mf,M_).call(this,{value:a}),this.reset()}setPageNumber(e,n){this.pageNumber=e,this.pageLabel=n,H(this,No,Tf).call(this,!1)}setPagesCount(e,n){this.pagesCount=e,this.hasPageLabels=n,H(this,No,Tf).call(this,!0)}setPageScale(e,n){this.pageScaleValue=(e||n).toString(),this.pageScale=n,H(this,No,Tf).call(this,!1)}reset(){this.pageNumber=0,this.pageLabel=null,this.hasPageLabels=!1,this.pagesCount=0,this.pageScaleValue=sd,this.pageScale=_b,H(this,No,Tf).call(this,!0),this.updateLoadingIndicatorState(),H(this,hf,P_).call(this,{mode:ae.AnnotationEditorType.DISABLE})}updateLoadingIndicatorState(e=!1){const{pageNumber:n}=x(this,pl);n.classList.toggle("loading",e)}}pl=new WeakMap,mf=new WeakSet,M_=function({value:e}){let n="normal";switch(e){case 1:n="compact";break;case 2:n="touch";break}document.documentElement.setAttribute("data-toolbar-density",n)},xm=new WeakSet,cA=function(e,n){const a=new ae.ColorPicker({uiManager:e});e.setMainHighlightColorPicker(a),n.append(a.renderMainDropdown())},Cm=new WeakSet,dA=function(e){const{eventBus:n}=this,{editorHighlightColorPicker:a,editorHighlightButton:i,pageNumber:s,scaleSelect:l}=x(this,pl),o=this;for(const{element:r,eventName:c,eventDetails:d,telemetry:u}of e)r.addEventListener("click",m=>{c!==null&&n.dispatch(c,ml(aa({source:this},d),{isFromKeyboard:m.detail===0})),u&&n.dispatch("reporttelemetry",{source:this,details:u})});s.addEventListener("click",function(){this.select()}),s.addEventListener("change",function(){n.dispatch("pagenumberchanged",{source:o,value:this.value})}),l.addEventListener("change",function(){this.value!=="custom"&&n.dispatch("scalechanged",{source:o,value:this.value})}),l.addEventListener("click",function({target:r}){this.value===o.pageScaleValue&&r.tagName.toUpperCase()==="OPTION"&&this.blur()}),l.oncontextmenu=ae.noContextMenu,n._on("annotationeditormodechanged",H(this,hf,P_).bind(this)),n._on("showannotationeditorui",({mode:r})=>{switch(r){case ae.AnnotationEditorType.HIGHLIGHT:i.click();break}}),n._on("toolbardensity",H(this,mf,M_).bind(this)),a&&n._on("annotationeditoruimanager",({uiManager:r})=>{H(this,xm,cA).call(this,r,a)},{once:!0})},hf=new WeakSet,P_=function({mode:e}){const{editorFreeTextButton:n,editorFreeTextParamsToolbar:a,editorHighlightButton:i,editorHighlightParamsToolbar:s,editorInkButton:l,editorInkParamsToolbar:o,editorStampButton:r,editorStampParamsToolbar:c}=x(this,pl);Di(n,e===ae.AnnotationEditorType.FREETEXT,a),Di(i,e===ae.AnnotationEditorType.HIGHLIGHT,s),Di(l,e===ae.AnnotationEditorType.INK,o),Di(r,e===ae.AnnotationEditorType.STAMP,c);const d=e===ae.AnnotationEditorType.DISABLE;n.disabled=d,i.disabled=d,l.disabled=d,r.disabled=d},No=new WeakSet,Tf=function(e=!1){const{pageNumber:n,pagesCount:a,pageScaleValue:i,pageScale:s}=this,l=x(this,pl);e&&(this.hasPageLabels?(l.pageNumber.type="text",l.numPages.setAttribute("data-l10n-id","pdfjs-page-of-pages")):(l.pageNumber.type="number",l.numPages.textContent="/ "+a),l.pageNumber.max=a),this.hasPageLabels?(l.pageNumber.value=this.pageLabel,l.numPages.textContent=`(${n} / ${a})`):l.pageNumber.value=n,l.previous.disabled=n<=1,l.next.disabled=n>=a,l.zoomOut.disabled=s<=VE,l.zoomIn.disabled=s>=YE;let o=!1;for(const r of l.scaleSelect.options){if(r.value!==i){r.selected=!1;continue}r.selected=!0,o=!0}o||(l.customScaleOption.selected=!0,l.customScaleOption.textContent=`${Math.round(s*1e4)/100}%`)};const WT=20;class VT{constructor(e,n=WT){this.fingerprint=e,this.cacheSize=n,this._initializedPromise=this._readFromStorage().then(a=>{const i=JSON.parse(a||"{}");let s=-1;if(!Array.isArray(i.files))i.files=[];else{for(;i.files.length>=this.cacheSize;)i.files.shift();for(let l=0,o=i.files.length;l<o;l++)if(i.files[l].fingerprint===this.fingerprint){s=l;break}}s===-1&&(s=i.files.push({fingerprint:this.fingerprint})-1),this.file=i.files[s],this.database=i})}_writeToStorage(){return se(this,null,function*(){const e=JSON.stringify(this.database);if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")){sessionStorage.setItem("pdfjs.history",e);return}window.siyuan.storage["pdfjs.history"]=e,Ee("pdfjs.history",e)})}_readFromStorage(){return se(this,null,function*(){return typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?sessionStorage.getItem("pdfjs.history"):window.siyuan.storage["pdfjs.history"]})}set(e,n){return se(this,null,function*(){return yield this._initializedPromise,this.file[e]=n,this._writeToStorage()})}setMultiple(e){return se(this,null,function*(){yield this._initializedPromise;for(const n in e)this.file[n]=e[n];return this._writeToStorage()})}get(e,n){return se(this,null,function*(){yield this._initializedPromise;const a=this.file[e];return a!==void 0?a:n})}getMultiple(e){return se(this,null,function*(){yield this._initializedPromise;const n=Object.create(null);for(const a in e){const i=this.file[a];n[a]=i!==void 0?i:e[a]}return n})}}const YT=1e4,jb={UNKNOWN:-1,PREVIOUS:0,INITIAL:1};class Rk{constructor(e){this.pdfId=e,this.initialBookmark=document.location.hash.substring(1),this._initializedCapability=ml(aa({},Promise.withResolvers()),{settled:!1}),this.appConfig=null,this.pdfDocument=null,this.pdfLoadingTask=null,this.printService=null,this.pdfViewer=null,this.pdfThumbnailViewer=null,this.pdfRenderingQueue=null,this.pdfPresentationMode=null,this.pdfDocumentProperties=null,this.pdfLinkService=null,this.pdfHistory=null,this.pdfSidebar=null,this.pdfOutlineViewer=null,this.pdfAttachmentViewer=null,this.pdfLayerViewer=null,this.pdfCursorTools=null,this.pdfScriptingManager=null,this.store=null,this.downloadManager=null,this.overlayManager=null,this.preferences=new wC,this.toolbar=null,this.secondaryToolbar=null,this.eventBus=null,this.l10n=null,this.annotationEditorParams=null,this.imageAltTextSettings=null,this.isInitialViewSet=!1,this.isViewerEmbedded=!0,this.url="",this.baseUrl="",this.mlManager=null,this._downloadUrl="",this._eventBusAbortController=null,this._windowAbortController=null,this._globalAbortController=new AbortController,this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._wheelUnusedTicks=0,this._wheelUnusedFactor=1,this._touchUnusedTicks=0,this._touchUnusedFactor=1,this._PDFBug=null,this._hasAnnotationEditors=!1,this._title=document.title,this._printAnnotationStoragePromise=null,this._touchInfo=null,this._isCtrlKeyDown=!1,this._caretBrowsing=null,this._isScrolling=!1}initialize(e){return se(this,null,function*(){var n;this.appConfig=e;try{yield this.preferences.initializedPromise}catch(a){console.error(`initialize: "${a.message}".`)}if(ge.get("pdfBugEnabled")&&(yield this._parseHashParams()),typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL")){let a;switch(ge.get("viewerCssTheme")){case 1:a="is-light";break;case 2:a="is-dark";break}a&&document.documentElement.classList.add(a),(typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING"))&&ge.get("enableFakeMLManager")&&(this.mlManager=((n=Rp.getFakeMLManager)==null?void 0:n.call(Rp,{enableGuessAltText:ge.get("enableGuessAltText"),enableAltTextModelDownload:ge.get("enableAltTextModelDownload")}))||null)}else ge.get("enableAltText")&&(this.mlManager=new Rp({enableGuessAltText:ge.get("enableGuessAltText"),enableAltTextModelDownload:ge.get("enableAltTextModelDownload"),altTextLearnMoreUrl:ge.get("altTextLearnMoreUrl")}));this.l10n=yield this.externalServices.createL10n(),document.getElementsByTagName("html")[0].dir=this.l10n.getDirection(),(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&this.l10n.translate(e.appContainer||document.documentElement),this.isViewerEmbedded&&ge.get("externalLinkTarget")===es.NONE&&ge.set("externalLinkTarget",es.TOP),yield this._initializeViewerComponents(),this.bindEvents(),this.bindWindowEvents(),this._initializedCapability.settled=!0,this._initializedCapability.resolve()})}_parseHashParams(){return se(this,null,function*(){var o;const e=document.location.hash.substring(1);if(!e)return;const{mainContainer:n,viewerContainer:a}=this.appConfig,i=ld(e),s=()=>se(this,null,function*(){this._PDFBug});if(i.get("disableworker")==="true")try{(o=ae.GlobalWorkerOptions).workerSrc||(o.workerSrc=ge.get("workerSrc")),typeof PDFJSDev=="undefined"?globalThis.pdfjsWorker=yield Ue(843)(`${p.PROTYLE_CDN}/js/pdf/pdf.worker.mjs`):yield __non_webpack_import__(ae.PDFWorker.workerSrc)}catch(r){console.error(`_parseHashParams: "${r.message}".`)}if(i.has("textlayer"))switch(i.get("textlayer")){case"off":ge.set("textLayerMode",ci.DISABLE);break;case"visible":case"shadow":case"hover":a.classList.add(`textLayer-${i.get("textlayer")}`);try{yield s(),this._PDFBug.loadCSS()}catch(r){console.error(`_parseHashParams: "${r.message}".`)}break}if(i.has("pdfbug")){ge.setAll({pdfBug:!0,fontExtraProperties:!0});const r=i.get("pdfbug").split(",");try{yield s(),this._PDFBug.init(n,r)}catch(c){console.error(`_parseHashParams: "${c.message}".`)}}(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&i.has("locale")&&ge.set("localeProperties",{lang:i.get("locale")});const l={disableAutoFetch:r=>r==="true",disableFontFace:r=>r==="true",disableHistory:r=>r==="true",disableRange:r=>r==="true",disableStream:r=>r==="true",verbosity:r=>r|0};typeof PDFJSDev!="undefined"&&PDFJSDev.test("TESTING")&&Object.assign(l,{enableAltText:r=>r==="true",enableFakeMLManager:r=>r==="true",enableGuessAltText:r=>r==="true",enableUpdatedAddImage:r=>r==="true",highlightEditorColors:r=>r,maxCanvasPixels:r=>parseInt(r),spreadModeOnLoad:r=>parseInt(r),supportsCaretBrowsingMode:r=>r==="true"});for(const r in l){const c=l[r],d=r.toLowerCase();i.has(d)&&ge.set(r,c(i.get(d)))}})}_initializeViewerComponents(){return se(this,null,function*(){var y,w,E,C,$,M,k,_,v,S,L;const{appConfig:e,externalServices:n,l10n:a}=this,i=typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?new bC(ge.get("allowedGlobalEvents"),n,ge.get("isInAutomation")):new Lb;this.eventBus=ge.eventBus=i,(y=this.mlManager)==null||y.setEventBus(i,this._globalAbortController.signal),this.overlayManager=new LC;const s=new Ek;s.onIdle=this._cleanup.bind(this),this.pdfRenderingQueue=s;const l=new Bp({eventBus:i,externalLinkTarget:ge.get("externalLinkTarget"),externalLinkRel:ge.get("externalLinkRel"),ignoreDestinationZoom:ge.get("ignoreDestinationZoom")});this.pdfLinkService=l;const o=this.downloadManager=new SC,r=new tT({linkService:l,eventBus:i,updateMatchesCountOnProgress:typeof PDFJSDev=="undefined"?!window.isGECKOVIEW:!PDFJSDev.test("GECKOVIEW")});this.findController=r;const c=new _T({eventBus:i,externalServices:n,docProperties:this._scriptingDocProperties.bind(this)});this.pdfScriptingManager=c;const d=e.mainContainer,u=e.viewerContainer,m=ge.get("annotationEditorMode"),f=ge.get("forcePageColors")||window.matchMedia("(forced-colors: active)").matches?{background:ge.get("pageColorsBackground"),foreground:ge.get("pageColorsForeground")}:null;let g;const h=ge.get("enableHWA"),b=new FT({container:d,viewer:u,eventBus:i,renderingQueue:s,linkService:l,downloadManager:o,altTextManager:g,findController:r,scriptingManager:ge.get("enableScripting")&&c,l10n:a,textLayerMode:ge.get("textLayerMode"),annotationMode:ge.get("annotationMode"),annotationEditorMode:m,annotationEditorHighlightColors:ge.get("highlightEditorColors"),enableHighlightFloatingButton:ge.get("enableHighlightFloatingButton"),enableUpdatedAddImage:ge.get("enableUpdatedAddImage"),enableNewAltTextWhenAddingImage:ge.get("enableNewAltTextWhenAddingImage"),imageResourcesPath:ge.get("imageResourcesPath"),enablePrintAutoRotate:ge.get("enablePrintAutoRotate"),maxCanvasPixels:ge.get("maxCanvasPixels"),enablePermissions:ge.get("enablePermissions"),pageColors:f,mlManager:this.mlManager,abortSignal:this._globalAbortController.signal,enableHWA:h});if(this.pdfViewer=b,s.setViewer(b),l.setViewer(b),c.setViewer(b),(w=e.sidebar)!=null&&w.thumbnailView&&(this.pdfThumbnailViewer=new LT({container:e.sidebar.thumbnailView,eventBus:i,renderingQueue:s,linkService:l,pageColors:f,abortSignal:this._globalAbortController.signal,enableHWA:h}),s.setThumbnailViewer(this.pdfThumbnailViewer)),!this.isViewerEmbedded&&!ge.get("disableHistory")&&(this.pdfHistory=new sT({linkService:l,eventBus:i}),l.setHistory(this.pdfHistory)),!this.supportsIntegratedFind&&e.findBar&&(this.findBar=new aT(e.findBar,e.principalContainer,i)),e.annotationEditorParams)if((typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")||typeof AbortSignal.any=="function")&&m!==ae.AnnotationEditorType.DISABLE)this.annotationEditorParams=new kC(e.annotationEditorParams,i);else for(const D of["editorModeButtons","editorModeSeparator"])(E=document.getElementById(D))==null||E.classList.add("hidden");if(this.mlManager&&((C=e.secondaryToolbar)!=null&&C.imageAltTextSettingsButton),e.documentProperties&&(this.pdfDocumentProperties=new MC(e.documentProperties,this.overlayManager,i,a,()=>this._docFilename)),($=e.secondaryToolbar)!=null&&$.cursorHandToolButton&&(this.pdfCursorTools=new DC({container:d,eventBus:i,cursorToolOnLoad:ge.get("cursorToolOnLoad")})),e.toolbar)if(typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW")){const D=JSON.parse(ge.get("nimbusDataStr")||"null");this.toolbar=new Bk(e.toolbar,i,D)}else this.toolbar=new Bk(e.toolbar,i,ge.get("toolbarDensity"));e.secondaryToolbar&&(ge.get("enableAltText")&&((M=e.secondaryToolbar.imageAltTextSettingsButton)==null||M.classList.remove("hidden"),(k=e.secondaryToolbar.imageAltTextSettingsSeparator)==null||k.classList.remove("hidden")),this.secondaryToolbar=new UT(e.secondaryToolbar,i)),this.supportsFullscreen&&((_=e.secondaryToolbar)!=null&&_.presentationModeButton)&&(this.pdfPresentationMode=new pT({container:d,pdfViewer:b,eventBus:i})),e.passwordOverlay&&(this.passwordPrompt=new AC(e.passwordOverlay,this.overlayManager,this.isViewerEmbedded)),(v=e.sidebar)!=null&&v.outlineView&&(this.pdfOutlineViewer=new cT({container:e.sidebar.outlineView,eventBus:i,l10n:a,linkService:l,downloadManager:o})),(S=e.sidebar)!=null&&S.attachmentsView&&(this.pdfAttachmentViewer=new CC({container:e.sidebar.attachmentsView,eventBus:i,l10n:a,downloadManager:o})),(L=e.sidebar)!=null&&L.layersView&&(this.pdfLayerViewer=new rT({container:e.sidebar.layersView,eventBus:i,l10n:a})),e.sidebar&&(this.pdfSidebar=new vT({elements:e.sidebar,eventBus:i,l10n:a}),this.pdfSidebar.onToggled=this.forceRendering.bind(this),this.pdfSidebar.onUpdateThumbnails=()=>{var D;for(const I of b.getCachedPageViews())I.renderingState===it.FINISHED&&((D=this.pdfThumbnailViewer.getThumbnail(I.id-1))==null||D.setImage(I));this.pdfThumbnailViewer.scrollThumbnailIntoView(b.currentPageNumber)})})}run(e){return se(this,null,function*(){var s,l,o,r,c,d,u;yield this.initialize(e);const{appConfig:n,eventBus:a}=this;let i;if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){const m=document.location.search.substring(1);i=(s=ld(m).get("file"))!=null?s:ge.get("defaultUrl"),zT(i)}else PDFJSDev.test("MOZCENTRAL")?i=window.location.href:PDFJSDev.test("CHROME")&&(i=ge.get("defaultUrl"));if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){const m=this._openFileInput=document.createElement("input");m.id="fileInput",m.hidden=!0,m.type="file",m.value=null,document.body.append(m),m.addEventListener("change",function(f){const{files:g}=f.target;!g||g.length===0||a.dispatch("fileinputchange",{source:this,fileInput:f.target})}),n.mainContainer.addEventListener("dragover",function(f){for(const g of f.dataTransfer.items)if(g.type==="application/pdf"){f.dataTransfer.dropEffect=f.dataTransfer.effectAllowed==="copy"?"copy":"move",f.preventDefault(),f.stopPropagation();return}}),n.mainContainer.addEventListener("drop",function(f){var g;((g=f.dataTransfer.files)==null?void 0:g[0].type)==="application/pdf"&&(f.preventDefault(),f.stopPropagation(),a.dispatch("fileinputchange",{source:this,fileInput:f.dataTransfer}))})}if(ge.get("supportsDocumentFonts")||(ge.set("disableFontFace",!0),this.l10n.get("pdfjs-web-fonts-disabled").then(m=>{console.warn(m)})),this.supportsPrinting||((o=(l=n.toolbar)==null?void 0:l.print)==null||o.classList.add("hidden"),(r=n.secondaryToolbar)==null||r.printButton.classList.add("hidden")),this.supportsFullscreen||(c=n.secondaryToolbar)==null||c.presentationModeButton.classList.add("hidden"),this.supportsIntegratedFind&&((u=(d=n.findBar)==null?void 0:d.toggleButton)==null||u.classList.add("hidden")),typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))i?this.open({url:i}):this._hideViewBookmark();else if(PDFJSDev.test("MOZCENTRAL || CHROME"))this.setTitleUsingUrl(i,i),this.externalServices.initPassiveLoading();else throw new Error("Not implemented: run")})}get externalServices(){return(0,ae.shadow)(this,"externalServices",new vC)}get initialized(){return this._initializedCapability.settled}get initializedPromise(){return this._initializedCapability.promise}updateZoom(e,n,a){this.pdfViewer.isInPresentationMode||this.pdfViewer.updateScale({drawingDelay:ge.get("defaultZoomDelay"),steps:e,scaleFactor:n,origin:a})}zoomIn(){this.updateZoom(1)}zoomOut(){this.updateZoom(-1)}zoomReset(){this.pdfViewer.isInPresentationMode||(this.pdfViewer.currentScaleValue=sd)}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfViewer.currentPageNumber}set page(e){this.pdfViewer.currentPageNumber=e}get supportsPrinting(){return vk.supportsPrinting}get supportsFullscreen(){return(0,ae.shadow)(this,"supportsFullscreen",document.fullscreenEnabled)}get supportsPinchToZoom(){return(0,ae.shadow)(this,"supportsPinchToZoom",ge.get("supportsPinchToZoom"))}get supportsIntegratedFind(){return(0,ae.shadow)(this,"supportsIntegratedFind",ge.get("supportsIntegratedFind"))}get loadingBar(){const e=this.appConfig.appContainer.querySelector("#loadingBar"),n=e?new pC(e):null;return(0,ae.shadow)(this,"loadingBar",n)}get supportsMouseWheelZoomCtrlKey(){return(0,ae.shadow)(this,"supportsMouseWheelZoomCtrlKey",ge.get("supportsMouseWheelZoomCtrlKey"))}get supportsMouseWheelZoomMetaKey(){return(0,ae.shadow)(this,"supportsMouseWheelZoomMetaKey",ge.get("supportsMouseWheelZoomMetaKey"))}get supportsCaretBrowsingMode(){return ge.get("supportsCaretBrowsingMode")}moveCaret(e,n){var a;this._caretBrowsing||(this._caretBrowsing=new Tb(this._globalAbortController.signal,this.appConfig.mainContainer,this.appConfig.viewerContainer,(a=this.appConfig.toolbar)==null?void 0:a.container)),this._caretBrowsing.moveCaret(e,n)}setTitleUsingUrl(e="",n=null){this.url=e,this.baseUrl=e.split("#",1)[0],n&&(this._downloadUrl=n===e?this.baseUrl:n.split("#",1)[0]),(0,ae.isDataScheme)(e)?this._hideViewBookmark():typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL || CHROME")&&ge.set("docBaseUrl",this.baseUrl);let a=(0,ae.getPdfFilenameFromUrl)(e,"");if(!a)try{a=decodeURIComponent((0,ae.getFilenameFromUrl)(e))}catch(i){}this.setTitle(a||e)}setTitle(e=this._title){if(this._title=e,this.isViewerEmbedded)return;const n=this._hasAnnotationEditors&&!this.pdfRenderingQueue.printing;document.title=`${n?"* ":""}${e}`}get _docFilename(){return this._contentDispositionFilename||(0,ae.getPdfFilenameFromUrl)(this.url)}_hideViewBookmark(){var n;const{secondaryToolbar:e}=this.appConfig;e==null||e.viewBookmarkButton.classList.add("fn__hidden"),e!=null&&e.presentationModeButton.classList.contains("fn__hidden")&&((n=document.getElementById("viewBookmarkSeparator"))==null||n.classList.add("fn__hidden"))}close(){return se(this,null,function*(){var n,a,i,s,l,o,r,c,d,u,m,f;if(this._unblockDocumentLoadEvent(),this._hideViewBookmark(),!this.pdfLoadingTask)return;if((typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC && !TESTING"))&&((n=this.pdfDocument)==null?void 0:n.annotationStorage.size)>0&&this._annotationStorageModified)try{yield this.save()}catch(g){}const e=[];e.push(this.pdfLoadingTask.destroy()),this.pdfLoadingTask=null,this.pdfDocument&&(this.pdfDocument=null,(a=this.pdfThumbnailViewer)==null||a.setDocument(null),this.pdfViewer.setDocument(null),this.pdfLinkService.setDocument(null),(i=this.pdfDocumentProperties)==null||i.setDocument(null)),this.pdfLinkService.externalLinkEnabled=!0,this.store=null,this.isInitialViewSet=!1,this.url="",this.baseUrl="",this._downloadUrl="",this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._hasAnnotationEditors=!1,e.push(this.pdfScriptingManager.destroyPromise,this.passwordPrompt.close()),this.setTitle(),(s=this.pdfSidebar)==null||s.reset(),(l=this.pdfOutlineViewer)==null||l.reset(),(o=this.pdfAttachmentViewer)==null||o.reset(),(r=this.pdfLayerViewer)==null||r.reset(),(c=this.pdfHistory)==null||c.reset(),(d=this.findBar)==null||d.reset(),(u=this.toolbar)==null||u.reset(),(m=this.secondaryToolbar)==null||m.reset(),(f=this._PDFBug)==null||f.cleanup(),yield Promise.all(e)})}open(e){return se(this,null,function*(){this.pdfLoadingTask&&(yield this.close());const n=ge.getAll(te.WORKER);Object.assign(ae.GlobalWorkerOptions,n),typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?e.data&&(0,ae.isPdfFile)(e.filename)&&(this._contentDispositionFilename=e.filename):e.url&&this.setTitleUsingUrl(e.originalUrl||e.url,e.url);const a=ge.getAll(te.API),i=(0,ae.getDocument)(aa(aa({},a),e));return this.pdfLoadingTask=i,i.onPassword=(s,l)=>{this.isViewerEmbedded&&this._unblockDocumentLoadEvent(),this.pdfLinkService.externalLinkEnabled=!1,this.passwordPrompt.setUpdateCallback(s,l),this.passwordPrompt.open()},i.onProgress=({loaded:s,total:l})=>{this.progress(s/l)},i.promise.then(s=>{this.load(s)},s=>{if(i!==this.pdfLoadingTask)return;let l="loadingError";return s instanceof ae.InvalidPDFException?l="invalidFileError":s instanceof ae.MissingPDFException?l="missingFileError":s instanceof ae.UnexpectedResponseException&&(l="unexpectedResponseError"),this._documentError(window.siyuan.languages[l],{message:s.message}).then(()=>{throw s})})})}download(){return se(this,null,function*(){let e;try{e=yield this.pdfDocument.getData()}catch(n){}this.downloadManager.download(e,this._downloadUrl,this._docFilename)})}save(){return se(this,null,function*(){var e;if(!this._saveInProgress){this._saveInProgress=!0,yield this.pdfScriptingManager.dispatchWillSave();try{const n=yield this.pdfDocument.saveDocument();this.downloadManager.download(n,this._downloadUrl,this._docFilename)}catch(n){console.error(`Error when saving the document: ${n.message}`),yield this.download()}finally{yield this.pdfScriptingManager.dispatchDidSave(),this._saveInProgress=!1}this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"save",stats:(e=this.pdfDocument)==null?void 0:e.annotationStorage.editorStats}})}})}downloadOrSave(){return se(this,null,function*(){var n;const{classList:e}=this.appConfig.appContainer;e.add("wait"),yield((n=this.pdfDocument)==null?void 0:n.annotationStorage.size)>0?this.save():this.download(),e.remove("wait")})}_documentError(e,n=null){return se(this,null,function*(){var i;this._unblockDocumentLoadEvent();const a=yield this._otherError(e||"pdfjs-loading-error",n);this.eventBus.dispatch("documenterror",{source:this,message:a,reason:(i=n==null?void 0:n.message)!=null?i:null})})}_otherError(e,n=null){return se(this,null,function*(){const a=window.siyuan.languages[e]||e,i=[`PDF.js v${ae.version||"?"} (build: ${ae.build||"?"})`];return n&&(i.push(`Message: ${n.message}`),n.stack?i.push(`Stack: ${n.stack}`):(n.filename&&i.push(`File: ${n.filename}`),n.lineNumber&&i.push(`Line: ${n.lineNumber}`))),console.error(`${a}

${i.join(`
`)}`),a})}progress(e){var a,i;const n=Math.round(e*100);!this.loadingBar||n<=this.loadingBar.percent||(this.loadingBar.percent=n,((i=(a=this.pdfDocument)==null?void 0:a.loadingParams.disableAutoFetch)!=null?i:ge.get("disableAutoFetch"))&&this.loadingBar.setDisableAutoFetch())}load(e){var d,u,m,f;this.pdfDocument=e,e.getDownloadInfo().then(({length:g})=>{var h;this._contentLength=g,(h=this.loadingBar)==null||h.hide(),l.then(()=>{this.eventBus.dispatch("documentloaded",{source:this})})});const n=e.getPageLayout().catch(()=>{}),a=e.getPageMode().catch(()=>{}),i=e.getOpenAction().catch(()=>{});if((d=this.toolbar)==null||d.setPagesCount(e.numPages,!1),(u=this.secondaryToolbar)==null||u.setPagesCount(e.numPages),typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")){const g=location.href.split("#",1)[0];this.pdfLinkService.setDocument(e,(0,ae.isDataScheme)(g)?null:g)}else this.pdfLinkService.setDocument(e);(m=this.pdfDocumentProperties)==null||m.setDocument(e);const s=this.pdfViewer;s.setDocument(e);const{firstPagePromise:l,onePageRendered:o,pagesPromise:r}=s;(f=this.pdfThumbnailViewer)==null||f.setDocument(e);const c=(this.store=new VT(e.fingerprints[0])).getMultiple({page:null,zoom:sd,scrollLeft:"0",scrollTop:"0",rotation:null,sidebarView:Ke.UNKNOWN,scrollMode:Ve.UNKNOWN,spreadMode:Bt.UNKNOWN}).catch(()=>{});l.then(g=>{var h;(h=this.loadingBar)==null||h.setWidth(this.appConfig.viewerContainer),this._initializeAnnotationStorageCallbacks(e),Promise.all([uC,c,n,a,i]).then($=>se(this,[$],function*([b,y,w,E,C]){const M=ge.get("viewOnLoad");this._initializePdfHistory({fingerprint:e.fingerprints[0],viewOnLoad:M,initialDest:C==null?void 0:C.dest});const k=this.initialBookmark,_=ge.get("defaultZoomValue");let v=_?`zoom=${_}`:null,S=null,L=ge.get("sidebarViewOnLoad"),D=ge.get("scrollModeOnLoad"),I=ge.get("spreadModeOnLoad");y.page=this.pdfId||y.page,y!=null&&y.page&&M!==jb.INITIAL&&(v=`page=${y.page}&zoom=${_||y.zoom},${y.scrollLeft}${this.pdfId?"":","+y.scrollTop}`,S=parseInt(y.rotation,10),L===Ke.UNKNOWN&&(L=y.sidebarView|0),D===Ve.UNKNOWN&&(D=y.scrollMode|0),I===Bt.UNKNOWN&&(I=y.spreadMode|0)),v.indexOf("page=")===-1&&this.pdfId&&(v+=`&page=${this.pdfId}`),E&&L===Ke.UNKNOWN&&(L=mC(E)),w&&D===Ve.UNKNOWN&&I===Bt.UNKNOWN&&(I=nk(w).spreadMode),this.setInitialView(v,{rotation:S,sidebarView:L,scrollMode:D,spreadMode:I}),this.eventBus.dispatch("documentinit",{source:this}),this.isViewerEmbedded||s.focus(),yield Promise.race([r,new Promise(q=>{setTimeout(q,YT)})]),!(!k&&!v)&&(s.hasEqualPageSizes||(this.initialBookmark=k,s.currentScaleValue=s.currentScaleValue,this.setInitialView(v)))})).catch(()=>{this.setInitialView()}).then(function(){s.update();const b=T(s.container,"fn__flex-1");b&&b.removeAttribute("data-loading")})}),r.then(()=>{this._unblockDocumentLoadEvent(),this._initializeAutoPrint(e,i)},g=>{this._documentError("pdfjs-loading-error",{message:g.message})}),o.then(g=>{this.externalServices.reportTelemetry({type:"pageInfo",timestamp:g.timestamp}),this.pdfOutlineViewer&&e.getOutline().then(h=>{e===this.pdfDocument&&this.pdfOutlineViewer.render({outline:h,pdfDocument:e})}),this.pdfAttachmentViewer&&e.getAttachments().then(h=>{e===this.pdfDocument&&this.pdfAttachmentViewer.render({attachments:h})}),this.pdfLayerViewer&&s.optionalContentConfigPromise.then(h=>{e===this.pdfDocument&&this.pdfLayerViewer.render({optionalContentConfig:h,pdfDocument:e})})}),this._initializePageLabels(e),this._initializeMetadata(e)}_scriptingDocProperties(e){return se(this,null,function*(){var n,a;return!this.documentInfo&&(yield new Promise(i=>{this.eventBus._on("metadataloaded",i,{once:!0})}),e!==this.pdfDocument)||!this._contentLength&&(yield new Promise(i=>{this.eventBus._on("documentloaded",i,{once:!0})}),e!==this.pdfDocument)?null:ml(aa({},this.documentInfo),{baseURL:this.baseUrl,filesize:this._contentLength,filename:this._docFilename,metadata:(n=this.metadata)==null?void 0:n.getRaw(),authors:(a=this.metadata)==null?void 0:a.get("dc:creator"),numPages:this.pagesCount,URL:this.url})})}_initializeAutoPrint(e,n){return se(this,null,function*(){const[a,i]=yield Promise.all([n,this.pdfViewer.enableScripting?null:e.getJSActions()]);if(e!==this.pdfDocument)return;let s=(a==null?void 0:a.action)==="Print";if(i){console.warn("Warning: JavaScript support is not enabled");for(const l in i){if(s)break;switch(l){case"WillClose":case"WillSave":case"DidSave":case"WillPrint":case"DidPrint":continue}s=i[l].some(o=>oC.test(o))}}s&&this.triggerPrinting()})}_initializeMetadata(e){return se(this,null,function*(){var r,c;const{info:n,metadata:a,contentDispositionFilename:i,contentLength:s}=yield e.getMetadata();if(e!==this.pdfDocument)return;this.documentInfo=n,this.metadata=a,(r=this._contentDispositionFilename)!=null||(this._contentDispositionFilename=i),(c=this._contentLength)!=null||(this._contentLength=s);let l=n.Title;const o=a==null?void 0:a.get("dc:title");o&&o!=="Untitled"&&!/[\uFFF0-\uFFFF]/g.test(o)&&(l=o),l?this.setTitle(`${l} - ${this._contentDispositionFilename||this._title}`):this._contentDispositionFilename&&this.setTitle(this._contentDispositionFilename),n.IsXFAPresent&&!n.IsAcroFormPresent&&!e.isPureXfa?e.loadingParams.enableXfa?console.warn("Warning: XFA Foreground documents are not supported"):console.warn("Warning: XFA support is not enabled"):(n.IsAcroFormPresent||n.IsXFAPresent)&&!this.pdfViewer.renderForms&&console.warn("Warning: Interactive form support is not enabled"),n.IsSignaturesPresent&&console.warn("Warning: Digital signatures validation is not supported"),this.eventBus.dispatch("metadataloaded",{source:this})})}_initializePageLabels(e){return se(this,null,function*(){if(typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))return;const n=yield e.getPageLabels();if(e!==this.pdfDocument||!n||ge.get("disablePageLabels"))return;const a=n.length;let i=0,s=0;for(let c=0;c<a;c++){const d=n[c];if(d===(c+1).toString())i++;else if(d==="")s++;else break}if(i>=a||s>=a)return;const{pdfViewer:l,pdfThumbnailViewer:o,toolbar:r}=this;l.setPageLabels(n),o==null||o.setPageLabels(n),r==null||r.setPagesCount(a,!0),r==null||r.setPageNumber(l.currentPageNumber,l.currentPageLabel)})}_initializePdfHistory({fingerprint:e,viewOnLoad:n,initialDest:a=null}){this.pdfHistory&&(this.pdfHistory.initialize({fingerprint:e,resetHistory:n===jb.INITIAL,updateUrl:ge.get("historyUpdateUrl")}),this.pdfHistory.initialBookmark&&(this.initialBookmark=this.pdfHistory.initialBookmark,this.initialRotation=this.pdfHistory.initialRotation),a&&!this.initialBookmark&&n===jb.UNKNOWN&&(this.initialBookmark=JSON.stringify(a),this.pdfHistory.push({explicitDest:a,pageNumber:null})))}_initializeAnnotationStorageCallbacks(e){if(e!==this.pdfDocument)return;const{annotationStorage:n}=e;n.onSetModified=()=>{(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this._annotationStorageModified=!0)},n.onResetModified=()=>{(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&delete this._annotationStorageModified},n.onAnnotationEditor=a=>{this._hasAnnotationEditors=!!a,this.setTitle()}}setInitialView(e,{rotation:n,sidebarView:a,scrollMode:i,spreadMode:s}={}){var r,c,d;const l=u=>{Hp(u)&&(this.pdfViewer.pagesRotation=u)},o=(u,m)=>{QE(u)&&(this.pdfViewer.scrollMode=u),ek(m)&&(this.pdfViewer.spreadMode=m)};this.isInitialViewSet=!0,(r=this.pdfSidebar)==null||r.setInitialView(a),o(i,s),this.initialBookmark?(l(this.initialRotation),delete this.initialRotation,this.pdfLinkService.setHash(this.initialBookmark),this.initialBookmark=null):e&&(l(n),this.pdfLinkService.setHash(e)),(c=this.toolbar)==null||c.setPageNumber(this.pdfViewer.currentPageNumber,this.pdfViewer.currentPageLabel),(d=this.secondaryToolbar)==null||d.setPageNumber(this.pdfViewer.currentPageNumber),this.pdfViewer.currentScaleValue||(this.pdfViewer.currentScaleValue=sd)}_cleanup(){var e;this.pdfDocument&&(this.pdfViewer.cleanup(),(e=this.pdfThumbnailViewer)==null||e.cleanup(),this.pdfDocument.cleanup(ge.get("fontExtraProperties")))}forceRendering(){var e;this.pdfRenderingQueue.printing=!!this.printService,this.pdfRenderingQueue.isThumbnailViewEnabled=((e=this.pdfSidebar)==null?void 0:e.visibleView)===Ke.THUMBS,this.pdfRenderingQueue.renderHighestPriority()}beforePrint(){var e;if(this._printAnnotationStoragePromise=this.pdfScriptingManager.dispatchWillPrint().catch(()=>{}).then(()=>{var n;return(n=this.pdfDocument)==null?void 0:n.annotationStorage.print}),!this.printService){if(!this.supportsPrinting){this._otherError(window.siyuan.languages.printingNotSupported);return}if(!this.pdfViewer.pageViewsReady){this.l10n.get("pdfjs-printing-not-ready").then(n=>{window.alert(n)});return}this.printService=vk.createPrintService({pdfDocument:this.pdfDocument,pagesOverview:this.pdfViewer.getPagesOverview(),printContainer:this.appConfig.printContainer,printResolution:ge.get("printResolution"),printAnnotationStoragePromise:this._printAnnotationStoragePromise}),this.forceRendering(),this.setTitle(),this.printService.layout(),this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"print",stats:(e=this.pdfDocument)==null?void 0:e.annotationStorage.editorStats}})}}afterPrint(){var e;this._printAnnotationStoragePromise&&(this._printAnnotationStoragePromise.then(()=>{this.pdfScriptingManager.dispatchDidPrint()}),this._printAnnotationStoragePromise=null),this.printService&&(this.printService.destroy(),this.printService=null,(e=this.pdfDocument)==null||e.annotationStorage.resetModified()),this.forceRendering(),this.setTitle()}rotatePages(e){this.pdfViewer.pagesRotation+=e}requestPresentationMode(){var e;(e=this.pdfPresentationMode)==null||e.request()}triggerPrinting(){this.supportsPrinting&&window.print()}bindEvents(){if(this._eventBusAbortController)return;this._eventBusAbortController=new AbortController;const{eventBus:e,externalServices:n,pdfDocumentProperties:a,pdfViewer:i,preferences:s,_eventBusAbortController:{signal:l}}=this;e._on("resize",t3.bind(this),{signal:l}),e._on("hashchange",n3.bind(this),{signal:l}),e._on("beforeprint",this.beforePrint.bind(this),{signal:l}),e._on("afterprint",this.afterPrint.bind(this),{signal:l}),e._on("pagerender",KT.bind(this),{signal:l}),e._on("pagerendered",ZT.bind(this),{signal:l}),e._on("updateviewarea",e3.bind(this),{signal:l}),e._on("pagechanging",c3.bind(this),{signal:l}),e._on("scalechanging",o3.bind(this),{signal:l}),e._on("rotationchanging",r3.bind(this),{signal:l}),e._on("sidebarviewchanged",QT.bind(this),{signal:l}),e._on("pagemode",JT.bind(this),{signal:l}),e._on("namedaction",XT.bind(this),{signal:l}),e._on("presentationmodechanged",o=>i.presentationModeState=o.state,{signal:l}),e._on("presentationmode",this.requestPresentationMode.bind(this),{signal:l}),e._on("switchannotationeditormode",o=>i.annotationEditorMode=o,{signal:l}),e._on("print",this.triggerPrinting.bind(this),{signal:l}),e._on("download",this.downloadOrSave.bind(this),{signal:l}),e._on("firstpage",()=>this.page=1,{signal:l}),e._on("lastpage",()=>this.page=this.pagesCount,{signal:l}),e._on("nextpage",()=>i.nextPage(),{signal:l}),e._on("previouspage",()=>i.previousPage(),{signal:l}),e._on("zoomin",this.zoomIn.bind(this),{signal:l}),e._on("zoomout",this.zoomOut.bind(this),{signal:l}),e._on("zoomreset",this.zoomReset.bind(this),{signal:l}),e._on("pagenumberchanged",Kb.bind(this),{signal:l}),e._on("scalechanged",o=>i.currentScaleValue=o.value,{signal:l}),e._on("rotatecw",this.rotatePages.bind(this,90),{signal:l}),e._on("rotateccw",this.rotatePages.bind(this,-90),{signal:l}),e._on("optionalcontentconfig",o=>i.optionalContentConfigPromise=o.promise,{signal:l}),e._on("switchscrollmode",o=>i.scrollMode=o.mode,{signal:l}),e._on("scrollmodechanged",qk.bind(this,"scrollMode"),{signal:l}),e._on("switchspreadmode",o=>i.spreadMode=o.mode,{signal:l}),e._on("spreadmodechanged",qk.bind(this,"spreadMode"),{signal:l}),e._on("imagealttextsettings",a3.bind(this),{signal:l}),e._on("documentproperties",()=>a==null?void 0:a.open(),{signal:l}),e._on("findfromurlhash",i3.bind(this),{signal:l}),e._on("updatefindmatchescount",s3.bind(this),{signal:l}),e._on("updatefindcontrolstate",l3.bind(this),{signal:l}),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(e._on("fileinputchange",GT.bind(this),{signal:l}),e._on("openfile",jT.bind(this),{signal:l})),typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")&&(e._on("annotationeditorstateschanged",o=>n.updateEditorStates(o),{signal:l}),e._on("reporttelemetry",o=>n.reportTelemetry(o.details),{signal:l})),(typeof PDFJSDev=="undefined"||PDFJSDev.test("TESTING || MOZCENTRAL"))&&e._on("setpreference",o=>s.set(o.name,o.value),{signal:l})}bindWindowEvents(){if(this._windowAbortController)return;this._windowAbortController=new AbortController;const{eventBus:e,appConfig:{mainContainer:n},pdfViewer:a,_windowAbortController:{signal:i}}=this;function s(c=null){c&&a.refresh(),window.matchMedia(`(resolution: ${window.devicePixelRatio||1}dppx)`).addEventListener("change",s,{once:!0,signal:i})}s();const l=T(n,"pdf__outer");if(l.addEventListener("wheel",d3.bind(this),{passive:!1,signal:i}),l.addEventListener("touchstart",u3.bind(this),{passive:!1,signal:i}),l.addEventListener("touchmove",f3.bind(this),{passive:!1,signal:i}),l.addEventListener("touchend",p3.bind(this),{passive:!1,signal:i}),l.addEventListener("click",g3.bind(this),{signal:i}),window.removeEventListener("keydown",Uk,{signal:i}),window.addEventListener("keydown",Uk,{signal:i}),window.removeEventListener("keyup",Fk,{signal:i}),window.addEventListener("keyup",Fk,{signal:i}),(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&!("onscrollend"in document.documentElement))return;(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&({scrollTop:this._lastScrollTop,scrollLeft:this._lastScrollLeft}=n);const o=()=>{(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&({scrollTop:this._lastScrollTop,scrollLeft:this._lastScrollLeft}=n),this._isScrolling=!1,n.addEventListener("scroll",r,{passive:!0,signal:i}),n.removeEventListener("scrollend",o),n.removeEventListener("blur",o)},r=()=>{this._isCtrlKeyDown||(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&this._lastScrollTop===n.scrollTop&&this._lastScrollLeft===n.scrollLeft||(n.removeEventListener("scroll",r,{passive:!0}),this._isScrolling=!0,n.addEventListener("scrollend",o,{signal:i}),n.addEventListener("blur",o,{signal:i}))};n.addEventListener("scroll",r,{passive:!0,signal:i})}unbindEvents(){var e;(e=this._eventBusAbortController)==null||e.abort(),this._eventBusAbortController=null}unbindWindowEvents(){var e;(e=this._windowAbortController)==null||e.abort(),this._windowAbortController=null}testingClose(){return se(this,null,function*(){var e,n,a;this.unbindEvents(),this.unbindWindowEvents(),(e=this._globalAbortController)==null||e.abort(),this._globalAbortController=null,(n=this.findBar)==null||n.close(),yield Promise.all([(a=this.l10n)==null?void 0:a.destroy(),this.close()])})}_accumulateTicks(e,n){(this[n]>0&&e<0||this[n]<0&&e>0)&&(this[n]=0),this[n]+=e;const a=Math.trunc(this[n]);return this[n]-=a,a}_accumulateFactor(e,n,a){if(n===1)return 1;(this[a]>1&&n<1||this[a]<1&&n>1)&&(this[a]=1);const i=Math.floor(e*n*this[a]*100)/(100*e);return this[a]=n/i,i}_unblockDocumentLoadEvent(){var e;(e=document.blockUnblockOnload)==null||e.call(document,!1),this._unblockDocumentLoadEvent=()=>{}}get scriptingReady(){return this.pdfScriptingManager.ready}}if(typeof PDFJSDev=="undefined"||PDFJSDev.test("MOZCENTRAL"),typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){const t=["null","http://mozilla.github.io","https://mozilla.github.io"];var zT=function(e){if(e)try{const n=new URL(window.location.href).origin||"null";if(t.includes(n))return;if(new URL(e,window.location.href).origin!==n)throw new Error("file origin does not match viewer's")}catch(n){throw console.log(window.siyuan.languages.loadingError,n.message),n}},GT=function(e){var a;if((a=this.pdfViewer)!=null&&a.isInPresentationMode)return;const n=e.fileInput.files[0];this.open({url:URL.createObjectURL(n),originalUrl:n.name})},jT=function(e){var n;(n=this._openFileInput)==null||n.click()}}function KT({pageNumber:t}){var e;t===this.page&&((e=this.toolbar)==null||e.updateLoadingIndicatorState(!0))}function ZT({pageNumber:t,error:e}){var n,a,i;if(t===this.page&&((n=this.toolbar)==null||n.updateLoadingIndicatorState(!1)),((a=this.pdfSidebar)==null?void 0:a.visibleView)===Ke.THUMBS){const s=this.pdfViewer.getPageView(t-1),l=(i=this.pdfThumbnailViewer)==null?void 0:i.getThumbnail(t-1);s&&(l==null||l.setImage(s))}e&&this._otherError("pdfjs-rendering-error",e)}function JT({mode:t}){var n;let e;switch(t){case"thumbs":e=Ke.THUMBS;break;case"bookmarks":case"outline":e=Ke.OUTLINE;break;case"attachments":e=Ke.ATTACHMENTS;break;case"layers":e=Ke.LAYERS;break;case"none":e=Ke.NONE;break;default:console.error('Invalid "pagemode" hash parameter: '+t);return}(n=this.pdfSidebar)==null||n.switchView(e,!0)}function XT(t){var e,n;switch(t.action){case"GoToPage":(e=this.appConfig.toolbar)==null||e.pageNumber.select();break;case"Find":this.supportsIntegratedFind||(n=this.findBar)==null||n.toggle();break;case"Print":this.triggerPrinting();break;case"SaveAs":this.downloadOrSave();break}}function QT({view:t}){var e;this.pdfRenderingQueue.isThumbnailViewEnabled=t===Ke.THUMBS,this.isInitialViewSet&&((e=this.store)==null||e.set("sidebarView",t).catch(()=>{}))}function e3({location:t}){var e;this.isInitialViewSet&&((e=this.store)==null||e.setMultiple({page:t.pageNumber,zoom:t.scale,scrollLeft:t.left,scrollTop:t.top,rotation:t.rotation}).catch(()=>{})),this.appConfig.secondaryToolbar&&(this.appConfig.secondaryToolbar.viewBookmarkButton.href=this.pdfLinkService.getAnchorUrl(t.pdfOpenParams))}function qk(t,e){var n;this.isInitialViewSet&&!this.pdfViewer.isInPresentationMode&&((n=this.store)==null||n.set(t,e.mode).catch(()=>{}))}function t3(){const{pdfDocument:t,pdfViewer:e,pdfRenderingQueue:n}=this;if(n.printing&&window.matchMedia("print").matches||!t)return;const a=e.currentScaleValue;(a==="auto"||a==="page-fit"||a==="page-width")&&(e.currentScaleValue=a),e.update()}function n3(t){var n;const e=t.hash;e&&(this.isInitialViewSet?(n=this.pdfHistory)!=null&&n.popStateInProgress||this.pdfLinkService.setHash(e):this.initialBookmark=e)}function Kb(t){var a;let e=this;t.pdfInstance&&(e=t.pdfInstance);const{pdfViewer:n}=e;t.value!==""&&e.pdfLinkService.goToPage(t.value),t.id&&Pk(e.pdfViewer.container,t.id),t.value!==n.currentPageNumber.toString()&&t.value!==n.currentPageLabel&&((a=e.toolbar)==null||a.setPageNumber(n.currentPageNumber,n.currentPageLabel))}function a3(){var t;(t=this.imageAltTextSettings)==null||t.open({enableGuessAltText:ge.get("enableGuessAltText"),enableNewAltTextWhenAddingImage:ge.get("enableNewAltTextWhenAddingImage")})}function i3(t){this.eventBus.dispatch("find",{source:t.source,type:"",query:t.query,caseSensitive:!1,entireWord:!1,highlightAll:!0,findPrevious:!1,matchDiacritics:!0})}function s3({matchesCount:t}){var e;this.supportsIntegratedFind?this.externalServices.updateFindMatchesCount(t):(e=this.findBar)==null||e.updateResultsCount(t)}function l3({state:t,previous:e,entireWord:n,matchesCount:a,rawQuery:i}){var s;this.supportsIntegratedFind?this.externalServices.updateFindControlState({result:t,findPrevious:e,entireWord:n,matchesCount:a,rawQuery:i}):(s=this.findBar)==null||s.updateUIState(t,e,a)}function o3(t){var e;(e=this.toolbar)==null||e.setPageScale(t.presetValue,t.scale),this.pdfViewer.update()}function r3(t){this.pdfThumbnailViewer&&(this.pdfThumbnailViewer.pagesRotation=t.pagesRotation),this.forceRendering(),this.pdfViewer.currentPageNumber=t.pageNumber}function c3({pageNumber:t,pageLabel:e}){var a,i,s,l,o;(a=this.toolbar)==null||a.setPageNumber(t,e),(i=this.secondaryToolbar)==null||i.setPageNumber(t),((s=this.pdfSidebar)==null?void 0:s.visibleView)===Ke.THUMBS&&((l=this.pdfThumbnailViewer)==null||l.scrollThumbnailIntoView(t));const n=this.pdfViewer.getPageView(t-1);(o=this.toolbar)==null||o.updateLoadingIndicatorState((n==null?void 0:n.renderingState)===it.RUNNING)}function d3(t){const{pdfViewer:e,supportsMouseWheelZoomCtrlKey:n,supportsMouseWheelZoomMetaKey:a,supportsPinchToZoom:i}=this;if(e.isInPresentationMode)return;const s=t.deltaMode;let l=Math.exp(-t.deltaY/100);const o=typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")&&ae.FeatureTest.platform.isMac,r=t.ctrlKey&&!this._isCtrlKeyDown&&s===WheelEvent.DOM_DELTA_PIXEL&&t.deltaX===0&&(Math.abs(l-1)<.05||o)&&t.deltaZ===0,c=[t.clientX,t.clientY];if(r||t.ctrlKey&&n||t.metaKey&&a){if(t.preventDefault(),this._isScrolling||document.visibilityState==="hidden"||this.overlayManager.active)return;if(r&&i)l=this._accumulateFactor(e.currentScale,l,"_wheelUnusedFactor"),this.updateZoom(null,l,c);else{const d=XE(t);let u=0;s===WheelEvent.DOM_DELTA_LINE||s===WheelEvent.DOM_DELTA_PAGE?u=Math.abs(d)>=1?Math.sign(d):this._accumulateTicks(d,"_wheelUnusedTicks"):u=this._accumulateTicks(d/30,"_wheelUnusedTicks"),this.updateZoom(u,null,c)}}}function u3(t){if(this.pdfViewer.isInPresentationMode||t.touches.length<2)return;if(t.preventDefault(),t.touches.length!==2||this.overlayManager.active){this._touchInfo=null;return}let[e,n]=t.touches;e.identifier>n.identifier&&([e,n]=[n,e]),this._touchInfo={touch0X:e.pageX,touch0Y:e.pageY,touch1X:n.pageX,touch1Y:n.pageY}}function f3(t){if(!this._touchInfo||t.touches.length!==2)return;const{pdfViewer:e,_touchInfo:n,supportsPinchToZoom:a}=this;let[i,s]=t.touches;i.identifier>s.identifier&&([i,s]=[s,i]);const{pageX:l,pageY:o}=i,{pageX:r,pageY:c}=s,{touch0X:d,touch0Y:u,touch1X:m,touch1Y:f}=n;if(Math.abs(d-l)<=1&&Math.abs(u-o)<=1&&Math.abs(m-r)<=1&&Math.abs(f-c)<=1)return;if(n.touch0X=l,n.touch0Y=o,n.touch1X=r,n.touch1Y=c,d===l&&u===o){const y=m-l,w=f-o,E=r-l,C=c-o,$=y*C-w*E;if(Math.abs($)>.02*Math.hypot(y,w)*Math.hypot(E,C))return}else if(m===r&&f===c){const y=d-r,w=u-c,E=l-r,C=o-c,$=y*C-w*E;if(Math.abs($)>.02*Math.hypot(y,w)*Math.hypot(E,C))return}else{const y=l-d,w=r-m,E=o-u,C=c-f;if(y*w+E*C>=0)return}t.preventDefault();const g=[(l+r)/2,(o+c)/2],h=Math.hypot(l-r,o-c)||1,b=Math.hypot(d-m,u-f)||1;if(a){const y=this._accumulateFactor(e.currentScale,h/b,"_touchUnusedFactor");this.updateZoom(null,y,g)}else{const w=this._accumulateTicks((h-b)/30,"_touchUnusedTicks");this.updateZoom(w,null,g)}}function p3(t){this._touchInfo&&(t.preventDefault(),this._touchInfo=null,this._touchUnusedTicks=0,this._touchUnusedFactor=1)}function g3(t){var n,a,i;if(["SELECT","TEXTAREA","INPUT"].includes(t.target.tagName)||this.pdfViewer.focus(),!((n=this.secondaryToolbar)!=null&&n.isOpen))return;const e=this.appConfig;(this.pdfViewer.containsElement(t.target)||(a=e.toolbar)!=null&&a.container.contains(t.target)&&!((i=e.secondaryToolbar)!=null&&i.toggleButton.contains(t.target)))&&this.secondaryToolbar.close()}function Fk(t){const e=zb(t.target);e&&(["SELECT","TEXTAREA","INPUT"].includes(t.target.tagName)||e.pdfViewer.focus(),t.key==="Control"&&(e._isCtrlKeyDown=!1),([92,91,68].includes(t.keyCode)||t.ctrlKey||t.altKey)&&e.appConfig.toolbar.rectAnno.classList.contains("toggled")&&e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")))}function Uk(t){var d,u,m,f,g,h;const e=zb(t.target);if(!e||(e._isCtrlKeyDown=t.key==="Control",e.overlayManager.active))return;const{eventBus:n,pdfViewer:a}=e,i=a.isInPresentationMode;let s=!1,l=!1;const o=(t.ctrlKey?1:0)|(t.altKey?2:0)|(t.shiftKey?4:0)|(t.metaKey?8:0);if(o===0&&[38,40].includes(t.keyCode)){document.activeElement&&document.activeElement.blur(),setTimeout(()=>{a.focus()});return}if(!t.repeat&&(o===8||o===1||o===2)&&t.keyCode===68&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")),t.preventDefault();return}if(!t.repeat&&o!==1&&o!==2&&o!==4&&o!==8&&[48,49,50,51,52,53,54,55].includes(t.keyCode)&&getSelection().rangeCount>0&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){const b=getSelection().getRangeAt(0);if(b.toString()!==""&&T(b.commonAncestorContainer,"pdfViewer")){e.appConfig.appContainer.dispatchEvent(new CustomEvent("click",{detail:(t.keyCode-48).toString()})),t.preventDefault();return}}if(o===1||o===8||o===5||o===12)switch(t.keyCode){case 70:!e.supportsIntegratedFind&&!t.shiftKey&&((d=e.findBar)==null||d.open(),s=!0);break;case 71:if(!e.supportsIntegratedFind){const{state:b}=e.findController;if(b){const y={source:window,type:"again",findPrevious:o===5||o===12};n.dispatch("find",aa(aa({},b),y))}s=!0}break;case 61:case 107:case 187:case 171:e.zoomIn(),s=!0;break;case 173:case 109:case 189:e.zoomOut(),s=!0;break;case 48:case 96:i||(setTimeout(()=>{e.zoomReset()}),s=!1);break;case 38:(i||e.page>1)&&(e.page=1,s=!0,l=!0);break;case 40:(i||e.page<e.pagesCount)&&(e.page=e.pagesCount,s=!0,l=!0);break}if((typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC || CHROME"))&&(o===1||o===8))switch(t.keyCode){case 83:n.dispatch("download",{source:window}),s=!0;break;case 79:(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(n.dispatch("openfile",{source:window}),s=!0);break}if(o===3||o===10)switch(t.keyCode){case 80:e.requestPresentationMode(),s=!0,e.externalServices.reportTelemetry({type:"buttons",data:{id:"presentationModeKeyboard"}});break;case 71:e.appConfig.toolbar&&(e.appConfig.toolbar.pageNumber.select(),s=!0);break}if(s){l&&!i&&a.focus(),t.preventDefault();return}const r=gC(),c=r==null?void 0:r.tagName.toUpperCase();if(!((c==="INPUT"||c==="TEXTAREA"||c==="SELECT"||c==="BUTTON"&&(t.keyCode===13||t.keyCode===32)||r!=null&&r.isContentEditable)&&t.keyCode!==27)){if(o===0){let b=0,y=!1;switch(t.keyCode){case 38:if(e.supportsCaretBrowsingMode){e.moveCaret(!0,!1),s=!0;break}case 33:a.isVerticalScrollbarEnabled&&(y=!0),b=-1;break;case 8:i||(y=!0),b=-1;break;case 37:if(e.supportsCaretBrowsingMode)return;a.isHorizontalScrollbarEnabled&&(y=!0);case 75:case 80:b=-1;break;case 27:(u=e.secondaryToolbar)!=null&&u.isOpen&&(e.secondaryToolbar.close(),s=!0),!e.supportsIntegratedFind&&((m=e.findBar)!=null&&m.opened)&&(e.findBar.close(),s=!0);break;case 40:if(e.supportsCaretBrowsingMode){e.moveCaret(!1,!1),s=!0;break}case 34:a.isVerticalScrollbarEnabled&&(y=!0),b=1;break;case 13:case 32:i||(y=!0),b=1;break;case 39:if(e.supportsCaretBrowsingMode)return;a.isHorizontalScrollbarEnabled&&(y=!0);case 74:case 78:b=1;break;case 36:(i||e.page>1)&&(e.page=1,s=!0,l=!0);break;case 35:(i||e.page<e.pagesCount)&&(e.page=e.pagesCount,s=!0,l=!0);break;case 83:(f=e.pdfCursorTools)==null||f.switchTool(Qn.SELECT);break;case 72:(g=e.pdfCursorTools)==null||g.switchTool(Qn.HAND);break;case 82:e.rotatePages(90);break;case 115:(h=e.pdfSidebar)==null||h.toggle();break}b!==0&&(!y||a.currentScaleValue==="page-fit")&&(b>0?a.nextPage():a.previousPage(),s=!0)}if(o===4)switch(t.keyCode){case 13:case 32:if(!i&&a.currentScaleValue!=="page-fit")break;a.previousPage(),s=!0;break;case 38:e.moveCaret(!0,!0),s=!0;break;case 40:e.moveCaret(!1,!0),s=!0;break;case 82:e.rotatePages(-90);break}!s&&!i&&(t.keyCode>=33&&t.keyCode<=40||t.keyCode===32&&c!=="BUTTON")&&(l=!0),l&&!a.containsElement(r)&&a.focus(),s&&t.preventDefault()}}function xD(t){return t.preventDefault(),t.returnValue="",!1}const CD=typeof PDFJSDev!="undefined"?PDFJSDev.eval("BUNDLE_VERSION"):void 0,TD=typeof PDFJSDev!="undefined"?PDFJSDev.eval("BUNDLE_BUILD"):void 0,DD=typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?{LinkTarget:es,RenderingStates:it,ScrollMode:Ve,SpreadMode:Bt}:null;function m3(t){return{appContainer:t,principalContainer:t.querySelector("#mainContainer"),mainContainer:t.querySelector("#viewerContainer"),viewerContainer:t.querySelector("#viewer"),toolbar:{rectAnno:t.querySelector("#rectAnno"),container:t.querySelector("#toolbarContainer"),numPages:t.querySelector("#numPages"),pageNumber:t.querySelector("#pageNumber"),scaleSelect:t.querySelector("#scaleSelect"),customScaleOption:t.querySelector("#customScaleOption"),previous:t.querySelector("#previous"),next:t.querySelector("#next"),zoomIn:t.querySelector("#zoomInButton"),zoomOut:t.querySelector("#zoomOutButton"),print:t.querySelector("#printButton"),editorFreeTextButton:t.querySelector("#editorFreeTextButton"),editorFreeTextParamsToolbar:t.querySelector("#editorFreeTextParamsToolbar"),editorHighlightButton:t.querySelector("#editorHighlightButton"),editorHighlightParamsToolbar:t.querySelector("#editorHighlightParamsToolbar"),editorHighlightColorPicker:t.querySelector("#editorHighlightColorPicker"),editorInkButton:t.querySelector("#editorInkButton"),editorInkParamsToolbar:t.querySelector("#editorInkParamsToolbar"),editorStampButton:t.querySelector("#editorStampButton"),editorStampParamsToolbar:t.querySelector("#editorStampParamsToolbar"),download:t.querySelector("#downloadButton")},secondaryToolbar:{toolbar:t.querySelector("#secondaryToolbar"),toggleButton:t.querySelector("#secondaryToolbarToggleButton"),presentationModeButton:t.querySelector("#presentationMode"),openFileButton:typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?t.querySelector("#secondaryOpenFile"):null,printButton:t.querySelector("#secondaryPrint"),downloadButton:t.querySelector("#secondaryDownload"),viewBookmarkButton:t.querySelector("#viewBookmark"),firstPageButton:t.querySelector("#firstPage"),lastPageButton:t.querySelector("#lastPage"),pageRotateCwButton:t.querySelector("#pageRotateCw"),pageRotateCcwButton:t.querySelector("#pageRotateCcw"),cursorSelectToolButton:t.querySelector("#cursorSelectTool"),cursorHandToolButton:t.querySelector("#cursorHandTool"),scrollPageButton:t.querySelector("#scrollPage"),scrollVerticalButton:t.querySelector("#scrollVertical"),scrollHorizontalButton:t.querySelector("#scrollHorizontal"),scrollWrappedButton:t.querySelector("#scrollWrapped"),spreadNoneButton:t.querySelector("#spreadNone"),spreadOddButton:t.querySelector("#spreadOdd"),spreadEvenButton:t.querySelector("#spreadEven"),imageAltTextSettingsButton:t.querySelector("#imageAltTextSettings"),imageAltTextSettingsSeparator:t.querySelector("#imageAltTextSettingsSeparator"),documentPropertiesButton:t.querySelector("#documentProperties")},sidebar:{outerContainer:t.querySelector("#outerContainer"),sidebarContainer:t.querySelector("#sidebarContainer"),toggleButton:t.querySelector("#sidebarToggleButton"),resizer:t.querySelector("#sidebarResizer"),thumbnailButton:t.querySelector("#viewThumbnail"),outlineButton:t.querySelector("#viewOutline"),attachmentsButton:t.querySelector("#viewAttachments"),layersButton:t.querySelector("#viewLayers"),thumbnailView:t.querySelector("#thumbnailView"),outlineView:t.querySelector("#outlineView"),attachmentsView:t.querySelector("#attachmentsView"),layersView:t.querySelector("#layersView"),currentOutlineItemButton:t.querySelector("#currentOutlineItem")},findBar:{bar:t.querySelector("#findbar"),toggleButton:t.querySelector("#viewFindButton"),findField:t.querySelector("#findInput"),highlightAllCheckbox:t.querySelector("#findHighlightAll"),caseSensitiveCheckbox:t.querySelector("#findMatchCase"),matchDiacriticsCheckbox:t.querySelector("#findMatchDiacritics"),entireWordCheckbox:t.querySelector("#findEntireWord"),findMsg:t.querySelector("#findMsg"),findResultsCount:t.querySelector("#findResultsCount"),findPreviousButton:t.querySelector("#findPreviousButton"),findNextButton:t.querySelector("#findNextButton")},passwordOverlay:{dialog:t.querySelector("#passwordDialog"),label:t.querySelector("#passwordText"),input:t.querySelector("#password"),submitButton:t.querySelector("#passwordSubmit"),cancelButton:t.querySelector("#passwordCancel")},documentProperties:{dialog:t.querySelector("#documentPropertiesDialog"),closeButton:t.querySelector("#documentPropertiesClose"),fields:{fileName:t.querySelector("#fileNameField"),fileSize:t.querySelector("#fileSizeField"),title:t.querySelector("#titleField"),author:t.querySelector("#authorField"),subject:t.querySelector("#subjectField"),keywords:t.querySelector("#keywordsField"),creationDate:t.querySelector("#creationDateField"),modificationDate:t.querySelector("#modificationDateField"),creator:t.querySelector("#creatorField"),producer:t.querySelector("#producerField"),version:t.querySelector("#versionField"),pageCount:t.querySelector("#pageCountField"),pageSize:t.querySelector("#pageSizeField"),linearized:t.querySelector("#linearizedField")}},altTextDialog:{dialog:t.querySelector("#altTextDialog"),optionDescription:t.querySelector("#descriptionButton"),optionDecorative:t.querySelector("#decorativeButton"),textarea:t.querySelector("#descriptionTextarea"),cancelButton:t.querySelector("#altTextCancel"),saveButton:t.querySelector("#altTextSave")},newAltTextDialog:{dialog:t.querySelector("#newAltTextDialog"),title:t.querySelector("#newAltTextTitle"),descriptionContainer:t.querySelector("#newAltTextDescriptionContainer"),textarea:t.querySelector("#newAltTextDescriptionTextarea"),disclaimer:t.querySelector("#newAltTextDisclaimer"),learnMore:t.querySelector("#newAltTextLearnMore"),imagePreview:t.querySelector("#newAltTextImagePreview"),createAutomatically:t.querySelector("#newAltTextCreateAutomatically"),createAutomaticallyButton:t.querySelector("#newAltTextCreateAutomaticallyButton"),downloadModel:t.querySelector("#newAltTextDownloadModel"),downloadModelDescription:t.querySelector("#newAltTextDownloadModelDescription"),error:t.querySelector("#newAltTextError"),errorCloseButton:t.querySelector("#newAltTextCloseButton"),cancelButton:t.querySelector("#newAltTextCancel"),notNowButton:t.querySelector("#newAltTextNotNow"),saveButton:t.querySelector("#newAltTextSave")},altTextSettingsDialog:{dialog:t.querySelector("#altTextSettingsDialog"),createModelButton:t.querySelector("#createModelButton"),aiModelSettings:t.querySelector("#aiModelSettings"),learnMore:t.querySelector("#altTextSettingsLearnMore"),deleteModelButton:t.querySelector("#deleteModelButton"),downloadModelButton:t.querySelector("#downloadModelButton"),showAltTextDialogButton:t.querySelector("#showAltTextDialogButton"),altTextSettingsCloseButton:t.querySelector("#altTextSettingsCloseButton"),closeButton:t.querySelector("#altTextSettingsCloseButton")},annotationEditorParams:{editorFreeTextFontSize:t.querySelector("#editorFreeTextFontSize"),editorFreeTextColor:t.querySelector("#editorFreeTextColor"),editorInkColor:t.querySelector("#editorInkColor"),editorInkThickness:t.querySelector("#editorInkThickness"),editorInkOpacity:t.querySelector("#editorInkOpacity"),editorStampAddImage:t.querySelector("#editorStampAddImage"),editorFreeHighlightThickness:t.querySelector("#editorFreeHighlightThickness"),editorHighlightShowAll:t.querySelector("#editorHighlightShowAll")},printContainer:t.querySelector("#printContainer")}}function Wk(t,e,n,a){ge.set("workerSrc",`${p.PROTYLE_CDN}/js/pdf/pdf.worker.min.mjs?v=4.7.85`),ge.set("defaultUrl",t),ge.set("cMapUrl","cmaps/"),ge.set("standardFontDataUrl","standard_fonts/"),ge.set("annotationEditorMode",ae.AnnotationEditorType.DISABLE);const i=new Rk(n);i.annoId=a;const s=m3(e);if(s.file=t,typeof PDFJSDev!="undefined"&&PDFJSDev.test("GENERIC")){const l=new CustomEvent("webviewerloaded",{bubbles:!0,cancelable:!0,detail:{source:window}});try{parent.document.dispatchEvent(l)}catch(o){console.error(`webviewerloaded: ${o}`),document.dispatchEvent(l)}}return i.run(s),$T(e,i),i}(YS=document.blockUnblockOnload)==null||YS.call(document,!0);class ts extends ia{constructor(e){if(super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.path=e.path,this.pdfId=e.page,this.element.addEventListener("click",n=>{Qi(),gt(this.element.parentElement.parentElement),this.app.plugins.forEach(a=>{a.eventBus.emit("click-pdf",{event:n})})}),typeof this.pdfId=="string"){this.getPdfId(()=>{this.render()});return}else typeof this.pdfId=="number"&&(this.pdfPage=this.pdfId);this.render()}getPdfId(e){A("/api/asset/getFileAnnotation",{path:this.path+".sya"},n=>{if(n.code!==1){const a=JSON.parse(n.data.data);a[this.pdfId]?this.pdfPage=a[this.pdfId].page?a[this.pdfId].page+1:a[this.pdfId].pages[0].index+1:this.pdfPage=void 0}e()})}goToPage(e){if(!(typeof e=="undefined"||e===null)){if(this.pdfId=e,typeof e=="string"){this.getPdfId(()=>{this.pdfPage&&Kb({value:this.pdfPage,pdfInstance:this.pdfObject,id:this.pdfId})});return}typeof e=="number"&&!isNaN(e)&&Kb({value:this.pdfId,pdfInstance:this.pdfObject})}}render(){const e=this.path.substr(this.path.lastIndexOf(".")).toLowerCase().split("?")[0];if(p.SIYUAN_ASSETS_IMAGE.includes(e))this.element.innerHTML=`<div class="asset"><img src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></div>`;else if(p.SIYUAN_ASSETS_AUDIO.includes(e))this.element.innerHTML=`<div class="asset"><audio controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></audio></div>`;else if(p.SIYUAN_ASSETS_VIDEO.includes(e))this.element.innerHTML=`<div class="asset"><video controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></video></div>`;else if(e===".pdf"){this.element.innerHTML=`<div class="pdf__outer" id="outerContainer">
      <div id="sidebarContainer">
        <div id="toolbarSidebar">
          <div id="toolbarSidebarLeft">
              <button id="viewThumbnail" class="toolbarButton toggled b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.thumbsTitle}">
                <svg><use xlink:href="#iconImage"></use></svg>
              </button>
              <button id="viewOutline" class="toolbarButton b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.outline}">
                 <svg><use xlink:href="#iconAlignCenter"></use></svg>
              </button>
              <button id="viewAttachments" class="toolbarButton fn__none" data-l10n-id="attachments">
                 <span data-l10n-id="attachments_label">Attachments</span>
              </button>
              <button id="viewLayers" class="toolbarButton fn__none" data-l10n-id="layers">
                 <span data-l10n-id="layers_label">Layers</span>
              </button>
          </div>
          <div class="fn__flex-1"></div>
          <div id="toolbarSidebarRight">
            <div id="outlineOptionsContainer" class="fn__hidden">
              <button id="currentOutlineItem" class="toolbarButton b3-tooltips b3-tooltips__nw" disabled="disabled" aria-label="${window.siyuan.languages.focusOutline}">
                <svg><use xlink:href="#iconFocus"></use></svg>
              </button>
            </div>
          </div>
        </div>
        <div id="sidebarContent">
          <div id="thumbnailView">
          </div>
          <div id="outlineView" class="fn__hidden">
          </div>
          <div id="attachmentsView" class="fn__hidden">
          </div>
          <div id="layersView" class="fn__hidden">
          </div>
        </div>
        <div id="sidebarResizer"></div>
      </div>
      <div id="mainContainer">
        <div class="findbar b3-menu fn__hidden doorHanger" id="findbar">
            <input id="findInput" class="toolbarField b3-text-field" placeholder="${window.siyuan.languages.search}">
            <div class="fn__space"></div>
            <button id="findPreviousButton" class="toolbarButton findPrevious b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.previous}">
                <svg><use xlink:href="#iconUp"></use></svg>
            </button>
            <button id="findNextButton" class="toolbarButton findNext b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.next}">
                <svg><use xlink:href="#iconDown"></use></svg>
            </button>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findHighlightAll" class="toolbarField">
                ${window.siyuan.languages.findHighlight}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchCase" class="toolbarField">
                ${window.siyuan.languages.searchCaseSensitive}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchDiacritics" class="toolbarField">
                ${window.siyuan.languages.matchDiacritics}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findEntireWord" class="toolbarField">
                ${window.siyuan.languages.findEntireWord}
            </label>
            <div class="fn__space"></div>
            <span id="findResultsCount" class="b3-button b3-button--small b3-button--cancel"></span>
            <span id="findMsg" class="b3-button b3-button--small b3-button--cancel"></span>
        </div>  <!-- findbar -->
        <div id="secondaryToolbar" class="secondaryToolbar fn__hidden doorHangerRight b3-menu">
          <div id="secondaryToolbarButtonContainer" class="b3-menu__items">
            <button id="pdfLight" class="secondaryToolbarButton b3-menu__item toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconLight"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeLight}</span>
            </button>
            <button id="pdfDark" class="secondaryToolbarButton b3-menu__item">
              <svg class="b3-menu__icon"><use xlink:href="#iconDark"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeDark}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="previous" class="secondaryToolbarButton b3-menu__item pageUp">
              <svg class="b3-menu__icon"><use xlink:href="#iconUp"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.previousLabel}</span>
              <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe("P")}/${pe("K")}</span>
            </button>
            <button id="next" class="secondaryToolbarButton b3-menu__item pageDown">
              <svg class="b3-menu__icon"><use xlink:href="#iconDown"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.nextLabel}</span>
              <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe("J")}/${pe("N")}</span>
            </button>
            <button id="firstPage" class="secondaryToolbarButton b3-menu__item firstPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconBack"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.firstPage}</span>
              <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">Home</span>
            </button>
            <button id="lastPage" class="secondaryToolbarButton b3-menu__item lastPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconForward"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.lastPage}</span>
              <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">End</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="zoomOutButton" class="secondaryToolbarButton b3-menu__item zoomOut">
               <svg class="b3-menu__icon"><use xlink:href="#iconLine"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomOut}</span>
               <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe("\u2318-")}</span>
            </button>
            <button id="zoomInButton" class="secondaryToolbarButton b3-menu__item zoomIn">
               <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomIn}</span>
               <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe("\u2318=")}</span>
            </button>
            <button id="pageRotateCw" class="secondaryToolbarButton b3-menu__item rotateCw">
               <svg class="b3-menu__icon"><use xlink:href="#iconRedo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCw}</span>
               <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">R</span>
            </button>
            <button id="pageRotateCcw" class="secondaryToolbarButton b3-menu__item rotateCcw">
               <svg class="b3-menu__icon"><use xlink:href="#iconUndo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCcw}</span>
               <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe("\u21E7R")}</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator"></div>

            <button id="cursorSelectTool" class="secondaryToolbarButton b3-menu__item selectTool toggled">
               <svg class="b3-menu__icon"><use xlink:href="#iconSelectText"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.cursorText}</span>
               <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">S</span>
            </button>
            <button id="cursorHandTool" class="secondaryToolbarButton b3-menu__item handTool">
              <svg class="b3-menu__icon"><use xlink:href="#iconHand"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.cursorHand}</span>
              <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">H</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="scrollVertical" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollVertical toggled">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollVert"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollVertical}</span>
            </button>
            <button id="scrollHorizontal" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollHorizontal">
              <svg class="b3-menu__icon"><use xlink:href="#iconScrollHoriz"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollHorizontal}</span>
            </button>
            <button id="scrollWrapped" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollWrapped">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollWrapped"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollWrapped}</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator scrollModeButtons"></div>

            <button id="spreadNone" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadNone toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconFile"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadNone}</span>
            </button>
            <button id="spreadOdd" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadOdd">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadOdd"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadOdd}</span>
            </button>
            <button id="spreadEven" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadEven">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadEven"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadEven}</span>
            </button>
            <button id="presentationMode" class="secondaryToolbarButton b3-menu__item presentationMode">
              <svg class="b3-menu__icon"><use xlink:href="#iconPlay"></use></svg>
              <span class="b3-menu__label">${window.siyuan.languages.presentationMode}</span>
              <span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${pe("\u2325\u2318P")}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator spreadModeButtons"></div>
            <button id="documentProperties" class="secondaryToolbarButton b3-menu__item documentProperties">
              <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
            </button>
          </div>
        </div>  <!-- secondaryToolbar -->

        <div class="pdf__toolbar">
          <div id="toolbarContainer">
            <div id="toolbarViewer">
                <button id="sidebarToggleButton" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="sidebarContainer" aria-label="${window.siyuan.languages.toggleSidebarNotification2Title} ${pe("F4")}">
                    <svg><use xlink:href="#iconLayoutRight"></use></svg>
                </button>
                <button id="viewFindButton" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.search} ${pe("\u2318F")}">
                  <svg><use xlink:href="#iconSearch"></use></svg>
                </button>
                <button id="rectAnno" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.rectAnnotation} ${pe("\u2318D")}/${pe("\u2325D")}">
                  <svg><use xlink:href="#iconLeftTop"></use></svg>
                </button>
                <input type="number" id="pageNumber" class="toolbarField pageNumber b3-text-field" value="1" size="4" min="1" autocomplete="off">
                <span id="numPages"></span>
                <div class="fn__flex-1"></div>
                <span id="scaleSelectContainer" class="dropdownToolbarButton">
                  <select id="scaleSelect" class="b3-select">
                    <option id="pageAutoOption" value="auto" selected="selected">${window.siyuan.languages.pageScaleAuto}</option>
                    <option id="pageActualOption" value="page-actual">${window.siyuan.languages.pageScaleActual}</option>
                    <option id="pageFitOption" value="page-fit">${window.siyuan.languages.pageScaleFit}</option>
                    <option id="pageWidthOption" value="page-width">${window.siyuan.languages.pageScaleWidth}</option>
                    <option id="customScaleOption" value="custom" disabled="disabled" hidden="true"></option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1">100%</option>
                    <option value="1.25">125%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                    <option value="3">300%</option>
                    <option value="4">400%</option>
                  </select>
                </span>
                <span id="scrollPage" class="fn__none"></span>
                <span id="printButton" class="fn__none"></span>
                <span id="secondaryPrint" class="fn__none"></span>
                <span id="viewBookmark" class="fn__none"></span>
                <span id="secondaryViewBookmark" class="fn__none"></span>
                <button id="secondaryToolbarToggleButton" class="toolbarButton b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.more}" aria-expanded="false" aria-controls="secondaryToolbar">
                  <svg><use xlink:href="#iconMore"></use></svg>
                </button>
            </div>
            <div id="loadingBar">
              <div class="progress">
                <div class="glimmer">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewerContainer">
          <div id="viewer" class="pdfViewer"></div>
          <div class="pdf__resize fn__none"></div>
        </div>
        <div id="errorWrapper" hidden='true'>
          <div id="errorMessageLeft">
            <span id="errorMessage"></span>
            <button id="errorShowMore" data-l10n-id="error_more_info">
              More Information
            </button>
            <button id="errorShowLess" data-l10n-id="error_less_info" hidden='true'>
              Less Information
            </button>
          </div>
          <div id="errorMessageRight">
            <button id="errorClose" data-l10n-id="error_close">
              Close
            </button>
          </div>
          <div class="clearBoth"></div>
          <textarea id="errorMoreInfo" hidden='true' readonly="readonly"></textarea>
        </div>
      </div>
      <div id="dialogContainer">
        <div class="dialog" id="passwordDialog">
            <div class="row">
              <p id="passwordText" data-l10n-id="password_label">Enter the password to open this PDF file:</p>
            </div>
            <div class="row">
              <input type="password" id="password" class="toolbarField">
            </div>
            <div class="buttonRow">
              <button id="passwordCancel" class="overlayButton"><span data-l10n-id="password_cancel">Cancel</span></button>
              <button id="passwordSubmit" class="overlayButton"><span data-l10n-id="password_ok">OK</span></button>
            </div>
        </div>
        <div class="dialog" id="documentPropertiesDialog">
            <div class="row">
              <span>${window.siyuan.languages.fileName}</span> <p id="fileNameField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.fileSize}</span> <p id="fileSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.title1}</span> <p id="titleField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.author}</span> <p id="authorField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.subject}</span> <p id="subjectField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.keywords}</span> <p id="keywordsField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creationDate}</span> <p id="creationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.modificationDate}</span> <p id="modificationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creator}</span> <p id="creatorField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.producer}</span> <p id="producerField">-</p>
            </div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.version}</span> <p id="versionField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageCount}</span> <p id="pageCountField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageSize}</span> <p id="pageSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.linearized}</span> <p id="linearizedField">-</p>
            </div>
            <div class="buttonRow">
              <button id="documentPropertiesClose" class="b3-button"><span>${window.siyuan.languages.close}</span></button>
            </div>
        </div>
        <div class="dialog" id="printServiceOverlay">
            <div class="row">
              <span data-l10n-id="print_progress_message">Preparing document for printing\u2026</span>
            </div>
            <div class="row">
              <progress value="0" max="100"></progress>
              <span data-l10n-id="print_progress_percent" data-l10n-args='{ "progress": 0 }' class="relative-progress">0%</span>
            </div>
            <div class="buttonRow">
              <button id="printCancel" class="overlayButton"><span data-l10n-id="print_progress_close">Cancel</span></button>
            </div>
        </div>
      </div>
      <div class="pdf__util b3-menu fn__none pdf__util--hide">
        <div class="fn__flex" style="padding: 0 4px">
            <button class="color__square" style="background-color:var(--b3-pdf-background1)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background2)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background3)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background4)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background5)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background6)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background7)"></button>
        </div>
        <div class="b3-menu__separator pdf__util__hide" style="margin-top: 8px"></div>
        <button class="b3-menu__item pdf__util__hide" data-type="toggle">
            <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.showHideBg}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="copy">
            <svg class="b3-menu__icon"><use xlink:href="#iconRef"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.copyAnnotation}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="relate">
            <svg class="b3-menu__icon"><use xlink:href="#iconParagraph"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="remove">
            <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.remove}</span>
        </button>
      </div>
      <div class="fn__none">
        <input id="editorFreeTextFontSize">
        <input id="editorFreeTextColor">
        <input id="editorInkColor">
        <input id="editorInkThickness">
        <input id="editorInkOpacity">
        <input id="editorStampAddImage">
        <input id="editorFreeHighlightThickness">
        <input id="editorHighlightShowAll">
        <input id="downloadButton">
        <input id="secondaryDownload">
        <input id="editorFreeTextButton">
        <input id="openFile">
        <input id="editorInkButton">
        <input id="editorStampButton">
        <input id="editorHighlightButton">
        <input id="imageAltTextSettings">
        <input id="secondaryOpenFile">
      </div>
    </div> <!-- outerContainer -->
    <div id="printContainer"></div>`;const n=window.siyuan.storage[p.LOCAL_PDFTHEME],a=window.siyuan.config.appearance.mode===0?n.light:n.dark,i=this.element.querySelector("#pdfDark"),s=this.element.querySelector("#pdfLight");a==="dark"?(this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled")):(s.classList.add("toggled"),i.classList.remove("toggled")),s.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?n.light="light":n.dark="light",this.element.firstElementChild.classList.remove("pdf__outer--dark"),s.classList.add("toggled"),i.classList.remove("toggled"),Ee(p.LOCAL_PDFTHEME,window.siyuan.storage[p.LOCAL_PDFTHEME])}),i.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?n.light="dark":n.dark="dark",this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled"),Ee(p.LOCAL_PDFTHEME,window.siyuan.storage[p.LOCAL_PDFTHEME])}),setTimeout(()=>{if(this.element.clientWidth===0){const l=new MutationObserver(()=>{this.pdfObject=Wk(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true"),l.disconnect()});l.observe(this.element,{attributeFilter:["class"]})}else this.pdfObject=Wk(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true")},p.TIMEOUT_LOAD)}}}class ns extends ia{constructor(e){var n;super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&((n=e.tab.headElement)==null||n.classList.add("item--unupdate")),this.element=e.tab.panelElement,this.config=e.config,this.editors=sv(e.app,this.config,this.element),this.element.addEventListener("click",()=>{Qi(),gt(this.element.parentElement.parentElement)})}updateSearch(e,n){const a=this.element.querySelector(".b3-text-field");if(e===""){a.select();return}const i=a.value;i!==e&&(n||(i.indexOf(e)>-1?e=i.replace(e+" ","").replace(" "+e,""):i!==""&&(e=i+" "+e)),a.value=e,a.select(),a.dispatchEvent(new CustomEvent("input")))}}class fi extends ia{constructor(e){var n;super({app:e.app,id:e.tab.id}),this.editors=[],window.siyuan.config.fileTree.openFilesUseCurrentTab&&((n=e.tab.headElement)==null||n.classList.add("item--unupdate")),this.element=e.tab.panelElement,this.tab=e.tab,this.data=e.data,this.type=e.type,this.init=e.init,this.destroy=e.destroy,this.beforeDestroy=e.beforeDestroy,this.resize=e.resize,this.update=e.update,this.init(this)}}var Zb=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Jb=t=>{let e;const n=new fi({app:t.app,type:"siyuan-card",tab:t.tab,data:t.data,init(){return Zb(this,null,function*(){if(t.data.cardsData){let a=t.data.cardsData;for(let i=0;i<t.app.plugins.length;i++)a=yield t.app.plugins[i].updateCards(t.data.cardsData);this.element.innerHTML=Zf({id:this.data.id,cardType:this.data.cardType,cardsData:a,isTab:!0}),e=yield Jf({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:a,index:t.data.index}),n.editors.push(e),delete t.data.cardsData,delete t.data.index}else A(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},a=>Zb(this,null,function*(){let i=a.data;for(let s=0;s<t.app.plugins.length;s++)i=yield t.app.plugins[s].updateCards(i);this.element.innerHTML=Zf({id:this.data.id,cardType:this.data.cardType,cardsData:i,isTab:!0}),e=yield Jf({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:i}),n.editors.push(e)}))})},destroy(){e&&e.destroy()},resize(){e&&e.resize()},update(){A(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},a=>Zb(this,null,function*(){let i=a.data;for(let s=0;s<t.app.plugins.length;s++)i=yield t.app.plugins[s].updateCards(i);n.editors.forEach(s=>{s.destroy()}),this.element.innerHTML=Zf({id:this.data.id,cardType:this.data.cardType,cardsData:i,isTab:!0}),e=yield Jf({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:i}),n.editors.push(e)}))}});return n.element.addEventListener("click",()=>{Qi(),gt(n.element.parentElement.parentElement)}),n};var Vk=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const ve=t=>Vk(void 0,null,function*(){const e=yield Ae("/api/block/getBlockInfo",{id:t.id});if(e.code!==-1){if(e.code===3){de(e.msg);return}return ea({app:t.app,fileName:e.data.rootTitle,rootIcon:e.data.rootIcon,rootID:e.data.rootID,id:t.id,position:t.position,mode:t.mode,action:t.action,zoomIn:t.zoomIn,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,afterOpen:t.afterOpen,openNewTab:t.openNewTab})}}),ur=(t,e,n,a)=>{const i=De().extname(e).split("?")[0];p.SIYUAN_ASSETS_EXTS.includes(i)&&ea({app:t,assetPath:e,page:n,position:a,removeCurrentTab:!0})},ea=t=>Vk(void 0,null,function*(){typeof t.removeCurrentTab=="undefined"&&(t.removeCurrentTab=!0),document.querySelectorAll(".av__panel, .av__mask").forEach(i=>{i.remove()}),document.activeElement instanceof HTMLElement&&document.activeElement.blur();const e=Oe();if(t.assetPath){Qi();const i=e.asset.find(s=>{if(s.path==t.assetPath)return Zl(s.parent.parent.element)||(s.parent.parent.switchTab(s.parent.headElement),s.parent.parent.showHeading(),s.goToPage(t.page)),!0});if(i)return t.afterOpen&&t.afterOpen(i),i.parent}else if(t.custom){Qi();const i=e.custom.find(l=>{if(rn(l.data,t.custom.data)&&(!t.custom.id||t.custom.id===l.type))return Zl(l.parent.parent.element)||(l.parent.parent.switchTab(l.parent.headElement),l.parent.parent.showHeading()),!0});if(i)return t.afterOpen&&t.afterOpen(i),i.parent;const s=Xb(t);if(s)return t.afterOpen&&t.afterOpen(s.model),s}else if(t.searchData){Qi();const i=e.search.find(s=>{if(rn(s.config,t.searchData))return Zl(s.parent.parent.element)||(s.parent.parent.switchTab(s.parent.headElement),s.parent.parent.showHeading()),!0});if(i)return i.parent}else if(!t.position&&!t.openNewTab){let i,s;if(e.editor.find(o=>{if(o.editor.protyle.block.rootID===t.rootID&&(T(o.element,"layout__wnd--active")&&(s=o),(!i||o.headElement.getAttribute("data-activetime")>i.headElement.getAttribute("data-activetime"))&&(i=o)),s)return!0}),s&&(i=s),i)return Zl(i.parent.parent.element)||Yk(i,t,e),t.afterOpen&&t.afterOpen(i),i.parent;const l=Xb(t);if(l)return t.afterOpen&&t.afterOpen(l.model),l}let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=on(a.getAttribute("data-id"))),n||(n=br(window.siyuan.layout.centerLayout)),n){let i;if((t.position==="right"||t.position==="bottom")&&n.children[0].headElement){const s=t.position==="right"?"lr":"tb";let l;if(n.parent.children.length>1&&n.parent instanceof Ua&&n.parent.direction===s&&n.parent.children.find((o,r)=>{if(o.id===n.id){let c=n.parent.children[r+1];for(c||(c=n);c instanceof Ua;)c=c.children[0];return l=c,!0}}),l){if(Zl(l.element)){t.afterOpen&&t.afterOpen();return}let o=l.children.find(r=>{if(r.model&&r.model instanceof Ot&&r.model.editor.protyle.block.rootID===t.rootID)return Yk(r.model,t,e),!0});o||(o=Xb(t),i=o),o||(i=dd(t),l.addTab(i))}else i=dd(t),n.split(s).addTab(i);return n.showHeading(),t.afterOpen&&t.afterOpen(i?i.model:void 0),i}if(Zl(n.element)){t.afterOpen&&t.afterOpen();return}if(t.keepCursor&&n.children[0].headElement)i=dd(t),i.headElement.setAttribute("keep-cursor",t.id),n.addTab(i,t.keepCursor);else if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let s;n.children.find(l=>{if(l.headElement&&l.headElement.classList.contains("item--unupdate")&&!l.headElement.classList.contains("item--pin")&&(s=l,l.headElement.classList.contains("item--focus")))return!0}),i=dd(t),n.addTab(i),s&&t.removeCurrentTab&&n.removeTab(s.id,!1,!1)}else i=dd(t),n.addTab(i);return n.showHeading(),t.afterOpen&&t.afterOpen(i.model),i}}),Xb=t=>pi().find(e=>{var n;const a=(n=e.headElement)==null?void 0:n.getAttribute("data-initdata");if(a){const i=JSON.parse(a);if(i.instance==="Editor"&&(i.rootId===t.rootID||i.blockId===t.rootID))return i.blockId=t.id,i.mode=t.mode,t.zoomIn?i.action=[p.CB_GET_ALL,p.CB_GET_FOCUS]:i.action=t.action,e.headElement.setAttribute("data-initdata",JSON.stringify(i)),e.parent.switchTab(e.headElement),!0;if(i.instance==="Custom"&&t.custom&&rn(i.customModelData,t.custom.data))return e.parent.switchTab(e.headElement),!0}}),Yk=(t,e,n)=>{var a,i,s,l;if(e.keepCursor)return t.parent.headElement.setAttribute("keep-cursor",e.id),!0;if(t.parent.parent.switchTab(t.parent.headElement),t.parent.parent.showHeading(),e.mode!=="preview"&&!t.editor.protyle.preview.element.classList.contains("fn__none"))return!0;if(e.zoomIn)return dn({protyle:t.editor.protyle,id:e.id}),!0;let o;if(Array.from(t.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(r=>{if(!G(r))return o=r,!0}),(!o||(o==null?void 0:o.clientHeight)===0)&&e.id!==e.rootID)A("/api/filetree/getDoc",{id:e.id,mode:e.action&&e.action.includes(p.CB_GET_CONTEXT)?3:0,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{kt({data:r,protyle:t.editor.protyle,action:e.action}),ey(n,t.editor.protyle)});else{if(ra(t.editor.protyle),(a=t.editor.protyle.observerLoad)==null||a.disconnect(),(i=e.action)!=null&&i.includes(p.CB_GET_HL))yc(t.editor.protyle,e.id,"start");else if((s=e.action)!=null&&s.includes(p.CB_GET_FOCUS))if(o){const r=oe(o,void 0,!((l=e.action)!=null&&l.includes(p.CB_GET_OUTLINE)));r&&(t.editor.protyle.toolbar.range=r),Ye(t.editor.protyle),t.editor.protyle.observerLoad=new ResizeObserver(()=>{document.contains(o)&&Ye(t.editor.protyle)}),setTimeout(()=>{t.editor.protyle.observerLoad.disconnect()},1e3*3),t.editor.protyle.observerLoad.observe(t.editor.protyle.wysiwyg.element)}else t.editor.protyle.block.rootID===e.id||t.editor.protyle.toolbar.range&&(o=B(t.editor.protyle.toolbar.range.startContainer),ne(t.editor.protyle.toolbar.range),Ye(t.editor.protyle));cr(t.editor.protyle,t.editor.protyle.toolbar.range)}e.mode&&ql(t.editor.protyle,e.mode)},dd=t=>{let e;if(t.assetPath){const n=De().extname(t.assetPath).split("?")[0];if(p.SIYUAN_ASSETS_EXTS.includes(n)){let a="iconPDF";p.SIYUAN_ASSETS_IMAGE.includes(n)?a="iconImage":p.SIYUAN_ASSETS_AUDIO.includes(n)?a="iconRecord":p.SIYUAN_ASSETS_VIDEO.includes(n)&&(a="iconVideo"),e=new Dt({icon:a,title:xt(t.assetPath),callback(i){i.addModel(new ts({app:t.app,tab:i,path:t.assetPath,page:t.page})),gt(i.panelElement.parentElement.parentElement)}})}}else t.custom?e=new Dt({icon:t.custom.icon,title:t.custom.title,callback(n){t.custom.id?t.custom.id==="siyuan-card"?n.addModel(Jb({app:t.app,tab:n,data:t.custom.data})):t.app.plugins.find(a=>{if(a.models[t.custom.id])return n.addModel(a.models[t.custom.id]({tab:n,data:t.custom.data})),!0}):(console.warn("0.8.3 \u5C06\u79FB\u9664 custom.fn \u53C2\u6570\uFF0C\u8BF7\u53C2\u7167 https://github.com/siyuan-note/plugin-sample/blob/91a716358941791b4269241f21db25fd22ae5ff5/src/index.ts \u5C06\u5176\u4FEE\u6539\u4E3A custom.id"),n.addModel(t.custom.fn({tab:n,data:t.custom.data}))),gt(n.panelElement.parentElement.parentElement)}}):t.searchData?e=new Dt({icon:"iconSearch",title:window.siyuan.languages.search,callback(n){n.addModel(new ns({app:t.app,tab:n,config:t.searchData})),gt(n.panelElement.parentElement.parentElement)}}):e=new Dt({title:xt(t.fileName,!0,!0),docIcon:t.rootIcon,callback(n){let a;t.zoomIn?a=new Ot({app:t.app,tab:n,blockId:t.id,rootId:t.rootID,action:[p.CB_GET_ALL,p.CB_GET_FOCUS]}):a=new Ot({app:t.app,tab:n,blockId:t.id,rootId:t.rootID,mode:t.mode,action:t.action}),n.addModel(a)}});return e},fr=t=>{var e;if(t.protyle&&t.protyle.path){if(t.protyle.element.classList.contains("fn__none")||!T(t.protyle.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active"))return;if(t.resize&&mn(t.protyle),t.focus&&(t.protyle.toolbar.range?(ne(t.protyle.toolbar.range),Vl(t.protyle.toolbar.range,t.protyle.block.rootID),t.pushBackStack&&t.protyle.preview.element.classList.contains("fn__none")&&cr(t.protyle,t.protyle.toolbar.range)):(oe(t.protyle.wysiwyg.element.firstElementChild),t.pushBackStack&&t.protyle.preview.element.classList.contains("fn__none")&&cr(t.protyle,void 0,t.protyle.wysiwyg.element.firstElementChild),Pn([],t.protyle.block.rootID))),window.siyuan.config.fileTree.alwaysSelectOpenedFile&&t.protyle){const a=(e=nt("file"))==null?void 0:e.data.file;if(a instanceof Ki){const i=a.element.querySelector(`li[data-path="${t.protyle.path}"]`);(!i||i&&!i.classList.contains("b3-list-item--focus"))&&a.selectItem(t.protyle.notebookId,t.protyle.path)}}t.protyle.app.plugins.forEach(a=>{a.eventBus.emit("switch-protyle",{protyle:t.protyle})})}const n=Oe();Qb(n,t.protyle,t.reload),ey(n,t.protyle)},zk=t=>{const e=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus");if(e){const n=on(e.getAttribute("data-id"));if(n instanceof Dt&&n.model instanceof Ot&&(n.model.editor.protyle.block.rootID===t||n.model.editor.protyle.block.parentID===t||n.model.editor.protyle.block.id===t))return!0}return!1},Qb=(t,e,n=!1)=>{t.outline.find(a=>{var i;if(n||a.type==="pin"&&(!e||a.blockId!==((i=e.block)==null?void 0:i.rootID)||a.isPreview===e.preview.element.classList.contains("fn__none"))){let s="";if(e&&e.block&&(s=e.block.rootID),s===a.blockId&&!n&&a.isPreview!==e.preview.element.classList.contains("fn__none"))return;A("/api/outline/getDocOutline",{id:s,preview:!e.preview.element.classList.contains("fn__none")},l=>{var o;if(!(!n&&(!zk(s)||a.blockId===s)&&a.isPreview!==e.preview.element.classList.contains("fn__none")))if(a.isPreview=!e.preview.element.classList.contains("fn__none"),a.update(l,s),e){if(a.updateDocTitle(e.background.ial,((o=l.data)==null?void 0:o.length)||0),getSelection().rangeCount>0){const r=getSelection().getRangeAt(0).startContainer;if(e.wysiwyg.element.contains(r)){const c=j(r,"data-node-id",null);c&&a.setCurrent(c)}}}else a.updateDocTitle()})}})},ey=(t,e)=>{e&&e.element.classList.contains("fn__none")||e&&!T(e.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active")||(t.graph.forEach(n=>{var a,i;if(n.type!=="global"&&(!e||n.blockId!==((a=e.block)==null?void 0:a.id))){if(n.type==="local"&&n.rootId!==((i=e==null?void 0:e.block)==null?void 0:i.rootID))return;let s="";if(e&&e.block&&(s=e.block.showAll?e.block.id:e.block.parentID),s===n.blockId)return;n.searchGraph(!0,s)}}),t.backlink.forEach(n=>{var a;if(n.type==="local"&&n.rootId!==((a=e==null?void 0:e.block)==null?void 0:a.rootID))return;let i="";e&&e.block&&(i=e.block.showAll?e.block.id:e.block.parentID),i!==n.blockId&&(n.element.querySelector('.block__icon[data-type="refresh"] svg').classList.add("fn__rotate"),A("/api/ref/getBacklink2",{sort:n.status[i]?n.status[i].sort.toString():window.siyuan.config.editor.backlinkSort.toString(),mSort:n.status[i]?n.status[i].mSort.toString():window.siyuan.config.editor.backmentionSort.toString(),id:i||"",k:n.inputsElement[0].value,mk:n.inputsElement[1].value},s=>{if(!zk(i)||n.blockId===i){n.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate");return}n.saveStatus(),n.blockId=i,n.render(s.data)}))}))},Gk=(t,e)=>{};class ud{constructor(e){this.editors=[],this.id=ee(),this.targetElement=e.targetElement,this.refDefs=e.refDefs,this.app=e.app,this.x=e.x,this.y=e.y,this.isBacklink=e.isBacklink,this.originalRefBlockIDs=e.originalRefBlockIDs,this.element=document.createElement("div"),this.element.classList.add("block__popover");const n=T(this.targetElement,"block__popover",!0);let a=1;n?(this.element.setAttribute("data-oid",n.getAttribute("data-oid")),a=parseInt(n.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.refDefs[0].refID),this.element.setAttribute("data-level",a.toString());for(let i=0;i<window.siyuan.blockPanels.length;i++){const s=window.siyuan.blockPanels[i];s.element.getAttribute("data-pin")==="false"&&s.targetElement&&parseInt(s.element.getAttribute("data-level"))>=a&&(s.destroy(),i--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",i=>{const s=i.target,l=T(s,"block__icons");if(l){const o=l.querySelector('[data-type="pin"]');this.element.getAttribute("data-pin")==="true"?(o.setAttribute("aria-label",window.siyuan.languages.pin),o.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(o.setAttribute("aria-label",window.siyuan.languages.unpin),o.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")),i.preventDefault(),i.stopPropagation()}}),this.element.addEventListener("click",i=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let s=i.target;for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("block__icon")||s.classList.contains("block__logo")){const l=s.getAttribute("data-type");l==="close"?this.destroy():l==="pin"?this.element.getAttribute("data-pin")==="true"?(s.setAttribute("aria-label",window.siyuan.languages.pin),s.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(s.setAttribute("aria-label",window.siyuan.languages.unpin),s.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")):l==="open"||l==="stickTab"&&(ft(this.refDefs[0].refID,(o,r)=>{ve({app:e.app,id:this.refDefs[0].refID,action:r,zoomIn:o,openNewTab:!0})}),this.destroy()),i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),jm(this.element,()=>{const i=this.element.firstElementChild.querySelector('[data-type="pin"]');i.setAttribute("aria-label",window.siyuan.languages.unpin),i.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")}),this.render()}initProtyle(e,n){const a=parseInt(e.getAttribute("data-index"));A("/api/block/getBlockInfo",{id:this.refDefs[a].refID},i=>{if(i.code===3){de(i.msg);return}if(!this.targetElement&&typeof this.x=="undefined"&&typeof this.y=="undefined")return;const s=[];i.data.rootID!==this.refDefs[a].refID?s.push(p.CB_GET_ALL):s.push(p.CB_GET_CONTEXT),this.isBacklink&&s.push(p.CB_GET_BACKLINK);const l=new ba(this.app,e,{blockId:this.refDefs[a].refID,defIds:this.refDefs[a].defIDs||[],originalRefBlockIDs:this.isBacklink?this.originalRefBlockIDs:void 0,action:s,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0,title:i.data.rootID===this.refDefs[a].refID},typewriterMode:!1,after:o=>{i.data.rootID!==this.refDefs[a].refID&&o.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),n&&n(),(o.protyle.element.nextElementSibling||o.protyle.element.previousElementSibling)&&(o.protyle.element.style.minHeight=Math.min(30+o.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),o.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(o.protyle.contentElement.clientHeight-49,200)}px;`)}});this.editors.push(l)})}destroy(){var e,n,a;(e=this.observerResize)==null||e.disconnect(),(n=this.observerLoad)==null||n.disconnect(),window.siyuan.blockPanels.find((l,o)=>{if(l.id===this.id)return window.siyuan.blockPanels.splice(o,1),!0}),this.editors.length>0&&(this.editors.forEach(l=>{ce(["util"],l.protyle),l.destroy()}),this.editors=[]);const i=parseInt(this.element.dataset.level);this.element.remove(),this.element=void 0,this.targetElement=void 0;const s=parseInt(window.siyuan.menus.menu.element.dataset.from);s&&s>=i&&((a=window.siyuan.menus.menu.element.dataset.from)!=null&&a.includes("popover"))&&window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let e="";this.refDefs.length===1&&(e=`<span data-type="stickTab" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.openInNewTab}${Pt(window.siyuan.config.keymap.editor.general.openInNewTab.custom)}"><svg><use xlink:href="#iconOpen"></use></svg></span>
<span class="fn__space"></span>`);let n=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>${e}
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg style="width: 12px;margin: 0 1px;"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.refDefs.length===0?n+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.refDefs.forEach((i,s)=>{n+=`<div class="block__edit fn__flex-1 protyle" data-index="${s}"></div>`}),n&&(n+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=n;let a;this.observerResize=new ResizeObserver(()=>{clearTimeout(a),a=window.setTimeout(()=>{this.editors.forEach(i=>{mn(i.protyle)})},p.TIMEOUT_TRANSITION)}),this.observerResize.observe(this.element),this.observerLoad=new IntersectionObserver(i=>{i.forEach(s=>{s.isIntersecting&&s.target.innerHTML===""&&this.initProtyle(s.target)})},{threshold:0}),this.element.querySelectorAll(".block__edit").forEach((i,s)=>{s<5?this.initProtyle(i,s===0?()=>{if(!document.contains(this.element))return;let l;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){l=this.targetElement.getBoundingClientRect();let r=l.top;const c=T(this.targetElement,"protyle-content",!0);if(c){const d=c.getBoundingClientRect().top;l.top<d&&(r=d)}this.element.style.height=Math.min(window.innerHeight-p.SIZE_TOOLBAR_HEIGHT,l.height+42)+"px",Te(this.element,l.left,Math.max(r-42,p.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?l=this.targetElement.firstElementChild.getBoundingClientRect():l=this.targetElement.getBoundingClientRect(),window.innerHeight-l.bottom-4>l.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-l.bottom-12)+"px"),Te(this.element,l.left,l.bottom+4,l.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(Te(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,p.SIZE_TOOLBAR_HEIGHT)-12)+"px");const o=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(o.top<l.top?this.element.style.maxHeight=Math.floor(l.top-o.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-o.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):this.observerLoad.observe(i)}),this.targetElement&&(this.targetElement.style.cursor=""),this.element.querySelector(".block__content").addEventListener("scroll",()=>{this.editors.forEach(i=>{ce(["gutter"],i.protyle)})})}}class Ii extends ia{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&A("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(a){if(a)switch(a.cmd){case"mount":this.type==="global"&&a.code!==1&&this.searchGraph(!1);break;case"rename":this.graphData&&a.data.box===this.graphData.box&&this.rootId===a.data.id&&(this.searchGraph(!1),this.type==="local"&&this.parent.updateTitle(a.data.title)),this.type==="global"&&this.searchGraph(!1);break;case"unmount":this.type==="local"&&this.graphData&&this.graphData.box===a.data.box&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":this.type==="local"&&a.data.ids.includes(this.rootId)&&this.parent.parent.removeTab(this.parent.id);break}}}),this.element=e.tab.panelElement,this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element.classList.add("graph","file-tree",this.type==="global"?"sy__globalGraph":"sy__graph");let n;this.type==="global"?n=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.d3.arrow?" checked":""}/>
</label>
<label> 
    <span>${window.siyuan.languages.graphConfig2}</span>  
    <input data-type="minRefs" class="b3-slider b3-tooltips__n b3-tooltips" max="16" min="0" step="1" type="range" value="${window.siyuan.config.graph.global.minRefs}" aria-label="${window.siyuan.config.graph.global.minRefs}" />
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.global.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.linkWidth}" aria-label="${window.siyuan.config.graph.global.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.global.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.centerStrength}" aria-label="${window.siyuan.config.graph.global.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.global.d3.collideRadius}" aria-label="${window.siyuan.config.graph.global.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.collideStrength}" aria-label="${window.siyuan.config.graph.global.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.global.d3.linkDistance}" aria-label="${window.siyuan.config.graph.global.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`:n=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.d3.arrow?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.local.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.linkWidth}" aria-label="${window.siyuan.config.graph.local.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.local.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.centerStrength}" aria-label="${window.siyuan.config.graph.local.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.local.d3.collideRadius}" aria-label="${window.siyuan.config.graph.local.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.collideStrength}" aria-label="${window.siyuan.config.graph.local.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.local.d3.linkDistance}" aria-label="${window.siyuan.config.graph.local.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`,this.element.innerHTML=`<div class="block__icons"> 
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#icon${this.type==="global"?"GlobalGraph":"Graph"}"></use></svg>${this.type==="global"?window.siyuan.languages.globalGraph:window.siyuan.languages.graphView}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__size200 fn__none" placeholder="${window.siyuan.languages.search}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.search}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <div class="fn__space"></div>
    <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.fullscreen}">
        <svg><use xlink:href="#iconFullscreen"></use></svg>
    </div>
    <div class="fn__space"></div>
    <div data-type="menu" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min"  class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="graph__panel">
    ${n}
</div>
<div class="fn__flex-1 graph__svg"></div>`,this.graphElement=this.element.querySelector(".graph__svg"),this.inputElement=this.element.querySelector("input"),this.panelElement=this.element.querySelector(".graph__panel"),this.element.addEventListener("click",a=>{this.type==="local"?gt(this.element.parentElement.parentElement):gt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("b3-button")){this.type==="global"?A("/api/graph/resetGraph",{},s=>{this.reset(s.data.conf)}):A("/api/graph/resetLocalGraph",{},s=>{this.reset(s.data.conf)});break}else if(i.classList.contains("block__icon")){const s=i.getAttribute("data-type");if(s==="min")nt(this.type==="global"?"globalGraph":"graph").toggleModel(this.type==="global"?"globalGraph":"graph",!1,!0);else if(s==="menu")i.classList.contains("ft__primary")?(i.classList.remove("ft__primary"),this.panelElement.style.right=""):(i.classList.add("ft__primary"),this.panelElement.style.right="0");else if(s==="search")i.previousElementSibling.classList.remove("fn__none"),i.previousElementSibling.select();else if(s==="refresh")this.searchGraph(!1,void 0,!0);else if(s==="fullscreen"){kl(this.element,i);const l=this.element.querySelector('.block__icons .block__icon[data-type="min"]');this.element.className.includes("fullscreen")?l.classList.add("fn__none"):l.classList.remove("fn__none")}break}else if(i.classList.contains("graph__svg")){this.element.querySelectorAll(".block__icon.ft__primary").forEach(s=>{s.classList.remove("ft__primary")}),this.panelElement.style.right="";break}i=i.parentElement}}),this.inputElement.addEventListener("compositionend",()=>{this.searchGraph(!1)}),this.inputElement.addEventListener("blur",a=>{a.target.classList.add("fn__none")}),this.inputElement.addEventListener("input",a=>{a.isComposing||this.searchGraph(!1)}),this.element.querySelectorAll(".b3-slider").forEach(a=>{a.addEventListener("input",()=>{a.setAttribute("aria-label",a.value),this.searchGraph(!1)})}),this.element.querySelectorAll(".b3-switch").forEach(a=>{a.addEventListener("change",()=>{this.searchGraph(!1)})}),this.searchGraph(e.type!=="global")}reset(e){this.type==="global"?(window.siyuan.config.graph.global=e,this.panelElement.querySelector("[data-type='minRefs']").setAttribute("aria-label",window.siyuan.config.graph.global.minRefs.toString()),this.panelElement.querySelector("[data-type='minRefs']").value=window.siyuan.config.graph.global.minRefs.toString()):window.siyuan.config.graph.local=e,this.inputElement.value="",this.panelElement.querySelector("[data-type='nodeSize']").setAttribute("aria-label",e.d3.nodeSize.toString()),this.panelElement.querySelector("[data-type='centerStrength']").setAttribute("aria-label",e.d3.centerStrength.toString()),this.panelElement.querySelector("[data-type='collideRadius']").setAttribute("aria-label",e.d3.collideRadius.toString()),this.panelElement.querySelector("[data-type='collideStrength']").setAttribute("aria-label",e.d3.collideStrength.toString()),this.panelElement.querySelector("[data-type='lineOpacity']").setAttribute("aria-label",e.d3.lineOpacity.toString()),this.panelElement.querySelector("[data-type='linkDistance']").setAttribute("aria-label",e.d3.linkDistance.toString()),this.panelElement.querySelector("[data-type='linkWidth']").setAttribute("aria-label",e.d3.linkWidth.toString()),this.panelElement.querySelector("[data-type='nodeSize']").value=e.d3.nodeSize.toString(),this.panelElement.querySelector("[data-type='centerStrength']").value=e.d3.centerStrength.toString(),this.panelElement.querySelector("[data-type='collideRadius']").value=e.d3.collideRadius.toString(),this.panelElement.querySelector("[data-type='collideStrength']").value=e.d3.collideStrength.toString(),this.panelElement.querySelector("[data-type='lineOpacity']").value=e.d3.lineOpacity.toString(),this.panelElement.querySelector("[data-type='linkDistance']").value=e.d3.linkDistance.toString(),this.panelElement.querySelector("[data-type='linkWidth']").value=e.d3.linkWidth.toString(),this.panelElement.querySelector("[data-type='list']").checked=e.type.list,this.panelElement.querySelector("[data-type='listItem']").checked=e.type.listItem,this.panelElement.querySelector("[data-type='math']").checked=e.type.math,this.panelElement.querySelector("[data-type='paragraph']").checked=e.type.paragraph,this.panelElement.querySelector("[data-type='super']").checked=e.type.super,this.panelElement.querySelector("[data-type='table']").checked=e.type.table,this.panelElement.querySelector("[data-type='tag']").checked=e.type.tag,this.panelElement.querySelector("[data-type='dailyNote']").checked=e.dailyNote,this.panelElement.querySelector("[data-type='heading']").checked=e.type.heading,this.panelElement.querySelector("[data-type='arrow']").checked=e.d3.arrow,this.panelElement.querySelector("[data-type='blockquote']").checked=e.type.blockquote,this.panelElement.querySelector("[data-type='code']").checked=e.type.code,this.searchGraph(!1)}searchGraph(e,n,a=!1){const i=this.element.querySelector('.block__icon[data-type="refresh"] svg');if(i.classList.contains("fn__rotate")&&!n)return;i.classList.add("fn__rotate");const s={list:this.panelElement.querySelector("[data-type='list']").checked,listItem:this.panelElement.querySelector("[data-type='listItem']").checked,math:this.panelElement.querySelector("[data-type='math']").checked,paragraph:this.panelElement.querySelector("[data-type='paragraph']").checked,super:this.panelElement.querySelector("[data-type='super']").checked,table:this.panelElement.querySelector("[data-type='table']").checked,tag:this.panelElement.querySelector("[data-type='tag']").checked,heading:this.panelElement.querySelector("[data-type='heading']").checked,blockquote:this.panelElement.querySelector("[data-type='blockquote']").checked,code:this.panelElement.querySelector("[data-type='code']").checked},l={arrow:this.panelElement.querySelector("[data-type='arrow']").checked,nodeSize:parseFloat(this.panelElement.querySelector("[data-type='nodeSize']").value),centerStrength:parseFloat(this.panelElement.querySelector("[data-type='centerStrength']").value),collideRadius:parseFloat(this.panelElement.querySelector("[data-type='collideRadius']").value),collideStrength:parseFloat(this.panelElement.querySelector("[data-type='collideStrength']").value),lineOpacity:parseFloat(this.panelElement.querySelector("[data-type='lineOpacity']").value),linkDistance:parseFloat(this.panelElement.querySelector("[data-type='linkDistance']").value),linkWidth:parseFloat(this.panelElement.querySelector("[data-type='linkWidth']").value)};this.type==="global"?A("/api/graph/getGraph",{k:this.inputElement.value,conf:{type:s,d3:l,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked,minRefs:parseFloat(this.panelElement.querySelector("[data-type='minRefs']").value)}},o=>{this.graphData=o.data,window.siyuan.config.graph.global=o.data.conf,this.onGraph(!1),i.classList.remove("fn__rotate")}):A("/api/graph/getLocalGraph",{type:this.type,k:this.inputElement.value,id:n||this.blockId,conf:{type:s,d3:l,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked}},o=>{i.classList.remove("fn__rotate"),n&&(this.blockId=n),!(!a&&this.type==="pin"&&this.blockId&&!Array.from(document.querySelectorAll(".fn__flex > .layout-tab-bar > .item--focus")).find(c=>{const d=on(c.getAttribute("data-id"));if(d instanceof Dt&&d.model instanceof Ot&&(d.model.editor.protyle.block.rootID===this.blockId||d.model.editor.protyle.block.parentID===this.blockId||d.model.editor.protyle.block.id===this.blockId))return!0}))&&(this.graphData=o.data,window.siyuan.config.graph.local=o.data.conf,this.onGraph(e))})}hlNode(e){this.graphElement.clientHeight===0||!this.network||this.network.findNode(e).length===0||(this.network.focus(e,{animation:{duration:1e3,easingFunction:"easeInOutQuad"}}),this.network.selectNodes([e]))}destroy(){var e;(e=this.network)==null||e.destroy()}onGraph(e){var n;if(this.graphElement.clientHeight===0||((n=this.network)==null||n.destroy(),!this.graphData||!this.graphData.nodes||this.graphData.nodes.length===0))return;const a=getComputedStyle(document.body);this.graphData.nodes.forEach(i=>{switch(i.type){case"NodeDocument":i.color={background:a.getPropertyValue("--b3-graph-doc-point").trim()};break;case"NodeParagraph":i.color={background:a.getPropertyValue("--b3-graph-p-point").trim()};break;case"NodeHeading":i.color={background:a.getPropertyValue("--b3-graph-heading-point").trim()};break;case"NodeMathBlock":i.color={background:a.getPropertyValue("--b3-graph-math-point").trim()};break;case"NodeCodeBlock":i.color={background:a.getPropertyValue("--b3-graph-code-point").trim()};break;case"NodeTable":i.color={background:a.getPropertyValue("--b3-graph-table-point").trim()};break;case"NodeList":i.color={background:a.getPropertyValue("--b3-graph-list-point").trim()};break;case"NodeListItem":i.color={background:a.getPropertyValue("--b3-graph-listitem-point").trim()};break;case"NodeBlockquote":i.color={background:a.getPropertyValue("--b3-graph-bq-point").trim()};break;case"NodeSuperBlock":i.color={background:a.getPropertyValue("--b3-graph-super-point").trim()};break;case"tag":case"textmark tag":i.color={background:a.getPropertyValue("--b3-graph-tag-point").trim()};break;default:i.color={background:a.getPropertyValue("--b3-graph-p-point").trim()};break}}),this.graphData.links.forEach(i=>{i.ref?i.color={color:a.getPropertyValue("--b3-graph-ref-line").trim()}:i.color={color:a.getPropertyValue("--b3-graph-line").trim()}}),jt(`${p.PROTYLE_CDN}/js/vis/vis-network.min.js?v=9.1.13`,"protyleVisScript").then(()=>{var i;if((i=this.network)==null||i.destroy(),!this.graphData||!this.graphData.nodes||this.graphData.nodes.length===0)return;const s=window.siyuan.config.graph[this.type==="global"?"global":"local"],l=32<this.graphData.nodes.length?.1:.5;let o=this.graphData.nodes.length;this.graphData.nodes.length>1024&&(o=1024),this.graphData.nodes.length<256&&(o=256);let r=this.graphData.nodes.length;this.graphData.nodes.length>64&&(r=64),this.graphData.nodes.length<16&&(r=8);const c={autoResize:!0,interaction:{hover:!0},nodes:{borderWidth:0,borderWidthSelected:5,shape:"dot",font:{face:a.getPropertyValue("--b3-font-family-graph").trim(),size:32,color:a.getPropertyValue("--b3-theme-on-background").trim()},color:{hover:{border:a.getPropertyValue("--b3-graph-hl-point").trim(),background:a.getPropertyValue("--b3-graph-hl-point").trim()},highlight:{border:a.getPropertyValue("--b3-graph-hl-point").trim(),background:a.getPropertyValue("--b3-graph-hl-point").trim()}}},edges:{width:s.d3.linkWidth,arrowStrikethrough:!1,smooth:!1,color:{opacity:s.d3.lineOpacity,hover:a.getPropertyValue("--b3-graph-hl-line").trim(),highlight:a.getPropertyValue("--b3-graph-hl-line").trim()}},layout:{randomSeed:0,improvedLayout:!1},physics:{enabled:!0,forceAtlas2Based:{theta:.5,gravitationalConstant:-s.d3.collideRadius,centralGravity:s.d3.centerStrength,springConstant:s.d3.collideStrength,springLength:s.d3.linkDistance,damping:.4,avoidOverlap:.5},maxVelocity:o,minVelocity:r,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:64,updateInterval:64,onlyDynamicEdges:!1,fit:!0},timestep:l,adaptiveTimestep:!0,wind:{x:0,y:0}}};let d=Math.max(Math.ceil(this.graphData.nodes.length*.1),128),u=Math.max(Math.ceil(this.graphData.links.length*.1),128);const m=new vis.DataSet(this.graphData.nodes.slice(0,d)),f=new vis.DataSet(this.graphData.links.slice(0,u)),g=new vis.Network(this.graphElement,{nodes:m,edges:f},c),h=Math.max(.03,1-.3*Math.floor(this.graphData.nodes.length/128));h!==1&&g.moveTo({position:{x:0,y:0},scale:h,animation:!1});const b=256,y=Math.max(Math.ceil(b/8),32);let w=this.graphData.nodes.length/b/2;w<64&&(w=64),w>256&&(w=256);const E=setInterval(()=>{if(!g.images){clearInterval(C);return}const $=this.graphData.nodes.slice(d,d+w);if($.length===0){clearInterval(E);return}g.body.data.nodes.add($),d+=w},y),C=setInterval(()=>{if(!g.images){clearInterval(C);return}const $=this.graphData.links.slice(u,u+w);if($.length===0){clearInterval(C),g.fit({animation:!0});return}g.body.data.edges.add($),u+=w},b);this.network=g,g.on("stabilizationIterationsDone",()=>{g.physics.stopSimulation(),e&&this.hlNode(this.blockId)}),g.on("dragEnd",()=>{setTimeout(()=>{g.physics.stopSimulation()},3e3)}),g.on("click",$=>{if($.nodes.length!==1)return;const M=this.graphData.nodes.find(k=>k.id===$.nodes[0]);if(M){if(-1<M.type.indexOf("tag")){Si(this.app,`#${M.id}#`,!window.siyuan.ctrlIsPressed,{method:0});return}window.siyuan.shiftIsPressed?ft(M.id,(k,_)=>{ve({app:this.app,id:M.id,position:"bottom",action:_,zoomIn:k})}):window.siyuan.altIsPressed?ft(M.id,(k,_)=>{ve({app:this.app,id:M.id,position:"right",action:_,zoomIn:k})}):window.siyuan.ctrlIsPressed?window.siyuan.blockPanels.push(new ud({app:this.app,isBacklink:!1,x:$.event.center.x,y:$.event.center.y,refDefs:[{refID:M.id}]})):ft(M.id,(k,_)=>{ve({app:this.app,id:M.id,action:_,zoomIn:k})})}})})}}const jk=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BOOKMARK){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=t.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new N({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent,s=new $e({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});s.element.setAttribute("data-key",p.DIALOG_RENAMEBOOKMARK);const l=s.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{s.destroy()});const o=s.element.querySelector("input");s.bindInput(o,()=>{l[1].click()}),o.value=i,o.focus(),o.select(),l[1].addEventListener("click",()=>{A("/api/bookmark/renameBookmark",{oldBookmark:i,newBookmark:o.value},()=>{s.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:xs([t.getAttribute("data-node-id")],!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent;Re(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${he(i)}</b>`),()=>{a?(A("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{n.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(s=>{s.setAttribute("bookmark","");const l=s.querySelector(".protyle-attr--bookmark");l&&l.remove()})):A("/api/bookmark/removeBookmark",{bookmark:i})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BOOKMARK),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Wl extends ia{constructor(e,n){super({app:e,id:n.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('class="protyle-attr--bookmark"')>-1||i.action==="delete")&&(s=!0),s&&A("/api/bookmark/getBookmark",{},l=>{this.update(l.data)})});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&A("/api/bookmark/getBookmark",{},i=>{this.update(i.data)});break}}}),this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__bookmark"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconBookmark"></use></svg>${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand}${Pt(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse}${Pt(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new kc({element:this.element.lastElementChild,data:null,click:(a,i)=>{if(i){const l=T(i.target,"b3-list-item__action");if(l){jk(l.parentElement,i,this);return}}const s=a.getAttribute("data-node-id");ft(s,(l,o)=>{ve({app:e,id:s,action:o,zoomIn:l})})},rightClick:(a,i)=>{jk(a,i,this)},ctrlClick:a=>{const i=a.getAttribute("data-node-id");ft(i,s=>{ve({app:e,id:i,keepCursor:!0,action:s?[p.CB_GET_HL,p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],zoomIn:s})})},altClick:a=>{const i=a.getAttribute("data-node-id");ft(i,(s,l)=>{ve({app:e,id:i,position:"bottom",action:l,zoomIn:s})})},shiftClick:a=>{const i=a.getAttribute("data-node-id");ft(i,(s,l)=>{ve({app:e,id:i,position:"bottom",action:l,zoomIn:s})})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{gt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":nt("bookmark").toggleModel("bookmark",!1,!0);break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),A("/api/bookmark/getBookmark",{},n=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(n.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}const Kk=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TAG){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new N({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{dw(n)}}).element),window.siyuan.menus.menu.append(new N({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${he(n)}</b>?`,()=>{A("/api/tag/removeTag",{label:n},()=>{nt("tag").data.tag.update()})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_TAG),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Ps extends ia{constructor(e,n){super({app:e,id:n.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('data-type="tag"')>-1||i.action==="delete")&&(s=!0),s&&this.update()});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&this.update();break}}}),this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__tag"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconTags"></use></svg>${window.siyuan.languages.tag}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" class="block__icon b3-tooltips b3-tooltips__sw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.sort}">
        <svg><use xlink:href="#iconSort"></use></svg>
    </span>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand}${Pt(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse}${Pt(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new kc({element:this.element.lastElementChild,data:null,click(a,i){const s=a.getAttribute("data-label");if(i){const l=T(i.target,"b3-list-item__action");if(l){Kk(l.parentElement,i,s);return}}Si(e,`#${a.getAttribute("data-label")}#`,!window.siyuan.ctrlIsPressed,{method:0})},rightClick:(a,i)=>{Kk(a,i,a.getAttribute("data-label"))},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{gt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":nt("tag").toggleModel("tag",!1,!0);break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new N({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new N({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new N({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new N({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new N({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new N({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break;case"refresh":this.update();break}i=i.parentElement}}),this.update(!1)}update(e=!0){const n=this.element.querySelector('.block__icon[data-type="refresh"] svg');n.classList.contains("fn__rotate")||(n.classList.add("fn__rotate"),A("/api/tag/getTag",{sort:window.siyuan.config.tag.sort,app:p.SIYUAN_APPID,ignoreMaxListHint:e},a=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(a.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),n.classList.remove("fn__rotate")}))}}var h3=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)},b3=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)},Zk=(t,e,n)=>(h3(t,e,"access private method"),n),Yp,ty;const y3=class N_{constructor(e,n,a){b3(this,Yp),this.children=[],this.removeTabAction=(o,r=!1,c=!0,d=!0)=>{if(T3(),this.children.find((u,m)=>{if(u.id===o){window.siyuan.closedTabs.length>p.SIZE_UNDO&&window.siyuan.closedTabs.pop();const f={};if($i(u,f),window.siyuan.closedTabs.push(f),u.model instanceof fi&&u.model.beforeDestroy&&u.model.beforeDestroy(),u.model instanceof Ot&&(xc(u.model.editor.protyle),A("/api/storage/updateRecentDocCloseTime",{rootID:u.model.editor.protyle.block.rootID})),this.children.length===1){this.destroyModel(this.children[0].model),this.children=[],["bottom","left","right"].includes(this.parent.type)?u.panelElement.remove():(id(),this.remove());const g=Oe().editor;g.length===0?Qi():g.forEach(h=>{if(!h.element.classList.contains("fn__none")){gt(h.parent.parent.headersElement.parentElement.parentElement),fr({protyle:h.editor.protyle,focus:!0,pushBackStack:!0,reload:!1,resize:!0});return}});return}if(u.headElement){if(u.headElement.classList.contains("item--focus")){let g;Array.from(u.headElement.parentElement.children).forEach(h=>{h!==u.headElement&&h.style.maxWidth!=="0px"&&(g?h.getAttribute("data-activetime")>g.getAttribute("data-activetime")&&(g=h):g=h)}),g&&!r&&(this.switchTab(g,!0,!0,!1,!1),this.showHeading())}c?(u.headElement.setAttribute("style","max-width: 0px;"),setTimeout(()=>{u.headElement.remove()},200)):u.headElement.remove()}return u.panelElement.remove(),this.destroyModel(u.model),this.children.splice(m,1),Sn(!1),!0}}),window.siyuan.layout.centerLayout&&!br(window.siyuan.layout.centerLayout)){const m=new N_(this.app);window.siyuan.layout.centerLayout.addWnd(m),m.addTab(pS(this.app),!1,!1),gd(window.siyuan.languages.siyuanNote)}d&&bn()},this.id=ee(),this.app=e,this.resize=n,this.element=document.createElement("div"),this.element.classList.add("fn__flex-1","fn__flex");let i='<div class="layout-tab-container__drag fn__none"></div>';(a==="left"||a==="right"||a==="bottom")&&(i=""),this.element.innerHTML=`<div data-type="wnd" data-id="${this.id}" class="fn__flex-column fn__flex fn__flex-1">
    <div class="fn__flex fn__none">
        <ul class="fn__flex layout-tab-bar"></ul>
        <ul class="layout-tab-bar layout-tab-bar--readonly fn__flex-1">
            <li class="item item--readonly">
                <span data-type="new" class="block__icon block__icon--show ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newFile}"><svg><use xlink:href="#iconAdd"></use></svg></span>
                <span class="fn__flex-1"></span>
                <span data-type="more" data-menu="true" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.switchTab}"><svg><use xlink:href="#iconDown"></use></svg></span>
            </li>
        </ul>
    </div>
    <div class="layout-tab-container fn__flex-1">${i}</div>
</div>`,this.headersElement=this.element.querySelector(".layout-tab-bar");const s=this.element.querySelector(".layout-tab-container__drag");if(!s)return;this.headersElement.addEventListener("mousedown",o=>{if(o.button!==1)return;let r=o.target;for(;r&&!r.isEqualNode(this.headersElement);){if(r.tagName==="LI"){this.removeTab(r.getAttribute("data-id")),window.siyuan.menus.menu.remove(),o.stopPropagation(),o.preventDefault();const c=ie();if(["desktop","desktop-window"].includes(c)&&window.siyuan.config.system.os==="linux"||c==="browser-desktop"&&navigator.userAgent.indexOf("Linux")!==-1){const d=document.activeElement;window.addEventListener("paste",Zk(this,Yp,ty),{capture:!0,once:!0}),d instanceof HTMLElement&&d.focus(),setTimeout(()=>{window.removeEventListener("paste",Zk(this,Yp,ty),{capture:!0})},p.TIMEOUT_INPUT)}break}r=r.parentElement}}),this.headersElement.addEventListener("mousewheel",o=>{this.headersElement.scrollLeft=this.headersElement.scrollLeft+o.deltaY},{passive:!0}),this.headersElement.parentElement.addEventListener("click",o=>{let r=o.target;for(;r&&!r.isEqualNode(this.headersElement);){if(r.classList.contains("block__icon")&&r.getAttribute("data-type")==="new"){gt(this.headersElement.parentElement.parentElement),ki({app:e,useSavePath:!0});break}else if(r.classList.contains("block__icon")&&r.getAttribute("data-type")==="more"){this.renderTabList(r);break}else if(r.tagName==="LI"&&r.getAttribute("data-id")&&!Zl(this.element)){r.classList.contains("item--focus")?this.switchTab(r,!0,!0,!1,!1):this.switchTab(r,!0);break}r=r.parentElement}}),this.headersElement.parentElement.addEventListener("dblclick",o=>{let r=o.target;for(;r&&!r.isEqualNode(this.headersElement);){if(window.siyuan.config.fileTree.openFilesUseCurrentTab&&r.getAttribute("data-type")==="tab-header"){r.classList.remove("item--unupdate");break}r=r.parentElement}}),this.headersElement.parentElement.addEventListener("dragover",function(o){const r=this;if(window.siyuan.currentDragOverTabHeadersElement?window.siyuan.currentDragOverTabHeadersElement!==r&&(window.siyuan.currentDragOverTabHeadersElement.classList.remove("layout-tab-bars--drag"),window.siyuan.currentDragOverTabHeadersElement.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(m=>{m.remove()}),window.siyuan.currentDragOverTabHeadersElement=r):window.siyuan.currentDragOverTabHeadersElement=r,o.dataTransfer.types.includes(p.SIYUAN_DROP_FILE)){o.preventDefault(),r.classList.add("layout-tab-bars--drag");return}if(!o.dataTransfer.types.includes(p.SIYUAN_DROP_TAB))return;o.preventDefault();let c=window.siyuan.dragElement,d=!1;if(Array.from(r.firstElementChild.childNodes).find(m=>{var f;if(((f=m.style)==null?void 0:f.opacity)==="0.38")return c=m,d=!0,!0}),!d&&c){if(c.classList.contains("item--pin"))return;c=c.cloneNode(!0),c.setAttribute("data-clone","true"),r.firstElementChild.append(c);return}else!d&&!c&&(c=document.createElement("li"),c.style.opacity="0.38",c.innerHTML='<svg class="svg"><use xlink:href="#iconFile"></use></svg>',c.setAttribute("data-clone","true"),r.firstElementChild.append(c));const u=j(o.target,"data-type","tab-header");if(!u){c.classList.contains("item--pin")||r.classList.add("layout-tab-bars--drag");return}if(r.classList.remove("layout-tab-bars--drag"),u!==c&&(c.classList.contains("item--pin")&&u.classList.contains("item--pin")||!c.classList.contains("item--pin")&&!u.classList.contains("item--pin"))){const m=u.getClientRects()[0];o.clientX>m.left+m.width/2?u.after(c):u.before(c)}}),this.headersElement.parentElement.addEventListener("drop",function(o){var r;document.querySelectorAll(".layout-tab-bars--drag").forEach(h=>{h.classList.remove("layout-tab-bars--drag")});const c=this;if(o.dataTransfer.types.includes(p.SIYUAN_DROP_FILE)){gt(c.parentElement),o.dataTransfer.getData(p.SIYUAN_DROP_FILE).split(",").forEach(h=>{h&&ve({app:e,id:h,action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]})}),window.siyuan.dragElement=void 0;return}const d=JSON.parse(o.dataTransfer.getData(p.SIYUAN_DROP_TAB));let u=on(d.id);const m=on(c.parentElement.getAttribute("data-id"));if(!u)return;const f=(r=Array.from(c.firstElementChild.childNodes).find(h=>{var b;if(((b=h.style)==null?void 0:b.opacity)==="0.38")return!0}))==null?void 0:r.nextElementSibling;if(!c.contains(u.headElement)){const h=c.querySelector("[data-clone='true']");if(!h)return;h.before(u.headElement),h.remove(),m.moveTab(u,f?f.getAttribute("data-id"):void 0),Sn();return}let g;u.parent.children.find((h,b)=>{if(h.id===u.id)return g=u.parent.children.splice(b,1)[0],!0}),f?u.parent.children.find((h,b)=>{if(h.id===f.getAttribute("data-id"))return u.parent.children.splice(b,0,g),!0}):u.parent.children.push(g),bn()});let l=0;this.element.addEventListener("dragenter",o=>{if(l++,o.dataTransfer.types.includes(p.SIYUAN_DROP_TAB)){if(T(o.target,"layout-tab-bar"))return;T(o.target,"layout-tab-container",!0)&&(s.classList.remove("fn__none"),this.updateDragElement(o,s.parentElement.getBoundingClientRect(),s))}}),this.element.addEventListener("dragleave",()=>{l--,l===0&&(s.classList.add("fn__none"),s.removeAttribute("style"))}),s.addEventListener("dragover",o=>{document.querySelectorAll(".layout-tab-bars--drag").forEach(r=>{r.classList.remove("layout-tab-bars--drag")}),o.preventDefault(),s.nextElementSibling&&this.updateDragElement(o,s.parentElement.getBoundingClientRect(),s)}),s.addEventListener("dragleave",()=>{s.classList.add("fn__none"),s.removeAttribute("style")}),s.addEventListener("drop",o=>{s.classList.add("fn__none");const r=o.target.parentElement.parentElement,c=on(r.getAttribute("data-id")),d=JSON.parse(o.dataTransfer.getData(p.SIYUAN_DROP_TAB));let u=on(d.id);if(!u){s.removeAttribute("style");return}if(s.style.height==="50%"||s.style.width==="50%"){if(s.style.height==="50%"){const m=c.split("tb");m.headersElement.append(u.headElement),m.headersElement.parentElement.classList.remove("fn__none"),m.moveTab(u),s.style.bottom==="50%"&&m.element.previousElementSibling&&c.element.parentElement&&Ay(m,c)}else if(s.style.width==="50%"){const m=c.split("lr");m.headersElement.append(u.headElement),m.headersElement.parentElement.classList.remove("fn__none"),m.moveTab(u),s.style.right==="50%"&&m.element.previousElementSibling&&c.element.parentElement&&Ay(m,c)}Sn(),s.removeAttribute("style");return}s.removeAttribute("style"),!r.contains(document.querySelector(`[data-id="${d.id}"]`))&&c&&(id(),c.headersElement.append(u.headElement),c.headersElement.parentElement.classList.remove("fn__none"),c.moveTab(u),Sn())})}isPointWithinLines(e,n,a,i){const s=a.k*e+a.b,l=i.k*e+i.b;return n>=Math.min(s,l)&&n<=Math.max(s,l)}updateDragElement(e,n,a){const i=n.height,s=n.width,l=e.clientX-n.left,o=e.clientY-n.top;l<s/5&&this.isPointWithinLines(l,o,{k:1.5*i/s,b:-.15*i},{k:-1.25*i/s,b:1.05*i})?a.setAttribute("style","height:100%;width:50%;right:50%;bottom:0;left:0;top:0"):l>s*.8&&this.isPointWithinLines(l,o,{k:-1.5*i/s,b:1.35*i},{k:1.25*i/s,b:-.2*i})?a.setAttribute("style","height:100%;width:50%;right:0;bottom:0;left:50%;top:0"):o<i*.15?a.setAttribute("style","height:50%;width:100%;right:0;bottom:50%;left:0;top:0"):o>i*.8?a.setAttribute("style","height:50%;width:100%;right:0;bottom:0;left:0;top:50%"):a.setAttribute("style","height:100%;width:100%;right:0;bottom:0;left:0;top:0")}showHeading(){const e=this.headersElement.querySelector(".item--focus");e&&(e.offsetLeft+e.clientWidth>this.headersElement.scrollLeft+this.headersElement.clientWidth?this.headersElement.scrollLeft=e.offsetLeft+e.clientWidth-this.headersElement.clientWidth:e.offsetLeft<this.headersElement.scrollLeft&&(this.headersElement.scrollLeft=e.offsetLeft))}switchTab(e,n=!1,a=!0,i=!0,s=!0){let l,o=!1;if(this.children.forEach(r=>{var c;e===r.headElement?(r.headElement&&r.headElement.classList.contains("fn__none")||(r.headElement&&(r.headElement.classList.add("item--focus"),r.headElement.getAttribute("data-init-active")==="true"?(r.headElement.removeAttribute("data-init-active"),o=!0):(r.headElement.setAttribute("data-activetime",new Date().getTime().toString()),r.model instanceof Ot&&A("/api/storage/updateRecentDocViewTime",{rootID:r.model.editor.protyle.block.rootID}))),r.panelElement.classList.remove("fn__none")),l=r):((c=r.headElement)==null||c.classList.remove("item--focus"),r.panelElement.classList.contains("fn__none")||r.panelElement.classList.add("fn__none"))}),o||gt(this.headersElement.parentElement.parentElement,s),l&&l.headElement){const r=l.headElement.getAttribute("data-initdata");if(r){l.addModel(qS(this.app,l,JSON.parse(r))),l.headElement.removeAttribute("data-initdata"),s&&bn();return}}if(l&&e===l.headElement&&(l.model instanceof Ii?l.model.onGraph(!1):l.model instanceof ts&&l.model.pdfObject&&l.model.pdfObject.pdfViewer&&l.model.pdfObject.pdfViewer.container.focus()),l&&l.model instanceof Ot){const r=l.headElement.getAttribute("keep-cursor");if(r){let c;if(Array.from(l.model.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(d=>{if(!G(d))return c=d,!0}),c){if(!l.model.editor.protyle.toolbar.range){const d=document.createRange();d.selectNodeContents(c),d.collapse(),l.model.editor.protyle.toolbar.range=d}Ye(l.model.editor.protyle,c,"start")}else ve({app:this.app,id:r,action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]});l.headElement.removeAttribute("keep-cursor")}a&&fr({protyle:l.model.editor.protyle,focus:!0,pushBackStack:n,reload:!1,resize:i}),window.siyuan.editorIsFullscreen&&!l.model.editor.protyle.element.className.includes("fullscreen")&&(kl(l.model.editor.protyle.element),yb(l.model.editor.protyle))}else Qi();s&&bn()}addTab(e,n=!1,a=!0,i){var s;n&&((s=e.headElement)==null||s.classList.remove("item--focus"),e.panelElement.classList.add("fn__none"));let l=0;this.children.forEach((r,c)=>{var d;if(r.headElement&&r.headElement.classList.contains("item--focus")){l=c;let u=r.headElement.nextElementSibling;for(;u&&u.classList.contains("item--pin");)l++,u=u.nextElementSibling}n||((d=r.headElement)==null||d.classList.remove("item--focus"),r.panelElement.classList.add("fn__none"))}),this.children.splice(l+1,0,e),e.headElement&&(this.headersElement.parentElement.classList.remove("fn__none"),this.headersElement.childElementCount===0?this.headersElement.append(e.headElement):this.headersElement.children[l].after(e.headElement),e.headElement.querySelector(".item__close").addEventListener("click",r=>{e.headElement.classList.contains("item--pin")?e.unpin():e.parent.removeTab(e.id),window.siyuan.menus.menu.remove(),r.stopPropagation(),r.preventDefault()}),e.headElement.setAttribute("data-activetime",i||new Date().getTime().toString()));const o=this.element.querySelector(".layout-tab-container");o.querySelector(".fn__flex-1")?o.querySelector(".layout-tab-container__drag")?o.children[l+1].after(e.panelElement):o.children[l].after(e.panelElement):o.append(e.panelElement),e.parent=this,e.callback&&e.callback(e),this.parent.type==="center"&&this.children.length===2&&!this.children[0].headElement?this.removeTab(this.children[0].id):this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(a),a&&bn()}renderTabList(e){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TAB_LIST){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),Array.from(this.headersElement.children).forEach(a=>{var i;const s=a.querySelector(".item__icon"),l=a.querySelector(".item__graphic");let o;s?((i=s.firstElementChild)==null?void 0:i.tagName)==="IMG"?o=`<img src="${s.firstElementChild.getAttribute("src")}"  class="b3-menu__icon">`:o=`<span class="b3-menu__icon">${s.innerHTML}</span>`:l||(o=be(window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-menu__icon",!0)),window.siyuan.menus.menu.append(new N({label:he(a.querySelector(".item__text").textContent),action:"iconCloseRound",iconHTML:o,icon:l?l.firstElementChild.getAttribute("xlink:href").substring(1):"",bind:r=>{r.addEventListener("click",c=>{T(c.target,"b3-menu__action")?(this.removeTab(a.getAttribute("data-id")),r.previousElementSibling||r.nextElementSibling?(r.remove(),Te(window.siyuan.menus.menu.element,n.left+n.width-window.siyuan.menus.menu.element.clientWidth,n.top+n.height)):window.siyuan.menus.menu.remove()):(this.switchTab(a,!0),this.showHeading(),window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})},current:a.classList.contains("item--focus")}).element)}),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_TAB_LIST);const n=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:n.left+n.width,y:n.top+n.height,isLeft:!0})}removeOverCounter(e=!1){let n,a,i=0;this.children.forEach((s,l)=>{s.headElement&&(s.headElement.classList.contains("item--pin")||s.headElement.classList.contains("item--focus")||(i++,a?s.headElement.getAttribute("data-activetime")<a&&(a=s.headElement.getAttribute("data-activetime"),n=this.children[l].id):(a=s.headElement.getAttribute("data-activetime"),n=this.children[l].id)))}),n&&(this.removeTab(n,!1,!1,e),i--),i>0&&this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(e)}destroyModel(e){if(e){if(e instanceof Ot&&e.editor){window.siyuan.blockPanels.forEach(n=>{n.element&&e.editor.protyle.wysiwyg.element.contains(n.element)&&n.destroy()}),e.editor.destroy();return}if(e instanceof ns){e.editors.edit.destroy(),e.editors.unRefEdit.destroy();return}e instanceof ts&&e.pdfObject&&e.pdfObject.pdfLoadingTask&&e.pdfObject.pdfLoadingTask.destroy(),e instanceof fi&&e.destroy&&e.destroy(),e.send("closews",{})}}removeTab(e,n=!1,a=!0,i=!0){var s;for(let l=0;l<this.children.length;l++){const o=this.children[l];if(o.id===e){if(o.model instanceof Ot&&((s=o.model.editor)!=null&&s.protyle)){if(o.model.editor.protyle.upload.isUploading){de(window.siyuan.languages.uploading);return}this.removeTabAction(e,n,a,i)}else this.removeTabAction(e,n,a,i);return}}}moveTab(e,n){let a;if(e.model instanceof Ot&&e.model.editor.protyle.toolbar.range){const s=B(e.model.editor.protyle.toolbar.range.startContainer);if(s){const l=_t(s,void 0,e.model.editor.protyle.toolbar.range);a={id:s.getAttribute("data-node-id"),start:l.start,end:l.end}}}if(this.element.querySelector(".layout-tab-container").append(e.panelElement),a&&e.model instanceof Ot){const s=ha(e.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${a.id}"]`),a.start,a.end);s&&(e.model.editor.protyle.toolbar.range=s)}n?this.children.find((s,l)=>{if(s.id===n)return this.children.splice(l,0,e),!0}):this.children.push(e),this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter();const i=e.parent;if(i.children.length===1)i.children=[],i.remove();else if(i.children.find((s,l)=>{if(s.id===e.id)return i.children.splice(l,1),Sn(),!0}),!i.headersElement.querySelector(".item--focus")){let s;Array.from(i.headersElement.children).forEach(l=>{s?l.getAttribute("data-activetime")>s.getAttribute("data-activetime")&&(s=l):s=l}),s&&i.switchTab(s,!0)}this.switchTab(e.headElement),e.parent=this,_s(["toolbar"])}split(e){if(this.children.length===1&&!this.children[0].headElement)return this;id();const n=new N_(this.app,e);return e===this.parent.direction?this.parent.addWnd(n,this.id):this.parent.children.length===1?(this.parent.direction=e,e==="tb"?(this.parent.element.classList.add("fn__flex-column"),this.parent.element.classList.remove("fn__flex")):(this.parent.element.classList.remove("fn__flex-column"),this.parent.element.classList.add("fn__flex")),this.parent.addWnd(n,this.id)):this.parent.children.find((a,i)=>{if(a.id===this.id){const s=new Ua({resize:a.resize,direction:e});this.parent.addLayout(s,a.id);const l=this.parent.children.splice(i,1)[0];return l.resize&&(l.element.previousElementSibling.remove(),l.resize=void 0),s.addWnd.call(s,l),s.addWnd.call(s,n),e==="tb"&&l.element.style.width?(s.element.style.width=l.element.style.width,s.element.classList.remove("fn__flex-1"),l.element.style.width="",l.element.classList.add("fn__flex-1")):e==="lr"&&l.element.style.height&&(s.element.style.height=l.element.style.height,s.element.classList.remove("fn__flex-1"),l.element.style.height="",l.element.classList.add("fn__flex-1")),!0}}),n}remove(){let e=this.parent,n=this.element,a=this.id;for(;e&&e.children.length===1&&e.type!=="center";)a=e.id,n=e.element,e=e.parent;e.children.find((i,s)=>{if(i.id===a){if(e.children.length>1){let l=e.children[s-1];s===0&&(l=e.children[1]),e.children.length===2&&(e.direction==="lr"?l.element.style.width="":l.element.style.height="",l.resize=void 0,l.element.classList.add("fn__flex-1")),e.children.length>2&&s===0&&(e.children[1].resize=void 0)}return e.children.splice(s,1),!0}}),n.previousElementSibling&&n.previousElementSibling.classList.contains("layout__resize")?n.previousElementSibling.remove():n.nextElementSibling&&n.nextElementSibling.classList.contains("layout__resize")&&n.nextElementSibling.remove(),n.remove(),Ty(e),Sn()}};Yp=new WeakSet,ty=function(t){t.preventDefault(),t.stopPropagation()};let fd=y3;const qn=()=>{const t=[],e=Oe();return e.editor.forEach(n=>{t.push(n.editor)}),e.search.forEach(n=>{t.push(n.editors.edit),t.push(n.editors.unRefEdit)}),e.custom.forEach(n=>{var a;(a=n.editors)==null||a.forEach(i=>{t.push(i)})}),e.backlink.forEach(n=>{n.editors.forEach(a=>{t.push(a)})}),window.siyuan.dialogs.forEach(n=>{n.editors&&Object.keys(n.editors).forEach(a=>{t.push(n.editors[a])})}),window.siyuan.blockPanels.forEach(n=>{n.editors.forEach(a=>{t.push(a)})}),t},Oe=()=>{const t={editor:[],graph:[],asset:[],outline:[],backlink:[],search:[],inbox:[],files:[],bookmark:[],tag:[],custom:[]},e=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];if(i instanceof Dt){const s=i.model;s instanceof Ot?t.editor.push(s):s instanceof Ii?t.graph.push(s):s instanceof Is?t.outline.push(s):s instanceof Zi?t.backlink.push(s):s instanceof ts?t.asset.push(s):s instanceof ns?t.search.push(s):s instanceof Ki?t.files.push(s):s instanceof Wl?t.bookmark.push(s):s instanceof Ps?t.tag.push(s):s instanceof fi&&t.custom.push(s)}else e(i)}};return window.siyuan.layout.layout&&e(window.siyuan.layout.layout),t},pr=(t,e)=>{for(let n=0;n<t.children.length;n++){const a=t.children[n];a instanceof fd?e.push(a):a instanceof Ua&&pr(a,e)}},pi=()=>{const t=[],e=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];i instanceof Dt?t.push(i):e(i)}};return window.siyuan.layout.centerLayout&&e(window.siyuan.layout.centerLayout),t},zp=()=>{const t=[];return window.siyuan.config.uiLayout.left.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),window.siyuan.config.uiLayout.right.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),window.siyuan.config.uiLayout.bottom.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),t},as=(t=window.siyuan.languages._kernel[29])=>!1,ny=()=>!0;var _3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Gp=(t,e,n)=>{A("/api/block/getDocInfo",{id:t},a=>{e.updateTitle(a.data.name),n&&n.title&&n.title.setTitle(a.data.name)})},ay=(t,e,n=!0,a=!0,i=!1)=>{n&&At();const s=Oe();s.editor.forEach(l=>{e.upsertRootIDs.includes(l.editor.protyle.block.rootID)?A("/api/block/getDocInfo",{id:l.editor.protyle.block.rootID},o=>{l.editor.protyle.wysiwyg.renderCustom(o.data.ial),Ei(l.editor.protyle,!1,a),Gp(l.editor.protyle.block.rootID,l.parent,l.editor.protyle)}):e.removeRootIDs.includes(l.editor.protyle.block.rootID)&&(l.parent.parent.removeTab(l.parent.id,!1,!1),delete window.siyuan.storage[p.LOCAL_FILEPOSITION][l.editor.protyle.block.rootID],Ee(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION]))}),s.graph.forEach(l=>{l.type==="local"&&e.removeRootIDs.includes(l.rootId)?l.parent.parent.removeTab(l.parent.id,!1,!1):(l.type!=="local"||e.upsertRootIDs.includes(l.rootId))&&(l.searchGraph(!1),l.type==="local"&&Gp(l.rootId,l.parent))}),s.outline.forEach(l=>{l.type==="local"&&e.removeRootIDs.includes(l.blockId)?l.parent.parent.removeTab(l.parent.id,!1,!1):(l.type!=="local"||e.upsertRootIDs.includes(l.blockId))&&(A("/api/outline/getDocOutline",{id:l.blockId,preview:l.isPreview},o=>{l.update(o)}),l.type==="local"&&Gp(l.blockId,l.parent))}),s.backlink.forEach(l=>{l.type==="local"&&e.removeRootIDs.includes(l.rootId)?l.parent.parent.removeTab(l.parent.id,!1,!1):(l.refresh(),l.type==="local"&&Gp(l.rootId,l.parent))}),i||s.files.forEach(l=>{Gi(()=>{l.init(!1)})}),s.bookmark.forEach(l=>{l.update()}),s.tag.forEach(l=>{l.update()}),s.search.forEach(l=>{l.parent.panelElement.querySelector("#searchInput").dispatchEvent(new CustomEvent("input"))}),s.custom.forEach(l=>{l.update&&l.update()})},w3=t=>{qn().forEach(e=>{e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t.blockID}"] span[data-type~="block-ref"][data-subtype="d"][data-id="${t.defBlockID}"]`).forEach(n=>{n.innerHTML=t.refText})})},v3=t=>{qn().forEach(n=>{if(n.protyle.block.rootID===t.rootID&&n.protyle.title){const a=n.protyle.title.element.querySelector(".protyle-attr"),i=a.querySelector(".protyle-attr--refcount");i?t.rootRefCount===0?i.remove():i.textContent=t.rootRefCount.toString():t.rootRefCount>0&&a.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${t.rootRefCount}</div>`)}t.rootID!==t.blockID&&n.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t.blockID}"]`).forEach(a=>{const i=a.lastElementChild.querySelector(".protyle-attr--refcount");if(i)t.refCount===0?i.remove():i.textContent=t.refCount.toString();else if(t.refCount>0){const s=a.lastElementChild;s.childElementCount>0?s.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${t.refCount}</div>`):s.innerHTML=`<div class="protyle-attr--refcount popover__block">${t.refCount}</div>${p.ZWSP}`}t.refCount===0?a.removeAttribute("refcount"):a.setAttribute("refcount",t.refCount.toString())})});let e;if(e=nt("file").data.file.element.querySelector(`li[data-node-id="${t.rootID}"]`),e){const n=e.querySelector(".counter");n?t.rootRefCount===0?n.remove():n.textContent=t.rootRefCount.toString():t.rootRefCount>0&&e.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${t.rootRefCount}</span>`)}},jp=t=>{window.siyuan.config.readonly||(t.plugins.forEach(e=>{e.eventBus.emit("lock-screen")}),A("/api/system/logoutAuth",{},()=>{_A()}))},Jk=()=>{if(document.querySelector("#errorLog"))return;let t=`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${p.SIYUAN_VERSION}</small>`,e=`<div>${window.siyuan.languages.kernelFault1}</div><div class="fn__hr"></div><div>${window.siyuan.languages.kernelFault2}</div>`;$n()&&(t=`\u{1F375} ${window.siyuan.languages.pleaseWait} <small>v${p.SIYUAN_VERSION}</small>`,e=`<div>${window.siyuan.languages.reconnectPrompt}</div><div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const n=new $e({disableClose:!0,title:t,width:Y()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    ${e}
</div>
</div>`});n.element.id="errorLog",n.element.setAttribute("data-key",p.DIALOG_KERNELFAULT);const a=n.element.querySelector(".b3-button");a&&a.addEventListener("click",()=>{n.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},pd=()=>{},Ns=()=>_3(void 0,null,function*(){_s(["util"]),A("/api/system/exit",{force:!1},t=>{if(t.code===1){const e=de(t.msg,t.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${e}"] button`);n&&n.addEventListener("click",()=>{A("/api/system/exit",{force:!0},()=>{($n()||ht()||bt())&&(window.location.href="siyuan://api/system/exit")})})}else t.code===2?(At(),window.siyuan.config.system.container==="std"&&ipcRenderer.send(p.SIYUAN_SHOW_WINDOW),Re(window.siyuan.languages.tip,t.msg,()=>{A("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{A("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):($n()||ht()||bt())&&(window.location.href="siyuan://api/system/exit")})}),E3=()=>{if(document.getElementById("transactionError"))return;const t=new $e({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${p.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:Y()?"92vw":"520px"});t.element.setAttribute("data-key",p.DIALOG_STATEEXCEPTED);const e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{Un({errorExit:!0,cb:Ns})}),e[1].addEventListener("click",()=>{Xk(),t.destroy()})},Xk=t=>{window.siyuan.storage[p.LOCAL_FILEPOSITION]={},Ee(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION]),A("/api/system/rebuildDataIndex",{},()=>{t&&t()})};let Kp;const k3=t=>{const e=document.querySelector("#status");if(e)if(Y()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout(Kp),e.innerHTML=t.msg,e.style.bottom="0",Kp=window.setTimeout(()=>{e.style.bottom=""},12e3)}else{const n=e.querySelector(".status__msg");n&&(clearTimeout(Kp),n.innerHTML=t.msg,Kp=window.setTimeout(()=>{n.innerHTML=""},12e3))}},iy=t=>{let e=document.getElementById("progress");if(e||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),e=document.getElementById("progress")),t.code===2){e.remove();return}t.code===0?e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${t.data.current}/${t.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${t.data.current/t.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div class="ft__breakword">${he(t.msg)}</div>
</div>`:t.code===1&&(e.lastElementChild?e.lastElementChild.lastElementChild.innerHTML=he(t.msg):e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div class="ft__breakword">${he(t.msg)}</div>
</div>`)},S3=t=>{const e=document.querySelector(".status__backgroundtask");e&&(t.length===0?(e.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_STATUS_BACKGROUND_TASK&&window.siyuan.menus.menu.remove()):(e.classList.remove("fn__none"),e.setAttribute("data-tasks",JSON.stringify(t)),e.innerHTML=t[0].action+"<div><div></div></div>"))},L3=()=>{A("/api/sync/getBootSync",{},t=>{if(t.code===1){const e=new $e({width:Y()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${t.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});e.element.setAttribute("data-key",p.DIALOG_BOOTSYNCFAILED);const n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),A("/api/sync/performBootSync",{},a=>{a.code===0&&e.destroy(),n[1].removeAttribute("disabled")}))})}})},gd=t=>{const e=document.getElementById("drag"),n=uw();if(t===window.siyuan.languages.siyuanNote){const a=`${n} - ${window.siyuan.languages.siyuanNote} v${p.SIYUAN_VERSION}`;document.title=a,e&&(e.textContent=a,e.setAttribute("title",a))}else{if(t=t||window.siyuan.languages.untitled,document.title=`${t} - ${n} - ${window.siyuan.languages.siyuanNote} v${p.SIYUAN_VERSION}`,!e)return;e.setAttribute("title",t),e.innerHTML=he(t)}},A3=t=>{const e=document.querySelector("#configBazaarReadme .item__side");if(!e||t.id!==JSON.parse(e.getAttribute("data-obj")).repoURL)return;const n=e.querySelector('[data-type="install"]');n&&(t.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${t.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${t.percent*100}%"></span>`))},gi=(t,e)=>{const n=document.querySelector("#barSync");if(!n)return;const a=n.querySelector("use");if(!t){n.classList.remove("toolbar__item--active"),!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&as("")?a.setAttribute("xlink:href","#iconCloudOff"):a.setAttribute("xlink:href","#iconCloudSucc");return}n.firstElementChild.classList.remove("fn__rotate"),t.code===0?(n.classList.add("toolbar__item--active"),n.firstElementChild.classList.add("fn__rotate"),a.setAttribute("xlink:href","#iconRefresh")):t.code===2?(n.classList.remove("toolbar__item--active"),a.setAttribute("xlink:href","#iconCloudError")):t.code===1&&(n.classList.remove("toolbar__item--active"),a.setAttribute("xlink:href","#iconCloudSucc")),e.forEach(i=>{t.code===0?i.eventBus.emit("sync-start",t):t.code===1?i.eventBus.emit("sync-end",t):t.code===2&&i.eventBus.emit("sync-fail",t)})};var x3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const A=(t,e,n,a)=>{const i={method:"POST"};e&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(t)&&(window.siyuan.reqIds[t]=new Date().getTime(),e.type==="local"&&t==="/api/graph/getLocalGraph"||(e.reqId=window.siyuan.reqIds[t])),t==="/api/transactions"&&(e.reqId=new Date().getTime()),e instanceof FormData?i.body=e:i.body=JSON.stringify(e)),a&&(i.headers=a),fetch(t,i).then(s=>{var l;switch(s.status){case 403:case 404:return{data:null,msg:s.statusText,code:-s.status};default:return s.status==401&&setTimeout(()=>{window.location.reload()},3e3),((l=s.headers.get("content-type"))==null?void 0:l.indexOf("application/json"))>-1?s.json():s.text()}}).then(s=>{if(typeof s=="string"){n&&n(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(t)&&s.data.reqId&&window.siyuan.reqIds[t]&&window.siyuan.reqIds[t]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?Gm(s)&&n&&n(s):n&&n(s))}).catch(s=>{if(console.warn("fetch post failed ["+s+"], url ["+t+"]"),t==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){Jk();return}})},Ae=(t,e)=>x3(void 0,null,function*(){const n={method:"POST"};e&&(e instanceof FormData?n.body=e:n.body=JSON.stringify(e));const i=yield(yield fetch(t,n)).json();return Gm(i),i}),Qk=(t,e)=>{fetch(t).then(n=>{var a;return((a=n.headers.get("content-type"))==null?void 0:a.indexOf("application/json"))>-1?n.json():n.text()}).then(n=>{e(n)})},C3=(t=!1)=>{let e="";t||(e=`<div id="barDock" class="toolbar__item ariaLabel${window.siyuan.config.readonly||t?" fn__none":""}" aria-label="${window.siyuan.languages.toggleDock} ${pe(window.siyuan.config.keymap.general.toggleDock.custom)}">
    <svg>
        <use xlink:href="#${window.siyuan.config.uiLayout.hideDock?"iconDock":"iconHideDock"}"></use>
    </svg>
</div>`),document.getElementById("status").innerHTML=`${e}
<div class="status__msg"></div>
<div class="fn__flex-1"></div>
<div class="status__backgroundtask fn__none"></div>
<div class="status__counter"></div>
<div id="statusHelp" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.help}">
    <svg><use xlink:href="#iconHelp"></use></svg>
</div>`,document.querySelector("#status").addEventListener("click",n=>{let a=n.target;for(;a.id!=="status";){if(a.id==="barDock"){gb(a.firstElementChild.firstElementChild),n.stopPropagation();break}else if(a.classList.contains("status__backgroundtask")){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_STATUS_BACKGROUND_TASK){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_STATUS_BACKGROUND_TASK),JSON.parse(a.getAttribute("data-tasks")).forEach(s=>{window.siyuan.menus.menu.append(new N({type:"readonly",iconHTML:"",label:s.action}).element)});const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),n.stopPropagation();break}else if(a.id==="statusHelp"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_STATUS_HELP){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_STATUS_HELP),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.userGuide,icon:"iconHelp",ignore:Ha()||window.siyuan.config.readonly,click:()=>{rp()}}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages._trayMenu.officialWebsite,icon:"iconSiYuan",click:()=>{window.open("https://b3log.org/siyuan")}}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages._trayMenu.openSource,icon:"iconGithub",click:()=>{window.open("https://github.com/siyuan-note/siyuan")}}).element);const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),n.stopPropagation();break}else if(a.classList.contains("b3-menu__item")){const i=a.getAttribute("data-type");if(nt(i).toggleModel(i),i==="file"&&getSelection().rangeCount>0){const s=getSelection().getRangeAt(0),l=T(s.startContainer,"protyle-wysiwyg",!0);l&&l.blur()}a.parentElement.classList.add("fn__none"),n.stopPropagation();break}a=a.parentElement}}),window.siyuan.config.appearance.hideStatusBar&&document.getElementById("status").classList.add("fn__none")};let Hs,md;const Vl=(t,e)=>{document.getElementById("status").classList.contains("fn__none")||(clearTimeout(md),md=window.setTimeout(()=>{t.toString()?(A("/api/block/getContentWordCount",{content:t.toString()},a=>{Zp(a.data.stat)}),Hs=""):e&&e!==Hs&&(Hs=e,A("/api/block/getTreeStat",{id:e},a=>{Zp(a.data.stat)}))},p.TIMEOUT_COUNT))},Pn=(t,e,n=!1)=>{if(!document.getElementById("status").classList.contains("fn__none")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).toString()&&t.length===0){Vl(getSelection().getRangeAt(0));return}clearTimeout(md),md=window.setTimeout(()=>{n&&(Hs=""),t.length>0?(A("/api/block/getBlocksWordCount",{ids:t},a=>{Zp(a.data.stat)}),Hs=""):e&&e!==Hs&&(Hs=e,A("/api/block/getTreeStat",{id:e},a=>{Zp(a.data.stat)}))},p.TIMEOUT_COUNT)}},T3=()=>{Hs="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(md)},Zp=t=>{if(!t)return;let e=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${t.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${t.wordCount}<span class="fn__space"></span>`;0<t.linkCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${t.linkCount}<span class="fn__space"></span>`),0<t.imageCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${t.imageCount}<span class="fn__space"></span>`),0<t.refCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${t.refCount}<span class="fn__space"></span>`),0<t.blockCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.blockCount}</span>&nbsp;${t.blockCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=e},D3=(t,e)=>{if(!e){if(getSelection().rangeCount===0)return!1;e=getSelection().getRangeAt(0)}const n=e.commonAncestorContainer;return t.isEqualNode(n)||t.contains(n)},sy=t=>{const e=j(t.startContainer,"data-type","NodeTable");if(t.toString()!==""&&e&&t.commonAncestorContainer.nodeType!==3){const n=t.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=U(t.startContainer,"TD")||U(t.startContainer,"TH"),i=U(t.endContainer,"TD")||U(t.endContainer,"TH");if(!a&&!i){const s=e.querySelector("th")||e.querySelector("td");t.setStart(s.firstChild,0),t.setEnd(s.lastChild,s.lastChild.textContent.length)}else a&&!a.contains(t.endContainer)&&Yt(a,t,!1)}}},Jp=(t,e,n)=>{const a=fe(e);if(a){let l;if(a.tagName==="TABLE"){const o=U(n.startContainer,"TD")||U(n.startContainer,"TH");if(o&&(l=_t(o,e,n),l.start!==0||l.end!==o.textContent.length))return n.setStart(o.firstChild,0),n.setEndAfter(o.lastChild),t.toolbar.render(t,n),Vl(n,t.block.rootID),!0}else if(l=_t(a,e,n),l.start!==0||l.end!==a.textContent.length){let o=a.firstChild;for(;o;)if(o.nodeType===3){if(o.textContent!==""){n.setStart(o,0);break}o=o.nextSibling}else{if(o.classList.contains("render-node")||o.classList.contains("img")){n.setStartBefore(o);break}o=o.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return ne(n),t.toolbar.render(t,n),Vl(n,t.block.rootID),!0}}n.collapse(!0);const i=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.wysiwyg.element.childElementCount===i.length&&i[0].parentElement===t.wysiwyg.element)return!0;ce(["select"],t);const s=[];Array.from(t.wysiwyg.element.children).forEach(l=>{const o=l.getAttribute("data-node-id");o&&(l.classList.add("protyle-wysiwyg--select"),s.push(o))}),Pn(s,t.block.rootID)},ly=(t,e)=>{const n=document.caretRangeFromPoint(t,e),a=j(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},ke=t=>{var e,n,a;let i;if(getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),t===i.startContainer||t.contains(i.startContainer))){if(i.toString()===""&&i.startContainer.nodeType===1){if(i.startOffset===0&&i.startContainer.classList.contains("protyle-wysiwyg")){const l=oe(i.startContainer.firstChild);if(l)return l}if(i.startContainer.getAttribute("contenteditable")!=="true"&&fe(i.startContainer)){const l=B(i.startContainer);if(l){const o=oe(l);if(o)return o}}}return i}if(t.classList.contains("li")||t.classList.contains("list")){const l=t.querySelector("[data-node-id]");if(l)return ke(l)}t.focus({preventScroll:!0}),i||(i=document.createRange());let s;if(t.classList.contains("table"))s=t.querySelector("th")||t.querySelector("td");else if(s=fe(t),s)s.tagName==="TABLE"&&(s=s.querySelector("th")||t.querySelector("td"));else{const l=t.getAttribute("data-type");l==="NodeThematicBreak"?s=t.firstElementChild:l==="NodeBlockQueryEmbed"?s=(e=t.querySelector(".protyle-cursor"))==null?void 0:e.firstChild:["NodeMathBlock","NodeHTMLBlock"].includes(l)?s=(a=(n=t.lastElementChild.previousElementSibling)==null?void 0:n.lastElementChild)==null?void 0:a.firstChild:l==="NodeVideo"?s=t.firstElementChild.firstChild:l==="NodeAudio"&&(s=t.firstElementChild.lastChild)}return i.setStart(s||t,0),i.collapse(!0),i},Ca=(t,e,n=!1)=>{var a,i;if(e||(e=ke(t)),!t.contains(e.startContainer))return{left:0,top:0};let s;if(e.getClientRects().length===0)if(e.startContainer.nodeType===3){const l=(a=e.startContainer.parentElement)==null?void 0:a.getClientRects(),o=(i=e.startContainer.previousElementSibling)==null?void 0:i.getClientRects();if(l.length>0||o.length>0)l.length===0||o&&o.length>0&&l[0].top<o[o.length-1].bottom?s={left:o[o.length-1].left,top:o[o.length-1].bottom}:s=l[0];else return{left:0,top:0}}else{const l=e.startContainer.children;if(l[e.startOffset]&&l[e.startOffset].getClientRects().length>0)s=l[e.startOffset].getClientRects()[0];else if(e.startContainer.childNodes.length>0){const o=e.cloneRange();e.selectNode(e.startContainer.childNodes[Math.max(0,e.startOffset-1)]),s=e.getClientRects()[0],e.setEnd(o.endContainer,o.endOffset),e.setStart(o.startContainer,o.startOffset)}else s=e.startContainer.getClientRects()[0];if(!s){let o=e.startContainer.childNodes[e.startOffset];if(o||(o=e.startContainer.childNodes[e.startOffset-1]),!o)s=e.getBoundingClientRect();else{for(;!o.getClientRects||o.getClientRects&&o.getClientRects().length===0;)o=o.parentElement;s=o.getClientRects()[0]}}}else{const l=e.getClientRects();if(e.toString())if(n){const o=window.getSelection(),r=o&&"direction"in o&&o.direction!=="none"?o.direction==="backward":e.startContainer===(o==null?void 0:o.focusNode)&&e.startOffset===(o==null?void 0:o.focusOffset),c=!r&&l[0].top!==l[l.length-1].top;return{left:r?l[0].left:l[l.length-1].right,top:c?l[l.length-1].bottom:l[0].top,isBottom:c}}else return{left:l[l.length-1].left,top:l[0].top};else return{left:l[l.length-1].left,top:l[l.length-1].top}}return{left:s.left,top:s.top}},_t=(t,e,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(e&&!D3(e,n))return a;const i=n.cloneRange();return t.childNodes[0]&&t.childNodes[0].childNodes[0]?i.setStart(t.childNodes[0].childNodes[0],0):i.selectNodeContents(t),i.setEnd(n.startContainer,n.startOffset),a.start=i.toString().length+i.cloneContents().querySelectorAll("br").length,a.end=a.start+n.toString().length+n.cloneContents().querySelectorAll("br").length,a};function Xp(t,e,n,a){if(!e)return!1;if(n(e))return!0;for(let i=0,s=e.childNodes.length;i<s;i++)if(Xp(e,e.childNodes[i],n,!0))return!0;if(!a){let i=e;for(;i&&i!==t;){let s=i.nextSibling;for(;s;){if(Xp(t,s,n,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const Yt=(t,e,n=!0)=>{if(!t)return e;let a=t.lastChild;for(;a&&a.nodeType!==3&&a.lastChild;)a=a.lastChild;return a||(a=t),n?a.nodeType!==3&&(a.classList.contains("render-node")||a.tagName==="BR")&&a.innerHTML===""?e.setStartAfter(a):e.setStart(a,a.textContent.length):a.nodeType!==3&&(a.classList.contains("render-node")||a.tagName==="BR")&&a.innerHTML===""?e.setEndAfter(a):e.setEnd(a,a.textContent.length),e},Yl=(t,e)=>{if(!t)return e;let n=t.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return e.setStartBefore(n),e;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?e.setStartBefore(n):e.setStart(n,0),e):(e.selectNodeContents(t),e)},ha=(t,e,n,a=!0)=>{if(!t)return!1;const i=fe(t);if(i)t=i;else if(a&&(An(t)||t.classList.contains("av")))return oe(t);let s;Xp(t,t.firstChild,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return e<=c?(s=r,!0):(e-=c,n-=c,!1)}else if(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="BR")return e<=1?(s=r,!0):(e-=1,n-=1,!1)});let l;s&&Xp(t,s,r=>{if(r.nodeType===Node.TEXT_NODE){const c=r.data.length;return n<=c?(l=r,!0):(n-=c,!1)}});const o=document.createRange();return s?s.nodeType===Node.TEXT_NODE&&e<=s.data.length?o.setStart(s,e):o.setStartAfter(s):e===0?o.setStart(t,0):Yt(fe(t),o),l?n<=l.data.length?o.setEnd(l,n):o.setEndAfter(l):n===0?o.setEnd(t,0):Yt(fe(t),o,!1),a&&ne(o),o},hd=(t,e,n)=>{const a=fe(t);if(!a)return;const i=_t(a,t,e),s=t.cloneNode(!0),l=ha(s,i.end,i.end,!1);l&&l.insertNode(document.createElement("wbr")),n.wysiwyg.lastHTMLs[t.getAttribute("data-node-id")]=s.outerHTML},we=(t,e)=>{var n;const a=t.querySelectorAll("wbr");if(a.length===0)return;a.forEach((s,l)=>{l!==0&&s.remove()});const i=a[0];if(!i.previousElementSibling)i.previousSibling?e.setStart(i.previousSibling,i.previousSibling.textContent.length):i.nextSibling?i.nextSibling.nodeType===3?e.setStart(i.nextSibling,0):e.setStartAfter(i):e.setStart(i.parentElement,0);else{const s=pt(i);s&&i.previousElementSibling===s?((n=i.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?e.setStart(i.previousElementSibling.lastChild,i.previousElementSibling.lastChild.textContent.length):s.nodeType!==3&&s.classList.contains("img")?e.setStartAfter(s):e.setStartBefore(i):e.setStart(i.previousSibling,i.previousSibling.textContent.length)}e.collapse(!0),i.remove(),ne(e)},ne=t=>{if(!t)return;const e=t.startContainer.childNodes[t.startOffset];if(e&&e.nodeType!==3&&["INPUT","TEXTAREA"].includes(e.tagName)){e.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(t)},oe=(t,e,n=!0)=>{if(!t)return!1;if(t.classList.contains("render-node")||t.classList.contains("iframe")||t.classList.contains("hr")||t.classList.contains("av")){const i=document.createRange(),s=t.getAttribute("data-type");let l=!1;if(s==="NodeThematicBreak")i.selectNodeContents(t.firstElementChild),l=!0;else if(s==="NodeBlockQueryEmbed")vc(t),i.setStart(t.querySelector(".protyle-cursor").firstChild,0),i.collapse(!0),l=!0;else if(s==="NodeMathBlock")vc(t),i.setStart(t.firstElementChild.lastElementChild.firstChild,0),l=!0;else if(s==="NodeHTMLBlock")i.setStart(t.lastElementChild.previousElementSibling.lastElementChild.firstChild,0),i.collapse(!0),l=!0;else if(s==="NodeIFrame"||s==="NodeWidget")i.setStart(t,0),l=!0;else if(s==="NodeVideo")i.setStart(t.firstElementChild.firstChild,0),l=!0;else if(s==="NodeAudio")i.setStart(t.firstElementChild.lastChild,0),l=!0;else if(s==="NodeCodeBlock")i.selectNodeContents(t),i.collapse(!0),l=!0;else if(s==="NodeAttributeView"){const o=t.querySelector(".av__cursor");if(o)i.setStart(o.firstChild,0),l=!0;else return t.setAttribute("data-need-focus","true"),!1}return l?(ne(i),i):(oy(t),!1)}let a;if(n?a=fe(t):Array.from(t.querySelectorAll('[contenteditable="true"]')).reverse().find(i=>{if(i.getBoundingClientRect().width>0)return a=i,!0}),a){if(a.tagName==="TABLE")if(n)a=a.querySelector("th, td");else{const s=a.querySelectorAll("th, td");a=s[s.length-1]}let i;if(n)i=Yl(a,ke(a)),i.collapse(!0);else{let s=!1;if(t.getAttribute("data-type")==="NodeCodeBlock"){let l=a.lastChild;if(l||(a.innerHTML=`
`,l=a.lastChild),l.textContent===""&&l.nodeType===3&&(l=pt(a.lastChild)),l&&l.textContent.endsWith(`
`)){if(l.nodeType===1)for(l=l.lastChild;l&&l.textContent.indexOf(`
`)===-1;)l=l.previousSibling;i=ke(a),i.setStart(l,l.textContent.length-1),s=!0}}s||(i=Yt(a,ke(a))),i.collapse(!1)}return ne(i),i}else if(e)e.focus();else if(t.classList.contains("li"))return oe(t.querySelector("[data-node-id]"),e,n);return!1},oy=t=>{if(t.getAttribute("data-node-id")){let n,a;t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=mt(t)):t.previousElementSibling&&(a=!1,n=Qe(t)),n||(n=t),oe(n,void 0,a);return}const e=ke(t);t.nextSibling?(e.selectNodeContents(t.nextSibling),e.collapse(!0)):t.previousSibling&&(e.selectNodeContents(t.previousSibling),e.collapse(!1)),ne(e)},Qp=(t,e,n)=>{e&&(Yt(fe(n[n.length-1]),t.toolbar.range),t.toolbar.range.collapse(!0),Ht(t.lute.SpinBlockDOM(e),t,!0,!0),We(t,t.wysiwyg.element),Ct(t.wysiwyg.element),rt(t.wysiwyg.element))},I3=(t,e)=>{const n=new $e({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});n.element.setAttribute("data-key",p.DIALOG_AIUPDATECUSTOMACTION);const a=n.element.querySelector("input");a.value=t;const i=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(i,()=>{s[2].click()}),i.value=e,s[1].addEventListener("click",()=>{n.destroy()}),s[2].addEventListener("click",()=>{window.siyuan.storage[p.LOCAL_AI].find(l=>{if(t===l.name&&e===l.memo)return l.name=a.value,l.memo=i.value,Ee(p.LOCAL_AI,window.siyuan.storage[p.LOCAL_AI]),!0}),n.destroy()}),s[0].addEventListener("click",()=>{window.siyuan.storage[p.LOCAL_AI].find((l,o)=>{if(t===l.name&&e===l.memo)return window.siyuan.storage[p.LOCAL_AI].splice(o,1),Ee(p.LOCAL_AI,window.siyuan.storage[p.LOCAL_AI]),!0}),n.destroy()}),a.focus()},eS=(t,e,n)=>{const a=new $e({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:Y()?"92vw":"520px"});a.element.setAttribute("data-key",p.DIALOG_AICUSTOMACTION);const i=a.element.querySelector("input"),s=a.element.querySelector("textarea"),l=a.element.querySelectorAll(".b3-button");a.bindInput(s,()=>{l[1].click()}),l[0].addEventListener("click",()=>{a.destroy()}),l[1].addEventListener("click",()=>{if(!s.value){de(window.siyuan.languages._kernel[142]);return}A("/api/ai/chatGPTWithAction",{ids:e,action:s.value},o=>{a.destroy(),Qp(t,o.data,n)})}),l[2].addEventListener("click",()=>{if(!i.value&&!s.value){de(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[p.LOCAL_AI].push({name:i.value,memo:s.value}),Ee(p.LOCAL_AI,window.siyuan.storage[p.LOCAL_AI]),a.destroy()}),i.focus()},tS=(t,e)=>{t.querySelectorAll(".b3-list-item").forEach(n=>{n.textContent.indexOf(e.value)>-1?n.classList.remove("fn__none"):n.classList.add("fn__none")}),t.querySelectorAll(".b3-menu__separator").forEach(n=>{e.value?n.classList.add("fn__none"):n.classList.remove("fn__none")}),t.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),t.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},ry=(t,e)=>{window.siyuan.menus.menu.remove();const n=[];t.forEach(o=>{n.push(o.getAttribute("data-node-id"))});const a=new dt(p.MENU_AI,()=>{ne(e.toolbar.range)});let i="";window.siyuan.storage[p.LOCAL_AI].forEach((o,r)=>{i+=`<div data-action="${at(o.memo||o.name)}" data-index="${r}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${Zt(o.memo)}">
    <span class="b3-list-item__text">${he(o.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),i&&(i=`<div class="b3-menu__separator"></div>${i}`);const s="Clear context";a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${s}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${i}
    </div>
</div>`,bind(o){const r=o.querySelector(".b3-list"),c=o.querySelector("input");c.addEventListener("keydown",d=>{if(d.isComposing)return;if(xn(r,d)&&d.stopPropagation(),d.key==="Enter"){d.preventDefault(),d.stopPropagation();const m=r.querySelector(".b3-list-item--focus");m.dataset.type==="custom"?(eS(e,n,t),a.close()):(A("/api/ai/chatGPTWithAction",{ids:n,action:m.dataset.action},f=>{Qp(e,f.data,t)}),m.dataset.action===s?de(window.siyuan.languages.clearContextSucc):a.close())}}),c.addEventListener("compositionend",()=>{tS(o,c)}),c.addEventListener("input",d=>{d.isComposing||tS(o,c)}),o.addEventListener("click",d=>{let u=d.target;for(;u&&u!==o;){if(u.classList.contains("b3-list-item__action")){const m=window.siyuan.storage[p.LOCAL_AI][u.parentElement.dataset.index];I3(m.name,m.memo),a.close(),d.stopPropagation(),d.preventDefault();break}else if(u.classList.contains("b3-list-item")){u.dataset.type==="custom"?(eS(e,n,t),a.close()):(A("/api/ai/chatGPTWithAction",{ids:n,action:u.dataset.action},m=>{Qp(e,m.data,t)}),u.dataset.action===s?de(window.siyuan.languages.clearContextSucc):a.close()),d.stopPropagation(),d.preventDefault();break}u=u.parentElement}})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const l=t[t.length-1].getBoundingClientRect();a.open({x:l.left,y:l.bottom,h:l.height}),a.element.querySelector("input").focus()},nS=(t,e)=>{const n=new $e({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"}),a=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()}),a.focus(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{let s=a.value;A("/api/ai/chatGPT",{msg:s},l=>{n.destroy();let o="";l.data&&l.data!==""&&(o=`

`+l.data),s==="Clear context"&&(s=""),Qp(t,`${s}${o}`,[e])})})};class $3{constructor(e){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var a;const i=n.target;if(i.tagName==="INPUT"){n.stopPropagation();return}const s=U(i,"BUTTON");if(s&&!s.classList.contains("emojis__item")&&!s.classList.contains("emojis__type")){this.fill(decodeURIComponent(s.getAttribute("data-value")),e,!1,this.source==="search"?et(n):Wt(n)),n.preventDefault(),n.stopPropagation();return}const l=this.element.querySelector(".emojis__panel"),o=T(i,"emojis__type");if(o){const c=l.querySelector(`[data-type="${o.getAttribute("data-type")}"]`);if(c){const d=c.nextElementSibling.getAttribute("data-index");if(d){let u="";window.siyuan.emojis[parseInt(d)].items.forEach(m=>{u+=`<button data-unicode="${m.unicode}" class="emojis__item ariaLabel" aria-label="${El(m)}">
${be(m.unicode)}</button>`}),c.nextElementSibling.innerHTML=u,c.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:c.offsetTop})}return}const r=T(i,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const d=getSelection().getRangeAt(0);d.endContainer.nodeType!==3?(a=d.endContainer.childNodes[d.endOffset-1])==null||a.remove():d.endContainer.textContent===":"&&(d.endContainer.textContent=""),wl(c);let u;c.indexOf(".")>-1?u=`:${c.split(".")[0]}: `:u=be(c)+" ",Ht(e.lute.SpinBlockDOM(u),e,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,e)}})}render(e){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(e.toolbar.range=getSelection().getRangeAt(0),e.toolbar.range.startContainer.nodeType===3&&e.toolbar.range.startContainer.textContent===""){const s=pt(e.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let l=s.previousSibling;for(;l&&l.nodeType===3;)if(l.textContent==="")l=l.previousSibling,l.nextSibling.remove();else{s.textContent=l.textContent+s.textContent,l.remove();break}}e.toolbar.range.setStart(s,s.textContent.length),e.toolbar.range.collapse(!0)}}const n=_t(e.toolbar.range.startContainer,e.wysiwyg.element).start,a=e.toolbar.range.startContainer.textContent.substring(0,n)||"",i=this.getKey(a,e.options.hint.extend);if(typeof i=="undefined"||j(e.toolbar.range.startContainer,"data-type","code")||j(e.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=B(e.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const l=_t(e.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(l))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(e,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!Y()&&this.genHTML(Mh(i,e),e,!1,"hint");return}e.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,e,"hint"),e,!1,"hint")},e.options.hint.delay))})}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=Ca(e.wysiwyg.element);Te(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(e,n){n.querySelectorAll('input[type="file"]').forEach(a=>{a.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=ke(e.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),Ai(e,i.target.files,i.target),ce(["hint","toolbar"],e)})})}getHTMLByData(e){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),e.forEach((a,i)=>{let s="";(i===1&&e[i].focus||i===0&&(e.length===1||!e[1].focus))&&(s=" b3-list-item--focus"),a.html==="separator"?n+=`<button data-id="${a.id||""}" class="b3-menu__separator"></button>`:n+=`<button data-id="${a.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(e,n,a=!1,i){var s;if(this.source=i,e.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(e),this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.source==="av"){const o=T(n.toolbar.range.startContainer,"av__cell");if(o){const r=o.getBoundingClientRect();Te(this.element,r.left,r.bottom,r.height)}}else{const o=Ca(n.wysiwyg.element);Te(this.element,o.left,o.top+26,30)}this.element.scrollTop=0;let l=this.element.querySelector(".b3-list-item--focus");for(;qo(l,"b3-list-item");)l.classList.remove("b3-list-item--focus"),l=l.nextElementSibling,l==null||l.classList.add("b3-list-item--focus");if(this.bindUploadEvent(n,this.element),this.source!=="hint"){const o=this.element.querySelector("input.b3-text-field"),r=((s=this.element.querySelector("mark"))==null?void 0:s.textContent)||"";o.value=r,o.select(),o.addEventListener("keydown",d=>{d.key!=="Meta"&&d.key!=="Control"&&d.stopPropagation(),!d.isComposing&&(xn(this.element.lastElementChild,d),d.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!1,et(d)),d.preventDefault()):d.key==="Escape"&&(this.element.classList.add("fn__none"),ne(n.toolbar.range)))});const c=n.toolbar.range?B(n.toolbar.range.startContainer):!1;o.addEventListener("input",d=>{d.isComposing||(d.stopPropagation(),this.genSearchHTML(n,o,c,r,i))}),o.addEventListener("compositionend",d=>{d.stopPropagation(),this.genSearchHTML(n,o,c,r,i)})}}genSearchHTML(e,n,a,i,s){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',A("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:s==="av"?"":e.block.rootID,isDatabase:s==="av"},l=>{let o="";if(l.data.newDoc){const r=`((newFile "${i}"${p.ZWSP}'${l.data.k}${Lute.Caret}'))`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${l.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${l.data.k}</mark></span></div></button>`}l.data.blocks.forEach((r,c)=>{let d;if(s==="av"){let u=r.name||r.refText.replace(new RegExp(p.ZWSP,"g"),"");a&&(u=r.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||u),d=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${u}</span>`}else d=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${i}</span>`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${c===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(d)}">
${Ph(r)}
</button>`}),o===""&&(o=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=o,Te(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(e,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=wc(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),_c(a)):(this.element.innerHTML=`<div style="padding:0;max-height:min(402px,40vh);width:366px" class="emojis">
<div class="emojis__panel">${wc(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",vn(0)],["1f60d",vn(1)],["1f433",vn(2)],["1f96a",vn(3)],["1f3a8",vn(4)],["1f3dd-fe0f",vn(5)],["1f52e",vn(6)],["267e-fe0f",vn(7)],["1f6a9",vn(8)]].map(([s,l],o)=>`<button data-type="${o}" class="emojis__type ariaLabel" aria-label="${l}">${be(s)}</button>`).join("")}
</div>
</div>`,Pf(this.element),_c(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none");const s=Ca(e.wysiwyg.element);Te(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,n,a=!0,i=!1){var s;ce(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=ke(n.wysiwyg.element));const l=n.toolbar.range;let o=B(n.toolbar.range.startContainer);if(!o)return;if(this.source==="av"){let u=T(n.toolbar.range.startContainer,"av__cell");if(u||(u=o.querySelector(".av__cell--select")),!u)return;const m=T(u,o.getAttribute("data-av-type")==="table"?"av__row":"av__gallery-item");if(!m)return;const f=m.dataset.id,g=o.getAttribute("data-av-id");let h=document.createElement("div");if(h.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),h=h.firstElementChild,e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const b=e.substring(11,e.length-4).split(`"${p.ZWSP}'`),y=b.length===1?b[0]:b[1],w=Lute.NewNodeID();m.dataset.id=w,hh(n.path,n.notebookId,(E,C)=>{A("/api/filetree/createDocWithMd",{notebook:C,path:De().join(E,y),parentID:n.notebookId===C?n.block.rootID:"",markdown:"",id:w},()=>{V(n,[{action:"replaceAttrViewBlock",avID:g,previousID:f,nextID:w,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:w,nextID:f,isDetached:!0}])})}),On(u,{type:"block",isDetached:!1,block:{content:y,id:w}})}else{const b=h.getAttribute("data-id");m.dataset.id=b,V(n,[{action:"replaceAttrViewBlock",avID:g,previousID:f,nextID:b,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:b,nextID:f,isDetached:!0}]),On(u,{type:"block",isDetached:!1,block:{content:h.textContent,id:b}})}return}this.enableExtend=!1;let r="";o&&(r=o.getAttribute("data-node-id"));const c=o.outerHTML,d=p.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(p.BLOCK_HINT_KEYS.includes(this.splitChar)&&d&&l.startContainer.nodeType===3&&l.startContainer.wholeText.indexOf(d)>-1&&l.startContainer.wholeText.indexOf(this.splitChar)>-1){let u=0,m=l.startContainer;for(;m&&u<2;){const f=m.textContent.indexOf(d),g=m.textContent.indexOf(this.splitChar);if(f>-1&&(f<g||g<0)){u=2,l.setEnd(m,f+2);break}const h=m.textContent.indexOf(d.substr(1));if(h>-1&&(u+=1),u===2){l.setEnd(m,h+1);break}m=m.nextSibling}}if(this.lastIndex>-1&&(l.setStart(l.startContainer,this.lastIndex),ne(l)),p.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const u=e.substring(11,e.length-4).split(`"${p.ZWSP}'`),m=u.length===1?u[0]:u[1];hh(n.path,n.notebookId,(f,g)=>{A("/api/filetree/createDocWithMd",{notebook:g,path:De().join(f,m),parentID:n.notebookId===g?n.block.rootID:"",markdown:""},h=>{n.toolbar.range=l;const b=n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${h.data}${p.ZWSP}${i?"s":"d"}${p.ZWSP}${(i?u[0]:m).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`});b[0]&&n.toolbar.range.setEnd(b[0].lastChild,b[0].lastChild.textContent.length),n.toolbar.range.collapse(!1)})});return}if(p.BLOCK_HINT_KEYS.includes(this.splitChar)){if(e===""){const f=fe(o);f.textContent===""&&(f.innerHTML="<wbr>",we(f,l));return}let u=document.createElement("div");if(u.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),u=u.firstElementChild,i){const f=l.toString().replace(this.splitChar,"");f&&(u.setAttribute("data-subtype","s"),u.innerText=f)}else{u.setAttribute("data-subtype","d");const f=u.innerText.split(p.ZWSP);f.length===2&&(u.innerText=f[1])}const m=n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${u.getAttribute("data-id")}${p.ZWSP}${u.getAttribute("data-subtype")}${p.ZWSP}${u.textContent}`});m[0]&&n.toolbar.range.setEnd(m[0].lastChild,m[0].lastChild.textContent.length),n.toolbar.range.collapse(!1);return}else if(this.splitChar===":"){wl(e);let u;e.indexOf(".")>-1?u=`:${e.split(".")[0]}: `:u=be(e)+" ",Ht(n.lute.SpinBlockDOM(u),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(e===""){const u=fe(o);u.textContent===""&&(u.innerHTML="<wbr>",we(u,l));return}Ht(n.lute.SpinBlockDOM(e),n,!1,Y()),We(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,e==="(("||e==="{{"){e==="(("?As("",n,"hint"):Zo("",n),this.splitChar=e,this.lastIndex=0,l.deleteContents();const u=document.createTextNode(e);l.insertNode(u),l.setEnd(u,e.length),l.collapse(!1),ne(l);return}else if(e===p.ZWSP){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showTpl(n,o,l),le(n,r,o.outerHTML,c);return}else if(e===p.ZWSP+1){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showWidget(n,o,l),le(n,r,o.outerHTML,c);return}else if(e===p.ZWSP+2){l.deleteContents(),this.fixImageCursor(l),n.toolbar.range=l;const u=Ca(o,l);Oh(n,{x:u.left,y:u.top+26,w:0,h:26}),le(n,r,o.outerHTML,c);return}else if(e===p.ZWSP+3){l.deleteContents();return}else if(e===p.ZWSP+4){ki({app:n.app,notebookId:n.notebookId,useSavePath:!0,currentPath:n.path,afterCB:(u,m)=>{Ht(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${m}</span>`,n)}});return}else if(e===p.ZWSP+6){const u=Lute.NewNodeID();A("/api/filetree/createDoc",{notebook:n.notebookId,path:De().join(xt(n.path,!1,!0),u+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{Ht(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,n),ve({app:n.app,id:u,action:[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW]})});return}else if(e===p.ZWSP+5){l.deleteContents(),nS(n,o);return}else if(p.INLINE_TYPE.includes(e)){if(l.deleteContents(),ne(l),["a","block-ref","inline-math","inline-memo","text"].includes(e)){n.toolbar.element.querySelector(`[data-type="${e}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,e,"range");return}else if(e==="emoji"){l.deleteContents(),l.insertNode(document.createTextNode(":")),l.collapse(!1),ne(l),this.genEmojiHTML(n);return}else if(e.startsWith("style")){l.deleteContents(),this.fixImageCursor(l),o.setAttribute("style",e.split(p.ZWSP)[1]||""),le(n,r,o.outerHTML,c);return}else if(e.startsWith("plugin")){n.app.plugins.find(u=>{const m=e.split(p.ZWSP);if(m[1]===u.name)return u.protyleSlash.find(f=>{if(f.id===m[2])return f.callback(n.getInstance(),o),!0}),!0});return}else{l.deleteContents(),e!=="![]()"&&this.fixImageCursor(l);let u=e;e==="```"&&(u=e+(p.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[p.LOCAL_CODELANG])?"":window.siyuan.storage[p.LOCAL_CODELANG])+Lute.Caret+"\n```");const m=fe(o);if(e==="![]()"){let f="";l.insertNode(document.createElement("wbr")),l.insertNode(document.createTextNode(e)),f=n.lute.SpinBlockDOM(o.outerHTML),o.outerHTML=f,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),we(o,l),le(n,r,o.outerHTML,c);let g=l.startContainer.childNodes[l.startOffset-1]||l.startContainer;g&&g.nodeType!==3&&g.classList.contains("img")||(((s=g.previousSibling)==null?void 0:s.nodeType)!==3&&g.previousSibling.classList.contains("img")?g=g.previousSibling:Array.from(o.querySelectorAll(".img")).find(b=>{if(b.querySelector("img").getAttribute("data-src")==="")return g=b,!0}));const h=g.getBoundingClientRect();Fh(n,l,g,{clientX:h.left,clientY:h.top});return}else if(m.textContent===""&&o.getAttribute("data-type")==="NodeParagraph"){let f="";e==="<div>"?f=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${ji()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(m.textContent=u,f=n.lute.SpinBlockDOM(o.outerHTML)),o.outerHTML=f,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),o.getAttribute("data-type")==="NodeTable"&&(o.querySelectorAll("colgroup col").forEach(g=>{g.style.minWidth="60px"}),f=o.outerHTML),le(n,r,f,c)}else{let f=n.lute.SpinBlockDOM(u);e==="<div>"&&(f=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${ji()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`);const g=o.outerHTML;let h;o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"&&(h=Nt(n,o,!0,!1,!1,!0)),o.insertAdjacentHTML("afterend",f);const b=f.substr(f.indexOf('data-node-id="')+14,22);o=n.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),o.getAttribute("data-type")==="NodeTable"&&o.querySelectorAll("colgroup col").forEach(E=>{E.style.minWidth="60px"});const y=[{data:g,id:r,action:"update"},{data:o.outerHTML,id:b,previousID:r,action:"insert"}],w=[{id:b,action:"delete"},{data:c,id:r,action:"update"}];h&&(y.push(...h.doOperations),w.push(...h.undoOperations)),V(n,y,w)}if(e==="<div>"||e==="$$"||e.indexOf("```")>-1&&(e.length>3||o.classList.contains("render-node")))n.toolbar.showRender(n,o),Ct(o);else if(e.startsWith("```"))rt(o);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){n.gutter.renderMenu(n,o);const f=o.getBoundingClientRect();window.siyuan.menus.menu.popup({x:f.left,y:f.top,isLeft:!0});const g=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');g.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(g.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else e==="---"?oe(o):o.classList.contains("av")?Vt(o,n,()=>{const f=o.querySelector(".av__title");f.focus(),l.setStart(f,0),l.collapse(!0),ne(l)}):we(o,l)}}select(e,n){var a,i,s,l,o;const r=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!r)return!1;if(e.key==="Enter"){if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;const d=c.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3&&((a=u.endContainer.childNodes[u.endOffset-1])==null||a.remove()),wl(d);let m;d.indexOf(".")>-1?m=`:${d.split(".")[0]}: `:m=be(d)+" ",Ht(n.lute.SpinBlockDOM(m),n),this.element.classList.add("fn__none")}else this.fill(d,n)}else{const c=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));c===p.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(c,n,!0,Wt(e))}return e.preventDefault(),e.stopPropagation(),!0}if(r){const c=this.element.querySelector(".emojis__item--current");if(!c)return!1;let d;if(e.key==="ArrowLeft")c.previousElementSibling?(c.classList.remove("emojis__item--current"),d=c.previousElementSibling):(i=c.parentElement.previousElementSibling)!=null&&i.previousElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(e.key==="ArrowRight")c.nextElementSibling?(c.classList.remove("emojis__item--current"),d=c.nextElementSibling):(s=c.parentElement.nextElementSibling)!=null&&s.nextElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(e.key==="ArrowDown"){if(c.nextElementSibling){c.classList.remove("emojis__item--current");let u=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(d=c;d.nextElementSibling&&u>0;)d=d.nextElementSibling,u--}else{const u=(l=c.parentElement.nextElementSibling)==null?void 0:l.nextElementSibling;u&&(d=u.firstElementChild,c.classList.remove("emojis__item--current"))}e.preventDefault(),e.stopPropagation()}else if(e.key==="ArrowUp"){if(c.previousElementSibling){c.classList.remove("emojis__item--current");let u=Math.floor(c.parentElement.clientWidth/(c.clientWidth+2));for(d=c;d.previousElementSibling&&u>0;)d=d.previousElementSibling,u--}else{const u=(o=c.parentElement.previousElementSibling)==null?void 0:o.previousElementSibling;u&&(d=u.lastElementChild,c.classList.remove("emojis__item--current"))}e.preventDefault(),e.stopPropagation()}if(d){d.classList.add("emojis__item--current");const u=this.element.querySelector(".emojis__panel");if(d.offsetTop-8<u.scrollTop)u.scrollTop=d.offsetTop-8;else{const m=u.nextElementSibling.classList.contains("fn__none")?8:36;d.offsetTop+m-this.element.clientHeight+d.clientHeight>u.scrollTop&&(u.scrollTop=d.offsetTop+m-this.element.clientHeight+d.clientHeight)}}return e.preventDefault(),e.stopPropagation(),!0}else if(e.key==="ArrowDown"||e.key==="ArrowUp")return xn(this.element.firstElementChild,e),e.preventDefault(),e.stopPropagation(),!0;return e.key==="ArrowLeft"||e.key==="ArrowRight"?(ce(["hint"],n),!0):!1}fixImageCursor(e){const n=pt(e.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(Ge(n)||(e.insertNode(document.createTextNode(p.ZWSP)),e.collapse(!1)))}getKey(e,n){const a=this.splitChar,i=this.lastIndex;if(this.lastIndex=-1,this.splitChar="",n.forEach(o=>{let r=e.lastIndexOf(o.key);p.BLOCK_HINT_KEYS.includes(o.key)&&r>-1&&e.lastIndexOf(o.key+o.key.substring(0,1))>-1&&(r=Math.min(r,e.lastIndexOf(o.key+o.key.substring(0,1)))),this.lastIndex<r&&(this.splitChar=o.key,this.lastIndex=r)}),this.lastIndex===-1)return;!this.element.classList.contains("fn__none")&&a&&a!==this.splitChar&&(this.splitChar=a,this.lastIndex=i),this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(e.substr(this.lastIndex-1,1))||e.substr(this.lastIndex-1,2)==="::"));const s=e.split(this.splitChar),l=s[s.length-1];if(s.length>1&&l.trimStart()===l&&l.length<p.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&e.endsWith("\u3010\u3010\u3011")?"":l}}const M3=t=>{const e=Lute.New();if(e.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.SetFileAnnotationRef(!0),e.SetHTMLTag2TextMark(!0),e.SetTextMark(!0),e.SetHeadingID(!1),e.SetYamlFrontMatter(!1),e.PutEmojis(t.emojis),e.SetEmojiSite(t.emojiSite),e.SetHeadingAnchor(t.headingAnchor),e.SetInlineMathAllowDigitAfterOpenMarker(!0),e.SetToC(!1),e.SetIndentCodeBlock(!1),e.SetParagraphBeginningSpace(!0),e.SetSetext(!1),e.SetFootnotes(!1),e.SetLinkRef(!1),e.SetSanitize(t.sanitize),e.SetChineseParagraphBeginningSpace(t.paragraphBeginningSpace),e.SetRenderListStyle(t.listStyle),e.SetImgPathAllowSpace(!0),e.SetKramdownIAL(!0),e.SetTag(!0),e.SetSuperBlock(!0),e.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.SetGFMStrikethrough1(!1),e.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.SetMark(window.siyuan.config.editor.markdown.inlineMark),e.SetSpin(!0),e.SetProtyleWYSIWYG(!0),t.lazyLoadImage&&e.SetImageLazyLoading(t.lazyLoadImage),e.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach(a=>{n[a.keywords]=t.emojiSite+"/"+a.unicode}),e.PutEmojis(n)}return e.SetUnorderedListMarker("-"),e},P3=(t,e)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const o=speechSynthesis.getVoices();let r,c;return o.forEach(d=>{d.lang===e.replace("_","-")&&(r=d),d.default&&(c=d)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const l=s();i.onclick=()=>{if(i.className==="protyle-speech"){const o=new SpeechSynthesisUtterance(i.getAttribute("data-text"));o.voice=l,o.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=n},speechSynthesis.speak(o),i.className="protyle-speech protyle-speech--current",i.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=a):(speechSynthesis.pause(),i.innerHTML=n));ne(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}t.addEventListener("mouseup",s=>{const l=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const o=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=n,i.style.display="block",i.style.top=o.top+o.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",l)})};var N3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class H3{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",e.options.classes.preview&&n.classList.add(e.options.classes.preview);const a=e.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let l=0;l<a.length;l++){const o=a[l];if(typeof o=="object"){s.push(`<button type="button" data-type="${o.key}" class="${o.className}">${o.text}</button>`);continue}switch(o){case"desktop":s.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":s.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":s.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":s.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":s.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":s.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(n),this.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){const c=o.getAttribute("href");if(c.startsWith("#")){const d=c.substring(1);n.querySelector('[data-node-id="'+d+'"], [id="'+d+'"]').scrollIntoView(),l.stopPropagation(),l.preventDefault();break}if(Y()){nn(c),l.stopPropagation(),l.preventDefault();break}l.stopPropagation(),l.preventDefault(),Ro(c)?Wt(l)?Gk(c,"folder"):l.shiftKey?Gk(c,"app"):p.SIYUAN_ASSETS_EXTS.includes(De().extname(c.split("?")[0]))&&ur(e.app,c.split("?page")[0],parseInt(Ie("page",c))):window.open(c);break}else if(o.tagName==="IMG"){Bv(l.target.getAttribute("src"),e.block.rootID),l.stopPropagation(),l.preventDefault();break}else if(o.tagName==="BUTTON"){const c=o.getAttribute("data-type"),d=a.find(u=>(u==null?void 0:u.key)===c);d?d.click(c):c==="mp-wechat"||c==="zhihu"||c==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),e,c):c==="desktop"?(n.style.width="",n.style.padding=e.wysiwyg.element.style.padding):c==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),c!=="mp-wechat"&&c!=="zhihu"&&c!=="yuque"&&(i.querySelectorAll("button").forEach(u=>{u.classList.remove("protyle-preview__action--current")}),o.classList.add("protyle-preview__action--current"))}o=o.parentElement}const r=j(l.target,"id",void 0);r&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("selected")}),r.classList.add("selected"),e.model&&Oe().outline.forEach(c=>{c.blockId===e.block.rootID&&c.setCurrentByPreview(r)}))}),this.previewElement=n}render(e){var n;if(this.element.style.display==="none")return;if((n=this.element.querySelector('.protyle-preview__action [data-type="desktop"]'))!=null&&n.classList.contains("protyle-preview__action--current")){const i=UE(e);this.previewElement.style.padding=`${i.top}px ${i.left}px ${i.bottom}px ${i.right}px`}let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{A("/api/export/preview",{id:e.block.id||e.options.blockId||e.block.parentID},i=>{const s=e.preview.previewElement.scrollTop;e.preview.previewElement.innerHTML=i.data.html,Ct(e.preview.previewElement),rt(e.preview.previewElement),Vt(e.preview.previewElement,e),P3(e.preview.previewElement,e.options.lang),e.preview.previewElement.scrollTop=s,a.remove()})},e.options.preview.delay)}link2online(e){as("")||e.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const i=p.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",i):n.setAttribute("src",i)}})}copyToX(e,n,a){return N3(this,null,function*(){if(a==="mp-wechat")this.link2online(e),e.querySelectorAll(".katex-html .base").forEach(l=>{l.style.display="initial"}),e.querySelectorAll("mjx-container > svg").forEach(l=>{l.setAttribute("width",parseInt(l.getAttribute("width"))*8+"px")}),e.querySelectorAll("ul, ol").forEach(l=>{Array.from(l.children).forEach(o=>{const r=o.querySelector("ul, ol");r&&o.parentNode.insertBefore(r,o.nextSibling)})}),e.querySelectorAll("li.protyle-task").forEach(l=>{const o=l.querySelector('input[type="checkbox"]');o&&(o.style.opacity="0",o.checked?l.style.setProperty("list-style-type","'\u2705'","important"):l.style.setProperty("list-style-type","'\u25A2'","important"))}),typeof window.MathJax=="undefined"&&(window.MathJax={svg:{fontCache:"none"}}),yield W_(`${p.PROTYLE_CDN}/js/mathjax/tex-svg-full.js`,"protyleMathJaxScript"),yield window.MathJax.startup.promise,e.querySelectorAll('[data-subtype="math"]').forEach(l=>{const o=window.MathJax.tex2svg(Lute.UnEscapeHTMLStr(l.getAttribute("data-content")).trim(),{display:l.tagName==="DIV"});o.querySelector("mjx-assistive-mml").remove(),l.innerHTML=o.outerHTML});else if(a==="zhihu")this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach(l=>{l.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${l.getAttribute("data-content")}" style="${l.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),e.querySelectorAll("blockquote").forEach(l=>{const o=[];this.processZHBlockquote(l,o),o.reverse().forEach(r=>{l.insertAdjacentElement("afterend",r)}),l.remove()}),this.processZHTable(e);else if(a==="yuque"){A("/api/lute/copyStdMarkdown",{id:n.block.id||n.options.blockId||n.block.parentID,assetsDestSpace2Underscore:!0,fillCSSVar:!0,adjustHeadingLevel:!0},l=>{Be(l.data),de(`${window.siyuan.languages.pasteToYuque}`)});return}e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach(l=>{l.style.backgroundImage="none"}),this.element.append(e),e.insertAdjacentHTML("beforeend","<p>&zwj;</p>");let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0).cloneRange());const s=e.ownerDocument.createRange();s.selectNodeContents(e),ne(s),document.execCommand("copy"),this.element.lastElementChild.remove(),ne(i),a&&de(`${a==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)})}processZHBlockquote(e,n){Array.from(e.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const i=n[n.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(e){e.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const i=n.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const cy=(...t)=>{const e={},n=a=>{for(const i in a)a.hasOwnProperty(i)&&(Object.prototype.toString.call(a[i])==="[object Object]"?e[i]=cy(e[i],a[i]):e[i]=a[i])};for(let a=0;a<t.length;a++)n(t[a]);return e};class O3{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,titleShowTop:!1,hideTitleOnZoom:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},click:{preventInsetEmptyBlock:!1},hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:As},{key:"\u3010\u3010",hint:As},{key:"\uFF08\uFF08",hint:As},{key:"[[",hint:As},{key:"{{",hint:Zo},{key:"\u300C\u300C",hint:Zo},{key:"\u300C\u300E",hint:Zo},{key:"\u300E\u300C",hint:Zo},{key:"\u300E\u300E",hint:Zo},{key:"#",hint:Rx},{key:"/",hint:Mh},{key:"\u3001",hint:Mh},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:p.PROTYLE_TOOLBAR,typewriterMode:!1,upload:{max:1024*1024*1024*8,url:p.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){var e;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(e=this.options.hint)!=null&&e.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),cy(this.defaultOptions,this.options)}mergeToolbar(e){return bp(e)}}class B3{constructor(e){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="north" aria-label="${pe("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="2west" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" aria-label="${pe("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,e.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`),wi(this.element.getAttribute("aria-label"),this.element)}),this.inputElement.addEventListener("change",()=>{this.setIndex(e)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(e)}),this.parentElement.addEventListener("click",n=>{const a=n.target;T(a,"protyle-scroll__up")?$h(e):T(a,"protyle-scroll__down")?xv(e):a.classList.contains("b3-slider")&&this.setIndex(e)}),this.parentElement.addEventListener("mousewheel",n=>{n.deltaY!==0&&e.scroll.lastScrollTop!==-1&&(e.contentElement.scrollTop+=n.deltaY)},{passive:!0})}setIndex(e){e.wysiwyg.element.getAttribute("data-top")||(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),e.contentElement.style.overflow="hidden",A("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{kt({data:n,protyle:e,action:[p.CB_GET_FOCUSFIRST,p.CB_GET_UNCHANGEID],afterCB:()=>{setTimeout(()=>{e.contentElement.style.overflow=""},p.TIMEOUT_INPUT),wi(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(e,n,a){A("/api/block/getBlockIndex",{id:n},i=>{if(!i.data)return;const s=e.scroll.element.querySelector(".b3-slider");s.value=i.data,e.scroll.element.setAttribute("aria-label",`Blocks ${i.data}/${e.block.blockCount}`),a&&a(i.data)})}update(e){typeof e.block.blockCount=="number"&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.scroll&&!e.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}var eg=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const aS=(t,e,n,a,i,s)=>eg(void 0,null,function*(){var l,o,r,c,d,u,m,f,g;const h=[],b=[],y=[],w=n.getAttribute("data-node-id"),E=[];let C=n,$=!0;e.find(v=>{if(!v.classList.contains("li")||!n.classList.contains("li")||n.getAttribute("data-subtype")!==v.getAttribute("data-subtype"))return $=!1,!0});let M,k;const _={};for(let v=e.length-1;v>=0;v--){const S=e[v],L=S.getAttribute("data-node-id"),D=S.parentElement.getAttribute("data-node-id")||t.block.parentID||t.block.rootID;S.getAttribute("data-type")==="NodeListItem"&&!k&&!$&&(k=Lute.NewNodeID(),M=document.createElement("div"),M.innerHTML=`<div data-subtype="${S.getAttribute("data-subtype")}" data-node-id="${k}" data-type="NodeList" class="list"><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,M=M.firstElementChild,h.push({action:"insert",data:M.outerHTML,id:k,previousID:i==="afterbegin"?null:i==="afterend"?w:(l=C.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:i==="afterbegin"?w:((o=C.parentElement)==null?void 0:o.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),b.push({action:"delete",id:k}),C.insertAdjacentElement(i,M),E.push(M));const I=Lute.NewNodeID();s&&S.getAttribute("data-type")==="NodeHeading"&&S.getAttribute("fold")==="1"&&y.push({newId:I,oldId:L});let q;if(s?b.push({action:"delete",id:I}):b.push({action:"move",id:L,previousID:(r=S.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:D}),!a&&!s){const Z=t.wysiwyg.element.querySelector(`[data-node-id="${L}"]`);Z&&Z.remove()}if(s)q=S.cloneNode(!0),q.setAttribute("data-node-id",I),q.querySelectorAll("[data-node-id]").forEach(Z=>{const R=Lute.NewNodeID();Z.setAttribute("data-node-id",R),Z.setAttribute("updated",R.split("-")[0])}),k?(M.insertAdjacentElement("afterbegin",q),h.push({action:"insert",id:I,data:q.outerHTML,parentID:k})):(C.insertAdjacentElement(i,q),h.push({action:"insert",id:I,data:q.outerHTML,previousID:i==="afterbegin"?null:i==="afterend"?w:(c=q.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:i==="afterbegin"?w:((d=q.parentElement)==null?void 0:d.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),E.push(q));else{const Z=Et(S),R=S.parentElement;if(S.classList.contains("li")&&S.getAttribute("data-subtype")==="o"&&(_[S.parentElement.getAttribute("data-node-id")]=S.parentElement),k?(M.insertAdjacentElement("afterbegin",S),h.push({action:"move",id:L,parentID:k})):(C.insertAdjacentElement(i,S),h.push({action:"move",id:L,previousID:i==="afterbegin"?null:i==="afterend"?w:(u=S.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:i==="afterbegin"?w:((m=S.parentElement)==null?void 0:m.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),E.push(S)),Z!==S){h.push({action:"delete",id:Z.getAttribute("data-node-id")}),b.push({action:"insert",data:Z.outerHTML,id:Z.getAttribute("data-node-id"),previousID:(f=Z.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:((g=Z.parentElement)==null?void 0:g.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID});const F=Z.parentElement;if(Z.remove(),!a){const K=t.wysiwyg.element.querySelector(`[data-node-id="${Z.getAttribute("data-node-id")}"]`);K&&K.remove()}if(F.classList.contains("sb")&&F.childElementCount===2)if(a){const K=yield Li(t,F);h.push(K.doOperations[0],K.doOperations[1]),b.push(K.undoOperations[1],K.undoOperations[0])}else{const K=qn();for(let X=0;X<K.length;X++)if(K[X].protyle.element.contains(F)){const J=yield Li(K[X].protyle,F);h.push(J.doOperations[0],J.doOperations[1]),b.push(J.undoOperations[1],J.undoOperations[0]),K[X].protyle.undo.clear();break}}}else if(R.classList.contains("sb")&&R.childElementCount===2)if(a){const F=yield Li(t,R);h.push(F.doOperations[0],F.doOperations[1]),b.push(F.undoOperations[1],F.undoOperations[0])}else{const F=qn();for(let K=0;K<F.length;K++)if(F[K].protyle.element.contains(R)){const X=yield Li(F[K].protyle,R);h.push(X.doOperations[0],X.doOperations[1]),b.push(X.undoOperations[1],X.undoOperations[0]),F[K].protyle.undo.clear();break}}else R.classList.contains("protyle-wysiwyg")&&R.childElementCount===0&&qn().find(F=>{if(F.protyle.element.contains(R)){if(F.protyle.block.showAll)dn({protyle:F.protyle,id:F.protyle.block.rootID});else{const K=Lute.NewNodeID();h.splice(0,0,{action:"insert",id:K,data:jn(!1,!1,K).outerHTML,parentID:F.protyle.block.parentID}),b.splice(0,0,{action:"delete",id:K})}return!0}})}k&&(v===0||e[v-1].getAttribute("data-type")!=="NodeListItem"||e[v-1].getAttribute("data-subtype")!==S.getAttribute("data-subtype"))?(i==="beforebegin"&&(C=M),k=null,M.getAttribute("data-subtype")==="o"&&M.firstElementChild.getAttribute("data-marker")!=="1."&&(Array.from(M.children).forEach(Z=>{Z.classList.contains("protyle-attr")||b.push({action:"update",id:Z.getAttribute("data-node-id"),data:Z.outerHTML})}),Tt(M,1),Array.from(M.children).forEach(Z=>{Z.classList.contains("protyle-attr")||h.push({action:"update",id:Z.getAttribute("data-node-id"),data:Z.outerHTML})}),Tt(M,1))):i==="beforebegin"&&(C=s?q:S)}Object.keys(_).forEach(v=>{Array.from(_[v].children).forEach(S=>{S.classList.contains("protyle-attr")||b.push({action:"update",id:S.getAttribute("data-node-id"),data:S.outerHTML})}),Tt(_[v],1),Array.from(_[v].children).forEach(S=>{S.classList.contains("protyle-attr")||h.push({action:"update",id:S.getAttribute("data-node-id"),data:S.outerHTML})})}),b.reverse();for(let v=0;v<y.length;v++){const S=y[v],L=yield Ae("/api/block/getHeadingInsertTransaction",{id:S.oldId});L.data.doOperations.splice(0,1),L.data.doOperations[0].previousID=S.newId,L.data.undoOperations.splice(0,1),h.push(...L.data.doOperations),b.push(...L.data.undoOperations)}return{doOperations:h,undoOperations:b,newSourceElements:E}}),iS=(t,e,n,a,i,s)=>eg(void 0,null,function*(){var l,o,r,c;const d=t.element.contains(e[0]);if(d&&e[0].classList.contains("li")&&n===e[0].parentElement&&n.childElementCount===e.length+1&&!e.find(C=>{if(!n.contains(C))return!0}))return;const u=[],m={action:"move",id:n.getAttribute("data-node-id"),previousID:(l=n.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:((o=n.parentElement)==null?void 0:o.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID},f=Nv(i);n.parentElement.replaceChild(f,n);const g=[{action:"insert",data:f.outerHTML,id:f.getAttribute("data-node-id"),nextID:(r=f.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=f.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];f.lastElementChild.before(n);const h=yield aS(t,e,f,d,"afterbegin",s);g.push(...h.doOperations),u.push(...h.undoOperations);const b=h.newSourceElements;let y=g.length;g.find((E,C)=>{E.action==="delete"&&E.id===m.parentID&&(y=C),E.action==="delete"&&E.id===n.getAttribute("data-node-id")&&(n=f.querySelector(`[data-node-id="${g[C-1].id}"]`))}),a?(f.insertAdjacentElement("afterbegin",n),g.splice(y,0,{action:"move",id:n.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")})):(f.lastElementChild.insertAdjacentElement("beforebegin",n),g.splice(y,0,{action:"move",id:n.getAttribute("data-node-id"),previousID:b[0].getAttribute("data-node-id")})),u.push(m),u.push({action:"delete",id:f.getAttribute("data-node-id")});let w=!1;b.forEach(E=>{if(E.getAttribute("data-type")==="NodeHeading"&&E.getAttribute("fold")==="1"){if(w=!0,E.nextElementSibling&&(E.nextElementSibling.getAttribute("data-type")!=="NodeHeading"||E.nextElementSibling.getAttribute("data-subtype")>E.getAttribute("data-subtype"))){const C=Nt(t,E,!0,!1,!1,!0);g.push(...C.doOperations)}return!0}}),d||s?V(t,g,u):V(t,g),(b.length>1||w)&&i==="col"&&ga({protyle:t,selectsElement:b.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),document.contains(e[0])?oe(e[0]):oe(n)}),sS=(t,e,n,a,i)=>eg(void 0,null,function*(){const s=t.element.contains(e[0]),l=[],o=[],r=yield aS(t,e,n,s,a?"afterend":"beforebegin",i);l.push(...r.doOperations),o.push(...r.undoOperations);const c=r.newSourceElements;let d;a&&n.getAttribute("data-type")==="NodeHeading"&&n.getAttribute("fold")==="1"?d=Nt(t,n,!0,!1,!1,!0):!a&&n.previousElementSibling&&n.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&n.previousElementSibling.getAttribute("fold")==="1"&&(d=Nt(t,n.previousElementSibling,!0,!1,!1,!0)),d&&(d.doOperations[0].context={focusId:e[0].getAttribute("data-node-id")},l.push(...d.doOperations),o.push(...d.undoOperations)),n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||o.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}),Tt(n.parentElement,1),Array.from(n.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||l.push({action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}));let u=!1;c.forEach(m=>{if(m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"){if(u=!0,m.nextElementSibling&&(m.nextElementSibling.getAttribute("data-type")!=="NodeHeading"||m.nextElementSibling.getAttribute("data-subtype")>m.getAttribute("data-subtype"))){const f=Nt(t,m,!0,!1,!1,!0);l.push(...f.doOperations)}return!0}}),s||i?V(t,l,o):V(t,l),(c.length>1||u)&&c[0].parentElement.classList.contains("sb")&&c[0].parentElement.getAttribute("data-sb-layout")==="col"&&ga({protyle:t,selectsElement:c.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),document.contains(e[0])?oe(e[0]):oe(n)}),R3=(t,e)=>{e.addEventListener("dragstart",s=>{var l,o,r;if(t.disabled){s.preventDefault(),s.stopPropagation();return}let c=s.target;if((l=c.classList)!=null&&l.contains("av__gallery-img")&&(c=T(c,"av__gallery-item")),!!c){if(c.tagName==="IMG"){window.siyuan.dragElement=void 0,s.preventDefault();return}if(c.classList){if(T(c,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,s.preventDefault();else if(c.parentElement.parentElement.classList.contains("av__views")){window.siyuan.dragElement=c,c.style.width=c.clientWidth+"px",c.style.opacity=".36",s.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}ViewTab${p.ZWSP}${[(o=c.previousElementSibling)==null?void 0:o.getAttribute("data-id")]}`,c.outerHTML);return}else if(c.classList.contains("protyle-action")){c.parentElement.classList.add("protyle-wysiwyg--select");const d=document.createElement("div");d.className=t.wysiwyg.element.className,d.append(sa(c.parentElement.cloneNode(!0))),d.setAttribute("style",`position:fixed;opacity:.1;width:${c.parentElement.clientWidth}px;padding:0;`),document.body.append(d),s.dataTransfer.setDragImage(d,0,0),setTimeout(()=>{d.remove()}),window.siyuan.dragElement=t.wysiwyg.element,s.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeListItem${p.ZWSP}${c.parentElement.getAttribute("data-subtype")}${p.ZWSP}${[c.parentElement.getAttribute("data-node-id")]}`,t.wysiwyg.element.innerHTML);return}else if(c.classList.contains("av__cell--header")){window.siyuan.dragElement=c,s.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}Col${p.ZWSP}${[c.getAttribute("data-col-id")]}`,c.outerHTML);return}else if(c.classList.contains("av__gallery-item")){const d=B(c);if(d){if((r=d.querySelector('.block__icon[data-type="av-sort"]'))!=null&&r.classList.contains("block__icon--active")){const y=d.querySelectorAll(".av__body");if(y.length===1){s.preventDefault(),s.stopPropagation();return}else if(["template","created","updated"].includes(y[0].getAttribute("data-dtype"))){s.preventDefault(),s.stopPropagation();return}}c.classList.contains("av__gallery-item--select")||(d.querySelectorAll(".av__gallery-item--select").forEach(y=>{y.classList.remove("av__gallery-item--select")}),c.classList.add("av__gallery-item--select"));const u=document.createElement("div");u.className="protyle-wysiwyg protyle-wysiwyg--attr";const m=d.getAttribute("data-av-type")==="kanban";m&&(u.innerHTML=`<div class="${d.querySelector(".av__kanban").className}"></div>`);let f,g=document.createElement("div");const h=d.querySelectorAll(".av__gallery-item--select");h.forEach(y=>{(!f||!f.contains(y))&&(f=y.parentElement,g=document.createElement("div"),m?(g.className="av__kanban-group",g.setAttribute("style",y.parentElement.parentElement.parentElement.getAttribute("style")),g.innerHTML='<div class="av__gallery"></div>',u.firstElementChild.appendChild(g)):(g.classList.add("av__gallery"),g.setAttribute("style",`width: 100vw;margin-bottom: 16px;grid-template-columns: repeat(auto-fill, ${h[0].clientWidth}px);`),u.appendChild(g)));const w=sa(y.cloneNode(!0));w.setAttribute("style",`height:${y.clientHeight}px;`),w.classList.remove("av__gallery-item--select"),m?g.firstElementChild.appendChild(w):g.appendChild(w)}),u.setAttribute("style","left: 1px;top:100vh;position:fixed;opacity:.1;padding:0;z-index: 8"),document.body.append(u),s.dataTransfer.setDragImage(u,-10,-10),setTimeout(()=>{u.remove()}),window.siyuan.dragElement=c;const b=[];d.querySelectorAll(".av__gallery-item--select").forEach(y=>{const E=T(y,"av__body").getAttribute("data-group-id");b.push(y.getAttribute("data-id")+(E?`@${E}`:""))}),s.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}GalleryItem${p.ZWSP}${b}`,u.outerHTML)}return}}s.dataTransfer.setData(p.SIYUAN_DROP_EDITOR,p.SIYUAN_DROP_EDITOR),t.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}}),e.addEventListener("drop",s=>eg(void 0,null,function*(){var l,o,r,c,d,u;if(i=0,t.disabled||s.dataTransfer.getData(p.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation();return}let m="";for(const g of s.dataTransfer.items)g.type.startsWith(p.SIYUAN_DROP_GUTTER)&&(m=g.type);if(m.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}ViewTab${p.ZWSP}`.toLowerCase())){const g=B(window.siyuan.dragElement);if(g){const h=g.getAttribute("data-av-id"),b=g.getAttribute("data-node-id"),y=window.siyuan.dragElement.getAttribute("data-id");V(t,[{action:"sortAttrViewView",avID:h,blockID:b,id:y,previousID:(l=window.siyuan.dragElement.previousElementSibling)==null?void 0:l.getAttribute("data-id"),data:"unRefresh"}],[{action:"sortAttrViewView",avID:h,blockID:b,id:y,previousID:m.split(p.ZWSP).pop()}])}return}const f=e.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(f&&(f.classList.remove("dragover"),f.removeAttribute("select-start"),f.removeAttribute("select-end")),m){const g=[],h=m.replace(p.SIYUAN_DROP_GUTTER,"").split(p.ZWSP),b=h[2].split(",");if(s.altKey||s.shiftKey)if(s.y>t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)Gn(t,"afterend",t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const y=ly(s.clientX,s.clientY);if(j(y.startContainer,"data-type","NodeBlockQueryEmbed"))return;ne(y)}if(s.altKey){let y="";for(let w=0;w<b.length;w++){const E=yield Ae("/api/block/getRefText",{id:b[w]});y+=t.lute.Md2BlockDOM(`((${b[w]} '${E.data}'))`)}Ht(y,t)}else if(s.shiftKey){let y="";b.forEach(w=>{y+=`{{select * from blocks where id='${w}'}}
`}),Ht(t.lute.SpinBlockDOM(y),t,!0),We(t,t.wysiwyg.element)}else if(f&&f.className.indexOf("dragover__")>-1){let y="";if(b.forEach($=>{y+=`[data-node-id="${$}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(y.substring(0,y.length-1)).forEach($=>{G($)||g.push($)});else if(window.siyuan.config.system.workspaceDir.toLowerCase()===h[3]){const $=document.createElement("template");$.innerHTML=`<div>${s.dataTransfer.getData(m)}</div>`,$.content.querySelectorAll(y.substring(0,y.length-1)).forEach(M=>{G(M)||g.push(M)})}const w=[],E=[];g.forEach($=>{$.classList.remove("protyle-wysiwyg--hl"),$.removeAttribute("select-start"),$.removeAttribute("select-end"),$.querySelectorAll('[data-type="search-mark"]').forEach(k=>{k.outerHTML=k.innerHTML});const M=$.getAttribute("data-node-id");w.push(M),E.push({itemID:Lute.NewNodeID(),id:M,isDetached:!1})}),ce(["gutter"],t);const C=f.className.split(" ");if(f.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),f.classList.contains("av__cell")){const $=B(f);if($){const M=$.getAttribute("data-av-id");let k="";C.includes("dragover__left")?f.previousElementSibling&&(f.previousElementSibling.classList.contains("av__colsticky")?k=f.previousElementSibling.lastElementChild.getAttribute("data-col-id"):k=f.previousElementSibling.getAttribute("data-col-id")):k=f.getAttribute("data-col-id");let _="";const v=T(f,"av__row");if(v){const S=(o=v.querySelector(`[data-col-id="${h[2]}"`))==null?void 0:o.previousElementSibling;S&&(S.classList.contains("av__colsticky")?_=S.lastElementChild.getAttribute("data-col-id"):_=S.getAttribute("data-col-id"))}k!==_&&k!==h[2]&&V(t,[{action:"sortAttrViewCol",avID:M,previousID:k,id:h[2],blockID:$.dataset.nodeId}],[{action:"sortAttrViewCol",avID:M,previousID:_,id:h[2],blockID:$.dataset.nodeId}])}}else if(f.classList.contains("av__row")){const $=B(f);if($){let M="";C.includes("dragover__bottom")?M=f.getAttribute("data-id")||"":M=((r=f.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"";const k=$.getAttribute("data-av-id");if(h[0]==="nodeattributeviewrowmenu"){const _=[],v=[],S=f.parentElement.getAttribute("data-group-id");b.reverse().forEach(L=>{var D;const I=L.split("@"),q=I[0],Z=I[1]||"",R=((D=$.querySelector(`.av__body${Z?`[data-group-id="${Z}"]`:""} .av__row[data-id="${q}"]`).previousElementSibling)==null?void 0:D.getAttribute("data-id"))||"";(M!==q&&R!==M||R===""&&M===""&&S!==Z)&&(_.push({action:"sortAttrViewRow",avID:k,previousID:M,id:q,blockID:$.dataset.nodeId,groupID:Z,targetGroupID:S}),v.push({action:"sortAttrViewRow",avID:k,previousID:R,id:q,blockID:$.dataset.nodeId,groupID:S,targetGroupID:Z}))}),V(t,_,v)}else{const _=Q().format("YYYYMMDDHHmmss"),v=T(f,"av__body"),S=v&&v.getAttribute("data-group-id");V(t,[{action:"insertAttrViewBlock",avID:k,previousID:M,srcs:E,blockID:$.dataset.nodeId,groupID:S},{action:"doUpdateUpdated",id:$.dataset.nodeId,data:_}],[{action:"removeAttrViewBlock",srcIDs:w,avID:k},{action:"doUpdateUpdated",id:$.dataset.nodeId,data:$.getAttribute("updated")}]),$.setAttribute("updated",_),ap({protyle:t,blockElement:$,srcIDs:w,previousId:M,groupID:S})}}}else if(f.classList.contains("av__gallery-item")||f.classList.contains("av__gallery-add")){const $=B(f);if($){let M="";C.includes("dragover__right")||C.includes("dragover__bottom")?M=f.getAttribute("data-id")||"":(C.includes("dragover__top")||C.includes("dragover__left"))&&(M=((c=f.previousElementSibling)==null?void 0:c.getAttribute("data-id"))||"");const k=$.getAttribute("data-av-id");if(h[1]==="galleryitem"&&h[0]==="nodeattributeview"){const _=[],v=[],S=f.parentElement.parentElement.getAttribute("data-group-id");b.reverse().forEach(L=>{var D;const I=L.split("@"),q=I[0],Z=I[1]||"",R=((D=$.querySelector(`.av__body[data-group-id="${Z}"] .av__gallery-item[data-id="${q}"]`).previousElementSibling)==null?void 0:D.getAttribute("data-id"))||"";(M!==L&&R!==M||R===""&&M===""&&S!==Z)&&(_.push({action:"sortAttrViewRow",avID:k,previousID:M,id:q,blockID:$.dataset.nodeId,groupID:Z,targetGroupID:S}),v.push({action:"sortAttrViewRow",avID:k,previousID:R,id:q,blockID:$.dataset.nodeId,groupID:S,targetGroupID:Z}))}),V(t,_,v)}else{const _=Q().format("YYYYMMDDHHmmss"),v=T(f,"av__body");V(t,[{action:"insertAttrViewBlock",avID:k,previousID:M,srcs:E,blockID:$.dataset.nodeId,groupID:v&&v.getAttribute("data-group-id")},{action:"doUpdateUpdated",id:$.dataset.nodeId,data:_}],[{action:"removeAttrViewBlock",srcIDs:w,avID:k},{action:"doUpdateUpdated",id:$.dataset.nodeId,data:$.getAttribute("updated")}]),$.setAttribute("updated",_),Rw({protyle:t,blockElement:$,srcIDs:w,previousId:M,groupID:f.parentElement.getAttribute("data-group-id")})}}}else g.length>0&&(f.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&f.parentElement.getAttribute("data-sb-layout")==="col"?C.includes("dragover__left")||C.includes("dragover__right")?sS(t,g,f,C.includes("dragover__right"),s.ctrlKey):iS(t,g,f,C.includes("dragover__bottom"),"row",s.ctrlKey):C.includes("dragover__left")||C.includes("dragover__right")?iS(t,g,f,C.includes("dragover__right"),"col",s.ctrlKey):sS(t,g,f,C.includes("dragover__bottom"),s.ctrlKey),e.querySelectorAll(".protyle-wysiwyg--empty").forEach($=>{$.classList.remove("protyle-wysiwyg--empty")}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach($=>{$.removeAttribute("data-render"),We(t,$)}));n=void 0}}else if(((d=s.dataTransfer.getData(p.SIYUAN_DROP_FILE))==null?void 0:d.split("-").length)>1){const g=s.dataTransfer.getData(p.SIYUAN_DROP_FILE).split(",");if(!s.altKey&&(!f||!f.classList.contains("av__row")&&!f.classList.contains("av__gallery-item")&&!f.classList.contains("av__gallery-add"))){if(s.y>t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)Gn(t,"afterend",t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const b=ly(s.clientX,s.clientY);if(j(b.startContainer,"data-type","NodeBlockQueryEmbed"))return;ne(b)}let h="";for(let b=0;b<g.length;b++){g.length>1&&(h+="- ");const y=yield Ae("/api/block/getRefText",{id:g[b]});h+=`((${g[b]} '${y.data}'))`,g.length>1&&b!==g.length-1&&(h+=`
`)}Ht(t.lute.Md2BlockDOM(h),t)}else if(f&&!t.options.backlinkData&&f.className.indexOf("dragover__")>-1){const h=t.contentElement.scrollTop;if(f.classList.contains("av__row")||f.classList.contains("av__gallery-item")||f.classList.contains("av__gallery-add")){const b=B(f);if(b){let y="";f.classList.contains("dragover__bottom")||f.classList.contains("dragover__right")?y=f.getAttribute("data-id")||"":(f.classList.contains("dragover__top")||f.classList.contains("dragover__left"))&&(y=((u=f.previousElementSibling)==null?void 0:u.getAttribute("data-id"))||"");const w=b.getAttribute("data-av-id"),E=Q().format("YYYYMMDDHHmmss"),C=[],$=T(f,"av__body"),M=$&&$.getAttribute("data-group-id");g.forEach(k=>{C.push({itemID:Lute.NewNodeID(),id:k,isDetached:!1})}),V(t,[{action:"insertAttrViewBlock",avID:w,previousID:y,srcs:C,blockID:b.dataset.nodeId,groupID:M},{action:"doUpdateUpdated",id:b.dataset.nodeId,data:E}],[{action:"removeAttrViewBlock",srcIDs:g,avID:w},{action:"doUpdateUpdated",id:b.dataset.nodeId,data:b.getAttribute("updated")}]),ap({protyle:t,blockElement:b,srcIDs:g,previousId:y,groupID:M}),b.setAttribute("updated",E)}}else{if(f.classList.contains("dragover__bottom"))for(let b=g.length-1;b>-1;b--)g[b]&&(yield Ae("/api/filetree/doc2Heading",{srcID:g[b],after:!0,targetID:f.getAttribute("data-node-id")}));else for(let b=0;b<g.length;b++)g[b]&&(yield Ae("/api/filetree/doc2Heading",{srcID:g[b],after:!1,targetID:f.getAttribute("data-node-id")}));A("/api/filetree/getDoc",{id:t.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},b=>{kt({data:b,protyle:t}),fr({protyle:t,focus:!1,pushBackStack:!1,reload:!0,resize:!1}),setTimeout(()=>{t.contentElement.scrollTop=h,t.scroll.lastScrollTop=h-1},p.TIMEOUT_LOAD)})}f.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(s.dataTransfer.types[0]==="Files"||s.dataTransfer.types.includes("text/html"))){s.preventDefault();const g=T(s.target,"av");if(g){const h=T(s.target,"av__cell");if(h&&Zn(h)==="mAsset"&&s.dataTransfer.types[0]==="Files"&&!Ne()){const b=[];for(let y=0;y<s.dataTransfer.files.length;y++)b.push(webUtils.getPathForFile(s.dataTransfer.files[y]));Fv(b,t,h),an(["cell"],g)}}else{if(ne(ly(s.clientX,s.clientY)),s.dataTransfer.types[0]==="Files"&&!Ne()){const h=[];for(let b=0;b<s.dataTransfer.files.length;b++)h.push(webUtils.getPathForFile(s.dataTransfer.files[b]));Yh(h,t,!s.altKey)}else Uo(t,s);an(["av","img"],t.wysiwyg.element)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,a;e.addEventListener("dragover",s=>{var l,o,r,c,d;if(t.disabled||s.dataTransfer.types.includes(p.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="none";return}let u="";for(const w of s.dataTransfer.items)w.type.startsWith(p.SIYUAN_DROP_GUTTER)&&(u=w.type);if(u.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}ViewTab${p.ZWSP}`.toLowerCase())){ZA(s),s.preventDefault();return}const m=t.contentElement.getBoundingClientRect();!T(s.target,"av__cell")&&(s.clientY<m.top+p.SIZE_SCROLL_TB||s.clientY>m.bottom-p.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(s.clientY<m.top+p.SIZE_SCROLL_TB?-p.SIZE_SCROLL_STEP:p.SIZE_SCROLL_STEP),behavior:"smooth"});let f;if(s.dataTransfer.types.includes("Files")){if(f=T(s.target,"av__cell"),f&&f.getAttribute("data-dtype")==="mAsset"&&!f.classList.contains("av__cell--header")){if(s.preventDefault(),n&&f===n)return;const w=B(f);w&&(an(["cell","row"],t.wysiwyg.element),f.classList.add("av__cell--select"),w.getAttribute("data-av-type")!=="gallery"&&pa(f),n=f)}return}if(!u&&!window.siyuan.dragElement){s.preventDefault();return}const g=u?u.replace(p.SIYUAN_DROP_GUTTER,"").split(p.ZWSP):[],h=s.dataTransfer.types.includes(p.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(s.shiftKey||s.altKey&&h.indexOf("-")===-1){const w=B(s.target);w?(w.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),w.removeAttribute("select-start"),w.removeAttribute("select-end")):e.querySelectorAll(".dragover__top, .protyle-wysiwyg--select, .dragover__bottom, .dragover__left, .dragover__right").forEach(E=>{E.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),E.removeAttribute("select-start"),E.removeAttribute("select-end")}),s.preventDefault();return}if(s.preventDefault(),f=T(s.target,"av__gallery-item")||T(s.target,"av__gallery-add")||T(s.target,"av__row")||T(s.target,"av__row--util")||B(s.target),f&&["gallery","kanban"].includes(f.getAttribute("data-av-type"))&&s.target.classList.contains("av__gallery"))return;const b={x:s.clientX,y:s.clientY,className:""};if(f&&(f.classList.contains("bq")||f.classList.contains("sb")||f.classList.contains("list")||f.classList.contains("li"))){let w=B(document.elementFromPoint(b.x,b.y-6));for(;w&&f.contains(w);)(l=w.nextElementSibling)!=null&&l.getAttribute("data-node-id")&&(f=w),w=w.parentElement}if(f)f&&f.classList.contains("list")&&(g[0]!=="nodelistitem"?f=B(document.elementFromPoint(s.clientX,s.clientY-6)):f=T(document.elementFromPoint(s.clientX,s.clientY-6),"li"));else if(s.clientY>e.lastElementChild.getBoundingClientRect().bottom)f=e.lastElementChild,b.className="dragover__bottom";else if(s.clientY<e.firstElementChild.getBoundingClientRect().top)f=e.firstElementChild,b.className="dragover__top";else if(m){const w={left:m.left+parseInt(e.style.paddingLeft),right:m.left+t.contentElement.clientWidth-parseInt(e.style.paddingRight)};s.clientX<w.left?(b.x=w.left,b.className="dragover__left"):s.clientX>=w.right&&(b.x=w.right-6,b.className="dragover__right"),f=document.elementFromPoint(b.x,b.y),f.classList.contains("protyle-wysiwyg")&&(f=document.elementFromPoint(b.x,b.y-6)),f=Le(f,"data-node-id",null)}if(u&&u.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}Col${p.ZWSP}`.toLowerCase())){if(f=T(s.target,"av__cell"),f){const w=T(f,"av__row--header"),E=T(window.siyuan.dragElement,"av__row--header");(f===window.siyuan.dragElement||!w||!E||w&&E&&w!==E)&&(f=!1)}}else if(f&&u&&u.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${p.ZWSP}`.toLowerCase()))if(!f.classList.contains("av__row")&&!f.classList.contains("av__row--util")||window.siyuan.dragElement&&!window.siyuan.dragElement.contains(f))f=!1;else{const w=T(f,"av__body");if(w){const E=B(w),C=w.getAttribute("data-group-id"),$=["template","created","updated"].includes(w.getAttribute("data-dtype")),M=(o=E.querySelector('.block__icon[data-type="av-sort"]'))==null?void 0:o.classList.contains("block__icon--active");g[2].split(",").find(k=>{const _=k?k.split("@")[1]:"";if(_!==C&&$||_===C&&M)return f=!1,!0})}}else if(f&&u&&u.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}GalleryItem${p.ZWSP}`.toLowerCase())){const w=T(s.target,"av__container");if(f.classList.contains("av")||!w||!w.contains(window.siyuan.dragElement)||f===window.siyuan.dragElement)f=!1;else{const E=T(f,"av__body");if(E){const C=B(E),$=E.getAttribute("data-group-id"),M=["template","created","updated"].includes(E.getAttribute("data-dtype")),k=(r=C.querySelector('.block__icon[data-type="av-sort"]'))==null?void 0:r.classList.contains("block__icon--active");g[2].split(",").find(_=>{const v=_?_.split("@")[1]:"";if(v!==$&&M||v===$&&k)return f=!1,!0})}}}if(!f){e.querySelectorAll(".dragover__bottom, .dragover__top, .dragover, .dragover__left, .dragover__right").forEach(w=>{w.classList.remove("dragover__top","dragover__bottom","dragover","dragover__left","dragover__right")});return}const y=!f.classList.contains("av__row")&&!f.classList.contains("av__row--util")&&!f.classList.contains("av__gallery-item")&&!f.classList.contains("av__gallery-add");if(f&&n&&f===n){const w=f.getBoundingClientRect();if(e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(E=>{E.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),E.removeAttribute("select-start"),E.removeAttribute("select-end")}),h.indexOf("-")>-1&&y)if(s.altKey){if(h.split(",").includes(t.block.rootID)&&s.altKey)return}else return;if(f.getAttribute("data-type")==="NodeAttributeView"&&U(s.target,"TD"))return;if(b.className){f.classList.add(b.className),zl(f);return}if(f.getAttribute("data-type")==="NodeListItem"){s.clientY>w.top+w.height/2?(f.classList.add("dragover__bottom"),zl(f)):f.classList.contains("av__row--header")||(f.classList.add("dragover__top"),zl(f));return}if(f.classList.contains("av__cell")){s.clientX<w.left+w.width/2&&s.clientX>w.left&&!f.classList.contains("av__row")&&f.previousElementSibling!==window.siyuan.dragElement?f.classList.add("dragover__left"):s.clientX>w.right-w.width/2&&s.clientX<=w.right+1&&!f.classList.contains("av__row")&&f!==window.siyuan.dragElement.previousElementSibling&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&f===window.siyuan.dragElement.previousElementSibling.lastElementChild||f.classList.add("dragover__right"));return}if(f.classList.contains("av__gallery-item")){if(T(f,"av__kanban-group")){const E=w.top+w.height/2;s.clientY<E&&s.clientY>w.top-13?f.classList.add("dragover__top"):s.clientY>E&&s.clientY<=w.bottom+13&&f.classList.add("dragover__bottom")}else{const E=w.left+w.width/2;s.clientX<E&&s.clientX>w.left-13?f.classList.add("dragover__left"):s.clientX>E&&s.clientX<=w.right+13&&f.classList.add("dragover__right")}return}if(f.classList.contains("av__gallery-add")){T(f,"av__kanban-group")?f.classList.add("dragover__top"):f.classList.add("dragover__left");return}s.clientX<w.left+32&&s.clientX>=w.left-1&&!f.classList.contains("av__row")?(f.classList.add("dragover__left"),zl(f)):s.clientX>w.right-32&&s.clientX<w.right&&!f.classList.contains("av__row")?(f.classList.add("dragover__right"),zl(f)):f.classList.contains("av__row--header")?f.classList.add("dragover__bottom"):f.classList.contains("av__row--util")?f.previousElementSibling.classList.add("dragover__bottom"):s.clientY>w.top+w.height/2&&a!=="bottom"?(f.classList.add("dragover__bottom"),zl(f)):a!=="top"&&(f.classList.add("dragover__top"),zl(f));return}if(h.indexOf("-")>-1){h.split(",").includes(t.block.rootID)&&y&&s.altKey?(n=void 0,e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(w=>{w.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),w.removeAttribute("select-start"),w.removeAttribute("select-end")})):n=f;return}if(u){if(a="",g[0]==="nodeattributeview"&&g[1]==="col"&&f.getAttribute("data-id")===g[2]){Gl(n);return}if(g[0]==="nodeattributeviewrowmenu"&&g[2].split("@")[0]===f.getAttribute("data-id")){Gl(n);return}if(g[2].split(",").find(E=>{if(E&&j(f,"data-node-id",E))return!0})&&g[0]!=="nodeattributeviewrowmenu"){Gl(n);return}if(G(f)){Gl(n);return}if(g[0]==="nodelistitem"&&f.getAttribute("data-type")==="NodeListItem"){if(g[1]!==f.getAttribute("data-subtype")){Gl(n);return}if(Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")).find(C=>{if(!C.classList.contains("li"))return!0})){Gl(n);return}}if(g[0]!=="nodelistitem"&&f.getAttribute("data-type")==="NodeListItem"){Gl(n);return}g[0]==="nodelistitem"&&f.parentElement.classList.contains("li")&&((c=f.previousElementSibling)!=null&&c.classList.contains("protyle-action"))&&(a="top"),g[0]==="nodelistitem"&&((d=f.nextElementSibling)!=null&&d.classList.contains("list"))&&(a="bottom"),f&&f.classList.contains("av__row--header")&&(a="top"),n=f}});let i=0;e.addEventListener("dragleave",s=>{if(t.disabled){s.preventDefault(),s.stopPropagation();return}i--,i===0&&(e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(l=>{l.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),n=void 0)}),e.addEventListener("dragenter",s=>{s.preventDefault(),i++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0,document.onmousemove=null)})},zl=t=>{(t.classList.contains("sb")||t.classList.contains("li")||t.classList.contains("list")||t.classList.contains("bq"))&&t.classList.add("dragover")},Gl=t=>{t&&(t.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),t=void 0)},q3=(t,e,n)=>{if(!e.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(t.isComposing)return!0;if(W("\u2318B",t)||W("\u2318I",t)||W("\u2318U",t))return t.preventDefault(),!0;const a=e.querySelector(".av__cell--select");if(a){const s=T(a,"av__row");if(!s||s.dataset.type==="ghost")return!1;const l=document.querySelector(".av__panel");if(l&&(t.key==="Backspace"||t.key==="Delete"||t.key==="Escape"||t.key.startsWith("ArrowLeft")||t.key==="Enter"||W("\u21E5",t)||W("\u21E7\u21E5",t)))return l.remove(),t.preventDefault(),t.stopPropagation(),!0;if(t.key==="Backspace"||t.key==="Delete")return Bn(n,e,void 0,Array.from(e.querySelectorAll(".av__cell--active, .av__cell--select"))),t.preventDefault(),!0;if(t.key==="Escape")return an(["cell"],e),ti(s.querySelector(".av__firstcol"),"select"),t.preventDefault(),!0;if(t.key==="Enter")return Jn(n,[a]),t.preventDefault(),!0;let o;if(t.key==="ArrowLeft"||W("\u21E7\u21E5",t)){const r=s.previousElementSibling;if(a.previousElementSibling&&!a.previousElementSibling.classList.contains("av__firstcol")&&(a.previousElementSibling.classList.contains("av__colsticky")?(o=a.previousElementSibling.lastElementChild,o.classList.contains("av__firstcol")&&(o=void 0)):a.previousElementSibling.classList.contains("av__cell")&&(o=a.previousElementSibling)),!o&&r&&!r.classList.contains("av__row--header")){const c=r.querySelectorAll(".av__cell");o=c[c.length-1]}return o&&(an(["cell"],e),o.classList.add("av__cell--select"),pa(o),Xi(e,o,!1)),t.preventDefault(),!0}if(t.key==="ArrowRight"||W("\u21E5",t)){const r=s.nextElementSibling;return a.nextElementSibling&&a.nextElementSibling.classList.contains("av__cell")?o=a.nextElementSibling:!a.nextElementSibling&&a.parentElement.nextElementSibling?o=a.parentElement.nextElementSibling:r&&!r.classList.contains("av__row--footer")&&(o=r.querySelector(".av__cell")),o?(an(["cell"],e),o.classList.add("av__cell--select"),pa(o),Xi(e,o,!1)):t.key!=="ArrowRight"&&(an(["cell"],e),Ss({blockElement:e,protyle:n,count:1,previousID:s.getAttribute("data-id"),groupID:s.parentElement.getAttribute("data-group-id")})),t.preventDefault(),!0}if(t.key==="ArrowUp"){const r=s.previousElementSibling;return r&&!r.classList.contains("av__row--header")&&(o=r.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),o&&(an(["cell"],e),o.classList.add("av__cell--select"),pa(o),Xi(e,o)),t.preventDefault(),!0}if(t.key==="ArrowDown"){const r=s.nextElementSibling;return r&&!r.classList.contains("av__row--footer")&&(o=r.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),o&&(an(["cell"],e),o.classList.add("av__cell--select"),pa(o),Xi(e,o)),t.preventDefault(),!0}if(!p.KEYCODELIST[t.keyCode]||p.KEYCODELIST[t.keyCode].length===1&&!t.metaKey&&!t.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(p.KEYCODELIST[t.keyCode]))return a.style.backgroundColor?t.preventDefault():Jn(n,[a]),!0}const i=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(i.length>0){if(W("\u2318/",t))return t.stopPropagation(),t.preventDefault(),Yc(n,i[0],{x:e.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:i[0].getBoundingClientRect().bottom}),!0;if(t.key==="Escape")return t.preventDefault(),ti(i[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(t.key==="Backspace")return t.preventDefault(),Uw(e,n),!0;if(t.key==="Enter")return ti(i[0].querySelector(".av__firstcol"),"unselectAll"),Jn(n,[i[0].querySelector(".av__cell")]),t.preventDefault(),!0;if(t.key==="ArrowUp"){const s=i[0].previousElementSibling;return ti(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--header")?(ti(s.querySelector(".av__firstcol"),"select"),Xi(e,s)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}if(t.key==="ArrowDown"){const s=i[i.length-1].nextElementSibling;return ti(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--util")?(ti(s.querySelector(".av__firstcol"),"select"),Xi(e,s)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}}return!1},F3=t=>{const e=document.querySelector(".av__panel");if(e&&window.siyuan.menus.menu.element.classList.contains("fn__none")&&(e.querySelector('[data-type="goSearchRollupCol"]')&&!e.querySelector(".b3-text-field")||e.querySelector('[data-type="addAssetExist"]'))){const n=e.querySelector(".b3-menu__items");if(t.key==="Enter"){const a=n.querySelector(".b3-menu__item--current");if(a){const i=a.querySelector('[data-type="editAssetItem"]'),s=a.querySelector(".b3-form__upload");return i?e.dispatchEvent(new CustomEvent("click",{detail:{type:i.getAttribute("data-type"),target:i}})):s?s.dispatchEvent(new MouseEvent("click",{bubbles:!0})):e.dispatchEvent(new CustomEvent("click",{detail:{type:a.getAttribute("data-type"),target:a}})),!0}}else{if(t.key==="Escape")return e.dispatchEvent(new CustomEvent("click",{detail:"close"})),!0;if(xn(n,t,"b3-menu__item--current",n.firstElementChild))return!0}}return!1},bd=t=>{var e;if(t.command==="switchReadonly")return Tw(t.protyle.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),t.protyle),!0;if(t.command==="switchAdjust"){let a;const i=t.protyle.wysiwyg.element.getAttribute(p.CUSTOM_SY_FULLWIDTH);return i?a=i==="true"?"false":"true":a=window.siyuan.config.editor.fullWidth?"false":"true",A("/api/attr/setBlockAttrs",{id:t.protyle.block.rootID,attrs:{[p.CUSTOM_SY_FULLWIDTH]:a}}),!0}const n=B(t.previousRange.startContainer);if(!n)return!1;if(t.command==="enter"){let a=Et(n);a.parentElement.classList.contains("li")&&a.parentElement.parentElement.classList.contains("list")&&((e=a.nextElementSibling)!=null&&e.classList.contains("list"))&&a.previousElementSibling.classList.contains("protyle-action")&&(a=a.parentElement);const i=a.getAttribute("data-node-id");return t.protyle.options.backlinkData?ft(i,(s,l)=>{ve({app:t.protyle.app,id:i,action:l,zoomIn:s})}):dn({protyle:t.protyle,id:i}),!0}return t.command==="enterBack"?(qh(t.protyle,n.getAttribute("data-node-id")),!0):!1};var U3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const dy=(t,e)=>{let n="";Array.from(t.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),A("/api/block/getDOMText",{dom:n},a=>{e(a.data)})},W3=(t,e)=>{e.addEventListener("keydown",n=>U3(void 0,null,function*(){var a,i,s,l,o,r,c,d,u,m;if(n.target.localName==="protyle-html"||n.target.localName==="input"){n.stopPropagation();return}if(t.disabled||!t.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}t.wysiwyg.preventKeyup=!1,ce(["util"],t),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&ce(["toolbar"],t);const f=ke(t.wysiwyg.element),g=B(f.startContainer);if(!g)return;const h=B(f.endContainer);if(!W("\u2318C",n)&&h&&g!==h){n.stopPropagation(),n.preventDefault();return}if(document.querySelector(".av__panel")||q3(n,g,t))return;if(g.classList.contains("protyle-wysiwyg--select")&&et(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{Gn(t,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{Gn(t,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(p.KEYCODELIST[n.keyCode])||(p.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?t.hint.enableSlash=!0:(p.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.key===","&&n.keyCode===229||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(t.hint.enableSlash=!1,ce(["hint"],t))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!An(g)&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Process"&&(hd(g,f,t),t.wysiwyg.preventKeyup=!0),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(p.KEYCODELIST[n.keyCode])||p.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&et(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&t.options.render.breadcrumb&&t.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&et(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const k=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(k.length>0){if(n.preventDefault(),n.stopPropagation(),ce(["select"],t),n.key==="ArrowDown"){const _=k[k.length-1];let v=mt(_);if(v)if(v.getBoundingClientRect().width===0){const L=Le(v,"fold","1");L?(v=mt(L),v?v=Ut(v):v=_):v=_}else v.getAttribute("fold")==="1"&&(v.classList.contains("sb")||v.classList.contains("bq"))||(v=Ut(v));else v=_;v.classList.add("protyle-wysiwyg--select"),Pn([v.getAttribute("data-node-id")]);const S=v.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;S>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+S,t.scroll.lastScrollTop=t.contentElement.scrollTop-1),oe(v)}else if(n.key==="ArrowUp"){let _=Qe(k[0]);if(_){if(_=$t(_),_.getBoundingClientRect().width===0){const v=Le(_,"fold","1");v?_=Ut(v):_=k[0]}else if(_){const v=Le(_,"fold","1");v&&(v.classList.contains("sb")||v.classList.contains("bq"))&&(_=v)}}else if(t.title&&t.title.editElement&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)){const v=Yt(t.title.editElement,f,!1);v.collapse(!1),ne(v),n.stopPropagation(),n.preventDefault()}else t.contentElement.scrollTop!==0?(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8):_=k[0];if(_){_.classList.add("protyle-wysiwyg--select"),Pn([_.getAttribute("data-node-id")]);const v=_.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;v<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+v,t.scroll.lastScrollTop=t.contentElement.scrollTop+1),oe(_)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&et(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),ce(["select"],t),g&&fe(g)&&f.endContainer.nodeType===1&&f.endContainer.classList.contains("protyle-attr")&&f.collapse(!0),!1;if(W(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const k=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return k.length>0?Nt(t,k[0]):g.parentElement.getAttribute("data-type")==="NodeListItem"?g.parentElement.childElementCount>3?Nt(t,g.parentElement):Nt(t,g):g.getAttribute("data-type")==="NodeHeading"?Nt(t,g):Nt(t,Et(g)),n.stopPropagation(),n.preventDefault(),!1}if(W(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const k=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");k.length>0?Nt(t,k[0],!0):g.parentElement.getAttribute("data-type")==="NodeListItem"?g.parentElement.childElementCount>3?Nt(t,g.parentElement,!0):Nt(t,g,!0):g.getAttribute("data-type")==="NodeHeading"?Nt(t,g,!0):Nt(t,Et(g),!0),n.stopPropagation(),n.preventDefault();return}if(W(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){Lv({protyle:t,event:n,nodeElement:g,editorElement:e,range:f,cb(k){const _=k[0].previousElementSibling;if(_&&_.getAttribute("data-node-id")){_.classList.add("protyle-wysiwyg--select"),k.forEach(S=>{S.removeAttribute("select-end")}),_.setAttribute("select-end","true");const v=_.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;v<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+v,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else k[0].parentElement.classList.contains("protyle-wysiwyg")||(ce(["select"],t),k[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(W(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){Av({protyle:t,event:n,nodeElement:g,editorElement:e,range:f,cb(k){const _=k[k.length-1],v=_.nextElementSibling;if(v&&v.getAttribute("data-node-id")){v.classList.add("protyle-wysiwyg--select"),k.forEach(L=>{L.removeAttribute("select-end")}),v.setAttribute("select-end","true");const S=v.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;S>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+S,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else _.parentElement.classList.contains("protyle-wysiwyg")||(ce(["select"],t),_.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(W("\u21E7\u2191",n)){Lv({protyle:t,event:n,nodeElement:g,editorElement:e,range:f,cb(k){const _=yp(k);if(_.startElement.getBoundingClientRect().top>=_.endElement.getBoundingClientRect().top){const v=_.endElement.previousElementSibling;if(v&&v.getAttribute("data-node-id")){v.classList.add("protyle-wysiwyg--select"),v.setAttribute("select-end","true"),_.endElement.removeAttribute("select-end");const S=v.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;S<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+S,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else _.endElement.parentElement.classList.contains("protyle-wysiwyg")||(ce(["select"],t),_.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{_.endElement.classList.remove("protyle-wysiwyg--select"),_.endElement.removeAttribute("select-end");const v=Qe(_.endElement);v&&(v.setAttribute("select-end","true"),v.getBoundingClientRect().top<=t.contentElement.getBoundingClientRect().top&&(ra(t),v.scrollIntoView(!0)))}}});return}if(W("\u21E7\u2193",n)){Av({protyle:t,event:n,nodeElement:g,editorElement:e,range:f,cb(k){const _=yp(k);if(_.startElement.getBoundingClientRect().top<=_.endElement.getBoundingClientRect().top){const v=_.endElement.nextElementSibling;if(v&&v.getAttribute("data-node-id"))if(v.getBoundingClientRect().width===0)ce(["select"],t),_.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{v.classList.add("protyle-wysiwyg--select"),v.setAttribute("select-end","true"),_.endElement.removeAttribute("select-end");const S=v.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;S>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+S,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else _.endElement.parentElement.classList.contains("protyle-wysiwyg")||(ce(["select"],t),_.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{_.endElement.classList.remove("protyle-wysiwyg--select"),_.endElement.removeAttribute("select-end");const v=mt(_.endElement);v&&(v.setAttribute("select-end","true"),v.getBoundingClientRect().bottom>=t.contentElement.getBoundingClientRect().bottom&&(ra(t),v.scrollIntoView(!1)))}}});return}if(W(window.siyuan.config.keymap.general.enter.custom,n)){bd({protyle:t,command:"enter",previousRange:f}),n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.general.enterBack.custom,n)){bd({protyle:t,command:"enterBack",previousRange:f}),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&et(n)&&(n.key==="Home"||n.key==="End")&&Mt()||n.shiftKey&&!n.altKey&&Wt(n)&&(n.key==="Home"||n.key==="End")&&!Mt()){const k=Le(g,"data-node-id",null);if(k){k.querySelectorAll(".protyle-wysiwyg--select").forEach(v=>{v.classList.remove("protyle-wysiwyg--select")}),k.classList.add("protyle-wysiwyg--select");let _=n.key==="Home"?k.previousElementSibling:k.nextElementSibling;for(;_;)_.classList.add("protyle-wysiwyg--select"),_=n.key==="Home"?_.previousElementSibling:_.nextElementSibling;n.key==="Home"?t.wysiwyg.element.firstElementChild.scrollIntoView():t.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if((n.key==="Home"||n.key==="End")&&!n.shiftKey&&!n.altKey&&et(n)&&ce(["hint"],t),!n.altKey&&!n.shiftKey&&et(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(t.contentElement.scrollTop=t.contentElement.scrollTop-t.contentElement.clientHeight+60,t.scroll.lastScrollTop=t.contentElement.scrollTop+1):(t.contentElement.scrollTop=t.contentElement.scrollTop+t.contentElement.clientHeight-60,t.scroll.lastScrollTop=t.contentElement.scrollTop-1);const k=t.contentElement.getBoundingClientRect();let _=document.elementFromPoint(k.x+k.width/2,k.y+k.height/2);_.classList.contains("protyle-wysiwyg")&&(_=document.elementFromPoint(k.x+k.width/2,k.y+k.height/2+p.SIZE_TOOLBAR_HEIGHT));const v=B(_);v&&v!==g&&oe(v,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&et(n)||n.key==="Enter")&&!t.hint.element.classList.contains("fn__none")&&t.hint.select(n,t))return;if(W("\u2318/",n)){n.stopPropagation(),n.preventDefault();const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(k.length===0){const v=j(f.startContainer,"data-type",null);if(v&&v.tagName==="SPAN"){const S=v.getAttribute("data-type").split(" ");if(S.length>0&&(t.toolbar.range=f,kv(v)),S.includes("block-ref")){Rh(t,v);return}else if(S.includes("inline-memo")){t.toolbar.showRender(t,v);return}else if(S.includes("file-annotation-ref")){Bh(t,v);return}else if(S.includes("a")){Jo(t,v);return}else if(S.includes("tag")){Uh(t,v);return}}if(f.startOffset===0&&f.startContainer.nodeType===3){const S=pt(f.startContainer);if(S&&S.nodeType!==3&&((a=S.getAttribute("data-type"))==null?void 0:a.indexOf("inline-math"))>-1){wp(t,S);return}else if(!S&&f.startContainer.parentElement.previousSibling&&f.startContainer.parentElement.previousSibling===f.startContainer.parentElement.previousElementSibling&&((i=f.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){wp(t,f.startContainer.parentElement.previousElementSibling);return}}k.push(g)}k.length===1?t.gutter.renderMenu(t,k[0]):t.gutter.renderMultipleMenu(t,k);const _=g.getBoundingClientRect();window.siyuan.menus.menu.popup({x:_.left,y:_.top,isLeft:!0});return}if(qA(t,n,f)){n.preventDefault();return}const b=f.toString();if(!n.altKey&&!n.shiftKey&&et(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const k=U(f.startContainer,"TD")||U(f.startContainer,"TH"),_=k||fe(g)||g,v=_t(_,t.wysiwyg.element,f);if(g.classList.contains("code-block")&&v.end===_.innerText.length&&(v.end-=1),n.key==="ArrowDown"&&(_==null?void 0:_.innerText.trimRight().substr(v.start).indexOf(`
`))===-1&&(k&&!k.parentElement.nextElementSibling&&g.getAttribute("data-type")==="NodeTable"&&!mt(g)||g.getAttribute("data-type")==="NodeCodeBlock"&&!mt(g)||g.parentElement.getAttribute("data-type")==="NodeBlockquote"&&g.nextElementSibling.classList.contains("protyle-attr")&&!mt(g.parentElement)))g.parentElement.getAttribute("data-type")==="NodeBlockquote"?Gn(t,"afterend",g.parentElement.getAttribute("data-node-id")):Gn(t,"afterend",g.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const S=fe(t.wysiwyg.element.firstElementChild);if(!Qe(g)&&g.contains(S)||!S&&g===t.wysiwyg.element.firstElementChild){if(Ca(_,f).top-_.getBoundingClientRect().top<20||g.classList.contains("av"))if(t.title&&t.title.editElement&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)){const L=Yt(t.title.editElement,f,!1);L.collapse(!1),ne(L),n.stopPropagation(),n.preventDefault()}else t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8}else if(((_==null?void 0:_.innerText.substr(0,v.end).indexOf(`
`))===-1||v.start===0)&&Ca(_,f).top-_.getBoundingClientRect().top<20){let L=Qe(g);if(L&&(L=$t(L),L)){const D=Le(L,"fold","1");if(!D&&L.classList.contains("code-block"))oe(L,void 0,!1),Ye(t,L),n.stopPropagation(),n.preventDefault();else if(D)D.scrollTop=0,oe(D,void 0,!0),Ye(t,D),n.stopPropagation(),n.preventDefault();else{const I=fe(L);if(I&&((s=I.lastChild)==null?void 0:s.nodeType)===3&&((l=I.lastChild)!=null&&l.textContent.endsWith(`
`))){oe(L,void 0,!1),n.preventDefault(),n.stopPropagation();return}}}}}else if(b===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&g===$t(t.wysiwyg.element.lastElementChild)&&!U(f.startContainer,"TD")&&!U(f.startContainer,"TH")){const S=fe(g);S&&!S.querySelector(".emoji")&&S.textContent.replace(/\n$/,"").length<=_t(S,void 0,f).end&&(n.stopPropagation(),n.preventDefault(),ne(f))}else if(b===""&&n.key==="ArrowLeft"&&g===Ut(t.wysiwyg.element.firstElementChild)){const S=fe(g);S&&_t(S,void 0,f).start===0&&(n.stopPropagation(),n.preventDefault(),ne(f))}if(n.key==="ArrowDown"){if((_==null?void 0:_.innerText.trimRight().substr(v.start).indexOf(`
`))===-1&&g===t.wysiwyg.element.lastElementChild){Yt(fe(_),f,!1),f.collapse(!1),n.stopPropagation(),n.preventDefault();return}const S=j(f.startContainer,"fold","1");if(S){let L=mt(S);L&&(L.getAttribute("fold")==="1"&&(L.classList.contains("sb")||L.classList.contains("bq"))||(L=Ut(L)),oe(L),Ye(t,L)),n.stopPropagation(),n.preventDefault()}else if((_==null?void 0:_.innerText.substr(v.end).indexOf(`
`))===-1||v.end>=_.innerText.trimEnd().length){f.collapse(!1);const L=mt(g);L&&(L.getAttribute("fold")==="1"||L.classList.contains("code-block"))&&_.getBoundingClientRect().bottom-Ca(g,f).top<40&&(oe(L),Ye(t,L),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||W("\u2303D",n)){if(t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){Ea(t,g,f,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}if(b===""&&n.key==="Backspace"&&f.startOffset===f.startContainer.textContent.length&&f.startContainer.textContent.endsWith(`
`+p.ZWSP)){f.setStart(f.startContainer,f.startOffset-1),f.collapse(!0),n.stopPropagation(),n.preventDefault();return}const k=pt(f.startContainer);if(f.startOffset===1&&f.startContainer.textContent===p.ZWSP&&k&&k.nodeType!==3&&n.key==="Backspace"){if(k.classList.contains("img"))k.classList.add("img--select");else if(((o=k.getAttribute("data-type"))==null?void 0:o.indexOf("inline-math"))>-1){k.after(document.createElement("wbr"));const S=g.outerHTML;f.startContainer.textContent="",k.remove(),le(t,g.getAttribute("data-node-id"),g.outerHTML,S),we(g,f),n.stopPropagation(),n.preventDefault();return}}const _=fe(g),v=t.wysiwyg.element.querySelector(".img--select");if(v){if(v.classList.remove("img--select"),g.contains(v)){Wh(v,g,f,t),n.stopPropagation(),n.preventDefault();return}}else if(b===""){if(g.classList.contains("table")&&g.querySelector(".table__select").clientHeight>0){kw(t,g),n.stopPropagation(),n.preventDefault();return}if(!_){g.classList.add("protyle-wysiwyg--select"),Ea(t,g,f,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}const S=_t(_,t.wysiwyg.element,f);if(n.key==="Delete"||W("\u2303D",n)){if(f.startOffset===0&&f.startContainer.textContent.length===1){const L=pt(f.startContainer),D=Ge(f.startContainer);if(L&&L.nodeType===1&&L.classList.contains("img")&&D&&D.nodeType===1&&D.classList.contains("img")){const I=document.createElement("wbr");f.insertNode(I);const q=g.outerHTML;I.nextSibling.textContent=p.ZWSP,le(t,g.getAttribute("data-node-id"),g.outerHTML,q),we(g,f),n.preventDefault();return}if(S.start===0&&f.startContainer.textContent!==p.ZWSP&&!L&&D&&D.nodeType===1&&D.classList.contains("img")){const I=document.createElement("wbr");f.insertNode(I);const q=g.outerHTML;I.nextSibling.textContent=p.ZWSP,le(t,g.getAttribute("data-node-id"),g.outerHTML,q),we(g,f),n.preventDefault();return}}if(Na(f)||_.textContent.substring(S.start)===`
`){const L=f.cloneRange(),D=mt(Et(g));if(D){const I=oe(D);if(I){const q=B(I.startContainer);q&&(!q.classList.contains("code-block")||q.classList.contains("code-block")&&fe(q).textContent==`
`||q.parentElement.classList.contains("li"))&&(L.insertNode(document.createElement("wbr")),Ea(t,q,I,"Delete"))}n.stopPropagation(),n.preventDefault();return}}else if(S.end===_.innerText.length-1&&g.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}else{let L=Ge(f.startContainer);if(L){if(L.nodeType===3&&L.textContent===p.ZWSP){if(!L.nextSibling){const D=mt(g);D&&Ea(t,D,f,"remove"),n.stopPropagation(),n.preventDefault();return}L=L.nextSibling}if(L.nodeType===1&&L.classList.contains("img")&&_t(f.startContainer,t.wysiwyg.element,f).start===f.startContainer.textContent.length){Wh(L,g,f,t),n.stopPropagation(),n.preventDefault();return}}}}else{const L=f.startContainer.childNodes[f.startOffset-1];if(S.start===0&&(f.startOffset===0||L&&L.nodeType===3&&!pt(L)&&L.textContent==="")){(!g.classList.contains("code-block")||g.classList.contains("code-block")&&(_.textContent==`
`||g.parentElement.classList.contains("li")))&&Ea(t,g,f,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(f.startContainer.nodeType!==3&&g.getAttribute("data-type")==="NodeTable"&&((r=f.startContainer.children[f.startOffset-1])==null?void 0:r.tagName)==="TABLE"){g.classList.add("protyle-wysiwyg--select"),Ea(t,g,f,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(L&&L.nodeType!==3&&L.classList.contains("img")){Wh(L,g,f,t),n.stopPropagation(),n.preventDefault();return}const D=Ge(f.startContainer);if(D&&D.nodeType===1&&["code","tag","kbd"].includes(D.dataset.type)&&(S.start===1||f.startContainer.textContent.slice(-2,-1)===`
`)&&(f.insertNode(document.createTextNode(p.ZWSP)),f.collapse(!0)),f.startOffset===1&&f.startContainer.textContent.length===1){const q=pt(f.startContainer);if(q&&q.nodeType===1&&q.classList.contains("img")&&D&&D.nodeType===1&&D.classList.contains("img")){const Z=document.createElement("wbr");f.insertNode(Z);const R=g.outerHTML;Z.previousSibling.textContent=p.ZWSP,le(t,g.getAttribute("data-node-id"),g.outerHTML,R),we(g,f),n.preventDefault();return}if(S.start===1&&f.startContainer.textContent!==p.ZWSP&&!q&&D&&D.nodeType===1&&D.classList.contains("img")){const Z=document.createElement("wbr");f.insertNode(Z);const R=g.outerHTML;Z.previousSibling.textContent=p.ZWSP,le(t,g.getAttribute("data-node-id"),g.outerHTML,R),we(g,f),n.preventDefault();return}}if(g.classList.contains("code-block")&&Wt(n)&&f.startContainer.nodeType===3&&f.startContainer.textContent.substring(f.startOffset-1,f.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const I=U(f.startContainer,"SPAN");if(S.start===2&&I&&_t(I,t.wysiwyg.element,f).start===1&&I.innerText.startsWith(p.ZWSP)&&I.innerText!==p.ZWSP&&_.innerText.startsWith(p.ZWSP)){oe(g),n.stopPropagation(),n.preventDefault();return}if(S.start===1&&!I&&_.innerText.startsWith(p.ZWSP)&&_.innerText.length>1){Yl(_,f),Ea(t,g,f,"Backspace"),n.stopPropagation(),n.preventDefault();return}}}else if(g.classList.contains("code-block")&&_.textContent===`
`){f.collapse(!0),n.stopPropagation(),n.preventDefault();return}else if(b!==""){const S=_t(_,t.wysiwyg.element,f);if(f.startOffset===0&&f.endContainer.textContent.length===f.endOffset){const L=pt(f.startContainer),D=Ge(f.endContainer);if(L&&L.nodeType===1&&L.classList.contains("img")&&D&&D.nodeType===1&&D.classList.contains("img")||S.start===0&&f.startContainer.textContent!==p.ZWSP&&!L&&D&&D.nodeType===1&&D.classList.contains("img")){f.insertNode(document.createElement("wbr"));const I=g.outerHTML;f.deleteContents(),f.insertNode(document.createTextNode(p.ZWSP)),f.insertNode(document.createElement("wbr")),le(t,g.getAttribute("data-node-id"),g.outerHTML,I),we(g,f),n.preventDefault();return}}}}if(W("\u21E7\u21A9",n)&&b===""&&Ix(f,g,t)){n.stopPropagation(),n.preventDefault();return}if(W("\u2325\u21A9",n)&&b===""){const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(k.length===0&&k.push(g),k.length>0&&!Km("\u2325\u21A9")){if(k.find(v=>!v.classList.contains("code-block")))zx(t,g,f);else{const v=[];k.forEach(S=>{v.push(S.querySelector(".protyle-action__language"))}),t.toolbar.showCodeLanguage(t,v)}n.stopPropagation(),n.preventDefault();return}}if(W("\u21A9",n)){Tx(g,f,t),n.stopPropagation(),n.preventDefault();return}if(W("\u2318A",n))return n.preventDefault(),Jp(t,g,f),!0;if(W(window.siyuan.config.keymap.editor.general.undo.custom,n)){t.undo.undo(t),n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.editor.general.redo.custom,n)){t.undo.redo(t),n.preventDefault(),n.stopPropagation();return}if(Sv(t,n,g))return!0;if(W(window.siyuan.config.keymap.editor.general.copyText.custom,n)){if(b!=="")dy(f,k=>{Be(`${k.trim()} ((${g.getAttribute("data-node-id")} "*"))`)});else{const k=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");k.length>0?(k[0].setAttribute("data-reftext","true"),ne(ke(g)),document.execCommand("copy")):Be(`((${g.getAttribute("data-node-id")} "*"))`)}return n.preventDefault(),n.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.general.attr.custom,n)){const k=Et(g);if(b===""){const _=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let v;_.length===1?v=_[0]:v=k,xi(v,"bookmark",t)}else dy(f,_=>{const v=k.outerHTML,S=k.lastElementChild.querySelector(".protyle-attr--name");S?S.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${_.trim()}`:k.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${_.trim()}</div>`),k.setAttribute("name",_.trim()),le(t,k.getAttribute("data-node-id"),k.outerHTML,v)});return n.preventDefault(),n.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!t.disabled){b===""?A("/api/block/getDocInfo",{id:t.block.rootID},k=>{sh({notebookId:t.notebookId,path:t.path,name:k.data.ial.title,range:f,type:"file"})}):A("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:oa(b)}),n.preventDefault(),n.stopPropagation();return}const y=W(window.siyuan.config.keymap.editor.general.newNameFile.custom,n);if(y||W(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!b.trim()&&(g.querySelector("tr")||g.querySelector("span"))||(!b.trim()&&fe(g).textContent&&Jp(t,g,f),y?A("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.path},k=>{Jw(t,b,g,k.data,t.notebookId)}):hh(t.path,t.notebookId,(k,_)=>{Jw(t,b,g,k,_)})),n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){BA(t),n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const k=g.querySelectorAll(".img--select");if(k.length>0)Tv(t,g,Array.from(k),g.getAttribute("data-node-id"),g.outerHTML);else{let _=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));_.length===0&&(_=[g]),Ds(_,t,v=>{v.classList.contains("av")?v.style.justifyContent="":v.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(W(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const k=g.querySelectorAll(".img--select");if(k.length>0)Cv(t,g,Array.from(k),g.getAttribute("data-node-id"),g.outerHTML);else{let _=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));_.length===0&&(_=[g]),Ds(_,t,v=>{v.classList.contains("av")?v.style.justifyContent="center":v.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(W(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));k.length===0&&(k=[g]),Ds(k,t,_=>{_.classList.contains("av")?_.style.justifyContent="flex-end":_.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(W(window.siyuan.config.keymap.editor.general.rtl.custom,n)){let k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));k.length===0&&(k=[g]),Ds(k,t,_=>{_.style.direction="rtl"}),n.stopPropagation(),n.preventDefault();return}if(W(window.siyuan.config.keymap.editor.general.ltr.custom,n)){let k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));k.length===0&&(k=[g]),Ds(k,t,_=>{_.style.direction="ltr"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){if(n.repeat){const k=T(f.startContainer,"card__main",!0);k&&document.activeElement&&document.activeElement.classList.contains("protyle-wysiwyg")&&(k.querySelector(".card__action:not(.fn__none) button:not([disabled])").focus(),ce(["select"],t))}else!t.toolbar.element.classList.contains("fn__none")||!t.hint.element.classList.contains("fn__none")||!t.toolbar.subElement.classList.contains("fn__none")?(ce(["toolbar","hint","util"],t),t.hint.enableExtend=!1):window.siyuan.menus.menu.element.classList.contains("fn__none")?g.classList.contains("protyle-wysiwyg--select")?(ce(["select"],t),Pn([],t.block.rootID)):(ce(["select"],t),f.collapse(!1),g.classList.add("protyle-wysiwyg--select"),Pn([g.getAttribute("data-node-id")],t.block.rootID)):window.siyuan.menus.menu.remove(!0);n.stopPropagation(),n.preventDefault();return}if(W(window.siyuan.config.keymap.editor.heading.paragraph.custom,n)){const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(k.length===0&&k.push(g),k.length>1)ka({protyle:t,nodeElement:k[0],type:"Blocks2Ps"});else{const _=k[0].getAttribute("data-type");_==="NodeHeading"?ka({protyle:t,nodeElement:k[0],type:"Blocks2Ps"}):_==="NodeList"?lr({protyle:t,nodeElement:k[0],id:k[0].getAttribute("data-node-id"),type:"CancelList"}):_==="NodeBlockquote"&&lr({protyle:t,nodeElement:k[0],id:k[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return n.preventDefault(),n.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return ka({protyle:t,nodeElement:g,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return ka({protyle:t,nodeElement:g,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return ka({protyle:t,nodeElement:g,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return ka({protyle:t,nodeElement:g,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return ka({protyle:t,nodeElement:g,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return ka({protyle:t,nodeElement:g,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading","NodeTable"].includes(g.getAttribute("data-type"))){const k=fe(g);if(k){const _=g.getAttribute("data-node-id"),v=g.outerHTML;k.innerHTML="```"+window.siyuan.storage[p.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(k.textContent)+"<wbr>\n```";const S=t.lute.SpinBlockDOM(g.outerHTML);g.outerHTML=S;const L=t.wysiwyg.element.querySelector(`[data-node-id="${_}"]`);return le(t,_,S,v),rt(L),n.preventDefault(),n.stopPropagation(),!0}}if(W(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){t.toolbar.range=f;const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b===""&&k.length===0&&k.push(g),ii(t,k),n.stopPropagation(),n.preventDefault();return}if(!g.classList.contains("code-block")&&!n.repeat&&!G(g)){let k=!1;if(t.options.toolbar.find(_=>{if(!_.hotkey)return!1;if(W(_.hotkey,n))return t.toolbar.range=f,["block-ref"].includes(_.name)&&t.toolbar.range.toString()===""||(k=!0,["a","block-ref","inline-math","inline-memo","text"].includes(_.name)?t.toolbar.element.querySelector(`[data-type="${_.name}"]`).dispatchEvent(new CustomEvent("click")):p.INLINE_TYPE.includes(_.name)?t.toolbar.setInlineMark(t,_.name,"range"):_.click&&_.click(t.getInstance())),!0}),k)return n.preventDefault(),n.stopPropagation(),t.wysiwyg.preventKeyup=!0,!0}if(W(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const k=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(k.length>0){let _=!0;return k.forEach((v,S)=>{v.nextElementSibling&&k[S+1]&&k[S+1]!==v.nextElementSibling&&(_=!1)}),_&&(k[0].classList.contains("li")||k[0].parentElement.classList.contains("li"))&&qc(t,Array.from(k),f),n.preventDefault(),n.stopPropagation(),!0}else if(g.parentElement.classList.contains("li")&&g.getAttribute("data-type")!=="NodeCodeBlock")return qc(t,[g.parentElement],f),n.preventDefault(),n.stopPropagation(),!0}if(W(window.siyuan.config.keymap.editor.list.indent.custom,n)){const k=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(k.length>0){let _=!0;return k.forEach((v,S)=>{v.nextElementSibling&&k[S+1]&&k[S+1]!==v.nextElementSibling&&(_=!1)}),_&&(k[0].classList.contains("li")||k[0].parentElement.classList.contains("li"))&&Vh(t,Array.from(k),f),n.preventDefault(),n.stopPropagation(),!0}else if(g.parentElement.classList.contains("li")&&g.getAttribute("data-type")!=="NodeCodeBlock")return Vh(t,[g.parentElement],f),n.preventDefault(),n.stopPropagation(),!0}const w=W(window.siyuan.config.keymap.editor.insert.list.custom,n),E=W(window.siyuan.config.keymap.editor.insert.check.custom,n),C=W(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,n),$=W(window.siyuan.config.keymap.editor.insert.quote.custom,n);if(w||C||E||$){const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(k.length===0&&k.push(g),k.length===1){const _=k[0].dataset.subtype,v=k[0].dataset.type;if($)["NodeHeading","NodeParagraph","NodeList"].includes(v)?ga({protyle:t,selectsElement:k,type:"Blocks2Blockquote"}):(t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(">"+Lute.Caret,t));else if(v==="NodeParagraph")ga({protyle:t,selectsElement:k,type:E?"Blocks2TLs":w?"Blocks2ULs":"Blocks2OLs"});else if(v==="NodeList"){const S=k[0].dataset.nodeId;_==="o"&&(w||E)?lr({protyle:t,nodeElement:k[0],id:S,type:E?"UL2TL":"OL2UL"}):_==="t"&&(w||C)?lr({protyle:t,nodeElement:k[0],id:S,type:w?"TL2UL":"TL2OL"}):_==="u"&&(E||C)&&lr({protyle:t,nodeElement:k[0],id:S,type:E?"OL2TL":"UL2OL"})}else t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill((E?"- [ ] ":w?"- ":"1. ")+Lute.Caret,t)}else{let _=!1,v=!1;k.find((S,L)=>{if(S.classList.contains("li"))return _=!0,!0;if(S.nextElementSibling&&k[L+1]&&S.nextElementSibling===k[L+1])v=!0;else if(L!==k.length-1)return v=!1,!0}),!_&&v&&ga({protyle:t,selectsElement:k,type:$?"Blocks2Blockquote":E?"Blocks2TLs":w?"Blocks2ULs":"Blocks2OLs"})}n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.editor.insert.table.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,t),n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const k=j(f.startContainer,"data-subtype","t");if(!k)return;const _=k.outerHTML;k.classList.contains("protyle-task--done")?(k.querySelector("use").setAttribute("xlink:href","#iconUncheck"),k.classList.remove("protyle-task--done")):(k.querySelector("use").setAttribute("xlink:href","#iconCheck"),k.classList.add("protyle-task--done")),k.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,k.getAttribute("data-node-id"),k.outerHTML,_),n.preventDefault(),n.stopPropagation();return}if(W(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return(c=g.querySelector(".img--select"))==null||c.classList.remove("img--select"),Gn(t,"beforebegin"),n.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return(d=g.querySelector(".img--select"))==null||d.classList.remove("img--select"),Gn(t,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return Xo(t,g,"next"),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.jumpToParent.custom,n))return Xo(t,g,"parent"),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,n))return Xo(t,g,"previous"),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),_x(t,g,f);return}if(W(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),wx(t,g,f);return}if(W(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(k.length===1&&k[0].getAttribute("data-type")==="NodeSuperBlock"){if(k[0].getAttribute("data-sb-layout")==="col"){const _=k[0].outerHTML;k[0].setAttribute("data-sb-layout","row"),k[0].setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,k[0].getAttribute("data-node-id"),k[0].outerHTML,_)}else{f.insertNode(document.createElement("wbr"));const _=yield Li(t,k[0]);V(t,_.doOperations,_.undoOperations),we(t.wysiwyg.element,f)}return}if(k.length<2||(u=k[0])!=null&&u.classList.contains("li"))return;ga({protyle:t,selectsElement:k,type:"BlocksMergeSuperBlock",level:"row"});return}if(W(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(k.length===1&&k[0].getAttribute("data-type")==="NodeSuperBlock"){if(k[0].getAttribute("data-sb-layout")==="row"){const _=k[0].outerHTML;k[0].setAttribute("data-sb-layout","col"),k[0].setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(t,k[0].getAttribute("data-node-id"),k[0].outerHTML,_)}else{f.insertNode(document.createElement("wbr"));const _=yield Li(t,k[0]);V(t,_.doOperations,_.undoOperations),we(t.wysiwyg.element,f)}return}if(k.length<2||(m=k[0])!=null&&m.classList.contains("li"))return;ga({protyle:t,selectsElement:k,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&W(window.siyuan.config.keymap.editor.general.ai.custom,n)){n.preventDefault(),n.stopPropagation();let k=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));k.length===0&&(k=[g]),ry(k,t);return}if(!n.repeat&&W(window.siyuan.config.keymap.editor.general.aiWriting.custom,n)){n.preventDefault(),n.stopPropagation(),nS(t,g);return}if(!n.repeat&&W(window.siyuan.config.keymap.editor.general.openInNewTab.custom,n)){n.preventDefault(),n.stopPropagation();const k=window.siyuan.blockPanels.find(v=>{if(v.element.contains(g))return!0}),_=g.getAttribute("data-node-id");ft(_,(v,S)=>{ve({app:t.app,id:_,action:S,zoomIn:v,openNewTab:!0}),k.destroy()});return}if(n.key==="Tab"&&et(n)&&!n.altKey){n.preventDefault();const k=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(g.getAttribute("data-type")==="NodeCodeBlock"&&b!==""){!Ge(f.endContainer)&&f.endContainer.textContent.endsWith(`
`)&&f.endOffset>0&&f.setEnd(f.endContainer,f.endOffset-1);const _=document.createElement("wbr");f.insertNode(_),f.setStartAfter(_);const v=g.outerHTML;let S="";n.shiftKey?f.extractContents().textContent.split(`
`).forEach(I=>{I.startsWith(k)?S+=I.replace(k,"")+`
`:S+=I+`
`}):f.extractContents().textContent.split(`
`).forEach(I=>{S+=k+I+`
`});let L=g.querySelector(".protyle-action__language").textContent;if(f.commonAncestorContainer.nodeType===1){const I=f.commonAncestorContainer.className;I.startsWith("language-")&&(L=I.replace("language-",""),_.parentElement!==f.commonAncestorContainer&&(_.parentElement.after(_),_.previousElementSibling.remove()))}window.hljs.getLanguage(L)||(L="plaintext"),_.insertAdjacentHTML("afterend",window.hljs.highlight(S.substr(0,S.length-1),{language:L,ignoreIllegals:!0}).value+"<br>"),f.setStart(_.nextSibling,0);const D=_.parentElement.querySelector("br");Yt(D.previousSibling,f,!1),D.remove(),le(t,g.getAttribute("data-node-id"),g.outerHTML,v),_.remove();return}if(!n.shiftKey){const _=f.startContainer.parentElement,v=t.toolbar.getCurrentType(f);v.length>0&&f.toString()===""&&f.startOffset===0&&_.tagName==="SPAN"&&!pt(f.startContainer)&&!pt(_)?(f.setStartBefore(_),f.collapse(!0)):_.tagName==="SPAN"&&!v.includes("search-mark")&&!v.includes("code")&&!v.includes("kbd")&&!v.includes("tag")&&f.toString()===""&&f.startContainer.nodeType===3&&(v.includes("inline-memo")||v.includes("block-ref")||v.includes("file-annotation-ref")||v.includes("a"))&&!Ge(f.startContainer)&&f.startContainer.textContent.length===f.startOffset&&(f.setEndAfter(_),f.collapse(!1));const S=document.createElement("wbr");f.insertNode(S);const L=g.outerHTML;return f.extractContents(),f.insertNode(document.createTextNode(k)),f.collapse(!1),ne(f),S.remove(),le(t,g.getAttribute("data-node-id"),g.outerHTML,L),!0}}if(n.key==="ContextMenu"){const k=Ca(g,f);t.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:g,y:k.top+8,x:k.left}})),n.preventDefault(),n.stopPropagation();return}const M=j(f.startContainer,"data-type","block-ref");if(M){const k=M.getAttribute("data-id");if(W(window.siyuan.config.keymap.editor.general.openBy.custom,n))return ft(k,(_,v,S)=>{S||v.push(p.CB_GET_HL),ve({app:t.app,id:k,action:v,zoomIn:_})}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.refTab.custom,n))return ft(k,_=>{ve({app:t.app,id:k,action:_?[p.CB_GET_HL,p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:_})}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.insertRight.custom,n))return ft(k,(_,v,S)=>{S||v.push(p.CB_GET_HL),ve({app:t.app,id:k,position:"right",action:v,zoomIn:_})}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.insertBottom.custom,n))return ft(k,(_,v,S)=>{S||v.push(p.CB_GET_HL),ve({app:t.app,id:k,position:"bottom",action:v,zoomIn:_})}),n.preventDefault(),n.stopPropagation(),!0;if(W(window.siyuan.config.keymap.editor.general.refPopover.custom,n))return window.siyuan.blockPanels.push(new ud({app:t.app,isBacklink:!1,targetElement:M,refDefs:[{refID:k}]})),n.preventDefault(),n.stopPropagation(),!0}if(W("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),rh(t);return}if(W(window.siyuan.config.keymap.editor.general.openBy.custom,n)){const k=j(f.startContainer,"data-type","a");if(k){Uc(t,k.getAttribute("data-href"),void 0,!1),n.preventDefault(),n.stopPropagation();return}const _=j(f.startContainer,"data-type","file-annotation-ref");if(_){const S=`assets/${_.getAttribute("data-id").split("/")[1]}`;Uc(t,S,void 0,!1),n.preventDefault(),n.stopPropagation();return}return}if(n.shiftKey&&(n.key==="ArrowLeft"||n.key==="ArrowRight")){if(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(!f.toString()){if(n.key==="ArrowRight"&&Na(f)&&!Km("\u2325\u21E7\u2192")){n.preventDefault(),n.stopPropagation();return}const _=fe(g);if(_t(_,t.wysiwyg.element,f).start===0&&n.key==="ArrowLeft"&&!Km("\u2325\u21E7\u2190")){n.preventDefault(),n.stopPropagation();return}}}if(et(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&ce(["select"],t),W("\u2318B",n)||W("\u2318I",n)||W("\u2318U",n)){n.preventDefault(),n.stopPropagation();return}}))},lS=(t,e,n)=>{const a=Y(),i=T(t.target,"protyle-attr--bookmark");if(i)return!a&&Wt(t)?Si(e.app,i.textContent.trim(),!0):n?fa(n,"bookmark",e):xi(i.parentElement.parentElement,"bookmark",e),t.stopPropagation(),!0;const s=T(t.target,"protyle-attr--name");if(s)return!a&&Wt(t)?Si(e.app,s.textContent.trim(),!0):n?fa(n,"name",e):xi(s.parentElement.parentElement,"name",e),t.stopPropagation(),!0;const l=T(t.target,"protyle-attr--av");if(l)return n?fa(n,"av",e):xi(l.parentElement.parentElement,"av",e),t.stopPropagation(),!0;const o=T(t.target,"protyle-attr--alias");if(o)return!a&&Wt(t)?Si(e.app,o.textContent.trim(),!0):n?fa(n,"alias",e):xi(o.parentElement.parentElement,"alias",e),t.stopPropagation(),!0;const r=T(t.target,"protyle-attr--memo");if(r)return!a&&Wt(t)?Si(e.app,r.getAttribute("aria-label").trim(),!0):n?fa(n,"memo",e):xi(r.parentElement.parentElement,"memo",e),t.stopPropagation(),!0},oS=t=>{!window.siyuan.menus.menu.element.contains(t)&&!j(t,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove())},V3=t=>{$E(),oS(t.target);const e=T(t.target,"protyle",!0);if(e){const i=e.querySelector(".protyle-wysiwyg");(i.getAttribute("data-readonly")==="true"||!i.contains(t.target))&&i.dispatchEvent(new Event("focusin"))}!He(t.target,"protyle-util")&&!He(t.target,"protyle-toolbar")&&document.querySelectorAll(".protyle-font").forEach(i=>{i.parentElement.classList.add("fn__none")});const n=He(t.target,"protyle-action__copy");if(n){let i=n.parentElement.nextElementSibling.textContent.replace(/\n$/,"");i=i.replace(/\u00A0/g," "),Be(i),de(window.siyuan.languages.copied,2e3),t.preventDefault();return}if(!ue()&&window.siyuan.layout.leftDock&&!T(t.target,"b3-dialog--open",!0)&&!T(t.target,"b3-menu")&&!T(t.target,"block__popover")&&!T(t.target,"dock")&&!T(t.target,"layout--float",!0)&&(window.siyuan.layout.bottomDock.hideDock(),window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock()),T(t.target,"pdf__outer")||_s(["pdfutil"]),j(t.target,"id","secondaryToolbarToggleButton")||j(t.target,"id","viewFindButton")||j(t.target,"id","findbar"))return;let a;Oe().asset.find(i=>{if(i.pdfObject&&!i.pdfObject.appConfig.appContainer.classList.contains("fn__none"))return a=i.pdfObject,!0}),a&&(a.secondaryToolbar.isOpen&&a.secondaryToolbar.close(),!a.supportsIntegratedFind&&a.findBar.opened&&a.findBar.close())};var uy=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class Y3{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),Y()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),!e.options.action.includes(p.CB_GET_HISTORY)&&(this.bindEvent(e),W3(e,this.element),R3(e,this.element))}renderCustom(e){let n=e[p.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(e);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(s)&&!a.includes(s)&&(this.element.removeAttribute(s),i--)}a.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)||this.element.setAttribute(i,e[i])})}escapeInline(e,n,a){if(!a.data&&a.inputType!=="insertLineBreak")return;const i=a.data;e.toolbar.range=n;const s=n.startContainer.parentElement,l=e.toolbar.getCurrentType();if(a.inputType==="insertLineBreak"){l.length>0&&n.toString()===""&&s.tagName==="SPAN"&&s.textContent.startsWith(`
`)&&n.startContainer.previousSibling&&n.startContainer.previousSibling.textContent===`
`&&s.before(n.startContainer.previousSibling);return}let o=i.length;if(i==="<"||i===">"?o=4:i==="&"&&(o=5),l.length>0&&n.toString()===""&&n.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(p.ZWSP,"")!==i&&s.textContent.replace(p.ZWSP,"").length>=i.length&&!pt(n.startContainer)&&!pt(s)){const r=s.innerHTML.replace(p.ZWSP,"");s.innerHTML=r.substr(o);const c=document.createTextNode(i);s.before(c),n.selectNodeContents(c),n.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!l.includes("search-mark")&&!l.includes("code")&&!l.includes("kbd")&&!l.includes("tag")&&n.toString()===""&&n.startContainer.nodeType===3&&(l.includes("inline-memo")||l.includes("block-ref")||l.includes("file-annotation-ref")||l.includes("a"))&&!Ge(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&s.textContent.length>i.length){const r=_t(s,e.wysiwyg.element,n),c=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=c.substr(0,c.length-o);const d=document.createTextNode(i);s.after(d),n.selectNodeContents(d),n.collapse(!1)}}}setEmptyOutline(e,n){let a=n;if(!n.getAttribute("data-node-id")){const i=B(n);if(!i)return;a=i}e.model&&Oe().outline.forEach(i=>{i.blockId===e.block.rootID&&i.setCurrent(a)})}emojiToMd(e){e.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(e){this.element.addEventListener("copy",n=>uy(this,null,function*(){var a;if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"||n.target.localName==="input"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const i=ke(e.wysiwyg.element),s=B(i.startContainer);if(!s)return;const l=s.querySelector(".img--select"),o=s.querySelector(".av__row--select, .av__cell--select"),r=((a=s.querySelector(".table__select"))==null?void 0:a.clientWidth)>0;let c=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&i.toString()===""&&!i.cloneContents().querySelector("img")&&!l&&!o&&!r&&(s.classList.add("protyle-wysiwyg--select"),Pn([s.getAttribute("data-node-id")]),c=[s]);let d="",u="",m=!1,f=!1;if(c.length>0){const g=c[0].getAttribute("data-reftext")==="true";c[0].getAttribute("data-type")==="NodeListItem"&&c[0].parentElement.classList.contains("list")&&c[0].parentElement.childElementCount-1===c.length&&(c.find(y=>{if(!c[0].parentElement.contains(y))return!0})||(c=[c[0].parentElement]));let h="";for(let b=0;b<c.length;b++){const y=c[b];if(g)d+=Sw(y)+`

`;else{let w="";y.getAttribute("data-type")==="NodeHeading"&&y.getAttribute("fold")==="1"?(f=!0,w=(yield Ae("/api/block/getHeadingChildrenDOM",{id:y.getAttribute("data-node-id"),removeFoldAttr:!1})).data):y.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&y.querySelector('[data-type="NodeHeading"][fold="1"]')?(f=!0,w=(yield Ae("/api/block/getBlockDOM",{id:y.getAttribute("data-node-id")})).data.dom):w=qf(y),y.getAttribute("data-type")==="NodeListItem"?(h||(h=`<div data-subtype="${y.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">`),h+=w,(b===c.length-1||c[b+1].getAttribute("data-type")!=="NodeListItem"||c[b+1].getAttribute("data-subtype")!==y.getAttribute("data-subtype"))&&(d+=`${h}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,h="")):d+=w}}g&&(d=d.slice(0,-2),c[0].removeAttribute("data-reftext"))}else if(o){const g=Array.from(s.querySelectorAll(".av__cell--active, .av__cell--select"))||[];g.length===0&&s.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(h=>{h.querySelectorAll(".av__cell").forEach(b=>{g.push(b)})}),g.length>0&&(d="[",g.forEach((h,b)=>{var y;const w=Bl(h);(b===0||g[b-1]!==h.previousElementSibling&&!((y=h.previousElementSibling)!=null&&y.classList.contains("av__colsticky")&&!g[b-1].nextElementSibling&&g[b-1].parentElement===h.previousElementSibling))&&(d+="["),d+=JSON.stringify(Ci(Zn(h),h))+",",b===g.length-1||g[b+1]!==h.nextElementSibling&&!(!h.nextElementSibling&&h.parentElement.nextElementSibling===g[b+1])?(d=d.substring(0,d.length-1)+"],",u+=w+`
`):u+=w+"	"}),u=u.substring(0,u.length-1),d=d.substring(0,d.length-1)+"]")}else if(r){const g=[],h=s.firstElementChild.scrollLeft,b=s.querySelector("table").scrollTop,y=s.querySelector(".table__select");d="<table>",s.querySelectorAll("th, td").forEach(w=>{!w.classList.contains("fn__none")&&vi({tableSelectElement:y,scrollLeft:h,scrollTop:b,item:w})&&g.push(w)}),g.forEach((w,E)=>{(E===0||!w.previousElementSibling||w.previousElementSibling!==g[E-1])&&(d+="<tr>"),d+=w.outerHTML,(!w.nextElementSibling||!g[E+1]||w.nextElementSibling!==g[E+1])&&(d+="</tr>")}),d+="</table>",u=e.lute.HTML2Md(d)}else{const g=document.createElement("div"),h=e.toolbar.getCurrentType(i),b=U(i.startContainer,"SPAN"),y=j(i.startContainer,"data-type","NodeHeading"),w=y&&y.textContent.replace(p.ZWSP,"")===i.toString();if(h.length>0&&b&&b.textContent.replace(p.ZWSP,"")===i.toString()||w)w?(g.append(y.cloneNode(!0)),y.removeAttribute("fold")):["DIV","TD","TH","TR"].includes(i.startContainer.parentElement.tagName)?(g.append(i.cloneContents()),this.emojiToMd(g)):(g.append(i.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(g)),d=g.innerHTML,u=i.toString();else if(l)d=l.outerHTML,u=l.querySelector("img").getAttribute("data-src");else if(h.length>0&&i.startContainer.nodeType===3&&i.startContainer.parentElement.tagName==="SPAN"&&i.startContainer.parentElement===i.endContainer.parentElement){const E=i.startContainer.parentElement.attributes,C=document.createElement("span");for(let $=0;$<E.length;$++)C.setAttribute(E[$].name,E[$].value);C.getAttribute("data-type").indexOf("block-ref")>-1&&C.getAttribute("data-subtype")==="d"&&C.setAttribute("data-subtype","s"),C.textContent=i.toString(),d=C.outerHTML,u=i.toString()}else{g.append(i.cloneContents()),this.emojiToMd(g);const E=j(i.commonAncestorContainer,"data-type","inline-math");E?d=E.outerHTML:d=g.innerHTML,u=g.textContent,j(i.startContainer,"data-type","NodeCodeBlock")?(Na(i)&&(u=u.replace(/\n$/,"")),m=!0):U(i.startContainer,"TD")||U(i.startContainer,"TH")?(g.innerHTML=g.innerHTML.replace(/<br>/g,`
`).replace(/<br\/>/g,`
`),u=g.textContent.endsWith(`
`)?g.textContent.replace(/\n$/,""):g.textContent):U(i.startContainer,"CODE")||(u=i.toString())}}if(e.disabled&&(d=OA(d)),u=u||e.lute.BlockDOM2StdMd(d).trimEnd(),u=u.replace(/\u00A0/g," ").replace(new RegExp(p.ZWSP,"g"),""),n.clipboardData.setData("text/plain",u),!m){Lc(e);const g=r?e.lute.HTML2BlockDOM(d):d;n.clipboardData.setData("text/siyuan",g),Fo(e);const h=`<!--data-siyuan='${zm(g)}'-->`+(r?d:e.lute.BlockDOM2HTML(o?u:d));if(n.clipboardData.setData("text/html",h),f)try{yield navigator.clipboard.write([new ClipboardItem({"text/plain":u,"text/html":h})])}catch(b){console.log("Copy write clipboard error:",b)}}})),this.element.addEventListener("mousedown",n=>{var a;if(e.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),n.button===2)return;const i=document;i.onmouseup=null;let s=n.target,l=B(s);const o=this.element.querySelector(".protyle-wysiwyg--select"),r=T(s,"av__gallery-item");if(n.shiftKey){let D,I=l;if(getSelection().rangeCount>0&&(D=B(getSelection().getRangeAt(0).startContainer)),!o&&r){r.classList.add("av__gallery-item--select");let q=r.previousElementSibling,Z=[];for(;q&&!q.classList.contains("av__gallery-item--select");)if(Z.push(q),q=q.previousElementSibling,!q){Z=[];break}q=r.nextElementSibling;let R=[];for(;q&&!q.classList.contains("av__gallery-item--select");)if(R.push(q),q=q.nextElementSibling,!q||q.classList.contains("av__gallery-add")){R=[];break}Z.concat(R).forEach(F=>{F.classList.add("av__gallery-item--select")}),n.preventDefault()}else if(D&&I&&D!==I){let q=!0;const Z=D.getBoundingClientRect(),R=I.getBoundingClientRect();let F=Z.top,K=R.top;if(F===K&&(F=Z.left,K=R.left),F>K){const me=I;I=D,D=me;const Pe=K;K=F,F=Pe,q=!1}let X=[],J=D,Me=!1;for(;J;)if(J&&!J.classList.contains("protyle-attr")){const me=J.getBoundingClientRect();if(Z.top===R.top?me.left<=K:me.top<=K)if(Me)if(J.nextElementSibling&&!J.nextElementSibling.classList.contains("protyle-attr")){const Pe=J.nextElementSibling.getBoundingClientRect();if(Z.top===R.top?Pe.left<=K&&Pe.bottom<=R.bottom:Pe.top<=K)X=[J],J=J.nextElementSibling,Me=!1;else if(J.parentElement.classList.contains("sb"))J=B(J.parentElement),Me=!0;else break}else J=B(J.parentElement),Me=!0;else X.push(J),J=J.nextElementSibling;else if(J.parentElement.classList.contains("sb"))J=B(J.parentElement),Me=!0;else break}else J=B(J.parentElement),Me=!0;if(!(X.length===1&&!X[0].classList.contains("list")&&!X[0].classList.contains("bq")&&!X[0].classList.contains("sb"))){const me=[];!o&&e.scroll&&!e.scroll.element.classList.contains("fn__none")&&!e.scroll.keepLazyLoad&&(D.getBoundingClientRect().top<-e.contentElement.clientHeight*2||I.getBoundingClientRect().bottom>e.contentElement.clientHeight*2)&&de(window.siyuan.languages.crossKeepLazyLoad),X.forEach(Pe=>{T(J,"protyle-wysiwyg--select")||(Pe.classList.add("protyle-wysiwyg--select"),me.push(Pe.getAttribute("data-node-id")),Pe.querySelectorAll(".protyle-wysiwyg--select").forEach(Je=>{Je.classList.remove("protyle-wysiwyg--select")}))}),Pn(me),oe(q?X[X.length-1]:X[0],e.wysiwyg.element,!1)}n.preventDefault()}return}if(Wt(n)&&!n.shiftKey&&!n.altKey){let D=l;if(!o&&r)r.classList.toggle("av__gallery-item--select");else if(D){const I=G(D);I&&(D=I),D=Et(D),D.classList.contains("protyle-wysiwyg--select")?(D.classList.remove("protyle-wysiwyg--select"),D.removeAttribute("select-start"),D.removeAttribute("select-end")):D.classList.add("protyle-wysiwyg--select"),D.querySelectorAll(".protyle-wysiwyg--select").forEach(R=>{R.classList.remove("protyle-wysiwyg--select"),R.removeAttribute("select-start"),R.removeAttribute("select-end")});const q=T(D.parentElement,"protyle-wysiwyg--select");q&&(q.classList.remove("protyle-wysiwyg--select"),q.removeAttribute("select-start"),q.removeAttribute("select-end"));const Z=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(R=>{Z.push(R.getAttribute("data-node-id"))}),Pn(Z)}return}if(r&&!j(s,"data-type","av-gallery-more")){i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,an(["galleryItem"],e.wysiwyg.element),!1);return}const c=T(s,"av__drag-fill");if(ce(["select"],e),j(s,"data-type","av-gallery-more")?an(["img","row","cell"],e.wysiwyg.element):!T(s,"av__firstcol")&&!c&&an(["img","av"],e.wysiwyg.element),T(s,"protyle-action")&&!T(s,"code-block")||T(s,"av__cell--header")&&!T(s,"av__widthdrag"))return;const d=e.wysiwyg.element.getBoundingClientRect(),u=window.getComputedStyle(e.wysiwyg.element),m=d.left+(parseInt(u.paddingLeft)||24)+1,f=d.right-(parseInt(u.paddingRight)||16)-2,g=e.element.getBoundingClientRect(),h=g.bottom,b=n.clientY,y=e.contentElement.getBoundingClientRect();if(!e.disabled&&s.classList.contains("av__widthdrag")){if(!l)return;const D=l.getAttribute("data-av-id"),I=l.dataset.nodeId,q=s.parentElement,Z=q.clientWidth,R=q.getAttribute("data-col-id");let F;const K=l.querySelector(".av__scroll");i.onmousemove=X=>{F=Math.max(Z+(X.clientX-n.clientX),25),K.querySelectorAll(".av__row, .av__row--footer").forEach(J=>{J.querySelector(`[data-col-id="${R}"]`).style.width=F+"px"}),ks(l,y,"bottom")},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!F||F===Z)return;const X=l.getAttribute(p.CUSTOM_SY_AV_VIEW);V(e,[{action:"setAttrViewColWidth",id:R,avID:D,data:F+"px",blockID:I,viewID:X}],[{action:"setAttrViewColWidth",id:R,avID:D,data:Z+"px",blockID:I,viewID:X}])},this.preventClick=!0,n.preventDefault();return}if(!e.disabled&&c){if(!l)return;const D={};let I;const q=[];l.querySelectorAll(".av__cell--active").forEach(X=>{const J=T(X,"av__row");J&&(D[J.dataset.id]||(D[J.dataset.id]=[]),D[J.dataset.id].push(Ci(Zn(X),X)),I=X,q.push(X.dataset.id))});const Z=Kc(I),R=Kc(l.querySelector(".av__cell--active"));let F,K;return i.onmousemove=X=>{const J=T(X.target,"av__cell");if(!(F&&J&&J===F)&&(F=J,F&&F.dataset.id)){const Me=Kc(F);if(l.querySelectorAll(".av__cell--active").forEach(me=>{q.includes(me.dataset.id)||me.classList.remove("av__cell--active")}),Me.celIndex!==Z.celIndex){K=void 0;return}l.querySelectorAll(".av__row").forEach((me,Pe)=>{(Me.rowIndex<R.rowIndex&&Pe>=Me.rowIndex&&Pe<R.rowIndex||Me.rowIndex>Z.rowIndex&&Pe<=Me.rowIndex&&Pe>Z.rowIndex)&&me.querySelectorAll(".av__cell").forEach((Je,ze)=>{ze>=R.celIndex&&ze<=Me.celIndex&&(Je.classList.add("av__cell--active"),K=Je)})})}},i.onmouseup=()=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,K){N0(e,l,D,q,I);const X=l.querySelectorAll(".av__cell--active");pa(X[X.length-1])}return!1},this.preventClick=!0,!1}const w=T(s,"av__cell");if(!e.disabled&&w&&w.dataset.id&&!G(w)){if(!l||l.dataset.avType!=="table")return;l.querySelectorAll(".av__cell--select").forEach(K=>{K.classList.remove("av__cell--select")}),l.querySelectorAll(".av__drag-fill").forEach(K=>{K.remove()}),w.classList.add("av__cell--select");const D=Kc(w);let I,q;const Z=l.getBoundingClientRect(),R=l.querySelector(".av__scroll"),F=T(w,"av__body");return i.onmousemove=K=>{const X=T(K.target,"av__cell");if(R.scrollWidth>R.clientWidth+2&&(K.clientX>Z.right-10?R.scrollLeft+=10:K.clientX<Z.left+34&&(R.scrollLeft-=10),K.clientY<y.top+48?e.contentElement.scrollTop-=5:K.clientY>y.bottom-48&&(e.contentElement.scrollTop+=5)),!(F!==T(X,"av__body")||I&&X&&X===I)&&X&&X.dataset.id&&(n.clientX!==K.clientX||n.clientY!==K.clientY)){const J=Kc(X);l.querySelectorAll(".av__cell--active").forEach(Me=>{Me.classList.remove("av__cell--active")}),F.querySelectorAll(".av__row").forEach((Me,me)=>{me>=Math.min(D.rowIndex,J.rowIndex)&&me<=Math.max(D.rowIndex,J.rowIndex)&&Me.querySelectorAll(".av__cell").forEach((Pe,Je)=>{Je>=Math.min(D.celIndex,J.celIndex)&&Je<=Math.max(D.celIndex,J.celIndex)&&(Pe.classList.add("av__cell--active"),q=Pe)})}),I=X}},i.onmouseup=()=>(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,q&&(ti(l.querySelector(".av__firstcol"),"unselectAll"),oe(l),pa(q),this.preventClick=!0),!1),!1}if(!e.disabled&&s.classList.contains("protyle-action__drag")){if(!l)return;let D=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(l.getAttribute("data-type"))?(l.classList.add("iframe--drag"),(l.style.textAlign==="left"||l.style.textAlign==="right")&&(D=!1)):s.parentElement.parentElement.getAttribute("data-type")==="img"&&s.parentElement.parentElement.classList.add("img--drag");const I=l.getAttribute("data-node-id"),q=l.outerHTML,Z=n.clientX,R=s.previousElementSibling,F=R.clientWidth,K=R.clientHeight,X=R.parentElement.parentElement;R.tagName==="IMG"&&$l(X),i.onmousemove=J=>{if(R.tagName==="IMG"&&(R.style.height=""),J.clientX>Z-F+8&&J.clientX<f){const Me=R.tagName==="IMG"&&!X.style.minWidth&&l.style.textAlign!=="center"||!D?1:2;R.tagName==="IMG"?R.parentElement.style.width=Math.max(17,F+(J.clientX-Z)*Me)+"px":R.style.width=Math.max(17,F+(J.clientX-Z)*Me)+"px"}R.tagName!=="IMG"&&J.clientY>b-K+8&&J.clientY<h&&(R.style.height=K+(J.clientY-b)+"px")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,s.classList.contains("protyle-action__drag")&&l&&le(e,I,l.outerHTML,q),l.classList.remove("iframe--drag"),s.parentElement.parentElement.classList.remove("img--drag")};return}let E;const C=U(s,"TH")||U(s,"TD");if(C&&(s=C),(s.tagName==="TH"||s.tagName==="TD"||((a=s.firstElementChild)==null?void 0:a.tagName)==="TABLE"||s.classList.contains("table__resize")||s.classList.contains("table__select"))&&(E=l,E&&(E.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),ce(["toolbar"],e),s.classList.contains("table__select")&&(s=document.elementFromPoint(n.clientX,n.clientY),l=B(s)),n.stopPropagation())),!e.disabled&&s.classList.contains("table__resize")){if(!l)return;const D=l.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),l.firstElementChild.style.webkitUserModify="read-only",l.style.cursor="col-resize",s.removeAttribute("style");const I=l.getAttribute("data-node-id"),q=n.clientX,Z=parseInt(s.getAttribute("data-col-index")),R=l.querySelectorAll("table col")[Z];R.style.minWidth&&(R.style.width=l.querySelectorAll("table td, table th")[Z].offsetWidth+"px",R.style.minWidth=""),l.querySelectorAll("tr").forEach(X=>{X.cells[Z].style.width=""});const F=R.clientWidth,K=l.firstElementChild.clientWidth<l.firstElementChild.scrollWidth;i.onmousemove=X=>{l.style.textAlign==="center"&&!K?R.style.width=F+(X.clientX-q)*2+"px":R.style.width=F+(X.clientX-q)+"px"},i.onmouseup=()=>{l.firstElementChild.style.webkitUserModify="",l.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,l&&le(e,I,l.outerHTML,D)};return}let $=n.clientX;n.clientX>f?$=f:n.clientX<m&&($=m);const M=g.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let k,_,v,S;this.element.querySelectorAll("iframe").forEach(D=>{D.style.pointerEvents="none"});const L=["IMG","VIDEO","AUDIO"].includes(s.tagName)||s.classList.contains("img");i.onmousemove=D=>{let I=D.target;if(E&&E.contains(I)&&!T(E,"protyle-wysiwyg__embed")){if(I.classList.contains("table__select")){I.classList.add("fn__none");const ze=document.elementFromPoint(D.clientX,D.clientY);I.classList.remove("fn__none"),I=U(ze,"TH")||U(ze,"TD")}if(I&&I===s)return E.querySelector(".table__select").removeAttribute("style"),e.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),_=I,!1;if(I&&(I.tagName==="TH"||I.tagName==="TD")&&(!_||_!==I)){E.firstElementChild.style.webkitUserModify="read-only";let ze=s.offsetLeft+s.clientWidth-I.offsetLeft,wt=I.offsetLeft;s.offsetLeft===I.offsetLeft?ze=Math.max(s.clientWidth,I.clientWidth):s.offsetLeft<I.offsetLeft&&(ze=I.offsetLeft+I.clientWidth-s.offsetLeft,wt=s.offsetLeft);let $a=s.offsetTop+s.clientHeight-I.offsetTop,Vn=I.offsetTop;s.offsetTop===I.offsetTop?$a=Math.max(s.clientHeight,I.clientHeight):s.offsetTop<I.offsetTop&&($a=I.offsetTop+I.clientHeight-s.offsetTop,Vn=s.offsetTop),Array.from(E.querySelectorAll("th, td")).find(Xe=>{const Yn=Xe.offsetLeft<wt+ze&&Xe.offsetLeft+Xe.clientWidth>wt+ze,gl=Xe.offsetLeft<wt&&Xe.offsetLeft+Xe.clientWidth>wt;Xe.offsetTop<Vn&&Xe.offsetTop+Xe.clientHeight>Vn?((Xe.offsetLeft+6>wt&&Xe.offsetLeft+Xe.clientWidth-6<wt+ze||Yn||gl)&&($a=Vn+$a-Xe.offsetTop,Vn=Xe.offsetTop),Yn&&(ze=Xe.offsetLeft+Xe.clientWidth-wt),gl&&(ze=wt+ze-Xe.offsetLeft,wt=Xe.offsetLeft)):Xe.offsetTop<Vn+$a&&Xe.offsetTop+Xe.clientHeight>Vn+$a?((Xe.offsetLeft+6>wt&&Xe.offsetLeft+Xe.clientWidth-6<wt+ze||Yn||gl)&&($a=Xe.clientHeight+Xe.offsetTop-Vn),Yn&&(ze=Xe.offsetLeft+Xe.clientWidth-wt),gl&&(ze=wt+ze-Xe.offsetLeft,wt=Xe.offsetLeft)):gl&&Xe.offsetTop+6>Vn&&Xe.offsetTop+Xe.clientHeight-6<Vn+$a?(ze=wt+ze-Xe.offsetLeft,wt=Xe.offsetLeft):Yn&&Xe.offsetTop+6>Vn&&Xe.offsetTop+Xe.clientHeight-6<Vn+$a&&(ze=Xe.offsetLeft+Xe.clientWidth-wt)}),e.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),E.querySelector(".table__select").setAttribute("style",`left:${wt-E.firstElementChild.scrollLeft}px;top:${Vn-E.querySelector("table").scrollTop}px;height:${$a}px;width:${ze+1}px;`),_=I}return}L&&(D.clientY<y.top+p.SIZE_SCROLL_TB||D.clientY>y.bottom-p.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(D.clientY<y.top+p.SIZE_SCROLL_TB?-p.SIZE_SCROLL_STEP:p.SIZE_SCROLL_STEP),behavior:"smooth"}),e.selectElement.classList.remove("fn__none"),ce(["gutter"],e);let q=0,Z=0,R=0,F=0;if(D.clientX<$?(D.clientX<m?Z=m:Z=D.clientX,R=$-Z):D.clientX>f?(Z=$,R=f-Z):(Z=$,R=D.clientX-$),D.clientY>b?D.clientY>h?(q=b,F=h-b):(q=b,F=D.clientY-b):(D.clientY<M?q=M:q=D.clientY,F=b-q),F<4)return;e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${q}px;height:${F}px;left:${Z+2}px;width:${R-2}px;`);const K=document.elementFromPoint(D.clientX,D.clientY);if(k&&k===K&&!k.classList.contains("protyle-wysiwyg")&&!k.classList.contains("list")&&!k.classList.contains("bq")&&!k.classList.contains("sb"))return;k=K,ce(["select"],e);let X;if(D.clientY>b?(X=v||document.elementFromPoint(Z,q),S=void 0):(X=document.elementFromPoint(Z,q),v=void 0),!X||((X.classList.contains("protyle-wysiwyg")||X.classList.contains("list")||X.classList.contains("li")||X.classList.contains("sb")||X.classList.contains("bq"))&&(X=document.elementFromPoint(Z,q+16)),!X))return;let J=B(X);!J&&X.classList.contains("protyle-breadcrumb__bar")&&(J=X.nextElementSibling),D.clientY>b?v||(J||(J=e.wysiwyg.element.firstElementChild,J.classList.contains("protyle-breadcrumb__bar")&&(J=J.nextElementSibling)),v=J):!J&&D.clientY<e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(J=e.wysiwyg.element.firstElementChild,J.classList.contains("protyle-breadcrumb__bar")&&(J=J.nextElementSibling));let Me=[],me=J;if(me){const ze=G(me);ze&&(me=ze)}let Pe=!1;const Je=S?S.getBoundingClientRect().bottom:q+F;for(;me;)if(me&&!me.classList.contains("protyle-attr")){const ze=me.getBoundingClientRect();if(ze.height>0&&ze.top<Je&&ze.left<Z+R)if(Pe)if(me.nextElementSibling&&!me.nextElementSibling.classList.contains("protyle-attr")){const wt=me.nextElementSibling.getBoundingClientRect();if(wt.top<Je&&wt.left<Z+R)Me=[me],me=me.nextElementSibling,Pe=!1;else if(me.parentElement.classList.contains("sb"))me=B(me.parentElement),Pe=!0;else break}else me=B(me.parentElement),Pe=!0;else!me.classList.contains("protyle-breadcrumb__bar")&&!me.classList.contains("protyle-breadcrumb__item")&&Me.push(me),me=me.nextElementSibling;else if(me.parentElement.classList.contains("sb"))me=B(me.parentElement),Pe=!0;else if(ze.height===0&&ze.width===0&&me.parentElement.getAttribute("fold")==="1")me=me.parentElement,Me=[];else break}else me=B(me.parentElement),Pe=!0;D.clientY<=b&&!S&&(S=Me[Me.length-1]),Me.length===1&&!Me[0].classList.contains("list")&&!Me[0].classList.contains("bq")&&!Me[0].classList.contains("sb")?(e.selectElement.style.backgroundColor="transparent",e.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange")):(e.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),Me.forEach(ze=>{T(ze,"protyle-wysiwyg__embed")||ze.classList.add("protyle-wysiwyg--select")}),e.selectElement.style.backgroundColor="")},i.onmouseup=D=>{var I;if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,v=void 0,S=void 0,e.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),this.element.querySelectorAll("iframe").forEach(R=>{R.style.pointerEvents=""}),e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),E){E.firstElementChild.style.webkitUserModify="";const R=E.querySelector(".table__select");if(R.getAttribute("style")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),e.disabled||(window.siyuan.menus.menu.append(new N({id:"mergeCell",label:window.siyuan.languages.mergeCell,click:()=>{if(E){const F=[],K=[],X=E.querySelectorAll("th").length;let J=0;const Me=E.firstElementChild.scrollLeft,me=E.querySelector("table").scrollTop;let Pe=!1,Je=!1;E.querySelectorAll("th, td").forEach((qt,Ui)=>{qt.classList.contains("fn__none")?(qt.previousElementSibling&&qt.previousElementSibling===F[F.length-1]||Ui<J&&K.includes((Ui+1)%X))&&(F.push(qt),!Pe&&qt.parentElement.parentElement.tagName==="THEAD"?Pe=!0:!Je&&qt.parentElement.parentElement.tagName==="TBODY"&&(Je=!0)):vi({tableSelectElement:R,scrollLeft:Me,scrollTop:me,item:qt})&&(F.push(qt),!Pe&&qt.parentElement.parentElement.tagName==="THEAD"?Pe=!0:!Je&&qt.parentElement.parentElement.tagName==="TBODY"&&(Je=!0),K.push((Ui+1)%X),J=Math.max((qt.rowSpan-1)*X+Ui+1,J))}),R.removeAttribute("style");const ze=E.outerHTML;let wt=F[0],$a=wt.colSpan,Vn=1;for(;wt.nextElementSibling&&wt.nextElementSibling===F[Vn];)wt=wt.nextElementSibling,wt.classList.contains("fn__none")||($a+=wt.colSpan),Vn++;let Xe="",Yn=F[0].parentElement,gl=F[0].rowSpan;if(F.forEach((qt,Ui)=>{let hs=qt.innerHTML.trim();hs.endsWith("<br>")&&(hs=hs.substr(0,hs.length-4)),Xe+=hs+(!hs||Ui===F.length-1?"":"<br>"),Ui!==0&&(Yn!==qt.parentElement&&(qt.classList.contains("fn__none")||(gl+=qt.rowSpan),Yn=qt.parentElement,F[0].parentElement.parentElement.tagName==="THEAD"&&qt.parentElement.parentElement.tagName!=="THEAD"&&F[0].parentElement.parentElement.insertAdjacentElement("beforeend",qt.parentElement)),qt.classList.add("fn__none"),qt.innerHTML="")}),Pe&&Je)for(Yn=Yn.parentElement.nextElementSibling.firstElementChild;Yn&&Yn.parentElement.tagName!=="THEAD";){let qt=0,Ui=0;if(Array.from(Yn.children).forEach(hs=>{qt+=hs.colSpan-1,hs.classList.contains("fn__none")&&Ui++}),qt!==Ui)F[0].parentElement.parentElement.insertAdjacentElement("beforeend",Yn),Yn=Yn.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{E&&(F[0].innerHTML=Xe+"<wbr>",F[0].colSpan=$a,F[0].rowSpan=gl,we(F[0],document.createRange()),le(e,E.getAttribute("data-node-id"),E.outerHTML,ze))})}}}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(E){const F=[],K=E.firstElementChild.scrollLeft,X=E.querySelector("table").scrollTop;E.querySelectorAll("th, td").forEach(J=>{!J.classList.contains("fn__none")&&vi({tableSelectElement:R,scrollLeft:K,scrollTop:X,item:J})&&(F.length===0||F.length>0&&J.offsetTop===F[0].offsetTop)&&F.push(J)}),R.removeAttribute("style"),ei(e,F,E,"left",ke(E))}}}).element),window.siyuan.menus.menu.append(new N({id:"alignCenter",icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(E){const F=[],K=E.firstElementChild.scrollLeft,X=E.querySelector("table").scrollTop;E.querySelectorAll("th, td").forEach(J=>{!J.classList.contains("fn__none")&&vi({tableSelectElement:R,scrollLeft:K,scrollTop:X,item:J})&&(F.length===0||F.length>0&&J.offsetTop===F[0].offsetTop)&&F.push(J)}),R.removeAttribute("style"),ei(e,F,E,"center",ke(E))}}}).element),window.siyuan.menus.menu.append(new N({id:"alignRight",icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(E){const F=[],K=E.firstElementChild.scrollLeft,X=E.querySelector("table").scrollTop;E.querySelectorAll("th, td").forEach(J=>{!J.classList.contains("fn__none")&&vi({tableSelectElement:R,scrollLeft:K,scrollTop:X,item:J})&&(F.length===0||F.length>0&&J.offsetTop===F[0].offsetTop)&&F.push(J)}),R.removeAttribute("style"),ei(e,F,E,"right",ke(E))}}}).element),window.siyuan.menus.menu.append(new N({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(E){const F=[],K=E.firstElementChild.scrollLeft,X=E.querySelector("table").scrollTop;E.querySelectorAll("th, td").forEach(J=>{!J.classList.contains("fn__none")&&vi({tableSelectElement:R,scrollLeft:K,scrollTop:X,item:J})&&(F.length===0||F.length>0&&J.offsetTop===F[0].offsetTop)&&F.push(J)}),R.removeAttribute("style"),ei(e,F,E,"",ke(E))}}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element)),window.siyuan.menus.menu.append(new N({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,click(){if(E){const F=[],K=E.firstElementChild.scrollLeft,X=E.querySelector("table").scrollTop,J=E.querySelector(".table__select");E.querySelectorAll("th, td").forEach(me=>{!me.classList.contains("fn__none")&&vi({tableSelectElement:J,scrollLeft:K,scrollTop:X,item:me})&&F.push(me)});let Me="";F.forEach((me,Pe)=>{Me+=me.textContent.trim()+"	",(!me.nextElementSibling||!F[Pe+1]||me.nextElementSibling!==F[Pe+1])&&(Me=Me.slice(0,-1)+`
`)}),Yi(Me.slice(0,-1)),oe(E)}}}).element),window.siyuan.menus.menu.append(new N({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){E&&(ne(ke(E)),document.execCommand("copy"))}}).element),!e.disabled){let F;window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){E&&(ne(ke(E)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new N({id:"clear",label:window.siyuan.languages.clear,icon:"iconTrashcan",accelerator:"\u2326",click(){kw(e,E)}}).element),window.siyuan.menus.menu.append(new N({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return uy(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else if(E)try{const K=yield hc();Uo(e,Object.assign(K,{target:E}))}catch(K){console.log(K)}})}}).element)}window.siyuan.menus.menu.popup({x:D.clientX-8,y:D.clientY-16})}}const q=[],Z=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(Z.forEach(R=>{q.push(R.getAttribute("data-node-id"))}),Pn(q),getSelection().rangeCount>0){const R=getSelection().getRangeAt(0);if((R.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let X=B(R.startContainer);if(X){if((I=X.nextElementSibling)!=null&&I.classList.contains("table"))Yt(fe(X),R,!1);else if(X.classList.contains("table")){const J=X.querySelectorAll("th, td");X=J[J.length-1],X.contains(R.startContainer)&&Yt(X,R,!1)}}return}if(Z.length>0){R.collapse(!0),R.commonAncestorContainer.nodeType===1&&R.startContainer.childNodes[R.startOffset]&&R.startContainer.childNodes[R.startOffset].nodeType===1&&R.commonAncestorContainer.classList.contains("protyle-wysiwyg")&&oe(R.startContainer.childNodes[R.startOffset]);return}const F=B(R.startContainer);let K;if(D.detail>2&&R.endContainer.nodeType!==3&&["DIV","TD","TH"].includes(R.endContainer.tagName)&&R.endOffset===0){if(R.endContainer.classList.contains("protyle-attr")&&F)Yt(fe(F),R,!1);else if(["TD","TH"].includes(R.endContainer.tagName)){const X=U(R.startContainer,"TH")||U(R.startContainer,"TD");X&&Yt(X,R,!1)}}else K=B(R.endContainer);F&&K&&K!==F&&(R.startContainer.nodeType===1&&R.startContainer.tagName==="DIV"&&R.startContainer.classList.contains("protyle-attr")||n.clientY>D.clientY?Yl(fe(K),R):R.endOffset===0&&R.endContainer.nodeType===1&&R.endContainer.tagName==="DIV"?Yt(fe(F),R,!1):R.collapse(!0))}}})}bindEvent(e){e.observer=new ResizeObserver(()=>{const o=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(r=>{r.querySelector(".av__scroll")&&ks(r,o,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const o=getSelection().getRangeAt(0);(this.element===o.startContainer||this.element.contains(o.startContainer))&&(e.toolbar.range=o.cloneRange())}),this.element.addEventListener("cut",o=>uy(this,null,function*(){var r,c,d;if(window.siyuan.ctrlIsPressed=!1,e.disabled)return;if(o.target.tagName==="PROTYLE-HTML"||o.target.localName==="input"){o.stopPropagation();return}e.options.render.breadcrumb&&e.breadcrumb.hide();const u=ke(e.wysiwyg.element);let m=B(u.startContainer);if(!m){o.stopPropagation(),o.preventDefault();return}const f=G(m);f&&(m=f),o.stopPropagation(),o.preventDefault();const g=m.querySelector(".img--select"),h=m.querySelector(".av__row--select, .av__cell--select"),b=((r=m.querySelector(".table__select"))==null?void 0:r.clientWidth)>0;let y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&u.toString()===""&&!u.cloneContents().querySelector("img")&&!g&&!h&&!b&&(m.classList.add("protyle-wysiwyg--select"),y=[m]);let w="",E="",C=!1,$=!1;if(y.length>0){y[0].getAttribute("data-type")==="NodeListItem"&&y[0].parentElement.classList.contains("list")&&y[0].parentElement.childElementCount-1===y.length&&(y.find(v=>{if(!y[0].parentElement.contains(v))return!0})||(y=[y[0].parentElement]));let M="";for(let _=0;_<y.length;_++){const v=Et(y[_]);let S="";v.getAttribute("data-type")==="NodeHeading"&&v.getAttribute("fold")==="1"?($=!0,S=(yield Ae("/api/block/getHeadingChildrenDOM",{id:v.getAttribute("data-node-id"),removeFoldAttr:!1})).data):v.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&v.querySelector('[data-type="NodeHeading"][fold="1"]')?($=!0,S=(yield Ae("/api/block/getBlockDOM",{id:v.getAttribute("data-node-id")})).data.dom):S=qf(v),v.getAttribute("data-type")==="NodeListItem"?(M||(M=`<div data-subtype="${v.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">`),M+=S,(_===y.length-1||y[_+1].getAttribute("data-type")!=="NodeListItem"||y[_+1].getAttribute("data-subtype")!==v.getAttribute("data-subtype"))&&(w+=`${M}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,M="")):w+=S}const k=mt(y[y.length-1]);Ea(e,m,u,"remove"),k&&oe(k)}else if(h){$=!0;const M=yield Bn(e,m);w=JSON.stringify(M.json),E=M.text}else if(b){const M=[],k=m.firstElementChild.scrollLeft,_=m.querySelector("table").scrollTop,v=m.querySelector(".table__select");if(w="<table>",m.querySelectorAll("th, td").forEach(L=>{!L.classList.contains("fn__none")&&vi({tableSelectElement:v,scrollLeft:k,scrollTop:_,item:L})&&M.push(L)}),v.removeAttribute("style"),getSelection().rangeCount>0){const L=getSelection().getRangeAt(0);m.contains(L.startContainer)&&L.insertNode(document.createElement("wbr"))}const S=m.outerHTML;(c=m.querySelector("wbr"))==null||c.remove(),m.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),M.forEach((L,D)=>{(D===0||!L.previousElementSibling||L.previousElementSibling!==M[D-1])&&(w+="<tr>"),w+=L.outerHTML,(!L.nextElementSibling||!M[D+1]||L.nextElementSibling!==M[D+1])&&(w+="</tr>"),L.innerHTML=""}),w+="</table>",E=e.lute.HTML2Md(w),le(e,m.getAttribute("data-node-id"),m.outerHTML,S)}else{const M=m.getAttribute("data-node-id");hd(m,u,e);const k=e.wysiwyg.lastHTMLs[M]||m.outerHTML,_=document.createElement("div");let v=u.startContainer;if(v.nodeType===3&&v.textContent===""){const L=Ge(u.startContainer);L&&(v=L)}const S=j(v,"data-type","NodeHeading");if(S&&u.toString()===S.firstElementChild.textContent)_.insertAdjacentHTML("afterbegin",S.firstElementChild.innerHTML),S.firstElementChild.innerHTML="";else if(u.toString()!==""&&v===u.endContainer&&u.startContainer.nodeType===3&&u.endOffset===u.endContainer.wholeText.length&&u.startOffset===0&&!["DIV","TD","TH","TR"].includes(u.startContainer.parentElement.tagName))_.append(u.startContainer.parentElement);else if(g)_.append(g);else if(u.startContainer.nodeType===3&&u.startContainer.parentElement.tagName==="SPAN"&&u.startContainer.parentElement.getAttribute("data-type")&&u.startContainer.parentElement===u.endContainer.parentElement){const L=u.startContainer.parentElement,D=L.attributes,I=document.createElement("span");for(let q=0;q<D.length;q++)I.setAttribute(D[q].name,D[q].value);L.getAttribute("data-type").indexOf("block-ref")>-1&&L.getAttribute("data-subtype")==="d"&&(I.setAttribute("data-subtype","s"),L.setAttribute("data-subtype","s")),I.textContent=u.toString(),u.deleteContents(),_.append(I)}else if(u.cloneContents().querySelectorAll("td, th").length>0){const L=document.createElement("wbr");u.insertNode(L),u.setStartAfter(L),_.append(u.extractContents()),m.outerHTML=e.lute.SpinBlockDOM(m.outerHTML),m=e.wysiwyg.element.querySelector(`[data-node-id="${M}"]`),Nn(m),we(m,u)}else{const L=j(u.commonAncestorContainer,"data-type","inline-math");if(L)_.append(L);else{_.append(u.extractContents());let D;m.classList.contains("av")?Qh(e,m):m.classList.contains("table")?D=U(u.startContainer,"TD")||U(u.startContainer,"TH"):D=fe(m),D&&Array.from(D.children).forEach(I=>{I.textContent===""&&I.nodeType===1&&!["BR","IMG"].includes(I.tagName)&&I.remove()})}}if(this.emojiToMd(_),w=_.innerHTML,(j(u.startContainer,"data-type","NodeCodeBlock")||U(u.startContainer,"CODE"))&&(E=_.textContent.replace(p.ZWSP,""),C=!0),!m.classList.contains("table")){const L=fe(m);L&&L.textContent===""&&(L.innerHTML="")}m.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),m.getAttribute("data-type")==="NodeCodeBlock"&&(u.insertNode(document.createElement("wbr")),(d=m.querySelector('[data-render="true"]'))==null||d.removeAttribute("data-render"),rt(m)),m.parentElement.parentElement&&!m.classList.contains("av")&&(hd(m,u,e),le(e,M,e.wysiwyg.lastHTMLs[M]||m.outerHTML,k))}if(e.hint.render(e),h||(E=E||e.lute.BlockDOM2StdMd(w).trimEnd(),m.classList.contains("table")&&(E=E.replace(/<br>/g,`
`).replace(/<br\/>/g,`
`),E=E.endsWith(`
`)?E.replace(/\n$/,""):E)),E=E.replace(/\u00A0/g," "),o.clipboardData.setData("text/plain",E),!C){Lc(e);const M=b?e.lute.HTML2BlockDOM(w):w;Fo(e),o.clipboardData.setData("text/siyuan",M);const k=`<!--data-siyuan='${zm(M)}'-->`+(b?w:e.lute.BlockDOM2HTML(h?E:w));if(o.clipboardData.setData("text/html",k),$)try{yield navigator.clipboard.write([new ClipboardItem({"text/plain":E,"text/html":k})])}catch(_){console.log("Cut write clipboard error:",_)}}}));let n;this.element.addEventListener("contextmenu",o=>{var r,c,d,u,m;if(o.shiftKey)return;o.stopPropagation(),o.preventDefault();const f=o.clientX||o.detail.x,g=o.clientY||o.detail.y,h=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(h.length>1){ce(["util"],e),e.gutter.renderMenu(e,h[0]),window.siyuan.menus.menu.popup({x:f,y:g});return}const b=o.detail.target||o.target,y=G(b);if(y)return getSelection().rangeCount===0&&oy(y),e.gutter.renderMenu(e,y),window.siyuan.menus.menu.popup({x:f,y:g}),!1;const w=B(b);if(!w)return!1;const E=T(b,"av__gallery-item");if(E)return jv({target:E.querySelector(".protyle-icon--last"),protyle:e,position:{x:o.clientX,y:o.clientY}}),o.stopPropagation(),o.preventDefault(),!1;const C=T(b,"av__cell");if(C){if(C.classList.contains("av__cell--header")){e.disabled||fE(e,w,C),o.stopPropagation(),o.preventDefault();return}if(Zn(C)==="mAsset"){const _=T(b,"av__cellassetimg")||T(b,"av__celltext--url");if(_){let v=0;Array.from(C.children).find((S,L)=>{if(S===_)return v=L,!0}),Sp({protyle:e,cellElements:[C],blockElement:B(_),content:b.tagName==="IMG"?b.getAttribute("src"):b.getAttribute("data-url"),type:b.tagName==="IMG"?"image":"file",name:b.tagName==="IMG"?"":b.getAttribute("data-name"),index:v,rect:b.getBoundingClientRect()}),o.stopPropagation(),o.preventDefault();return}}}const $=T(b,"av__row");if($&&Yc(e,$,{x:o.clientX,y:$.getBoundingClientRect().bottom,h:$.clientHeight})){o.stopPropagation(),o.preventDefault();return}const M=T(b,"item");if(w.classList.contains("av")&&M){M.classList.contains("item--focus")?Mc({protyle:e,blockElement:w,element:M}):(V(e,[{action:"setAttrViewBlockView",blockID:w.getAttribute("data-node-id"),id:M.dataset.id,avID:w.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:w.getAttribute("data-node-id"),id:M.parentElement.querySelector(".item--focus").getAttribute("data-id"),avID:w.getAttribute("data-av-id")}]),window.siyuan.menus.menu.remove(),Mc({protyle:e,blockElement:w,element:M})),o.stopPropagation(),o.preventDefault();return}if(e.toolbar.range=ke(e.element),b.tagName==="SPAN"&&!An(w)){let _=((r=b.getAttribute("data-type"))==null?void 0:r.split(" "))||[];if(_.length===0&&(_=(b.dataset.type||"").split(" ")),_.length>0&&kv(b),_.includes("block-ref"))return Rh(e,b),b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620),!1;if(_.includes("file-annotation-ref")&&!e.disabled)return Bh(e,b),!1;if(_.includes("tag")&&!e.disabled)return Uh(e,b),!1;if(_.includes("inline-memo"))return e.toolbar.showRender(e,b),!1;if(_.includes("a"))return Jo(e,b),window.siyuan.config.editor.floatWindowMode===0&&((c=b.getAttribute("data-href"))!=null&&c.startsWith("siyuan://blocks"))&&(b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620)),!1}const k=j(b,"data-type","inline-math");if(k)return wp(e,k),!1;if(b.tagName==="IMG"&&T(b,"img"))return Fh(e,e.toolbar.range,b.parentElement.parentElement,{clientX:f+4,clientY:g}),!1;!An(w)&&!w.classList.contains("protyle-wysiwyg--select")&&!T(b,"protyle-action")&&(Y()||o.detail.target||n&&w.contains(n.startContainer))?(!Y()||(d=e.toolbar)!=null&&d.element.classList.contains("fn__none"))&&!w.classList.contains("av")&&(qx(e,w),window.siyuan.menus.menu.popup({x:f,y:g+13,h:26}),(u=e.toolbar)==null||u.element.classList.add("fn__none"),w.classList.contains("table")&&w.querySelector(".table__select").removeAttribute("style")):e.toolbar.range.toString()===""&&(ce(["util"],e),e.gutter&&e.gutter.renderMenu(e,w),window.siyuan.menus.menu.popup({x:f,y:g}),(m=e.toolbar)==null||m.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{if(getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0,e.breadcrumb){const o=e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');o&&getSelection().rangeCount>0&&setTimeout(()=>{const r=getSelection().getRangeAt(0),c=B(r.startContainer);if(!c)return;const d=e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');c.parentElement.classList.contains("li")?(o.removeAttribute("disabled"),d.removeAttribute("disabled")):(o.setAttribute("disabled","true"),d.setAttribute("disabled","true"))},520)}});let a=!1;this.element.addEventListener("mousewheel",o=>{if(cn(),!a&&o.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(A("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{a=!1,kt({data:c,protyle:e,action:[p.CB_GET_BEFORE,p.CB_GET_UNCHANGEID]})}),a=!0),o.deltaX===0)return;const r=T(o.target,"table");if(r){const c=r.querySelector(".table__select");c!=null&&c.style.width&&(c.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0}),this.element.addEventListener("paste",o=>{if(o.target.localName==="input"&&o.target.getAttribute("data-type")==="av-search")return;if(e.disabled){o.stopPropagation(),o.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,o.target.tagName==="PROTYLE-HTML"||o.target.localName==="input"){o.stopPropagation();return}if(!j(o.target,"contenteditable","true")){o.stopPropagation(),o.preventDefault();return}const r=B(o.target);if(r&&!fe(r)){o.stopPropagation(),o.preventDefault();return}if(!r)return;const c=getSelection().getRangeAt(0);e.toolbar.range=c;const d=c.startContainer.parentElement;if(c.toString()===""&&d.tagName==="SPAN"){const u=(d.getAttribute("data-type")||"").split(" ");if(u.includes("inline-memo")||u.includes("text")||u.includes("block-ref")||u.includes("file-annotation-ref")||u.includes("a")){const m=_t(d,r,c);m.start===0?(c.setStartBefore(d),c.collapse(!0)):m.start===d.textContent.length&&(c.setEndAfter(d),c.collapse(!1))}}Uo(e,o)});let i=!1;this.element.addEventListener("compositionstart",o=>{i=!0;const r=ke(e.wysiwyg.element),c=B(r.startContainer);!Mt()&&c&&hd(c,r,e),o.stopPropagation()}),this.element.addEventListener("compositionend",o=>{o.stopPropagation(),i=!1;const r=ke(this.element),c=B(r.startContainer);if(c)if(o.data!=="")this.escapeInline(e,r,o),Ep(e,c,r,!0);else{const d=c.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[d]&&le(e,d,c.outerHTML,e.wysiwyg.lastHTMLs[d])}});let s;this.element.addEventListener("input",o=>{const r=o.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||o.inputType==="historyRedo")return;if(o.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const c=ke(this.element),d=B(c.startContainer);d&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(o.data)&&(e.hint.enableExtend=!0),!(o.isComposing||i||o.inputType==="deleteByDrag"||o.inputType==="insertFromDrop")&&(this.escapeInline(e,c,o),/^\d{1}$/.test(o.data)||o.data==="\u2018"||o.data==="\u201C"||o.data==="\u201D"||o.data==="\u300C"?(clearTimeout(s),s=window.setTimeout(()=>{Ep(e,d,c,!0)})):Ep(e,d,c,!0,o),o.stopPropagation()))}),this.element.addEventListener("keyup",o=>{const r=ke(this.element).cloneRange(),c=B(r.startContainer);if(o.key!=="PageUp"&&o.key!=="PageDown"&&o.key!=="Home"&&o.key!=="End"&&o.key.indexOf("Arrow")===-1&&o.key!=="Escape"&&o.key!=="Shift"&&o.key!=="Meta"&&o.key!=="Alt"&&o.key!=="Control"&&o.key!=="CapsLock"&&!o.ctrlKey&&!o.shiftKey&&!o.metaKey&&!o.altKey&&!/^F\d{1,2}$/.test(o.key)){!Mt()&&c&&!i&&(typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"||r.toString()!==""||!this.preventKeyup)&&hd(c,r,e),this.preventKeyup=!1;return}if(this.preventKeyup){this.preventKeyup=!1;return}if((o.shiftKey||Wt(o))&&!o.isComposing&&r.toString()!==""&&(e.toolbar.render(e,r,o),Vl(r)),o.eventPhase!==3&&!o.shiftKey&&(o.key.indexOf("Arrow")>-1||o.key==="Home"||o.key==="End"||o.key==="PageUp"||o.key==="PageDown")&&!o.isComposing){if(c&&(an(["img","av"],e.wysiwyg.element),this.setEmptyOutline(e,c),r.toString()===""&&!c.classList.contains("protyle-wysiwyg--select")&&Vl(r,e.block.rootID),e.breadcrumb)){const d=e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(d){const u=e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');c.parentElement.classList.contains("li")?(d.removeAttribute("disabled"),u.removeAttribute("disabled")):(d.setAttribute("disabled","true"),u.setAttribute("disabled","true"))}}o.stopPropagation()}if((o.key==="ArrowLeft"||o.key==="ArrowRight")&&c&&!c.classList.contains("protyle-wysiwyg--select")){const d=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let u=!1;d.find(m=>{if(m.contains(r.startContainer))return u=!0,!0}),!u&&d.length>0&&(d.forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",o=>{if(o.target.tagName==="IMG"&&!o.target.classList.contains("emoji")){Bv(o.target.getAttribute("src"),e.block.rootID);return}});let l=!1;this.element.addEventListener("click",o=>{if(this.preventClick){this.preventClick=!1;return}e.app.plugins.forEach(L=>{L.eventBus.emit("click-editorcontent",{protyle:e,event:o})}),ce(["hint","util"],e);const r=Wt(o),c=T(o.target,"protyle-breadcrumb__item");if(c){const L=c.getAttribute("data-id");L?r&&!o.shiftKey&&!o.altKey?ft(L,D=>{ve({app:e.app,id:L,action:D?[p.CB_GET_FOCUS,p.CB_GET_ALL]:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT],zoomIn:D})}):j0(e,c):K0(c),o.stopPropagation();return}this.setEmptyOutline(e,o.target);const d=T(o.target,"table");this.element.querySelectorAll(".table").forEach(L=>{L.tagName==="DIV"&&((!d||L!==d)&&L.querySelector(".table__select").removeAttribute("style"),d&&d===L&&L.querySelector(".table__select").getAttribute("style")&&o.stopPropagation())}),e.options.render.breadcrumb&&e.breadcrumb.render(e,!1,B(o.target));const u=ke(this.element);u.startContainer.nodeType!==3&&u.startContainer.classList.contains("protyle-action")&&u.startContainer.parentElement.classList.contains("code-block")&&Yl(u.startContainer.parentElement.querySelector(".hljs").lastElementChild,u);const m=j(o.target,"data-type","a")||T(o.target,"av__celltext--url");let f=m&&m.getAttribute("data-href")||"";m&&!f&&m.classList.contains("av__celltext--url")&&(f=m.textContent.trim(),m.dataset.type==="phone"?f="tel:"+f:m.dataset.type==="email"?f="mailto:"+f:m.classList.contains("b3-chip")&&(f=m.dataset.url));const g=j(o.target,"data-type","block-ref");if((g||f.startsWith("siyuan://blocks/"))&&(o.stopPropagation(),o.preventDefault(),ce(["dialog","toolbar"],e),u.toString()===""||o.shiftKey)){let L;if(g?L=g.getAttribute("data-id"):m&&(L=f.substring(16,38)),ft(L,(D,I,q)=>{q||I.push(p.CB_GET_HL),o.shiftKey?(ve({app:e.app,id:L,position:"bottom",action:I,zoomIn:D}),window.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape"}))):o.altKey?ve({app:e.app,id:L,position:"right",action:I,zoomIn:D}):ve(r?{app:e.app,id:L,keepCursor:!0,action:D?[p.CB_GET_HL,p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],zoomIn:D}:{app:e.app,id:L,action:I,zoomIn:D})}),e.model){let D;g?D=B(g):m&&(D=B(m)),D&&cr(e,ke(this.element),D)}return}const h=j(o.target,"data-type","file-annotation-ref");if(h&&u.toString()===""){o.stopPropagation(),o.preventDefault(),Uc(e,h.getAttribute("data-id"),o,r);return}if(m&&(o.shiftKey||u.toString()==="")&&f){o.stopPropagation(),o.preventDefault(),Uc(e,f,o,r);return}if(m&&m.classList.contains("av__celltext--url")&&!f){let L=0;Array.from(m.parentElement.children).find((D,I)=>{if(D===m)return L=I,!0}),Sp({protyle:e,cellElements:[m.parentElement],blockElement:B(m),content:m.getAttribute("data-url"),type:"file",name:m.getAttribute("data-name"),index:L,rect:m.getBoundingClientRect()});return}const b=j(o.target,"data-type","tag");if(b&&!o.altKey&&!o.shiftKey&&u.toString()===""){Si(e.app,`#${b.textContent}#`,!r,{method:0}),ce(["dialog"]);return}const y=T(o.target,"protyle-wysiwyg__embed");if(y){const L=y.getAttribute("data-id");if(ft(L,(D,I)=>{o.shiftKey?ve({app:e.app,id:L,position:"bottom",action:I,zoomIn:D}):o.altKey?ve({app:e.app,id:L,position:"right",action:I,zoomIn:D}):r?ve({app:e.app,id:L,action:D?[p.CB_GET_HL,p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT],zoomIn:D,keepCursor:!0}):e.disabled||window.siyuan.blockPanels.push(new ud({app:e.app,targetElement:y,isBacklink:!1,refDefs:[{refID:L}]}))}),!r){o.stopPropagation();return}}if(lS(o,e)||He(o.target,"protyle-action__copy"))return;const w=T(o.target,"protyle-action__edit");if(w&&!e.disabled){e.toolbar.showRender(e,w.parentElement.parentElement),o.stopPropagation(),o.preventDefault();return}const E=T(o.target,"protyle-action__menu");if(E){e.gutter.renderMenu(e,E.parentElement.parentElement);const L=E.getBoundingClientRect();window.siyuan.menus.menu.popup({x:L.left,y:L.top,isLeft:!0}),o.stopPropagation(),o.preventDefault();return}const C=T(o.target,"protyle-action__reload");if(C){const L=G(C);if(L)L.removeAttribute("data-render"),We(e,L);else{const D=B(C);D&&D.getAttribute("data-subtype")==="echarts"&&(D.removeAttribute("data-render"),eh(D))}o.stopPropagation(),o.preventDefault();return}const $=T(o.target,"protyle-action__language");if($&&!e.disabled&&!r){e.toolbar.showCodeLanguage(e,[$]),o.stopPropagation(),o.preventDefault();return}const M=j(o.target,"data-subtype","math");if(!o.shiftKey&&!r&&M&&!e.disabled){e.toolbar.showRender(e,M),o.stopPropagation();return}const k=T(o.target,"protyle-action");if(k){if(k.parentElement.parentElement.getAttribute("data-type")==="img"&&!e.disabled){Fh(e,u,k.parentElement.parentElement,{clientX:o.clientX+4,clientY:o.clientY}),o.stopPropagation();return}else if(k.parentElement.classList.contains("li")){const D=k.parentElement.getAttribute("data-node-id");if(o.altKey&&!e.disabled){if(k.parentElement.parentElement.classList.contains("protyle-wysiwyg"))Nt(e,k.parentElement);else{let I=!0;const q=k.parentElement.parentElement.outerHTML;Array.from(k.parentElement.parentElement.children).find(Z=>{if(Z.classList.contains("li")&&Z.getAttribute("fold")!=="1"&&Z.childElementCount>3)return I=!1,!0}),Array.from(k.parentElement.parentElement.children).find(Z=>{Z.classList.contains("li")&&(I?Z.removeAttribute("fold"):Z.childElementCount>3&&Z.setAttribute("fold","1"))}),le(e,k.parentElement.parentElement.getAttribute("data-node-id"),k.parentElement.parentElement.outerHTML,q)}ce(["gutter"],e)}else if(o.shiftKey&&!e.disabled)xi(k.parentElement,"bookmark",e);else if(r)dn({protyle:e,id:D});else if(k.classList.contains("protyle-action--task")){if(!e.disabled){const I=k.parentElement.outerHTML;k.parentElement.classList.contains("protyle-task--done")?(k.querySelector("use").setAttribute("xlink:href","#iconUncheck"),k.parentElement.classList.remove("protyle-task--done")):(k.querySelector("use").setAttribute("xlink:href","#iconCheck"),k.parentElement.classList.add("protyle-task--done")),k.parentElement.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(e,D,k.parentElement.outerHTML,I)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(e.block.showAll&&e.block.id===D?qh(e,D):dn({protyle:e,id:D}));o.stopPropagation();return}}const _=T(o.target,"hr")||T(o.target,"iframe");if(!o.shiftKey&&!r&&_){_.classList.add("protyle-wysiwyg--select"),oS(o.target),o.stopPropagation();return}const v=He(o.target,"img");if(!o.shiftKey&&!r&&v){v.classList.add("img--select");const L=Ge(v);L&&(L.textContent.startsWith(p.ZWSP)?u.setStart(L,1):u.setStart(L,0),u.collapse(!0),ne(u),e.options.render.breadcrumb&&e.breadcrumb.render(e));return}const S=He(o.target,"emoji");if(!e.disabled&&!o.shiftKey&&!r&&S){const L=B(S);if(L){const D=S.getBoundingClientRect();Xa("","av",{x:D.left,y:D.bottom,h:D.height,w:D.width},I=>{S.insertAdjacentHTML("afterend","<wbr>");const q=L.outerHTML;let Z;if(I.startsWith("api/icon/getDynamicIcon"))Z=`<img class="emoji" src="${I}"/>`;else if(I.indexOf(".")>-1){const R=I.split(".");Z=`<img alt="${R[0]}" class="emoji" src="/emojis/${I}" title="${R[0]}">`}else Z=be(I);S.outerHTML=Z,ce(["dialog"]),le(e,L.getAttribute("data-node-id"),L.outerHTML,q),we(L,u)},S)}return}h0(e,o)||(setTimeout(()=>{var L;let D=ke(this.element);if(B(o.target)!==B(D.startContainer)&&((L=this.element.querySelector("[data-node-id]"))!=null&&L.contains(D.startContainer))){const Z=this.element.getBoundingClientRect();let R=document.elementFromPoint(Z.left+Z.width/2,o.clientY);R===this.element&&(R=document.elementFromPoint(Z.left+Z.width/2,o.clientY+8));let F=B(R);if(F){const K=G(F);K&&(F=K),D=oe(F,void 0,o.clientX<Z.left+parseInt(this.element.style.paddingLeft))||D,e.options.render.breadcrumb&&e.breadcrumb.render(e,!1,F)}}const I=T(D.endContainer,"protyle-attr");I&&(D=Yt(I.previousElementSibling,D,!1));const q=j(D.startContainer,"data-type","inline-math");q&&(D.setEndAfter(q),D.collapse(!1),ne(D)),D.toString().replace(p.ZWSP,"")!==""?e.toolbar.render(e,D):e.toolbar.range=D,e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||Vl(D,e.block.rootID),getSelection().rangeCount===0&&!l&&ne(D),cr(e,D),l=!1},Y()||$n()?520:0),e.hint.enableExtend=!1,this.element.querySelector(".protyle-wysiwyg--select")&&u.toString()!==""&&(u.collapse(!1),ne(u)))})}}class z3{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}var G3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class j3 extends Il{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>G3(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!B(i.startContainer))return;const l=j(i.startContainer,"data-type","a");if(l){Jo(e,l);return}let o="",r=i.toString().trim().replace(p.ZWSP,""),c=!1;try{if(o=e.lute.GetLinkDest(r),!o){const u=yield hc(),m=u.textHTML||e.lute.Md2BlockDOM(u.textPlain);if(m){const f=document.createElement("template");f.innerHTML=m;const g=f.content.querySelector('span[data-type~="a"], a');g&&(r=r||g.textContent,o=g.getAttribute("data-href")||g.getAttribute("href"))}if(o||(o=e.lute.GetLinkDest(u.textPlain)),!o){const f=u.textPlain.lastIndexOf(" ");f>-1&&(o=e.lute.GetLinkDest(u.textPlain.substring(f)),o&&!r&&(r=u.textPlain.substring(0,f)))}!o&&u.textPlain.startsWith("assets/")&&(o=u.textPlain),o&&!r&&(r=decodeURIComponent(o.replace("https://","").replace("http://","")),o.length>p.SIZE_LINK_TEXT_MAX&&(r=o.substring(0,p.SIZE_LINK_TEXT_MAX)+"..."),c=!0)}}catch(u){console.log(u)}const d=e.toolbar.setInlineMark(e,"a","range",{type:"a",color:o+(r?p.ZWSP+r:"")});c&&Jo(e,d[0],!0)}))}}class K3 extends Il{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>{e.toolbar.range.toString()!==""&&(sy(e.toolbar.range),As(e.toolbar.range.toString(),e,"search"),e.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var Z3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class J3 extends Il{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>Z3(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!B(i.startContainer))return;let l=j(i.startContainer,"data-type","inline-math");if(!l&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const o=pt(i.startContainer.childNodes[i.startOffset]);o&&o.nodeType!==3&&o.getAttribute("data-type").indexOf("inline-math")>-1&&(l=o)}if(!l&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let o=!0,r=!1;if(i.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:o=!1}),o&&r){const c=Ge(i.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)l=c;else{const d=pt(i.startContainer);i.startOffset===0&&d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1&&(l=d)}}}if(l){e.toolbar.showRender(e,l);return}e.toolbar.setInlineMark(e,"inline-math","range",{type:"inline-math"})}))}}var X3=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class Q3 extends Il{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>X3(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!B(i.startContainer))return;const l=j(i.startContainer,"data-type","inline-memo");if(l&&l.textContent===i.toString()){e.toolbar.showRender(e,l);return}i.toString()!==""&&e.toolbar.setInlineMark(e,"inline-memo","range",{type:"inline-memo"})}))}}var e1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class t1{constructor(e){const n=e.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none",this.toolbarHeight=29,e.app.plugins.forEach(i=>{const s=i.updateProtyleToolbar(n.toolbar);s.forEach(l=>{typeof l=="string"||p.INLINE_TYPE.concat("|").includes(l.name)||!l.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[i.name]&&window.siyuan.config.keymap.plugin[i.name][l.name]&&(l.hotkey=window.siyuan.config.keymap.plugin[i.name][l.name].custom)}),n.toolbar=bp(s)}),n.toolbar.forEach(i=>{const s=this.genItem(e,i);this.element.appendChild(s)})}update(e){this.element.innerHTML="",e.options.toolbar=bp(p.PROTYLE_TOOLBAR),e.app.plugins.forEach(n=>{const a=n.updateProtyleToolbar(e.options.toolbar);a.forEach(i=>{typeof i=="string"||p.INLINE_TYPE.concat("|").includes(i.name)||!i.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[n.name]&&window.siyuan.config.keymap.plugin[n.name][i.name]&&(i.hotkey=window.siyuan.config.keymap.plugin[n.name][i.name].custom)}),e.options.toolbar=bp(a)}),e.options.toolbar.forEach(n=>{const a=this.genItem(e,n);this.element.appendChild(a)})}render(e,n,a){this.range=n;let i=B(n.startContainer);if(Y()||!i||e.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!1;if(Array.from(n.cloneContents().childNodes).find(u=>{if(u.textContent.length>0&&u.textContent!==p.ZWSP&&!(u.nodeType===1&&u.classList.contains("img")))return s=!0,!0}),!s||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const l=B(n.startContainer),o=B(n.endContainer);if(l&&o&&l!==o){if(a)if(a.key==="ArrowLeft")this.range=Yt(fe(l),n,!1);else if(a.key==="ArrowRight")this.range=Yl(fe(o),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=Yl(fe(o),n),i=B(o),!i)return}else a.key==="ArrowDown"&&(this.range=Yt(fe(l),n,!1));else this.range=Yt(fe(i),n,!1);if(ne(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=Ca(i,n,!0);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const c=r.isBottom?Math.min(r.top+4,e.element.getBoundingClientRect().bottom-this.toolbarHeight):Math.max(r.top-this.toolbarHeight-4,e.element.getBoundingClientRect().top+30);this.element.setAttribute("data-inity",c+p.ZWSP+e.contentElement.scrollTop.toString()),Te(this.element,r.left-this.element.clientWidth/4,c),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(u=>{u.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(u=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(u))return;const m=this.element.querySelector(`[data-type="${u}"]`);m&&m.classList.add("protyle-toolbar__item--current")})}getCurrentType(e=this.range){var n,a;let i=[],s=e.startContainer;if(s.nodeType===3?s=s.parentElement:s.childElementCount>0&&((n=s.childNodes[e.startOffset])==null?void 0:n.nodeType)!==3&&(s=s.childNodes[e.startOffset],(s==null?void 0:s.tagName)==="WBR"&&(s=s.parentElement)),!s||s.nodeType===3)return[];["DIV","TD","TH","TR"].includes(s.tagName)||(i=(s.getAttribute("data-type")||"").split(" "));let l=e.endContainer;return l.nodeType===3?l=l.parentElement:l.childElementCount>0&&((a=l.childNodes[e.endOffset])==null?void 0:a.nodeType)!==3&&(l=l.childNodes[e.endOffset]),i.length===0&&(!l||l.nodeType===3)?[]:(l&&!["DIV","TD","TH","TR"].includes(l.tagName)&&s!==l&&(i=i.concat((l.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach(o=>{o.nodeType!==3&&(i=i.concat((o.getAttribute("data-type")||"").split(" ")))}),i=[...new Set(i)],i.find((o,r)=>{if(o==="")return i.splice(r,1),!0}),i)}setInlineMark(e,n,a,i){const s=B(this.range.startContainer);if(!s||s.getAttribute("data-type")==="NodeCodeBlock")return;const l=B(this.range.endContainer);if(!l)return;s!==l&&(this.range=Yt(fe(s),this.range,!1));let o=[];this.range.cloneContents().childNodes.forEach(_=>{_.nodeType!==3&&(o=o.concat((_.getAttribute("data-type")||"").split(" ")))});let r=Ge(this.range.startContainer);for(;r&&r.nodeType===1&&r.tagName==="BR";)r=Ge(r);const c=this.range.startContainer===this.range.endContainer||r&&r===this.range.endContainer&&this.range.startContainer.parentElement===this.range.endContainer.parentElement;this.range.startContainer.nodeType===3&&this.range.startContainer.parentElement.tagName==="SPAN"&&c&&this.range.startOffset>-1&&this.range.endOffset<=this.range.endContainer.textContent.length&&(o=o.concat((this.range.startContainer.parentElement.getAttribute("data-type")||"").split(" ")));const d=this.range.toString();let u=!1;if(!d&&this.range.startOffset===1&&this.range.startContainer.textContent===p.ZWSP){let _;this.range.startContainer.nodeType===1?_=this.range.startContainer:_=this.range.startContainer.parentElement,_.tagName==="SPAN"&&(o=o.concat((_.getAttribute("data-type")||"").split(" ")),this.range.setStart(_.firstChild,0),this.range.setEnd(_.lastChild,_.lastChild.textContent.length||0),u=!0)}if(o.length===1&&["block-ref","virtual-block-ref","file-annotation-ref","a","inline-memo","inline-math","tag"].includes(o[0])&&n==="clear")return;if(o.includes("text")&&n==="text"&&i&&this.range.startContainer.nodeType===3&&this.range.startContainer===this.range.endContainer){const _=this.range.startContainer.parentElement;if(_&&hv(null,_,i))return}sy(this.range);let m,f,g;if(this.range.startContainer.nodeType===3&&this.range.startContainer.parentElement.tagName==="SPAN"&&c){this.range.startOffset>-1&&this.range.endOffset<=this.range.endContainer.textContent.length&&(g=this.range.startContainer.parentElement);const _=pt(this.range.startContainer),v=Ge(this.range.endContainer);if((this.range.startOffset!==0||this.range.startOffset===0&&_&&(_.nodeType===3||_.tagName==="BR")&&this.range.startContainer.previousSibling.parentElement===this.range.startContainer.parentElement)&&(this.range.endOffset!==this.range.endContainer.textContent.length||this.range.endOffset===this.range.endContainer.textContent.length&&v&&(v.nodeType===3||v.tagName==="BR")&&this.range.endContainer.nextSibling.parentElement===this.range.endContainer.parentElement)&&!(this.range.startOffset===1&&this.range.startContainer.textContent.startsWith(p.ZWSP))){const S=this.range.startContainer.parentElement,L=document.createElement("span"),D=S.attributes;for(let I=0;I<D.length;I++)L.setAttribute(D[I].name,D[I].value);this.range.insertNode(document.createElement("wbr")),f=s.outerHTML,m=this.range.extractContents(),this.range.setEnd(S.lastChild,S.lastChild.textContent.length),L.append(this.range.extractContents()),S.after(L),this.range.setStartBefore(L),this.range.collapse(!0)}}let h=!1;if(this.range.endOffset===this.range.startContainer.textContent.length&&!["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)&&!Ge(this.range.endContainer)&&(this.range.setEndAfter(this.range.endContainer.parentElement),h=!0),this.range.startOffset===0&&!["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)&&!pt(this.range.startContainer)&&this.range.setStartBefore(this.range.startContainer.parentElement),f||(this.range.insertNode(document.createElement("wbr")),f=s.outerHTML,m=this.range.extractContents()),this.mergeNode(m.childNodes),m.childNodes.forEach(_=>{_.nodeType===3&&_.textContent===p.ZWSP&&_.remove(),_.nodeType===1&&_.textContent===""&&_.tagName==="SPAN"&&_.remove()}),d&&this.range.startContainer.nodeType!==3){let _=this.range.startContainer.childNodes[this.range.startOffset];_||(_=this.range.startContainer.childNodes[this.range.startOffset-1]),_&&_.nodeType===3&&(this.range.startContainer.tagName==="DIV"?_=_.previousSibling:_=this.range.startContainer),_&&_.nodeType!==3&&_.textContent.replace(p.ZWSP,"")===""&&!["TD","TH","BR"].includes(_.tagName)&&_.remove()}if(g){const _=g.attributes;m.childNodes.forEach(v=>{if(v.nodeType===3){const S=document.createElement("span");for(let L=0;L<_.length;L++)S.setAttribute(_[L].name,_[L].value);S.innerHTML=v.textContent,v.replaceWith(S)}})}const b=Y()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,y=a==="toolbar"?b.querySelector(`[data-type="${n}"]`):void 0,w=[];let E,C,$,M;if(n==="clear"||y!=null&&y.classList.contains("protyle-toolbar__item--current")||a==="range"&&o.length>0&&o.includes(n)&&!i){if(n==="clear"?b.querySelectorAll('[data-type="strong"],[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="kbd"],[data-type="mark"],[data-type="code"]').forEach(_=>{_.classList.remove("protyle-toolbar__item--current")}):y&&y.classList.remove("protyle-toolbar__item--current"),m.childNodes.length===0){if(o.find((_,v)=>{if(n===_)return o.splice(v,1),!0}),o.length===0||n==="clear")w.push(document.createTextNode(p.ZWSP)),E=w[0];else{let _=0;for(;_<o.length;)["inline-memo","text","block-ref","virtual-block-ref","file-annotation-ref","a"].includes(o[_])?o.splice(_,1):++_;const v=document.createElement("span");v.setAttribute("data-type",o.join(" ")),v.textContent=p.ZWSP,w.push(v),E=w[0].firstChild}u=!0,$=1}m.childNodes.forEach(_=>{if(_.nodeType!==3&&_.tagName!=="BR"&&_.tagName!=="IMG"&&!_.classList.contains("img")){const v=(_.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let S=0;S<v.length;S++)i&&i.type==="text"?v[S]==="text"&&(v.splice(S,1),S--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(v[S])&&(v.splice(S,1),S--);else v.find((S,L)=>{if(n===S)return v.splice(L,1),!0});v.length===0?w.push(document.createTextNode(_.textContent)):(n==="clear"&&(_.style.color="",_.style.webkitTextFillColor="",_.style.webkitTextStroke="",_.style.textShadow="",_.style.backgroundColor="",_.style.fontSize=""),_.setAttribute("data-type",v.join(" ")),w.push(_))}else w.push(_)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&y&&y.classList.add("protyle-toolbar__item--current"),d===""){const _=document.createElement("span");if(o.push(n),h){let v=0;for(;v<o.length;)["inline-memo","text","block-ref","virtual-block-ref","file-annotation-ref","a"].includes(o[v])?o.splice(v,1):++v;o.length===0&&o.push(n)}_.setAttribute("data-type",[...new Set(o)].join(" ")),_.textContent=p.ZWSP,Ah(_,i),w.push(_),u=!0}else{if(n==="block-ref")for(;m.childNodes.length>1;)m.childNodes[0].remove();m.childNodes.forEach(_=>{let v="";if(_.nodeType===3&&_.textContent){for(;_.textContent.endsWith(`
`);)_.textContent=_.textContent.substring(0,_.textContent.length-1),v+=`
`;if(_.textContent){const S=document.createElement("span");S.setAttribute("data-type",n),S.textContent=_.textContent,n==="a"&&(S.textContent||(S.textContent="*"),i.color=i.color.split(p.ZWSP)[0]),Ah(S,i),n==="text"&&!S.getAttribute("style")?w.push(_):w.push(S)}}else if(_.nodeType===1){let S=(_.getAttribute("data-type")||"").split(" ");for(let L=0;L<S.length;L++)["backslash","virtual-block-ref","search-mark"].includes(S[L])&&(S.splice(L,1),L--);if(S.includes("img")||S.push(n),n==="sub"&&S.includes("sup")?S.find((L,D)=>{if(L==="sup")return S.splice(D,1),b.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&S.includes("sub")?S.find((L,D)=>{if(L==="sub")return S.splice(D,1),b.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(S.includes("a")||S.includes("file-annotation-ref"))?S.find((L,D)=>{if(L==="a"||L==="file-annotation-ref")return S.splice(D,1),!0}):n==="a"&&(S.includes("block-ref")||S.includes("file-annotation-ref"))?S.find((L,D)=>{if(L==="block-ref"||L==="file-annotation-ref")return S.splice(D,1),!0}):n==="file-annotation-ref"&&(S.includes("block-ref")||S.includes("a"))?S.find((L,D)=>{if(L==="block-ref"||L==="a")return S.splice(D,1),!0}):n==="inline-memo"&&S.includes("inline-math")?(S.find((L,D)=>{if(L==="inline-math")return S.splice(D,1),!0}),_.querySelector(".katex")&&(_.textContent=_.getAttribute("data-content"))):n==="inline-math"&&S.includes("inline-memo")&&S.find((L,D)=>{if(L==="inline-memo")return S.splice(D,1),!0}),S=[...new Set(S)],_.tagName!=="BR"&&_.tagName!=="IMG"&&!S.includes("img"))if(_.setAttribute("data-type",S.join(" ")),n==="a"&&(_.textContent||(_.textContent="*"),i.color=i.color.split(p.ZWSP)[0]),Ah(_,i),S.includes("text")&&!_.getAttribute("style"))if(S.length===1){const L=document.createTextNode(_.textContent);w.push(L)}else S.splice(S.indexOf("text"),1),_.setAttribute("data-type",S.join(" ")),w.push(_);else w.push(_);else w.push(_)}v&&w.push(document.createTextNode(v))})}for(let _=w.length-1;_>-1;_--)this.range.insertNode(w[_]);if(w.length===1&&w[0].textContent===p.ZWSP&&(this.range.setStart(w[0],1),this.range.collapse(!0),w[0].nodeType!==3)){const _=(w[0].getAttribute("data-type")||"").split(" ");(_.includes("code")||_.includes("tag")||_.includes("kbd"))&&(u=!1)}if(!u){for(let _=0;_<=w.length;_++){let v=_===w.length?w[_-1]:pt(w[_]);v.nodeType===3&&v.textContent===p.ZWSP&&(v=pt(v),v&&v.nextSibling.remove());let S=w[_];if(S||(S=Ge(w[_-1]),S&&S.nodeType===3&&S.textContent===p.ZWSP&&(S=Ge(S),S&&S.previousSibling.remove())),S&&S.nodeType!==3){const L=(S.getAttribute("data-type")||"").split(" ");if(S.tagName!=="BR"&&v&&v.nodeType!==3&&S.nodeType!==3&&xe(L,(v.getAttribute("data-type")||"").split(" "))&&hv(S,v)&&((L.includes("code")||L.includes("tag")||L.includes("kbd"))&&S.textContent.startsWith(p.ZWSP)&&(S.textContent=S.textContent.substring(1)),L.includes("inline-math")?S.setAttribute("data-content",v.getAttribute("data-content")+S.getAttribute("data-content")):L.includes("block-ref")&&v.getAttribute("data-id")===S.getAttribute("data-id")?(v.dataset.subtype!=="d"||v.dataset.subtype!=="d")&&(S.setAttribute("data-subtype","s"),S.textContent=v.textContent+S.textContent):(S.textContent=v.innerText+S.innerText,L.includes("inline-memo")&&S.setAttribute("data-inline-memo-content",(v.getAttribute("data-inline-memo-content")||"")+(S.getAttribute("data-inline-memo-content")||""))),L.includes("inline-math")||(_===0?(E=S,$=v.textContent.length):_===w.length&&(C=S,M=v.textContent.length,E?E===v&&(E=S):E=S)),v.remove(),_>0&&(w.splice(_-1,1),_--),w.length===0)){w.push(S);break}}}for(let _=0;_<=w.length;_++){const v=_===w.length?w[_-1]:pt(w[_]);let S=w[_];if(S||(S=Ge(w[_-1])),!S){if(v.nodeType!==3){const L=(v.getAttribute("data-type")||"").split(" ");(L.includes("code")||L.includes("tag")||L.includes("kbd"))&&v.insertAdjacentText("afterend",p.ZWSP)}break}if(S.nodeType===3)if(v&&v.nodeType===3)S.textContent.startsWith(p.ZWSP)&&(S.textContent=S.textContent.substring(1)),v.textContent.endsWith(p.ZWSP)&&(v.textContent=v.textContent.substring(0,v.textContent.length-2));else{const L=v?(v.getAttribute("data-type")||"").split(" "):[];L.includes("code")||L.includes("tag")||L.includes("kbd")?S.textContent.startsWith(p.ZWSP)||(S.textContent=p.ZWSP+S.textContent):S.textContent.startsWith(p.ZWSP)&&(S.textContent=S.textContent.substring(1))}else{const L=S.nodeType===3?[]:(S.getAttribute("data-type")||"").split(" ");if(L.includes("code")||L.includes("tag")||L.includes("kbd")?(S.textContent.startsWith(p.ZWSP)||S.insertAdjacentText("afterbegin",p.ZWSP),(!v||v.nodeType===3&&v.textContent.endsWith(`
`))&&S.insertAdjacentText("beforebegin",p.ZWSP)):S.textContent.startsWith(p.ZWSP)&&(S.textContent=S.textContent.substring(1)),v&&v.nodeType!==3){const D=(v.getAttribute("data-type")||"").split(" ");(D.includes("code")||D.includes("tag")||D.includes("kbd"))&&S.insertAdjacentText("beforebegin",p.ZWSP)}}}}s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(e,s.getAttribute("data-node-id"),s.outerHTML,f),s.querySelectorAll("wbr").forEach(_=>{_.remove()}),E&&typeof $=="number"&&(E.nodeType===3?this.range.setStart(E,$):this.range.setStart(E.firstChild,$)),C&&typeof M=="number"&&(C.nodeType===3?this.range.setEnd(C,M):this.range.setEnd(C.firstChild,M)),ne(this.range);const k=w[0];if(k.nodeType!==3){const _=(k.getAttribute("data-type")||"").split(" ");n==="inline-math"?(Nn(s),d===""&&_.includes("inline-math")&&e.toolbar.showRender(e,k,void 0,f)):n==="inline-memo"?!k.getAttribute("data-inline-memo-content")&&_.includes("inline-memo")&&e.toolbar.showRender(e,k,w,f):n==="a"&&_.includes("a")&&(k.textContent.replace(p.ZWSP,"")===""||!k.getAttribute("data-href"))&&Jo(e,k,!!k.getAttribute("data-href"))}return w}showRender(e,n,a,i){var s;const l=B(n);if(!l)return;ce(["hint"],e),window.siyuan.menus.menu.remove();const o=l.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),c=i||l.outerHTML;let d="HTML",u="";const m=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":d=window.siyuan.languages.staff;break;case"echarts":d=window.siyuan.languages.chart;break;case"flowchart":d="Flow Chart";break;case"graphviz":d="Graphviz";break;case"mermaid":d="Mermaid";break;case"mindmap":u=`- foo
  - bar
- baz`,d=window.siyuan.languages.mindmap;break;case"plantuml":d="UML";break;case"math":r.includes("NodeMathBlock")?d=window.siyuan.languages.math:d=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?d=window.siyuan.languages.blockEmbed:m&&(d=window.siyuan.languages.memo);const f=((s=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:s.getAttribute("aria-label"))===window.siyuan.languages.unpin,g={};if(f){const $=this.subElement.querySelector(".b3-text-field");g.styleH=$.style.height,g.styleW=$.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${f&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move" style="line-height: 24px;">
        ${d}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${f&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages.insertBefore}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages.insertAfter}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${f?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${f?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px;margin: 0 2px;"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${e.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${u}" style="${Y()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const h=()=>{if(w.style.height=w.scrollHeight+"px",Y()){Te(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){w.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const $=C.bottom===C.top?C.bottom+26:C.bottom;this.subElement.clientHeight<=window.innerHeight-$||this.subElement.clientHeight<=C.top?r.includes("inline-math")||m?Te(this.subElement,C.left,$,C.height||26):Te(this.subElement,C.left+(C.width-this.subElement.clientWidth)/2,$,C.height||26):Te(this.subElement,C.right,$)},b=this.subElement.querySelector(".block__icons");b.addEventListener("click",$=>{const M=$.target,k=T(M,"b3-tooltips");if(!k){if($.detail===2){const _=b.querySelector('[data-type="pin"]');_.getAttribute("aria-label")===window.siyuan.languages.unpin?(_.querySelector("svg use").setAttribute("xlink:href","#iconPin"),_.setAttribute("aria-label",window.siyuan.languages.pin)):(_.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),_.setAttribute("aria-label",window.siyuan.languages.unpin)),$.preventDefault(),$.stopPropagation()}return}switch($.stopPropagation(),k.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),ce(["util"],e);break;case"pin":k.getAttribute("aria-label")===window.siyuan.languages.unpin?(k.querySelector("svg use").setAttribute("xlink:href","#iconPin"),k.setAttribute("aria-label",window.siyuan.languages.pin)):(k.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),k.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":k.classList.toggle("block__icon--active");break;case"before":Gn(e,"beforebegin",o),ce(["util"],e);break;case"after":Gn(e,"afterend",o),ce(["util"],e);break;case"export":y();break}});const y=()=>{const $=de(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("object").getAttribute("data")).then(function(M){return M.blob()}).then(function(M){const k=new FormData;k.append("file",M),k.append("type","image/svg+xml"),A("/api/export/exportAsFile",k,_=>{nn(_.data.file),At($)})});return}setTimeout(()=>{jt("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>{n.style.display="inline-block",window.htmlToImage.toBlob(n).then(M=>{n.style.display="";const k=new FormData;k.append("file",M),k.append("type","image/png"),A("/api/export/exportAsFile",k,_=>{nn(_.data.file),At($)})})})},p.TIMEOUT_LOAD)},w=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?w.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):m?w.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):w.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||"");const E=w.value;w.addEventListener("input",$=>{if(n.parentElement&&(w.clientHeight!==w.scrollHeight&&h(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(w.value));else if(m){let M;a?M=a:M=[n],M.forEach(k=>{k.nodeType!==3&&k.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(w.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!m)&&Ct(n),$.stopPropagation()}}),w.addEventListener("keydown",$=>{if($.stopPropagation(),W(window.siyuan.config.keymap.editor.insert["inline-math"].custom,$)){$.preventDefault();return}if(!$.isComposing){if($.key==="Escape"||W("\u2318\u21A9",$))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),ce(["util"],e);else if($.key==="Tab")document.execCommand("insertText",!1,"	"),$.preventDefault();else if(ai($))return}}),this.subElementCloseCB=()=>{var $;if(!n.parentElement||e.disabled||E===w.value&&w.value)return;let M;if(r.includes("NodeHTMLBlock")){let k=w.value;k&&(k=k.trim().replace(/\n+/g,`
`),k.startsWith("<div>")&&k.endsWith("</div>")||(k=`<div>
${k}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(k))}else if(m){let k;a?k=a:k=[n],k.forEach((_,v)=>{if(w.value)_.nodeType!==3&&_.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(w.value));else{const S=_.getAttribute("data-type").split(" ");S.length===1&&S[0]==="inline-memo"?_.outerHTML=_.innerHTML+(v===k.length-1?"<wbr>":""):(S.find((L,D)=>{if(L==="inline-memo")return S.splice(D,1),!0}),_.setAttribute("data-type",S.join(" ")),_.removeAttribute("data-inline-memo-content")),v===k.length-1&&(M=_)}})}else r.includes("inline-math")?w.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),n.removeAttribute("data-render"),Ct(n)):(M=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?(We(e,n),n.style.height=""):Ct(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&T(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?M?M.parentElement?(this.range.setStartAfter(M),this.range.collapse(!0),ne(this.range)):we(l,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),ne(this.range)):(oe(n),n.classList.add("protyle-wysiwyg--select")):($=l.querySelector("wbr"))==null||$.remove(),l.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const k=document.createElement("template");k.innerHTML=e.lute.SpinBlockDOM(l.outerHTML),k.content.childElementCount>1&&de(window.siyuan.languages.htmlBlockTip)}le(e,o,l.outerHTML,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const C=n.getBoundingClientRect();this.element.classList.add("fn__none"),f?(w.style.width=g.styleW,w.style.height=g.styleH):h(),e.disabled||w.select(),e.app.plugins.forEach($=>{$.eventBus.emit("open-noneditableblock",{protyle:e,toolbar:this,blockElement:l,renderElement:n})})}showCodeLanguage(e,n){var a,i;const s=B(n[0]);if(!s)return;ce(["hint"],e),window.siyuan.menus.menu.remove(),this.range=ke(s),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div data-id="codeLanguage" class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"></div>
</div>`;const l=this.subElement.lastElementChild.lastElementChild;let o=`<div data-id="clearLanguage" class="b3-list-item">${window.siyuan.languages.clear}</div>`,r=p.ALIAS_CODE_LANGUAGES.concat((i=(a=window.hljs)==null?void 0:a.listLanguages())!=null?i:[]).sort();const c={languages:r,type:"init",listElement:l};e.app&&e.app.plugins&&e.app.plugins.forEach(f=>{f.eventBus.emit("code-language-update",c)}),r=c.languages,r.forEach(f=>{o+=`<div data-id="${f}" class="b3-list-item">${f}</div>`}),l.innerHTML=o,l.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus");const d=this.subElement.querySelector("input");d.addEventListener("keydown",f=>{if(f.stopPropagation(),!f.isComposing){if(xn(l,f),f.key==="Enter"){this.updateLanguage(n,e,this.subElement.querySelector(".b3-list-item--focus").textContent),f.preventDefault();return}f.key==="Escape"&&(this.subElement.classList.add("fn__none"),ne(this.range))}});const u=(f,g)=>{const h=g.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),b=new RegExp(h,"gi");return f.replace(b,y=>`<b>${y}</b>`)};d.addEventListener("input",f=>{var g;const h=d.value.trim();let b,y=`<div data-id="clearLanguage" class="b3-list-item">${window.siyuan.languages.clear}</div>`,w=!1;if(h){const C=h.toLowerCase();b=r.filter($=>$.toLowerCase().includes(C)).sort(($,M)=>{const k=$.toLowerCase().startsWith(C),_=M.toLowerCase().startsWith(C);return k&&_?$.length-M.length:k?-1:_?1:0}),(g=window.hljs)!=null&&g.getLanguage(h)&&(b=[h].concat(b.filter($=>$!==h)))}const E={languages:h?b:r,type:"match",value:h,listElement:l};e.app&&e.app.plugins&&e.app.plugins.forEach(C=>{C.eventBus.emit("code-language-update",E)}),b=E.languages,h?b.forEach(C=>{h===C?(w=!0,y+=`<div data-id="${C}" class="b3-list-item"><b>${C}</b></div>`):y+=`<div data-id="${C}" class="b3-list-item">${u(C,h)}</div>`}):b.forEach(C=>{y+=`<div data-id="${C}" class="b3-list-item">${C}</div>`}),h&&!w&&(y+=`<div data-id="customLanguage" class="b3-list-item"><b>${he(h.replace(/`| /g,"_"))}</b></div>`),l.innerHTML=y,l.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"),f.stopPropagation()}),l.addEventListener("click",f=>{const g=f.target,h=T(g,"b3-list-item");h&&this.updateLanguage(n,e,h.textContent)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0;const m=n[0].getBoundingClientRect();Te(this.subElement,m.left,m.bottom,m.height),this.element.classList.add("fn__none"),d.select()}showTpl(e,n,a){this.range=a,ce(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${Y()?"width: 100%":"width: 256px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="toolbarResize" style="    cursor: col-resize;
    box-shadow: 2px 0 0 0 var(--b3-theme-surface) inset, 3px 0 0 0 var(--b3-border-color) inset;
    width: 5px;
    margin-left: -2px;"></div>
<div style="width: 520px;${Y()||window.outerWidth<window.outerWidth/2+520?"display:none;":""}overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list");ep(this.subElement.querySelector(".toolbarResize"),i.parentElement);const s=this.subElement.firstElementChild.lastElementChild;let l;i.addEventListener("mouseover",r=>{const c=r.target,d=T(c,"b3-list-item");if(!d)return;const u=d.getAttribute("data-value");l!==u&&(l=u,Ko(l,s,e.block.parentID),r.stopPropagation())});const o=this.subElement.querySelector("input");o.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const d=xn(i,r);if(d){const u=d.getAttribute("data-value");if(l===u)return;l=u,Ko(l,s,e.block.parentID)}}r.key==="Enter"?(c?ne(this.range):Dv(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),ne(this.range))}),o.addEventListener("input",r=>{r.stopPropagation(),A("/api/search/searchTemplate",{k:o.value},c=>{var d;let u="";c.data.blocks.forEach((f,g)=>{u+=`<div data-value="${f.path}" class="b3-list-item--hide-action b3-list-item${g===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${f.content}</span>`,u+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),i.innerHTML=u||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const m=(d=c.data.blocks[0])==null?void 0:d.path;l!==m&&(l=m,Ko(l,s,e.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),ne(this.range),r.stopPropagation();return}const d=T(c,"b3-list-item__action");if(d&&d.getAttribute("data-type")==="remove"){Re(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{A("/api/search/removeTemplate",{path:d.parentElement.getAttribute("data-value")},()=>{if(d.parentElement.parentElement.childElementCount===1)d.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Ko("",s,e.block.parentID);else{if(d.parentElement.classList.contains("b3-list-item--focus")){const g=d.parentElement.previousElementSibling||d.parentElement.nextElementSibling;g.classList.add("b3-list-item--focus");const h=g.getAttribute("data-value");if(l===h)return;l=h,Ko(l,s,e.block.parentID)}d.parentElement.remove()}})}),r.stopPropagation();return}if(j(c,"data-type","previous")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(j(c,"data-type","next")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const f=T(c,"b3-list-item");f&&(Dv(decodeURIComponent(f.getAttribute("data-value")),e,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),o.select(),A("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((u,m)=>{c+=`<div data-value="${u.path}" class="b3-list-item--hide-action b3-list-item${m===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${u.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=c||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const d=Ca(n,a);Te(this.subElement,d.left,d.top+18,p.SIZE_TOOLBAR_HEIGHT),this.subElement.firstElementChild.style.maxHeight=Math.min(window.innerHeight*.8,window.innerHeight-this.subElement.getBoundingClientRect().top)-16+"px",l=i.firstElementChild.getAttribute("data-value"),Ko(l,s,e.block.parentID)})}showWidget(e,n,a){this.range=a,ce(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",l=>{l.stopPropagation(),!l.isComposing&&(xn(i,l),l.key==="Enter"?(Iv(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),e),this.subElement.classList.add("fn__none"),l.preventDefault()):l.key==="Escape"&&(this.subElement.classList.add("fn__none"),ne(this.range)))}),s.addEventListener("input",l=>{l.stopPropagation(),A("/api/search/searchWidget",{k:s.value},o=>{let r="";o.data.blocks.forEach((c,d)=>{r+=`<div data-value="${c.path}" data-content="${c.content}" class="b3-list-item${d===0?" b3-list-item--focus":""}">
    ${c.name}
    <span class="b3-list-item__meta">${c.content}</span>
</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",l=>{const o=l.target,r=T(o,"b3-list-item");r&&Iv(r.dataset.content,e)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),A("/api/search/searchWidget",{k:""},l=>{let o="";l.data.blocks.forEach((c,d)=>{o+=`<div class="b3-list-item${d===0?" b3-list-item--focus":""}" data-content="${c.content}">
${c.name}
<span class="b3-list-item__meta">${c.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=o;const r=Ca(n,a);Te(this.subElement,r.left,r.top+18,p.SIZE_TOOLBAR_HEIGHT)})}showContent(e,n,a){var i,s;this.range=n,ce(["hint"],e),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let l="";const o=n.toString()!==""||((s=(i=n.cloneContents().childNodes[0])==null?void 0:i.classList)==null?void 0:s.contains("emoji"));o&&(l+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',e.disabled||(l+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),e.disabled||(l+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(o||!e.disabled)&&(l+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${l}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>e1(this,null,function*(){const d=T(c.target,"keyboard__action");if(!d)return;const u=d.getAttribute("data-action");if(u==="copy")ne(ke(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(u==="cut")ne(ke(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(u==="delete"){const m=ke(a);m.insertNode(document.createElement("wbr"));const f=a.outerHTML;m.extractContents(),we(a,m),ne(m),le(e,a.getAttribute("data-node-id"),a.outerHTML,f),this.subElement.classList.add("fn__none")}else if(u==="paste"){if(ne(ke(a)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const m=yield hc();Uo(e,Object.assign(m,{target:a}))}catch(m){console.log(m)}this.subElement.classList.add("fn__none")}else u==="select"?(Jp(e,a,n),this.subElement.classList.add("fn__none")):u==="copyPlainText"?(ne(ke(a)),Yi(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):u==="pasteAsPlainText"?(ne(ke(a)),rh(e),this.subElement.classList.add("fn__none")):u==="pasteEscaped"?(ne(ke(a)),Lw(e,a),this.subElement.classList.add("fn__none")):u==="back"?this.subElement.lastElementChild.innerHTML=l:u==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${o?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${o?"":" fn__none"}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,Te(this.subElement,r.left,r.top+28,p.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=Ca(a,n);Te(this.subElement,r.left,r.top-48,p.SIZE_TOOLBAR_HEIGHT)}genItem(e,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new Il(e,n);break;case"block-ref":a=new K3(e,n);break;case"inline-math":a=new J3(e,n);break;case"inline-memo":a=new Q3(e,n);break;case"|":a=new z3;break;case"text":a=new Cx(e,n);break;case"a":a=new j3(e,n);break;default:a=new Il(e,n);break}if(a)return a.element}mergeNode(e){for(let n=0;n<e.length;n++)e[n].nodeType!==3&&e[n].tagName==="WBR"&&(e[n].remove(),n--);for(let n=0;n<e.length;n++)e[n].nodeType===3&&(e[n].textContent===""?(e[n].remove(),n--):e[n+1]&&e[n+1].nodeType===3&&(e[n].textContent=e[n].textContent+e[n+1].textContent,e[n+1].remove(),n--))}updateLanguage(e,n,a){const i=a===window.siyuan.languages.clear?"":a;n.app&&n.app.plugins&&n.app.plugins.forEach(o=>{o.eventBus.emit("code-language-change",{language:i,languageElements:e,protyle:n})}),p.SIYUAN_RENDER_CODE_LANGUAGES.includes(i)||(window.siyuan.storage[p.LOCAL_CODELANG]=i,Ee(p.LOCAL_CODELANG,window.siyuan.storage[p.LOCAL_CODELANG]));const s=[],l=[];e.forEach(o=>{const r=B(o);if(r){const c=r.getAttribute("data-node-id");l.push({id:c,data:r.outerHTML,action:"update"}),o.textContent=a===window.siyuan.languages.clear?"":a;const d=fe(r);p.SIYUAN_RENDER_CODE_LANGUAGES.includes(i)?(r.dataset.content=d.textContent.trim(),r.dataset.subtype=i,r.className="render-node",r.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,Ct(r)):(d.textContent=d.textContent,d.parentElement.removeAttribute("data-render"),rt(r)),r.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),s.push({id:c,data:r.outerHTML,action:"update"})}}),V(n,s,l),this.subElement.classList.add("fn__none"),ne(this.range)}}const rS=t=>{window.siyuan.menus.menu.append(new N({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const e=new $e({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_TRANSFERBLOCKREF);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{A("/api/block/transferBlockRef",{fromID:t,toID:n.value}),e.destroy()})}}).element)};var n1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class a1{constructor(e){Mt()?this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",Pt(window.siyuan.config.keymap.general.enter.custom,"/")).replace("\u2318\u2191",Pt(window.siyuan.config.keymap.editor.general.collapse.custom,"/")).replace("\u2325\u2318A",Pt(window.siyuan.config.keymap.editor.general.attr.custom,"/")):this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",Pt(window.siyuan.config.keymap.general.enter.custom,"/")).replace("\u2318\u2191",Pt(window.siyuan.config.keymap.editor.general.collapse.custom,"/")).replace("\u2325\u2318A",Pt(window.siyuan.config.keymap.editor.general.attr.custom,"/")).replace(//g,"Ctrl+").replace(//g,"Alt+").replace(//g,"Shift+").replace(//g,"Ctrl+"),e.options.backlinkData&&(this.gutterTip=this.gutterTip.replace(window.siyuan.languages.enter,window.siyuan.languages.openBy)),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{var a;cn(),window.siyuan.menus.menu.remove();const i=n.target.parentElement;let s=[],l=[],o;if(i.dataset.rowId){if(o=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${i.dataset.nodeId}"]`)).find(d=>{if(!G(d)&&!je(d))return!0}),(a=o.querySelector('.block__icon[data-type="av-sort"]'))!=null&&a.classList.contains("block__icon--active")){const d=o.querySelectorAll(".av__body");if(d.length===1){n.preventDefault(),n.stopPropagation();return}else if(["template","created","updated"].includes(d[0].getAttribute("data-dtype"))){n.preventDefault(),n.stopPropagation();return}}const c=o.querySelector(`.av__body${i.dataset.groupId?`[data-group-id="${i.dataset.groupId}"]`:""} .av__row[data-id="${i.dataset.rowId}"]`);c.classList.contains("av__row--select")||o.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(d=>{d.classList.remove("av__row--select"),d.querySelector("use").setAttribute("xlink:href","#iconUncheck")}),c.classList.add("av__row--select"),c.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),Es(c),o.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(d=>{var u;const m=((u=T(d,"av__body"))==null?void 0:u.dataset.groupId)||"";s.push(d.getAttribute("data-id")+(m?"@"+m:"")),l.push(d)})}else{const c=i.getAttribute("data-node-id");l=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;if(l.forEach(u=>{const m=u.getAttribute("data-node-id");m===c&&(d=!0),s.push(m)}),!d){let u;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${c}"]`)).find(m=>{if(!G(m)&&this.isMatchNode(m))return u=m,!0}),u&&(l.forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),u.classList.add("protyle-wysiwyg--select"),l=[u],s=[c])}}const r=document.createElement("div");r.className=e.wysiwyg.element.className,l.forEach(c=>{if(c.querySelector("iframe")){const d=c.getAttribute("data-type"),u=jn();u.classList.add("protyle-wysiwyg--select"),fe(u).innerHTML=`<svg class="svg"><use xlink:href="${i.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${Kx(d)}`,r.append(u)}else r.append(sa(c.cloneNode(!0)))}),r.setAttribute("style",`position:fixed;opacity:.1;width:${l[0].clientWidth}px;padding:0;`),document.body.append(r),n.dataTransfer.setDragImage(r,0,0),setTimeout(()=>{r.remove()}),i.style.opacity="0.38",window.siyuan.dragElement=o||e.wysiwyg.element,n.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}${i.getAttribute("data-type")}${p.ZWSP}${i.getAttribute("data-subtype")}${p.ZWSP}${s}${p.ZWSP}${window.siyuan.config.system.workspaceDir}`,e.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{var a;const i=U(n.target,"BUTTON");if(!i)return;n.preventDefault(),n.stopPropagation(),cn(),an(["av","img"],e.wysiwyg.element);const s=i.getAttribute("data-node-id");if(!s){if(i.getAttribute("disabled"))return;i.setAttribute("disabled","disabled");let o;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${(i.previousElementSibling||i.nextElementSibling).getAttribute("data-node-id")}"]`)).find(r=>{if(!G(r)&&this.isMatchNode(r))return o=r,!0}),!o)return;if(n.altKey){let r=!0;Array.from(o.children).find(u=>{if(u.classList.contains("list")&&Array.from(u.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return r=!1,!0}))return!0});const c=[],d=[];Array.from(o.children).forEach(u=>{u.classList.contains("list")&&Array.from(u.children).forEach(m=>{if(m.classList.contains("li")){r?m.removeAttribute("fold"):m.childElementCount>3&&m.setAttribute("fold","1");const f=m.getAttribute("data-node-id");c.push({action:"setAttrs",id:f,data:JSON.stringify({fold:r?"":"1"})}),d.push({action:"setAttrs",id:f,data:JSON.stringify({fold:r?"1":""})})}})}),V(e,c,d),i.removeAttribute("disabled")}else{const r=Nt(e,o).fold;r===1?i.firstElementChild.style.transform="":r===0&&(i.firstElementChild.style.transform="rotate(90deg)")}ce(["select"],e),window.siyuan.menus.menu.remove();return}const l=i.getBoundingClientRect();if(i.dataset.type==="NodeAttributeViewRowMenu"||i.dataset.type==="NodeAttributeViewRow"){const o=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${i.dataset.nodeId}"] .av__row[data-id="${i.dataset.rowId}"]`)).find(c=>{if(!G(c))return!0});if(!o)return;const r=B(o);if(!r)return;if(i.dataset.type==="NodeAttributeViewRow"){const c=r.getAttribute("data-av-id"),d=[Lute.NewNodeID()],u=n.altKey?o.previousElementSibling.getAttribute("data-id")||"":i.dataset.rowId,m=Q().format("YYYYMMDDHHmmss"),f=o.parentElement.getAttribute("data-group-id");V(e,[{action:"insertAttrViewBlock",avID:c,previousID:u,srcs:[{itemID:Lute.NewNodeID(),id:d[0],isDetached:!0,content:""}],blockID:s,groupID:f},{action:"doUpdateUpdated",id:s,data:m}],[{action:"removeAttrViewBlock",srcIDs:d,avID:c},{action:"doUpdateUpdated",id:s,data:r.getAttribute("updated")}]),ap({protyle:e,blockElement:r,srcIDs:d,previousId:u,groupID:f}),n.altKey&&this.element.querySelectorAll("button").forEach(g=>{g.dataset.rowId=d[0]}),r.setAttribute("updated",m)}else{if(!e.disabled&&n.shiftKey){const c=(a=o.querySelector('[data-dtype="block"] .av__celltext--ref'))==null?void 0:a.getAttribute("data-id");if(c){A("/api/attr/getBlockAttrs",{id:c},d=>{fa(d.data,"av",e)});return}}Yc(e,o,{x:l.left,y:l.bottom,w:l.width,h:l.height,isLeft:!0})}return}if(Wt(n))e.options.backlinkData?ft(s,(o,r)=>{ve({app:e.app,id:s,action:r,zoomIn:o})}):dn({protyle:e,id:s});else if(n.altKey){let o;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(r=>{if(!G(r)&&this.isMatchNode(r))return o=r,!0}),!o)return;if(i.getAttribute("data-type")==="NodeListItem"&&o.parentElement.getAttribute("data-node-id")){let r=!0;Array.from(o.parentElement.children).find(u=>{if(u.classList.contains("li")&&u.getAttribute("fold")!=="1"&&u.childElementCount>3)return r=!1,!0}),i.parentElement.querySelector("[data-type='fold'] > svg").style.transform=r?"rotate(90deg)":"";const c=[],d=[];Array.from(o.parentElement.children).find(u=>{if(u.classList.contains("li")){r?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const m=u.getAttribute("data-node-id");c.push({action:"setAttrs",id:m,data:JSON.stringify({fold:r?"":"1"})}),d.push({action:"setAttrs",id:m,data:JSON.stringify({fold:r?"1":""})})}}),V(e,c,d)}else{const r=Nt(e,o).fold,c=i.parentElement.querySelector("[data-type='fold'] > svg");r!==-1&&c&&(c.style.transform=r===0?"rotate(90deg)":"")}o.classList.remove("protyle-wysiwyg--hl")}else if(n.shiftKey&&!e.disabled)xi(e.wysiwyg.element.querySelector(`[data-node-id="${s}"]`),"bookmark",e);else if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){this.renderMenu(e,i),e.toolbar.range||(e.toolbar.range=ke(e.wysiwyg.element.querySelector(`[data-node-id="${s}"]`)||e.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.popup({x:l.left,y:l.bottom,isLeft:!0});const o=He(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),ne(e.toolbar.range)}}),this.element.addEventListener("contextmenu",n=>{const a=U(n.target,"BUTTON");if(!(!a||a.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){cn(),an(["av","img"],e.wysiwyg.element);const i=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"){const s=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(l=>{if(!G(l))return!0});s&&Yc(e,s,{x:i.left,y:i.bottom,w:i.width,h:i.height,isLeft:!0})}else if(a.dataset.type!=="NodeAttributeViewRow"){this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=ke(e.wysiwyg.element.querySelector(`[data-node-id="${a.getAttribute("data-node-id")}"]`)||e.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.popup({x:i.left,y:i.bottom,isLeft:!0});const s=He(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",s?s.dataset.level+"popover":"app"),ne(e.toolbar.range)}}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseleave",n=>{Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()}),this.element.addEventListener("mousewheel",n=>{ce(["gutter"],e),n.stopPropagation()},{passive:!0})}isMatchNode(e){const n=e.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+6;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(e){return{id:e.menuId,icon:e.icon,label:e.label,accelerator:e.accelerator,click(){lr(e)}}}turnsIntoOne(e){return{id:e.menuId,icon:e.icon,label:e.label,accelerator:e.accelerator,click(){ga(e)}}}turnsInto(e){return{id:e.menuId,icon:e.icon,label:e.label,accelerator:e.accelerator,click(){ka(e)}}}showMobileAppearance(e){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const i=e.contentElement.scrollTop+333.5;wv(e,n),xh(i)}renderMultipleMenu(e,n){var a;let i=!1,s=!1;if(n.find((r,c)=>{if(r.classList.contains("li"))return i=!0,!0;if(r.nextElementSibling&&n[c+1]&&r.nextElementSibling===n[c+1])s=!0;else if(c!==n.length-1)return s=!1,!0}),!i&&!e.disabled){const r=[];s&&(r.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:e,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:n,type:"Blocks2ULs"})),r.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,selectsElement:n,type:"Blocks2OLs"})),r.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,selectsElement:n,type:"Blocks2TLs"})),r.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:n,type:"Blocks2Blockquote"}))),r.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:n,type:"Blocks2Ps",isContinue:s})),r.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:s})),r.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:s})),window.siyuan.menus.menu.append(new N({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:r}).element),s&&!(n[0].parentElement.classList.contains("sb")&&n.length+1===n[0].parentElement.childElementCount)&&window.siyuan.menus.menu.append(new N({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}e.disabled||window.siyuan.menus.menu.append(new N({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){ry(n,e)}}).element);const l=xs(Array.from(n).map(r=>r.getAttribute("data-node-id")),!0,n[0]).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let r="";n.forEach(c=>{r+=Sc(c)+`
`}),Yi(r.trimEnd()),oe(n[0])}},{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){An(n[0])?oe(n[0]):ne(ke(n[0])),document.execCommand("copy")}}]),o=this.genCopyTextRef(n);if(o&&l.splice(7,0,o),e.disabled||l.push({id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){_p(n,e)}}),window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:l}).element),!e.disabled){window.siyuan.menus.menu.append(new N({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{oe(n[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new N({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{zi(c=>{Nh(c[0],n,e)})}}).element),window.siyuan.menus.menu.append(new N({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{ip(e,ke(n[0]))}}).element),window.siyuan.menus.menu.append(new N({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var c;(c=e.breadcrumb)==null||c.hide(),Ea(e,n[0],ke(n[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new N({id:"separator_appearance",type:"separator"}).element);const r=new N({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Lh(e,n)),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const c=n[0].getBoundingClientRect();Te(e.toolbar.subElement,c.left,c.top)}}).element;window.siyuan.menus.menu.append(r),Y()||r.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,e),this.genWidths(n,e)}if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(new N({id:"separator_quickMakeCard",type:"separator"}).element);const r=!n.some(c=>!c.hasAttribute(p.CUSTOM_RIFF_DECKS)&&c.getAttribute("data-type")!=="NodeThematicBreak");window.siyuan.menus.menu.append(new N({id:r?"removeCard":"quickMakeCard",label:r?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,icon:"iconRiffCard",click(){$c(e,n)}}).element),window.siyuan.menus.menu.append(new N({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const c=[];n.forEach(d=>{d.getAttribute("data-type")!=="NodeThematicBreak"&&c.push(d.getAttribute("data-node-id"))}),Ic(e.app,c)}}).element)}return(a=e==null?void 0:e.app)!=null&&a.plugins&&zn({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(e,n){var a,i;if(!n)return;ce(["util","toolbar","hint"],e),window.siyuan.menus.menu.remove(),Y()&&hp();const s=n.getAttribute("data-node-id"),l=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(l.length>1){if(window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BLOCK_MULTI),Array.from(l).find(h=>{if(s===h.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(e,Array.from(l))}else window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BLOCK_SINGLE);let o;if(n.tagName==="BUTTON"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(g=>{if(!G(g)&&this.isMatchNode(g))return o=g,!0}):o=n,!o)return;const r=o.getAttribute("data-type"),c=o.getAttribute("data-subtype"),d=[];ce(["select"],e),o.classList.add("protyle-wysiwyg--select"),Pn([s],e.block.rootID),r==="NodeParagraph"&&!e.disabled?(d.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:e,selectsElement:[o],type:"Blocks2ULs"})),d.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,selectsElement:[o],type:"Blocks2OLs"})),d.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,selectsElement:[o],type:"Blocks2TLs"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:[o],type:"Blocks2Blockquote"})),d.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[o],level:1,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[o],level:2,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[o],level:3,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[o],level:4,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[o],level:5,type:"Blocks2Hs"})),d.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!e.disabled?(d.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[o],type:"Blocks2Ps"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:[o],type:"Blocks2Blockquote"})),c!=="h1"&&d.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[o],level:1,type:"Blocks2Hs"})),c!=="h2"&&d.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[o],level:2,type:"Blocks2Hs"})),c!=="h3"&&d.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[o],level:3,type:"Blocks2Hs"})),c!=="h4"&&d.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[o],level:4,type:"Blocks2Hs"})),c!=="h5"&&d.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[o],level:5,type:"Blocks2Hs"})),c!=="h6"&&d.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!e.disabled?(d.push(this.turnsOneInto({menuId:"paragraph",id:s,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,nodeElement:o,type:"CancelList"})),d.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:e,selectsElement:[o],type:"Blocks2Blockquote"})),o.getAttribute("data-subtype")==="o"?(d.push(this.turnsOneInto({menuId:"list",id:s,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:e,nodeElement:o,type:"OL2UL"})),d.push(this.turnsOneInto({menuId:"check",id:s,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,nodeElement:o,type:"UL2TL"}))):o.getAttribute("data-subtype")==="t"?(d.push(this.turnsOneInto({menuId:"list",id:s,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:e,nodeElement:o,type:"TL2UL"})),d.push(this.turnsOneInto({menuId:"orderedList",id:s,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,nodeElement:o,type:"TL2OL"}))):(d.push(this.turnsOneInto({menuId:"orderedList",id:s,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:e,nodeElement:o,type:"UL2OL"})),d.push(this.turnsOneInto({menuId:"check",id:s,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:e,nodeElement:o,type:"OL2TL"})))):r==="NodeBlockquote"&&!e.disabled&&d.push(this.turnsOneInto({menuId:"paragraph",id:s,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,nodeElement:o,type:"CancelBlockquote"})),d.length>0&&!e.disabled&&window.siyuan.menus.menu.append(new N({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:d}).element),!e.disabled&&!o.classList.contains("hr")&&window.siyuan.menus.menu.append(new N({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){ry([o],e)}}).element);const u=xs([s],!0,o).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){Yi(Sc(o).trimEnd()),oe(o)}},{id:r==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){An(o)?oe(o):ne(ke(o)),document.execCommand("copy")}}]),m=this.genCopyTextRef([o]);if(m&&u.splice(7,0,m),r==="NodeAttributeView"?(u.splice(6,0,{iconHTML:"",label:window.siyuan.languages.copyAVID,click(){Be(o.getAttribute("data-av-id"))}}),e.disabled||(u.push({id:"duplicateMirror",iconHTML:"",label:window.siyuan.languages.duplicateMirror,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){_p([o],e)}}),u.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,click(){Zv(e,o)}}))):e.disabled||u.push({id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){_p([o],e)}}),window.siyuan.menus.menu.append(new N({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:u}).element),e.disabled||(window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{oe(o),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new N({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{zi(g=>{Nh(g[0],[o],e)})}}).element),window.siyuan.menus.menu.append(new N({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{ip(e,ke(o))}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{var g;(g=e.breadcrumb)==null||g.hide(),Ea(e,o,ke(o),"Backspace")}}).element)),r==="NodeSuperBlock"&&!e.disabled){let g;window.siyuan.menus.menu.append(new N({id:"separator_cancelSuperBlock",type:"separator"}).element);const h=o.getAttribute("data-sb-layout")==="col";window.siyuan.menus.menu.append(new N({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,accelerator:window.siyuan.config.keymap.editor.general[h?"hLayout":"vLayout"].custom,click(){return n1(this,null,function*(){const b=yield Li(e,o);V(e,b.doOperations,b.undoOperations),oe(e.wysiwyg.element.querySelector(`[data-node-id="${b.previousId}"]`)),ce(["gutter"],e)})}}).element),window.siyuan.menus.menu.append(new N({id:"turnInto"+(h?"VLayout":"HLayout"),accelerator:window.siyuan.config.keymap.editor.general[h?"vLayout":"hLayout"].custom,label:window.siyuan.languages.turnInto+" "+window.siyuan.languages[h?"vLayout":"hLayout"],click(){const b=o.outerHTML;h?o.setAttribute("data-sb-layout","row"):o.setAttribute("data-sb-layout","col"),o.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),le(e,s,o.outerHTML,b),ne(e.toolbar.range),ce(["gutter"],e)}}).element)}else if(r==="NodeCodeBlock"&&!e.disabled&&!o.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new N({id:"separator_code",type:"separator"}).element);const g=o.getAttribute("linewrap"),h=o.getAttribute("ligatures"),b=o.getAttribute("linenumber");window.siyuan.menus.menu.append(new N({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.codeLineWrap&&g!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",w=>{const E=y.querySelector("input");w.target.tagName!=="INPUT"&&(E.checked=!E.checked),o.setAttribute("linewrap",E.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),rt(o),A("/api/attr/setBlockAttrs",{id:s,attrs:{linewrap:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.codeLigatures&&h!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",w=>{const E=y.querySelector("input");w.target.tagName!=="INPUT"&&(E.checked=!E.checked),o.setAttribute("ligatures",E.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),rt(o),A("/api/attr/setBlockAttrs",{id:s,attrs:{ligatures:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&b!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",w=>{const E=y.querySelector("input");w.target.tagName!=="INPUT"&&(E.checked=!E.checked),o.setAttribute("linenumber",E.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),rt(o),A("/api/attr/setBlockAttrs",{id:s,attrs:{linenumber:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!e.disabled&&["echarts","mindmap"].includes(o.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new N({id:"separator_chart",type:"separator"}).element);const g=o.style.height;let h=o.outerHTML;window.siyuan.menus.menu.append(new N({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${g?parseInt(g):"420"}" step="1" min="148" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind:b=>{b.querySelector("input").addEventListener("change",y=>{const w=(y.target.value||"420")+"px";o.style.height=w,le(e,s,o.outerHTML,h),h=o.outerHTML,y.stopPropagation();const E=o.querySelector('[contenteditable="false"]');if(E){E.style.height=w;const C=window.echarts.getInstanceById(E.getAttribute("_echarts_instance_"));C&&C.resize()}})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,o)}}]}).element)}else if(r==="NodeTable"&&!e.disabled){let g=ke(o);const h=o.querySelector("table");h.contains(g.startContainer)||(g=ke(h.querySelector("th")));const b=U(g.startContainer,"TD")||U(g.startContainer,"TH");b&&(window.siyuan.menus.menu.append(new N({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:Pv(e,o,b,g).menus}).element))}else if(r==="NodeAttributeView")window.siyuan.menus.menu.append(new N({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){A("/api/export/exportAttributeView",{id:o.getAttribute("data-av-id"),blockID:s},g=>{nn(g.data.zip)})}}).element),window.siyuan.menus.menu.append(new N({id:"showDatabaseInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click(){hA("showItemInFolder",Mf.join(window.siyuan.config.system.dataDir,"storage","av",o.getAttribute("data-av-id"))+".json")}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!e.disabled)window.siyuan.menus.menu.append(new N({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:r==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:Ux(e,o,r)}).element);else if(r==="NodeIFrame"&&!e.disabled)window.siyuan.menus.menu.append(new N({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:Fx(e,o)}).element);else if(r==="NodeHTMLBlock"&&!e.disabled)window.siyuan.menus.menu.append(new N({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"html",icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,o)}}).element);else if(r==="NodeBlockQueryEmbed"&&!e.disabled){window.siyuan.menus.menu.append(new N({id:"separator_blockEmbed",type:"separator"}).element);const g=o.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new N({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){o.removeAttribute("data-render"),We(e,o)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,o)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&g!=="false"?" checked":""}></div>`,bind(h){h.addEventListener("click",b=>{const y=h.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),o.setAttribute("breadcrumb",y.checked.toString()),A("/api/attr/setBlockAttrs",{id:s,attrs:{breadcrumb:y.checked.toString()}}),o.removeAttribute("data-render"),We(e,o),window.siyuan.menus.menu.remove()})}},{id:"headingEmbedMode",label:window.siyuan.languages.headingEmbedMode,type:"submenu",submenu:[{id:"showHeadingWithBlocks",label:window.siyuan.languages.showHeadingWithBlocks,iconHTML:"",checked:o.getAttribute("custom-heading-mode")==="0",click(){o.setAttribute("custom-heading-mode","0"),A("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":"0"}}),o.removeAttribute("data-render"),We(e,o)}},{id:"showHeadingOnlyTitle",label:window.siyuan.languages.showHeadingOnlyTitle,iconHTML:"",checked:o.getAttribute("custom-heading-mode")==="1",click(){o.setAttribute("custom-heading-mode","1"),A("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":"1"}}),o.removeAttribute("data-render"),We(e,o)}},{id:"showHeadingOnlyBlocks",label:window.siyuan.languages.showHeadingOnlyBlocks,iconHTML:"",checked:o.getAttribute("custom-heading-mode")==="2",click(){o.setAttribute("custom-heading-mode","2"),A("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":"2"}}),o.removeAttribute("data-render"),We(e,o)}},{id:"default",label:window.siyuan.languages.default,iconHTML:"",checked:!o.getAttribute("custom-heading-mode"),click(){o.removeAttribute("custom-heading-mode"),A("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":""}}),o.removeAttribute("data-render"),We(e,o)}}]}]}).element)}else if(r==="NodeHeading"&&!e.disabled){window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element);const g=[];c!=="h1"&&g.push(this.genHeadingTransform(e,s,1)),c!=="h2"&&g.push(this.genHeadingTransform(e,s,2)),c!=="h3"&&g.push(this.genHeadingTransform(e,s,3)),c!=="h4"&&g.push(this.genHeadingTransform(e,s,4)),c!=="h5"&&g.push(this.genHeadingTransform(e,s,5)),c!=="h6"&&g.push(this.genHeadingTransform(e,s,6)),window.siyuan.menus.menu.append(new N({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:g}).element),window.siyuan.menus.menu.append(new N({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){A("/api/block/getHeadingChildrenDOM",{id:s,removeFoldAttr:o.getAttribute("fold")!=="1"},h=>{ht()?window.JSAndroid.writeHTMLClipboard(e.lute.BlockDOM2StdMd(h.data).trimEnd(),h.data+p.ZWSP):bt()?window.JSHarmony.writeHTMLClipboard(e.lute.BlockDOM2StdMd(h.data).trimEnd(),h.data+p.ZWSP):Be(h.data+p.ZWSP)})}}).element),window.siyuan.menus.menu.append(new N({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){A("/api/block/getHeadingChildrenDOM",{id:s,removeFoldAttr:o.getAttribute("fold")!=="1"},h=>{ht()?window.JSAndroid.writeHTMLClipboard(e.lute.BlockDOM2StdMd(h.data).trimEnd(),h.data+p.ZWSP):bt()?window.JSHarmony.writeHTMLClipboard(e.lute.BlockDOM2StdMd(h.data).trimEnd(),h.data+p.ZWSP):Be(h.data+p.ZWSP),A("/api/block/getHeadingDeleteTransaction",{id:s},b=>{if(b.data.doOperations.forEach(y=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${y.id}"]`).forEach(w=>{w.remove()})}),e.wysiwyg.element.childElementCount===0){const y=Lute.NewNodeID(),w=jn(!1,!1,y);e.wysiwyg.element.insertAdjacentElement("afterbegin",w),b.data.doOperations.push({action:"insert",data:w.outerHTML,id:y,parentID:e.block.parentID}),b.data.undoOperations.push({action:"delete",id:y}),oe(w)}V(e,b.data.doOperations,b.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new N({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){A("/api/block/getHeadingDeleteTransaction",{id:s},h=>{if(h.data.doOperations.forEach(b=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${b.id}"]`).forEach(y=>{y.remove()})}),e.wysiwyg.element.childElementCount===0){const b=Lute.NewNodeID(),y=jn(!1,!1,b);e.wysiwyg.element.insertAdjacentElement("afterbegin",y),h.data.doOperations.push({action:"insert",data:y.outerHTML,id:b,parentID:e.block.parentID}),h.data.undoOperations.push({action:"delete",id:b}),oe(y)}V(e,h.data.doOperations,h.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),e.options.backlinkData?window.siyuan.menus.menu.append(new N({id:"enter",accelerator:`${pe(window.siyuan.config.keymap.general.enter.custom)}/${pe("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.openBy,click:()=>{ft(s,(g,h)=>{ve({app:e.app,id:s,action:h,zoomIn:g})})}}).element):(window.siyuan.menus.menu.append(new N({id:"enter",accelerator:`${window.siyuan.config.keymap.general.enter.custom?pe(window.siyuan.config.keymap.general.enter.custom)+"/":""}${Pt("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{dn({protyle:e,id:s})}}).element),window.siyuan.menus.menu.append(new N({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{qh(e,s)}}).element)),!e.disabled){window.siyuan.menus.menu.append(new N({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages.insertBefore,accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){ce(["select"],e),Pn([],e.block.rootID),Gn(e,"beforebegin",s)}}).element),window.siyuan.menus.menu.append(new N({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages.insertAfter,accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){ce(["select"],e),Pn([],e.block.rootID),Gn(e,"afterend",s)}}).element);const g=o.lastElementChild.querySelector(".protyle-attr--refcount");g&&g.textContent&&rS(s)}if(window.siyuan.menus.menu.append(new N({id:"jumpTo",type:"submenu",label:window.siyuan.languages.jumpTo,submenu:[{id:"jumpToParentPrev",iconHTML:"",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){ce(["select"],e),Xo(e,o,"previous")}},{iconHTML:"",id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){ce(["select"],e),Xo(e,o,"next")}},{iconHTML:"",id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){ce(["select"],e),Xo(e,o,"parent")}}]}).element),window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new N({id:"fold",label:window.siyuan.languages.fold,accelerator:`${pe(window.siyuan.config.keymap.editor.general.collapse.custom)}/${pe("\u2325"+window.siyuan.languages.click)}`,click(){Nt(e,o),oe(o)}}).element),e.disabled||window.siyuan.menus.menu.append(new N({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+pe("\u21E7"+window.siyuan.languages.click),click(){xi(o,"bookmark",e)}}).element)),!e.disabled){const g=new N({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Lh(e,[o])),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const h=o.getBoundingClientRect();Te(e.toolbar.subElement,h.left,h.top)}}).element;window.siyuan.menus.menu.append(g),Y()||g.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([o],e),this.genWidths([o],e)}if(window.siyuan.menus.menu.append(new N({id:"separator_4",type:"separator"}).element),window.siyuan.config.cloudRegion===0&&!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((a=fe(o))==null?void 0:a.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!o.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new N({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){o0(o)}}).element),r!=="NodeThematicBreak"&&!window.siyuan.config.readonly){const g=o.hasAttribute(p.CUSTOM_RIFF_DECKS);window.siyuan.menus.menu.append(new N({id:g?"removeCard":"quickMakeCard",icon:"iconRiffCard",label:g?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click(){$c(e,[o])}}).element),window.siyuan.menus.menu.append(new N({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){Ic(e.app,[s])}}).element),window.siyuan.menus.menu.append(new N({id:"separator_5",type:"separator"}).element)}(i=e==null?void 0:e.app)!=null&&i.plugins&&zn({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:[o]},separatorPosition:"bottom"});let f=o.getAttribute("updated")||"";return f&&(f=`${window.siyuan.languages.modifiedAt} ${Q(f).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new N({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${f}${window.siyuan.languages.createdAt} ${Q(s.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(e,n,a){return{id:"heading"+a,iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){A("/api/block/getHeadingLevelTransaction",{id:n,level:a},i=>{i.data.doOperations.forEach((s,l)=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(o=>{o.outerHTML=s.data}),e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(o=>{Nn(o)}),l===0&&oe(e.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),e.wysiwyg.element,!0)}),V(e,i.data.doOperations,i.data.undoOperations)})}}}genClick(e,n,a){Ds(e,n,a),oe(e[0])}genAlign(e,n){window.siyuan.menus.menu.append(new N({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="":a.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="center":a.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="flex-end":a.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(e,n,a=>{a.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,accelerator:window.siyuan.config.keymap.editor.general.ltr.custom,click:()=>{this.genClick(e,n,a=>{a.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,accelerator:window.siyuan.config.keymap.editor.general.rtl.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="":(a.style.textAlign="",a.style.direction="")})}}]}).element)}updateNodeElements(e,n,a){const i=[],s=[];e.forEach(l=>{i.push({action:"update",id:l.getAttribute("data-node-id"),data:l.outerHTML})}),a.addEventListener(a.type==="number"?"blur":"change",()=>{e.forEach(l=>{s.push({action:"update",id:l.getAttribute("data-node-id"),data:l.outerHTML})}),V(n,s,i),window.siyuan.menus.menu.remove(),oe(e[0])})}genWidths(e,n){let a;const i=e[0],s=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${i.style.width.endsWith("px")?parseInt(i.style.width):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.width}"><span class="fn__flex-center">px</span></div>`,bind:o=>{const r=o.querySelector("input");r.addEventListener("input",()=>{e.forEach(c=>{c.style.width=r.value+"px",c.style.flex="none"}),a.value="0",a.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(e,n,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(o=>{s.push({id:"width_"+o,iconHTML:"",label:o,click:()=>{this.genClick(e,n,r=>{r.style.width=o,r.style.flex="none"})}})}),s.push({id:"separator_1",type:"separator"});const l=i.style.width.endsWith("%")?parseInt(i.style.width):0;window.siyuan.menus.menu.append(new N({id:"width",label:window.siyuan.languages.width,submenu:s.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${i.style.width.endsWith("px")?i.style.width:i.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind:o=>{a=o.querySelector("input"),a.addEventListener("input",()=>{e.forEach(r=>{r.style.width=a.value+"%",r.style.flex="none"}),a.parentElement.setAttribute("aria-label",`${a.value}%`)}),this.updateNodeElements(e,n,a)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(e,n,o=>{o.style.width&&(o.style.width="",o.style.flex="")})}}])}).element)}genHeights(e,n){if(e.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let i;const s=e[0],l=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${s.style.height.endsWith("px")?parseInt(s.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind:r=>{const c=r.querySelector("input");c.addEventListener("input",()=>{e.forEach(d=>{d.style.height=c.value+"px",d.style.flex="none"}),i.value="0",i.parentElement.setAttribute("aria-label",c.value+"px")}),this.updateNodeElements(e,n,c)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{l.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(e,n,c=>{c.style.height=r,c.style.flex="none"})}})}),l.push({type:"separator"});const o=s.style.height.endsWith("%")?parseInt(s.style.height):0;window.siyuan.menus.menu.append(new N({id:"heightDrag",label:window.siyuan.languages.height,submenu:l.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${s.style.height.endsWith("px")?s.style.height:s.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${o}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind:r=>{i=r.querySelector("input"),i.addEventListener("input",()=>{e.forEach(c=>{c.style.height=i.value+"%",c.style.flex="none"}),i.parentElement.setAttribute("aria-label",`${i.value}%`)}),this.updateNodeElements(e,n,i)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(e,n,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(e){return An(e[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){e[0].setAttribute("data-reftext","true"),ne(ke(e[0])),document.execCommand("copy")}}}render(e,n,a,i){var s;if(e.title&&e.title.element.getAttribute("data-render")!=="true")return;const l=a.parentElement.parentElement.querySelector(".protyle-select");if(l&&!l.classList.contains("fn__none"))return;let o="",r=n,c=0,d=0,u,m=!1;for(;r;){let E=B(r.parentElement);if(!G(r)){let C;m||(C=r.getAttribute("data-type"));let $=r.getAttribute("data-node-id");if(C==="NodeAttributeView"&&i){const S=T(i,"av__row");if(S&&!S.classList.contains("av__row--header")&&S.dataset.id){n=S;const L=T(S,"av__body");let D=Mt()?window.siyuan.languages.rowTip:window.siyuan.languages.rowTip.replace("\u21E7","Shift+");e.disabled?D=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.indexOf("<br")):((s=S.querySelector('[data-dtype="block"]'))==null?void 0:s.getAttribute("data-detached"))==="true"&&(D=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.lastIndexOf("<br"))),o=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${$}" data-row-id="${S.dataset.id}" data-group-id="${L.dataset.groupId||""}" class="ariaLabel" data-position="parentW" aria-label="${D}"><svg><use xlink:href="#iconDrag"></use></svg><span ${e.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,e.disabled||(o=`<button data-type="NodeAttributeViewRow" data-node-id="${$}" data-row-id="${S.dataset.id}" data-group-id="${L.dataset.groupId||""}" class="ariaLabel" data-position="parentW" aria-label="${Mt()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${o}`);break}}if(d===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(C))return;const S=Et(r);u=S.querySelector(".li")||S.querySelector(".list"),(G(u)||je(u))&&(u=void 0),S!==r&&C!=="NodeHeading"&&(r=S,E=B(r.parentElement),C=r.getAttribute("data-type"),$=r.getAttribute("data-node-id"))}C==="NodeListItem"&&d===1&&(o=""),d+=1;let M=this.gutterTip;e.disabled&&(M=this.gutterTip.split("<br>").splice(0,2).join("<br>"));let k="";e.options.backlinkData&&(k=`class="popover__block" data-id="${$}"`);const _=`<button class="ariaLabel" data-position="parentW" aria-label="${M}" 
data-type="${C}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${$}">
    <svg><use xlink:href="#${la(C,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${k} ${e.disabled?"":'draggable="true"'}></span>
</button>`;m||(o=_+o);let v="";if(C==="NodeListItem"&&r.childElementCount>3||C==="NodeHeading"){const S=r.getAttribute("fold");v=`<button class="ariaLabel" data-position="parentW" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width: 10px${S&&S==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}if((C==="NodeListItem"||C==="NodeList")&&(u=r,C==="NodeListItem"&&r.childElementCount>3&&(o=_+v)),C==="NodeHeading"&&(o=o+v),C==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")){if(m=!0,E&&E.getAttribute("fold")==="1")return;E&&E.getAttribute("data-type")==="NodeBlockquote"&&(c+=8)}}if(E)r=E;else break}let f=!0;const g=this.element.querySelectorAll("button");if(g.length!==o.split("</button>").length-1?f=!1:Array.from(g).find(E=>{const C=E.getAttribute("data-node-id");if(C&&o.indexOf(C)===-1)return f=!1,!0;const $=E.getAttribute("data-row-id");if($&&o.indexOf($)===-1||!$&&o.indexOf("NodeAttributeViewRowMenu")>-1)return f=!1,!0}),f&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=o,this.element.classList.remove("fn__none"),this.element.style.width="";const h=a.parentElement.getBoundingClientRect().top;let b=n.getBoundingClientRect(),y=0;u&&!window.siyuan.config.editor.rtl&&getComputedStyle(n).direction!=="rtl"?(b=u.firstElementChild.getBoundingClientRect(),c=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(b=r.getBoundingClientRect(),c=0):n.classList.contains("av__row")||(b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||b.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?y=(b.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&h<b.top&&(y=8)),this.element.style.top=`${Math.max(b.top,h)+y}px`;let w=b.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?w=r.getBoundingClientRect().left-this.element.clientWidth-c:n.classList.contains("av__row")&&(w=r.getBoundingClientRect().left-this.element.clientWidth-c+parseInt(getComputedStyle(r).paddingLeft)),this.element.style.left=`${w}px`,w<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${b.left-this.element.clientWidth-c/2+3}px`,o="",Array.from(this.element.children).reverse().forEach((E,C)=>{C!==0&&(E.firstElementChild.style.height="14px"),o+=E.outerHTML}),this.element.innerHTML=o):this.element.querySelectorAll("svg").forEach(E=>{E.style.height=""})}}class i1{constructor(e){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let n;if(typeof AudioContext!="undefined")n=new AudioContext;else if(webkitAudioContext)n=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=n.sampleRate;const a=n.createGain();n.createMediaStreamSource(e).connect(a),this.recorder=n.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(n.destination),this.readyFlag=!0}cloneChannelData(e,n){this.leftChannel.push(new Float32Array(e)),this.rightChannel.push(new Float32Array(n)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const e=this.mergeBuffers(this.leftChannel),n=this.mergeBuffers(this.rightChannel);let a=new Float32Array(e.length);for(let u=0;u<e.length;++u)a[u]=.5*(e[u]+n[u]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const i=44+a.length*2,s=new ArrayBuffer(i),l=new DataView(s);this.writeUTFBytes(l,0,"RIFF"),l.setUint32(4,i,!0),this.writeUTFBytes(l,8,"WAVE"),this.writeUTFBytes(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,this.SAMPLE_RATE,!0),l.setUint32(28,this.SAMPLE_RATE*2,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0);const o=a.length*2;this.writeUTFBytes(l,36,"data"),l.setUint32(40,o,!0);const r=a.length;let c=44;const d=1;for(let u=0;u<r;u++)l.setInt16(c,a[u]*(32767*d),!0),c+=2;return new Blob([l],{type:"audio/wav"})}downSampleBuffer(e,n){if(n===this.DEFAULT_SAMPLE_RATE||n>this.DEFAULT_SAMPLE_RATE)return e;const a=this.DEFAULT_SAMPLE_RATE/n,i=Math.round(e.length/a),s=new Float32Array(i);let l=0,o=0;for(;l<s.length;){const r=Math.round((l+1)*a);let c=0,d=0;for(let u=o;u<r&&u<e.length;u++)c+=e[u],d++;s[l]=c/d,l++,o=r}return s}mergeBuffers(e){const n=new Float32Array(this.recordingLength);let a=0;const i=e.length;for(let s=0;s<i;++s){const l=e[s];n.set(l,a),a+=l.length}return n}writeUTFBytes(e,n,a){const i=a.length;for(let s=0;s<i;s++)e.setUint8(n+s,a.charCodeAt(s))}}var s1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const fy=(t,e,n)=>{if(cn(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TITLE){window.siyuan.menus.menu.remove();return}A("/api/block/getDocInfo",{id:t.block.rootID},a=>{var i;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_TITLE);const s=He(t.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",s?s.dataset.level+"popover-"+n:"app-"+n),window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:xs([t.block.rootID],!0,void 0,t.block.showAll?t.block.id:t.block.rootID)}).element),!t.disabled){window.siyuan.menus.menu.append(Zh([t.path]));const l=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new N({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{ip(t,l,"title")}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{Cw(t.notebookId,t.path)}}).element)}if(window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"outline",icon:"iconAlignCenter",label:window.siyuan.languages.outline,accelerator:window.siyuan.config.keymap.editor.general.outline.custom,click:()=>{fb({app:t.app,rootId:t.block.rootID,title:t.options.render.title?t.title.editElement.textContent||window.siyuan.languages.untitled:"",isPreview:!t.preview.element.classList.contains("fn__none")})}}).element),window.siyuan.menus.menu.append(new N({id:"backlinks",icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{Qc({app:t.app,blockId:t.block.id,rootId:t.block.rootID,useBlockId:t.block.showAll,title:t.title?t.title.editElement.textContent||window.siyuan.languages.untitled:null})}}).element),window.siyuan.menus.menu.append(new N({id:"graphView",icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{ed({app:t.app,blockId:t.block.id,rootId:t.block.rootID,useBlockId:t.block.showAll,title:t.title?t.title.editElement.textContent||window.siyuan.languages.untitled:null})}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+pe("\u21E7"+window.siyuan.languages.click),click(){fa(a.data.ial,"bookmark",t)}}).element),!window.siyuan.config.readonly){window.siyuan.config.cloudRegion===0&&window.siyuan.menus.menu.append(new N({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){r0(t)}}).element);const l=!!a.data.ial[p.CUSTOM_RIFF_DECKS],o=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{A("/api/riff/getTreeRiffDueCards",{rootID:t.block.rootID},r=>{Sl(t.app,r.data,"doc",t.block.rootID,r.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{A("/api/filetree/getHPathByID",{id:t.block.rootID},r=>{Vo(t.app,t.block.rootID,De().join(Qa(t.notebookId),r.data),"Tree")})}},{id:l?"removeCard":"quickMakeCard",iconHTML:"",label:l?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var r;let c=(r=t.title)==null?void 0:r.element;c||(c=document.createElement("div"),c.setAttribute("data-node-id",t.block.rootID),c.setAttribute(p.CUSTOM_RIFF_DECKS,a.data.ial[p.CUSTOM_RIFF_DECKS])),$c(t,[c])}}];window.siyuan.config.flashcard.deck&&o.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{Ic(t.app,[t.block.rootID])}}),window.siyuan.menus.menu.append(new N({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:o}).element)}window.siyuan.menus.menu.append(new N({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return s1(this,null,function*(){const l=xt(t.path,!1,!0);Hn({app:t.app,hotkey:p.DIALOG_SEARCH,notebookId:t.notebookId,searchPath:l})})}}).element),t.disabled||rS(t.block.rootID),window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),t.model||window.siyuan.menus.menu.append(new N({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",click(){ve({app:t.app,id:t.block.id,action:t.block.rootID!==t.block.id?[p.CB_GET_ALL,p.CB_GET_FOCUS]:[p.CB_GET_CONTEXT]})}}).element),t.disabled||window.siyuan.menus.menu.append(new N({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){$w({app:t.app,id:t.block.rootID,notebookId:t.notebookId,pathString:a.data.name})}}).element),window.siyuan.menus.menu.append(Yv(t.block.showAll?t.block.id:t.block.rootID)),window.siyuan.menus.menu.append(new N({id:"separator_4",type:"separator"}).element),(i=t==null?void 0:t.app)!=null&&i.plugins&&zn({plugins:t.app.plugins,type:"click-editortitleicon",detail:{protyle:t,data:a.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new N({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${Q(a.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${Q(a.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.popup(e)})},l1=()=>{const t=new $e({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"}),e=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.element.setAttribute("data-key",p.DIALOG_ACCESSAUTHCODE),t.bindInput(e,()=>{n[1].click()}),e.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{A("/api/system/setAccessAuthCode",{accessAuthCode:e.value})})},Fn=t=>{const e=window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io";return!t||t===""?e:`${e}/${t}`},cS=t=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${t}`;var o1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class r1{constructor(e){const n=document.createElement("div");n.className="protyle-breadcrumb";let a="";(Ha()||ht()||bt())&&(a=`<button class="block__icon fn__flex-center ariaLabel" disabled aria-label="${window.siyuan.languages.undo}" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" disabled aria-label="${window.siyuan.languages.redo}" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" disabled aria-label="${window.siyuan.languages.outdent}" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" disabled aria-label="${window.siyuan.languages.indent}" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>`),n.innerHTML=`${Y()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${pe(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${a}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly" data-subtype="unlock"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${Mt()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isEqualNode(n);){const l=s.getAttribute("data-node-id"),o=s.getAttribute("data-type");if(l){e.options.render.breadcrumbDocName&&window.siyuan.ctrlIsPressed?ve({app:e.app,id:l,action:l===e.block.rootID?[p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_ALL]}):dn({protyle:e,id:l}),i.preventDefault();break}else if(o==="mobile-menu"){this.genMobileMenu(e),i.preventDefault(),i.stopPropagation();break}else if(o==="doc"){if(i.shiftKey)A("/api/block/getDocInfo",{id:e.block.rootID},r=>{fa(r.data.ial,"bookmark",e)});else{const r=s.getBoundingClientRect();fy(e,{x:r.right,y:r.bottom,isLeft:!0},p.MENU_FROM_TITLE_BREADCRUMB)}i.stopPropagation(),i.preventDefault();break}else if(o==="more"){const r=s.getBoundingClientRect();this.showMenu(e,{x:r.right,y:r.bottom,isLeft:!0}),i.stopPropagation(),i.preventDefault();break}else if(o==="readonly"){Tw(s,e),i.stopPropagation(),i.preventDefault();break}else if(o==="exit-focus"){dn({protyle:e,id:e.block.rootID,focusId:e.block.id}),i.stopPropagation(),i.preventDefault();break}else if(o==="context"){i.stopPropagation(),i.preventDefault(),s.classList.contains("block__icon--active")?(dn({protyle:e,id:e.options.blockId}),s.classList.remove("block__icon--active")):(A("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{kt({data:r,protyle:e,action:[p.CB_GET_HL]})}),s.classList.add("block__icon--active"));break}else if(o==="undo"){e.undo.undo(e),i.preventDefault(),i.stopPropagation();break}else if(o==="redo"){e.undo.redo(e),i.preventDefault(),i.stopPropagation();break}else if(o==="outdent"){if(e.toolbar.range){const r=B(e.toolbar.range.startContainer);r&&qc(e,[r.parentElement],e.toolbar.range)}i.preventDefault(),i.stopPropagation();break}else if(o==="indent"){if(e.toolbar.range){const r=B(e.toolbar.range.startContainer);r&&Vh(e,[r.parentElement],e.toolbar.range)}i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),n.addEventListener("mouseleave",()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mousewheel",i=>{this.element.scrollLeft=this.element.scrollLeft+i.deltaY},{passive:!0})}startRecord(e){this.messageId=de(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),At(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});Ai(e,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(e){const n=new dt(p.MENU_BREADCRUMB_MOBILE_PATH);let a;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?a=Ln(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:a=B(s.startContainer)}a||(a=Ln(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const i=a.getAttribute("data-node-id");A("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(l=>{let o=!1;(!e.block.showAll&&l.id===e.block.parentID||e.block.showAll&&l.id===e.block.id)&&(o=!0),n.addItem({current:o,icon:la(l.type,l.subType),label:l.name,click(){dn({protyle:e,id:l.id})}})}),n.fullscreen()})}toggleExit(e){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');e?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(e,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BREADCRUMB_MORE){window.siyuan.menus.menu.remove();return}let a;const i=B(ke(e.element).startContainer);i&&(a=i.getAttribute("data-node-id")),A("/api/block/getTreeStat",{id:a||(e.block.showAll?e.block.id:e.block.rootID)},s=>{var l,o,r,c;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BREADCRUMB_MORE),!e.contentElement.classList.contains("fn__none")&&!e.disabled){let u="";u='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?u+=` accept="${e.options.upload.accept}">`:u+=">";const m=new N({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${u}`}).element;m.querySelector("input").addEventListener("change",f=>{f.target.files.length!==0&&(Ai(e,f.target.files,f.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(m),!ht()&&!bt()&&window.siyuan.menus.menu.append(new N({id:(l=this.mediaRecorder)!=null&&l.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(o=this.mediaRecorder)!=null&&o.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>o1(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(f=>{this.mediaRecorder=new i1(f),this.mediaRecorder.recorder.onaudioprocess=g=>{if(!this.mediaRecorder.isRecording)return;const h=g.inputBuffer.getChannelData(0),b=g.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(h,b)},this.startRecord(e)}).catch(()=>{de(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),At(this.messageId);const f=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});Ai(e,[f])}else At(this.messageId),this.startRecord(e)})}).element)}if(e.disabled||(window.siyuan.menus.menu.append(new N({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){Gf(e,"Img")}}).element),window.siyuan.menus.menu.append(new N({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){Gf(e,"Assets")}}).element),window.siyuan.menus.menu.append(new N({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){as()||Re("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{A("/api/asset/uploadCloud",{id:e.block.id})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new N({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){Re("\u{1F929} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip.replace("${accountServer}",Fn("")),()=>{A("/api/export/export2Liandi",{id:e.block.parentID})})}}).element)),(r=e.scroll)!=null&&r.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new N({id:"keepLazyLoad",current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{Ei(e,!Y())}}).element),e.disabled||window.siyuan.menus.menu.append(new N({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{ce(["toolbar"],e),A("/api/format/autoSpace",{id:e.block.rootID})}}).element),window.siyuan.menus.menu.append(new N({id:"fullscreen",icon:e.element.className.includes("fullscreen")?"iconFullscreenExit":"iconFullscreen",accelerator:window.siyuan.config.keymap.editor.general.fullscreen.custom,label:window.siyuan.languages.fullscreen,click:()=>{kl(e.element),mn(e)}}).element),window.siyuan.menus.menu.append(new N({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{ql(e,"wysiwyg"),e.scroll.lastScrollTop=0,A("/api/filetree/getDoc",{id:e.block.id,size:e.block.id===e.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.SIZE_GET_MAX},u=>{kt({data:u,protyle:e,action:e.block.id===e.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML,p.CB_GET_UNUNDO]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_UNUNDO,p.CB_GET_HTML]})}),bn()}},{id:"preview",current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{ql(e,"preview"),window.siyuan.menus.menu.remove(),bn()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const u=e.wysiwyg.element.getAttribute(p.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new N({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:u==="true",label:window.siyuan.languages.enable,click(){A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!u||u==="false",label:window.siyuan.languages.disable,click(){A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}if(!e.disabled){const u=e.wysiwyg.element.getAttribute(p.CUSTOM_SY_FULLWIDTH);window.siyuan.menus.menu.append(new N({id:"fullWidth",label:window.siyuan.languages.fullWidth,icon:"iconDock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:u==="true",label:window.siyuan.languages.enable,click(){A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.CUSTOM_SY_FULLWIDTH]:"true"}})}},{id:"disable",iconHTML:"",current:u==="false",label:window.siyuan.languages.disable,click(){A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.CUSTOM_SY_FULLWIDTH]:"false"}})}},{id:"default",iconHTML:"",current:!u,label:window.siyuan.languages.default,click(){A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.CUSTOM_SY_FULLWIDTH]:""}})}}]}).element)}(c=e==null?void 0:e.app)!=null&&c.plugins&&zn({plugins:e.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:e,data:s.data.stat},separatorPosition:"top"}),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.refCount}</div><div class="fn__flex">${window.siyuan.languages.blockCount}<span class="fn__space fn__flex-1"></span>${s.data.stat.blockCount}</div>`}).element),window.siyuan.menus.menu.popup(n);const d=He(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app")})}render(e,n=!1,a){var i;let s,l;a&&!a.classList.contains("list")?l=a:getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0),!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?e.element.id==="searchPreview"?l=B(e.wysiwyg.element.querySelector('[data-type="search-mark"]')):l=Ln(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:l=B(s.startContainer)),l||(l=Ln(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const o=l.getAttribute("data-node-id");if(o===this.id&&!n){e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(d=>{d.classList.remove("protyle-breadcrumb__item--active")});const c=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);c&&c.classList.add("protyle-breadcrumb__item--active");return}this.id=o;const r=[];(i=this.element.parentElement)!=null&&i.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&r.push("NodeTextMark-mark"),A("/api/block/getBlockBreadcrumb",{id:o,excludeTypes:r},c=>{let d="";c.data.forEach((u,m)=>{let f=!1;(!e.block.showAll&&u.id===e.block.parentID||e.block.showAll&&u.id===e.block.id)&&(f=!0),m===0&&!e.options.render.breadcrumbDocName?d+=`<span class="protyle-breadcrumb__item${f?" protyle-breadcrumb__item--active":""}" data-node-id="${u.id}"${c.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${u.id}"><use xlink:href="#${la(u.type,u.subType)}"></use></svg>
</span>`:d+=`<span class="protyle-breadcrumb__item${f?" protyle-breadcrumb__item--active":""}" data-node-id="${u.id}"${c.data.length===1||m===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${u.id}"><use xlink:href="#${la(u.type,u.subType)}"></use></svg>
    ${u.name?`<span class="protyle-breadcrumb__text" title="${u.name}">${u.name}</span>`:""}
</span>`,m!==c.data.length-1&&(d+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.innerHTML=d,cb(this.element.parentElement)})}hide(){Y()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}const dS=t=>t.replace(/\u00a0/g," ");var py=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class c1{constructor(e){var n;if(this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),(n=e.options.render)!=null&&n.titleShowTop)this.element.innerHTML='<div class="protyle-attr"></div>';else{this.element.innerHTML=`<span aria-label="${Mt()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}" data-position="west" class="protyle-title__icon ariaLabel"><svg><use xlink:href="#iconFile"></use></svg></span>
<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}" class="protyle-title__input" data-tip="${window.siyuan.languages._kernel[16]}"> </div><div class="protyle-attr"></div>`,this.editElement=this.element.querySelector(".protyle-title__input"),this.editElement.addEventListener("paste",i=>{i.stopPropagation(),i.preventDefault();let s=i.clipboardData.getData("text/siyuan");if(s){try{JSON.parse(s),s=i.clipboardData.getData("text/plain")}catch(l){}s=e.lute.BlockDOM2Content(s)}else s=i.clipboardData.getData("text/plain");setTimeout(function(){document.execCommand("insertText",!1,oa(s))},0),this.rename(e)}),this.editElement.addEventListener("click",()=>{var i;(i=e.toolbar)==null||i.element.classList.add("fn__none")}),this.editElement.addEventListener("input",i=>{i.isComposing||(this.editElement.textContent===""&&this.editElement.querySelectorAll("br").forEach(s=>{s.remove()}),this.rename(e))}),this.editElement.addEventListener("compositionend",()=>{this.rename(e)}),this.editElement.addEventListener("drop",i=>{i.stopPropagation(),i.preventDefault()}),this.editElement.addEventListener("keydown",i=>py(this,null,function*(){if(!i.isComposing){if(Sv(e,i))return!0;if(W("\u21E7\u2318V",i)){i.preventDefault(),i.stopPropagation();let s=(yield Bo())||"";if(s){s=s.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),Lc(e);let l=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(s));Fo(e),l=l.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,oa(l)),this.rename(e)}return}if(W(window.siyuan.config.keymap.general.enterBack.custom,i)){const s=e.path.split("/");s.length>2&&ve({app:e.app,id:s[s.length-2],action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]}),i.preventDefault(),i.stopPropagation();return}if(!ai(i))if(i.key==="ArrowDown"){const s=getSelection().getRangeAt(0).getClientRects();if(s.length===0||this.editElement.getBoundingClientRect().bottom-s[s.length-1].bottom<25){const l=Ln(e.wysiwyg.element.firstElementChild);l&&oe(l,e.wysiwyg.element),i.preventDefault(),i.stopPropagation()}}else if(i.key==="Enter"){const s=fe(e.wysiwyg.element.firstElementChild);if(s&&s.textContent===""&&s.getAttribute("placeholder"))oe(e.wysiwyg.element.firstElementChild,e.wysiwyg.element);else{const l=Lute.NewNodeID(),o=jn(!1,!0,l);e.wysiwyg.element.insertAdjacentElement("afterbegin",o),we(o,e.toolbar.range||ke(o)),V(e,[{action:"insert",data:o.outerHTML,id:l,parentID:e.block.parentID}],[{action:"delete",id:l}])}i.preventDefault(),i.stopPropagation()}else W(window.siyuan.config.keymap.editor.general.attr.custom,i)?(A("/api/block/getDocInfo",{id:e.block.rootID},s=>{fa(s.data.ial,"bookmark",e)}),i.preventDefault(),i.stopPropagation()):W("\u2318A",i)&&(ke(this.editElement).selectNodeContents(this.editElement),i.preventDefault(),i.stopPropagation())}}));const a=this.element.querySelector(".protyle-title__icon");a.addEventListener("click",i=>{if(i.shiftKey)A("/api/block/getDocInfo",{id:e.block.rootID},s=>{fa(s.data.ial,"bookmark",e)});else{const s=a.getBoundingClientRect();fy(e,{x:s.left,y:s.bottom},p.MENU_FROM_TITLE_PROTYLE)}}),this.element.addEventListener("contextmenu",i=>{var s;if(i.shiftKey)return;if(getSelection().rangeCount===0||a.contains(i.target)){fy(e,{x:i.clientX,y:i.clientY},p.MENU_FROM_TITLE_PROTYLE);return}(s=e.toolbar)==null||s.element.classList.add("fn__none"),window.siyuan.menus.menu.remove();const l=ke(this.editElement);l.toString()!==""&&(window.siyuan.menus.menu.append(new N({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click:()=>{ne(ke(this.editElement)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new N({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click:()=>{ne(ke(this.editElement)),document.execCommand("cut"),setTimeout(()=>{this.rename(e)},p.TIMEOUT_INPUT)}}).element),window.siyuan.menus.menu.append(new N({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:()=>{const o=ke(this.editElement);o.extractContents(),ne(o),setTimeout(()=>{this.rename(e)},p.TIMEOUT_INPUT)}}).element)),window.siyuan.menus.menu.append(new N({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click:()=>py(this,null,function*(){if(ne(ke(this.editElement)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const o=(yield Bo())||"";document.execCommand("insertText",!1,oa(o)),this.rename(e)}catch(o){console.log(o)}})}).element),window.siyuan.menus.menu.append(new N({id:"pasteAsPlainText",label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click:()=>py(this,null,function*(){let o=(yield Bo())||"";o=o.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),Lc(e);let r=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(o));Fo(e),r=r.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,oa(r)),this.rename(e)})}).element),window.siyuan.menus.menu.append(new N({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click:()=>{l.selectNodeContents(this.editElement),ne(l)}}).element),window.siyuan.menus.menu.popup({x:i.clientX,y:i.clientY})})}this.element.querySelector(".protyle-attr").addEventListener("click",a=>{A("/api/block/getDocInfo",{id:e.block.rootID},i=>{lS(a,e,i.data.ial)})})}rename(e){if(clearTimeout(this.timeout),!Ff(this.editElement.textContent,this.editElement)){const n=_t(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,p.SIZE_TITLE)),ha(this.editElement,n.start,n.end),!1}cn(),this.timeout=window.setTimeout(()=>{const n=oa(this.editElement.textContent);if(A("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n}),n!==this.editElement.textContent){const a=_t(this.editElement);this.setTitle(n),ha(this.editElement,a.start,a.end)}gd(n)},p.TIMEOUT_INPUT)}setTitle(e){dS(e)!==dS(this.editElement.textContent)&&(this.editElement.textContent=e===window.siyuan.languages.untitled?"":e)}render(e,n){var a;if(e.options.render.hideTitleOnZoom&&(e.block.showAll?this.element.classList.add("fn__none"):this.element.classList.remove("fn__none")),this.element.getAttribute("data-render")==="true"&&this.element.dataset.nodeId===e.block.rootID)return!1;this.element.setAttribute("data-node-id",e.block.rootID),n.data.ial[p.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(p.CUSTOM_RIFF_DECKS,n.data.ial[p.CUSTOM_RIFF_DECKS]),(a=e.background)==null||a.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(n.data.ial.title);let i="";if(n.data.ial.bookmark&&(i+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(n.data.ial.bookmark)}</div>`),n.data.ial.name&&(i+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.name)}</div>`),n.data.ial.alias&&(i+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.alias)}</div>`),n.data.ial.memo&&(i+=`<div class="protyle-attr--memo ariaLabel" aria-label="${Lute.EscapeHTMLStr(n.data.ial.memo)}" data-position="north"><svg><use xlink:href="#iconM"></use></svg></div>`),n.data.ial["custom-avs"]){let s="";n.data.attrViews.forEach(l=>{s+=`<span data-av-id="${l.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${l.name}</span>&nbsp;`}),s&&(s=s.substring(0,s.length-6)),i+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${s}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=i,n.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${n.data.refCount}</div>`),this.editElement&&new Date().getTime()-Q(n.data.id.split("-")[0]).toDate().getTime()<2e3){const s=this.editElement.ownerDocument.createRange();s.selectNodeContents(this.editElement),ne(s)}}}var uS=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const tg=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"];class d1{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel b3-form__upload" type="file"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips b3-chips__doctag fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",n=>uS(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>uS(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&Ai(e,[n.dataTransfer.files[0]],void 0,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let l=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(l=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=o=>{this.imgElement.style.objectPosition=`center ${((a-o.clientY)/s*100+l).toFixed(2)}%`,n.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&Ai(e,n.target.files,n.target,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(bc(),n=>{let a=n.target;for(ce(["gutter"],e);a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type");if(a.tagName==="IMG"&&a.parentElement.classList.contains("protyle-background__img")){const s=a.getAttribute("src");n.detail>1&&!s.startsWith("data:image/png;base64")&&(kp([s]),n.preventDefault(),n.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(i==="position"&&!e.disabled){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const l=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=l,A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":l}})}else this.render(this.ial,e.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(i==="open-emoji"&&!e.disabled){const s=this.iconElement.getBoundingClientRect();Xa(e.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width},void 0,a.querySelector("img")),n.preventDefault(),n.stopPropagation();break}else if(i==="show-random"&&!e.disabled){let s="";tg.forEach((o,r)=>{s+=`<div data-index="${r}" style="height: 128px;${o}" class="b3-card b3-card--wrap"></div>`});const l=new $e({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${s}</div>`,width:Y()?"92vw":"912px",height:Y()?"80vh":"70vh"});l.element.setAttribute("data-key",p.DIALOG_BACKGROUNDRANDOM),l.element.addEventListener("click",o=>{const r=o.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=tg[parseInt(r.getAttribute("data-index"))],this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),l.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(i==="random"&&!e.disabled){this.ial["title-img"]=tg[ye(0,tg.length-1)],this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(i==="asset"&&!e.disabled){const s=a.getBoundingClientRect();Oh(e,{x:a.parentElement.getBoundingClientRect().right,y:s.bottom+8,isLeft:!0},l=>{this.ial["title-img"]=`background-image:url("${l}")`,this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}})},p.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(i==="remove"&&!e.disabled){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(i==="icon"&&!e.disabled){const s=V_();if(s){vl(s,e.block.rootID),Nf(s,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:s}}),e.model&&e.model.parent.setDocIcon(s),this.iconElement.classList.remove("fn__none");const l=this.iconElement.getBoundingClientRect();Xa(e.block.rootID,"doc",{x:l.left,y:l.bottom,h:l.height,w:l.width})}n.preventDefault(),n.stopPropagation();break}else if(i==="tag"&&!e.disabled){this.openTag(e,a),n.preventDefault(),n.stopPropagation();break}else if(i==="link"&&!e.disabled){const s=new $e({title:window.siyuan.languages.link,width:Y()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});s.element.setAttribute("data-key",p.DIALOG_BACKGROUNDLINK);const l=s.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{s.destroy()}),l[1].addEventListener("click",()=>{const o=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=o,this.render(this.ial,e.block.rootID),A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(i==="open-search"){Si(e.app,`#${a.textContent}#`,!window.siyuan.ctrlIsPressed,{method:0}),n.preventDefault(),n.stopPropagation();break}else if(i==="remove-tag"&&!e.disabled){a.parentElement.remove(),this.removeTag(e),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}removeTag(e,n){const a=this.getTags();A("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:a.toString()}},()=>{n&&n()}),a.length===0?delete this.ial.tags:this.ial.tags=a.toString(),this.render(this.ial,e.block.rootID)}render(e,n){var a;const i=e["title-img"],s=e.icon,l=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",n),l){let o="";const r=["secondary","primary","info","success","warning","error","pink"];Array.from(new Set(l.split(",").map(c=>c.trim()))).forEach((c,d)=>{c.replace(/ /g,"")&&(o+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[d%7]}" data-type="open-search">${he(c)}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`)}),this.tagsElement.innerHTML=`${o}
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-bottom: 8px" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(s?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=be(s),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),i){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(i)),i.indexOf("url(")>-1){const o=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=o,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop=""}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px";i||s?this.iconElement.parentElement.style.marginTop="":this.iconElement.parentElement.style.marginTop="8px"}openTag(e,n){window.siyuan.menus.menu.remove();const a=new dt;a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:l=>{const o=l.querySelector(".b3-list--background");A("/api/search/searchTag",{k:""},c=>{let d="";const u=this.getTags();c.data.tags.forEach((m,f)=>{d+=`<div class="b3-list-item b3-list-item--narrow${f===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${m}</div>
    ${u.includes(Lute.UnEscapeHTMLStr(m))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`}),o.innerHTML=d});const r=l.querySelector("input");r.addEventListener("keydown",c=>{if(c.stopPropagation(),!c.isComposing)if(xn(o,c),c.key==="Enter"){const d=o.querySelector(".b3-list-item--focus");this.addTags(d?d.dataset.type==="new"?d.querySelector("mark").textContent.trim():d.textContent.trim():r.value.trim(),e,()=>{r.value="",r.dispatchEvent(new CustomEvent("input"))})}else c.key==="Escape"&&window.siyuan.menus.menu.remove()}),r.addEventListener("input",c=>{c.stopPropagation(),A("/api/search/searchTag",{k:r.value.trim()},d=>{let u="",m=!1;const f=this.getTags();d.data.tags.forEach((g,h)=>{u+=`<div class="b3-list-item b3-list-item--narrow${h===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${g}</div>
    ${f.includes(Lute.UnEscapeHTMLStr(g.replace(/<mark>/g,"").replace(/<\/mark>/g,"")))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`,g===`<mark>${d.data.k}</mark>`&&(m=!0)}),!m&&d.data.k&&(u=`<div data-type="new" class="b3-list-item b3-list-item--narrow${u?"":" b3-list-item--focus"}"><div class="fn__flex-1">${window.siyuan.languages.new} <mark>${he(d.data.k)}</mark></div></div>`+u),o.innerHTML=u})}),o.addEventListener("click",c=>{const d=c.target,u=T(d,"b3-list-item");u&&this.addTags(u.dataset.type==="new"?u.querySelector("mark").textContent.trim():u.textContent.trim(),e,()=>{r.value="",r.dispatchEvent(new CustomEvent("input")),r.focus()})})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const s=n.getBoundingClientRect();a.open({x:s.left,y:s.top+s.height}),a.element.querySelector("input").focus()}getTags(e){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(a=>{const i=a.textContent.trim();e&&i===e&&a.remove(),n.push(i)}),n}addTags(e,n,a){const i=this.getTags(e);if(i.includes(e)){this.removeTag(n,a);return}i.push(e),A("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:i.toString()}},()=>{a()}),this.ial.tags=i.toString(),this.render(this.ial,n.block.rootID)}}class ba{constructor(e,n,a){this.version=p.SIYUAN_VERSION;let i=a;e.plugins.forEach(o=>{o.protyleOptions&&(i=cy(i,o.protyleOptions))});const l=new O3(i).merge();if(this.protyle={getInstance:()=>this,app:e,transactionTime:new Date().getTime(),id:ee(),disabled:!1,updated:!1,element:n,options:l,block:{},highlight:{mark:ca()?new Highlight:void 0,markHL:ca()?new Highlight:void 0,ranges:[],rangeIndex:0,styleElement:document.createElement("style")}},ca()){const o=ee();this.protyle.highlight.styleElement.dataset.uuid=o,this.protyle.highlight.styleElement.textContent=`.protyle-content::highlight(search-mark-${o}) {background-color: var(--b3-highlight-background);color: var(--b3-highlight-color);}
  .protyle-content::highlight(search-mark-hl-${o}) {color: var(--b3-highlight-color);background-color: var(--b3-highlight-current-background)}`}if(this.protyle.hint=new $3(this.protyle),l.render.breadcrumb&&(this.protyle.breadcrumb=new r1(this.protyle)),l.render.title&&(this.protyle.title=new c1(this.protyle)),l.render.background&&(this.protyle.background=new d1(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),l.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new yx,this.protyle.wysiwyg=new Y3(this.protyle),this.protyle.toolbar=new t1(this.protyle),this.protyle.scroll=new B3(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new a1(this.protyle)),(l.upload.url||l.upload.handler)&&(this.protyle.upload=new a0),this.init(),l.action.includes(p.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new ia({app:e,id:this.protyle.id,type:"protyle",msgCallback:o=>{var r;switch(o.cmd){case"reload":o.data===this.protyle.block.rootID&&(Ei(this.protyle,!1),Oe().outline.forEach(c=>{c.blockId===o.data&&A("/api/outline/getDocOutline",{id:c.blockId,preview:c.isPreview},d=>{c.update(d)})}));break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`.av[data-av-id="${o.data.id}"]`)).forEach(c=>{c.removeAttribute("data-render"),Vt(c,this.protyle)});break;case"addLoading":o.data===this.protyle.block.rootID&&Rl(this.protyle,o.msg);break;case"unfoldHeading":Wx(o.data,this.protyle);break;case"transactions":this.onTransaction(o);break;case"readonly":window.siyuan.config.editor.readOnly=o.data,qE(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===o.data.srcRootBlockID&&(this.protyle.block.showAll&&o.cmd==="heading2doc"&&!this.protyle.options.backlinkData?A("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{kt({data:c,protyle:this.protyle})}):Ei(this.protyle,!1),o.cmd==="heading2doc"&&fr({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!0,resize:!1}));break;case"rename":this.protyle.path===o.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(o.data.title),this.protyle.background&&(this.protyle.background.ial.title=o.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===o.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&((r=this.protyle.title.editElement)!=null&&r.contains(getSelection().getRangeAt(0).startContainer))||this.protyle.title.setTitle(o.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${o.data.id}"]`).forEach(c=>{c.getAttribute("data-subtype")==="d"&&(c.innerHTML=o.data.refText)});break;case"moveDoc":this.protyle.path===o.data.fromPath&&(this.protyle.path=o.data.newPath,this.protyle.notebookId=o.data.toNotebook);break;case"unmount":this.protyle.notebookId===o.data.box&&this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1);break;case"removeDoc":o.data.ids.includes(this.protyle.block.rootID)&&(this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1),delete window.siyuan.storage[p.LOCAL_FILEPOSITION][this.protyle.block.rootID],Ee(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION]));break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,wE(this.protyle,a.backlinkData),this.protyle.wysiwyg.element.style.padding="4px 16px 4px 24px";return}if(!a.blockId){ad(this.protyle);return}this.protyle.options.mode!=="preview"&&a.rootId&&window.siyuan.storage[p.LOCAL_FILEPOSITION][a.rootId]&&(l.action.includes(p.CB_GET_SCROLL)||l.action.includes(p.CB_GET_ROOTSCROLL)&&a.rootId===a.blockId)?ch({protyle:this.protyle,scrollAttr:window.siyuan.storage[p.LOCAL_FILEPOSITION][a.rootId],mergedOptions:l,cb:()=>{this.afterOnGet(l)}}):this.getDoc(l)}}onTransaction(e){let n="";e.data[0].doOperations.find(a=>{var i;if(!this.protyle.preview.element.classList.contains("fn__none"))this.protyle.preview.render(this.protyle),a.action==="updateAttrs"&&Tp(this.protyle,a,!1);else{if(this.protyle.options.backlinkData&&["delete","move"].includes(a.action))return Oe().backlink.find(s=>{if(s.element.contains(this.protyle.element))return s.refresh(),!0}),!0;Tp(this.protyle,a,!1),a.action==="delete"&&typeof((i=a.data)==null?void 0:i.createEmptyParagraph)=="boolean"&&!a.data.createEmptyParagraph||(n=a.action)}}),this.protyle.wysiwyg.element.childElementCount===0&&this.protyle.block.parentID&&n&&(n==="delete"&&this.protyle.block.showAll?this.protyle.options.handleEmptyContent?this.protyle.options.handleEmptyContent():dn({protyle:this.protyle,id:this.protyle.block.rootID,focusId:this.protyle.block.id}):(this.protyle.undo.clear(),this.reload(!1)))}getDoc(e){var n;A("/api/filetree/getDoc",{id:e.blockId,isBacklink:e.action.includes(p.CB_GET_BACKLINK),originalRefBlockIDs:e.originalRefBlockIDs,mode:e.action&&e.action.includes(p.CB_GET_CONTEXT)?3:0,size:(n=e.action)!=null&&n.includes(p.CB_GET_ALL)?p.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{kt({data:a,protyle:this.protyle,action:e.action,afterCB:()=>{this.afterOnGet(e)}})})}afterOnGet(e){var n,a;this.protyle.model&&(((n=e.action)!=null&&n.includes(p.CB_GET_FOCUS)||(a=e.action)!=null&&a.includes(p.CB_GET_OPENNEW))&&gt(this.protyle.model.element.parentElement.parentElement),fr({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})),mn(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{if(this.protyle&&this.protyle.model){let i=!0;if(this.protyle.model.element.parentElement.parentElement.classList.contains("layout__wnd--active")&&this.protyle.model.headElement.classList.contains("item--focus")&&(i=!1),!i)return;gt(this.protyle.model.element.parentElement.parentElement),fr({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})}else document.querySelectorAll(".layout__tab--active").forEach(i=>{i.classList.remove("layout__tab--active")}),document.querySelectorAll(".layout__wnd--active").forEach(i=>{i.classList.remove("layout__wnd--active")})}),e.after&&e.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=M3({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new H3(this.protyle),iC(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){Hv(this.protyle)}resize(){mn(this.protyle)}reload(e){Ei(this.protyle,e)}insert(e,n=!1,a=!1){Ht(e,this.protyle,n,a)}transaction(e,n){V(this.protyle,e,n)}turnIntoOneTransaction(e,n,a){ga({protyle:this.protyle,selectsElement:e,type:n,level:a})}turnIntoTransaction(e,n,a){ka({protyle:this.protyle,nodeElement:e,type:n,level:a})}updateTransaction(e,n,a){le(this.protyle,e,n,a)}updateBatchTransaction(e,n){Ds(e,this.protyle,n)}getRange(e){return ke(e)}hasClosestBlock(e){return B(e)}focusBlock(e,n=!0){return oe(e,void 0,n)}disable(){Sa(this.protyle)}enable(){nd(this.protyle)}renderAVAttribute(e,n,a){jh(e,n,this.protyle,a)}}class Ot extends ia{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.headElement=e.tab.headElement,this.element=e.tab.panelElement,this.initProtyle(e),A("/api/storage/updateRecentDocOpenTime",{rootID:e.rootId})}initProtyle(e){this.editor=new ba(this.app,this.element,{action:e.action||[],blockId:e.blockId,rootId:e.rootId,mode:e.mode,render:{title:!0,background:!0,scroll:!0},typewriterMode:!0,after:n=>{window.siyuan.editorIsFullscreen&&(kl(n.protyle.element),yb(n.protyle)),Pn([],n.protyle.block.rootID),e.afterInitProtyle&&e.afterInitProtyle(n)}}),this.editor.protyle.model=this}}class Dt{constructor(e){if(this.id=ee(),this.callback=e.callback,e.title||e.icon){this.title=e.title,this.icon=e.icon,this.docIcon=e.docIcon,this.headElement=document.createElement("li"),this.headElement.setAttribute("data-type","tab-header"),this.headElement.setAttribute("draggable","true"),this.headElement.setAttribute("data-id",this.id),this.headElement.classList.add("item","item--focus");let n="";e.icon?n=`<svg class="item__graphic"><use xlink:href="#${e.icon}"></use></svg>`:e.docIcon&&(n=`<span class="item__icon">${be(e.docIcon)}</span>`),this.headElement.innerHTML=`${n}<span class="item__text">${he(e.title)}</span>
<span class="item__close"><svg><use xlink:href="#iconClose"></use></svg></span>`,this.headElement.addEventListener("mouseenter",a=>{var i,s,l;if(a.stopPropagation(),a.preventDefault(),Array.from(this.headElement.parentElement.childNodes).find(c=>{var d;if(((d=c.style)==null?void 0:d.opacity)==="0.38")return!0})){cn();return}let r="";if(this.model instanceof Ot&&((l=(s=(i=this.model.editor)==null?void 0:i.protyle)==null?void 0:s.block)!=null&&l.rootID))r=this.model.editor.protyle.block.rootID;else if(!this.model){const c=JSON.parse(this.headElement.getAttribute("data-initdata")||"{}");c&&c.instance==="Editor"&&(r=c.blockId)}r?A("/api/filetree/getFullHPathByID",{id:r},c=>{this.headElement.getAttribute("aria-label")||wi(_i(c.data),this.headElement),this.headElement.setAttribute("aria-label",_i(c.data))}):this.headElement.setAttribute("aria-label",_i(this.title))}),this.headElement.addEventListener("dragstart",a=>{if(Se()){a.stopPropagation(),a.preventDefault();return}window.getSelection().removeAllRanges(),cn();const i=U(a.target,"LI");if(i){a.dataTransfer.setData("text/html",i.outerHTML);const s={id:this.id};$i(this,s),a.dataTransfer.setData(p.SIYUAN_DROP_TAB,JSON.stringify(s)),a.dataTransfer.dropEffect="move",i.style.opacity="0.38",window.siyuan.dragElement=this.headElement}ipcRenderer.send(p.SIYUAN_SEND_WINDOWS,{cmd:"resetTabsStyle",data:"removeRegionStyle"})}),this.headElement.addEventListener("dragend",a=>{const i=U(a.target,"LI");i&&(i.style.opacity="1"),document.querySelectorAll(".layout-tab-bars--drag").forEach(s=>{s.classList.remove("layout-tab-bars--drag")}),document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(s=>{s.remove()}),window.siyuan.dragElement=void 0,a.dataTransfer.dropEffect==="none"&&this.parent.children.forEach((s,l)=>{const o=this.headElement.parentElement.children[l];s.headElement!==o&&(l===0?this.headElement.parentElement.firstElementChild.before(s.headElement):this.headElement.parentElement.children[l-1].after(s.headElement))}),ipcRenderer.send(p.SIYUAN_SEND_WINDOWS,{cmd:"resetTabsStyle",data:"addRegionStyle"})})}this.panelElement=document.createElement("div"),this.panelElement.classList.add("fn__flex-1"),this.panelElement.innerHTML=e.panel||"",this.panelElement.setAttribute("data-id",this.id)}updateTitle(e){this.title=e,this.headElement.querySelector(".item__text").innerHTML=he(e)}addModel(e){this.model=e,e.parent=this}pin(){if(!(!this.headElement.previousElementSibling||this.headElement.previousElementSibling&&this.headElement.previousElementSibling.classList.contains("item--pin"))){let e,n=0,a;this.parent.children.find((i,s)=>{if(i.headElement.classList.contains("item--pin")&&(n=s+1,a=i.headElement),i.id===this.id)return e=this.parent.children.splice(s,1)[0],!0}),a?a.after(e.headElement):this.parent.children[0].headElement.before(e.headElement),this.parent.children.splice(n,0,e)}this.headElement.classList.add("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.add("fn__none"),bn()}setDocIcon(e){var n;if(this.docIcon=e,this.docIcon){const a=this.headElement.querySelector(".item__icon");a?a.innerHTML=be(e):this.headElement.querySelector(".item__text").insertAdjacentHTML("beforebegin",`<span class="item__icon">${be(e)}</span>`),this.headElement.classList.contains("item--pin")&&this.headElement.querySelector(".item__text").classList.add("fn__none")}else(n=this.headElement.querySelector(".item__icon"))==null||n.remove(),this.headElement.querySelector(".item__text").classList.remove("fn__none")}unpin(){if(!(!this.headElement.nextElementSibling||this.headElement.nextElementSibling&&!this.headElement.nextElementSibling.classList.contains("item--pin"))){let e,n=0,a;for(let i=0;i<this.parent.children.length;i++)this.parent.children[i].id===this.id&&(e=this.parent.children.splice(i,1)[0],i--),i>-1&&this.parent.children[i].headElement.classList.contains("item--pin")&&(n=i+1,a=this.parent.children[i].headElement);a.after(e.headElement),this.parent.children.splice(n,0,e)}this.headElement.classList.remove("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.remove("fn__none"),bn()}close(){this.parent.removeTab(this.id)}}var u1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const yd=(t,e,n,a="viewedAt")=>u1(void 0,null,function*(){let i="",s=0;[...t].sort((d,u)=>{const m=d[a]||0;return(u[a]||0)-m}).forEach(d=>{(!n||d.title.toLowerCase().includes(n.toLowerCase()))&&(i+=`<li data-index="${s}" data-node-id="${d.rootID}" class="b3-list-item${s===0?" b3-list-item--focus":""}">
${be(d.icon||window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${he(d.title)}</span>
</li>`,s++)});let o="";if(i){const d=yield Ae("/api/filetree/getFullHPathByID",{id:t[0].rootID});o=he(d.data)}let r="";if(!ue()){r='<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">',(!n||window.siyuan.languages.riffCard.toLowerCase().includes(n.toLowerCase()))&&(r+=`<li data-type="riffCard" data-index="0" class="b3-list-item${o?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${pe(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,o||(o=window.siyuan.languages.riffCard));let d=1;zp().forEach(u=>{(!n||u.title.toLowerCase().includes(n.toLowerCase()))&&(r+=`<li data-type="${u.type}" data-index="${d}" class="b3-list-item${o?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#${u.icon}"></use></svg>
    <span class="b3-list-item__text">${u.title}</span>
    <span class="b3-list-item__meta">${pe(u.hotkey||"")}</span>
</li>`,d++,o||(o=window.siyuan.languages.riffCard))}),r=r+"</ul>"}const c=e.querySelector(".switch-doc__path");c.innerHTML=o,c.previousElementSibling.innerHTML=`<div class="fn__flex fn__flex-1" style="overflow:auto;">
        ${r}
        <ul style="${ue()?"border-left:0;":""}min-width:360px;" class="b3-list b3-list--background fn__flex-1">${i}</ul>
    </div>`}),ng=()=>{if(window.siyuan.dialogs.find(e=>{if(e.element.getAttribute("data-key")===p.DIALOG_RECENTDOCS)return!0})){ce(["dialog"]);return}A("/api/storage/getRecentDocs",{sortBy:"viewedAt"},e=>{let n;getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0));const a=new $e({positionId:p.DIALOG_RECENTDOCS,title:`<div class="fn__flex">
<div class="fn__flex-center">${window.siyuan.languages.recentDocs}</div>
<div class="fn__flex-1"></div>
<div class="b3-form__icon fn__size200">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input">
</div>
<span class="fn__space"></span>
<div class="fn__flex-center">
    <select class="b3-select" id="recentDocsSort">
        <option value="viewedAt"${window.siyuan.storage[p.LOCAL_RECENT_DOCS].type==="viewedAt"?" selected":""}>${window.siyuan.languages.recentViewed}</option>
        <option value="updated"${window.siyuan.storage[p.LOCAL_RECENT_DOCS].type==="updated"?" selected":""}>${window.siyuan.languages.recentModified}</option>
        <option value="openAt"${window.siyuan.storage[p.LOCAL_RECENT_DOCS].type==="openAt"?" selected":""}>${window.siyuan.languages.recentOpened}</option>
        <option value="closedAt"${window.siyuan.storage[p.LOCAL_RECENT_DOCS].type==="closedAt"?" selected":""}>${window.siyuan.languages.recentClosed}</option>
    </select>
</div>
</div>`,content:`<div class="fn__flex-column switch-doc">
    <div class="fn__flex fn__flex-1" style="overflow:auto;"></div>
    <div class="switch-doc__path"></div>
</div>`,height:"80vh",destroyCallback:()=>{n&&n.getBoundingClientRect().height!==0&&ne(n)}}),i=a.element.querySelector("input");i.focus(),i.addEventListener("compositionend",()=>{yd(e.data,a.element,i.value,s.value)}),i.addEventListener("input",l=>{l.isComposing||yd(e.data,a.element,i.value,s.value)}),a.element.setAttribute("data-key",p.DIALOG_RECENTDOCS),a.element.addEventListener("click",l=>{const o=T(l.target,"b3-list-item");o&&(a.element.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),window.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter"})),l.stopPropagation(),l.preventDefault())});const s=a.element.querySelector("#recentDocsSort");s.addEventListener("change",()=>{s.value==="updated"?Ae("/api/query/sql",{stmt:"SELECT * FROM blocks WHERE type = 'd' ORDER BY updated DESC LIMIT 33"}).then(o=>{if(o.data&&o.data.length>0){const r=o.data.map(c=>{let d="";if(c.ial){const u=c.ial.match(/icon="([^"]*)"/);u&&(d=u[1])}return{rootID:c.id,icon:d,title:c.content,updated:c.updated}});yd(r,a.element,i.value,"updated")}}):A("/api/storage/getRecentDocs",{sortBy:s.value},l=>{yd(l.data,a.element,i.value,s.value)}),window.siyuan.storage[p.LOCAL_RECENT_DOCS].type=s.value,Ee(p.LOCAL_RECENT_DOCS,window.siyuan.storage[p.LOCAL_RECENT_DOCS])}),yd(e.data,a.element)})};var f1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const ya=(t=!0)=>{const e=document.querySelector(".layout__wnd--active .item--focus");let n;return e&&(n=on(e.getAttribute("data-id"))),!n&&!t&&pi().find(a=>{var i;(i=a.headElement)!=null&&i.classList.contains("item--focus")&&(n=a)}),n},sn=t=>{var e;const n=document.querySelector(".dock .dock__item--activefocus");if(n){let i=n.parentElement.children[t];t===-1?(i=n.parentElement.lastElementChild,i.getAttribute("data-type")||(i=i.previousElementSibling)):t===-2?(i=n.previousElementSibling,i||(i=n.parentElement.lastElementChild,i.classList.contains("dock__item--pin")&&(i=i.previousElementSibling))):t===-3&&(i=n.nextElementSibling,(!i||i.classList.contains("dock__item--pin"))&&(i=n.parentElement.firstElementChild));const s=i==null?void 0:i.getAttribute("data-type");s&&((e=nt(s))==null||e.toggleModel(s,!0,!1));return}const a=ya(!1);if(a){let i=a.parent.headersElement.children[t];t===-1?i=a.parent.headersElement.lastElementChild:t===-2?(i=a.headElement.previousElementSibling,i||(i=a.headElement.parentElement.lastElementChild)):t===-3&&(i=a.headElement.nextElementSibling,i||(i=a.headElement.parentElement.firstElementChild)),i&&(a.parent.switchTab(i,!0),a.parent.showHeading())}};let fS;const Sn=(t=!0)=>{clearTimeout(fS),fS=window.setTimeout(()=>{const e=Oe();e.editor.forEach(n=>{n.editor&&n.editor.protyle&&n.element.parentElement&&!n.element.classList.contains("fn__none")&&n.editor.resize()}),e.backlink.forEach(n=>{const a=n.element.querySelector(".backlinkMList");a.style.height&&a.style.height!=="0px"&&n.element.clientHeight!==0&&(a.style.height=n.element.clientHeight-a.previousElementSibling.clientHeight*2+"px"),n.editors.forEach(i=>{ce(["gutter"],i.protyle),i.resize()})}),e.search.forEach(n=>{n.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?n.editors.edit.resize():n.editors.unRefEdit.resize()}),e.custom.forEach(n=>{n.resize&&n.resize()}),kx(),_s(["gutter"]),t&&bn()},200)},nt=t=>{if(window.siyuan.layout.leftDock){if(window.siyuan.layout.leftDock.data[t])return window.siyuan.layout.leftDock;if(window.siyuan.layout.rightDock.data[t])return window.siyuan.layout.rightDock;if(window.siyuan.layout.bottomDock.data[t])return window.siyuan.layout.bottomDock}},pS=t=>new Dt({panel:`<div class="layout__empty">
        <div class="${window.siyuan.config.readonly?"":" fn__none"}">
            <div class="config-about__logo">
                <img src="/stage/icon.png">
                ${window.siyuan.languages.siyuanNote}
            </div>
            <div class="b3-label__text">${window.siyuan.languages.slogan}</div>
        </div>
        <div class="fn__hr"></div>
    <div class="b3-list" style="margin: 0 auto">
        <div class="b3-list-item" id="editorEmptySearch">
            <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg>
            <span>${window.siyuan.languages.search}</span>
            <span class="b3-list-item__meta">${pe(window.siyuan.config.keymap.general.globalSearch.custom)}</span>
        </div>
        <div id="editorEmptyRecent" class="b3-list-item">
            <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg>
            <span>${window.siyuan.languages.recentDocs}</span>
            <span class="b3-list-item__meta">${pe(window.siyuan.config.keymap.general.recentDocs.custom)}</span>
        </div>
        <div id="editorEmptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
            <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg>
            <span>${window.siyuan.languages.dataHistory}</span>
            <span class="b3-list-item__meta">${pe(window.siyuan.config.keymap.general.dataHistory.custom)}</span>
        </div>
        <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyFile">
            <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
            <span>${window.siyuan.languages.newFile}</span>
            <span class="b3-list-item__meta">${pe(window.siyuan.config.keymap.general.newFile.custom)}</span>
        </div>
        <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyNewNotebook">
            <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg>
            <span>${window.siyuan.languages.newNotebook}</span>
        </div>
        <div class="b3-list-item${Ha()||window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyHelp">
            <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg>
            <span>${window.siyuan.languages.userGuide}</span>
        </div>
    </div>
</div>`,callback(e){e.panelElement.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e.panelElement);){if(a.id==="editorEmptySearch"){Hn({app:t,hotkey:p.DIALOG_GLOBALSEARCH}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyRecent"){ng(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyHistory"){pp(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyFile"){ki({app:t,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyNewNotebook"){Zw(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyHelp"){rp(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}})}}),ag=(t,e)=>new Dt({icon:e.icon,docIcon:e.docIcon,title:e.title,callback(n){let a;if(e.model instanceof Ot){const i=[];e.model.editor.protyle.block.action.forEach(s=>{s!==p.CB_GET_APPEND&&s!==p.CB_GET_BEFORE&&s!==p.CB_GET_HTML&&i.push(s)}),a=new Ot({app:t,tab:n,blockId:e.model.editor.protyle.block.id,rootId:e.model.editor.protyle.block.rootID,action:i,afterInitProtyle(s){var l;if(e.model instanceof Ot){const o=e.model.editor.protyle.wysiwyg.element.querySelector("[data-resize-top]");if(o){const r=s.protyle.wysiwyg.element.querySelector(`[data-node-id="${o.getAttribute("data-node-id")}"]`);r&&((l=s.protyle.observerLoad)==null||l.disconnect(),r.scrollIntoView(),s.protyle.contentElement.scrollTop+=parseInt(o.getAttribute("data-resize-top")))}}}})}else if(e.model instanceof ts)a=new ts({app:t,tab:n,path:e.model.path});else if(e.model instanceof Ii)a=new Ii({app:t,tab:n,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof Ki)a=new Ki({app:t,tab:n});else if(e.model instanceof Is)a=new Is({app:t,tab:n,blockId:e.model.blockId,type:e.model.type,isPreview:e.model.isPreview});else if(e.model instanceof Zi)a=new Zi({app:t,tab:n,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof Wl)a=new Wl(t,n);else if(e.model instanceof Ps)a=new Ps(t,n);else if(e.model instanceof ns)a=new ns({app:t,tab:n,config:e.model.config});else if(e.model instanceof fi){const i=e.model;i.type==="siyuan-card"?a=Jb({app:t,tab:n,data:i.data}):t.plugins.find(s=>{if(s.models[i.type])return a=s.models[i.type]({tab:n,data:i.data}),!0})}else if(!e.model&&e.headElement){const i=JSON.parse(e.headElement.getAttribute("data-initdata")||"{}");i&&(a=qS(t,n,i))}n.addModel(a)}}),is=(t,e,n)=>f1(void 0,null,function*(){if(e==="closeOthers")for(let a=0;a<t.parent.children.length;a++)t.parent.children[a].id!==t.id&&!t.parent.children[a].headElement.classList.contains("item--pin")&&(yield t.parent.children[a].parent.removeTab(t.parent.children[a].id,!0,!1),a--);else if(e==="closeAll")for(let a=0;a<t.parent.children.length;a++)t.parent.children[a].headElement.classList.contains("item--pin")||(yield t.parent.children[a].parent.removeTab(t.parent.children[a].id,!0),a--);else if(n.length>0)for(let a=0;a<n.length;a++)n[a].headElement.classList.contains("item--pin")||(yield n[a].parent.removeTab(n[a].id));t.headElement.parentElement&&!t.headElement.parentElement.querySelector(".item--focus")?t.parent.switchTab(t.headElement,!0):t.parent.children.length>0&&t.parent.switchTab(t.parent.children[t.parent.children.length-1].headElement,!0)});class Ua{constructor(e){const n=Object.assign({direction:"tb",size:"auto",type:"normal"},e);this.id=ee(),this.direction=n.direction,this.type=n.type,this.size=n.size,this.resize=e.resize,this.children=[],this.element=e.element||document.createElement("div"),this.type==="center"&&this.element.classList.add("layout__center"),n.direction==="tb"?this.element.classList.add("fn__flex-column"):this.element.classList.add("fn__flex")}addLayout(e,n){n?this.children.find((a,i)=>{if(a.id===n)return this.children.splice(i+1,0,e),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this&&this.element.append(e.element)),e.size==="auto"?e.element.classList.add("fn__flex-1"):e.element.style[this&&this.direction==="lr"?"width":"height"]=e.size,FS(e),e.parent=this}addWnd(e,n){n?this.children.find((a,i)=>{if(a.id===n)return this.children.splice(i+1,0,e),this.direction==="lr"&&a.element.querySelectorAll(".protyle-content").forEach(s=>{s.parentElement.classList.contains("fn__none")||(s.classList.remove("protyle-content--transition"),s.querySelector(".protyle-wysiwyg").style.padding="",s.classList.add("protyle-content--transition"))}),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this.element.append(e.element)),n&&Ty(this),FS(e),Sn(!1),e.parent=this}}var p1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class g1 extends ia{constructor(e,n){super({app:e,id:n.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},n instanceof Element?this.element=n:this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__inbox"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconInbox"></use></svg>${window.siyuan.languages.inbox}&nbsp;
        <span class="inboxSelectCount"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="selectall" class="block__icon"><svg><use xlink:href="#iconUncheck"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="previous" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="next" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="more" data-menu="true" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href="#iconMin"></use></svg></span>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto;background-color: var(--b3-theme-background)"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),i=this.element.querySelector(".inboxDetails"),s=this.element.firstElementChild.querySelector('[data-type="selectall"]');this.element.lastElementChild.addEventListener("contextmenu",l=>{const o=T(l.target,"b3-list-item");o&&this.more(l,o)}),this.element.addEventListener("click",l=>{gt(this.element);let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){l.stopPropagation();break}const r=o.getAttribute("data-type");if(r==="min"){nt("inbox").toggleModel("inbox",!1,!0),l.preventDefault();break}else if(r==="selectall"){const c=o.querySelector("use");c.getAttribute("xlink:href")==="#iconUncheck"?(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(d=>{d.querySelector("use").setAttribute("xlink:href","#iconCheck"),this.selectIds.push(d.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}),c.setAttribute("xlink:href","#iconCheck")):(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(d=>{d.querySelector("use").setAttribute("xlink:href","#iconUncheck"),this.selectIds.splice(this.selectIds.indexOf(d.getAttribute("data-id")),1)}),c.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),l.stopPropagation();break}else if(r==="select"){const c=o.querySelector("use");c.getAttribute("xlink:href")==="#iconUncheck"?(this.selectIds.push(o.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)],c.setAttribute("xlink:href","#iconCheck")):(this.selectIds.splice(this.selectIds.indexOf(o.parentElement.getAttribute("data-id")),1),c.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,s.querySelector("use").setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length?"#iconCheck":"#iconUncheck"),window.siyuan.menus.menu.remove(),l.stopPropagation();break}else if(r==="previous"){o.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),l.preventDefault();break}else if(r==="next"){o.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),l.preventDefault();break}else if(r==="back"){this.back(),l.preventDefault();break}else if(r==="more"){this.more(l),l.stopPropagation(),l.preventDefault();break}else if(o.classList.contains("b3-list-item")){const c=this.data[o.getAttribute("data-id")];s.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),i.innerHTML=this.genDetail(c),i.setAttribute("data-id",c.oId),i.classList.remove("fn__none"),i.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),l.preventDefault();break}o=o.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector('[data-type="selectall"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(e){let n="";return e.shorthandURL&&(n=`<span class="fn__space"></span><a href="${e.shorthandURL}" target="_blank" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.link}">
        <svg><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="block__icons">
    <div class="block__logo fn__pointer fn__flex-1" data-type="back">
        <svg class="block__logoicon"><use xlink:href="#iconLeft"></use></svg><span class="ft__breakword">${e.shorthandTitle}</span>
    </div>
    ${n}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px;user-select: text" data-type="textMenu">
${e.shorthandContent}
</div>`}genItemHTML(e){return`<li style="padding-left: 0" data-id="${e.oId}" class="b3-list-item">
    <span data-type="select" class="b3-list-item__action">
        <svg><use xlink:href="#icon${this.selectIds.includes(e.oId)?"Check":"Uncheck"}"></use></svg> 
    </span>
    <span class="fn__space--small"></span>
    <span class="b3-list-item__text" title="${e.shorthandTitle}${e.shorthandTitle===e.shorthandDesc?"":`
`+e.shorthandDesc}">${e.shorthandTitle}</span>
    <span class="b3-list-item__meta">${e.hCreated}</span>
</li>`}more(e,n){const a=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{n?A("/api/inbox/getShorthand",{id:n.dataset.id},s=>{this.data[s.data.oId]=s.data,n.outerHTML=this.genItemHTML(s.data)}):a.classList.contains("fn__none")?(this.currentPage=1,this.update()):A("/api/inbox/getShorthand",{id:a.getAttribute("data-id")},s=>{this.data[s.data.oId]=s.data,a.innerHTML=this.genDetail(s.data),a.scrollTop=0})}}).element);let i=[];n?i=[n.dataset.id]:a.classList.contains("fn__none")?i=this.selectIds:i=[a.getAttribute("data-id")],i.length>0&&(window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(i)}}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{let s="";i.forEach((l,o)=>{s+='<code class="fn__code">'+he(this.data[l].shorthandTitle)+"</code>"+(o===i.length-1?"":", ")}),Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} ${s}?`,()=>{n?this.remove([n.dataset.id]):a.classList.contains("fn__none")?this.remove():this.remove([a.getAttribute("data-id")])},void 0,!0)}}).element)),this.app.plugins&&zn({plugins:this.app.plugins,type:"open-menu-inbox",detail:{ids:i,element:n||a},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}remove(e){e||(e=this.selectIds),A("/api/inbox/removeShorthands",{ids:e},()=>{if(e){this.back();for(let n=this.selectIds.length-1;n>=0;n--)e.includes(this.selectIds[n])&&this.selectIds.splice(n,1)}else this.selectIds=[];this.currentPage=1,this.update()})}move(e){zi((n,a)=>p1(this,null,function*(){for(let i=0;i<e.length;i++){const s=e[i],l=yield Ae("/api/inbox/getShorthand",{id:s});this.data[l.data.oId]=l.data;let o=l.data.shorthandMd;o===""&&l.data.shorthandContent===""&&l.data.shorthandURL!=""&&(o="["+l.data.shorthandTitle+"]("+l.data.shorthandURL+")"),yield Ae("/api/filetree/createDoc",{notebook:a[0],path:De().join(xt(n[0],!1,!0),Lute.NewNodeID()+".sy"),title:oa(l.data.shorthandTitle),md:o,listDocTree:!0})}this.remove(e)}))}update(){const e=this.element.querySelector(".fn__loading");if(as("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replaceAll("${accountServer}",Fn(""))}
    </li>
</ul>`,e.classList.add("fn__none");return}e.classList.contains("fn__none")&&(e.classList.remove("fn__none"),A("/api/inbox/getShorthands",{page:this.currentPage},n=>{e.classList.add("fn__none");let a="";n.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',n.data.data.shorthands.forEach(o=>{a+=this.genItemHTML(o),this.data[o.oId]=o}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=n.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const i=this.element.querySelector('[data-type="previous"]'),s=this.element.querySelector('[data-type="next"]');n.data.data.pagination.paginationPageCount>this.currentPage?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),this.currentPage===1?i.setAttribute("disabled","disabled"):i.removeAttribute("disabled");const l=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector('[data-type="selectall"] use').setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===l&&l!==0?"#iconCheck":"#iconUncheck"),this.element.lastElementChild.scrollTop=0}))}}var m1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class gy extends ia{constructor(e,n){super({app:e,id:n.id}),this.messages=[],this.currentEditor=null,n instanceof Element?this.element=n:this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__ai"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg class="block__logoicon"><use xlink:href="#iconSparkles"></use></svg>AI \u6587\u6863\u5206\u6790&nbsp;
    </div>
    <span class="fn__flex-1"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.min}${Pt(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href="#iconMin"></use></svg></span>
</div>
<div class="fn__flex-1 ai-chat-container" style="background-color: var(--b3-theme-background); padding: 8px; display: flex; flex-direction: column;">
    <div class="ai-messages" style="flex: 1; overflow-y: auto; margin-bottom: 8px; border: 1px solid var(--b3-border-color); border-radius: 4px; padding: 8px; background: var(--b3-theme-surface);" data-type="messages">
        <div class="ai-welcome" style="color: var(--b3-theme-on-surface-light); text-align: center; padding: 20px 10px;">
            <div style="font-size: 24px; margin-bottom: 8px;">\u{1F916}</div>
            <div style="font-weight: bold; margin-bottom: 8px;">AI \u6587\u6863\u5206\u6790\u52A9\u624B</div>
            <div style="font-size: 12px; line-height: 1.6;">
                \u9009\u62E9\u4E00\u4E2A\u63D0\u793A\u8BCD\u5FEB\u901F\u5F00\u59CB\u5206\u6790\u5F53\u524D\u6587\u6863<br>
                \u5206\u6790\u5B8C\u6210\u540E\u53EF\u4EE5\u4FDD\u5B58\u5230\u7B14\u8BB0\u672B\u5C3E
            </div>
        </div>
    </div>
    <div class="ai-prompts" style="margin-bottom: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
        <button class="b3-button b3-button--outline" data-prompt="\u603B\u7ED3" style="font-size: 12px;">\u{1F4DD} \u603B\u7ED3\u6587\u6863</button>
        <button class="b3-button b3-button--outline" data-prompt="\u8981\u70B9" style="font-size: 12px;">\u{1F3AF} \u63D0\u53D6\u8981\u70B9</button>
        <button class="b3-button b3-button--outline" data-prompt="\u7EED\u5199" style="font-size: 12px;">\u270D\uFE0F \u7EED\u5199\u5185\u5BB9</button>
        <button class="b3-button b3-button--outline" data-prompt="\u4F18\u5316" style="font-size: 12px;">\u2728 \u4F18\u5316\u8868\u8FBE</button>
        <button class="b3-button b3-button--outline" data-prompt="\u7FFB\u8BD1" style="font-size: 12px;">\u{1F310} \u7FFB\u8BD1</button>
        <button class="b3-button b3-button--outline" data-prompt="\u95EE\u7B54" style="font-size: 12px;">\u{1F4AC} \u95EE\u7B54</button>
    </div>
    <div class="ai-input-container" style="display: flex; flex-direction: column; gap: 6px;">
        <div class="ai-input" style="display: flex; gap: 6px;">
            <input type="text" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u95EE\u9898\u6216\u9009\u62E9\u63D0\u793A\u8BCD..." data-type="input" style="font-size: 13px;">
            <button class="b3-button b3-button--outline" data-type="send" style="min-width: 60px;">\u53D1\u9001</button>
        </div>
        <div class="ai-actions" style="display: none; gap: 6px;">
            <button class="b3-button b3-button--outline fn__flex-1" data-type="save" style="font-size: 12px;">\u{1F4BE} \u4FDD\u5B58\u5230\u7B14\u8BB0</button>
            <button class="b3-button b3-button--text" data-type="clear" style="font-size: 12px;">\u{1F5D1}\uFE0F \u6E05\u7A7A</button>
        </div>
    </div>
</div>`,this.bindEvents()}bindEvents(){this.element.addEventListener("click",n=>{gt(this.element);let a=n.target;for(;a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type"),s=a.getAttribute("data-prompt");if(i==="min"){nt("ai").toggleModel("ai",!1,!0),n.preventDefault();break}else if(i==="send"){this.handleSend(),n.preventDefault();break}else if(i==="save"){this.saveToNote(),n.preventDefault();break}else if(i==="clear"){this.clearMessages(),n.preventDefault();break}else if(s){this.handlePromptClick(s),n.preventDefault();break}a=a.parentElement}});const e=this.element.querySelector('[data-type="input"]');e&&e.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),this.handleSend())})}handlePromptClick(e){const n=this.element.querySelector('[data-type="input"]'),a={\u603B\u7ED3:"\u8BF7\u603B\u7ED3\u8FD9\u7BC7\u6587\u6863\u7684\u4E3B\u8981\u5185\u5BB9",\u8981\u70B9:"\u8BF7\u63D0\u53D6\u8FD9\u7BC7\u6587\u6863\u7684\u5173\u952E\u8981\u70B9",\u7EED\u5199:"\u8BF7\u6839\u636E\u5F53\u524D\u5185\u5BB9\u7EE7\u7EED\u5199\u4F5C",\u4F18\u5316:"\u8BF7\u4F18\u5316\u8FD9\u7BC7\u6587\u6863\u7684\u8868\u8FBE\u548C\u7ED3\u6784",\u7FFB\u8BD1:"\u8BF7\u5C06\u8FD9\u7BC7\u6587\u6863\u7FFB\u8BD1\u6210\u82F1\u6587",\u95EE\u7B54:"\u8BF7\u56DE\u7B54\u5173\u4E8E\u8FD9\u7BC7\u6587\u6863\u7684\u95EE\u9898\uFF1A"};n&&a[e]&&(n.value=a[e],n.focus(),e!=="\u95EE\u7B54"&&setTimeout(()=>this.handleSend(),100))}handleSend(){const e=this.element.querySelector('[data-type="input"]');if(!e||!e.value.trim())return;const n=e.value.trim();e.value="",this.addMessage("user",n);const a=this.getCurrentDocContent();this.addMessage("assistant","\u{1F914} \u6B63\u5728\u601D\u8003\u4E2D..."),this.callAI(n,a).then(s=>{this.messages.pop(),this.addMessage("assistant",s);const l=this.element.querySelector(".ai-actions");l&&(l.style.display="flex")}).catch(s=>{this.messages.pop();const l=`\u274C AI\u8C03\u7528\u5931\u8D25: ${s.message||"\u672A\u77E5\u9519\u8BEF"}

\u8BF7\u68C0\u67E5AI\u914D\u7F6E\u662F\u5426\u6B63\u786E\u3002`;this.addMessage("assistant",l),console.error("AI\u8C03\u7528\u5931\u8D25:",s)})}getCurrentDocContent(){var e;const a=Oe().editor.find(i=>{var s,l;return(l=(s=i.parent)==null?void 0:s.headElement)==null?void 0:l.classList.contains("item--focus")});return a&&((e=a.editor)!=null&&e.protyle)?(this.currentEditor=a.editor,a.editor.protyle.wysiwyg.element.textContent||""):""}callAI(e,n){return m1(this,null,function*(){var a,i;const s=[];n&&n.trim()&&s.push({role:"system",content:`\u5F53\u524D\u6587\u6863\u5185\u5BB9\uFF1A

${n.substring(0,3e3)}${n.length>3e3?"...":""}`}),s.push({role:"user",content:e});try{const l=yield fetch("/api/ai/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:s,stream:!1})});if(!l.ok){const r=yield l.json().catch(()=>({}));throw new Error(r.msg||`HTTP ${l.status}`)}const o=yield l.json();if(o.code!==0)throw new Error(o.msg||"AI\u670D\u52A1\u8FD4\u56DE\u9519\u8BEF");return((a=o.data)==null?void 0:a.content)||((i=o.data)==null?void 0:i.message)||"\u62B1\u6B49\uFF0CAI\u6CA1\u6709\u8FD4\u56DE\u6709\u6548\u5185\u5BB9"}catch(l){throw console.error("AI API\u8C03\u7528\u5931\u8D25:",l),l}})}generateMockResponse(e,n){return e.includes("\u603B\u7ED3")?`\u{1F4CB} **\u6587\u6863\u603B\u7ED3**

\u6839\u636E\u5F53\u524D\u6587\u6863\u5185\u5BB9\uFF0C\u4E3B\u8981\u8BA8\u8BBA\u4E86\u4EE5\u4E0B\u51E0\u4E2A\u65B9\u9762\uFF1A

1. \u6838\u5FC3\u89C2\u70B9\u548C\u4E3B\u9898
2. \u5173\u952E\u8BBA\u636E\u548C\u652F\u6491\u6750\u6599
3. \u7ED3\u8BBA\u548C\u542F\u793A

_\uFF08\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u54CD\u5E94\uFF0C\u5B9E\u9645\u5E94\u7528\u4E2D\u9700\u8981\u63A5\u5165AI\u670D\u52A1\uFF09_`:e.includes("\u8981\u70B9")?`\u{1F3AF} **\u5173\u952E\u8981\u70B9**

\u2022 \u8981\u70B9\u4E00\uFF1A\u6838\u5FC3\u6982\u5FF5\u8BF4\u660E
\u2022 \u8981\u70B9\u4E8C\uFF1A\u91CD\u8981\u8BBA\u636E
\u2022 \u8981\u70B9\u4E09\uFF1A\u5B9E\u8DF5\u5E94\u7528
\u2022 \u8981\u70B9\u56DB\uFF1A\u6CE8\u610F\u4E8B\u9879

_\uFF08\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u54CD\u5E94\uFF0C\u5B9E\u9645\u5E94\u7528\u4E2D\u9700\u8981\u63A5\u5165AI\u670D\u52A1\uFF09_`:e.includes("\u7EED\u5199")?`\u270D\uFE0F **\u7EED\u5199\u5EFA\u8BAE**

\u57FA\u4E8E\u5F53\u524D\u5185\u5BB9\uFF0C\u53EF\u4EE5\u4ECE\u4EE5\u4E0B\u89D2\u5EA6\u7EE7\u7EED\u5C55\u5F00\uFF1A

1. \u6DF1\u5165\u5206\u6790\u73B0\u6709\u89C2\u70B9
2. \u8865\u5145\u76F8\u5173\u6848\u4F8B
3. \u63D0\u51FA\u53EF\u80FD\u7684\u89E3\u51B3\u65B9\u6848
4. \u603B\u7ED3\u548C\u5C55\u671B

_\uFF08\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u54CD\u5E94\uFF0C\u5B9E\u9645\u5E94\u7528\u4E2D\u9700\u8981\u63A5\u5165AI\u670D\u52A1\uFF09_`:e.includes("\u4F18\u5316")?`\u2728 **\u4F18\u5316\u5EFA\u8BAE**

**\u7ED3\u6784\u4F18\u5316\uFF1A**
- \u5EFA\u8BAE\u8C03\u6574\u6BB5\u843D\u987A\u5E8F\uFF0C\u4F7F\u903B\u8F91\u66F4\u6E05\u6670
- \u53EF\u4EE5\u6DFB\u52A0\u5C0F\u6807\u9898\uFF0C\u589E\u5F3A\u53EF\u8BFB\u6027

**\u8868\u8FBE\u4F18\u5316\uFF1A**
- \u90E8\u5206\u53E5\u5B50\u53EF\u4EE5\u66F4\u7B80\u6D01
- \u4E13\u4E1A\u672F\u8BED\u9700\u8981\u9002\u5F53\u89E3\u91CA

_\uFF08\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u54CD\u5E94\uFF0C\u5B9E\u9645\u5E94\u7528\u4E2D\u9700\u8981\u63A5\u5165AI\u670D\u52A1\uFF09_`:`\u{1F4A1} **AI \u56DE\u590D**

\u5173\u4E8E\u60A8\u7684\u95EE\u9898"${e}"\uFF1A

\u6839\u636E\u6587\u6863\u5185\u5BB9\u5206\u6790\uFF0C\u6211\u7684\u7406\u89E3\u662F...

_\uFF08\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u54CD\u5E94\uFF0C\u5B9E\u9645\u5E94\u7528\u4E2D\u9700\u8981\u63A5\u5165\u771F\u5B9E\u7684AI\u670D\u52A1\u8FDB\u884C\u5206\u6790\uFF09_`}addMessage(e,n){const a={role:e,content:n,timestamp:Date.now()};this.messages.push(a),this.renderMessages()}renderMessages(){const e=this.element.querySelector('[data-type="messages"]');if(!e)return;const n=e.querySelector(".ai-welcome");n&&n.remove(),e.innerHTML=this.messages.map(a=>{const i=a.role==="user";return`
                <div style="display: flex; justify-content: ${i?"flex-end":"flex-start"}; margin-bottom: 12px;">
                    <div style="max-width: 85%; background: ${i?"var(--b3-theme-primary-lighter)":"var(--b3-theme-surface)"}; padding: 8px 12px; border-radius: 8px; word-wrap: break-word;">
                        <div style="font-size: 11px; color: var(--b3-theme-on-surface-light); margin-bottom: 4px;">
                            ${i?"\u{1F464}":"\u{1F916}"} ${i?"\u6211":"AI\u52A9\u624B"}
                        </div>
                        <div style="line-height: 1.6; white-space: pre-wrap; font-size: 13px;">${this.escapeHtml(a.content)}</div>
                    </div>
                </div>
            `}).join(""),e.scrollTop=e.scrollHeight}escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,'<code style="background: var(--b3-theme-surface-lighter); padding: 2px 4px; border-radius: 2px;">$1</code>').replace(/\n/g,"<br>")}saveToNote(){var e,n,a,i,s,l,o,r;if(!this.currentEditor||!this.currentEditor.protyle){(n=(e=window.siyuan).showMessage)==null||n.call(e,"\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u6587\u6863",3e3,"error");return}const c=[...this.messages].reverse().find(d=>d.role==="assistant");if(!c){(i=(a=window.siyuan).showMessage)==null||i.call(a,"\u6CA1\u6709\u53EF\u4FDD\u5B58\u7684AI\u56DE\u590D",3e3,"error");return}try{const d=this.currentEditor.protyle;if(d.wysiwyg.element.lastElementChild){const m=`

---

## \u{1F916} AI \u5206\u6790\u7ED3\u679C

${c.content}

*\u751F\u6210\u65F6\u95F4\uFF1A${new Date(c.timestamp).toLocaleString()}*
`,f=d.lute.Md2BlockDOM(m);Ht(f,d,!0),setTimeout(()=>{const g=d.wysiwyg.element.lastElementChild;g&&oe(g,void 0,!1)},100),(l=(s=window.siyuan).showMessage)==null||l.call(s,"\u2705 \u5DF2\u4FDD\u5B58\u5230\u7B14\u8BB0\u672B\u5C3E",2e3,"info")}}catch(d){console.error("\u4FDD\u5B58\u5230\u7B14\u8BB0\u5931\u8D25:",d),(r=(o=window.siyuan).showMessage)==null||r.call(o,"\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5",3e3,"error")}}clearMessages(){this.messages=[];const e=this.element.querySelector('[data-type="messages"]');e&&(e.innerHTML=`
                <div class="ai-welcome" style="color: var(--b3-theme-on-surface-light); text-align: center; padding: 20px 10px;">
                    <div style="font-size: 24px; margin-bottom: 8px;">\u{1F916}</div>
                    <div style="font-weight: bold; margin-bottom: 8px;">AI \u6587\u6863\u5206\u6790\u52A9\u624B</div>
                    <div style="font-size: 12px; line-height: 1.6;">
                        \u9009\u62E9\u4E00\u4E2A\u63D0\u793A\u8BCD\u5FEB\u901F\u5F00\u59CB\u5206\u6790\u5F53\u524D\u6587\u6863<br>
                        \u5206\u6790\u5B8C\u6210\u540E\u53EF\u4EE5\u4FDD\u5B58\u5230\u7B14\u8BB0\u672B\u5C3E
                    </div>
                </div>
            `);const n=this.element.querySelector(".ai-actions");n&&(n.style.display="none")}}const my=["file","outline","inbox","bookmark","tag","graph","globalGraph","backlink","ai"];class hy{constructor(e){this.pin=!0;var n;switch(e.position){case"Left":this.layout=window.siyuan.layout.layout.children[0].children[0],this.resizeElement=this.layout.element.nextElementSibling,this.layout.element.classList.add("layout__dockl"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Right":this.layout=window.siyuan.layout.layout.children[0].children[2],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockr"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Bottom":this.layout=window.siyuan.layout.layout.children[1],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockb"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize"></div>');break}this.app=e.app,this.element=document.getElementById("dock"+e.position);const a=e.position==="Bottom"?' class="fn__flex dock__items"':' class="dock__items"';this.element.innerHTML=`<div${a}></div><div class="fn__flex-1 dock__item--space"></div><div${a}></div>`,this.position=e.position,this.pin=e.data.pin,this.data={};let i=!1;e.data.data.length!==0&&(i||e.data.data[0].find(l=>{if(my.includes(l.type))return i=!0,!0}),!i&&e.data.data[1]&&e.data.data[1].find(l=>{if(my.includes(l.type))return i=!0,!0})),i?(this.genButton(e.data.data[0],0),e.data.data[1]&&this.genButton(e.data.data[1],1),this.element.classList.remove("fn__none")):(this.element.firstElementChild.innerHTML=`<span class="dock__item dock__item--pin ariaLabel" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#icon${this.pin?"Unpin":"Pin"}"></use></svg>
</span>`,this.element.classList.add("fn__none"));const s=this.element.querySelectorAll(".dock__item--active");this.element.querySelectorAll(".dock__item").forEach(l=>{l.getAttribute("data-type")==="file"&&!l.classList.contains("dock__item--active")&&(this.toggleModel("file",!0,!1,!1,!1),this.toggleModel("file",!1,!1,!1,!1))}),s.length===0?(this.resizeElement.classList.add("fn__none"),this.layout.children.length>1&&(this.layout.children.forEach(l=>{l.element.classList.add("fn__none")}),(n=this.layout.children[0].element.nextElementSibling)==null||n.classList.add("fn__none"))):s.forEach(l=>{this.toggleModel(l.getAttribute("data-type"),!0,!1,!1,!1)}),this.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(this.element);){const r=o.getAttribute("data-type");if(r){this.toggleModel(r,!1,!0),l.preventDefault();break}else if(o.classList.contains("dock__item")){this.togglePin(),o.setAttribute("aria-label",this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin),o.querySelector("use").setAttribute("xlink:href",this.pin?"#iconUnpin":"#iconPin"),l.preventDefault();break}o=o.parentElement}}),this.element.addEventListener("mousedown",l=>{const o=T(l.target,"dock__item");if(!o||!o.getAttribute("data-type"))return;const r=document;r.ondragstart=()=>!1;let c,d;const u=document.createElement("span");u.classList.add("dock__item","fn__none"),u.style.background="var(--b3-theme-primary-light)",u.innerHTML="<svg></svg>",u.id="dockMoveItem",r.onmousemove=m=>{var f;if(window.siyuan.config.readonly||Math.abs(m.clientY-l.clientY)<3&&Math.abs(m.clientX-l.clientX)<3)return;m.preventDefault(),m.stopPropagation(),c||(o.style.opacity="0.38",c=o.cloneNode(!0),c.setAttribute("data-ghost-type","dock"),this.element.append(c),c.setAttribute("data-original",JSON.stringify({position:this.position,index:o.getAttribute("data-index"),previousType:(f=o.previousElementSibling)==null?void 0:f.getAttribute("data-type"),type:o.getAttribute("data-type")})),c.setAttribute("id","dragGhost"),c.setAttribute("style",`background-color:var(--b3-theme-background-light);position: fixed; top: ${l.clientY}px; left: ${l.clientX}px; z-index:999997;`)),this.position==="Bottom"?(c.style.top=m.clientY-40+"px",c.style.left=m.clientX-20+"px"):(c.style.top=m.clientY-20+"px",this.position==="Left"?c.style.left=m.clientX+"px":c.style.left=m.clientX-40+"px");const g=T(m.target,"dock__item")||T(m.target,"dock__items")||T(m.target,"dock__item--space");if(g&&d&&g===d){if(d.classList.contains("dock__item--space")){const h=d.getBoundingClientRect();if(d.parentElement.id==="dockBottom"){if(m.clientX<h.right&&m.clientX>h.right-40){const b=d.nextElementSibling.firstElementChild;b&&b===o?u.classList.add("fn__none"):(u.classList.remove("fn__none"),b.before(u))}}else if(m.clientY<h.bottom&&m.clientY>h.bottom-40){const b=d.nextElementSibling.firstElementChild;b&&b===o?u.classList.add("fn__none"):(u.classList.remove("fn__none"),b.before(u))}}else if(d.classList.contains("dock__item--pin"))o.nextElementSibling&&o.nextElementSibling===d?u.classList.add("fn__none"):(u.classList.remove("fn__none"),d.before(u));else if(d.classList.contains("dock__item")){const h=d.getBoundingClientRect();d.parentElement.parentElement.id==="dockBottom"?h.left+h.width/2>m.clientX?o.nextElementSibling&&o.nextElementSibling===d?u.classList.add("fn__none"):(u.classList.remove("fn__none"),d.before(u)):o.previousElementSibling&&o.previousElementSibling===d?u.classList.add("fn__none"):(u.classList.remove("fn__none"),d.after(u)):h.top+h.height/2>m.clientY?o.nextElementSibling&&o.nextElementSibling===d?u.classList.add("fn__none"):(u.classList.remove("fn__none"),d.before(u)):o.previousElementSibling&&o.previousElementSibling===d?u.classList.add("fn__none"):(u.classList.remove("fn__none"),d.after(u))}else d.childElementCount===0?(u.classList.remove("fn__none"),d.append(u)):d.childElementCount===1&&d.firstElementChild.id==="dockMoveItem"?u.classList.remove("fn__none"):d.childElementCount===1&&d.firstElementChild.classList.contains("dock__item--pin")?(u.classList.remove("fn__none"),d.insertAdjacentElement("afterbegin",u)):d.childElementCount===2&&d.firstElementChild.id==="dockMoveItem"&&d.lastElementChild.classList.contains("dock__item--pin")&&u.classList.remove("fn__none");return}if(!g||g.style.position==="fixed"||g===o||g.id==="dockMoveItem"){g&&g===o&&u.classList.add("fn__none");return}d=g},r.onmouseup=()=>{var m;if(r.onmousemove=null,r.onmouseup=null,r.ondragstart=null,r.onselectstart=null,r.onselect=null,c==null||c.remove(),o.style.opacity==="0.38"){if(o.style.opacity="",!u.classList.contains("fn__none")){let f;u.parentElement.parentElement.id==="dockBottom"?f=window.siyuan.layout.bottomDock:u.parentElement.parentElement.id==="dockLeft"?f=window.siyuan.layout.leftDock:u.parentElement.parentElement.id==="dockRight"&&(f=window.siyuan.layout.rightDock),f.add(u.parentElement===f.element.firstElementChild?0:1,o,(m=u.previousElementSibling)==null?void 0:m.getAttribute("data-type"))}u.remove()}}}),this.layout.element.addEventListener("mouseleave",l=>{var o,r;l.buttons!==0||this.pin||(o=l.toElement)!=null&&o.classList.contains("b3-menu")||(r=l.toElement)!=null&&r.classList.contains("tooltip")||this.position==="Left"&&l.clientX<43||this.position==="Right"&&l.clientX>window.innerWidth-43||this.position==="Bottom"&&l.clientY>window.innerHeight-73||this.hideDock()}),this.layout.element.querySelector(".layout__dockresize").addEventListener("mousedown",l=>{const o=document,r=this.position==="Bottom"?"tb":"lr",c=l[r==="lr"?"clientX":"clientY"],d=r==="lr"?this.layout.element.clientWidth:this.layout.element.clientHeight;o.onmousemove=u=>{u.preventDefault(),u.stopPropagation();let m;this.position==="Left"?m=d+(u.clientX-c):this.position==="Right"?m=d+(c-u.clientX):m=d+(c-u.clientY);let f=232;Array.from(this.layout.element.querySelectorAll(".file-tree")).find(g=>{if((g.classList.contains("sy__backlink")||g.classList.contains("sy__graph")||g.classList.contains("sy__globalGraph")||g.classList.contains("sy__inbox"))&&!g.classList.contains("fn__none")&&!T(g,"fn__none"))return f=320,!0}),!(m<f&&r==="lr")&&(m<64&&r==="tb"||(this.layout.element.style[r==="lr"?"width":"height"]=m+"px"))},o.onmouseup=()=>{o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,this.setSize(),this.element.querySelectorAll(".dock__item--active").forEach(u=>{const m=this.data[u.getAttribute("data-type")];m&&m instanceof fi&&m.resize&&m.resize()})}}),window.siyuan.config.uiLayout.hideDock&&this.element.classList.add("fn__none"),this.pin||setTimeout(()=>{this.resetDockPosition(!1),this.hideDock(!0),this.layout.element.classList.add("layout--float"),this.resizeElement.classList.add("fn__none")})}togglePin(){this.pin=!this.pin;const e=this.element.querySelector(".dock__item--active");this.pin?(this.layout.element.style.opacity="",this.layout.element.style.transform="",this.layout.element.style.zIndex="",e&&this.resizeElement.classList.remove("fn__none")):(this.resetDockPosition(!!e),this.resizeElement.classList.add("fn__none"),e?this.showDock(!0):this.hideDock(!0)),this.layout.element.classList.toggle("layout--float"),Sn()}resetDockPosition(e){this.position==="Left"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.position==="Right"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.layout.element.setAttribute("style",`height:${this.layout.element.clientHeight}px;opacity:${e?1:0};`)}showDock(e=!1){var n,a,i;!e&&(this.pin||!this.element.querySelector(".dock__item--active")||this.layout.element.style.opacity==="1")||!e&&(this.position==="Left"||this.position==="Right")&&this.layout.element.clientWidth===0&&this.layout.element.style.width.startsWith("0")||!e&&this.position==="Bottom"&&this.layout.element.clientHeight===0&&this.layout.element.style.height.startsWith("0")||(document.querySelector(".b3-dialog")||document.querySelector(".block__popover")||document.querySelector("#commonMenu:not(.fn__none)"))&&(((n=window.siyuan.layout.leftDock)==null?void 0:n.layout.element.style.opacity)==="1"||((a=window.siyuan.layout.rightDock)==null?void 0:a.layout.element.style.opacity)==="1"||((i=window.siyuan.layout.bottomDock)==null?void 0:i.layout.element.style.opacity)==="1")||(e||(this.layout.element.style.opacity="1"),this.layout.element.style.transform="",this.layout.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.position==="Left"?this.layout.element.style.left=`${this.element.clientWidth}px`:this.position==="Right"?this.layout.element.style.right=`${this.element.clientWidth}px`:this.position==="Bottom"&&(this.layout.element.style.bottom=`${this.element.offsetHeight+document.getElementById("status").offsetHeight}px`))}hideDock(e=!1){var n,a;if(!e&&(this.layout.element.style.opacity==="0"||this.pin))return;const i=this.layout.element.querySelector(".fullscreen");if(i&&i.clientHeight>0||document.activeElement&&this.layout.element.contains(document.activeElement)&&document.activeElement.classList.contains("b3-text-field"))return;const s=document.querySelector(".b3-dialog"),l=document.querySelector(".block__popover"),o=document.querySelector("#commonMenu:not(.fn__none)");s&&s.style.zIndex>this.layout.element.style.zIndex||l&&l.style.zIndex>this.layout.element.style.zIndex||o&&o.style.zIndex>this.layout.element.style.zIndex||(this.position==="Left"?(this.layout.element.style.transform=`translateX(-${this.layout.element.clientWidth+8}px)`,this.layout.element.style.left=""):this.position==="Right"?(this.layout.element.style.transform=`translateX(${this.layout.element.clientWidth+8}px)`,this.layout.element.style.right=""):this.position==="Bottom"&&(this.layout.element.style.transform=`translateY(${this.layout.element.clientHeight+8}px)`,this.layout.element.style.bottom=""),!e&&(this.layout.element.style.opacity="0",(n=this.element.querySelector(".dock__item--activefocus"))==null||n.classList.remove("dock__item--activefocus"),(a=this.layout.element.querySelector(".layout__tab--active"))==null||a.classList.remove("layout__tab--active")))}toggleModel(e,n=!1,a=!1,i=!1,s=!0){var l,o;if(!e)return;this.pin&&id();const r=this.element.querySelector(`[data-type="${e}"]`);n&&r.classList.contains("dock__item--active")&&r.classList.remove("dock__item--active","dock__item--activefocus");const c=parseInt(r.getAttribute("data-index")),d=this.layout.children[c];if(r.classList.contains("dock__item--active")||i){if(!a){let h=!1;if(Array.from(d.element.querySelector(".layout-tab-container").children).find(b=>{if(b.getAttribute("data-id")===r.getAttribute("data-id"))return b.classList.contains("layout__tab--active")||(gt(b),h=!0),!0}),h){document.activeElement&&document.activeElement.blur(),sC(),this.showDock();return}}if(r.classList.remove("dock__item--active","dock__item--activefocus"),this.element.querySelectorAll(".dock__item--active").length===0&&(this.position==="Left"||this.position==="Right"?this.layout.element.style.width="0px":this.layout.element.style.height="0px",this.resizeElement.classList.add("fn__none"),clearTimeout(this.hideResizeTimeout),this.hideDock()),(e==="graph"||e==="globalGraph")&&(this.layout.element.querySelector(".fullscreen")&&((l=document.getElementById("drag"))==null||l.classList.remove("fn__hidden")),this.data[e].destroy()),s&&!document.querySelector(".layout__center .layout__wnd--active")){const h=document.querySelector(".layout__center ul.layout-tab-bar .item--focus");h&&pi().find(b=>{if(b.id===h.getAttribute("data-id"))return b.parent.switchTab(b.headElement,!1,!0,!1),!0})}}else{if(this.element.querySelectorAll(`.dock__item--active[data-index="${c}"]`).forEach(h=>{h.classList.remove("dock__item--active","dock__item--activefocus")}),r.classList.add("dock__item--active","dock__item--activefocus"),r.getAttribute("data-id"))Array.from(d.element.querySelector(".layout-tab-container").children).forEach(h=>{h.getAttribute("data-id")===r.getAttribute("data-id")?(h.classList.remove("fn__none"),gt(h)):h.classList.add("fn__none")});else{let h;Oe().editor.find(w=>{var E,C;if(w.parent.headElement.classList.contains("item--focus")&&((C=(E=w.editor)==null?void 0:E.protyle)!=null&&C.path))return h=w.editor,!0});let y;switch(e){case"file":y=new Dt({callback:w=>{w.addModel(new Ki({tab:w,app:this.app}))}});break;case"bookmark":y=new Dt({callback:w=>{w.addModel(new Wl(this.app,w))}});break;case"tag":y=new Dt({callback:w=>{w.addModel(new Ps(this.app,w))}});break;case"outline":y=new Dt({callback:w=>{var E,C,$;const M=new Is({app:this.app,type:"pin",tab:w,blockId:(C=(E=h==null?void 0:h.protyle)==null?void 0:E.block)==null?void 0:C.rootID,isPreview:($=h==null?void 0:h.protyle)!=null&&$.preview?!h.protyle.preview.element.classList.contains("fn__none"):!1});w.addModel(M)}});break;case"graph":y=new Dt({callback:w=>{var E,C;w.addModel(new Ii({app:this.app,tab:w,blockId:(C=(E=h==null?void 0:h.protyle)==null?void 0:E.block)==null?void 0:C.rootID,type:"pin"}))}});break;case"globalGraph":y=new Dt({callback:w=>{w.addModel(new Ii({app:this.app,tab:w,type:"global"}))}});break;case"backlink":y=new Dt({callback:w=>{var E,C;w.addModel(new Zi({app:this.app,type:"pin",tab:w,blockId:(C=(E=h==null?void 0:h.protyle)==null?void 0:E.block)==null?void 0:C.rootID}))}});break;case"inbox":y=new Dt({callback:w=>{w.addModel(new g1(this.app,w))}});break;case"ai":y=new Dt({callback:w=>{w.addModel(new gy(this.app,w))}});break;default:y=new Dt({callback:w=>{let E;this.app.plugins.find(C=>{if(C.docks[e])return E=C.docks[e].model({tab:w}),!0}),E&&w.addModel(E)}});break}d.addTab(y,!1,!1),r.setAttribute("data-id",y.id),this.data[e]=y.model,gt(y.panelElement)}this.position==="Left"||this.position==="Right"?this.layout.element.style.width=this.getMaxSize()+"px":this.layout.element.style.height=this.getMaxSize()+"px",(e==="graph"||e==="globalGraph")&&this.layout.element.querySelector(".fullscreen")&&((o=document.getElementById("drag"))==null||o.classList.add("fn__hidden")),this.pin&&(this.layout.element.style.opacity="",this.hideResizeTimeout=window.setTimeout(()=>{this.resizeElement.classList.remove("fn__none"),kd()},p.TIMEOUT_TRANSITION)),document.activeElement&&document.activeElement.blur()}const u=c===0?1:0,m=this.layout.children[u],f=this.element.querySelectorAll(`.dock__item--active[data-index="${u}"]`).length>0,g=this.element.querySelectorAll(`.dock__item--active[data-index="${c}"]`).length>0;if(g&&f){let h=d;u===0?m.element.nextElementSibling.classList.remove("fn__none"):(h=m,m.element.previousElementSibling.classList.remove("fn__none"));const b=this.element.querySelector('.dock__item--active[data-index="1"]');if(this.position==="Left"||this.position==="Right"){const y=parseInt(b.getAttribute("data-height"));y!==0&&!isNaN(y)&&(h.element.style.height=y+"px",h.element.classList.remove("fn__flex-1"))}else{const y=parseInt(b.getAttribute("data-width"));y!==0&&!isNaN(y)&&(h.element.style.width=y+"px",h.element.classList.remove("fn__flex-1"))}}else u===0?m.element.nextElementSibling.classList.add("fn__none"):m.element.previousElementSibling.classList.add("fn__none");f?m.element.classList.remove("fn__none"):m.element.classList.add("fn__none"),g?d.element.classList.remove("fn__none"):d.element.classList.add("fn__none"),g&&!f?(d.element.classList.add("fn__flex-1"),d.element.style.height="",d.element.style.width=""):!g&&f&&(m.element.classList.add("fn__flex-1"),m.element.style.height="",m.element.style.width=""),Sn(s),this.showDock(),r.classList.contains("dock__item--active")&&!i&&(e==="graph"||e==="globalGraph")&&this.data[e].onGraph(!1)}add(e,n,a){n.setAttribute("data-height",""),n.setAttribute("data-width","");const i=n.getAttribute("data-type"),s=nt(i);s.element.querySelectorAll(".dock__item").length===2&&s.element.classList.add("fn__none");const l=s.layout.children[parseInt(n.getAttribute("data-index"))];n.getAttribute("data-id")&&(l.removeTab(n.getAttribute("data-id"),!1,!0,!1),n.removeAttribute("data-id"));const r=n.classList.contains("dock__item--active");r&&s.toggleModel(i,!1,!1,!1,!1),delete s.data[i],n.setAttribute("data-index",e.toString()),a?this.element.querySelector(`[data-type="${a}"]`).after(n):e===0?this.element.firstElementChild.insertAdjacentElement("afterbegin",n):this.element.lastElementChild.insertAdjacentElement("afterbegin",n),this.element.classList.remove("fn__none"),pb(),this.data[i]=!0,r&&this.toggleModel(i,!0,!1,!1,!1),setTimeout(()=>{bn()},p.TIMEOUT_TRANSITION)}remove(e){this.toggleModel(e,!1,!0,!0),this.element.querySelector(`[data-type="${e}"]`).remove();const n=this.data[e];n.parent&&n.parent.parent.removeTab(n.parent.id),delete this.data[e]}setSize(){const e=this.element.querySelectorAll(".dock__item--active");e.forEach(n=>{if(this.position==="Left"||this.position==="Right"){if(n.getAttribute("data-index")==="1"&&e.length>1){const a=this.data[n.getAttribute("data-type")].parent.parent.element;n.setAttribute("data-height",a.style.height?a.clientHeight.toString():"")}n.setAttribute("data-width",this.layout.element.clientWidth.toString())}else{if(n.getAttribute("data-index")==="1"&&e.length>1){const a=this.data[n.getAttribute("data-type")].parent.parent.element;n.setAttribute("data-width",a.style.width?a.clientWidth.toString():"")}n.setAttribute("data-height",this.layout.element.clientHeight.toString())}})}getMaxSize(){let e=0;return this.element.querySelectorAll(".dock__item--active").forEach(n=>{let a;this.position==="Left"||this.position==="Right"?a=parseInt(n.getAttribute("data-width"))||(["graph","globalGraph","backlink"].includes(n.getAttribute("data-type"))?320:232):a=parseInt(n.getAttribute("data-height"))||232,a>e&&(e=a)}),e}genButton(e,n,a){let i="";e.forEach(s=>{typeof a=="undefined"&&!my.includes(s.type)||(i+=`<span data-height="${s.size.height}" data-width="${s.size.width}" data-type="${s.type}" data-index="${n}" data-hotkey="${s.hotkey||""}" data-hotkeyLangId="${s.hotkeyLangId||""}" data-title="${s.title}" class="dock__item${s.show?" dock__item--active":""} ariaLabel" aria-label="<span style='white-space:pre'>${s.title} ${s.hotkey?pe(s.hotkey):""}${window.siyuan.languages.dockTip}</span>">
    <svg><use xlink:href="#${s.icon}"></use></svg>
</span>`,this.data[s.type]=!0)}),n===0?typeof a=="number"?this.element.firstElementChild.children[a]?this.element.firstElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.lastElementChild.insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.innerHTML=`${i}<span class="dock__item dock__item--pin ariaLabel" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#icon${this.pin?"Unpin":"Pin"}"></use></svg>
</span>`:typeof a=="number"?this.element.lastElementChild.children[a]?this.element.lastElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.lastElementChild.insertAdjacentHTML("beforeend",i):this.element.lastElementChild.innerHTML=i,typeof a=="number"&&(window.siyuan.config.uiLayout.hideDock||this.element.classList.remove("fn__none"),e[0].show&&this.toggleModel(e[0].type,!0,!1,!1,!1))}}var h1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class gS{constructor(e){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=n=>{window.siyuan.blockPanels.push(new ud({app:this.app,originalRefBlockIDs:n.originalRefBlockIDs,targetElement:n.targetElement,isBacklink:n.isBacklink,x:n.x,y:n.y,refDefs:n.refDefs}))},this.app=e.app,this.i18n=e.i18n,this.displayName=e.displayName,this.eventBus=new GA(e.name),Object.defineProperty(this,"name",{value:e.name,writable:!1}),this.updateProtyleToolbar([]).forEach(n=>{typeof n=="string"||p.INLINE_TYPE.concat("|").includes(n.name)||!n.hotkey||(window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[e.name]||(window.siyuan.config.keymap.plugin[e.name]={[n.name]:{default:n.hotkey,custom:n.hotkey}}),window.siyuan.config.keymap.plugin[e.name][n.name]||(window.siyuan.config.keymap.plugin[e.name][n.name]={default:n.hotkey,custom:n.hotkey}))})}onload(){}onunload(){}uninstall(){}updateCards(e){return h1(this,null,function*(){return e})}onLayoutReady(){}addCommand(e){window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][e.langKey]?window.siyuan.config.keymap.plugin[this.name][e.langKey]&&(typeof window.siyuan.config.keymap.plugin[this.name][e.langKey].custom=="string"?e.customHotkey=window.siyuan.config.keymap.plugin[this.name][e.langKey].custom:e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[this.name][e.langKey].default=e.hotkey):(e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[this.name][e.langKey]={default:e.hotkey,custom:e.hotkey}):(e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[this.name]={[e.langKey]:{default:e.hotkey,custom:e.hotkey}}),typeof e.customHotkey!="string"?console.error(`${this.name} - commands data is error and has been removed.`):this.commands.push(e)}addIcons(e){const n=document.querySelector(`svg[data-name="${this.name}"] defs`);if(n)n.insertAdjacentHTML("afterbegin",e);else{const a=document.querySelector("body > svg:last-of-type");a?a.insertAdjacentHTML("afterend",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${e}</defs></svg>`):document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${e}</defs></svg>`)}}addTopBar(e){var n,a;if(!e.icon.startsWith("icon")&&!e.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const i=document.createElement("div");return i.setAttribute("data-menu","true"),i.addEventListener("click",e.callback),i.id=`plugin_${this.name}_${this.topBarIcons.length}`,Y()?(i.className="b3-menu__item",i.innerHTML=(e.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${e.icon}"></use></svg>`:e.icon)+`<span class="b3-menu__label">${e.title}</span>`):ue()||(i.className="toolbar__item ariaLabel",i.setAttribute("aria-label",e.title),i.innerHTML=e.icon.startsWith("icon")?`<svg><use xlink:href="#${e.icon}"></use></svg>`:e.icon,i.addEventListener("click",e.callback),i.setAttribute("data-location",e.position||"right"),Ed()),Y()&&window.siyuan.storage?window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(i.id)||(n=document.querySelector("#menuAbout"))==null||n.after(i):!ue()&&window.siyuan.storage&&(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(i.id)&&i.classList.add("fn__none"),(a=document.querySelector("#"+(i.getAttribute("data-location")==="right"?"barPlugins":"drag")))==null||a.before(i)),this.topBarIcons.push(i),i}addStatusBar(e){e.element.setAttribute("data-location",e.position||"right"),this.statusBarIcons.push(e.element);const n=document.getElementById("status");return n&&(e.element.getAttribute("data-location")==="right"?n.insertAdjacentElement("beforeend",e.element):n.insertAdjacentElement("afterbegin",e.element)),e.element}openSetting(){this.setting&&this.setting.open(this.displayName||this.name)}loadData(e){return typeof this.data[e]=="undefined"&&(this.data[e]=""),new Promise(n=>{A("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{a.code!==404&&(this.data[e]=a),n(this.data[e])})})}saveData(e,n){if(!(window.siyuan.config.readonly||window.siyuan.isPublish))return new Promise(a=>{const i=`/data/storage/petal/${this.name}/${e}`;let s;typeof n=="object"?s=new File([new Blob([JSON.stringify(n)],{type:"application/json"})],i.split("/").pop()):s=new File([new Blob([n])],i.split("/").pop());const l=new FormData;l.append("path",i),l.append("file",s),l.append("isDir","false"),A("/api/file/putFile",l,o=>{this.data[e]=n,a(o)})})}removeData(e){if(!(window.siyuan.config.readonly||window.siyuan.isPublish))return new Promise(n=>{this.data||(this.data={}),A("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{delete this.data[e],n(a)})})}getOpenedTab(){const e={},n=Object.keys(this.models);return n.forEach(a=>{e[a.replace(this.name,"")]=[]}),Oe().custom.find(a=>{n.includes(a.type)&&e[a.type.replace(this.name,"")].push(a)}),e}addTab(e){const n=this.name+e.type;return this.models[n]=a=>{const i=new fi({app:this.app,tab:a.tab,type:n,data:a.data,init:e.init,beforeDestroy:e.beforeDestroy,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",()=>{Qi(),gt(i.element.parentElement.parentElement)}),i},this.models[n]}addDock(e){const n=this.name+e.type;return typeof e.config.index=="undefined"&&(e.config.index=1e3),this.docks[n]={config:e.config,model:a=>{const i=new fi({app:this.app,tab:a.tab,type:n,data:e.data,init:e.init,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",s=>{gt(i.element),j(s.target,"data-type","min")&&nt(n).toggleModel(n)}),i.element.classList.add("sy__"+n),i}},window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),e.config.hotkey&&(window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][n]?window.siyuan.config.keymap.plugin[this.name][n]&&(typeof window.siyuan.config.keymap.plugin[this.name][n].custom!="string"&&(window.siyuan.config.keymap.plugin[this.name][n].custom=e.config.hotkey),window.siyuan.config.keymap.plugin[this.name][n].default=e.config.hotkey):window.siyuan.config.keymap.plugin[this.name][n]={default:e.config.hotkey,custom:e.config.hotkey}:window.siyuan.config.keymap.plugin[this.name]={[n]:{default:e.config.hotkey,custom:e.config.hotkey}}),this.docks[n]}updateProtyleToolbar(e){return e}set protyleOptions(e){this.protyleOptionsValue=e}get protyleOptions(){return this.protyleOptionsValue}}var b1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const mS=(t,e={})=>{$i(t,{}),t.parent.removeTab(t.id)},y1=(t,...e)=>b1(void 0,[t,...e],function*(n,a={}){let i=n;typeof i=="string"&&(i=[i]);const s=[];for(let l=0;l<i.length;l++){const o=yield Ae("/api/block/getBlockInfo",{id:i[l]});if(o.code===3){de(o.msg);return}s.push({title:o.data.rootTitle,docIcon:o.data.rootIcon,pin:!1,active:!0,instance:"Tab",action:"Tab",children:{notebookId:o.data.box,blockId:i[l],rootId:o.data.rootID,mode:"wysiwyg",instance:"Editor",action:o.data.rootID===i[l]?p.CB_GET_SCROLL:p.CB_GET_ALL}})}}),ID=(t,e={})=>{};class _1{constructor(e){this.items=[],this.confirmCallback=e.confirmCallback,this.destroyCallback=e.destroyCallback,this.width=e.width||(Y()?"92vw":"768px"),this.height=e.height||"80vh"}addItem(e){this.items.push(e)}open(e){var n;const a=new $e({title:e,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),i=a.element.querySelector(".b3-dialog__content");this.items.forEach(l=>{let o="",r=l.actionElement;!l.actionElement&&l.createActionElement&&(r=l.createActionElement());const c=r!=null&&r.classList.contains("b3-switch")?"label":"div";typeof l.direction=="undefined"&&(l.direction=!r||r.tagName==="TEXTAREA"?"row":"column"),l.direction==="row"?o=`<${c} class="b3-label">
    <div class="fn__block">
        ${l.title}
        ${l.description?`<div class="b3-label__text">${l.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</${c}>`:o=`<${c} class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${l.title}
        ${l.description?`<div class="b3-label__text">${l.description}</div>`:""}
    </div>
    <span class="fn__space${r?"":" fn__none"}"></span>
</${c}>`,i.insertAdjacentHTML("beforeend",o),r&&(["INPUT","TEXTAREA"].includes(r.tagName)&&a.bindInput(r,()=>{s[1].dispatchEvent(new CustomEvent("click"))},r.tagName==="INPUT"),l.direction==="row"?(i.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",r),r.classList.add("fn__block")):(r.classList.remove("fn__block"),r.classList.add("fn__flex-center","fn__size200"),i.lastElementChild.insertAdjacentElement("beforeend",r)))}),(n=i.querySelector("input, textarea"))==null||n.focus();const s=a.element.querySelectorAll(".b3-dialog__action .b3-button");s[0].addEventListener("click",()=>{a.destroy()}),s[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),a.destroy()}),this.dialog=a}}const by=t=>{window.siyuan.config.editor.readOnly=t,A("/api/setting/setEditor",window.siyuan.config.editor)},qe={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fullWidth}
        <div class="b3-label__text">${window.siyuan.languages.fullWidthTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fullWidth" type="checkbox"${window.siyuan.config.editor.fullWidth?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly} 
        <code class="fn__code${window.siyuan.config.keymap.general.editReadonly.custom?"":" fn__none"}">${pe(window.siyuan.config.keymap.general.editReadonly.custom)}</code>
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.headingEmbedMode}
        <div class="b3-label__text">${window.siyuan.languages.headingEmbedModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="headingEmbedMode">
      <option value="0" ${window.siyuan.config.editor.headingEmbedMode===0?"selected":""}>${window.siyuan.languages.showHeadingWithBlocks}</option>
      <option value="1" ${window.siyuan.config.editor.headingEmbedMode===1?"selected":""}>${window.siyuan.languages.showHeadingOnlyTitle}</option>
      <option value="2" ${window.siyuan.config.editor.headingEmbedMode===2?"selected":""}>${window.siyuan.languages.showHeadingOnlyBlocks}</option>
    </select>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.listItemDotNumberClickFocus}
        <div class="b3-label__text">${window.siyuan.languages.listItemDotNumberClickFocusTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listItemDotNumberClickFocus" type="checkbox"${window.siyuan.config.editor.listItemDotNumberClickFocus?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.onlySearchForDoc?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<div class="b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.md9}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" id="virtualBlockRefInclude">${window.siyuan.config.editor.virtualBlockRefInclude}</textarea>
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.md35}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
        <div class="b3-label__text">${window.siyuan.languages.md41}</div>
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" id="virtualBlockRefExclude">${window.siyuan.config.editor.virtualBlockRefExclude}</textarea>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md39}
        <div class="b3-label__text">${window.siyuan.languages.md40}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.dynamicLoadBlocks}
        <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="dynamicLoadBlocks" type="number" min="48" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md37}
        <div class="b3-label__text">${window.siyuan.languages.md38}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkExpand}
        <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backmentionExpand}
        <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backmentionExpandCount" type="number" min="-1" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkContainChildren}
        <div class="b3-label__text">${window.siyuan.languages.backlinkContainChildrenTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="backlinkContainChildren" type="checkbox"${window.siyuan.config.editor.backlinkContainChildren?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateHistory}
        <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
</div>
<div class="b3-label">
    <div>
        ${window.siyuan.languages.historyRetentionDaysTip}
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.clearHistory}</div>
        <span class="fn__space"></span>
        <button id="clearHistory" class="b3-button b3-button--outline fn__size200 fn__flex-center">
            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.historyRetentionDays}</div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" id="historyRetentionDays" type="number" min="1" max="3650" value="${window.siyuan.config.editor.historyRetentionDays}"/>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.floatWindowMode}
        <div class="b3-label__text">${window.siyuan.languages.floatWindowModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="floatWindowMode">
      <option value="0" ${window.siyuan.config.editor.floatWindowMode===0?"selected":""}>${window.siyuan.languages.floatWindowMode0}</option>
      <option value="1" ${window.siyuan.config.editor.floatWindowMode===1?"selected":""}>${window.siyuan.languages.floatWindowMode1.replace("${hotkey}",pe("\u2318"))}</option>
      <option value="2" ${window.siyuan.config.editor.floatWindowMode===2?"selected":""}>${window.siyuan.languages.floatWindowMode2}</option>
    </select>    
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.font}
        <div class="b3-label__text">${window.siyuan.languages.font1}</div>
    </div>
    <span class="fn__space"></span>
    <input readonly="readonly" placeholder="${window.siyuan.languages.default}" id="fontFamily" class="b3-text-field fn__flex-center fn__size200" style="font-family:'${window.siyuan.config.editor.fontFamily}',var(--b3-font-family);" value="${window.siyuan.config.editor.fontFamily}"/>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSizeScrollZoom}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeScrollZoomTip.replace("Ctrl",pe("\u2318"))}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fontSizeScrollZoom" type="checkbox"${window.siyuan.config.editor.fontSizeScrollZoom?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSize}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.fontSize}">   
        <input class="b3-slider fn__size200" id="fontSize" max="72" min="9" step="1" type="range" value="${window.siyuan.config.editor.fontSize}">
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md29}
        <div class="b3-label__text">${window.siyuan.languages.md30}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.codeTabSpaces}">   
        <input class="b3-slider fn__size200" id="codeTabSpaces" max="8" min="0" step="2" type="range" value="${window.siyuan.config.editor.codeTabSpaces}">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.katexMacros}
        <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" id="katexMacros" spellcheck="false">${window.siyuan.config.editor.katexMacros}</textarea>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.allowHTMLBLockScript}
        <div class="b3-label__text">${window.siyuan.languages.allowHTMLBLockScriptTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowHTMLBLockScript" type="checkbox"${window.siyuan.config.editor.allowHTMLBLockScript?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineAsterisk}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineAsteriskTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineAsterisk" type="checkbox"${window.siyuan.config.editor.markdown.inlineAsterisk?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineUnderscore}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineUnderscoreTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineUnderscore" type="checkbox"${window.siyuan.config.editor.markdown.inlineUnderscore?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineSup}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSupTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSup" type="checkbox"${window.siyuan.config.editor.markdown.inlineSup?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineSub}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSubTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSub" type="checkbox"${window.siyuan.config.editor.markdown.inlineSub?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineTag}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineTagTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineTag" type="checkbox"${window.siyuan.config.editor.markdown.inlineTag?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineMath}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMathTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMath" type="checkbox"${window.siyuan.config.editor.markdown.inlineMath?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineStrikethrough}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineStrikethroughTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineStrikethrough" type="checkbox"${window.siyuan.config.editor.markdown.inlineStrikethrough?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editorMarkdownInlineMark}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMark" type="checkbox"${window.siyuan.config.editor.markdown.inlineMark?" checked":""}/>
</label>`,bindEvent:()=>{const t=qe.element.querySelector("#fontFamily");t.addEventListener("click",()=>{A("/api/system/getSysFonts",{},n=>{const a=new dt;a.addItem({iconHTML:"",checked:window.siyuan.config.editor.fontFamily==="",label:`<div style='var(--b3-font-family);'>${window.siyuan.languages.default}</div>`,click:()=>{window.siyuan.config.editor.fontFamily!==""&&(t.value="",t.style.fontFamily="",e())}}),n.data.forEach(s=>{a.addItem({iconHTML:"",checked:window.siyuan.config.editor.fontFamily===s,label:`<div style='font-family:"${s}",var(--b3-font-family);'>${s}</div>`,click:()=>{s!==window.siyuan.config.editor.fontFamily&&(t.value=s,t.style.fontFamily=s+",var(--b3-font-family)",e())}})});const i=t.getBoundingClientRect();a.open({x:i.left,y:i.bottom})})}),qe.element.querySelector("#clearHistory").addEventListener("click",()=>{Re(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{A("/api/history/clearWorkspaceHistory",{})})});const e=()=>{let n=parseInt(qe.element.querySelector("#dynamicLoadBlocks").value);48>n&&(n=48,qe.element.querySelector("#dynamicLoadBlocks").value="48"),A("/api/setting/setEditor",{fullWidth:qe.element.querySelector("#fullWidth").checked,markdown:{inlineAsterisk:qe.element.querySelector("#editorMarkdownInlineAsterisk").checked,inlineUnderscore:qe.element.querySelector("#editorMarkdownInlineUnderscore").checked,inlineSup:qe.element.querySelector("#editorMarkdownInlineSup").checked,inlineSub:qe.element.querySelector("#editorMarkdownInlineSub").checked,inlineTag:qe.element.querySelector("#editorMarkdownInlineTag").checked,inlineMath:qe.element.querySelector("#editorMarkdownInlineMath").checked,inlineStrikethrough:qe.element.querySelector("#editorMarkdownInlineStrikethrough").checked,inlineMark:qe.element.querySelector("#editorMarkdownInlineMark").checked},allowHTMLBLockScript:qe.element.querySelector("#allowHTMLBLockScript").checked,justify:qe.element.querySelector("#justify").checked,rtl:qe.element.querySelector("#rtl").checked,readOnly:qe.element.querySelector("#readOnly").checked,displayBookmarkIcon:qe.element.querySelector("#displayBookmarkIcon").checked,displayNetImgMark:qe.element.querySelector("#displayNetImgMark").checked,codeSyntaxHighlightLineNum:qe.element.querySelector("#codeSyntaxHighlightLineNum").checked,embedBlockBreadcrumb:qe.element.querySelector("#embedBlockBreadcrumb").checked,headingEmbedMode:parseInt(qe.element.querySelector("#headingEmbedMode").value),listLogicalOutdent:qe.element.querySelector("#listLogicalOutdent").checked,listItemDotNumberClickFocus:qe.element.querySelector("#listItemDotNumberClickFocus").checked,spellcheck:qe.element.querySelector("#spellcheck").checked,onlySearchForDoc:qe.element.querySelector("#onlySearchForDoc").checked,floatWindowMode:parseInt(qe.element.querySelector("#floatWindowMode").value),plantUMLServePath:qe.element.querySelector("#plantUMLServePath").value,katexMacros:qe.element.querySelector("#katexMacros").value,codeLineWrap:qe.element.querySelector("#codeLineWrap").checked,virtualBlockRef:qe.element.querySelector("#virtualBlockRef").checked,virtualBlockRefInclude:qe.element.querySelector("#virtualBlockRefInclude").value,virtualBlockRefExclude:qe.element.querySelector("#virtualBlockRefExclude").value,blockRefDynamicAnchorTextMaxLen:parseInt(qe.element.querySelector("#blockRefDynamicAnchorTextMaxLen").value),backlinkExpandCount:parseInt(qe.element.querySelector("#backlinkExpandCount").value),backmentionExpandCount:parseInt(qe.element.querySelector("#backmentionExpandCount").value),backlinkContainChildren:qe.element.querySelector("#backlinkContainChildren").checked,dynamicLoadBlocks:n,codeLigatures:qe.element.querySelector("#codeLigatures").checked,codeTabSpaces:parseInt(qe.element.querySelector("#codeTabSpaces").value),fontSize:parseInt(qe.element.querySelector("#fontSize").value),fontSizeScrollZoom:qe.element.querySelector("#fontSizeScrollZoom").checked,generateHistoryInterval:parseInt(qe.element.querySelector("#generateHistoryInterval").value),historyRetentionDays:parseInt(qe.element.querySelector("#historyRetentionDays").value),fontFamily:t.value,emoji:window.siyuan.config.editor.emoji},a=>{qe._onSetEditor(a.data)})};qe.element.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(n=>{n.addEventListener("change",()=>{e()})}),qe.element.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(n=>{n.getAttribute("readonly")||n.addEventListener("blur",()=>{e()})}),qe.element.querySelectorAll("input.b3-slider").forEach(n=>{n.addEventListener("input",a=>{const i=a.target;i.parentElement.setAttribute("aria-label",i.value)})})},_onSetEditor:t=>{t.readOnly!==window.siyuan.config.editor.readOnly&&by(t.readOnly),window.siyuan.config.editor=t,Oe().editor.forEach(n=>{Ei(n.editor.protyle,!1);let a=n.editor.protyle.wysiwyg.element.getAttribute(p.CUSTOM_SY_FULLWIDTH);a||(a=window.siyuan.config.editor.fullWidth?"true":"false"),!(a==="true"&&n.editor.protyle.contentElement.getAttribute("data-fullwidth")==="true")&&(mn(n.editor.protyle),a==="true"?n.editor.protyle.contentElement.setAttribute("data-fullwidth","true"):n.editor.protyle.contentElement.removeAttribute("data-fullwidth"))}),td()}},w1=t=>{const e=new $e({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:Y()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_SYNCADDCLOUDDIR);const n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',A("/api/sync/createCloudSyncDir",{name:n.value},()=>{e.destroy(),_d(t,!0)})})},hS=(t,e)=>{t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){const i=a.getAttribute("data-type");if(i){switch(i){case"addCloud":w1(t);break;case"removeCloud":Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',A("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},s=>{window.siyuan.config.sync.cloudName=s.data,_d(t,!0,e)})},void 0,!0);break;case"selectCloud":t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',A("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),_d(t,!0,e)});break}n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})},_d=(t,e=!1,n)=>{!e&&t.firstElementChild.tagName!=="IMG"||A("/api/sync/listCloudSyncDir",{},a=>{let i=`<ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?i=`<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(i='<ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(s=>{i+=`<li data-type="selectCloud" data-name="${s.cloudName}" class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
<input type="radio" name="cloudName"${s.cloudName===a.data.checkedSyncDir?" checked":""}/>
<span class="fn__space"></span>
<span>${s.cloudName}</span>
<span class="fn__space"></span>
<span class="ft__on-surface">${s.hSize}</span>
<span class="b3-list-item__meta">${s.updated}</span>
<span class="fn__flex-1 fn__space"></span>
<span data-type="removeCloud" class="b3-tooltips b3-tooltips__w b3-list-item__action${window.siyuan.config.sync.provider===2||window.siyuan.config.sync.provider===3?" fn__none":""}" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></li>`}),i+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline${window.siyuan.config.sync.provider===2||window.siyuan.config.sync.provider===3?" fn__none":""}" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),t.innerHTML=i,n&&n()})},ig=t=>{var e;if(!window.siyuan.config.readonly&&!((e=document.querySelector("#barSync"))!=null&&e.classList.contains("toolbar__item--active"))){if(window.siyuan.config.sync.provider===0&&as("")&&t){const n=Kl(t);window.siyuan.user?n.element.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")):(n.element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),n.element.querySelector('.config__tab-container[data-name="account"]').setAttribute("data-action","go-repos"));return}if(window.siyuan.config.sync.provider!==0&&!ny()&&t){de(window.siyuan.languages._kernel[214].replaceAll("${accountServer}",Fn("")));return}if(!window.siyuan.config.repo.key){bS();return}if(!window.siyuan.config.sync.enabled){yS();return}sg()}},bS=()=>{const e=`auto-${window.siyuan.config.system.id||"default-device"}-${Date.now()}`;A("/api/repo/initRepoKeyFromPassphrase",{pass:e},n=>{window.siyuan.config.repo.key=n.data.key,de("\u2705 \u5DF2\u81EA\u52A8\u751F\u6210\u540C\u6B65\u5BC6\u94A5",2e3,"info"),window.siyuan.config.sync.enabled?sg():yS()})},sg=()=>{if(window.siyuan.config.sync.mode!==3){Re("\u{1F504} \u5F00\u59CB\u540C\u6B65",`<div class="b3-dialog__content">
                <div class="ft__on-surface" style="margin-bottom: 12px;">
                    \u{1F4A1} \u4F7F\u7528<strong>\u667A\u80FD\u5408\u5E76\u6A21\u5F0F</strong>\uFF0C\u4F1A\u81EA\u52A8\u5408\u5E76\u672C\u5730\u548C\u4E91\u7AEF\u6570\u636E\uFF0C\u907F\u514D\u5185\u5BB9\u4E22\u5931\u3002
                </div>
                <div class="ft__secondary" style="font-size: 12px; line-height: 1.6;">
                    \u2022 \u4F18\u5148\u4FDD\u7559\u8F83\u65B0\u7684\u4FEE\u6539<br>
                    \u2022 \u53D1\u751F\u51B2\u7A81\u65F6\u4F1A\u751F\u6210\u51B2\u7A81\u6587\u6863<br>
                    \u2022 \u4E0D\u4F1A\u5220\u9664\u4EFB\u4F55\u73B0\u6709\u5185\u5BB9
                </div>
            </div>`,()=>{A("/api/sync/performSync",{merge:!0})},()=>{});return}const t=new $e({title:"\u{1F504} \u9009\u62E9\u540C\u6B65\u65B9\u5F0F",content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label" style="margin-bottom: 16px;">
        <input type="radio" name="syncMode" value="merge" checked>
        <span class="fn__space"></span>
        <div>
            <div style="font-weight: 500;">\u{1F500} \u667A\u80FD\u5408\u5E76\uFF08\u63A8\u8350\uFF09</div>
            <div class="b3-label__text">
                \u81EA\u52A8\u5408\u5E76\u672C\u5730\u548C\u4E91\u7AEF\u6570\u636E\uFF0C\u4F18\u5148\u4FDD\u7559\u8F83\u65B0\u4FEE\u6539\uFF0C\u51B2\u7A81\u65F6\u751F\u6210\u51B2\u7A81\u6587\u6863
            </div>
        </div>
    </label>
    <label class="fn__flex b3-label" style="margin-bottom: 16px;">
        <input type="radio" name="syncMode" value="upload">
        <span class="fn__space"></span>
        <div>
            <div style="font-weight: 500;">\u2B06\uFE0F \u4E0A\u4F20\u5230\u4E91\u7AEF</div>
            <div class="b3-label__text">
                ${window.siyuan.languages.uploadData2CloudTip}
            </div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="syncMode" value="download">
        <span class="fn__space"></span>
        <div>
            <div style="font-weight: 500;">\u2B07\uFE0F \u4ECE\u4E91\u7AEF\u4E0B\u8F7D</div>
            <div class="b3-label__text">
                ${window.siyuan.languages.downloadDataFromCloudTip}
            </div>
        </div>
    </label>
    <div class="fn__hr"></div>
    <div style="background: var(--b3-theme-surface-lighter); padding: 12px; border-radius: 4px; font-size: 12px; line-height: 1.6;">
        \u{1F4A1} <strong>\u63D0\u793A</strong>\uFF1A\u9996\u6B21\u540C\u6B65\u5EFA\u8BAE\u9009\u62E9"\u667A\u80FD\u5408\u5E76"\uFF0C\u7CFB\u7EDF\u4F1A\u81EA\u52A8\u5904\u7406\u6570\u636E\u5408\u5E76\uFF0C\u786E\u4FDD\u4E0D\u4E22\u5931\u5185\u5BB9\u3002
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">\u5F00\u59CB\u540C\u6B65</button>
</div>`,width:Y()?"92vw":"560px"});t.element.setAttribute("data-key",p.DIALOG_SYNCCHOOSEDIRECTION);const e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input[name=syncMode]:checked");if(!n){de("\u8BF7\u9009\u62E9\u540C\u6B65\u65B9\u5F0F");return}const a=n.value;a==="merge"?A("/api/sync/performSync",{merge:!0}):a==="upload"?A("/api/sync/performSync",{upload:!0}):A("/api/sync/performSync",{upload:!1}),t.destroy()})},yS=(t,e)=>{if(t&&(window.siyuan.config.repo.key=t),window.siyuan.config.sync.enabled)e&&e.destroy(),Re("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{sg()});else{const n=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div class="fn__hr--b"></div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;e?(e.element.querySelector(".b3-dialog__header").innerHTML="\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,e.element.querySelector(".b3-dialog__body").innerHTML=n):e=new $e({title:"\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,content:n,width:Y()?"92vw":"520px"}),e.element.setAttribute("data-key",p.DIALOG_SYNCCHOOSEDIR);const a=e.element.querySelector(".b3-dialog__content").lastElementChild,i=e.element.querySelector(".b3-button");hS(a,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),_d(a,!1,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{e.destroy(),A("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,gi(),Re("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{sg()})})})}},v1=(t,e)=>{Re("\u{1F511} \u540C\u6B65\u5BC6\u94A5\u8BBE\u7F6E",`<div class="b3-dialog__content">
            <div class="ft__on-surface" style="margin-bottom: 12px;">
                \u7CFB\u7EDF\u5DF2\u4E3A\u60A8\u81EA\u52A8\u751F\u6210\u540C\u6B65\u5BC6\u94A5\uFF0C\u65E0\u9700\u624B\u52A8\u8BBE\u7F6E\u5BC6\u7801\u3002
            </div>
            <div class="ft__secondary" style="font-size: 12px; line-height: 1.6;">
                \u{1F4A1} \u81EA\u52A8\u751F\u6210\u7684\u5BC6\u94A5\u5DF2\u8DB3\u591F\u5B89\u5168<br>
                \u{1F4A1} \u5982\u9700\u81EA\u5B9A\u4E49\u5BC6\u7801\uFF0C\u8BF7\u524D\u5F80\u8BBE\u7F6E\u9875\u9762
            </div>
        </div>`,()=>{bS()},()=>{})};var E1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Rt={element:void 0,genHTML:()=>{const t=window.siyuan.config.system.isMicrosoftStore?`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.currentVer} v${p.SIYUAN_VERSION}
        <span id="isInsider"></span>
        <div class="b3-label__text">${window.siyuan.languages.isMsStoreVerTip}</div>
    </div>
</div>`:`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.currentVer} v${p.SIYUAN_VERSION}
        <span id="isInsider"></span>
        <div class="b3-label__text">${window.siyuan.languages.downloadLatestVer}</div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__flex-center fn__size200 config__item-line">
        <button id="checkUpdateBtn" class="b3-button b3-button--outline fn__block">
            <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}
        </button>
    </div>
</div>`;return`<div class="fn__flex b3-label config__item${Ne()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"||window.siyuan.config.system.os==="linux"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoLaunch}
        <div class="b3-label__text">${window.siyuan.languages.autoLaunchTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="autoLaunch">
      <option value="0" ${window.siyuan.config.system.autoLaunch2===0?"selected":""}>${window.siyuan.languages.autoLaunchMode0}</option>
      <option value="1" ${window.siyuan.config.system.autoLaunch2===1?"selected":""}>${window.siyuan.languages.autoLaunchMode1}</option>
      ${Mt()?"":`<option value="2" ${window.siyuan.config.system.autoLaunch2===2?"selected":""}>${window.siyuan.languages.autoLaunchMode2}</option>`}
    </select>    
</div>
<label class="fn__flex b3-label${Ne()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"||window.siyuan.config.system.os==="linux"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoDownloadUpdatePkg}
        <div class="b3-label__text">${window.siyuan.languages.autoDownloadUpdatePkgTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="downloadInstallPkg" type="checkbox"${window.siyuan.config.system.downloadInstallPkg?" checked":""}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</label>
<div class="b3-label${window.siyuan.config.readonly||Ne()&&!$n()&&!ht()&&!Ha()&&!bt()?" fn__none":""}">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about5}
            <div class="b3-label__text">${window.siyuan.languages.about6}</div>
        </div>
        <div class="fn__space"></div>
        <button class="fn__flex-center b3-button b3-button--outline fn__size200" id="authCode">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <label class="b3-label fn__flex${!window.siyuan.config.accessAuthCode||Ne()?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about7}
            <div class="b3-label__text">${window.siyuan.languages.about8}</div>
        </div>
        <div class="fn__space"></div>
        <input class="b3-switch fn__flex-center" id="lockScreenMode" type="checkbox"${window.siyuan.config.system.lockScreenMode===1?" checked":""}>
    </label>
</div>
<div class="b3-label config__item${Ne()&&!ht()&&!$n()&&!bt()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
       ${window.siyuan.languages.about2}
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        ${(()=>{const e=[],n=[];for(const a of window.siyuan.config.localIPs){if(!a.trim())break;a.startsWith("[")&&a.endsWith("]")?n.push(`<code class="fn__code">${a}</code>`):e.push(`<code class="fn__code">${a}</code>`)}return`<div class="b3-label__text${e.length?"":" fn__none"}">${e.join(" ")}</div>
                    <div class="b3-label__text${n.length?"":" fn__none"}">${n.join(" ")}</div>`})()}
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
    </div>
    <div class="fn__space"></div>
    <button data-type="open" data-url="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.about4}
    </button>
</div>
<div class="b3-label fn__flex config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.dataRepoKey}
        <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
        <div class="b3-label__text"><span class="ft__error">${window.siyuan.languages.dataRepoKeyTip2}</span></div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?" fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            <svg><use xlink:href="#iconHand"></use></svg>${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?"":" fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="resetRepo">
            <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
</div>
<div class="b3-label">
    <div>
        ${window.siyuan.languages.dataRepoPurge}
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.dataRepoPurgeTip}</div>
        <span class="fn__space"></span>
        <button id="purgeRepo" class="b3-button b3-button--outline fn__size200 fn__flex-center">
            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.dataRepoAutoPurgeIndexRetentionDays}</div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" min="1" type="number" id="indexRetentionDays" value="${window.siyuan.config.repo.indexRetentionDays}">
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.dataRepoAutoPurgeRetentionIndexesDaily}</div>
        <span class="fn__space"></span>
        <input class="b3-text-field fn__flex-center fn__size200" min="1" type="number" id="retentionIndexesDaily" value="${window.siyuan.config.repo.retentionIndexesDaily}">
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.vacuumDataIndex}
        <div class="b3-label__text">${window.siyuan.languages.vacuumDataIndexTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="vacuumDataIndex" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.vacuumDataIndex}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rebuildDataIndex}
        <div class="b3-label__text">${window.siyuan.languages.rebuildDataIndexTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="rebuildDataIndex" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.rebuildDataIndex}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.systemLog}
        <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="exportLog" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
${t}
<div class="fn__flex config__item  b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about13}
         <div class="b3-label__text" id="tokenTip">${window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="token" value="${window.siyuan.config.api.token}">
</div>
<div class="b3-label">
    ${window.siyuan.languages.networkProxy}
    <div class="b3-label__text">
        ${window.siyuan.languages.about17}
    </div>
    <div class="b3-label__text fn__flex config__item">
        <select id="aboutScheme" class="b3-select">
            <option value="" ${window.siyuan.config.system.networkProxy.scheme===""?"selected":""}>${window.siyuan.languages.directConnection}</option>
            <option value="socks5" ${window.siyuan.config.system.networkProxy.scheme==="socks5"?"selected":""}>SOCKS5</option>
            <option value="https" ${window.siyuan.config.system.networkProxy.scheme==="https"?"selected":""}>HTTPS</option>
            <option value="http" ${window.siyuan.config.system.networkProxy.scheme==="http"?"selected":""}>HTTP</option>
        </select>
        <span class="fn__space"></span>
        <input id="aboutHost" placeholder="user:pass@IP" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.host}"/>
        <span class="fn__space"></span>
        <input id="aboutPort" placeholder="Port" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.port}" type="number"/>
        <span class="fn__space"></span>
        <button id="aboutConfirm" class="b3-button fn__size200 b3-button--outline">${window.siyuan.languages.confirm}</button>
    </div>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span>${window.siyuan.languages.siyuanNote}</span>
        <span class="fn__space"></span>
        <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        <span class="fn__space"></span>
        <span style="color:var(--b3-theme-background);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</span>
    </div>
    <div class='fn__hr'></div>
    ${window.siyuan.languages.about1} ${window.siyuan.config.system.container==="harmony"?" \u2022 "+window.siyuan.languages.feedback+" 845765@qq.com":""} 
</div>`},bindEvent:()=>{window.siyuan.config.system.isInsider&&(Rt.element.querySelector("#isInsider").innerHTML="<span class='ft__secondary'>Insider Preview</span>");const t=Rt.element.querySelector("#indexRetentionDays");t.addEventListener("change",()=>{A("/api/repo/setRepoIndexRetentionDays",{days:parseInt(t.value)},()=>{window.siyuan.config.repo.indexRetentionDays=parseInt(t.value)})});const e=Rt.element.querySelector("#retentionIndexesDaily");e.addEventListener("change",()=>{A("/api/repo/setRetentionIndexesDaily",{indexes:parseInt(e.value)},()=>{window.siyuan.config.repo.retentionIndexesDaily=parseInt(e.value)})});const n=Rt.element.querySelector("#token");n.addEventListener("click",()=>{n.select()}),n.addEventListener("change",()=>{A("/api/system/setAPIToken",{token:n.value},()=>{window.siyuan.config.api.token=n.value,Rt.element.querySelector("#tokenTip").innerHTML=window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)})}),Rt.element.querySelector("#vacuumDataIndex").addEventListener("click",()=>{A("/api/system/vacuumDataIndex",{},()=>{})}),Rt.element.querySelector("#rebuildDataIndex").addEventListener("click",()=>{A("/api/system/rebuildDataIndex",{},()=>{})}),Rt.element.querySelector("#exportLog").addEventListener("click",()=>{A("/api/system/exportLog",{},r=>{nn(r.data.zip)})});const a=Rt.element.querySelector("#checkUpdateBtn");a==null||a.addEventListener("click",()=>{a.firstElementChild.classList.contains("fn__rotate")||(a.innerHTML=`<svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`,A("/api/system/checkUpdate",{showMsg:!0},()=>{a.innerHTML=`<svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`}))}),Rt.element.querySelectorAll('[data-type="open"]').forEach(r=>{r.addEventListener("click",()=>{const c=r.getAttribute("data-url");window.open(c)})}),Rt.element.querySelector("#authCode").addEventListener("click",()=>{l1()});const i=Rt.element.querySelector("#importKey");i.addEventListener("click",()=>{const r=new $e({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea spellcheck="false" style="resize: vertical;" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"});r.element.setAttribute("data-key",p.DIALOG_PASSWORD);const c=r.element.querySelector("textarea");c.focus();const d=r.element.querySelectorAll(".b3-button");d[0].addEventListener("click",()=>{r.destroy()}),d[1].addEventListener("click",()=>{A("/api/repo/importRepoKey",{key:c.value},u=>{window.siyuan.config.repo.key=u.data.key,i.parentElement.classList.add("fn__none"),i.parentElement.nextElementSibling.classList.remove("fn__none"),r.destroy()})})}),Rt.element.querySelector("#initKey").addEventListener("click",()=>{Re("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{A("/api/repo/initRepoKey",{},r=>{window.siyuan.config.repo.key=r.data.key,i.parentElement.classList.add("fn__none"),i.parentElement.nextElementSibling.classList.remove("fn__none")})})}),Rt.element.querySelector("#initKeyByPW").addEventListener("click",()=>{v1(!1,()=>{i.parentElement.classList.add("fn__none"),i.parentElement.nextElementSibling.classList.remove("fn__none")})}),Rt.element.querySelector("#copyKey").addEventListener("click",()=>{de(window.siyuan.languages.copied),Be(window.siyuan.config.repo.key)}),Rt.element.querySelector("#resetRepo").addEventListener("click",()=>{Re("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{A("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,gi(),i.parentElement.classList.remove("fn__none"),i.parentElement.nextElementSibling.classList.add("fn__none")})})}),Rt.element.querySelector("#purgeRepo").addEventListener("click",()=>{Re("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{A("/api/repo/purgeRepo")})});const s=Rt.element.querySelector("#networkServe");s.addEventListener("change",()=>{A("/api/system/setNetworkServe",{networkServe:s.checked},()=>{Un({errorExit:!0,cb:Ns})})});const l=Rt.element.querySelector("#lockScreenMode");l.addEventListener("change",()=>{A("/api/system/setFollowSystemLockScreen",{lockScreenMode:l.checked?1:0},()=>{window.siyuan.config.system.lockScreenMode=l.checked?1:0})});const o=Rt.element.querySelector("#downloadInstallPkg");o.addEventListener("change",()=>{A("/api/system/setDownloadInstallPkg",{downloadInstallPkg:o.checked},()=>{window.siyuan.config.system.downloadInstallPkg=o.checked})}),Rt.element.querySelector("#aboutConfirm").addEventListener("click",()=>{const r=Rt.element.querySelector("#aboutScheme").value,c=Rt.element.querySelector("#aboutHost").value,d=Rt.element.querySelector("#aboutPort").value;A("/api/system/setNetworkProxy",{scheme:r,host:c,port:d},()=>E1(void 0,null,function*(){window.siyuan.config.system.networkProxy.scheme=r,window.siyuan.config.system.networkProxy.host=c,window.siyuan.config.system.networkProxy.port=d}))})}},Wa={element:void 0,genHTML:()=>{const t=Y();return`<div class="fn__flex-column" style="height: 100%">
    <div class="layout-tab-bar fn__flex">
        <div class="item item--full item--focus" data-type="remove">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.unreferencedAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="missing">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.missingAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="config-assets${t?" b3-list--mobile":""}" data-type="remove" data-init="true">
            <div class="fn__hr--b"></div>
            <div class="fn__flex">
                <div class="fn__space"></div>
                <button id="removeAll" class="b3-button b3-button--outline fn__flex-center fn__size200">
                    <svg class="svg"><use xlink:href="#iconTrashcan"></use></svg>
                    ${window.siyuan.languages.delete}
                </button>
            </div>
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="config-assets__preview"></div>
        </div>
        <div class="fn__none config-assets${t?" b3-list--mobile":""}" data-type="missing">
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="fn__hr"></div>
        </div>
    </div>
</div>`},bindEvent:()=>{const t=Wa.element.querySelector(".config-assets__list");Wa.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(Wa.element);){const a=n.getAttribute("data-type");if(n.id==="removeAll")Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.clearAll}`,()=>{A("/api/asset/removeUnusedAssets",{},i=>{Oe().asset.forEach(s=>{i.data.paths.includes(s.path)&&s.parent.close()}),t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Wa.element.querySelector(".config-assets__preview").innerHTML=""})},void 0,!0);else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){Wa.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),Wa.element.querySelectorAll(".config-assets").forEach(i=>{a===i.getAttribute("data-type")?(i.classList.remove("fn__none"),i.getAttribute("data-init")||(A("/api/asset/getMissingAssets",{},s=>{Wa._renderList(s.data.missingAssets,i.querySelector(".config-assets__list"),!1)}),i.setAttribute("data-init","true"))):i.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(a==="copy")Be(n.parentElement.querySelector(".b3-list-item__text").textContent.trim().replace("assets/",""));else if(a!=="open"){if(a==="clear"){const i=n.parentElement.getAttribute("data-path");Re(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.delete} <b>${De().basename(i)}</b>`,()=>{A("/api/asset/removeUnusedAsset",{path:i},s=>{Oe().asset.forEach(o=>{s.data.path===o.path&&o.parent.parent.removeTab(o.parent.id)});const l=n.parentElement;l.parentElement.querySelectorAll("li").length===1?l.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`:l.remove(),Wa.element.querySelector(".config-assets__preview").innerHTML=""})},void 0,!0),e.preventDefault(),e.stopPropagation();break}}n=n.parentElement}}),t.addEventListener("mouseover",e=>{const n=T(e.target,"b3-list-item");if(n&&n.getAttribute("data-path")!==t.nextElementSibling.getAttribute("data-path")){const a=n.getAttribute("data-path");t.nextElementSibling.setAttribute("data-path",a),t.nextElementSibling.innerHTML=Cl(a)}}),A("/api/asset/getUnusedAssets",{},e=>{Wa._renderList(e.data.unusedAssets,t)})},_renderList:(t,e,n=!0)=>{let a="",i="";!Ne()&&n&&(i=`<span data-type="open" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`);let s="";n&&(s=`<span data-type="clear" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`);const l=Y();t.forEach(o=>{const r=o.indexOf("assets/"),c=o.substr(r);a+=`<li data-path="${c}"  class="b3-list-item${l?"":" b3-list-item--hide-action"}">
    <span class="b3-list-item__text">${he(o)}</span>
    <span data-type="copy" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>
    ${i}
    ${s}
</li>`}),e.innerHTML=a||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`}},_S=t=>{const e=new $e({positionId:p.DIALOG_SAVEWORKSPACE,title:t?window.siyuan.languages.edit:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${t||""}" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove${t?"":" fn__none"}">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text${t?"":" fn__none"}">${window.siyuan.languages.rename}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages[t?"updateLayout":"confirm"]}</button>
</div>`,width:"520px"});e.element.setAttribute("data-key",p.DIALOG_SAVEWORKSPACE);const n=e.element.querySelectorAll(".b3-button"),a=e.element.querySelector("input");a.select(),a.focus(),e.bindInput(a,()=>{n[3].dispatchEvent(new CustomEvent("click"))}),n[0].addEventListener("click",()=>{window.siyuan.storage[p.LOCAL_LAYOUTS].find((i,s)=>{if(i.name===t)return window.siyuan.storage[p.LOCAL_LAYOUTS].splice(s,1),Ee(p.LOCAL_LAYOUTS,window.siyuan.storage[p.LOCAL_LAYOUTS]),!0}),e.destroy()}),n[1].addEventListener("click",()=>{e.destroy()}),n[2].addEventListener("click",()=>{const i=a.value;if(!i){de(window.siyuan.languages._kernel[142]);return}e.destroy(),window.siyuan.storage[p.LOCAL_LAYOUTS].find(s=>{if(s.name===t)return s.name=i,s.time=new Date().getTime(),Ee(p.LOCAL_LAYOUTS,window.siyuan.storage[p.LOCAL_LAYOUTS]),!0})}),n[3].addEventListener("click",()=>{const i=a.value;if(!i){de(window.siyuan.languages._kernel[142]);return}if(e.destroy(),t){window.siyuan.storage[p.LOCAL_LAYOUTS].find(l=>{if(l.name===t)return l.name=i,l.time=new Date().getTime(),l.layout=xy(),l.filesPaths=window.siyuan.storage[p.LOCAL_FILESPATHS],Ee(p.LOCAL_LAYOUTS,window.siyuan.storage[p.LOCAL_LAYOUTS]),!0});return}window.siyuan.storage[p.LOCAL_LAYOUTS].find(l=>{if(l.name===i)return Re(window.siyuan.languages.save,window.siyuan.languages.exportTplTip,()=>{l.layout=xy(),l.time=new Date().getTime(),l.filesPaths=window.siyuan.storage[p.LOCAL_FILESPATHS],Ee(p.LOCAL_LAYOUTS,window.siyuan.storage[p.LOCAL_LAYOUTS])}),!0})||(window.siyuan.storage[p.LOCAL_LAYOUTS].push({name:i,time:new Date().getTime(),layout:xy(),filesPaths:window.siyuan.storage[p.LOCAL_FILESPATHS]}),Ee(p.LOCAL_LAYOUTS,window.siyuan.storage[p.LOCAL_LAYOUTS]))})},yy=(t,e,n)=>({id:t,label:`${e.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}`,icon:n,current:!e.pin,click(){e.togglePin()}}),_y=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BAR_WORKSPACE){window.siyuan.menus.menu.remove();return}A("/api/system/getWorkspaces",{},n=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BAR_WORKSPACE);const a=[];if(zp().forEach(s=>{a.push({id:s.type,icon:s.icon,accelerator:s.hotkey,label:s.title,click(){nt(s.type).toggleModel(s.type)}})}),window.siyuan.config.readonly||(a.push({id:"separator_1",type:"separator"}),a.push(yy("leftDock",window.siyuan.layout.leftDock,"iconLeftTop")),a.push(yy("rightDock",window.siyuan.layout.rightDock,"iconRightTop")),a.push(yy("bottomDock",window.siyuan.layout.bottomDock,"iconBottomLeft"))),window.siyuan.menus.menu.append(new N({id:"panels",label:window.siyuan.languages.panels,icon:"iconDock",type:"submenu",submenu:a}).element),!window.siyuan.config.readonly){let s;s=[{id:"new",label:window.siyuan.languages.new,iconHTML:"",click(){const l=new $e({title:window.siyuan.languages.new,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"});l.element.setAttribute("data-key",p.DIALOG_CREATEWORKSPACE);const o=l.element.querySelector("input");o.focus();const r=l.element.querySelectorAll(".b3-button");r[0].addEventListener("click",()=>{l.destroy()}),r[1].addEventListener("click",()=>{A("/api/system/createWorkspaceDir",{path:De().join(De().dirname(window.siyuan.config.system.workspaceDir),o.value)},()=>{l.destroy()})})}},{id:"openBy",label:`${window.siyuan.languages.openBy}...`,iconHTML:"",click(){A("/api/system/getMobileWorkspaces",{},l=>{let o="";l.data.forEach((d,u)=>{o+=`<option value="${d}"${u===0?' selected="selected"':""}>${De().basename(d)}</option>`});const r=new $e({title:window.siyuan.languages.openBy,content:`<div class="b3-dialog__content">
    <select class="b3-text-field fn__block">${o}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"});r.element.setAttribute("data-key",p.DIALOG_OPENWORKSPACE);const c=r.element.querySelectorAll(".b3-button");c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{const d=r.element.querySelector("select").value;if(d===window.siyuan.config.system.workspaceDir){r.destroy();return}Re(window.siyuan.languages.confirm,`${De().basename(window.siyuan.config.system.workspaceDir)} -> ${De().basename(d)}?`,()=>{A("/api/system/setWorkspaceDir",{path:d},()=>{Ns()})})})})}}],s.push({id:"separator_1",type:"separator"}),n.data.forEach(l=>{s.push({iconHTML:"",action:"iconCloseRound",current:window.siyuan.config.system.workspaceDir===l.path,label:De().basename(l.path),bind(o){o.addEventListener("click",r=>{if(T(r.target,"b3-menu__action")){r.preventDefault(),r.stopPropagation(),A("/api/system/removeWorkspaceDir",{path:l.path},()=>{Re(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeWorkspacePhysically.replace("${x}",l.path),()=>{A("/api/system/removeWorkspaceDirPhysically",{path:l.path})},void 0,!0)});return}Re(window.siyuan.languages.confirm,`${De().basename(window.siyuan.config.system.workspaceDir)} -> ${De().basename(l.path)}?`,()=>{A("/api/system/setWorkspaceDir",{path:l.path},()=>{Ns()})})})}})}),(!Ne()||$n()||ht()||bt())&&window.siyuan.menus.menu.append(new N({id:"workspaceList",label:window.siyuan.languages.workspaceList,icon:"iconWorkspace",type:"submenu",submenu:s}).element)}const i=[{id:"save",iconHTML:"",label:window.siyuan.languages.save,click(){_S()}}];if(window.siyuan.storage[p.LOCAL_LAYOUTS].length>0&&(i.push({id:"separator_1",type:"separator"}),i.push({iconHTML:"",type:"empty",label:`<input class="b3-text-field fn__block" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
<div class="b3-list b3-list--background" style="max-width: 50vw"></div>`,bind(s){const l=()=>{let c="";return window.siyuan.storage[p.LOCAL_LAYOUTS].sort((d,u)=>d.name.localeCompare(u.name,void 0,{numeric:!0})).forEach(d=>{(o.value===""||d.name.toLowerCase().indexOf(o.value.toLowerCase())>-1)&&(c+=`<div data-name="${d.name}" class="b3-list-item b3-list-item--narrow b3-list-item--hide-action ${c?"":"b3-list-item--focus"}">
    <div class="b3-list-item__text">${d.name}</div>
    <span class="b3-list-item__meta">${d.time?Q(d.time).format("YYYY-MM-DD HH:mm"):""}</span>
    <span class="b3-list-item__action">
        <svg><use xlink:href="#iconEdit"></use></svg>
    </span>
</div>`)}),c},o=s.querySelector(".b3-text-field"),r=s.querySelector(".b3-list");o.addEventListener("keydown",c=>{if(c.stopPropagation(),!c.isComposing){if(xn(r,c),c.key==="Escape")window.siyuan.menus.menu.remove();else if(c.key==="Enter"){const d=r.querySelector(".b3-list-item--focus");d&&r.dispatchEvent(new CustomEvent("click",{detail:d.getAttribute("data-name")}))}}}),o.addEventListener("compositionend",()=>{r.innerHTML=l()}),o.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),r.innerHTML=l())}),r.addEventListener("click",c=>{if(window.siyuan.config.readonly)return;const d=T(c.target,"b3-list-item__action");if(d){c.preventDefault(),c.stopPropagation(),_S(d.parentElement.dataset.name),window.siyuan.menus.menu.remove();return}const u=T(c.target,"b3-list-item");if(u||c.detail){const m=window.siyuan.storage[p.LOCAL_LAYOUTS].find(f=>{if(typeof c.detail=="string")return f.name===c.detail;if(u)return f.name===u.dataset.name});m&&A("/api/system/setUILayout",{layout:m.layout},()=>{m.filesPaths?(window.siyuan.storage[p.LOCAL_FILESPATHS]=m.filesPaths,Ee(p.LOCAL_FILESPATHS,m.filesPaths,()=>{window.location.reload()})):window.location.reload()}),c.preventDefault(),c.stopPropagation()}}),r.innerHTML=l()}})),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({id:"layout",label:window.siyuan.languages.layout,icon:"iconLayout",type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){if(Qm()<2)window.siyuan.menus.menu.append(new N({id:"dailyNote",label:window.siyuan.languages.dailyNote,icon:"iconCalendar",accelerator:window.siyuan.config.keymap.general.dailyNote.custom,click:()=>{gh(t)}}).element);else{const s=[];window.siyuan.notebooks.forEach(l=>{l.closed||s.push({label:he(l.name),iconHTML:be(l.icon||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-menu__icon",!0),accelerator:window.siyuan.storage[p.LOCAL_DAILYNOTEID]===l.id?window.siyuan.config.keymap.general.dailyNote.custom:"",click:()=>{op(t,l.id),window.siyuan.storage[p.LOCAL_DAILYNOTEID]=l.id,Ee(p.LOCAL_DAILYNOTEID,window.siyuan.storage[p.LOCAL_DAILYNOTEID])}})}),window.siyuan.menus.menu.append(new N({id:"dailyNote",label:window.siyuan.languages.dailyNote,icon:"iconCalendar",type:"submenu",submenu:s}).element)}window.siyuan.config.readonly||window.siyuan.menus.menu.append(new N({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.general.riffCard.custom,click:()=>{Wo(t)}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{Vo(t,"",window.siyuan.languages.all,"")}}]}).element),window.siyuan.menus.menu.append(new N({id:"recentDocs",label:window.siyuan.languages.recentDocs,icon:"iconFile",accelerator:window.siyuan.config.keymap.general.recentDocs.custom,click:()=>{ng()}}).element),window.siyuan.menus.menu.append(new N({id:"lockScreen",label:window.siyuan.languages.lockScreen,icon:"iconLock",accelerator:window.siyuan.config.keymap.general.lockScreen.custom,click:()=>{jp(t)}}).element),window.siyuan.menus.menu.append(new N({id:"dataHistory",label:window.siyuan.languages.dataHistory,icon:"iconHistory",accelerator:window.siyuan.config.keymap.general.dataHistory.custom,click:()=>{pp(t)}}).element),window.siyuan.menus.menu.append(new N({id:"separator_2",type:"separator"}).element)}window.siyuan.menus.menu.append(new N({id:"userGuide",label:window.siyuan.languages.userGuide,icon:"iconHelp",ignore:Ha()||window.siyuan.config.readonly,click:()=>{rp()}}).element),window.siyuan.menus.menu.append(new N({id:"feedback",label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),(Ha()||ht()||bt()||!Ne())&&(window.siyuan.menus.menu.append(new N({id:"separator_3",type:"separator"}).element),window.siyuan.menus.menu.append(new N({id:"safeQuit",label:window.siyuan.languages.safeQuit,icon:"iconQuit",warning:!0,click:()=>{Un({errorExit:!0,cb:Ns})}}).element)),window.siyuan.menus.menu.popup({x:e.left,y:e.bottom})})},$D=t=>{},MD=t=>{},wS=t=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new N({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:xs([t])}).element),window.siyuan.menus.menu),k1=(t,e)=>{if(getSelection().rangeCount===0)return!1;const n=getSelection().getRangeAt(0);if(T(n.startContainer,"protyle",!0))return!1;let a,i,s,l,o;if(window.siyuan.dialogs.find(w=>{if(w.element.contains(n.startContainer)&&w.element.querySelector("#searchList"))return a=w.element.querySelector(".b3-dialog__body"),i=w,o=i.data,s=i.editors.edit,l=i.editors.unRefEdit,!0}),a||Oe().search.find(w=>{if(w.element.contains(n.startContainer))return a=w.element,s=w.editors.edit,o=w.config,l=w.editors.unRefEdit,!0}),!a)return!1;const r=a.querySelector("#searchAssets"),c=a.querySelector("#searchUnRefPanel"),d=r.classList.contains("fn__none")?c.classList.contains("fn__none")?"doc":"unRef":"asset",u=d==="asset"?r.querySelector("#searchAssetList"):d==="doc"?a.querySelector("#searchList"):c.querySelector("#searchUnRefList"),m=a.querySelector("#searchInput");if(d==="doc"&&W(window.siyuan.config.keymap.general.newFile.custom,e))return o.method===0&&bh(t,m.value),!0;const f=e.target.id;if(e.key==="ArrowDown"&&e.altKey)return d==="asset"?nv(r):d==="doc"&&(f==="replaceInput"?ev(a.querySelector("#replaceInput")):tv(a,o,s)),!0;const g=window.siyuan.storage[p.LOCAL_SEARCHASSET];if(!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;let h=u.querySelector(".b3-list-item--focus");if(!h)return!1;if(h.getAttribute("data-type")==="search-new")return e.key==="Enter"&&o.method===0?(bh(t,m.value),!0):!1;if(d!=="asset"){if(W(window.siyuan.config.keymap.editor.general.insertRight.custom,e)){const E=h.getAttribute("data-node-id");return ft(E,(C,$)=>{ve({app:t,id:E,position:"right",action:$,zoomIn:C}),i&&i.destroy({focus:"false"})}),!0}const w=h.getAttribute("data-node-id");if(W("\u2318/",e)){const E=h.getBoundingClientRect();return wS(w).popup({x:E.left+30,y:E.bottom}),!0}if(W(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e))return A("/api/block/getRefText",{id:w},E=>{Be(`((${w} '${E.data}'))`)}),!0;if(W(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e))return Be(`{{select * from blocks where id='${w}'}}`),!0;if(W(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e))return Be(`siyuan://blocks/${w}`),!0;if(W(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e))return A("/api/block/getRefText",{id:w},E=>{Be(`[${E.data}](siyuan://blocks/${w})`)}),!0;if(W(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return A("/api/filetree/getHPathByID",{id:w},E=>{Be(E.data)}),!0;if(W(window.siyuan.config.keymap.editor.general.copyID.custom,e))return Be(w),!0}if(p.KEYCODELIST[e.keyCode]==="PageUp"){if(d==="asset"){if(!r.querySelector('[data-type="assetPrevious"]').getAttribute("disabled")){let w=parseInt(r.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);w>1&&(w--,da(r,g,w))}}else if(d==="doc")a.querySelector('[data-type="previous"]').getAttribute("disabled")||o.page>1&&(o.page--,En(a,o,s));else if(d==="unRef"&&!a.querySelector('[data-type="unRefPrevious"]').getAttribute("disabled")){let w=parseInt(c.querySelector("#searchUnRefResult").textContent);w>1&&(w--,zo(c,l,w))}return!0}if(p.KEYCODELIST[e.keyCode]==="PageDown"){if(d==="asset"){if(!r.querySelector('[data-type="assetNext"]').getAttribute("disabled")){const w=r.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/");let E=parseInt(w[0]);E<parseInt(w[1])&&(E++,da(r,g,E))}}else if(d==="doc"){const w=a.querySelector('[data-type="next"]');w.getAttribute("disabled")||o.page<parseInt(w.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(o.page++,En(a,o,s))}else if(d==="unRef"&&!a.querySelector('[data-type="unRefNext"]').getAttribute("disabled")){let w=parseInt(c.querySelector("#searchUnRefResult").textContent);w<parseInt(c.querySelector("#searchUnRefResult").textContent.split("/")[1])&&(w++,zo(c,l,w))}return!0}if(!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.key==="Enter"){if(d!=="asset")if(f==="replaceInput")wh(a,o,s,!1);else{const w=h.getAttribute("data-node-id");ft(w,(E,C)=>{ve({app:t,id:w,action:C,zoomIn:E}),i&&i.destroy({focus:"false"})})}return!0}const b=28,y=r.querySelector("#searchAssetPreview");return e.key==="ArrowDown"?(h.classList.remove("b3-list-item--focus"),h.nextElementSibling?h.nextElementSibling.classList.add("b3-list-item--focus"):o.group===1&&d==="doc"?h.parentElement.nextElementSibling?h.parentElement.nextElementSibling.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):u.children[1].firstElementChild.classList.add("b3-list-item--focus"):u.firstElementChild.classList.add("b3-list-item--focus"),h=u.querySelector(".b3-list-item--focus"),(u.scrollTop<h.offsetTop-u.clientHeight+b||u.scrollTop>h.offsetTop)&&(u.scrollTop=h.offsetTop-u.clientHeight+b),d==="asset"?dp(y,h.dataset.id,m.value,g.method):xl(d==="doc"?{id:h.getAttribute("data-node-id"),config:o,value:m.value,edit:s}:{id:h.getAttribute("data-node-id"),edit:l}),!0):e.key==="ArrowUp"?(h.classList.remove("b3-list-item--focus"),h.previousElementSibling?h.previousElementSibling.classList.add("b3-list-item--focus"):o.group===1&&d==="doc"?h.parentElement.previousElementSibling.previousElementSibling?h.parentElement.previousElementSibling.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):u.lastElementChild.lastElementChild.classList.add("b3-list-item--focus"):u.lastElementChild.classList.add("b3-list-item--focus"),h=u.querySelector(".b3-list-item--focus"),(u.scrollTop<h.offsetTop-u.clientHeight+b||u.scrollTop>h.offsetTop-b*2)&&(u.scrollTop=h.offsetTop-b*2),d==="asset"?dp(y,h.dataset.id,m.value,g.method):d==="doc"?xl({id:h.getAttribute("data-node-id"),config:o,value:m.value,edit:s}):d==="unRef"&&xl({id:h.getAttribute("data-node-id"),edit:l}),!0):!1},S1=(t,e)=>{let n=e.element.querySelector(".history__side .b3-list-item--focus");const a=Array.from(e.element.querySelectorAll(".history__side .b3-list-item[data-id]"));if(a.length<2)return;n?(n.classList.remove("b3-list-item--focus"),t.key==="Home"?n=a[0]:t.key==="End"?n=a[a.length-1]:a.find((o,r)=>{if(o===n)return t.key==="ArrowUp"?r===0?n=a[a.length-1]:n=a[r-1]:t.key==="ArrowDown"&&(r===a.length-1?n=a[0]:n=a[r+1]),!0})):n=a[0],n.classList.add("b3-list-item--focus"),n.parentElement.classList.contains("fn__none")&&(n.parentElement.classList.remove("fn__none"),n.parentElement.previousElementSibling.querySelector("svg").classList.add("b3-list-item__arrow--open"));const i=n.getBoundingClientRect(),l=e.element.querySelector(".history__side").getBoundingClientRect();i.bottom>l.bottom?n.scrollIntoView(!1):i.top<l.top&&n.scrollIntoView(),e.element.dispatchEvent(new CustomEvent("click",{detail:t.key.toLowerCase()}))};var L1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const A1=t=>{const e=[],n=[],a=[];let i=-1;t.parent.children.forEach((s,l)=>{var o,r;const c=s.model;(!c||(o=c.editor)!=null&&o.protyle&&!((r=c.editor)!=null&&r.protyle.updated))&&e.push(s),s.id===t.id&&(i=l),i===-1?n.push(s):l>i&&a.push(s)}),window.siyuan.menus.menu.append(new N({id:"close",icon:"iconClose",label:window.siyuan.languages.close,accelerator:window.siyuan.config.keymap.general.closeTab.custom,click:()=>{t.parent.removeTab(t.id)}}).element),t.parent.children.length>1&&(window.siyuan.menus.menu.append(new N({id:"closeOthers",label:window.siyuan.languages.closeOthers,accelerator:window.siyuan.config.keymap.general.closeOthers.custom,click(){is(t,"closeOthers")}}).element),window.siyuan.menus.menu.append(new N({id:"closeAll",label:window.siyuan.languages.closeAll,accelerator:window.siyuan.config.keymap.general.closeAll.custom,click(){is(t,"closeAll")}}).element),e.length>0&&window.siyuan.menus.menu.append(new N({id:"closeUnmodified",label:window.siyuan.languages.closeUnmodified,accelerator:window.siyuan.config.keymap.general.closeUnmodified.custom,click(){is(t,"other",e)}}).element),n.length>0&&window.siyuan.menus.menu.append(new N({id:"closeLeft",label:window.siyuan.languages.closeLeft,accelerator:window.siyuan.config.keymap.general.closeLeft.custom,click:()=>L1(void 0,null,function*(){is(t,"other",n)})}).element),a.length>0&&window.siyuan.menus.menu.append(new N({id:"closeRight",label:window.siyuan.languages.closeRight,accelerator:window.siyuan.config.keymap.general.closeRight.custom,click(){is(t,"other",a)}}).element)),window.siyuan.menus.menu.append(new N({id:"separator_1",type:"separator"}).element)},x1=(t,e)=>{const n=[{id:"splitLR",icon:"iconSplitLR",accelerator:window.siyuan.config.keymap.general.splitLR.custom,label:window.siyuan.languages.splitLR,click:()=>{e.parent.split("lr").addTab(ag(t,e))}}];e.parent.children.length>1&&n.push({id:"splitMoveR",icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.general.splitMoveR.custom,label:window.siyuan.languages.splitMoveR,click:()=>{const i=e.parent.split("lr");i.headersElement.append(e.headElement),i.headersElement.parentElement.classList.remove("fn__none"),i.moveTab(e),Sn()}}),n.push({id:"splitTB",icon:"iconSplitTB",accelerator:window.siyuan.config.keymap.general.splitTB.custom,label:window.siyuan.languages.splitTB,click:()=>{e.parent.split("tb").addTab(ag(t,e))}}),e.parent.children.length>1&&n.push({id:"splitMoveB",icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.general.splitMoveB.custom,label:window.siyuan.languages.splitMoveB,click:()=>{const i=e.parent.split("tb");i.headersElement.append(e.headElement),i.headersElement.parentElement.classList.remove("fn__none"),i.moveTab(e),Sn()}});let a=[];return pr(window.siyuan.layout.centerLayout,a),a.length>1&&(n.push({id:"unsplit",label:window.siyuan.languages.unsplit,accelerator:window.siyuan.config.keymap.general.unsplit.custom,click:()=>{let i=e.parent.parent;for(;i.id!==window.siyuan.layout.centerLayout.id&&(a=[],pr(i,a),!(a.length>1));)i=i.parent;wd(e.parent.parent.children[0],i,!0),Sn()}}),n.push({id:"unsplitAll",label:window.siyuan.languages.unsplitAll,accelerator:window.siyuan.config.keymap.general.unsplitAll.custom,click:()=>{wd(window.siyuan.layout.centerLayout,window.siyuan.layout.centerLayout,!1),Sn()}})),n},vS=(t,e)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_TAB),A1(e),window.siyuan.menus.menu.append(new N({id:"split",label:window.siyuan.languages.split,submenu:x1(t,e)}).element);const n=e.model;let a;if(n&&n instanceof Ot)a=n.editor.protyle.block.rootID;else{const i=e.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s&&s.instance==="Editor"&&(a=s.rootId||s.blockId)}}return a?window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:xs([a],!1)}).element):n&&n instanceof ts&&window.siyuan.menus.menu.append(new N({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){Be(`[${Bf(n.parent.title)}${De().extname(n.path)}](${n.path})`)}}).element),e.headElement.classList.contains("item--pin")?window.siyuan.menus.menu.append(new N({id:"unpin",label:window.siyuan.languages.unpin,icon:"iconUnpin",click:()=>{e.unpin()}}).element):window.siyuan.menus.menu.append(new N({id:"pin",label:window.siyuan.languages.pin,icon:"iconPin",click:()=>{e.pin()}}).element),window.siyuan.menus.menu},wd=(t,e,n)=>{let a=t;for(;a instanceof Ua;)a=a.children[0];for(let i=0;i<e.children.length;i++){const s=e.children[i];if(s instanceof Ua&&!n)wd(a,s,n);else if(s instanceof fd&&s.id!==a.id&&s.children.length>0){for(let l=0;l<s.children.length;l++){const o=s.children[l];a.headersElement.append(o.headElement),a.moveTab(o),l--}i--}}},mi=(t,e)=>{var n,a;switch(t){case"fileTree":return nt("file").toggleModel("file"),!0;case"outline":return nt("outline").toggleModel("outline"),!0;case"bookmark":case"tag":case"inbox":return nt(t).toggleModel(t),!0;case"backlinks":return nt("backlink").toggleModel("backlink"),!0;case"graphView":return nt("graph").toggleModel("graph"),!0;case"globalGraph":return nt("globalGraph").toggleModel("globalGraph"),!0;case"config":return Kl(e),!0;case"globalSearch":return Hn({app:e,hotkey:p.DIALOG_GLOBALSEARCH,key:(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange()).toString()}),!0;case"stickSearch":return Si(e,(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange()).toString(),!0),!0;case"goBack":return Mp(e),!0;case"goForward":return Pp(e),!0;case"goToTab1":return sn(0),!0;case"goToTab2":return sn(1),!0;case"goToTab3":return sn(2),!0;case"goToTab4":return sn(3),!0;case"goToTab5":return sn(4),!0;case"goToTab6":return sn(5),!0;case"goToTab7":return sn(6),!0;case"goToTab8":return sn(7),!0;case"goToTab9":return sn(-1),!0;case"goToTabNext":return sn(-3),!0;case"goToTabPrev":return sn(-2),!0;case"mainMenu":return ue()||_y(e,document.querySelector("#barWorkspace").getBoundingClientRect()),!0;case"recentDocs":return ng(),!0;case"recentClosed":if(window.siyuan.closedTabs.length>0){const i=window.siyuan.closedTabs.pop(),s=i.children;s.instance==="Editor"?ea({app:e,fileName:i.title,id:s.blockId,rootID:s.rootId,mode:s.mode,action:[s.action]}):s.instance==="Asset"?ea({app:e,assetPath:s.path,page:s.page}):s.instance==="Backlink"?Qc({app:e,blockId:s.blockId,rootId:s.rootId,title:i.title}):s.instance==="Graph"?ed({app:e,blockId:s.blockId,rootId:s.rootId,title:i.title}):s.instance==="Outline"?fb({app:e,rootId:s.blockId,title:i.title,isPreview:s.isPreview}):s.instance==="Search"?ea({app:e,searchData:s.config}):s.instance==="Custom"&&ea({app:e,custom:{icon:i.icon,title:i.title,data:s.customModelData,id:s.customModelType}})}return!0;case"toggleDock":return gb(document.querySelector("#barDock use")),!0;case"toggleWin":return!0}if(t==="goToEditTabNext"||t==="goToEditTabPrev"){let i=document.querySelector(".layout__wnd--active ul.layout-tab-bar > .item--focus");if(i||(i=document.querySelector("ul.layout-tab-bar > .item--focus")),!i)return!0;const s=pi().sort((o,r)=>o.headElement.getAttribute("data-activetime")>r.headElement.getAttribute("data-activetime")?-1:1),l=i.getAttribute("data-id");return s.find((o,r)=>{if(l===o.id){let c;t==="goToEditTabPrev"?r===0?c=s[s.length-1]:c=s[r-1]:r===s.length-1?c=s[0]:c=s[r+1];const d=on(c.id);d.parent.switchTab(c.headElement),d.parent.showHeading()}}),!0}if(t==="closeUnmodified"){const i=ya(!1);if(i){const s=[];i.parent.children.forEach(l=>{var o,r;const c=l.model;(!c||(o=c.editor)!=null&&o.protyle&&!((r=c.editor)!=null&&r.protyle.updated))&&s.push(l)}),s.length>0&&is(i,"other",s)}return!0}if(t==="unsplitAll")return wd(window.siyuan.layout.centerLayout,window.siyuan.layout.centerLayout,!1),!0;if(t==="unsplit"){const i=ya(!1);if(i){let s=[],l=i.parent.parent;for(;l.id!==window.siyuan.layout.centerLayout.id&&(s=[],pr(l,s),!(s.length>1));)l=l.parent;wd(i.parent.parent.children[0],l,!0),Sn()}return!0}if(t==="closeTab"){const i=document.querySelector(".layout__tab--active");if(i&&i.getBoundingClientRect().width>0){let o;return Array.from(i.classList).find(r=>{if(r.startsWith("sy__"))return o=r.replace("sy__",""),!0}),o&&((n=nt(o))==null||n.toggleModel(o,!1,!0)),!0}const s=ya();if(s)return s.parent.removeTab(s.id),!0;if(window.siyuan.blockPanels.length>0)return(a=window.siyuan.blockPanels[window.siyuan.blockPanels.length-1])==null||a.destroy(),!0;const l=ya(!1);if(l)return l.parent.removeTab(l.id),!0}if(t==="closeOthers"||t==="closeAll"){const i=ya(!1);return i&&is(i,t),!0}if(t==="closeLeft"||t==="closeRight"){const i=ya(!1);if(i){const s=[],l=[];let o=-1;i.parent.children.forEach((r,c)=>{r.id===i.id&&(o=c),o===-1?s.push(r):c>o&&l.push(r)}),t==="closeLeft"?s.length>0&&is(i,"other",s):l.length>0&&is(i,"other",l)}return!0}if(t==="splitLR"){const i=ya(!1);return i&&i.parent.split("lr").addTab(ag(e,i)),!0}if(t==="splitTB"){const i=ya(!1);return i&&i.parent.split("tb").addTab(ag(e,i)),!0}if(t==="splitMoveB"||t==="splitMoveR"){const i=ya(!1);if(i&&i.parent.children.length>1){const s=i.parent.split(t==="splitMoveB"?"tb":"lr");s.headersElement.append(i.headElement),s.headersElement.parentElement.classList.remove("fn__none"),s.moveTab(i),Sn()}return!0}if(t==="tabToWindow"){const i=ya(!1);return i&&mS(i),!0}switch(t){case"dailyNote":return gh(e),!0;case"dataHistory":return pp(e),!0;case"editReadonly":return by(!window.siyuan.config.editor.readOnly),!0;case"lockScreen":return jp(e),!0;case"newFile":return ki({app:e,useSavePath:!0}),!0;case"riffCard":return Wo(e),!0;case"selectOpen1":return PE(),!0;case"syncNow":return ig(e),!0}return!1};var C1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const ES=t=>{const e=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0,n=new $e({width:Y()?"92vw":"80vw",height:Y()?"80vh":"70vh",title:window.siyuan.languages.commandPanel,content:`<div class="fn__flex-column">
    <div class="b3-form__icon search__header" style="border-top: 0;border-bottom: 1px solid var(--b3-theme-surface-lighter);">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-text-field b3-text-field--text" style="padding-left: 32px !important;">
    </div>
    <ul class="b3-list b3-list--background search__list" id="commands"></ul>
    <div class="search__tip">
        <kbd>\u2191/\u2193</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.confirm}
        <kbd>Esc</kbd> ${window.siyuan.languages.close}
    </div>
</div>`,destroyCallback(){e&&ne(e)}});n.element.setAttribute("data-key",p.DIALOG_COMMANDPANEL);const a=n.element.querySelector("#commands");let i="";if(Object.keys(window.siyuan.config.keymap.general).forEach(l=>{let o;o=["addToDatabase","fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","graphView","globalGraph","closeAll","closeLeft","closeOthers","closeRight","closeTab","closeUnmodified","config","dataHistory","editReadonly","enter","enterBack","globalSearch","goBack","goForward","goToEditTabNext","goToEditTabPrev","goToTab1","goToTab2","goToTab3","goToTab4","goToTab5","goToTab6","goToTab7","goToTab8","goToTab9","goToTabNext","goToTabPrev","lockScreen","mainMenu","move","newFile","recentDocs","replace","riffCard","search","selectOpen1","syncNow","splitLR","splitMoveB","splitMoveR","splitTB","tabToWindow","stickSearch","toggleDock","unsplitAll","unsplit","recentClosed"],o.includes(l)&&(i+=`<li class="b3-list-item" data-command="${l}">
    <span class="b3-list-item__text">${window.siyuan.languages[l]}</span>
    <span class="b3-list-item__meta${Y()?" fn__none":""}">${pe(window.siyuan.config.keymap.general[l].custom)}</span>
</li>`)}),Object.keys(window.siyuan.config.keymap.editor.general).forEach(l=>{["switchReadonly","switchAdjust"].includes(l)&&(i+=`<li class="b3-list-item" data-command="${l}">
    <span class="b3-list-item__text">${window.siyuan.languages[l]}</span>
    <span class="b3-list-item__meta${Y()?" fn__none":""}">${pe(window.siyuan.config.keymap.editor.general[l].custom)}</span>
</li>`)}),a.insertAdjacentHTML("beforeend",i),t.plugins.forEach(l=>{l.commands.forEach(o=>{const r=document.createElement("li");r.classList.add("b3-list-item"),r.innerHTML=`<span class="b3-list-item__text">${l.displayName}: ${o.langText||l.i18n[o.langKey]}</span>
<span class="b3-list-item__meta${Y()?" fn__none":""}">${pe(o.customHotkey)}</span>`,r.addEventListener("click",c=>{o.callback?o.callback():o.globalCallback&&o.globalCallback(),n.destroy(),c.preventDefault(),c.stopPropagation()}),a.insertAdjacentElement("beforeend",r)})}),a.childElementCount===0){const l=document.createElement("li");l.classList.add("b3-list-item","b3-list-item--focus"),l.innerHTML=`<span class="b3-list-item__text" style="-webkit-line-clamp: inherit;">${window.siyuan.languages._kernel[122]}</span>`,l.addEventListener("click",()=>{n.destroy()}),a.insertAdjacentElement("beforeend",l)}else a.firstElementChild.classList.add("b3-list-item--focus");const s=n.element.querySelector(".b3-text-field");s.focus(),a.addEventListener("click",l=>{const o=T(l.target,"b3-list-item");if(o){const r=o.getAttribute("data-command");r&&(hn({command:r,app:t,previousRange:e}),n.destroy(),l.preventDefault(),l.stopPropagation())}}),s.addEventListener("keydown",l=>{if(l.stopPropagation(),!l.isComposing)if(xn(a,l),l.key==="Enter"){const o=a.querySelector(".b3-list-item--focus");if(o){const r=o.getAttribute("data-command");r?hn({command:r,app:t,previousRange:e}):o.dispatchEvent(new CustomEvent("click"))}n.destroy()}else l.key==="Escape"&&n.destroy()}),s.addEventListener("compositionend",()=>{kS(s,a)}),s.addEventListener("input",l=>{l.isComposing||(l.stopPropagation(),kS(s,a))})},kS=(t,e)=>{var n;const a=t.value.toLowerCase();(n=e.querySelector(".b3-list-item--focus"))==null||n.classList.remove("b3-list-item--focus");let i=!1;Array.from(e.children).forEach(s=>{const l=s.querySelector(".b3-list-item__text").textContent.toLowerCase(),o=s.dataset.command;a.indexOf(l)>-1||l.indexOf(a)>-1||a.indexOf(o)>-1||(o==null?void 0:o.indexOf(a))>-1?(i||s.classList.add("b3-list-item--focus"),i=!0,s.classList.remove("fn__none")):s.classList.add("fn__none")})},hn=t=>C1(void 0,null,function*(){var e,n,a;if(mi(t.command,t.app))return;const i=(e=document.querySelector(".layout__tab--active"))==null?void 0:e.classList.contains("sy__file");let s=t.protyle;const l=t.previousRange||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange());let o=t.fileLiElements;if(!i&&!s){l&&window.siyuan.dialogs.find(c=>{if(c.editors&&(Object.keys(c.editors).find(d=>{if(c.editors[d].protyle.element.contains(l.startContainer))return s=c.editors[d].protyle,!0}),s))return!0});const r=ya();if(!s&&r)r.model instanceof Ot?s=r.model.editor.protyle:r.model instanceof ns?r.model.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?s=r.model.editors.edit.protyle:s=r.model.editors.unRefEdit.protyle:r.model instanceof fi&&((n=r.model.editors)==null?void 0:n.length)>0&&l&&r.model.editors.find(c=>{if(c.protyle.element.contains(l.startContainer))return s=c.protyle,!0});else if(!s){!s&&l&&window.siyuan.blockPanels.find(d=>{if(d.editors.find(u=>{if(u.protyle.element.contains(l.startContainer))return s=u.protyle,!0}),s)return!0});const c=Oe();s||c.backlink.find(d=>{if(d.element.classList.contains("layout__tab--active"))return l&&d.editors.find(u=>{if(u.protyle.element.contains(l.startContainer))return s=u.protyle,!0}),!s&&d.editors.length>0&&(s=d.editors[0].protyle),!0}),s||c.editor.find(d=>{if(d.parent.headElement.classList.contains("item--focus"))return s=d.editor.protyle,!0})}}if(!(!i&&s&&bd({command:t.command,previousRange:l,protyle:s}))){if(i&&!o){const r=nt("file");if(!r)return!1;const c=r.data.file;o=Array.from(c.element.querySelectorAll(".b3-list-item--focus"))}if(!s&&!i||i&&(!o||o.length===0)||Y()&&!document.getElementById("empty").classList.contains("fn__none")){t.command==="replace"?Hn({app:t.app,hotkey:p.DIALOG_REPLACE,key:l.toString()}):t.command==="search"&&Hn({app:t.app,hotkey:p.DIALOG_SEARCH,key:l.toString()});return}switch(t.command){case"replace":if(!i)Hn({app:t.app,hotkey:p.DIALOG_REPLACE,key:l.toString(),notebookId:s.notebookId,searchPath:s.path});else{const r=ot(o[0],"UL");if(!r)return!1;const c=r.getAttribute("data-url"),d=o[0].getAttribute("data-path"),u=o[0].getAttribute("data-type")==="navigation-file";Hn(u?{app:t.app,hotkey:p.DIALOG_REPLACE,notebookId:c,searchPath:xt(d,!1,!0)}:{app:t.app,hotkey:p.DIALOG_REPLACE,notebookId:c})}break;case"search":if(!i)Hn({app:t.app,hotkey:p.DIALOG_SEARCH,key:l.toString(),notebookId:s.notebookId,searchPath:s.path});else{const r=ot(o[0],"UL");if(!r)return!1;const c=r.getAttribute("data-url"),d=o[0].getAttribute("data-path"),u=o[0].getAttribute("data-type")==="navigation-file";Hn(u?{app:t.app,hotkey:p.DIALOG_SEARCH,notebookId:c,searchPath:xt(d,!1,!0)}:{app:t.app,hotkey:p.DIALOG_SEARCH,notebookId:c})}break;case"addToDatabase":i?ph(o):ip(s,l);break;case"move":if(i){const r=Zm(o);zi((c,d)=>{Jm(r,d[0],c[0])},r)}else{const r=B(l.startContainer);if((a=s.title)!=null&&a.editElement.contains(l.startContainer)||!r||window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TITLE)zi((c,d)=>{Jm([s.path],d[0],c[0])},[s.path],l);else if(r&&l&&s.element.contains(l.startContainer)){let c=Array.from(s.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&(c=[r]),zi(d=>{Nh(d[0],c,s)})}}break}}});var T1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});let Fe,jl;const D1=t=>{let e,n;document.addEventListener("mouseover",a=>{var i;if(!window.siyuan.config||!window.siyuan.menus||window.siyuan.dragElement||document.onmousemove){cn();return}const s=j(a.target,"data-type","a",!0)||T(a.target,"ariaLabel")||j(a.target,"data-type","tab-header")||j(a.target,"data-type","inline-memo")||T(a.target,"av__calc--ashow")||T(a.target,"av__cell");if(s){let l="",o=s.getAttribute("aria-label")||"";if(s.classList.contains("av__cell")&&!s.classList.contains("ariaLabel"))if(s.classList.contains("av__cell--header")){const r=s.querySelector(".av__celltext"),c=s.getAttribute("data-desc");(r.scrollWidth>r.clientWidth+.5||c)&&(c?o=`${Bl(s)}<div class='ft__on-surface'>${Zt(c)}</div>`:o=Bl(s))}else((i=s.firstElementChild)==null?void 0:i.getAttribute("data-type"))==="url"&&s.firstElementChild.textContent.indexOf("...")>-1&&(o=Lute.EscapeHTMLStr(s.firstElementChild.getAttribute("data-href")),l="href"),o="",!o&&s.dataset.wrap!=="true"&&a.target.dataset.type!=="block-more"&&!T(a.target,"block__icon")&&(s.style.overflow="auto",s.scrollWidth>s.clientWidth+2&&(o=Lute.EscapeHTMLStr(Bl(s))),s.style.overflow="");else if(s.parentElement.parentElement.classList.contains("av__views")&&s.parentElement.classList.contains("layout-tab-bar")){const r=s.querySelector(".item__text"),c=s.getAttribute("data-desc");(r.scrollWidth>r.clientWidth+.5||c)&&(c?o=`${r.textContent}<div class='ft__on-surface'>${Zt(c)}</div>`:o=r.textContent)}else if(s.classList.contains("av__celltext--url")){const r=s.getAttribute("data-name")||"";o=o?`<span style="word-break: break-all">${o.substring(0,p.SIZE_TITLE)}</span>${r?'<div class="fn__hr"></div><span>'+r+"</span>":""}`:r,l="href"}else if(s.classList.contains("av__calc--ashow")&&s.clientWidth+2<s.scrollWidth)o=s.lastChild.textContent+" "+s.firstElementChild.textContent;else if(s.getAttribute("data-type")==="setRelationCell"){const r=s.querySelector(".b3-menu__label");r&&r.clientWidth<r.scrollWidth&&(o=r.textContent)}if(o||(o=s.getAttribute("data-inline-memo-content"),o&&(l="memo")),!o){const r=s.getAttribute("data-href")||"";r&&(o=`<span style="word-break: break-all">${r.substring(0,p.SIZE_TITLE)}</span>`,l="href");const c=s.getAttribute("data-title");if(o&&Ro(r)&&!s.classList.contains("b3-tooltips")){let d=o;A("/api/asset/statAsset",{path:r},u=>{u.code===1?c&&(d+='<div class="fn__hr"></div><span>'+c+"</span>"):d+=` ${u.data.hSize}${c?'<div class="fn__hr"></div><span>'+c+"</span>":""}<br>${window.siyuan.languages.modifiedAt} ${u.data.hUpdated}<br>${window.siyuan.languages.createdAt} ${u.data.hCreated}`,wi(d,s,l)}),o=""}else c&&(o=(o?o+'<div class="fn__hr"></div>':"")+"<span>"+c+"</span>")}if(jl=T(a.target,"b3-list-item__text"),jl&&jl.parentElement.getAttribute("data-type")==="navigation-root"&&A("/api/notebook/getNotebookInfo",{notebook:jl.parentElement.parentElement.getAttribute("data-url")},r=>{const c=r.data.boxInfo,d=`${c.name} <small class='ft__on-surface'>${c.hSize}</small>${c.docCount!==0?window.siyuan.languages.includeSubFile.replace("x",c.docCount):""}<br>${window.siyuan.languages.modifiedAt} ${c.hMtime}<br>${window.siyuan.languages.createdAt} ${c.hCtime}`,u=T(a.target,"b3-list-item__text");jl&&u&&jl===u&&wi(d,jl),u&&u.parentElement.getAttribute("data-type")==="navigation-root"&&u.parentElement.parentElement.getAttribute("data-url")===c.id&&u.setAttribute("aria-label",d)}),o&&!s.classList.contains("b3-tooltips")){try{wi(decodeURIComponent(o),s,l)}catch(r){wi(o,s,l)}a.stopPropagation()}else cn()}else if(!s){const l=j(a.target,"id","tooltip",!0);(!l||l&&l.clientHeight>=l.scrollHeight&&l.clientWidth>=l.scrollWidth)&&cn()}if(window.siyuan.config.editor.floatWindowMode===1||window.siyuan.shiftIsPressed){if(clearTimeout(n),n=window.setTimeout(()=>{SS(a)},p.TIMEOUT_INPUT),!LS(a,s)||a.relatedTarget&&!document.contains(a.relatedTarget))return;window.siyuan.ctrlIsPressed?(clearTimeout(n),vd(t)):window.siyuan.shiftIsPressed&&(clearTimeout(n),vd(t,!0));return}clearTimeout(e),clearTimeout(n),n=window.setTimeout(()=>{SS(a)&&!Fe&&!s&&clearTimeout(e)},p.TIMEOUT_INPUT),e=window.setTimeout(()=>{!LS(a,s)||Se()||(clearTimeout(n),vd(t))},620)})},SS=t=>{var e;const n=Se()?document.elementFromPoint(t.clientX,t.clientY):t.target;if(!n||n.id&&n.tagName!=="svg"&&(n.id.startsWith("minder_node")||n.id.startsWith("kity_")||n.id.startsWith("node_"))||n.classList.contains("counter")||n.tagName==="circle")return!1;const a=T(n,"av__panel")||T(n,"av__mask");if(a){if(window.siyuan.blockPanels.find(l=>{if(l.element.style.zIndex<a.style.zIndex)return!0}))return!1}else{const s=T(n,"b3-menu");if(s&&s.getAttribute("data-name")!==p.MENU_DOC_TREE_MORE&&window.siyuan.blockPanels.find(o=>{if(o.element.style.zIndex<s.style.zIndex)return!0}))return!1}Fe=j(n,"data-type","block-ref")||j(n,"data-type","virtual-block-ref"),Fe&&Fe.classList.contains("b3-tooltips")&&(Fe=void 0),Fe||(Fe=T(n,"popover__block"));const i=j(n,"data-type","a",!0);if(!Fe&&i&&((e=i.getAttribute("data-href"))!=null&&e.startsWith("siyuan://blocks"))&&(Fe=i),!Fe||Fe&&window.siyuan.menus.menu.data&&window.siyuan.menus.menu.data===Fe){let s=n;!s.parentElement&&t.path&&t.path[1]&&(s=t.path[1]);const l=T(s,"block__popover",!0),o={oid:0};window.siyuan.blockPanels.forEach(c=>{if((c.targetElement||typeof c.x=="number")&&c.element.getAttribute("data-pin")==="true"){const d=parseInt(c.element.getAttribute("data-level")),u=c.element.getAttribute("data-oid");o[u]?d>o[u]&&(o[u]=d):o[u]=d}});const r=parseInt(window.siyuan.menus.menu.element.dataset.from);if(l)for(let c=window.siyuan.blockPanels.length-1;c>=0;c--){const d=window.siyuan.blockPanels[c],u=parseInt(d.element.getAttribute("data-level"));if((d.targetElement||typeof d.x=="number")&&u>(o[d.element.getAttribute("data-oid")]||0)&&d.element.getAttribute("data-pin")==="false"&&u>parseInt(l.getAttribute("data-level"))){if(r&&r>=u)break;if(d.editors.find(f=>{if(!f.protyle.toolbar.subElement.classList.contains("fn__none"))return!0}))break;d.destroy()}}else for(let c=window.siyuan.blockPanels.length-1;c>=0;c--){const d=window.siyuan.blockPanels[c],u=parseInt(d.element.getAttribute("data-level"));if((d.targetElement||typeof d.x=="number")&&d.element.getAttribute("data-pin")==="false"){if(r&&r>=u)break;if(d.targetElement&&d.targetElement.classList.contains("protyle-wysiwyg__embed")&&d.targetElement.contains(s))break;if(d.editors.find(f=>{if(!f.protyle.toolbar.subElement.classList.contains("fn__none"))return!0}))break;d.destroy()}}}},LS=(t,e)=>{var n,a;if(window.siyuan.config.editor.floatWindowMode===2||T(t.target,"history__repo",!0))return!1;if(Fe=j(t.target,"data-type","block-ref")||j(t.target,"data-type","virtual-block-ref"),Fe&&Fe.classList.contains("b3-tooltips")&&(Fe=void 0),Fe||(Fe=T(t.target,"popover__block")),!Fe&&e){if((n=e.getAttribute("data-href"))!=null&&n.startsWith("siyuan://blocks")&&e.getAttribute("prevent-popover")!=="true")Fe=e;else if(e.classList.contains("av__cell")){const i=e.querySelector(".av__celltext--url");i&&i.dataset.type==="url"&&((a=i.dataset.href)!=null&&a.startsWith("siyuan://blocks"))&&(Fe=i)}}if(!Fe||window.siyuan.altIsPressed||window.siyuan.config.editor.floatWindowMode===0&&window.siyuan.ctrlIsPressed||Fe&&Fe.getAttribute("prevent-popover")==="true")return!1;if(Fe&&getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(i.toString()!==""&&Fe.contains(i.startContainer))return!1}return!0},vd=(t,e=!1)=>T1(void 0,null,function*(){var n,a;if(!Fe||window.siyuan.menus.menu.data&&window.siyuan.menus.menu.data===Fe)return;let i=[],s;const l=Fe.getAttribute("data-id");if(l)if(e){const r=yield Ae("/api/block/getRefIDs",{id:l});i=r.data.refDefs,s=r.data.originalRefBlockIDs}else l.startsWith("[")?JSON.parse(l).forEach(r=>{i.push({refID:r})}):i=[{refID:l}];else if(((n=Fe.getAttribute("data-type"))==null?void 0:n.indexOf("virtual-block-ref"))>-1){const r=B(Fe);r&&(i=(yield Ae("/api/block/getBlockDefIDsByRefText",{anchor:Fe.textContent,excludeIDs:[r.getAttribute("data-node-id")]})).data.refDefs)}else if((a=Fe.getAttribute("data-type"))!=null&&a.split(" ").includes("a"))i=[{refID:Of(Fe.getAttribute("data-href"))}];else if(Fe.dataset.type==="url")i=[{refID:Of(Fe.textContent.trim())}];else if(Fe.dataset.popoverUrl)i=(yield Ae(Fe.dataset.popoverUrl,{avID:Fe.dataset.avId})).data.refDefs;else{let r,c="/api/block/getRefIDs";if(Fe.classList.contains("protyle-attr--refcount"))r=Fe.parentElement.parentElement.getAttribute("data-node-id");else if(Fe.classList.contains("pdf__rect")){const d=Fe.getAttribute("data-relations");d?(d.split(",").forEach(u=>{i.push({refID:u})}),c=""):(r=Fe.getAttribute("data-node-id"),c="/api/block/getRefIDsByFileAnnotationID")}else r||(r=Fe.parentElement.getAttribute("data-node-id"));if(c){const d=yield Ae(c,{id:r});i=d.data.refDefs,s=d.data.originalRefBlockIDs}}if(i.length===0)return;let o=!1;window.siyuan.blockPanels.find(r=>{if((r.targetElement||typeof r.x=="number")&&r.element.getAttribute("data-pin")==="true"&&JSON.stringify(i)===JSON.stringify(r.refDefs))return o=!0,!0}),!o&&Fe.parentElement&&Fe.parentElement.style.opacity!=="0.38"&&window.siyuan.blockPanels.push(new ud({app:t,targetElement:Fe,isBacklink:e||Fe.classList.contains("protyle-attr--refcount")||Fe.classList.contains("counter"),refDefs:i,originalRefBlockIDs:s}))}),gr=(t,e,n)=>{if(e==="general"){if(!window.siyuan.config.keymap[e])return window.siyuan.config.keymap[e]=t,!1}else{if(!window.siyuan.config.keymap[e])return window.siyuan.config.keymap[e]=JSON.parse(JSON.stringify(p.SIYUAN_KEYMAP.editor)),!1;if(!window.siyuan.config.keymap[e][n])return window.siyuan.config.keymap[e][n]=t,!1}let a=!0;return Object.keys(t).forEach(i=>{e==="general"?(!window.siyuan.config.keymap[e][i]||window.siyuan.config.keymap[e][i].default!==t[i].default)&&(a=!1,window.siyuan.config.keymap[e][i]=t[i]):(!window.siyuan.config.keymap[e][n][i]||window.siyuan.config.keymap[e][n][i].default!==t[i].default)&&(a=!1,window.siyuan.config.keymap[e][n][i]=t[i])}),a},mr=(t,e,n)=>{let a=!0;return e==="editor"?Object.keys(window.siyuan.config.keymap[e][n]).length!==Object.keys(p.SIYUAN_KEYMAP[e][n]).length&&Object.keys(window.siyuan.config.keymap[e][n]).forEach(i=>{p.SIYUAN_KEYMAP[e][n][i]||(a=!1,delete window.siyuan.config.keymap[e][n][i])}):Object.keys(window.siyuan.config.keymap[e]).length!==Object.keys(p.SIYUAN_KEYMAP[e]).length&&Object.keys(window.siyuan.config.keymap[e]).forEach(i=>{p.SIYUAN_KEYMAP[e][i]||(a=!1,delete window.siyuan.config.keymap[e][i])}),a},I1=t=>{const e=gr(p.SIYUAN_KEYMAP.general,"general"),n=gr(p.SIYUAN_KEYMAP.editor.general,"editor","general"),a=gr(p.SIYUAN_KEYMAP.editor.insert,"editor","insert"),i=gr(p.SIYUAN_KEYMAP.editor.heading,"editor","heading"),s=gr(p.SIYUAN_KEYMAP.editor.list,"editor","list"),l=gr(p.SIYUAN_KEYMAP.editor.table,"editor","table"),o=mr(p.SIYUAN_KEYMAP.general,"general"),r=mr(p.SIYUAN_KEYMAP.editor.general,"editor","general"),c=mr(p.SIYUAN_KEYMAP.editor.insert,"editor","insert"),d=mr(p.SIYUAN_KEYMAP.editor.heading,"editor","heading"),u=mr(p.SIYUAN_KEYMAP.editor.list,"editor","list"),m=mr(p.SIYUAN_KEYMAP.editor.table,"editor","table");!window.siyuan.config.readonly&&(!e||!n||!a||!i||!s||!l||!o||!r||!c||!d||!u||!m)&&A("/api/setting/setKeymap",{data:window.siyuan.config.keymap},()=>{})},$1=(t,e)=>{if(document.getElementById("progress")||document.getElementById("errorLog")||t.isComposing)return!0;const n=t.target;if(t.isTrusted&&et(t)&&!t.shiftKey&&!t.altKey&&!["INPUT","TEXTAREA"].includes(n.tagName)&&["0","1","2","3","4","j","k","l",";","s"," ","p","enter","a","s","d","f","q","x"].includes(t.key.toLowerCase())){let a;if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===p.DIALOG_OPENCARD)return a=i.element,!0}),a||(a=document.querySelector(`.layout__wnd--active div[data-key="${p.DIALOG_OPENCARD}"]:not(.fn__none)`)),a)return t.preventDefault(),a.firstElementChild.dispatchEvent(new CustomEvent("click",{detail:t.key.toLowerCase()})),!0}if(et(t)&&t.key!=="Escape"&&!t.shiftKey&&!t.altKey&&p.KEYCODELIST[t.keyCode]!=="PageUp"&&p.KEYCODELIST[t.keyCode]!=="PageDown"&&t.key!=="Home"&&t.key!=="End"&&!/^F\d{1,2}$/.test(t.key)&&t.key.indexOf("Arrow")===-1&&t.key!=="Enter"&&t.key!=="Backspace"&&t.key!=="Delete")return!0;!t.altKey&&!t.shiftKey&&Wt(t)&&((Mt()?t.key==="Meta":t.key==="Control")||Wt(t)?(window.siyuan.ctrlIsPressed=!0,(t.key==="Meta"||t.key==="Control")&&window.siyuan.config.editor.floatWindowMode===1&&!t.repeat&&vd(e)):window.siyuan.ctrlIsPressed=!1),!t.altKey&&t.shiftKey&&et(t)&&(t.key==="Shift"?(window.siyuan.shiftIsPressed=!0,t.repeat||vd(e,!0)):window.siyuan.shiftIsPressed=!1),t.altKey&&!t.shiftKey&&et(t)&&(t.key==="Alt"?window.siyuan.altIsPressed=!0:window.siyuan.altIsPressed=!1)},AS=(t,e)=>{e.preventDefault();let n=e.target;for(;n!==Va.element;){if(n.classList.contains("b3-list-item")){const a=n.getAttribute("data-type");if(a)a==="riffCard"?Wo(t):nt(a).toggleModel(a,!0);else{const i=n.getAttribute("data-id");pi().find(s=>{if(s.id===i)return s.parent.switchTab(s.headElement),s.parent.showHeading(),!0})}Va.destroy(),Va=void 0;break}n=n.parentElement}},xS=(t,e,n)=>{let a=e.querySelector(".b3-list-item--focus");if(a){if(a.classList.remove("b3-list-item--focus"),n.key==="ArrowUp")a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus");else if(n.key==="ArrowDown")a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus");else if(n.key==="ArrowLeft"||n.key==="ArrowRight"){const r=a.parentElement.previousElementSibling||a.parentElement.nextElementSibling;if(r){const c=r.querySelector(`[data-index="${a.getAttribute("data-index")}"]`)||r.lastElementChild;c?c.classList.add("b3-list-item--focus"):a.classList.add("b3-list-item--focus")}else a.classList.add("b3-list-item--focus")}else if(n.key==="Enter"){const r=a.getAttribute("data-type");r?r==="riffCard"?Wo(t):nt(r).toggleModel(r,!0):ve({app:t,id:a.getAttribute("data-node-id"),action:[p.CB_GET_FOCUS,p.CB_GET_SCROLL]}),ce(["dialog"]);return}a=e.querySelector(".b3-list-item--focus");const i=a.getAttribute("data-node-id"),s=e.querySelector(".switch-doc__path");i?A("/api/filetree/getFullHPathByID",{id:i},r=>{s.innerHTML=he(r.data)}):s.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const l=a.getBoundingClientRect(),o=a.parentElement.getBoundingClientRect();l.top<o.top?a.scrollIntoView(!0):l.bottom>o.bottom&&a.scrollIntoView(!1)}},M1=(t,e)=>{var n,a;let i,s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0));const l=document.querySelector(".layout__tab--active");let o=!1;l&&l.classList.contains("sy__file")&&(o=!0),s&&window.siyuan.dialogs.find(d=>{if(d.editors&&(Object.keys(d.editors).find(u=>{if(d.editors[u].protyle.element.contains(s.startContainer))return i=d.editors[u].protyle,o=!1,!0}),i))return!0});const r=ya();if(!i&&r){if(r.model instanceof Ot?i=r.model.editor.protyle:r.model instanceof ns?r.model.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?i=r.model.editors.edit.protyle:i=r.model.editors.unRefEdit.protyle:r.model instanceof fi&&((n=r.model.editors)==null?void 0:n.length)>0&&s&&r.model.editors.find(d=>{if(d.protyle.element.contains(s.startContainer))return i=d.protyle,!0}),!i)return}else if(!i){!i&&s&&window.siyuan.blockPanels.find(u=>{if(u.editors.find(m=>{if(m.protyle.element.contains(s.startContainer))return i=m.protyle,!0}),i)return!0});const d=Oe();if(i||d.backlink.find(u=>{if(u.element.classList.contains("layout__tab--active"))return s&&u.editors.find(m=>{if(m.protyle.element.contains(s.startContainer))return i=m.protyle,!0}),!i&&u.editors.length>0&&(i=u.editors[0].protyle),!0}),i||d.editor.find(u=>{if(u.parent.headElement.classList.contains("item--focus"))return i=u.editor.protyle,!0}),!i)return!1}if(!o&&W(window.siyuan.config.keymap.general.replace.custom,e))return hn({command:"replace",app:t,protyle:i,previousRange:s}),e.preventDefault(),!0;if(!o&&W(window.siyuan.config.keymap.general.search.custom,e))return hn({command:"search",app:t,protyle:i,previousRange:s}),e.preventDefault(),!0;if(!o&&W(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e)&&!window.siyuan.config.readonly){if((a=i.title)!=null&&a.editElement.contains(s.startContainer))$c(i,[i.title.element]);else{const d=[];if(i.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(u=>{d.push(u)}),d.length===0){const u=B(s.startContainer);u&&d.push(u)}$c(i,d)}return e.preventDefault(),!0}if(!o&&W(window.siyuan.config.keymap.general.addToDatabase.custom,e))return hn({command:"addToDatabase",app:t,protyle:i,previousRange:s}),e.preventDefault(),!0;if(!o&&W(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)&&!window.siyuan.config.readonly)return A("/api/riff/getTreeRiffDueCards",{rootID:i.block.rootID},d=>{var u;Sl(t,d.data,"doc",i.block.rootID,((u=i.title)==null?void 0:u.editElement.textContent)||window.siyuan.languages.untitled)}),e.preventDefault(),!0;if(!o&&W(window.siyuan.config.keymap.general.move.custom,e))return hn({command:"move",app:t,protyle:i,previousRange:s}),e.preventDefault(),!0;if(!o&&!e.repeat&&!i.disabled&&W(window.siyuan.config.keymap.editor.general.duplicate.custom,e)){e.preventDefault(),e.stopPropagation();let d=Array.from(i.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(d.length===0){const u=B(s.startContainer);u&&(d=[u])}return _p(d,i),!0}const c=e.target;if(c.tagName!=="TABLE"&&["INPUT","TEXTAREA"].includes(c.tagName))return!1;if(!e.altKey&&!e.shiftKey&&Wt(e)&&e.key==="Home"){$h(i),ce(["select"],i),e.stopPropagation(),e.preventDefault();return}if(!e.altKey&&!e.shiftKey&&Wt(e)&&e.key==="End"){xv(i),ce(["select"],i),e.stopPropagation(),e.preventDefault();return}if(W(window.siyuan.config.keymap.editor.general.exitFocus.custom,e))return e.preventDefault(),dn({protyle:i,id:i.block.rootID,focusId:i.block.id}),!0;if(W(window.siyuan.config.keymap.editor.general.switchReadonly.custom,e))return e.preventDefault(),bd({protyle:i,command:"switchReadonly",previousRange:s}),!0;if(W(window.siyuan.config.keymap.editor.general.switchAdjust.custom,e))return e.preventDefault(),bd({protyle:i,command:"switchAdjust",previousRange:s}),!0;if(W(window.siyuan.config.keymap.editor.general.backlinks.custom,e)){if(e.preventDefault(),s){const d=j(s.startContainer,"data-type","block-ref");if(d)return Qc({app:i.app,blockId:d.dataset.id}),!0}return Qc({app:i.app,blockId:i.block.id,rootId:i.block.rootID,useBlockId:i.block.showAll,title:i.title?i.title.editElement.textContent||window.siyuan.languages.untitled:null}),!0}if(W(window.siyuan.config.keymap.editor.general.graphView.custom,e)){if(e.preventDefault(),s){const d=j(s.startContainer,"data-type","block-ref");if(d)return ed({app:i.app,blockId:d.dataset.id}),!0}return ed({app:i.app,blockId:i.block.id,rootId:i.block.rootID,useBlockId:i.block.showAll,title:i.title?i.title.editElement.textContent||window.siyuan.languages.untitled:null}),!0}if(W(window.siyuan.config.keymap.editor.general.outline.custom,e)){e.preventDefault();const d=_t(c);return fb({app:t,rootId:i.block.rootID,title:i.options.render.title?i.title.editElement.textContent||window.siyuan.languages.untitled:"",isPreview:!i.preview.element.classList.contains("fn__none")}),ha(c,d.start,d.end),!0}if(W(window.siyuan.config.keymap.editor.general.copyPlainText.custom,e)){const d=B(s.startContainer);if(!d)return!1;if(s.toString()===""){const u=Array.from(i.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let m="";u.length===0&&u.push(d),u.forEach(f=>{m+=Sc(f)+`
`}),Yi(m.trimEnd())}else Yi(s.toString());return e.preventDefault(),!0}if(W(window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,e)){const d=B(s.startContainer);return!d||!d.classList.contains("av")?!1:(Zv(i,d),e.preventDefault(),!0)}if(W(window.siyuan.config.keymap.editor.general.refresh.custom,e))return Ei(i,!0),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.fullscreen.custom,e))return kl(i.element),mn(i),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.preview.custom,e))return ql(i,"preview"),bn(),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.wysiwyg.custom,e)&&!i.options.backlinkData)return ql(i,"wysiwyg"),i.scroll.lastScrollTop=0,A("/api/filetree/getDoc",{id:i.block.id,size:i.block.id===i.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.SIZE_GET_MAX},d=>{kt({data:d,protyle:i,action:i.block.id===i.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML,p.CB_GET_UNUNDO]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_UNUNDO,p.CB_GET_HTML]})}),bn(),e.preventDefault(),!0;if(s&&!o&&W(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e)){if(e.preventDefault(),e.stopPropagation(),T(s.startContainer,"protyle-title"))Jt([i.block.rootID],"ref");else{const d=B(s.startContainer);if(!d)return!1;const u=d.querySelector(".img--select");if(u)return ah(u.querySelector("img").getAttribute("src")),!0;const m=Array.from(i.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")).map(f=>f.getAttribute("data-node-id"));if(m.length>0)return Jt(m,"ref"),!0;s.toString()!==""?dy(s,f=>{Be(`((${d.getAttribute("data-node-id")} "${f.trim()}"))`)}):Jt([d.getAttribute("data-node-id")],"ref")}return!0}return T(c,"protyle-title__input")?!1:W(window.siyuan.config.keymap.editor.general.undo.custom,e)?(i.undo.undo(i),e.preventDefault(),!0):W(window.siyuan.config.keymap.editor.general.redo.custom,e)?(i.undo.redo(i),e.preventDefault(),!0):!1},P1=(t,e)=>{var n,a;const i=nt("file");if(!i)return!1;const s=i.data.file;if(typeof i.data.file=="boolean")return!0;if(W(window.siyuan.config.keymap.general.selectOpen1.custom,e)){e.preventDefault(),mi("selectOpen1",t);return}if(!s.element.parentElement.classList.contains("layout__tab--active"))return!1;let l=!1;if(t.plugins.find(g=>{if(g.commands.find(h=>{if(h.fileTreeCallback&&W(h.customHotkey,e))return l=!0,h.fileTreeCallback(s),!0}),l)return!0}),l)return!0;const o=Array.from(s.element.querySelectorAll(".b3-list-item--focus"));if(o.length===0){if(e.key.startsWith("Arrow")&&et(e)){const g=s.element.querySelector(".b3-list-item");g&&(g.classList.add("b3-list-item--focus"),s.lastSelectedElement=g),e.preventDefault()}return!1}const r=ot(o[0],"UL");if(!r)return!1;const c=r.getAttribute("data-url"),d=o[0].getAttribute("data-path"),u=o[0].getAttribute("data-type")==="navigation-file",m=[];if(o.forEach(g=>{g.getAttribute("data-type")==="navigation-file"&&m.push(g.getAttribute("data-node-id"))}),W(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)&&!window.siyuan.config.readonly){if(u){const g=o[0].getAttribute("data-node-id");A("/api/riff/getTreeRiffDueCards",{rootID:g},h=>{Sl(t,h.data,"doc",g,xt(o[0].getAttribute("data-name"),!1,!0))})}else A("/api/riff/getNotebookRiffDueCards",{notebook:c},g=>{Sl(t,g.data,"notebook",c,Qa(c))});return e.preventDefault(),!0}if(W(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e))return m.length>0&&V(void 0,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:m}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:m}]),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.general.addToDatabase.custom,e))return hn({command:"addToDatabase",app:t,fileLiElements:o}),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.editor.general.rename.custom,e))return window.siyuan.menus.menu.remove(),sh({notebookId:c,path:d,name:u?xt(o[0].getAttribute("data-name"),!1,!0):Qa(c),type:u?"file":"notebook"}),e.preventDefault(),!0;if(W("\u2318/",e)){const g=o[0].getBoundingClientRect();return u?lp(t,c,d,o[0]).popup({x:g.right-15,y:g.top+15}):sp(t,o[0]).popup({x:g.right-15,y:g.top+15}),!0}if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.duplicate.custom,e))return e.preventDefault(),e.stopPropagation(),m.forEach(g=>{A("/api/filetree/duplicateDoc",{id:g})}),!0;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e))return e.preventDefault(),e.stopPropagation(),Jt(m,"ref"),!0;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e))return e.preventDefault(),e.stopPropagation(),Jt(m,"blockEmbed"),!0;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e))return e.preventDefault(),e.stopPropagation(),Jt(m,"protocol"),!0;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e))return e.preventDefault(),e.stopPropagation(),Jt(m,"protocolMd"),!0;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return e.preventDefault(),e.stopPropagation(),Jt(m,"hPath"),!0;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.copyID.custom,e))return e.preventDefault(),e.stopPropagation(),Jt(m,"id"),!0;if(u&&W(window.siyuan.config.keymap.general.move.custom,e))return window.siyuan.menus.menu.remove(),hn({command:"move",app:t,fileLiElements:o}),e.preventDefault(),!0;if(u&&W(window.siyuan.config.keymap.editor.general.insertRight.custom,e))return window.siyuan.menus.menu.remove(),ve({app:t,id:o[0].getAttribute("data-node-id"),action:[p.CB_GET_FOCUS],position:"right"}),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.general.replace.custom,e))return window.siyuan.menus.menu.remove(),hn({command:"replace",app:t,fileLiElements:o}),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.general.search.custom,e))return window.siyuan.menus.menu.remove(),hn({command:"search",app:t,fileLiElements:o}),e.preventDefault(),!0;const f=e.target;if(["INPUT","TEXTAREA"].includes(f.tagName)||j(f,"contenteditable",null)||T(f,"protyle",!0))return!1;if(e.shiftKey){if(e.key==="ArrowUp"){const g=yp(o);let h;if(g.startElement.getBoundingClientRect().top>=g.endElement.getBoundingClientRect().top?(h=H_(g.endElement),h&&(h.classList.add("b3-list-item--focus"),h.setAttribute("select-end","true"),g.endElement.removeAttribute("select-end"))):(g.endElement.classList.remove("b3-list-item--focus"),g.endElement.removeAttribute("select-end"),h=H_(g.endElement),h&&h.setAttribute("select-end","true")),h){const b=h.getBoundingClientRect(),y=s.element.getBoundingClientRect();(b.top<y.top||b.bottom>y.bottom)&&h.scrollIntoView(b.top<y.top)}}else if(e.key==="ArrowDown"){const g=yp(o);let h;if(g.startElement.getBoundingClientRect().top<=g.endElement.getBoundingClientRect().top?(h=_l(g.endElement),h&&(h.classList.add("b3-list-item--focus"),h.setAttribute("select-end","true"),g.endElement.removeAttribute("select-end"))):(g.endElement.classList.remove("b3-list-item--focus"),g.endElement.removeAttribute("select-end"),h=_l(g.endElement),h&&h.setAttribute("select-end","true")),h){const b=h.getBoundingClientRect(),y=s.element.getBoundingClientRect();(b.top<y.top||b.bottom>y.bottom)&&h.scrollIntoView(b.top<y.top)}}return}else if(et(e)){if((n=s.element.querySelector('[select-end="true"]'))==null||n.removeAttribute("select-end"),(a=s.element.querySelector('[select-start="true"]'))==null||a.removeAttribute("select-start"),e.key==="ArrowRight"&&!o[0].querySelector(".b3-list-item__arrow--open")&&!o[0].querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||e.key==="ArrowLeft"&&o[0].querySelector(".b3-list-item__arrow--open"))return s.getLeaf(o[0],c),o.forEach((g,h)=>{h!==0&&g.classList.remove("b3-list-item--focus")}),e.preventDefault(),!0;if(e.key==="ArrowLeft"){let g=o[0].parentElement.previousElementSibling;if(g){g.tagName!=="LI"&&(g=s.element.querySelector(".b3-list-item")),o.forEach(y=>{y.classList.remove("b3-list-item--focus")}),g.classList.add("b3-list-item--focus"),s.lastSelectedElement=g;const h=g.getBoundingClientRect(),b=s.element.getBoundingClientRect();(h.top<b.top||h.bottom>b.bottom)&&g.scrollIntoView(h.top<b.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let g=o[0];for(;g;)if(g.nextElementSibling){g.nextElementSibling.tagName==="UL"?g=g.nextElementSibling.firstElementChild:g=g.nextElementSibling;break}else{if(g.parentElement.classList.contains("fn__flex-1"))break;g=g.parentElement}if(g.classList.contains("b3-list-item")){o.forEach(y=>{y.classList.remove("b3-list-item--focus")}),g.classList.add("b3-list-item--focus"),s.lastSelectedElement=g;const h=g.getBoundingClientRect(),b=s.element.getBoundingClientRect();(h.top<b.top||h.bottom>b.bottom)&&g.scrollIntoView(h.top<b.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let g=o[0];for(;g;)if(g.previousElementSibling){if(g.previousElementSibling.tagName==="LI")g=g.previousElementSibling;else{const h=g.previousElementSibling.querySelectorAll(".b3-list-item");g=h[h.length-1]}break}else{if(g.parentElement.classList.contains("fn__flex-1"))break;g=g.parentElement}if(g.classList.contains("b3-list-item")){o.forEach(y=>{y.classList.remove("b3-list-item--focus")}),g.classList.add("b3-list-item--focus"),s.lastSelectedElement=g;const h=g.getBoundingClientRect(),b=s.element.getBoundingClientRect();(h.top<b.top||h.bottom>b.bottom)&&g.scrollIntoView(h.top<b.top)}return e.preventDefault(),!0}}if(e.key==="Delete"||e.key==="Backspace"&&Mt())return window.siyuan.menus.menu.remove(),document.querySelector(`.b3-dialog--open[data-key="${p.DIALOG_CONFIRM}"]`)?void 0:(zf(o),!0);if(e.key==="Enter")return window.siyuan.menus.menu.remove(),o.forEach(g=>{if(g.getAttribute("data-type")==="navigation-file")ve({app:t,id:g.getAttribute("data-node-id"),action:[p.CB_GET_FOCUS]});else{const h=ot(g,"UL");h&&s.getLeaf(g,h.getAttribute("data-url"))}}),!0},N1=(t,e)=>{var n;const a=e.target;if(["INPUT","TEXTAREA"].includes(a.tagName)||j(a,"contenteditable",null)||T(a,"protyle",!0))return!1;let i=document.querySelector(".layout__tab--active");if(i||Array.from(document.querySelectorAll(".layout__wnd--active .layout-tab-container > div")).find(u=>{if(!u.classList.contains("fn__none")&&u.className.indexOf("sy__")>-1)return i=u,!0}),!i||i.className.indexOf("sy__")===-1)return!1;let s=!1;if(t.plugins.find(u=>{if(u.commands.find(m=>{if(m.dockCallback&&W(m.customHotkey,e))return s=!0,m.dockCallback(i),!0}),s)return!0}),s)return!0;if(!W(window.siyuan.config.keymap.editor.general.collapse.custom,e)&&!W(window.siyuan.config.keymap.editor.general.expand.custom,e)&&!e.key.startsWith("Arrow")&&e.key!=="Enter")return!1;if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.collapse.custom,e)){const u=i.querySelector('.block__icon[data-type="collapse"]');if(u)return u.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(!e.repeat&&W(window.siyuan.config.keymap.editor.general.expand.custom,e)){const u=i.querySelector('.block__icon[data-type="expand"]');if(u)return u.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(i.classList.contains("sy__inbox")||i.classList.contains("sy__globalGraph")||i.classList.contains("sy__graph"))return!1;const l=(n=on(i.getAttribute("data-id"),window.siyuan.layout.layout))==null?void 0:n.model;if(!l)return!1;let o=i.querySelector(".b3-list-item--focus");if(!o)return o=i.querySelector(".b3-list .b3-list-item"),o&&o.classList.add("b3-list-item--focus"),!1;let r=l.tree;if(o.parentElement.parentElement.classList.contains("backlinkMList")&&(r=l.mTree),!r)return!1;if(e.key==="Enter")return r.click(o),e.preventDefault(),!0;const c=o.querySelector(".b3-list-item__arrow");if(e.key==="ArrowRight"&&!c.classList.contains("b3-list-item__arrow--open")&&!c.parentElement.classList.contains("fn__hidden")||e.key==="ArrowLeft"&&c.classList.contains("b3-list-item__arrow--open")&&!c.parentElement.classList.contains("fn__hidden"))return r.toggleBlocks(o),e.preventDefault(),!0;const d=T(o,"b3-list");if(!d)return!1;if(e.key==="ArrowLeft"){let u=o.parentElement.previousElementSibling;if(u){u.tagName!=="LI"&&(u=d.querySelector(".b3-list-item")),o.classList.remove("b3-list-item--focus"),u.classList.add("b3-list-item--focus");const m=u.getBoundingClientRect(),f=d.parentElement.getBoundingClientRect();(m.top<f.top||m.bottom>f.bottom)&&u.scrollIntoView(m.top<f.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let u=o;for(;u;)if(u.nextElementSibling){u.nextElementSibling.tagName==="UL"?u.nextElementSibling.classList.contains("fn__none")?u.nextElementSibling.nextElementSibling&&(u=u.nextElementSibling.nextElementSibling):u=u.nextElementSibling.firstElementChild:u.nextElementSibling.classList.contains("protyle")?u.nextElementSibling.nextElementSibling&&(u=u.nextElementSibling.nextElementSibling):u=u.nextElementSibling;break}else{if(u.parentElement.classList.contains("fn__flex-1"))break;u=u.parentElement}if(u.classList.contains("b3-list-item")&&!u.classList.contains("b3-list-item--focus")){o.classList.remove("b3-list-item--focus"),u.classList.add("b3-list-item--focus");const m=u.getBoundingClientRect(),f=d.parentElement.getBoundingClientRect();(m.top<f.top||m.bottom>f.bottom)&&u.scrollIntoView(m.top<f.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let u=o;for(;u;)if(u.previousElementSibling){if(u.previousElementSibling.tagName==="LI")u=u.previousElementSibling;else if(u.previousElementSibling.classList.contains("protyle"))u.previousElementSibling.previousElementSibling&&(u=u.previousElementSibling.previousElementSibling);else if(u.previousElementSibling.tagName==="UL"&&u.previousElementSibling.classList.contains("fn__none"))u.previousElementSibling.previousElementSibling&&(u=u.previousElementSibling.previousElementSibling);else{const m=u.previousElementSibling.querySelectorAll(".b3-list-item");u=m[m.length-1]}break}else{if(u.parentElement.classList.contains("fn__flex-1"))break;u=u.parentElement}if(u.classList.contains("b3-list-item")&&!u.classList.contains("b3-list-item--focus")){o.classList.remove("b3-list-item--focus"),u.classList.add("b3-list-item--focus");const m=u.getBoundingClientRect(),f=d.parentElement.getBoundingClientRect();(m.top<f.top||m.bottom>f.bottom)&&u.scrollIntoView(m.top<f.top)}return e.preventDefault(),!0}return!1};let Va;const H1=(t,e)=>{if($1(e,t))return;if(Va&&(G_(window.siyuan.config.keymap.general.goToEditTabNext.custom,e)||G_(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e))&&e.key.startsWith("Arrow")){xS(t,Va.element,e);return}if(k1(t,e)){e.preventDefault(),e.stopPropagation();return}const n=ue();if(W(window.siyuan.config.keymap.general.goToEditTabNext.custom,e)||W(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)){if(Va&&Va.element.parentElement)return;let o="",r=document.querySelector(".layout__wnd--active ul.layout-tab-bar > .item--focus");if(r||(r=document.querySelector("ul.layout-tab-bar > .item--focus")),r){const d=r.getAttribute("data-id");pi().sort((u,m)=>u.headElement.getAttribute("data-activetime")>m.headElement.getAttribute("data-activetime")?-1:1).forEach((u,m)=>{let f=`<svg class="b3-list-item__graphic"><use xlink:href="#${u.icon}"></use></svg>`,g="";const h=u.headElement.getAttribute("data-initdata");if(u.model instanceof Ot)g=` data-node-id="${u.model.editor.protyle.block.rootID}"`,f=be(u.docIcon||window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-list-item__graphic",!0);else if(h){const b=JSON.parse(h);b.instance==="Editor"&&(g=` data-node-id="${b.rootId}"`,f=be(u.docIcon||window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-list-item__graphic",!0))}o+=`<li data-index="${m}" data-id="${u.id}"${g} class="b3-list-item${d===u.id?" b3-list-item--focus":""}"${d===u.id?' data-original="true"':""}>${f}<span class="b3-list-item__text">${he(u.title)}</span></li>`})}let c="";n||(c=`<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">
<li data-type="riffCard" data-index="0" class="b3-list-item${o?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${pe(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,zp().forEach((d,u)=>{c+=`<li data-type="${d.type}" data-index="${u+1}" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#${d.icon}"></use></svg>
    <span class="b3-list-item__text">${d.title}</span>
    <span class="b3-list-item__meta">${pe(d.hotkey||"")}</span>
</li>`}),c=c+"</ul>"),ce(["dialog"]),Va=new $e({positionId:p.DIALOG_SWITCHTAB,title:window.siyuan.languages.switchTab,content:`<div class="fn__flex-column switch-doc">
    <input style="opacity: 0;height: 0.1px;box-sizing: border-box;margin: 0;padding: 0;border: 0;">
    <div class="fn__flex" style="overflow:auto;">${c}
        <ul${n?' style="border-left:0"':""} class="b3-list b3-list--background fn__flex-1">${o}</ul>
    </div>
    <div class="switch-doc__path"></div>
</div>`}),Va.element.setAttribute("data-key",p.DIALOG_SWITCHTAB),Va.element.querySelector("input").focus(),Mt()&&Va.element.addEventListener("contextmenu",d=>{AS(t,d)}),Va.element.addEventListener("click",d=>{AS(t,d)});return}if(et(e)&&!e.shiftKey&&!e.altKey&&(e.key.startsWith("Arrow")||e.key==="Enter")){const o=window.siyuan.dialogs.find(r=>{if(r.element.getAttribute("data-key")===p.DIALOG_RECENTDOCS)return!0});if(o){e.preventDefault(),xS(t,o.element,e);return}}if(W(window.siyuan.config.keymap.general.recentDocs.custom,e)){ng(),e.preventDefault();return}if(TA(e)){e.preventDefault();return}if(F3(e)){e.preventDefault();return}if(["Home","End","ArrowUp","ArrowDown"].includes(e.key)){let o;if(window.siyuan.dialogs.forEach(r=>{[p.DIALOG_VIEWCARDS,p.DIALOG_HISTORYCOMPARE].includes(r.element.getAttribute("data-key"))&&(o=r)}),o){o.element.getAttribute("data-key")===p.DIALOG_VIEWCARDS?o.element.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()})):o.element.getAttribute("data-key")===p.DIALOG_HISTORYCOMPARE&&S1(e,o),e.preventDefault();return}}const a=e.target;if(!n&&W(window.siyuan.config.keymap.general.syncNow.custom,e)){e.preventDefault(),ig(t);return}if(W(window.siyuan.config.keymap.general.commandPanel.custom,e)){e.preventDefault(),ES(t);return}if(W(window.siyuan.config.keymap.general.editReadonly.custom,e)){e.preventDefault(),by(!window.siyuan.config.editor.readOnly);return}if(W(window.siyuan.config.keymap.general.lockScreen.custom,e)){jp(t),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.dataHistory.custom,e)){pp(t),e.preventDefault();return}if(!n&&W(window.siyuan.config.keymap.general.toggleDock.custom,e)){gb(document.querySelector("#barDock use")),e.preventDefault();return}if(!n&&!window.siyuan.config.readonly&&W(window.siyuan.config.keymap.general.config.custom,e)){Kl(t),e.preventDefault();return}if(W("\u2318A",e)&&!["INPUT","TEXTAREA"].includes(a.tagName)){e.preventDefault();return}if(zp().find(o=>{if(W(o.hotkey,e))return nt(o.type).toggleModel(o.type),e.preventDefault(),!0}))return;if(!n&&W(window.siyuan.config.keymap.general.riffCard.custom,e)){Wo(t),document.activeElement&&document.activeElement.blur(),e.preventDefault();return}if(!n&&W(window.siyuan.config.keymap.general.dailyNote.custom,e)){gh(t),e.stopPropagation(),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.newFile.custom,e)){ki({app:t,useSavePath:!0}),e.preventDefault();return}const s=document.querySelector('.b3-dialog--open[data-key="dialog-confirm"]');if(s){if(e.key==="Enter"){s.dispatchEvent(new CustomEvent("click",{detail:e.key})),e.preventDefault();return}else if(e.key==="Escape"){s.dispatchEvent(new CustomEvent("click",{detail:e.key})),e.preventDefault();return}}if(e.key==="Escape"&&!e.isComposing){$E();const o=document.querySelector(".protyle-img");if(o){o.remove();return}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&!(window.siyuan.dialogs.length>0&&window.siyuan.menus.menu.element.style.zIndex<window.siyuan.dialogs[0].element.querySelector(".b3-dialog").style.zIndex)){window.siyuan.menus.menu.remove(!0);return}const r=document.querySelector(".av__panel");if(r){const m=document.querySelector(".av__cell--select");m&&oe(B(m)),r.remove();return}if(e.repeat&&document.activeElement&&T(document.activeElement,"card__action"))return;if(window.siyuan.dialogs.length>0){window.siyuan.dialogs[window.siyuan.dialogs.length-1].destroy();return}const c={oid:0};window.siyuan.blockPanels.forEach(m=>{if((m.targetElement||typeof m.x=="number")&&m.element.getAttribute("data-pin")==="true"){const f=parseInt(m.element.getAttribute("data-level")),g=m.element.getAttribute("data-oid");c[g]?f>c[g]&&(c[g]=f):c[g]=1}});let d=!1;for(let m=0;m<window.siyuan.blockPanels.length;m++){const f=window.siyuan.blockPanels[m];(f.targetElement||typeof f.x=="number")&&f.element.getAttribute("data-pin")==="false"&&(f.destroy(),d=!0,m--)}if(d)return;if(getSelection().rangeCount>0){const m=getSelection().getRangeAt(0);if(T(m.startContainer,"protyle-content",!0)){ne(m);return}}const u=window.siyuan.backStack[window.siyuan.backStack.length-1];if(u&&u.protyle.toolbar.range)ne(u.protyle.toolbar.range);else{const m=Oe().editor[0];m&&oe(m.editor.protyle.wysiwyg.element.firstElementChild)}e.preventDefault();return}if(!n&&W(window.siyuan.config.keymap.general.mainMenu.custom,e)){_y(t,document.querySelector("#barWorkspace").getBoundingClientRect()),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goForward.custom,e)){Pp(t),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goBack.custom,e)){Mp(t),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.closeTab.custom,e)&&!e.repeat){hn({command:"closeTab"}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.recentClosed.custom,e)){hn({command:"recentClosed",app:t}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab1.custom,e)&&!e.repeat){sn(0),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab2.custom,e)&&!e.repeat){sn(1),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab3.custom,e)&&!e.repeat){sn(2),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab4.custom,e)&&!e.repeat){sn(3),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab5.custom,e)&&!e.repeat){sn(4),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab6.custom,e)&&!e.repeat){sn(5),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab7.custom,e)&&!e.repeat){sn(6),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab8.custom,e)&&!e.repeat){sn(7),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTab9.custom,e)&&!e.repeat){sn(-1),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTabNext.custom,e)&&!e.repeat){sn(-3),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.goToTabPrev.custom,e)&&!e.repeat){sn(-2),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.closeOthers.custom,e)&&!e.repeat){hn({command:"closeOthers"}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.closeAll.custom,e)&&!e.repeat){hn({command:"closeAll"}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.closeUnmodified.custom,e)&&!e.repeat){hn({command:"closeUnmodified"}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.closeLeft.custom,e)&&!e.repeat){hn({command:"closeLeft"}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.closeRight.custom,e)&&!e.repeat){hn({command:"closeRight"}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.splitLR.custom,e)&&!e.repeat){e.preventDefault(),mi("splitLR",t);return}if(W(window.siyuan.config.keymap.general.splitMoveR.custom,e)&&!e.repeat){e.preventDefault(),mi("splitMoveR",t);return}if(W(window.siyuan.config.keymap.general.splitTB.custom,e)&&!e.repeat){e.preventDefault(),mi("splitTB",t);return}if(W(window.siyuan.config.keymap.general.tabToWindow.custom,e)&&!e.repeat){e.preventDefault(),mi("tabToWindow",t);return}if(W(window.siyuan.config.keymap.general.splitMoveB.custom,e)&&!e.repeat){e.preventDefault(),mi("splitMoveB",t);return}if(W(window.siyuan.config.keymap.general.stickSearch.custom,e)){mi("stickSearch",t),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.unsplit.custom,e)&&!e.repeat){e.preventDefault(),mi("unsplit",t);return}if(W(window.siyuan.config.keymap.general.unsplitAll.custom,e)&&!e.repeat){e.preventDefault(),mi("unsplitAll",t);return}if(M1(t,e)||!n&&P1(t,e)||!n&&N1(t,e))return;let l=!1;if(t.plugins.find(o=>{if(o.commands.find(r=>{if(r.callback&&!r.fileTreeCallback&&!r.editorCallback&&!r.dockCallback&&!r.globalCallback&&W(r.customHotkey,e))return l=!0,r.callback(),!0}),l)return!0}),l)return e.stopPropagation(),e.preventDefault(),!0;if(W(window.siyuan.config.keymap.general.replace.custom,e)){hn({command:"replace",app:t}),e.preventDefault();return}if(W(window.siyuan.config.keymap.general.globalSearch.custom,e)){hn({command:"globalSearch",app:t}),e.preventDefault();return}if(!T(a,"pdf__outer")&&W(window.siyuan.config.keymap.general.search.custom,e)){hn({command:"search",app:t}),e.preventDefault();return}if(W("\u2318S",e))return e.preventDefault(),!0},CS=t=>{},PD=t=>{},St={element:void 0,_genItem(t,e){let n="";return Object.keys(t).forEach(a=>{if(window.siyuan.languages[a]){const i=pe(t[a].custom);let s=window.siyuan.languages[a];"editor"+p.ZWSP+"general"===e&&a==="duplicate"&&(s=`${window.siyuan.languages.duplicate} / ${window.siyuan.languages.duplicateMirror}`),n+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${s}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${i}</span>
    <input data-key="${e+p.ZWSP+a}" data-value="${t[a].custom}" data-default="${t[a].default}" class="b3-text-field fn__none" value="${i}" spellcheck="false">
</label>`}}),n},genHTML(t){let e="";return t.plugins.forEach(n=>{let a="";n.commands.forEach(i=>{const s=pe(i.customHotkey);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${i.langText||(n.i18n?n.i18n[i.langKey]:"")||i.langKey}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${s}</span>
    <input data-key="plugin${p.ZWSP}${n.name}${p.ZWSP}${i.langKey}" data-value="${i.customHotkey}" data-default="${i.hotkey}" class="b3-text-field fn__none" value="${s}" spellcheck="false">
</label>`}),n.updateProtyleToolbar([]).forEach(i=>{if(typeof i=="string"||p.INLINE_TYPE.concat("|").includes(i.name)||!i.hotkey)return;const s=window.siyuan.config.keymap.plugin[n.name][i.name],l=pe(s.custom);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${i.tip||window.siyuan.languages[i.lang]}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${l}</span>
    <input data-key="plugin${p.ZWSP}${n.name}${p.ZWSP}${i.name}" data-value="${s.custom}" data-default="${s.default}" class="b3-text-field fn__none" value="${l}" spellcheck="false">
</label>`}),Object.keys(n.docks).forEach(i=>{const s=n.docks[i].config;if(!s.hotkey)return;const l=window.siyuan.config.keymap.plugin[n.name][i],o=pe(l.custom);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${s.title}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${o}</span>
    <input data-key="plugin${p.ZWSP}${n.name}${p.ZWSP}${i}" data-value="${l.custom}" data-default="${l.default}" class="b3-text-field fn__none" value="${o}" spellcheck="false">
</label>`}),a&&(e+=`<div class="b3-list-item b3-list-item--narrow toggle">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__text ft__on-surface">${n.displayName}</span>
</div>
<div class="fn__none b3-list__panel">
    ${a}
</div>`)}),e&&(e=`<div class="b3-list b3-list--border b3-list--background">
    <div class="b3-list-item b3-list-item--narrow toggle">
        <span class="b3-list-item__toggle b3-list-item__toggle--hl">
            <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.plugin}</span>
    </div>
    <div class="b3-list__panel">
        ${e}
    </div>
</div>`),`<div class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip}</span>
    <span class="fn__flex-1"></span>
    <button id="keymapRefreshBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconRefresh"></use></svg>
        ${window.siyuan.languages.refresh}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip2}</span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <button id="keymapResetBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconUndo"></use></svg>
        ${window.siyuan.languages.reset}
    </button>
</div>
<div class="b3-label file-tree config-keymap" id="keymapList">
    <div class="fn__flex config__item">
        <label class="b3-form__icon fn__block">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="keymapInput" class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
        </label>
        <div class="fn__space"></div>
        <label class="b3-form__icon fn__block searchByKeyLabel">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconKeymap"></use></svg>
            <input id="searchByKey" data-value="" class="b3-form__icon-input b3-text-field fn__block" spellcheck="false" placeholder="${window.siyuan.languages.keymap}">
        </label>
        <div class="fn__space"></div>
        <button id="clearSearchBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
            <svg style="height: 14px"><use xlink:href="#iconClose"></use></svg>
            ${window.siyuan.languages.clear}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
        </div>
        <div class="fn__none b3-list__panel">${St._genItem(window.siyuan.config.keymap.general,"general")}</div>
    </div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
            </span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.editor}</span>
        </div>
        <div class="b3-list__panel">
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
            </div>
            <div class="fn__none b3-list__panel">${St._genItem(window.siyuan.config.keymap.editor.general,"editor"+p.ZWSP+"general")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.element}</span>
            </div>
            <div class="fn__none b3-list__panel">${St._genItem(window.siyuan.config.keymap.editor.insert,"editor"+p.ZWSP+"insert")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.headings}</span>
            </div>
            <div class="fn__none b3-list__panel">${St._genItem(window.siyuan.config.keymap.editor.heading,"editor"+p.ZWSP+"heading")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.list1}</span>
            </div>
            <div class="fn__none b3-list__panel">${St._genItem(window.siyuan.config.keymap.editor.list,"editor"+p.ZWSP+"list")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.table}</span>
            </div>
            <div class="fn__none b3-list__panel">${St._genItem(window.siyuan.config.keymap.editor.table,"editor"+p.ZWSP+"table")}</div>
        </div>
    </div>
    ${e}
</div>`},_setkeymap(t){const e=JSON.parse(JSON.stringify(p.SIYUAN_KEYMAP)),n=window.siyuan.config.keymap.general.toggleWin.custom;St.element.querySelectorAll("label.b3-list-item input").forEach(a=>{const i=a.getAttribute("data-key").split(p.ZWSP),s=a.getAttribute("data-value");i[0]==="plugin"?(window.siyuan.config.keymap.plugin[i[1]][i[2]].custom=s,e.plugin=window.siyuan.config.keymap.plugin,t.plugins.forEach(l=>{l.name===i[1]&&l.commands.forEach(o=>{o.langKey===i[2]&&(o.customHotkey=s)})})):i[0]==="general"?e[i[0]][i[1]].custom=s:i[0]==="editor"&&(i[1]==="general"||i[1]==="insert"||i[1]==="heading"||i[1]==="list"||i[1]==="table")&&(e[i[0]][i[1]][i[2]].custom=s)}),window.siyuan.config.keymap=e,A("/api/setting/setKeymap",{data:e},()=>{})},search(t,e){const n=St.element.querySelector("#keymapList");n.querySelectorAll(".b3-list-item--hide-action > .b3-list-item__text").forEach(a=>{const i=a.parentElement;let s=!1;if((e===""||i.querySelector(".b3-text-field").getAttribute("data-value").indexOf(e)>-1)&&(s=!0),(a.textContent.toLowerCase().indexOf(t.toLowerCase())>-1||t.toLowerCase().indexOf(a.textContent.toLowerCase())>-1||t==="")&&s?(i.classList.remove("fn__none"),i.parentElement.classList.remove("fn__none"),i.parentElement.parentElement.classList.remove("fn__none")):i.classList.add("fn__none"),!i.nextElementSibling){const l=i.parentElement.previousElementSibling;t===""&&e===""&&(l.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")?i.parentElement.classList.remove("fn__none"):i.parentElement.classList.add("fn__none")),i.parentElement.childElementCount===i.parentElement.querySelectorAll(".b3-list-item.fn__none").length?l.classList.add("fn__none"):l.classList.remove("fn__none")}}),this._toggleSearchItem(n.lastElementChild,t,e),n.childElementCount===5&&this._toggleSearchItem(n.lastElementChild.previousElementSibling,t,e)},_toggleSearchItem(t,e,n){e===""&&n===""&&(t.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")?t.lastElementChild.classList.remove("fn__none"):t.lastElementChild.classList.add("fn__none")),t.querySelectorAll(".b3-list-item--hide-action.fn__none").length===t.querySelectorAll(".b3-list-item--hide-action").length?t.firstElementChild.classList.add("fn__none"):t.firstElementChild.classList.remove("fn__none")},_getTip(t){const e=t.parentElement;let n=e.querySelector(".b3-list-item__text").textContent.trim();const a=e.parentElement.previousElementSibling;n=a.textContent.trim()+"-"+n;const i=a.parentElement.previousElementSibling;return i.classList.contains("b3-list-item")&&(n=i.textContent.trim()+"-"+n),n},bindEvent(t){St.element.querySelector("#keymapRefreshBtn").addEventListener("click",()=>{Un({cb(){window.location.reload()},errorExit:!1})});const e=St.element.querySelector("#keymapInput"),n=St.element.querySelector("#searchByKey");e.addEventListener("compositionend",()=>{St.search(e.value,n.dataset.value)}),e.addEventListener("input",s=>{s.isComposing||St.search(e.value,n.dataset.value)}),n.addEventListener("blur",()=>{CS(t)}),n.addEventListener("keydown",function(s){s.stopPropagation(),s.preventDefault();const l=St._getKeymapString(s);setTimeout(()=>{this.value=pe(l)}),this.dataset.keymap=l,St.search(e.value,l)}),St.element.querySelector("#clearSearchBtn").addEventListener("click",()=>{e.value="",n.value="",St.search("","")}),St.element.querySelector("#keymapResetBtn").addEventListener("click",()=>{Re("\u26A0\uFE0F "+window.siyuan.languages.reset,window.siyuan.languages.confirmReset,()=>{A("/api/setting/setKeymap",{data:p.SIYUAN_KEYMAP},()=>{window.location.reload()})})});const a=St.element.querySelector("#keymapList");a.addEventListener("click",s=>{let l=s.target;for(;l&&!l.isEqualNode(a);){const o=l.getAttribute("data-type");if(o==="reset"){const r=l.parentElement.querySelector(".b3-text-field");r.value=pe(r.getAttribute("data-default")),r.setAttribute("data-value",r.getAttribute("data-default")),r.previousElementSibling.textContent=r.value,St._setkeymap(t),s.preventDefault(),s.stopPropagation();break}else if(o==="clear"){const r=l.parentElement.querySelector(".b3-text-field");r.value="",r.previousElementSibling.textContent="",r.setAttribute("data-value",""),St._setkeymap(t),s.preventDefault(),s.stopPropagation();break}else if(o==="update"){l.classList.add("fn__none");const r=l.nextElementSibling;r.classList.remove("fn__none"),r.focus(),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("b3-list-item--hide-action")){const r=l.querySelector(".b3-text-field");r.classList.remove("fn__none"),r.focus(),r.previousElementSibling.classList.add("fn__none"),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("toggle")){l.nextElementSibling.classList.contains("fn__none")?(l.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open"),l.nextElementSibling.classList.remove("fn__none")):(l.firstElementChild.firstElementChild.classList.remove("b3-list-item__arrow--open"),l.nextElementSibling.classList.add("fn__none")),s.preventDefault(),s.stopPropagation();break}l=l.parentElement}});let i;a.querySelectorAll("label.b3-list-item input").forEach(s=>{s.addEventListener("keydown",function(l){l.stopPropagation(),l.preventDefault();const o=St._getKeymapString(l),r=pe(o);clearTimeout(i),i=window.setTimeout(()=>{const c=this.getAttribute("data-key").split(p.ZWSP);c[1]==="list"&&(c[1]="list1"),c[1]==="heading"&&(c[1]="headings");let d=!1;const u=["\u2318","\u21E7","\u2325","\u2303"].includes(o.substr(o.length-1,1));if((u||["\u2318A","\u2318X","\u2318C","\u2318V","\u2318-","\u2318=","\u23180","\u21E7\u2318V","\u2318/","\u21E7\u2191","\u21E7\u2193","\u21E7\u2192","\u21E7\u2190","\u21E7\u21E5","\u2303D","\u21E7\u2318\u2192","\u21E7\u2318\u2190","\u2318Home","\u2318End","\u21E7\u21A9","\u21A9","PageUp","PageDown","\u232B","\u2326","Escape"].includes(o)||Mt()&&c[0]==="general"&&["goToEditTabNext","goToEditTabPrev"].includes(c[1])&&o.includes("\u2318"))&&(u||de(`${window.siyuan.languages.invalid} [${r}]`),d=!0),Array.from(St.element.querySelectorAll("label.b3-list-item input")).find(m=>{if(m!==this&&m.getAttribute("data-value")===o){const f=m.getAttribute("data-key").split(p.ZWSP);return f[1]==="list"&&(f[1]="list1"),f[1]==="heading"&&(f[1]="headings"),de(`${window.siyuan.languages.conflict} [${St._getTip(m)} ${r}]`),d=!0,!0}}),d){this.value=pe(this.getAttribute("data-value"));return}At(),this.setAttribute("data-value",o),this.value=r,St._setkeymap(t)},p.TIMEOUT_TRANSITION)}),s.addEventListener("blur",function(){CS(t),setTimeout(()=>{this.classList.add("fn__none"),this.previousElementSibling.textContent=this.value,this.previousElementSibling.classList.remove("fn__none")},p.TIMEOUT_INPUT)})})},_getKeymapString(t){let e="";return t.ctrlKey&&Mt()&&(e+="\u2303"),t.altKey&&(e+="\u2325"),t.shiftKey&&(e+="\u21E7"),(t.metaKey||!Mt()&&t.ctrlKey)&&(e+="\u2318"),t.key!=="Shift"&&t.key!=="Alt"&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Unidentified"&&(t.keyCode===229?t.code==="Minus"?e+="-":t.code==="Semicolon"?e+=";":t.code==="Quote"?e+="'":t.code==="Comma"?e+=",":t.code==="Period"?e+=".":t.code==="Slash"&&(e+="/"):e+=p.KEYCODELIST[t.keyCode]||(t.key.length>1?t.key:t.key.toUpperCase())),e}},_a=t=>{const e=[];return t.forEach(n=>{e.push(window.siyuan.languages[n])}),e},O1=(t,e)=>{const n=[_a(["config","fullWidth","md7","md8","md37","md38","editor","md2","md3","md12","md16","md27","md28","md29","md30","md31","md32","md33","md34","md39","md40","fontSizeTip","fontSize","font","font1","generateHistory","generateHistoryInterval","historyRetentionDays","historyRetentionDaysTip","clearHistory","katexMacros","katexMacrosTip","editReadonly","editReadonlyTip","embedBlockBreadcrumb","embedBlockBreadcrumbTip","outlineOutdentTip","outdent","floatWindowMode","floatWindowModeTip","justify","justifyTip","rtl","rtlTip","spellcheck","spellcheckTip","backlinkExpand","backlinkExpandTip","backmentionExpand","backmentionExpandTip","onlySearchForDoc","onlySearchForDocTip","dynamicLoadBlocks","dynamicLoadBlocksTip","fontSizeScrollZoom","fontSizeScrollZoomTip","listItemDotNumberClickFocus","listItemDotNumberClickFocusTip","editorMarkdownInlineAsterisk","editorMarkdownInlineUnderscore","editorMarkdownInlineSup","editorMarkdownInlineSupTip","editorMarkdownInlineSub","editorMarkdownInlineSubTip","editorMarkdownInlineTag","editorMarkdownInlineTagTip","editorMarkdownInlineMath","editorMarkdownInlineMathTip","editorMarkdownInlineStrikethrough","editorMarkdownInlineStrikethroughTip","editorMarkdownInlineMark","editorMarkdownInlineMarkTip","allowHTMLBLockScript","allowHTMLBLockScriptTip","backlinkExpandTip","backmentionExpandTip","backlinkContainChildren","backlinkContainChildrenTip"]),_a(["selectOpen","tabLimit","fileTree","fileTree2","fileTree3","fileTree4","fileTree5","fileTree6","fileTree7","fileTree8","fileTree9","fileTree10","fileTree12","fileTree13","fileTree15","fileTree16","fileTree17","fileTree18","fileTree19","fileTree20","fileTree21","fileTree22","fileTree23","fileTree24","fileTree25"]),_a(["riffCard","flashcardNewCardLimit","flashcardNewCardLimitTip","flashcardReviewCardLimit","flashcardNewCardLimit","flashcardReviewCardLimitTip","flashcardMark","flashcardMarkTip","flashcardList","flashcardSuperBlock","flashcardHeading","flashcardDeck","flashcardDeckTip","flashcardFSRSParamRequestRetention","flashcardFSRSParamRequestRetentionTip","flashcardFSRSParamMaximumInterval","flashcardFSRSParamMaximumIntervalTip","flashcardFSRSParamWeights","flashcardFSRSParamWeightsTip","reviewMode","reviewModeTip"]),["AI"].concat(_a(["ai","apiTimeout","apiTimeoutTip","apiMaxTokens","apiMaxTokensTip","apiKey","apiKeyTip","apiProxy","apiProxyTip","apiBaseURL","apiBaseURLTip","apiUserAgentTip","apiVersion","apiVersionTip","apiProvider","apiProviderTip","apiTemperature","apiTemperatureTip","apiMaxContexts","apiMaxContextsTip"])),_a(["assets","unreferencedAssets","missingAssets"]),_a(["paragraphBeginningSpace","md4","export","export1","export2","export5","export11","export13","export14","export15","export19","export20","ref","blockEmbed","export17","export18","export23","export24","export25","export26","export27","export28","export29"]),_a(["language","language1","appearance","appearance1","appearance2","appearance3","appearance4","appearance5","appearance6","appearance8","appearance9","appearance10","appearance11","appearance16","appearance17","appearance18","resetLayout","reset","icon","themeLight","themeDark","close","themeOS","theme","theme2","theme11","theme12","customEmoji","customEmojiTip","refresh"]),_a(["bazaar","theme","template","icon","widget"]),_a(["search","searchLimit","searchLimit1","memo","name","alias","keywordsLimit","doc","headings","list1","listItem","code","math","table","quote","superBlock","paragraph","indexAssetPath","embedBlock","database","searchBackmention","searchVirtualRef","searchBlockAttr","searchBlockType","searchCaseSensitive"]),_a(["keymap","keymapTip2"].concat(Object.keys(p.SIYUAN_KEYMAP.general)).concat(Object.keys(p.SIYUAN_KEYMAP.editor.general)).concat(Object.keys(p.SIYUAN_KEYMAP.editor.heading)).concat(Object.keys(p.SIYUAN_KEYMAP.editor.insert)).concat(Object.keys(p.SIYUAN_KEYMAP.editor.list)).concat(Object.keys(p.SIYUAN_KEYMAP.editor.table))),_a(["accountTip","accountName","password","captcha","forgetPassword","login","register","twoFactorCaptcha","account1","account2","account5"]),_a(["cloudStorage","trafficStat","sync","backup","cdn","total","sizeLimit","cloudBackup","cloudBackupTip","updatePath","cloudSync","upload","download","syncMode","syncModeTip","generateConflictDoc","generateConflictDocTip","syncProvider","syncProviderTip","syncMode1","syncMode2","reposTip","openSyncTip1","openSyncTip2","cloudSyncDir","cloudSyncDirTip","config"]),_a(["publishService","publishServiceTip","publishServicePort","publishServicePortTip","publishServiceAddresses","publishServiceAddressesTip","publishServiceAuth","publishServiceAuthTip","publishServiceAuthAccounts","publishServiceAuthAccountsTip"]),_a(["autoLaunch","autoLaunchTip","about","about1","about2","about3","about4","about5","about6","about7","about8","about11","about12","about13","about14","about17","config","dataRepoKey","dataRepoKeyTip1","dataRepoKeyTip2","slogan","currentVer","checkUpdate","updatePath","systemLog","importKey","genKey","genKeyByPW","copyKey","resetRepo","systemLogTip","export","downloadLatestVer","safeQuit","directConnection","siyuanNote","key","password","copied","resetRepoTip","autoDownloadUpdatePkg","autoDownloadUpdatePkgTip","networkProxy","keyPlaceholder","initRepoKeyTip","dataRepoPurge","dataRepoPurgeTip","dataRepoAutoPurgeIndexRetentionDays","dataRepoAutoPurgeRetentionIndexesDaily","vacuumDataIndex","vacuumDataIndexTip","rebuildDataIndex","rebuildDataIndexTip"])],a=t.querySelector(".b3-form__icon input"),i=()=>{const s=[],l=a.value;n.map((c,d)=>{c.map(u=>{u||console.warn("Search config miss language: ",c,d),u&&(l.toLowerCase().indexOf(u.toLowerCase())>-1||u.toLowerCase().indexOf(l.toLowerCase())>-1)&&s.push(d)})});let o;t.querySelectorAll(".b3-tab-bar li").forEach((c,d)=>{if(s.includes(d)){o||(o=c);const u=c.getAttribute("data-name");if(c.style.display="",["image","bazaar","account"].includes(u))return;const m=t.querySelector(`.config__tab-container[data-name="${u}"]`);if(m.innerHTML===""&&DS(u,m,e),u==="keymap"){const f=St.element.querySelector("#keymapInput"),g=St.element.querySelector("#searchByKey");f.value=l,g.value="",St.search(f.value,g.value)}else u==="search"?m.querySelectorAll(`.config__tab-container[data-name="${u}"] .b3-label`).forEach(f=>{let g=!1,h=!1;const b=f.firstElementChild.textContent.toLowerCase();(b.indexOf(l.toLowerCase())>-1||l.toLowerCase().indexOf(b)>-1)&&(h=!0),f.querySelectorAll(".fn__flex-1").forEach(y=>{if(!y.parentElement.classList.contains("fn__none")){const w=y.textContent.toLowerCase();w.indexOf(l.toLowerCase())>-1||l.toLowerCase().indexOf(w)>-1||h?(y.parentElement.style.display="",g=!0):y.parentElement.style.display="none"}}),f.classList.contains("fn__none")||(g?f.style.display="":f.style.display="none")}):m.querySelectorAll(`.config__tab-container[data-name="${u}"] .b3-label`).forEach(f=>{if(!f.classList.contains("fn__none")){const g=f.textContent.toLowerCase();g.indexOf(l.toLowerCase())>-1||l.toLowerCase().indexOf(g)>-1?f.style.display="":f.style.display="none"}})}else c.style.display="none"});const r=t.querySelectorAll(".config__tab-container");o?o.click():r.forEach(c=>{c.classList.add("fn__none")}),a.focus()};a.addEventListener("compositionend",()=>{i()}),a.addEventListener("input",s=>{s.isComposing||i()})},Qt={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.selectOpen}
        <div class="b3-label__text">${window.siyuan.languages.fileTree2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="alwaysSelectOpenedFile" type="checkbox"${window.siyuan.config.fileTree.alwaysSelectOpenedFile?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree7}
        <div class="b3-label__text">${window.siyuan.languages.fileTree8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="openFilesUseCurrentTab" type="checkbox"${window.siyuan.config.fileTree.openFilesUseCurrentTab?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree9}
        <div class="b3-label__text">${window.siyuan.languages.fileTree10}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeTabsOnStart" type="checkbox"${window.siyuan.config.fileTree.closeTabsOnStart?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree18}
        <div class="b3-label__text">${window.siyuan.languages.fileTree19}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowCreateDeeper" type="checkbox"${window.siyuan.config.fileTree.allowCreateDeeper?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree3}
        <div class="b3-label__text">${window.siyuan.languages.fileTree4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="removeDocWithoutConfirm" type="checkbox"${window.siyuan.config.fileTree.removeDocWithoutConfirm?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree20}
        <div class="b3-label__text">${window.siyuan.languages.fileTree21}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="useSingleLineSave" type="checkbox"${window.siyuan.config.fileTree.useSingleLineSave?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree24}
        <div class="b3-label__text">${window.siyuan.languages.fileTree25}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="createDocAtTop" type="checkbox"${window.siyuan.config.fileTree.createDocAtTop?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree22}
        <div class="b3-label__text">${window.siyuan.languages.fileTree23}</div>
    </div>
    <span class="fn__space"></span>
    <div class="fn__size200 fn__flex-center fn__flex">
        <input class="b3-text-field fn__flex-1" id="largeFileWarningSize" type="number" min="2" max="10240" value="${window.siyuan.config.fileTree.largeFileWarningSize}">
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-center">MB</span>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree16}
        <div class="b3-label__text">${window.siyuan.languages.fileTree17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxListCount" type="number" min="1" max="10240" value="${window.siyuan.config.fileTree.maxListCount}">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.tabLimit}
        <div class="b3-label__text">${window.siyuan.languages.tabLimit1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxOpenTabCount" type="number" min="1" max="32" value="${window.siyuan.config.fileTree.maxOpenTabCount}">
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${Yf(window.siyuan.config.fileTree.docCreateSaveBox)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${Yf(window.siyuan.config.fileTree.refCreateSaveBox)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
    </div>
</div>`,_send(){let t=parseInt(Qt.element.querySelector("#maxOpenTabCount").value);32<t&&(t=32,Qt.element.querySelector("#maxOpenTabCount").value="32"),1>t&&(t=1,Qt.element.querySelector("#maxOpenTabCount").value="1"),A("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:Qt.element.querySelector("#alwaysSelectOpenedFile").checked,refCreateSavePath:Qt.element.querySelector("#refCreateSavePath").value,refCreateSaveBox:Qt.element.querySelector("#refCreateSaveBox").value,docCreateSavePath:Qt.element.querySelector("#docCreateSavePath").value,docCreateSaveBox:Qt.element.querySelector("#docCreateSaveBox").value,openFilesUseCurrentTab:Qt.element.querySelector("#openFilesUseCurrentTab").checked,closeTabsOnStart:Qt.element.querySelector("#closeTabsOnStart").checked,allowCreateDeeper:Qt.element.querySelector("#allowCreateDeeper").checked,removeDocWithoutConfirm:Qt.element.querySelector("#removeDocWithoutConfirm").checked,useSingleLineSave:Qt.element.querySelector("#useSingleLineSave").checked,createDocAtTop:Qt.element.querySelector("#createDocAtTop").checked,largeFileWarningSize:parseInt(Qt.element.querySelector("#largeFileWarningSize").value),maxListCount:parseInt(Qt.element.querySelector("#maxListCount").value),maxOpenTabCount:t},e=>{window.siyuan.config.fileTree=e.data})},bindEvent:()=>{Qt.element.querySelector("#docCreateSavePath").value=window.siyuan.config.fileTree.docCreateSavePath,Qt.element.querySelector("#refCreateSavePath").value=window.siyuan.config.fileTree.refCreateSavePath,Qt.element.querySelectorAll("input, select").forEach(t=>{t.addEventListener("change",()=>{Qt._send()})})}};var TS=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const ct={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.paragraphBeginningSpace}
        <div class="b3-label__text">${window.siyuan.languages.md4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="paragraphBeginningSpace" type="checkbox"${window.siyuan.config.export.paragraphBeginningSpace?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export17}
        <div class="b3-label__text">${window.siyuan.languages.export18}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="addTitle" type="checkbox"${window.siyuan.config.export.addTitle?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export23}
        <div class="b3-label__text">${window.siyuan.languages.export24}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="markdownYFM" type="checkbox"${window.siyuan.config.export.markdownYFM?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export31}
        <div class="b3-label__text">${window.siyuan.languages.export32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="inlineMemo" type="checkbox"${window.siyuan.config.export.inlineMemo?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.ref}
        <div class="b3-label__text">${window.siyuan.languages.export11}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="2" ${window.siyuan.config.export.blockRefMode===2?"selected":""}>${window.siyuan.languages.export2}</option>
        <option value="3" ${window.siyuan.config.export.blockRefMode===3?"selected":""}>${window.siyuan.languages.export3}</option>
        <option value="4" ${window.siyuan.config.export.blockRefMode===4?"selected":""}>${window.siyuan.languages.export4}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.blockEmbed}
        <div class="b3-label__text">${window.siyuan.languages.export12}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockEmbedMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.blockEmbedMode===0?"selected":""}>${window.siyuan.languages.export0}</option>
        <option value="1" ${window.siyuan.config.export.blockEmbedMode===1?"selected":""}>${window.siyuan.languages.export1}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export5}
        <div class="b3-label__text">${window.siyuan.languages.export6}</div>
    </div>
    <span class="fn__space"></span>
    <select id="fileAnnotationRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.fileAnnotationRefMode===0?"selected":""}>${window.siyuan.languages.export7}</option>
        <option value="1" ${window.siyuan.config.export.fileAnnotationRefMode===1?"selected":""}>${window.siyuan.languages.export8}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export21}
        <div class="b3-label__text">${window.siyuan.languages.export22}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="pdfFooter">
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.export27}
    <div class="b3-label__text">${window.siyuan.languages.export28}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="pdfWatermarkStr">
    <div class="fn__hr"></div>
    <div class="b3-label__text"><a href="https://pdfcpu.io/core/watermark#description" target="_blank">${window.siyuan.languages.export29}</a></div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="pdfWatermarkDesc"></textarea>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.export30}
    <div class="b3-label__text">${window.siyuan.languages.export28}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="imageWatermarkStr">
    <div class="fn__hr"></div>
    <div class="b3-label__text">    
        ${window.siyuan.languages.export29}<br>
        ${window.siyuan.languages.export10}
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="imageWatermarkDesc"></textarea>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export25}
        <div class="b3-label__text">${window.siyuan.languages.export26}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="docxTemplate" placeholder="F:\\template.docx">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export13}
        <div class="b3-label__text">${window.siyuan.languages.export14}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextLeft">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextRight">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export15}
        <div class="b3-label__text">${window.siyuan.languages.export16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagOpenMarker">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagCloseMarker">
</div>
<div class="fn__flex b3-label config__item${Ne()?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export19}
        <span class="fn__space"></span>
        <a href="javascript:void(0)" id="pandocBinPath" style="word-break: break-all">${window.siyuan.config.export.pandocBin}</a>
        <div class="b3-label__text">${window.siyuan.languages.export20}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="pandocBin"><svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}</button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.export} Data
        <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="exportData">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.import} Data
        <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.exportConf}
        <div class="b3-label__text">${window.siyuan.languages.exportConfTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="exportConf">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.importConf}
        <div class="b3-label__text">${window.siyuan.languages.importConfTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" style="position: relative">
        <input id="importConf" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
</div>`,bindEvent:()=>{ct.element.querySelector("#docxTemplate").value=window.siyuan.config.export.docxTemplate,ct.element.querySelector("#pdfFooter").value=window.siyuan.config.export.pdfFooter,ct.element.querySelector("#pdfWatermarkStr").value=window.siyuan.config.export.pdfWatermarkStr,ct.element.querySelector("#pdfWatermarkDesc").value=window.siyuan.config.export.pdfWatermarkDesc,ct.element.querySelector("#imageWatermarkStr").value=window.siyuan.config.export.imageWatermarkStr,ct.element.querySelector("#imageWatermarkDesc").value=window.siyuan.config.export.imageWatermarkDesc,ct.element.querySelector("#blockRefTextLeft").value=window.siyuan.config.export.blockRefTextLeft,ct.element.querySelector("#blockRefTextRight").value=window.siyuan.config.export.blockRefTextRight,ct.element.querySelector("#tagOpenMarker").value=window.siyuan.config.export.tagOpenMarker,ct.element.querySelector("#tagCloseMarker").value=window.siyuan.config.export.tagCloseMarker;const t=ct.element.querySelector("#pandocBinPath"),e=n=>{A("/api/setting/setExport",{paragraphBeginningSpace:ct.element.querySelector("#paragraphBeginningSpace").checked,addTitle:ct.element.querySelector("#addTitle").checked,markdownYFM:ct.element.querySelector("#markdownYFM").checked,inlineMemo:ct.element.querySelector("#inlineMemo").checked,blockRefMode:parseInt(ct.element.querySelector("#blockRefMode").value,10),blockEmbedMode:parseInt(ct.element.querySelector("#blockEmbedMode").value,10),fileAnnotationRefMode:parseInt(ct.element.querySelector("#fileAnnotationRefMode").value,10),pdfFooter:ct.element.querySelector("#pdfFooter").value,pdfWatermarkStr:ct.element.querySelector("#pdfWatermarkStr").value,pdfWatermarkDesc:ct.element.querySelector("#pdfWatermarkDesc").value,imageWatermarkStr:ct.element.querySelector("#imageWatermarkStr").value,imageWatermarkDesc:ct.element.querySelector("#imageWatermarkDesc").value,docxTemplate:ct.element.querySelector("#docxTemplate").value,blockRefTextLeft:ct.element.querySelector("#blockRefTextLeft").value,blockRefTextRight:ct.element.querySelector("#blockRefTextRight").value,tagOpenMarker:ct.element.querySelector("#tagOpenMarker").value,tagCloseMarker:ct.element.querySelector("#tagCloseMarker").value,pandocBin:n||window.siyuan.config.export.pandocBin},a=>{ct.onSetexport(a.data),t.textContent=a.data.pandocBin})};ct.element.querySelectorAll("select").forEach(n=>{n.addEventListener("change",()=>{e()})}),ct.element.querySelectorAll("input, textarea").forEach(n=>{n.id=="importData"?n.addEventListener("change",a=>{const i=new FormData;i.append("file",a.target.files[0]),A("/api/import/importData",i)}):n.id==="importConf"?n.addEventListener("change",a=>{const i=new FormData;i.append("file",a.target.files[0]),A("/api/system/importConf",i,s=>{if(s.code!==0){de(s.msg);return}de(window.siyuan.languages.imported),Un({errorExit:!0,cb:Ns})})}):n.addEventListener("change",()=>{e()})}),ct.element.querySelector("#exportData").addEventListener("click",()=>TS(void 0,null,function*(){A("/api/export/exportData",{},n=>{nn(n.data.zip)})})),ct.element.querySelector("#exportConf").addEventListener("click",()=>TS(void 0,null,function*(){A("/api/system/exportConf",{},n=>{nn(n.data.zip)})}))},onSetexport:t=>{window.siyuan.config.export=t}};var B1=Ue(922);const wy=t=>t===0?as("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replaceAll("${accountServer}",Fn(""))}</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:ny()?t===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Region ID</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="s3ConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.s3.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="s3">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="s3">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:t===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="webdavConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.webdav.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="webdav">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="webdav">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:t===4?`<div class="b3-label b3-label--inner">
    <div class="ft__error">
        ${window.siyuan.languages.mobileNotSupport}
    </div>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderLocalIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.local.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.local.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="localConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="1024" value="${window.siyuan.config.sync.local.concurrentReqs}">
</div>`:"":`<div>
    ${window.siyuan.languages._kernel[214].replaceAll("${accountServer}",Fn(""))}
</div>
<div class="ft__error${t==4?"":" fn__none"}">
    <div class="fn__hr--b"></div>
    ${window.siyuan.languages.mobileNotSupport}
</div>`,vy=()=>{const t=en.element.querySelector("#importData");t&&t.addEventListener("change",()=>{const s=new FormData;s.append("file",t.files[0]);const l=t.getAttribute("data-type")==="s3";A(l?"/api/sync/importSyncProviderS3":"/api/sync/importSyncProviderWebDAV",s,o=>{l?window.siyuan.config.sync.s3=o.data.s3:window.siyuan.config.sync.webdav=o.data.webdav,en.element.querySelector("#syncProviderPanel").innerHTML=wy(window.siyuan.config.sync.provider),vy(),de(window.siyuan.languages.imported),t.value=""})});const e=en.element.querySelector("#reposData"),n=en.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(as("")){n.classList.add("fn__none");let s=e;for(;s;)s.classList.add("fn__none"),s=s.nextElementSibling;return}A("/api/cloud/getCloudSpace",{},s=>{if(n.classList.add("fn__none"),s.code===1){e.innerHTML=s.msg;return}else e.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${s.data.sync?s.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${s.data.backup?s.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Fn("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${s.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${s.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${s.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Fn("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${s.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),e.classList.remove("fn__none");return}n.classList.add("fn__none");let a=e.nextElementSibling;for(;a;)ny()?a.classList.remove("fn__none"):a.classList.add("fn__none"),a=a.nextElementSibling;e.classList.add("fn__none");const i=en.element.querySelector("#syncProviderPanel");i.querySelectorAll(".b3-text-field, .b3-select").forEach(s=>{s.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let l=parseInt(i.querySelector("#timeout").value,10);7>l&&(1>l?l=30:l=7),300<l&&(l=300);let o=parseInt(i.querySelector("#s3ConcurrentReqs").value,10);1>o&&(o=1),16<o&&(o=16),i.querySelector("#timeout").value=l.toString();let r=i.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const c={endpoint:r,accessKey:i.querySelector("#accessKey").value.trim(),secretKey:i.querySelector("#secretKey").value.trim(),bucket:i.querySelector("#bucket").value.trim(),pathStyle:i.querySelector("#pathStyle").value==="true",region:i.querySelector("#region").value.trim(),skipTlsVerify:i.querySelector("#s3SkipTlsVerify").value==="true",timeout:l,concurrentReqs:o};A("/api/sync/setSyncProviderS3",{s3:c},()=>{window.siyuan.config.sync.s3=c})}else if(window.siyuan.config.sync.provider===3){let l=parseInt(i.querySelector("#timeout").value,10);7>l&&(l=7),300<l&&(l=300);let o=parseInt(i.querySelector("#webdavConcurrentReqs").value,10);1>o&&(o=1),16<o&&(o=16),i.querySelector("#timeout").value=l.toString();let r=i.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const c={endpoint:r,username:i.querySelector("#username").value.trim(),password:i.querySelector("#password").value.trim(),skipTlsVerify:i.querySelector("#webdavSkipTlsVerify").value==="true",timeout:l,concurrentReqs:o};A("/api/sync/setSyncProviderWebDAV",{webdav:c},()=>{window.siyuan.config.sync.webdav=c})}else if(window.siyuan.config.sync.provider===4){let l=parseInt(i.querySelector("#timeout").value,10);7>l&&(l=7),300<l&&(l=300);let o=parseInt(i.querySelector("#localConcurrentReqs").value,10);1>o&&(o=1),1024<o&&(o=1024),i.querySelector("#timeout").value=l.toString();const r={endpoint:i.querySelector("#endpoint").value,timeout:l,concurrentReqs:o};A("/api/sync/setSyncProviderLocal",{local:r},c=>{if(c.code===0){window.siyuan.config.sync.local=c.data.local;const d=i.querySelector("#endpoint");d&&(d.value=c.data.local.endpoint)}else window.siyuan.config.sync.local=r})}})})},en={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
        <option value="4" ${window.siyuan.config.sync.provider===4?"selected":""}>${window.siyuan.languages.localFileSystem}</option>
    </select>
</div>
<div id="syncProviderPanel" class="b3-label">
    ${wy(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </div>
    <div class="fn__flex b3-label${window.siyuan.config.sync.mode!==1?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncInterval}
            <div class="b3-label__text">${window.siyuan.languages.syncIntervalTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="number" min="30" max="43200" id="syncInterval" class="b3-text-field fn__flex-center" value="${window.siyuan.config.sync.interval}" >
        <span class="fn__space"></span>        
        <span class="fn__flex-center ft__on-surface">${window.siyuan.languages.second}</span> 
    </div>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudSyncDir}
            <div class="b3-label__text">${window.siyuan.languages.cloudSyncDirTip}</div>
        </div>
        <div class="fn__space"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-action="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{vy();const t=en.element.querySelector("#reposCloudSyncSwitch");t.addEventListener("change",()=>{if(t.checked&&window.siyuan.config.sync.cloudName===""){t.checked=!1,de(window.siyuan.languages._kernel[123]);return}A("/api/sync/setSyncEnable",{enabled:t.checked},()=>{window.siyuan.config.sync.enabled=t.checked,gi()})});const e=en.element.querySelector("#syncInterval");e.addEventListener("change",()=>{let r=parseInt(e.value);30>r&&(r=30),43200<r&&(r=43200),e.value=r.toString(),A("/api/sync/setSyncInterval",{interval:r},()=>{window.siyuan.config.sync.interval=r,gi()})});const n=en.element.querySelector("#syncPerception");n.addEventListener("change",()=>{A("/api/sync/setSyncPerception",{enabled:n.checked},()=>{window.siyuan.config.sync.perception=n.checked,gi()})});const a=en.element.querySelector("#generateConflictDoc");a.addEventListener("change",()=>{A("/api/sync/setSyncGenerateConflictDoc",{enabled:a.checked},()=>{window.siyuan.config.sync.generateConflictDoc=a.checked})});const i=en.element.querySelector("#syncMode");i.addEventListener("change",()=>{A("/api/sync/setSyncMode",{mode:parseInt(i.value,10)},()=>{i.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?n.parentElement.classList.remove("fn__none"):n.parentElement.classList.add("fn__none"),i.value==="1"?e.parentElement.classList.remove("fn__none"):e.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(i.value,10)})});const s=en.element.querySelector("#reposCloudSyncList"),l=en.element.querySelector("#syncProvider");l.addEventListener("change",()=>{A("/api/sync/setSyncProvider",{provider:parseInt(l.value,10)},r=>{r.code===1?(de(r.msg),l.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(l.value,10),en.element.querySelector("#syncProviderPanel").innerHTML=wy(window.siyuan.config.sync.provider),vy(),s.innerHTML="",s.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?n.parentElement.classList.add("fn__none"):n.parentElement.classList.remove("fn__none"),window.siyuan.config.sync.mode!==1?e.parentElement.classList.add("fn__none"):e.parentElement.classList.remove("fn__none")})});const o=en.element.querySelector("#reposLoading");o.style.width=en.element.clientWidth+"px",o.style.height=en.element.clientHeight+"px",hS(s),en.element.firstElementChild.addEventListener("click",r=>{let c=r.target;for(;c&&c!==en.element;){const d=c.getAttribute("data-action");if(d==="config"){s.classList.contains("fn__none")?(_d(s,!0),s.classList.remove("fn__none")):s.classList.add("fn__none");break}else if(d==="togglePassword"){const u=c.firstElementChild.getAttribute("xlink:href")==="#iconEye";c.firstElementChild.setAttribute("xlink:href",u?"#iconEyeoff":"#iconEye"),c.previousElementSibling.setAttribute("type",u?"text":"password");break}else if(d==="exportData"){A(c.getAttribute("data-type")==="s3"?"/api/sync/exportSyncProviderS3":"/api/sync/exportSyncProviderWebDAV",{},u=>{nn(u.data.zip)});break}else if(d==="purgeData"){Re("\u267B\uFE0F "+window.siyuan.languages.cloudStoragePurge,`<div class="b3-typography">${window.siyuan.languages.cloudStoragePurgeConfirm}</div>`,()=>{A("/api/repo/purgeCloudRepo")});break}c=c.parentElement}})}},R1=t=>{if(iy({code:2,msg:""}),t===0)document.querySelector('.config__tab-container[data-name="account"] #refresh').dispatchEvent(new Event("click"));else{let e="";switch(t){case-1:e="Invalid cloud region.";break;case-2:e="Server communication failed, need to retry.";break;case-3:e="Non-iOS device.";break;case-4:e="Account not logged in.";break;case-5:e="Account status abnormal.";break;case-6:e="Parameter error.";break;case-7:e="AccountToken verification failed.";break;case-8:e="Transaction verification failed.";break;case-9:e="Unknown product.";break;case-10:e="User canceled the transaction.";break;case-11:e="Purchase transaction was suspended.";break;case-12:e="Purchase failed.";break}de(e,0,"error")}},q1=t=>{window.siyuan.user?A("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},e=>{if(window.siyuan.user.userSiYuanOneTimePayStatus!==e.data.userSiYuanOneTimePayStatus||window.siyuan.user.userSiYuanProExpireTime!==e.data.userSiYuanProExpireTime||window.siyuan.user.userSiYuanSubscriptionPlan!==e.data.userSiYuanSubscriptionPlan||window.siyuan.user.userSiYuanSubscriptionType!==e.data.userSiYuanSubscriptionType||window.siyuan.user.userSiYuanSubscriptionStatus!==e.data.userSiYuanSubscriptionStatus){de(window.siyuan.languages._kernel[19]);return}window.siyuan.user=e.data;let n;window.siyuan.config.cloudRegion===0?n=t==="function"?"china00":"china02":n=t==="function"?"00":"02",window.webkit.messageHandlers.purchase.postMessage(`${n} ${ee().substring(0,19)}${window.siyuan.config.cloudRegion}00${window.siyuan.user.userId.substring(0,1)}-${window.siyuan.user.userId.substring(1)}`),iy({code:1,msg:""})}):de(window.siyuan.languages.needLogin)},Ey=t=>{const e=document.cookie.split(";");for(let n of e){const[a,i]=n.trim().split("=");if(a===t)return i}return null},hr=()=>{let t="";const e=[];return document.querySelectorAll("body > svg > defs > symbol").forEach(n=>{e.push(n.id)}),Array.from({length:45},()=>{const n=Math.floor(Math.random()*e.length);t+=`<svg><use xlink:href="#${e[n]}"></use></svg>`,e.splice(n,1)}),`<div class="fn__flex config-account__svg">${t}</div>`},tn={element:void 0,genHTML:(t=!1)=>{var e,n;const a=$n();let i;if(a?((e=window.siyuan.user)==null?void 0:e.userSiYuanOneTimePayStatus)===1?i=`<button class="b3-button b3-button--big" data-action="iOSPay" data-type="subscribe">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account4}
</button>`:i=`<button class="b3-button b3-button--big" data-action="iOSPay" data-type="subscribe">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}
</button>
<div class="fn__hr"></div>
<button class="b3-button b3-button--success" data-action="iOSPay" data-type="function">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}
</button>`:i=`<a class="b3-button b3-button--big" href="${cS("pricing.html")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages[((n=window.siyuan.user)==null?void 0:n.userSiYuanOneTimePayStatus)===1?"account4":"account1"]}
</a>`,i+=`<div class="fn__hr--b"></div>
<span class="b3-chip b3-chip--primary b3-chip--hover${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}" id="trialSub">
    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>
    ${window.siyuan.languages.freeSub}
</span>
<div class="fn__hr${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}"></div>
<a href="${Fn("sponsor")}" target="_blank" class="${a?"fn__none ":""}b3-chip b3-chip--pink b3-chip--hover">
    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>
    ${window.siyuan.languages.sponsor}
</a>
<div class="fn__hr--b"></div>
<div class="fn__flex-1"></div>
<div>
${window.siyuan.languages.accountSupport1}
</div>
<div class="fn__hr--b"></div>
<div>
${window.siyuan.languages.accountSupport2}
</div>`,t)return`<div class="fn__flex-1 fn__hr--b"></div>
${hr()}
<div class="fn__flex-1 fn__hr--b"></div>    
${i}
<div class="fn__flex-1 fn__hr--b"></div>
${hr()}
<div class="fn__flex-1 fn__hr--b"></div>`;if(localStorage.getItem("siyuan_token")||Ey("siyuan_token")){let l=null;try{const o=localStorage.getItem("siyuan_user");o&&(l=JSON.parse(o))}catch(o){console.error("Failed to parse web user data:",o)}if(l)return`<div class="fn__flex config-account">
<div class="config-account__center">
    <div class="config-account__bg">
        <div class="config-account__cover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
        <div class="config-account__avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: bold;">
            ${l.username?l.username.charAt(0).toUpperCase():"U"}
        </div>
        <h1 class="config-account__name">
            <span class="fn__a">${l.username||"Unknown"}</span>
            <span class="ft__on-surface ft__smaller">\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1</span>
        </h1>
    </div>
    <div class="config-account__info">
        <div class="fn__flex">
            <button class="b3-button b3-button--text" id="refreshWebProfile">\u5237\u65B0\u4FE1\u606F</button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel" id="logoutWeb">
                ${window.siyuan.languages.logout}
            </button>
            <span class="fn__flex-1"></span>
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-label">
            <div class="b3-label__text">\u7528\u6237\u540D</div>
            <div class="fn__hr"></div>
            <div class="ft__on-surface">${l.username||"N/A"}</div>
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-label">
            <div class="b3-label__text">\u90AE\u7BB1</div>
            <div class="fn__hr"></div>
            <div class="ft__on-surface">${l.email||"N/A"}</div>
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-label">
            <div class="b3-label__text">\u5DE5\u4F5C\u7A7A\u95F4</div>
            <div class="fn__hr"></div>
            <div class="ft__on-surface" style="font-family: monospace; font-size: 12px; word-break: break-all;">${l.workspace||"N/A"}</div>
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-label">
            <div class="b3-label__text">\u8BA4\u8BC1\u65B9\u5F0F</div>
            <div class="fn__hr"></div>
            <div><span class="b3-chip b3-chip--primary">\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1</span></div>
        </div>
    </div>
</div>
<div class="config-account__center config-account__center--text">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${hr()}
    <div class="fn__flex-1 fn__hr--b"></div>
    <div class="b3-label">
        <div class="b3-label__text">\u5173\u4E8E\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1</div>
        <div class="fn__hr"></div>
        <div class="ft__on-surface ft__smaller" style="line-height: 1.6;">
            \u60A8\u7684\u8D26\u6237\u7531<strong>\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1</strong>\u7BA1\u7406\uFF0C\u53EF\u4EE5\u5728\u591A\u4E2A\u5E94\u7528\uFF08\u601D\u6E90\u7B14\u8BB0\u3001\u667A\u80FD\u65E5\u5386\u7B49\uFF09\u4E4B\u95F4\u5171\u4EAB\u3002
            \u9000\u51FA\u767B\u5F55\u540E\uFF0C\u60A8\u53EF\u4EE5\u5207\u6362\u5230\u5176\u4ED6\u8D26\u6237\u767B\u5F55\u3002
        </div>
    </div>
    <div class="fn__flex-1 fn__hr--b"></div>
    ${hr()}
    <div class="fn__flex-1 fn__hr--b"></div>
</div>
</div>`}if(window.siyuan.user){let l="";window.siyuan.user.userTitles.length>0&&(l='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(c=>{l+=`<div class="b3-chip b3-chip--middle b3-chip--primary">${c.icon} ${c.name}</div>`}),l+="</div>");let o="",r=a?"":`<div class="b3-form__icon fn__block">
   <svg class="ft__secondary b3-form__icon-icon"><use xlink:href="#iconVIP"></use></svg>
   <input class="b3-text-field fn__block b3-form__icon-input" style="padding-right: 44px;" placeholder="${window.siyuan.languages.activationCodePlaceholder}">
   <button id="activationCode" class="b3-button b3-button--text" style="position: absolute;right: 0;top: 0;">${window.siyuan.languages.confirm}</button>
</div>`;if(window.siyuan.user.userSiYuanProExpireTime===-1)r="",o=`<div class="b3-chip b3-chip--secondary">${p.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`;else if(window.siyuan.user.userSiYuanProExpireTime>0){const c=`<div class="fn__hr--b"></div>
<div class="ft__on-surface ft__smaller">
    ${window.siyuan.languages.account6} 
    ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-new Date().getTime())/1e3/60/60/24))} 
    ${window.siyuan.languages.day} 
    ${a?`<a href="javascript:void(0)" data-action="iOSPay" data-type="subscribe">${window.siyuan.languages.clickMeToRenew}</a>`:`<a href="${Fn("subscribe/siyuan")}" target="_blank">${window.siyuan.languages.clickMeToRenew}</a>`}
</div>`;window.siyuan.user.userSiYuanOneTimePayStatus===1&&(o=`<div class="b3-chip b3-chip--success"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account7}</div>
<div class="fn__hr--b"></div>`),window.siyuan.user.userSiYuanSubscriptionPlan===2?o+=`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>
${c}<div class="fn__hr--b"></div>`:o+=`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account8}</div>
${c}<div class="fn__hr--b"></div>`,window.siyuan.user.userSiYuanOneTimePayStatus===0&&(o+=a?`<button class="b3-button b3-button--success" data-action="iOSPay" data-type="function">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}
</button>`:`<a class="b3-button b3-button--success" href="${cS("pricing.html")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}
</a>`)}else window.siyuan.user.userSiYuanOneTimePayStatus===1?o=`<div class="b3-chip b3-chip--success"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account7}</div>
<div class="fn__hr--b"></div>${i}`:o=i;return`<div class="fn__flex config-account">
<div class="config-account__center">
    <div class="config-account__bg">
        <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
        <a href="${Fn("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
        <h1 class="config-account__name">
            <a target="_blank" class="fn__a" href="${Fn("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
            <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
        </h1>
        ${l}
    </div>
    <div class="config-account__info">
        <div class="fn__flex">
            <a class="b3-button b3-button--text${a?" fn__none":""}" href="${Fn("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
            <span class="fn__space${a?" fn__none":""}"></span>
            <button class="b3-button b3-button--cancel" id="logout">
                ${window.siyuan.languages.logout}
            </button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?"":" fn__none"}" id="deactivateUser">
                ${window.siyuan.languages.deactivateUser}
            </button>
            <span class="fn__flex-1"></span>
            <button class="b3-button b3-button--cancel b3-tooltips b3-tooltips__n" id="refresh" aria-label="${window.siyuan.languages.refresh}">
                <svg style="margin-right: 0"><use xlink:href="#iconRefresh"></use></svg>
            </button>
        </div>
        <div class="fn__hr--b"></div>
        <div class="fn__flex">  
            <label>
                ${window.siyuan.languages.accountDisplayTitle}
                <input class="b3-switch fn__flex-center" id="displayTitle" type="checkbox"${window.siyuan.config.account.displayTitle?" checked":""}/>
            </label>
            <div class="fn__flex-1"></div>
            <label>
                ${window.siyuan.languages.accountDisplayVIP}
                <input class="b3-switch fn__flex-center" id="displayVIP" type="checkbox"${window.siyuan.config.account.displayVIP?" checked":""}/>
            </label>
        </div>
    </div>
</div>
<div class="config-account__center config-account__center--text">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${o}
    <div class="fn__flex-1 fn__hr--b"></div>
    ${r}
</div></div>`}return`<div class="fn__flex config-account">
<div class="config-account__center">
    <div class="config-account__bg" style="padding: 60px 40px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">\u{1F510}</div>
        <h2 style="color: #333; margin-bottom: 16px;">\u8BF7\u5148\u767B\u5F55</h2>
        <p style="color: #666; line-height: 1.6; margin-bottom: 24px;">
            \u60A8\u9700\u8981\u4F7F\u7528\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1\u8D26\u6237\u767B\u5F55\u540E\u624D\u80FD\u67E5\u770B\u8D26\u6237\u4FE1\u606F\u3002
        </p>
        <button class="b3-button b3-button--outline" onclick="window.location.href='/stage/login.html'" style="padding: 12px 32px;">
            \u524D\u5F80\u767B\u5F55
        </button>
    </div>
</div>
<div class="config-account__center config-account__center--text">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${hr()}
    <div class="fn__flex-1 fn__hr--b"></div>
    <div class="b3-label">
        <div class="b3-label__text">\u5173\u4E8E\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1</div>
        <div class="fn__hr"></div>
        <div class="ft__on-surface ft__smaller" style="line-height: 1.6;">
            \u601D\u6E90\u7B14\u8BB0\u73B0\u5728\u4F7F\u7528<strong>\u7EDF\u4E00\u6CE8\u518C\u670D\u52A1</strong>\u8FDB\u884C\u8D26\u6237\u7BA1\u7406\u3002<br>
            \u60A8\u53EF\u4EE5\u4F7F\u7528\u540C\u4E00\u4E2A\u8D26\u6237\u767B\u5F55\u591A\u4E2A\u5E94\u7528\uFF08\u601D\u6E90\u7B14\u8BB0\u3001\u667A\u80FD\u65E5\u5386\u7B49\uFF09\u3002
        </div>
    </div>
    <div class="fn__flex-1 fn__hr--b"></div>
    ${hr()}
    <div class="fn__flex-1 fn__hr--b"></div>
</div>
</div>`},bindEvent:t=>{const e=t.querySelector("#logoutWeb");e&&e.addEventListener("click",()=>{if(!confirm(`\u786E\u5B9A\u8981\u9000\u51FA\u767B\u5F55\u5417\uFF1F

\u9000\u51FA\u540E\u60A8\u53EF\u4EE5\u5207\u6362\u5230\u5176\u4ED6\u8D26\u6237\u767B\u5F55\u3002`))return;(localStorage.getItem("siyuan_token")||Ey("siyuan_token"))&&A("/api/web/auth/logout",{},()=>{localStorage.removeItem("siyuan_token"),localStorage.removeItem("siyuan_user"),document.cookie="siyuan_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",de("\u5DF2\u9000\u51FA\u767B\u5F55",3e3),setTimeout(()=>{window.location.href="/stage/login.html"},1e3)})});const n=t.querySelector("#refreshWebProfile");n&&n.addEventListener("click",()=>{(localStorage.getItem("siyuan_token")||Ey("siyuan_token"))&&A("/api/web/auth/profile",{},b=>{b.code===0&&b.data&&(localStorage.setItem("siyuan_user",JSON.stringify(b.data)),t.innerHTML=tn.genHTML(),tn.bindEvent(t),de("\u8D26\u6237\u4FE1\u606F\u5DF2\u5237\u65B0",3e3))})}),t.querySelectorAll('[data-action="iOSPay"]').forEach(h=>{h.addEventListener("click",()=>{q1(h.getAttribute("data-type"))})});const a=t.querySelector("#trialSub");a&&a.addEventListener("click",()=>{A("/api/account/startFreeTrial",{},()=>{t.querySelector("#refresh").dispatchEvent(new Event("click"))})});const i=t.querySelector("#agreeLogin"),s=t.querySelector("#userName");if(!s){const h=t.querySelector("#refresh");h.addEventListener("click",()=>{const y=h.firstElementChild;y.classList.contains("fn__rotate")||(y.classList.add("fn__rotate"),A("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},w=>{window.siyuan.user=w.data,t.innerHTML=tn.genHTML(),tn.bindEvent(t),de(window.siyuan.languages.refreshUser,3e3),tn.onSetaccount(),gi()}))}),t.querySelector("#logout").addEventListener("click",()=>{A("/api/setting/logoutCloudUser",{},()=>{A("/api/setting/getCloudUser",{},y=>{window.siyuan.user=y.data,t.innerHTML=tn.genHTML(),tn.bindEvent(t),tn.onSetaccount(),gi()})})}),t.querySelector("#deactivateUser").addEventListener(bc(),()=>{Re("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{A("/api/account/deactivate",{},()=>{window.siyuan.user=null,t.innerHTML=tn.genHTML(),tn.bindEvent(t),tn.onSetaccount(),gi()})})}),t.querySelectorAll("input[type='checkbox']").forEach(y=>{y.addEventListener("change",()=>{A("/api/setting/setAccount",{displayTitle:t.querySelector("#displayTitle").checked,displayVIP:t.querySelector("#displayVIP").checked},w=>{window.siyuan.config.account.displayTitle=w.data.displayTitle,window.siyuan.config.account.displayVIP=w.data.displayVIP,tn.onSetaccount()})})});const b=t.querySelector("#activationCode");b==null||b.addEventListener("click",()=>{const y=b.previousElementSibling;A("/api/account/checkActivationcode",{data:y.value},w=>{w.code!==0&&(y.value=""),Re(window.siyuan.languages.activationCode,w.msg,()=>{w.code===0&&A("/api/account/useActivationcode",{data:b.previousElementSibling.value},()=>{h.dispatchEvent(new CustomEvent("click"))})})})});return}const l=t.querySelector("#userPassword"),o=t.querySelector("#captchaImg"),r=t.querySelector("#captcha"),c=t.querySelector("#twofactorAuthCode"),d=t.querySelector("#login"),u=t.querySelector("#login2");i.addEventListener("click",()=>{i.checked?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled")}),s.focus(),s.addEventListener("keydown",h=>{if(h.isComposing){h.preventDefault();return}h.key==="Enter"&&(d.click(),h.preventDefault())}),c.addEventListener("keydown",h=>{if(h.isComposing){h.preventDefault();return}h.key==="Enter"&&(u.click(),h.preventDefault())}),r.addEventListener("keydown",h=>{if(h.isComposing){h.preventDefault();return}h.key==="Enter"&&(d.click(),h.preventDefault())}),l.addEventListener("keydown",h=>{if(h.isComposing){h.preventDefault();return}h.key==="Enter"&&(d.click(),h.preventDefault())});let m,f;o.addEventListener("click",()=>{o.setAttribute("src",Fn("captcha")+`/login?needCaptcha=${f}&t=${new Date().getTime()}`)});const g=t.querySelector("#cloudRegion");g.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(g.value),t.querySelector(".config-account__center--text").innerHTML=tn.genHTML(!0),t.querySelector("#form1").lastElementChild.innerHTML=`<a href="${Fn("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
<span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
<a href="${Fn("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),d.addEventListener("click",()=>{A("/api/account/login",{userName:s.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:B1(l.value),captcha:r.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},h=>{let b;if(h.code===1){if(b=de(h.msg),h.data.needCaptcha){f=h.data.needCaptcha,r.parentElement.classList.remove("fn__none"),r.previousElementSibling.setAttribute("src",Fn("captcha")+`/login?needCaptcha=${h.data.needCaptcha}`),r.value="";return}return}if(h.code===10){t.querySelector("#form1").classList.add("fn__none"),t.querySelector("#form2").classList.remove("fn__none"),c.focus(),m=h.data.token;return}At(b),A("/api/setting/getCloudUser",{token:h.data.token},y=>{tn._afterLogin(y,t)})})}),u.addEventListener("click",()=>{A("/api/setting/login2faCloudUser",{code:c.value,token:m},h=>{A("/api/setting/getCloudUser",{token:h.data.token},b=>{tn._afterLogin(b,t)})})})},_afterLogin(t,e){if(window.siyuan.user=t.data,gi(),e.innerHTML=tn.genHTML(),tn.bindEvent(e),tn.onSetaccount(),e.getAttribute("data-action")==="go-repos")if(as("")&&window.siyuan.config.sync.provider===0){const n=T(e,"b3-dialog--open");n&&(n.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")),e.removeAttribute("data-action"))}else ce(["dialog"]),ig()},onSetaccount(){en.element&&(en.element.innerHTML="")}},lg=(t,e,n)=>{t.plugins.find((a,i)=>{var s,l;if(a.name===e){try{a.onunload()}catch(c){console.error(`plugin ${a.name} onunload error:`,c)}if(n){try{a.uninstall()}catch(c){console.error(`plugin ${a.name} uninstall error:`,c)}window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][a.name]={},Ee(p.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS])}const o=Object.keys(a.models);Oe().custom.forEach(c=>{o.includes(c.type)&&c.parent.parent.removeTab(c.parent.id)});for(let c=0;c<a.topBarIcons.length;c++)a.topBarIcons[c].remove(),a.topBarIcons.splice(c,1),c--;return Ed(),a.statusBarIcons.forEach(c=>{c.remove()}),Object.keys(a.docks).forEach(c=>{Object.keys(window.siyuan.layout.leftDock.data).includes(c)?window.siyuan.layout.leftDock.remove(c):Object.keys(window.siyuan.layout.rightDock.data).includes(c)?window.siyuan.layout.rightDock.remove(c):Object.keys(window.siyuan.layout.bottomDock.data).includes(c)&&window.siyuan.layout.bottomDock.remove(c)}),Array.from(document.childNodes).find(c=>{if(c.nodeType===8&&c.textContent===e)return c.remove(),!0}),t.plugins.splice(i,1),(s=document.querySelector(`svg[data-name="${a.name}"]`))==null||s.remove(),qn().forEach(c=>{c.protyle.toolbar.update(c.protyle)}),(l=document.getElementById("pluginsStyle"+e))==null||l.remove(),!0}})};var ky=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Ce={element:void 0,genHTML(){if(!window.siyuan.config.bazaar.trust)return`<div class="fn__flex-column">
<div class="fn__flex-1"></div>
<div class="b3-label">
    <div>${window.siyuan.languages.bazaarTrust}</div>
    <div class="fn__hr--b"></div>
    <div>${window.siyuan.languages.bazaarTrust3}</div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconEye"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustCodeReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustCodeReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconGithub"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustOpenSource}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustOpenSourceTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconUsers"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarCommunityReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarPeerReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconInfo"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarUserReport}
        <div class="b3-label__text">${window.siyuan.languages.bazaarUserReportTip}</div>
    </div>
</div>
<div class="b3-label b3-label--noborder">
    <div>${window.siyuan.languages.bazaarTrust1}</div>
    <div class="fn__hr--b"></div>
    <diiv>${window.siyuan.languages.bazaarTrust2}</diiv>
</div>
<div class="ft__center b3-label b3-label--noborder">
    <button class="b3-button fn__size200">${window.siyuan.languages.trust}</button>
</div>
<div class="fn__flex-1"></div>
</div>`;const t=window.siyuan.storage[p.LOCAL_BAZAAR],e=`<div style="height: ${Ce.element.clientHeight-80}px;display: flex;align-items: center;justify-content: center;"><img src="/stage/loading-pure.svg"></div>`;return`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="downloaded" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.downloaded}</span><span class="fn__flex-1"></span></div>
    <div data-type="plugin" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.plugin}</span><span class="fn__flex-1"></span></div>
    <div data-type="theme" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.theme}</span><span class="fn__flex-1"></span></div>
    <div data-type="icon" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.icon}</span><span class="fn__flex-1"></span></div>
    <div data-type="template" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.template}</span><span class="fn__flex-1"></span></div>
    <div data-type="widget" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.widget}</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div class="config-bazaar__panel" data-type="downloaded" data-init="true">
        <div data-type="downloaded-update"></div>
        <div class="fn__flex config-bazaar__title">
            <button data-type="myPlugin" class="b3-button">${window.siyuan.languages.plugin}</button>
            <div class="fn__space"></div>
            <button data-type="myTheme" class="b3-button b3-button--outline">${window.siyuan.languages.theme}</button>
            <div class="fn__space"></div>
            <button data-type="myIcon" class="b3-button b3-button--outline">${window.siyuan.languages.icon}</button>
            <div class="fn__space"></div>
            <button data-type="myTemplate" class="b3-button b3-button--outline">${window.siyuan.languages.template}</button>
            <div class="fn__space"></div>
            <button data-type="myWidget" class="b3-button b3-button--outline">${window.siyuan.languages.widget}</button>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <input ${window.siyuan.config.bazaar.petalDisabled?"":" checked"} data-type="plugins-enable" type="checkbox" class="b3-switch fn__flex-center" style="margin-right: 8px">
            <div class="counter counter--bg fn__none fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarDownloaded" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div data-type="theme" class="config-bazaar__panel fn__none">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.theme==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.theme==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.theme==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.theme==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <select id="bazaarSelect" class="b3-select">
                <option selected value="2">${window.siyuan.languages.all}</option>
                <option value="0">${window.siyuan.languages.themeLight}</option>
                <option value="1">${window.siyuan.languages.themeDark}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarTheme" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="template">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.template==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.template==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.template==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.template==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarTemplate" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="plugin">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.plugin==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.plugin==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.plugin==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.plugin==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarPlugin" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="icon">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.icon==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.icon==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.icon==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.icon==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarIcon" class="config-bazaar__content">
            ${e}
        </div>
    </div>
    <div class="fn__none config-bazaar__panel" data-type="widget">
        <div class="fn__flex config-bazaar__title">
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.widget==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.widget==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.widget==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.widget==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter counter--bg fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}"></div>
        </div>
        <div id="configBazaarWidget" class="config-bazaar__content">
            ${e}
        </div>
    </div>
</div>
<div id="configBazaarReadme" class="config-bazaar__readme"></div>
</div>`},_genCardHTML(t,e){let n=!1,a="";if(e==="themes"){const l=Ce.element.querySelector("#bazaarSelect").value;(l==="0"&&t.modes.includes("dark")||l==="1"&&t.modes.includes("light"))&&(n=!0),a=t.modes.toString()}let i=!1;["icons","themes"].includes(e)&&(i=!0);const s={bazaarType:e,themeMode:a,updated:t.updated,name:t.name,repoURL:t.repoURL,repoHash:t.repoHash,downloads:t.downloads,downloaded:!1};return`<div data-obj='${JSON.stringify(s)}' class="b3-card b3-card--wrap${n?" fn__none":""}${t.current?" b3-card--current":""}">
    <div class="b3-card__img">
        <img src="${t.iconURL}" onerror="this.src='/stage/images/icon.png'"/>
    </div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info fn__flex-1">
            ${t.preferredName} <span class="ft__on-surface ft__smaller">${t.name}</span>
            <div class="b3-card__desc" title="${at(t.preferredDesc)||""}">
                ${t.preferredDesc||""}
            </div>
        </div>
        <div class="b3-card__actions">
            <span class="block__icon block__icon--show ft__primary">
                <svg><use xlink:href="#iconDownload"></use></svg>
                <span class="fn__space"></span>
                ${t.downloads}
            </span>
            <span class="fn__space"></span>
            ${t.preferredFunding?`<a target="_blank" href="${t.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${t.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a><span class="fn__space"></span>`:""}
            <div class="fn__flex-1"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${t.installed?"":" fn__none"}" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
                <svg><use xlink:href="#iconTrashcan"></use></svg>
            </span>
            <div class="fn__space${!t.current&&t.installed&&i?"":" fn__none"}"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!t.current&&t.installed&&i?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
                <svg><use xlink:href="#iconSelect"></use></svg>
            </span>
            <div class="fn__space${t.outdated?"":" fn__none"}"></div>
            <span data-type="install-t" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${t.outdated?"":" fn__none"}" aria-label="${window.siyuan.languages.update}">
                <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
            </span>
        </div>
    </div>
</div>`},_genUpdateItemHTML(t,e){var n;const a={bazaarType:e,themeMode:(n=t.modes)==null?void 0:n.toString(),updated:t.updated,name:t.name,repoURL:t.repoURL,repoHash:t.repoHash,downloaded:!0};return`<div class="b3-card" data-obj='${JSON.stringify(a)}'>
    <div class="b3-card__img"><img src="${t.iconURL}" onerror="this.src='/stage/images/icon.png'"/></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info b3-card__info--left fn__flex-1">
            ${t.preferredName} <span class="ft__on-surface ft__smaller">${t.name}</span>
            <div class="b3-card__desc" title="${at(t.preferredDesc)||""}">${t.preferredDesc||""}</div>
        </div>
    </div>
    <div class="b3-card__actions b3-card__actions--right">
        ${t.incompatible?`<span class="fn__space"></span><span class="fn__flex-center b3-tooltips b3-tooltips__nw b3-chip b3-chip--error b3-chip--small" aria-label="${window.siyuan.languages.incompatiblePluginTip}">${window.siyuan.languages.incompatible}</span>`:""}
        ${t.preferredFunding?`<a target="_blank" href="${t.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${t.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:""}
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${Ne()?" fn__none":""}" data-type="open" aria-label="${window.siyuan.languages.showInFolder}">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span data-type="install-t" aria-label="${window.siyuan.languages.update}" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show">
            <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
        </span>
    </div>
</div>`},_getUpdate(){A("/api/bazaar/getUpdatedPackage",{frontend:ie()},t=>{let e="";t.data.plugins.forEach(a=>{e+=this._genUpdateItemHTML(a,"plugins")}),t.data.themes.forEach(a=>{e+=this._genUpdateItemHTML(a,"themes")}),t.data.icons.forEach(a=>{e+=this._genUpdateItemHTML(a,"icons")}),t.data.templates.forEach(a=>{e+=this._genUpdateItemHTML(a,"templates")}),t.data.widgets.forEach(a=>{e+=this._genUpdateItemHTML(a,"widgets")}),this._data.update=t.data;const n=t.data.themes.length+t.data.icons.length+t.data.widgets.length+t.data.plugins.length+t.data.templates.length;if(n===0){this.element.querySelector('[data-type="downloaded-update"]').innerHTML="";return}this.element.querySelector('[data-type="downloaded-update"]').innerHTML=`<div class="fn__flex config-bazaar__title">
    <div class="fn__flex-1"></div>
    <button class="b3-button" data-type="install-all">${window.siyuan.languages.updateAll}</button>
    <span class="fn__space"></span>
    <div class="counter counter--bg fn__flex-center">${n}</div>
</div>
<div class="config-bazaar__content">${e}</div>`})},_genMyHTML(t,e,n=!0){var a;n&&this._getUpdate();const i=Ce.element.querySelector("#configBazaarDownloaded");if(i.getAttribute("data-loading")==="true"||i.previousElementSibling.querySelector(`[data-type="my${t.replace(t[0],t[0].toUpperCase()).substring(0,t.length-1)}"]`).classList.contains("b3-button--outline"))return;i.setAttribute("data-loading","true");let s="/api/bazaar/getInstalledTheme";t==="icons"?s="/api/bazaar/getInstalledIcon":t==="widgets"?s="/api/bazaar/getInstalledWidget":t==="templates"?s="/api/bazaar/getInstalledTemplate":t==="plugins"&&(s="/api/bazaar/getInstalledPlugin"),A(s,{frontend:ie(),keyword:((a=i.previousElementSibling.querySelector(".b3-text-field"))==null?void 0:a.value)||""},l=>{i.removeAttribute("data-loading");let o="",r=!1;["icons","themes"].includes(t)&&(r=!0);const c=i.previousElementSibling.querySelector(".counter");l.data.packages.length===0?c.classList.add("fn__none"):(c.classList.remove("fn__none"),c.textContent=l.data.packages.length,l.data.packages.forEach(u=>{var m;const f={bazaarType:t,themeMode:(m=u.modes)==null?void 0:m.toString(),updated:u.updated,name:u.name,repoURL:u.repoURL,repoHash:u.repoHash,downloaded:!0};let g=!1;t==="plugins"&&e.plugins.find(h=>{if(h.name===f.name)return g=h.setting||h.__proto__.hasOwnProperty("openSetting"),!0}),o+=`<div data-obj='${JSON.stringify(f)}' class="b3-card${u.current?" b3-card--current":""}${window.siyuan.config.bazaar.petalDisabled&&t==="plugins"?" b3-card--disabled":""}">
    <div class="b3-card__img"><img src="${u.iconURL}" onerror="this.src='/stage/images/icon.png'"/></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info b3-card__info--left fn__flex-1">
            ${u.preferredName} <span class="ft__on-surface ft__smaller">${u.name}</span>
            <div class="b3-card__desc" title="${at(u.preferredDesc)||""}">${u.preferredDesc||""}</div>
        </div>
    </div>
    <div class="b3-card__actions b3-card__actions--right">
        ${u.incompatible?`<span class="fn__space"></span><span class="fn__flex-center b3-tooltips b3-tooltips__nw b3-chip b3-chip--error b3-chip--small" aria-label="${window.siyuan.languages.incompatiblePluginTip}">${window.siyuan.languages.incompatible}</span>`:""}
        ${u.preferredFunding?`<a target="_blank" href="${u.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${u.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:""}
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${g?"":" fn__none"}" data-type="setting" aria-label="${window.siyuan.languages.config}">
            <svg><use xlink:href="#iconSettings"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${Ne()?" fn__none":""}" data-type="open" aria-label="${window.siyuan.languages.showInFolder}">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!u.current&&r?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
            <svg><use xlink:href="#iconSelect"></use></svg>
        </span>
        <span data-type="install-t" aria-label="${window.siyuan.languages.update}" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${u.outdated?"":" fn__none"}">
            <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space${t==="plugins"?"":" fn__none"}"></span>
        <span class="fn__space${t==="plugins"?"":" fn__none"}"></span>
        <input class="b3-switch fn__flex-center${t==="plugins"?"":" fn__none"}" ${u.enabled?"checked":""} data-type="plugin-enable" type="checkbox" ${u.incompatible?" disabled":""}>
    </div>
</div>`})),Ce._data.downloaded=l.data.packages;const d=i.parentElement.querySelector(".b3-switch");t==="plugins"?d.classList.remove("fn__none"):d.classList.add("fn__none"),i.innerHTML=o||`<div class="fn__hr"></div><ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`})},_data:{themes:[],templates:[],icons:[],widgets:[],plugins:[],downloaded:[],update:{themes:[],templates:[],icons:[],widgets:[],plugins:[]}},_renderReadme(t,e,n){var a;const i=Ce.element.querySelector("#configBazaarReadme"),s=e.repoURL.split("/");s.pop();let l=window.siyuan.languages.icon;t==="themes"?l=window.siyuan.languages.theme:t==="widgets"?l=window.siyuan.languages.widget:t==="templates"?l=window.siyuan.languages.template:t==="plugins"&&(l=window.siyuan.languages.plugin);const o={bazaarType:t,themeMode:(a=e.modes)==null?void 0:a.toString(),name:e.name,repoURL:e.repoURL,repoHash:e.repoHash,downloaded:n};if(i.innerHTML=` <div class="item__side" data-obj='${JSON.stringify(o)}'>
    <div class="fn__flex">
        <div style="padding-right: 8px" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" data-type="goBack" aria-label="${window.siyuan.languages.back}">
            <svg><use xlink:href="#iconLeft"></use></svg>
            <span class="fn__space"></span>
            ${l}
        </div>
    </div>
    <img class="item__img" src="${e.iconURL}" onerror="this.src='/stage/images/icon.png'">
    <div>
        <a href="${e.repoURL}" target="_blank" class="item__title" title="GitHub Repo">${e.preferredName}</a>
    </div>
    <div class="fn__hr"></div>
    <div>
        <a href="${e.repoURL}" target="_blank" class="ft__on-surface ft__smaller" title="GitHub Repo">${e.name}</a>
    </div>
    <div class="block__icons">
        <span class="fn__flex-1"></span>
        ${e.preferredFunding?`<a target="_blank" href="${e.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${e.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:`<span class="b3-tooltips b3-tooltips__ne block__icon block__icon--show ft__primary" aria-label="${window.siyuan.languages.author}"><svg><use xlink:href="#iconAccount"></use></svg></span>`}
        <span class="fn__space"></span>
        <a href="${s.join("/")}" target="_blank" title="Creator">${e.author}</a>
        <span class="fn__flex-1"></span>
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${window.siyuan.languages.currentVer}<br>v${e.version}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${n?window.siyuan.languages.installDate:window.siyuan.languages.releaseDate}<br>${n?e.hInstallDate:e.hUpdated}</div>
    <div class="fn__hr${n?" fn__none":""}"></div>
    <div class="ft__on-surface ft__smaller${n?" fn__none":""}" style="line-height: 20px;">${window.siyuan.languages.pkgSize}<br>${e.hSize}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${window.siyuan.languages.installSize}<br>${e.hInstallSize}</div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div${e.installed||n?' class="fn__none"':""}>
        <button class="b3-button" style="width: 168px"  data-type="install">${window.siyuan.languages.download}</button>
    </div>
    <div${e.outdated&&(e.installed||n)?"":' class="fn__none"'}>
        <button class="b3-button" style="width: 168px" data-type="install-t">${window.siyuan.languages.update}</button>
    </div>
    <div class="fn__hr--b"></div>
    <div>
        <a href="${e.repoURL}/issues" target="_blank" title="Feedback via GitHub Issues" class="b3-button b3-button--success" style="width: 168px" data-type="feedback">${window.siyuan.languages.feedback}</a>
    </div>
    <div class="fn__hr--b${n?" fn__none":""}"></div>
    <div class="fn__hr--b${n?" fn__none":""}"></div>
    <div class="fn__flex${n?" fn__none":""}" style="justify-content: center;">
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGithub"></use></svg>
        <span class="fn__space"></span>
        <a href="${e.repoURL}" target="_blank" title="GitHub Repo">Repo</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconStar"></use></svg>
        <span class="fn__space"></span>
        <a href="${e.repoURL}/stargazers" target="_blank" title="Stars">${e.stars}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGitHubI"></use></svg>
        <span class="fn__space"></span>
        <a href="${e.repoURL}/issues" target="_blank" title="Open issues">${e.openIssues}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconDownload"></use></svg>
        <span class="fn__space"></span>
        ${e.downloads}
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__flex-1"></div>
</div>
<div class="item__main">
    <div class="item__preview" style="background-image: url(${e.previewURL})"></div>
    <div class="b3-typography${e.preferredDesc?"":" fn__none"}">
        <blockquote>
            <p>
                ${e.preferredDesc||""}
            </p>
         </blockquote>
    </div>
    <div class="item__readme b3-typography b3-typography--default">
        <img data-type="img-loading" style="height: 64px;width: 100%;padding: 16px 0;" src="/stage/loading-pure.svg">
    </div>
</div>`,n&&e.preferredReadme){const r=i.querySelector(".item__readme");r.innerHTML=e.preferredReadme,rt(r)}else A("/api/bazaar/getBazaarPackageREAME",{repoURL:e.repoURL,repoHash:e.repoHash,packageType:t},r=>{const c=i.querySelector(".item__readme");c.innerHTML=r.data.html,rt(c)});i.classList.add("config-bazaar__readme--show")},bindEvent(t){if(!window.siyuan.config.bazaar.trust){Ce.element.querySelector("button").addEventListener("click",()=>{A("/api/setting/setBazaar",{trust:!0,petalDisabled:window.siyuan.config.bazaar.petalDisabled},()=>{window.siyuan.config.bazaar.trust=!0,Ce.element.innerHTML=Ce.genHTML(),Ce.bindEvent(t)})});return}this._genMyHTML("plugins",t),Ce.element.firstElementChild.addEventListener("click",e=>{let n=e.target;const a=j(n,"data-obj",null);let i;for(a&&(i=JSON.parse(a.getAttribute("data-obj")));n&&!n.isEqualNode(Ce.element);){const s=n.getAttribute("data-type");if(n.tagName==="A")break;if(s==="open"&&i){e.preventDefault(),e.stopPropagation();break}else if(["myTheme","myTemplate","myIcon","myWidget","myPlugin"].includes(s)){n.classList.contains("b3-button--outline")&&!Ce.element.querySelector("#configBazaarDownloaded").getAttribute("data-loading")&&(n.parentElement.childNodes.forEach(l=>{l.nodeType!==3&&l.classList.contains("b3-button")&&l.classList.add("b3-button--outline")}),n.classList.remove("b3-button--outline"),this._genMyHTML(s.replace("my","").toLowerCase()+"s",t,!1)),e.preventDefault(),e.stopPropagation();break}else if(s==="goBack"){Ce.element.querySelector("#configBazaarReadme").classList.remove("config-bazaar__readme--show"),e.preventDefault(),e.stopPropagation();break}else if(s==="install"){if(!n.classList.contains("b3-button--progress")){const l=i.bazaarType;let o="/api/bazaar/installBazaarTemplate";l==="themes"?o="/api/bazaar/installBazaarTheme":l==="icons"?o="/api/bazaar/installBazaarIcon":l==="widgets"?o="/api/bazaar/installBazaarWidget":l==="plugins"&&(o="/api/bazaar/installBazaarPlugin"),A(o,{keyword:Ce.element.querySelector(".config-bazaar__panel:not(.fn__none) .b3-form__icon-input").value,repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,frontend:ie()},r=>ky(this,null,function*(){if(window.siyuan.config.appearance.themeJS&&l==="themes")if(window.destroyTheme){try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(c){console.error("destroyTheme error: "+c)}window.siyuan.config.appearance=r.data.appearance,Ip(window.siyuan.config.appearance)}else{Un({cb(){window.location.reload()},errorExit:!1});return}Ce._onBazaar(r,l,["themes","icons"].includes(l)),Ce._genMyHTML(l,t,!1),l==="plugins"&&(window.siyuan.config.bazaar.petalDisabled?Re(window.siyuan.languages.confirm,window.siyuan.languages.enablePluginTip2):Re("\u{1F4A1} "+window.siyuan.languages.enablePlugin,window.siyuan.languages.enablePluginTip,()=>{A("/api/petal/setPetalEnabled",{packageName:i.name,enabled:!0,frontend:ie(),app:p.SIYUAN_APPID},c=>{HS(t,c.data),Ce._genMyHTML(l,t,!1)})}))}))}e.preventDefault(),e.stopPropagation();break}else if(s==="install-all"){Re("\u2B06\uFE0F "+window.siyuan.languages.updateAll,window.siyuan.languages.confirmUpdateAll,()=>{A("/api/bazaar/batchUpdatePackage",{frontend:ie()})}),e.preventDefault(),e.stopPropagation();break}else if(s==="feedback"){e.preventDefault(),e.stopPropagation();break}else if(s==="install-t"){n.classList.contains("b3-button--progress")||Re("\u2B06\uFE0F "+window.siyuan.languages.update,window.siyuan.languages.confirmUpdate,()=>{const l=i.bazaarType;let o="/api/bazaar/installBazaarTemplate";l==="themes"?o="/api/bazaar/installBazaarTheme":l==="icons"?o="/api/bazaar/installBazaarIcon":l==="widgets"?o="/api/bazaar/installBazaarWidget":l==="plugins"&&(o="/api/bazaar/installBazaarPlugin"),n.classList.contains("b3-button")||n.parentElement.insertAdjacentHTML("afterend",'<img data-type="img-loading" style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 16px;box-sizing: border-box;" src="/stage/loading-pure.svg">'),A(o,{keyword:Ce.element.querySelector(".config-bazaar__panel:not(.fn__none) .b3-form__icon-input").value,repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,update:!0,frontend:ie()},r=>ky(this,null,function*(){var c;if(this._genMyHTML(l,t),Ce._onBazaar(r,l,["icons"].includes(l)),l==="themes"&&((c=r.data.appearance)!=null&&c.themeVer)&&(window.siyuan.config.appearance.themeVer=r.data.appearance.themeVer),l==="themes"&&(window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight===i.name||window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark===i.name)){const d=window.siyuan.config.appearance.mode===1?window.siyuan.config.appearance.themeDark:window.siyuan.config.appearance.themeLight;if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove(),jt(`/appearance/themes/${d}/theme.js?v=${r.data.appearance.themeVer}`,"themeScript")}catch(u){console.error("destroyTheme error: "+u)}else{Un({cb(){window.location.reload()},errorExit:!1});return}window.siyuan.config.appearance.mode===1&&d==="midnight"||window.siyuan.config.appearance.mode!==1&&d==="daylight"?document.getElementById("themeDefaultStyle").href=`/appearance/themes/${window.siyuan.config.appearance.mode===1?"midnight":"daylight"}/theme.css?v=${p.SIYUAN_VERSION}`:document.getElementById("themeStyle").href=`/appearance/themes/${d}/theme.css?v=${r.data.appearance.themeVer}`}else l==="plugins"&&t.plugins.find(d=>{if(d.name===i.name)return OS(t,{upsertPlugins:[i.name],removePlugins:[]}),!0})}))}),e.preventDefault(),e.stopPropagation();break}else if(s==="uninstall"){const l=i.bazaarType;let o="/api/bazaar/uninstallBazaarTemplate";l==="themes"?o="/api/bazaar/uninstallBazaarTheme":l==="icons"?o="/api/bazaar/uninstallBazaarIcon":l==="widgets"?o="/api/bazaar/uninstallBazaarWidget":l==="plugins"&&(o="/api/bazaar/uninstallBazaarPlugin");const r=i.name;window.siyuan.config.appearance.themeDark===r||window.siyuan.config.appearance.themeLight===r||window.siyuan.config.appearance.icon===r?de(window.siyuan.languages.uninstallTip):Re("\u26A0\uFE0F "+window.siyuan.languages.uninstall,window.siyuan.languages.confirmUninstall.replace("${name}",r),()=>{A(o,{packageName:r,keyword:Ce.element.querySelector(".config-bazaar__panel:not(.fn__none) .b3-form__icon-input").value,frontend:ie()},c=>{this._genMyHTML(l,t),Ce._onBazaar(c,l,["themes","icons"].includes(l))})}),e.preventDefault(),e.stopPropagation();break}else if(s==="switch"){const l=i.bazaarType,o=i.name,r=i.themeMode==="dark"?1:0;l==="icons"?A("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:o}),c=>{this._genMyHTML(l,t,!1),A("/api/bazaar/getBazaarIcon",{},d=>{d.data.appearance=c.data,Ce._onBazaar(d,"icons",!0),Ce._data.icons=d.data.packages,pd()})}):l==="themes"&&A("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:r,modeOS:!1,themeDark:r===1?o:window.siyuan.config.appearance.themeDark,themeLight:r===0?o:window.siyuan.config.appearance.themeLight}),c=>ky(this,null,function*(){if(pd(),(r!==window.siyuan.config.appearance.mode||r===1&&window.siyuan.config.appearance.themeDark!==o||r===0&&window.siyuan.config.appearance.themeLight!==o)&&window.siyuan.config.appearance.themeJS)if(window.destroyTheme){try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(d){console.error("destroyTheme error: "+d)}window.siyuan.config.appearance=c.data,Ip(window.siyuan.config.appearance)}else{Un({cb(){window.location.reload()},errorExit:!1});return}this._genMyHTML("themes",t,!1),A("/api/bazaar/getBazaarTheme",{},d=>{d.data.appearance=c.data,Ce._onBazaar(d,"themes",!0),Ce._data.themes=d.data.packages})})),e.preventDefault(),e.stopPropagation();break}else if(s==="setting"){t.plugins.find(l=>{if(l.name===i.name)return l.openSetting(),!0}),e.preventDefault(),e.stopPropagation();break}else if(s==="plugins-enable"){n.getAttribute("disabled")||(n.setAttribute("disabled","disabled"),window.siyuan.config.bazaar.petalDisabled=!n.checked,A("/api/setting/setBazaar",window.siyuan.config.bazaar,()=>{n.removeAttribute("disabled"),window.siyuan.config.bazaar.petalDisabled?Ce.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(l=>{l.classList.add("b3-card--disabled"),lg(t,JSON.parse(l.getAttribute("data-obj")).name,!1)}):(Ce.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(l=>{l.classList.remove("b3-card--disabled")}),Sy(t).then(()=>{t.plugins.forEach(l=>{rg(l)})}),bn())})),e.stopPropagation();break}else if(s==="plugin-enable"){if(!n.getAttribute("disabled")){n.setAttribute("disabled","disabled");const l=n.checked;A("/api/petal/setPetalEnabled",{packageName:i.name,enabled:l,frontend:ie(),app:p.SIYUAN_APPID},o=>{n.removeAttribute("disabled"),l?HS(t,o.data).then(r=>{r.setting||r.__proto__.hasOwnProperty("openSetting")?n.parentElement.querySelector('[data-type="setting"]').classList.remove("fn__none"):n.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none")}):(lg(t,i.name,!1),n.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none"))})}e.stopPropagation();break}else if(n.classList.contains("b3-card")){if(!T(e.target,"b3-card__actions--right")){const l=JSON.parse(n.getAttribute("data-obj")),o=l.bazaarType;let r;j(n,"data-type","downloaded-update")?r=Ce._data.update[l.bazaarType].find(c=>c.repoURL===l.repoURL):r=(l.downloaded?Ce._data.downloaded:Ce._data[o]).find(c=>c.repoURL===l.repoURL),Ce._renderReadme(o,r,l.downloaded)}e.preventDefault(),e.stopPropagation();break}else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){Ce.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),Ce.element.querySelectorAll(".config-bazaar__panel").forEach(l=>{s===l.getAttribute("data-type")?(l.classList.remove("fn__none"),l.getAttribute("data-init")||(s==="template"?A("/api/bazaar/getBazaarTemplate",{},o=>{Ce._onBazaar(o,"templates",!1),Ce._data.templates=o.data.packages}):s==="icon"?A("/api/bazaar/getBazaarIcon",{},o=>{Ce._onBazaar(o,"icons",!1),Ce._data.icons=o.data.packages}):s==="widget"?A("/api/bazaar/getBazaarWidget",{},o=>{Ce._onBazaar(o,"widgets",!1),Ce._data.widgets=o.data.packages}):s==="theme"?A("/api/bazaar/getBazaarTheme",{},o=>{Ce._onBazaar(o,"themes",!1),Ce._data.themes=o.data.packages}):s==="plugin"&&A("/api/bazaar/getBazaarPlugin",{frontend:ie()},o=>{Ce._onBazaar(o,"plugins",!1),Ce._data.plugins=o.data.packages}),l.setAttribute("data-init","true"))):l.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(n.classList.contains("item__preview")){n.classList.toggle("item__preview--fullscreen"),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),Ce.element.querySelectorAll(".config-bazaar__panel .b3-form__icon > .b3-text-field").forEach(e=>{e.addEventListener("keydown",n=>{if(!n.isComposing&&n.key==="Enter"){const a=e.value.trim(),i=T(e,"config-bazaar__panel").getAttribute("data-type");if(i==="template")A("/api/bazaar/getBazaarTemplate",{keyword:a},s=>{Ce._onBazaar(s,"templates",!1),Ce._data.templates=s.data.packages});else if(i==="icon")A("/api/bazaar/getBazaarIcon",{keyword:a},s=>{Ce._onBazaar(s,"icons",!1),Ce._data.icons=s.data.packages});else if(i==="widget")A("/api/bazaar/getBazaarWidget",{keyword:a},s=>{Ce._onBazaar(s,"widgets",!1),Ce._data.widgets=s.data.packages});else if(i==="theme")A("/api/bazaar/getBazaarTheme",{keyword:a},s=>{Ce._onBazaar(s,"themes",!1),Ce._data.themes=s.data.packages});else if(i==="plugin")A("/api/bazaar/getBazaarPlugin",{frontend:ie(),keyword:a},s=>{Ce._onBazaar(s,"plugins",!1),Ce._data.plugins=s.data.packages});else if(i==="downloaded"){const s=e.parentElement.parentElement.querySelector(".b3-button:not(.b3-button--outline)").getAttribute("data-type").replace("my","").toLowerCase()+"s";this._genMyHTML(s,t)}n.preventDefault();return}})}),Ce.element.querySelectorAll(".b3-select").forEach(e=>{e.addEventListener("change",n=>{if(e.id==="bazaarSelect")Ce.element.querySelectorAll("#configBazaarTheme .b3-card").forEach(a=>{const i=JSON.parse(a.getAttribute("data-obj"));e.value==="0"?i.themeMode.indexOf("light")>-1?a.classList.remove("fn__none"):a.classList.add("fn__none"):e.value==="1"?i.themeMode.indexOf("dark")>-1?a.classList.remove("fn__none"):a.classList.add("fn__none"):a.classList.remove("fn__none")}),n.target.parentElement.querySelector(".counter").textContent=Ce.element.querySelectorAll("#configBazaarTheme .b3-card:not(.fn__none)").length.toString();else{const a=window.siyuan.storage[p.LOCAL_BAZAAR],i=e.parentElement.parentElement;let s="";const l=Array.from(i.querySelectorAll(".b3-card"));e.value==="0"?l.sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(o.getAttribute("data-obj")).updated?-1:1).forEach(o=>{s+=o.outerHTML}):e.value==="1"?l.sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(o.getAttribute("data-obj")).updated?1:-1).forEach(o=>{s+=o.outerHTML}):e.value==="2"?l.sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(o.getAttribute("data-obj")).downloads?-1:1).forEach(o=>{s+=o.outerHTML}):e.value==="3"&&l.sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(o.getAttribute("data-obj")).downloads?1:-1).forEach(o=>{s+=o.outerHTML}),a[e.parentElement.parentElement.getAttribute("data-type")]=e.value,Ee(p.LOCAL_BAZAAR,window.siyuan.storage[p.LOCAL_BAZAAR]),l.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.querySelector(".b3-cards").innerHTML=s}})})},_onBazaar(t,e,n){if(Ce.element.querySelector("#configBazaarReadme").classList.contains("config-bazaar__readme--show")){const o=JSON.parse(Ce.element.querySelector("#configBazaarReadme > .item__side").getAttribute("data-obj"));Ce._renderReadme(o.bazaarType,t.data.packages.find(r=>r.repoURL===o.repoURL),o.downloaded)}let a="#configBazaarTemplate";e==="themes"?a="#configBazaarTheme":e==="icons"?a="#configBazaarIcon":e==="widgets"?a="#configBazaarWidget":e==="plugins"&&(a="#configBazaarPlugin");const i=Ce.element.querySelector(a);t.code===1&&(de(t.msg),i.querySelectorAll("img[data-type='img-loading']").forEach(o=>{o.remove()}));let s="";t.data.packages.forEach(o=>{s+=this._genCardHTML(o,e)}),Ce._data[e]=t.data.packages,i.innerHTML=`<div class="b3-cards">${s}</div>`,i.parentElement.querySelector(".counter").textContent=i.querySelectorAll(".b3-card:not(.fn__none)").length.toString();const l=window.siyuan.storage[p.LOCAL_BAZAAR];l[e.replace("s","")]==="1"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(o.getAttribute("data-obj")).updated?1:-1).forEach(o=>{s+=o.outerHTML})):l[e.replace("s","")]==="2"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(o.getAttribute("data-obj")).downloads?-1:1).forEach(o=>{s+=o.outerHTML})):l[e.replace("s","")]==="3"&&(s="",Array.from(i.querySelectorAll(".b3-card")).sort((o,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(o.getAttribute("data-obj")).downloads?1:-1).forEach(o=>{s+=o.outerHTML})),t.data.packages.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.innerHTML=`<div class="b3-cards">${s}</div>`,n&&It.onSetAppearance(t.data.appearance)}},st={element:void 0,genHTML:()=>`<div class="b3-label">
    <div>${window.siyuan.languages.searchBlockType}</div>
    <div class="fn__flex config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconMath"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.math}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="mathBlock" type="checkbox"${window.siyuan.config.search.mathBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconTable"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.table}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="table" type="checkbox"${window.siyuan.config.search.table?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconParagraph"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.paragraph}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="paragraph" type="checkbox"${window.siyuan.config.search.paragraph?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHeadings"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.headings}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="heading" type="checkbox"${window.siyuan.config.search.heading?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconCode"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.code}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="codeBlock" type="checkbox"${window.siyuan.config.search.codeBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHTML5"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                HTML
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="htmlBlock" type="checkbox"${window.siyuan.config.search.htmlBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconDatabase"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.database}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="databaseBlock" type="checkbox"${window.siyuan.config.search.databaseBlock?" checked":""}/>
        </label>        
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSQL"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.embedBlock}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="embedBlock" type="checkbox"${window.siyuan.config.search.embedBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconVideo"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.video}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="videoBlock" type="checkbox"${window.siyuan.config.search.videoBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconRecord"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.audio}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="audioBlock" type="checkbox"${window.siyuan.config.search.audioBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconLanguage"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                IFrame
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="iframeBlock" type="checkbox"${window.siyuan.config.search.iframeBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconBoth"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.widget}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="widgetBlock" type="checkbox"${window.siyuan.config.search.widgetBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconQuote"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.quote} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="blockquote" type="checkbox"${window.siyuan.config.search.blockquote?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSuper"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.superBlock} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="superBlock" type="checkbox"${window.siyuan.config.search.superBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconList"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.list1} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="list" type="checkbox"${window.siyuan.config.search.list?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconListItem"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.listItem} <sup>[1]</sup>
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="listItem" type="checkbox"${window.siyuan.config.search.listItem?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconFile"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.doc}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="document" type="checkbox"${window.siyuan.config.search.document?" checked":""}/>
        </label>
    </div>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>
</div>
<div class="b3-label">
    <div>${window.siyuan.languages.searchBlockAttr}</div>
    <div class="config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconN"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="name" type="checkbox"${window.siyuan.config.search.name?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconA"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="alias" type="checkbox"${window.siyuan.config.search.alias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconM"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.memo}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="memo" type="checkbox"${window.siyuan.config.search.memo?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.allAttrs}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="ial" type="checkbox"${window.siyuan.config.search.ial?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
    <div>${window.siyuan.languages.searchBackmention}</div>
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionName" type="checkbox"${window.siyuan.config.search.backlinkMentionName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAlias" type="checkbox"${window.siyuan.config.search.backlinkMentionAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAnchor" type="checkbox"${window.siyuan.config.search.backlinkMentionAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionDoc" type="checkbox"${window.siyuan.config.search.backlinkMentionDoc?" checked":""}/>
        </label>
        <div class="fn__flex label fn__flex-1" style="flex: 2">
            <div>
                ${window.siyuan.languages.keywordsLimit}
            </div>
            <span class="fn__space"></span>
            <input class="b3-text-field" id="backlinkMentionKeywordsLimit" type="number" min="1" max="10240" value="${window.siyuan.config.search.backlinkMentionKeywordsLimit}">
        </div>
    </div>
</div>
<div class="b3-label">
    <div>${window.siyuan.languages.searchVirtualRef}</div>
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefName" type="checkbox"${window.siyuan.config.search.virtualRefName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAlias" type="checkbox"${window.siyuan.config.search.virtualRefAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAnchor" type="checkbox"${window.siyuan.config.search.virtualRefAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefDoc" type="checkbox"${window.siyuan.config.search.virtualRefDoc?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
    <div>${window.siyuan.languages.searchIndex}</div>
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.indexAssetPath}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="indexAssetPath" type="checkbox"${window.siyuan.config.search.indexAssetPath?" checked":""}/>
        </label>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchLimit}
         <div class="b3-label__text">${window.siyuan.languages.searchLimit1}</div>
         <div class="b3-label__text">${window.siyuan.languages.searchLimit2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="limit" type="number" min="32" max="10240" value="${window.siyuan.config.search.limit}">
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchCaseSensitive}
         <div class="b3-label__text">${window.siyuan.languages.searchCaseSensitive1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="caseSensitive" type="checkbox"${window.siyuan.config.search.caseSensitive?" checked":""}/>
</label>`,bindEvent:()=>{st.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{A("/api/setting/setSearch",{document:st.element.querySelector("#document").checked,heading:st.element.querySelector("#heading").checked,list:st.element.querySelector("#list").checked,listItem:st.element.querySelector("#listItem").checked,codeBlock:st.element.querySelector("#codeBlock").checked,htmlBlock:st.element.querySelector("#htmlBlock").checked,embedBlock:st.element.querySelector("#embedBlock").checked,databaseBlock:st.element.querySelector("#databaseBlock").checked,audioBlock:st.element.querySelector("#audioBlock").checked,videoBlock:st.element.querySelector("#videoBlock").checked,iframeBlock:st.element.querySelector("#iframeBlock").checked,widgetBlock:st.element.querySelector("#widgetBlock").checked,mathBlock:st.element.querySelector("#mathBlock").checked,table:st.element.querySelector("#table").checked,blockquote:st.element.querySelector("#blockquote").checked,superBlock:st.element.querySelector("#superBlock").checked,paragraph:st.element.querySelector("#paragraph").checked,name:st.element.querySelector("#name").checked,alias:st.element.querySelector("#alias").checked,memo:st.element.querySelector("#memo").checked,ial:st.element.querySelector("#ial").checked,indexAssetPath:st.element.querySelector("#indexAssetPath").checked,limit:parseInt(st.element.querySelector("#limit").value),caseSensitive:st.element.querySelector("#caseSensitive").checked,backlinkMentionName:st.element.querySelector("#backlinkMentionName").checked,backlinkMentionAlias:st.element.querySelector("#backlinkMentionAlias").checked,backlinkMentionAnchor:st.element.querySelector("#backlinkMentionAnchor").checked,backlinkMentionDoc:st.element.querySelector("#backlinkMentionDoc").checked,backlinkMentionKeywordsLimit:parseInt(st.element.querySelector("#backlinkMentionKeywordsLimit").value),virtualRefName:st.element.querySelector("#virtualRefName").checked,virtualRefAlias:st.element.querySelector("#virtualRefAlias").checked,virtualRefAnchor:st.element.querySelector("#virtualRefAnchor").checked,virtualRefDoc:st.element.querySelector("#virtualRefDoc").checked},e=>{window.siyuan.config.search=e.data})})})}},_e={element:void 0,genHTML:()=>{let t="";return t=`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        AI\u670D\u52A1\u63D0\u4F9B\u5546
        <div class="b3-label__text">\u9009\u62E9AI\u5BF9\u8BDD\u670D\u52A1\u63D0\u4F9B\u5546\uFF0C\u652F\u6301\u591A\u79CD\u4E3B\u6D41AI\u6A21\u578B</div>
    </div>
    <span class="fn__space"></span>
    <select id="apiProvider" class="b3-select fn__flex-center fn__size200">
        <option value="builtin" ${window.siyuan.config.ai.openAI.apiProvider==="builtin"?"selected":""}>\u{1F381} \u5185\u7F6E\u514D\u8D39\u6A21\u578B</option>
        <option value="OpenAI" ${window.siyuan.config.ai.openAI.apiProvider==="OpenAI"?"selected":""}>OpenAI</option>
        <option value="Azure" ${window.siyuan.config.ai.openAI.apiProvider==="Azure"?"selected":""}>Azure OpenAI</option>
        <option value="SiliconFlow" ${window.siyuan.config.ai.openAI.apiProvider==="SiliconFlow"?"selected":""}>\u7845\u57FA\u6D41\u52A8</option>
        <option value="Qwen" ${window.siyuan.config.ai.openAI.apiProvider==="Qwen"?"selected":""}>\u901A\u4E49\u5343\u95EE</option>
        <option value="ZhipuAI" ${window.siyuan.config.ai.openAI.apiProvider==="ZhipuAI"?"selected":""}>\u667A\u8C31AI</option>
        <option value="DeepSeek" ${window.siyuan.config.ai.openAI.apiProvider==="DeepSeek"?"selected":""}>DeepSeek</option>
        <option value="Moonshot" ${window.siyuan.config.ai.openAI.apiProvider==="Moonshot"?"selected":""}>\u6708\u4E4B\u6697\u9762</option>
        <option value="Custom" ${window.siyuan.config.ai.openAI.apiProvider==="Custom"?"selected":""}>\u81EA\u5B9A\u4E49API</option>
    </select>
</div>
<div class="fn__flex b3-label${window.siyuan.config.ai.openAI.apiProvider==="builtin"?" fn__none":""}" data-field="apiKey">
    <div class="fn__block">
        API\u5BC6\u94A5
        <div class="b3-label__text">\u60A8\u7684API\u5BC6\u94A5${_e.getProviderKeyTip()}</div>
        <div class="fn__hr"></div>
        <div class="b3-form__icona fn__block">
            <input id="apiKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.ai.openAI.apiKey}" placeholder="sk-xxx">
            <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
        </div>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        AI\u6A21\u578B
        <div class="b3-label__text">\u9009\u62E9\u8981\u4F7F\u7528\u7684AI\u6A21\u578B</div>
        <div class="fn__hr"></div>
        <select id="apiModel" class="b3-select fn__block">
            ${_e.getModelOptions()}
        </select>
        <div class="b3-label__text" id="modelDescription" style="margin-top: 8px;">${_e.getModelDescription()}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiTimeout}
        <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
    </div>
    <span class="fn__space"></span>
    <div class="fn__size200 fn__flex-center fn__flex">
        <input class="b3-text-field fn__flex-1" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-center">s</span>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiMaxTokens}
        <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiTemperature}
        <div class="b3-label__text">${window.siyuan.languages.apiTemperatureTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="0.1" min="0" max="2" id="apiTemperature" value="${window.siyuan.config.ai.openAI.apiTemperature}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiMaxContexts}
        <div class="b3-label__text">${window.siyuan.languages.apiMaxContextsTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="1" max="64" id="apiMaxContexts" value="${window.siyuan.config.ai.openAI.apiMaxContexts}"/>
</div>
<div class="fn__flex b3-label${window.siyuan.config.ai.openAI.apiProvider==="builtin"?" fn__none":""}" data-field="apiBaseURL">
    <div class="fn__block">
        ${window.siyuan.languages.apiBaseURL}
        <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}" placeholder="${_e.getDefaultBaseURL()}"/>
    </div>
</div>
<div class="fn__flex b3-label${window.siyuan.config.ai.openAI.apiProvider!=="Custom"?" fn__none":""}" data-field="apiProxy">
    <div class="fn__block">
        ${window.siyuan.languages.apiProxy}
        <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    </div>
</div>
<div class="fn__flex b3-label${window.siyuan.config.ai.openAI.apiProvider!=="Azure"?" fn__none":""}" data-field="apiVersion">
    <div class="fn__block">
        ${window.siyuan.languages.apiVersion}
        <div class="b3-label__text">${window.siyuan.languages.apiVersionTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiVersion" value="${window.siyuan.config.ai.openAI.apiVersion}"/>
    </div>
</div>
<div class="fn__flex b3-label${window.siyuan.config.ai.openAI.apiProvider==="builtin"?" fn__none":""}" data-field="apiUserAgent">
    <div class="fn__block">
        User-Agent
        <div class="b3-label__text">${window.siyuan.languages.apiUserAgentTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiUserAgent" value="${window.siyuan.config.ai.openAI.apiUserAgent}"/>
    </div>
</div>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">AI\u5BF9\u8BDD</span><span class="fn__flex-1"></span></div>
    <div data-type="embedding" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">\u5411\u91CF\u5316</span><span class="fn__flex-1"></span></div>
    <div data-type="ai-features" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">AI\u529F\u80FD</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${t}
    </div>
    <div data-type="embedding" style="display: none;">
        ${_e.genEmbeddingHTML()}
    </div>
    <div data-type="ai-features" style="display: none;">
        ${_e.genAIFeaturesHTML()}
    </div>
</div>
</div>`},getModelOptions:t=>{const e=t||window.siyuan.config.ai.openAI.apiProvider||"builtin",n=window.siyuan.config.ai.openAI.apiModel||"",a={builtin:[{value:"builtin-free",label:"\u601D\u6E90\u5185\u7F6E\u514D\u8D39\u6A21\u578B",desc:"\u514D\u8D39\u4F7F\u7528\uFF0C\u9002\u5408\u65E5\u5E38\u5BF9\u8BDD"}],OpenAI:[{value:"gpt-4o",label:"GPT-4o",desc:"\u6700\u65B0\u6700\u5F3A\u6A21\u578B\uFF0C\u652F\u6301\u591A\u6A21\u6001"},{value:"gpt-4o-mini",label:"GPT-4o Mini",desc:"\u8F7B\u91CF\u5FEB\u901F\uFF0C\u6027\u4EF7\u6BD4\u9AD8"},{value:"gpt-4-turbo",label:"GPT-4 Turbo",desc:"\u5F3A\u5927\u7684GPT-4\u6A21\u578B"},{value:"gpt-4",label:"GPT-4",desc:"\u7ECF\u5178GPT-4\u6A21\u578B"},{value:"gpt-3.5-turbo",label:"GPT-3.5 Turbo",desc:"\u5FEB\u901F\u4E14\u7ECF\u6D4E"}],Azure:[{value:"gpt-4",label:"GPT-4 (Azure)",desc:"Azure\u90E8\u7F72\u7684GPT-4"},{value:"gpt-35-turbo",label:"GPT-3.5 Turbo (Azure)",desc:"Azure\u90E8\u7F72\u7684GPT-3.5"}],SiliconFlow:[{value:"Qwen/Qwen2.5-72B-Instruct",label:"\u901A\u4E49\u5343\u95EE 2.5 (72B)",desc:"\u5F3A\u5927\u7684\u4E2D\u6587\u6A21\u578B"},{value:"Qwen/Qwen2.5-7B-Instruct",label:"\u901A\u4E49\u5343\u95EE 2.5 (7B)",desc:"\u8F7B\u91CF\u5FEB\u901F"},{value:"THUDM/glm-4-9b-chat",label:"GLM-4 (9B)",desc:"\u667A\u8C31\u6700\u65B0\u6A21\u578B"},{value:"deepseek-ai/DeepSeek-V2.5",label:"DeepSeek V2.5",desc:"\u63A8\u7406\u80FD\u529B\u5F3A"},{value:"meta-llama/Meta-Llama-3.1-70B-Instruct",label:"Llama 3.1 (70B)",desc:"Meta\u5F00\u6E90\u5927\u6A21\u578B"},{value:"meta-llama/Meta-Llama-3.1-8B-Instruct",label:"Llama 3.1 (8B)",desc:"\u8F7B\u91CF\u5F00\u6E90\u6A21\u578B"}],Qwen:[{value:"qwen-max",label:"\u901A\u4E49\u5343\u95EE Max",desc:"\u6700\u5F3A\u6027\u80FD"},{value:"qwen-plus",label:"\u901A\u4E49\u5343\u95EE Plus",desc:"\u5E73\u8861\u6027\u80FD"},{value:"qwen-turbo",label:"\u901A\u4E49\u5343\u95EE Turbo",desc:"\u5FEB\u901F\u54CD\u5E94"}],ZhipuAI:[{value:"glm-4-plus",label:"GLM-4 Plus",desc:"\u8D85\u5927\u89C4\u6A21\u6A21\u578B"},{value:"glm-4",label:"GLM-4",desc:"\u7EFC\u5408\u6027\u80FD\u5F3A"},{value:"glm-3-turbo",label:"GLM-3 Turbo",desc:"\u5FEB\u901F\u9AD8\u6548"}],DeepSeek:[{value:"deepseek-chat",label:"DeepSeek Chat",desc:"\u5BF9\u8BDD\u6A21\u578B"},{value:"deepseek-coder",label:"DeepSeek Coder",desc:"\u4EE3\u7801\u4E13\u7528\u6A21\u578B"}],Moonshot:[{value:"moonshot-v1-128k",label:"Kimi (128K)",desc:"\u8D85\u957F\u4E0A\u4E0B\u6587"},{value:"moonshot-v1-32k",label:"Kimi (32K)",desc:"\u957F\u4E0A\u4E0B\u6587"},{value:"moonshot-v1-8k",label:"Kimi (8K)",desc:"\u6807\u51C6\u4E0A\u4E0B\u6587"}],Custom:[{value:"custom-model",label:"\u81EA\u5B9A\u4E49\u6A21\u578B",desc:"\u517C\u5BB9OpenAI API\u7684\u4EFB\u4F55\u6A21\u578B"}]};return(a[e]||a.builtin).map(s=>`<option value="${s.value}">${s.label}</option>`).join("")},getModelDescription:(t,e)=>{const n=t||window.siyuan.config.ai.openAI.apiModel||"builtin-free";return{"builtin-free":"\u5B8C\u5168\u514D\u8D39\u7684\u5185\u7F6EAI\u6A21\u578B\uFF0C\u9002\u5408\u65E5\u5E38\u5BF9\u8BDD\u548C\u6587\u6863\u5206\u6790","gpt-4o":"OpenAI\u6700\u65B0\u6700\u5F3A\u6A21\u578B\uFF0C\u652F\u6301\u89C6\u89C9\u7406\u89E3\u548C\u591A\u6A21\u6001\u8F93\u5165","gpt-4o-mini":"\u8F7B\u91CF\u7248GPT-4o\uFF0C\u54CD\u5E94\u66F4\u5FEB\uFF0C\u6210\u672C\u66F4\u4F4E","gpt-4-turbo":"GPT-4\u7684\u4F18\u5316\u7248\u672C\uFF0C\u5904\u7406\u901F\u5EA6\u66F4\u5FEB","gpt-4":"\u7ECF\u5178\u7684GPT-4\u6A21\u578B\uFF0C\u5F3A\u5927\u7684\u63A8\u7406\u80FD\u529B","gpt-3.5-turbo":"\u6027\u4EF7\u6BD4\u6700\u9AD8\u7684\u9009\u62E9\uFF0C\u54CD\u5E94\u8FC5\u901F","gpt-35-turbo":"Azure\u90E8\u7F72\u7684GPT-3.5\u6A21\u578B","Qwen/Qwen2.5-72B-Instruct":"\u963F\u91CC\u6700\u5F3A\u4E2D\u6587\u6A21\u578B\uFF0C\u7406\u89E3\u80FD\u529B\u51FA\u8272","Qwen/Qwen2.5-7B-Instruct":"\u8F7B\u91CF\u5FEB\u901F\uFF0C\u9002\u5408\u65E5\u5E38\u4F7F\u7528","THUDM/glm-4-9b-chat":"\u667A\u8C31\u6700\u65B0\u5BF9\u8BDD\u6A21\u578B\uFF0C\u4E2D\u6587\u8868\u73B0\u4F18\u79C0","deepseek-ai/DeepSeek-V2.5":"\u5F3A\u5927\u7684\u63A8\u7406\u548C\u4EE3\u7801\u80FD\u529B","qwen-max":"\u901A\u4E49\u5343\u95EE\u6700\u5F3A\u6A21\u578B\uFF0C\u7EFC\u5408\u80FD\u529B\u7A81\u51FA","qwen-plus":"\u901A\u4E49\u5343\u95EE\u5E73\u8861\u6027\u80FD\u6A21\u578B","qwen-turbo":"\u901A\u4E49\u5343\u95EE\u5FEB\u901F\u54CD\u5E94\u6A21\u578B","glm-4-plus":"\u667A\u8C31AI\u8D85\u5927\u6A21\u578B\uFF0C\u5904\u7406\u590D\u6742\u4EFB\u52A1","glm-4":"\u667A\u8C31AI\u7EFC\u5408\u6027\u80FD\u6A21\u578B","glm-3-turbo":"\u667A\u8C31AI\u5FEB\u901F\u6A21\u578B","deepseek-chat":"DeepSeek\u901A\u7528\u5BF9\u8BDD\u6A21\u578B","deepseek-coder":"DeepSeek\u4EE3\u7801\u4E13\u7528\u6A21\u578B","moonshot-v1-128k":"\u652F\u6301128K\u8D85\u957F\u4E0A\u4E0B\u6587\uFF0C\u9002\u5408\u957F\u6587\u6863\u5206\u6790","moonshot-v1-32k":"\u652F\u630132K\u957F\u4E0A\u4E0B\u6587","moonshot-v1-8k":"\u652F\u63018K\u6807\u51C6\u4E0A\u4E0B\u6587","custom-model":"\u517C\u5BB9OpenAI API\u7684\u81EA\u5B9A\u4E49\u6A21\u578B","meta-llama/Meta-Llama-3.1-70B-Instruct":"Meta\u5F00\u6E90\u5927\u6A21\u578B\uFF0C\u901A\u7528\u80FD\u529B\u5F3A","meta-llama/Meta-Llama-3.1-8B-Instruct":"\u8F7B\u91CF\u7EA7\u5F00\u6E90\u6A21\u578B"}[n]||"\u8BF7\u9009\u62E9\u4E00\u4E2AAI\u6A21\u578B"},getDefaultBaseURL:t=>{const e=t||window.siyuan.config.ai.openAI.apiProvider||"builtin";return{OpenAI:"https://api.openai.com/v1",Azure:"https://YOUR_RESOURCE.openai.azure.com",SiliconFlow:"https://api.siliconflow.cn/v1",Qwen:"https://dashscope.aliyuncs.com/compatible-mode/v1",ZhipuAI:"https://open.bigmodel.cn/api/paas/v4",DeepSeek:"https://api.deepseek.com/v1",Moonshot:"https://api.moonshot.cn/v1",Custom:"https://your-api-endpoint.com/v1"}[e]||""},getProviderKeyTip:t=>{const e=t||window.siyuan.config.ai.openAI.apiProvider||"builtin";return{OpenAI:"\uFF0C\u5728 platform.openai.com \u83B7\u53D6",Azure:"\uFF0C\u5728Azure\u95E8\u6237\u83B7\u53D6",SiliconFlow:"\uFF0C\u5728 siliconflow.cn \u514D\u8D39\u83B7\u53D6",Qwen:"\uFF0C\u5728\u963F\u91CC\u4E91\u63A7\u5236\u53F0\u83B7\u53D6",ZhipuAI:"\uFF0C\u5728 open.bigmodel.cn \u83B7\u53D6",DeepSeek:"\uFF0C\u5728 platform.deepseek.com \u83B7\u53D6",Moonshot:"\uFF0C\u5728 platform.moonshot.cn \u83B7\u53D6"}[e]||""},genEmbeddingHTML:()=>{var t;const e=((t=window.siyuan.config.ai)==null?void 0:t.embedding)||{provider:"siliconflow",apiKey:"",model:"BAAI/bge-large-zh-v1.5",apiBaseUrl:"https://api.siliconflow.cn/v1/embeddings",encodingFormat:"float",timeout:30,enabled:!1};return`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        \u5411\u91CF\u5316\u63D0\u4F9B\u5546
        <div class="b3-label__text">\u9009\u62E9\u5411\u91CF\u5316\u670D\u52A1\u63D0\u4F9B\u5546\uFF0C\u652F\u6301\u591A\u79CDAI\u6A21\u578B</div>
    </div>
    <span class="fn__space"></span>
    <select id="embeddingProvider" class="b3-select fn__flex-center fn__size200">
        <option value="siliconflow" ${e.provider==="siliconflow"?"selected":""}>SiliconFlow</option>
        <option value="openai" ${e.provider==="openai"?"selected":""}>OpenAI</option>
    </select>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        \u542F\u7528\u5411\u91CF\u5316\u529F\u80FD
        <div class="b3-label__text">\u5F00\u542F\u540E\u53EF\u4F7F\u7528\u8BED\u4E49\u641C\u7D22\u548CAI\u5206\u6790\u529F\u80FD</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="embeddingEnabled" class="b3-switch" ${e.enabled?"checked":""}/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        API\u5BC6\u94A5
        <div class="b3-label__text">\u5411\u91CF\u5316\u670D\u52A1\u7684API\u5BC6\u94A5</div>
        <div class="fn__hr"></div>
        <div class="b3-form__icona fn__block">
            <input id="embeddingApiKey" type="password" class="b3-text-field b3-form__icona-input" value="${e.apiKey}" placeholder="sk-xxx">
            <svg class="b3-form__icona-icon" data-action="toggleEmbeddingPassword"><use xlink:href="#iconEye"></use></svg>
        </div>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        \u5411\u91CF\u5316\u6A21\u578B
        <div class="b3-label__text">\u9009\u62E9\u7528\u4E8E\u5411\u91CF\u5316\u7684AI\u6A21\u578B</div>
        <div class="fn__hr"></div>
        <select id="embeddingModel" class="b3-text-field fn__block">
            <option value="BAAI/bge-large-zh-v1.5" ${e.model==="BAAI/bge-large-zh-v1.5"?"selected":""}>BAAI/bge-large-zh-v1.5 (\u4E2D\u6587\u5927\u578B)</option>
            <option value="BAAI/bge-m3" ${e.model==="BAAI/bge-m3"?"selected":""}>BAAI/bge-m3 (\u591A\u8BED\u8A00)</option>
            <option value="netease-youdao/bce-embedding-base_v1" ${e.model==="netease-youdao/bce-embedding-base_v1"?"selected":""}>BCE-Embedding-Base</option>
            <option value="text-embedding-3-small" ${e.model==="text-embedding-3-small"?"selected":""}>text-embedding-3-small (OpenAI)</option>
            <option value="text-embedding-3-large" ${e.model==="text-embedding-3-large"?"selected":""}>text-embedding-3-large (OpenAI)</option>
            <option value="text-embedding-ada-002" ${e.model==="text-embedding-ada-002"?"selected":""}>text-embedding-ada-002 (OpenAI)</option>
        </select>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        API\u5730\u5740
        <div class="b3-label__text">\u5411\u91CF\u5316\u670D\u52A1\u7684API\u7AEF\u70B9\u5730\u5740</div>
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" id="embeddingApiBaseUrl" value="${e.apiBaseUrl}" placeholder="https://api.siliconflow.cn/v1/embeddings"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        \u7F16\u7801\u683C\u5F0F
        <div class="b3-label__text">\u5411\u91CF\u6570\u636E\u7684\u7F16\u7801\u683C\u5F0F</div>
    </div>
    <span class="fn__space"></span>
    <select id="embeddingEncodingFormat" class="b3-select fn__flex-center fn__size200">
        <option value="float" ${e.encodingFormat==="float"?"selected":""}>float</option>
        <option value="base64" ${e.encodingFormat==="base64"?"selected":""}>base64</option>
    </select>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        \u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4
        <div class="b3-label__text">\u5411\u91CF\u5316\u8BF7\u6C42\u7684\u6700\u5927\u7B49\u5F85\u65F6\u95F4</div>
    </div>
    <span class="fn__space"></span>
    <div class="fn__size200 fn__flex-center fn__flex">
        <input class="b3-text-field fn__flex-1" type="number" step="1" min="5" max="300" id="embeddingTimeout" value="${e.timeout}"/>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-center">\u79D2</span>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        <button id="testEmbeddingConnection" class="b3-button b3-button--outline">\u6D4B\u8BD5\u8FDE\u63A5</button>
        <span class="fn__space"></span>
        <button id="getEmbeddingModels" class="b3-button b3-button--outline">\u83B7\u53D6\u53EF\u7528\u6A21\u578B</button>
    </div>
</div>`},genAIFeaturesHTML:()=>`<div class="b3-label">
    <h3>AI\u529F\u80FD\u6D4B\u8BD5</h3>
    <div class="b3-label__text">\u6D4B\u8BD5\u65B0\u589E\u7684AI\u5411\u91CF\u5316\u548C\u5206\u6790\u529F\u80FD</div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <button id="semanticSearchTest" class="b3-button b3-button--outline">\u8BED\u4E49\u641C\u7D22\u6D4B\u8BD5</button>
        <span class="fn__space"></span>
        <input id="semanticSearchQuery" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u641C\u7D22\u5173\u952E\u8BCD..." value="\u4EBA\u5DE5\u667A\u80FD">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <button id="notebookSummaryTest" class="b3-button b3-button--outline">\u7B14\u8BB0\u672C\u6458\u8981\u751F\u6210\u6D4B\u8BD5</button>
        <span class="fn__space"></span>
        <input id="notebookSummaryId" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u7B14\u8BB0\u672CID...">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <button id="batchVectorizeTest" class="b3-button b3-button--outline">\u6279\u91CF\u5411\u91CF\u5316\u6D4B\u8BD5</button>
        <span class="fn__space"></span>
        <input id="batchVectorizeNotebook" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u7B14\u8BB0\u672CID...">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <div id="aiTestResults" class="b3-form__space-small" style="background: var(--b3-theme-background-contrast); padding: 12px; border-radius: 4px; min-height: 60px; font-family: monospace; white-space: pre-wrap;">\u6D4B\u8BD5\u7ED3\u679C\u5C06\u5728\u8FD9\u91CC\u663E\u793A...</div>
    </div>
</div>`,bindEvent:()=>{_e.element.querySelectorAll(".layout-tab-bar .item").forEach(c=>{c.addEventListener("click",()=>{const d=c.getAttribute("data-type");_e.element.querySelectorAll(".layout-tab-bar .item").forEach(u=>{u.classList.remove("item--focus")}),c.classList.add("item--focus"),_e.element.querySelectorAll(".fn__flex-1 > div").forEach(u=>{u.getAttribute("data-type")===d?u.style.display="block":u.style.display="none"})})});const t=_e.element.querySelector("#apiProvider");t&&t.addEventListener("change",()=>{const c=t.value,d=_e.element.querySelector("#apiModel");if(d&&(d.innerHTML=_e.getModelOptions(c),d.options.length>0)){d.selectedIndex=0;const f=_e.element.querySelector("#modelDescription");f&&(f.textContent=_e.getModelDescription(d.value,c))}const u=_e.element.querySelector("#apiBaseURL");u&&(u.placeholder=_e.getDefaultBaseURL(c)),["apiKey","apiBaseURL","apiProxy","apiVersion","apiUserAgent"].forEach(f=>{const g=_e.element.querySelector(`[data-field="${f}"]`);g&&(c==="builtin"||f==="apiProxy"&&c!=="Custom"||f==="apiVersion"&&c!=="Azure"?g.classList.add("fn__none"):g.classList.remove("fn__none"))})});const e=_e.element.querySelector("#apiModel");e&&e.addEventListener("change",()=>{const c=_e.element.querySelector("#modelDescription");c&&(c.textContent=_e.getModelDescription(e.value))});const n=_e.element.querySelector('.b3-form__icona-icon[data-action="togglePassword"]');n&&n.addEventListener("click",()=>{const c=n.firstElementChild.getAttribute("xlink:href")==="#iconEye";n.firstElementChild.setAttribute("xlink:href",c?"#iconEyeoff":"#iconEye"),n.previousElementSibling.setAttribute("type",c?"text":"password")});const a=_e.element.querySelector('.b3-form__icona-icon[data-action="toggleEmbeddingPassword"]');a&&a.addEventListener("click",()=>{const c=a.firstElementChild.getAttribute("xlink:href")==="#iconEye";a.firstElementChild.setAttribute("xlink:href",c?"#iconEyeoff":"#iconEye"),a.previousElementSibling.setAttribute("type",c?"text":"password")}),_e.element.querySelectorAll("#apiKey, #apiModel, #apiMaxTokens, #apiTemperature, #apiMaxContexts, #apiProxy, #apiTimeout, #apiProvider, #apiBaseURL, #apiVersion, #apiUserAgent").forEach(c=>{c.addEventListener("change",()=>{const d=_e.element.querySelector("#apiProvider").value,u=_e.element.querySelector("#apiModel").value,m=d==="builtin",f={openAI:{apiUserAgent:_e.element.querySelector("#apiUserAgent").value,apiBaseURL:m?"USE_DEFAULT_CONFIG":_e.element.querySelector("#apiBaseURL").value,apiVersion:_e.element.querySelector("#apiVersion").value,apiKey:m?"USE_DEFAULT_CONFIG":_e.element.querySelector("#apiKey").value,apiModel:m?"USE_DEFAULT_CONFIG":u,apiMaxTokens:parseInt(_e.element.querySelector("#apiMaxTokens").value),apiTemperature:parseFloat(_e.element.querySelector("#apiTemperature").value),apiMaxContexts:parseInt(_e.element.querySelector("#apiMaxContexts").value),apiProxy:_e.element.querySelector("#apiProxy").value,apiTimeout:parseInt(_e.element.querySelector("#apiTimeout").value),apiProvider:d}};A("/api/setting/setAI",f,g=>{var h;if(window.siyuan.config.ai=g.data,m&&((h=window.siyuan.config.system)==null?void 0:h.container)==="web"){const b=localStorage.getItem("siyuan_jwt_token");b&&fetch(`${window.siyuan.config.system.unifiedAuthServiceUrl||"http://localhost:3002"}/api/settings/neuralink_llm`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`},body:JSON.stringify({provider:"builtin",model:"USE_DEFAULT_CONFIG",api_key:"USE_DEFAULT_CONFIG",base_url:"USE_DEFAULT_CONFIG"})}).then(y=>y.json()).then(y=>{y.success&&console.log("\u5185\u7F6E\u514D\u8D39\u6A21\u578B\u914D\u7F6E\u5DF2\u4FDD\u5B58\u5230\u7528\u6237\u8BBE\u7F6E")}).catch(y=>{console.error("\u4FDD\u5B58\u7528\u6237\u8BBE\u7F6E\u5931\u8D25:",y)})}})})}),_e.element.querySelectorAll("#embeddingProvider, #embeddingApiKey, #embeddingModel, #embeddingApiBaseUrl, #embeddingEncodingFormat, #embeddingTimeout, #embeddingEnabled").forEach(c=>{c.addEventListener("change",()=>{const d={provider:_e.element.querySelector("#embeddingProvider").value,apiKey:_e.element.querySelector("#embeddingApiKey").value,model:_e.element.querySelector("#embeddingModel").value,apiBaseUrl:_e.element.querySelector("#embeddingApiBaseUrl").value,encodingFormat:_e.element.querySelector("#embeddingEncodingFormat").value,timeout:parseInt(_e.element.querySelector("#embeddingTimeout").value),enabled:_e.element.querySelector("#embeddingEnabled").checked};A("/api/ai/setEmbeddingConfig",d,u=>{u.code===0?(window.siyuan.config.ai.embedding=u.data.data,_e.showMessage("\u5411\u91CF\u5316\u914D\u7F6E\u5DF2\u4FDD\u5B58","success")):_e.showMessage("\u4FDD\u5B58\u5931\u8D25: "+u.msg,"error")})})});const i=_e.element.querySelector("#testEmbeddingConnection");i&&i.addEventListener("click",()=>{_e.showMessage("\u6B63\u5728\u6D4B\u8BD5\u5411\u91CF\u5316\u670D\u52A1\u8FDE\u63A5...","info"),A("/api/ai/testEmbeddingConnection",{},c=>{const d=_e.element.querySelector("#aiTestResults");c.code===0?(d.textContent=`\u2705 \u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F!
`+JSON.stringify(c.data,null,2),_e.showMessage("\u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F","success")):(d.textContent="\u274C \u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: "+c.msg,_e.showMessage("\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25","error"))})});const s=_e.element.querySelector("#getEmbeddingModels");s&&s.addEventListener("click",()=>{const c=_e.element.querySelector("#embeddingProvider").value;_e.showMessage(`\u6B63\u5728\u83B7\u53D6${c}\u7684\u53EF\u7528\u6A21\u578B...`,"info"),A("/api/ai/getEmbeddingModels",{provider:c},d=>{const u=_e.element.querySelector("#aiTestResults");d.code===0?(u.textContent=`\u2705 ${c}\u53EF\u7528\u6A21\u578B:
`+JSON.stringify(d.data,null,2),_e.showMessage("\u6A21\u578B\u5217\u8868\u83B7\u53D6\u6210\u529F","success")):(u.textContent="\u274C \u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25: "+d.msg,_e.showMessage("\u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25","error"))})});const l=_e.element.querySelector("#semanticSearchTest");l&&l.addEventListener("click",()=>{const c=_e.element.querySelector("#semanticSearchQuery").value;if(!c.trim()){_e.showMessage("\u8BF7\u8F93\u5165\u641C\u7D22\u67E5\u8BE2","warning");return}_e.showMessage("\u6B63\u5728\u6267\u884C\u8BED\u4E49\u641C\u7D22...","info"),A("/api/ai/semanticSearch",{query:c,limit:10},d=>{const u=_e.element.querySelector("#aiTestResults");d.code===0?(u.textContent=`\u2705 \u8BED\u4E49\u641C\u7D22\u7ED3\u679C:
`+JSON.stringify(d.data,null,2),_e.showMessage("\u8BED\u4E49\u641C\u7D22\u5B8C\u6210","success")):(u.textContent="\u274C \u8BED\u4E49\u641C\u7D22\u5931\u8D25: "+d.msg,_e.showMessage("\u8BED\u4E49\u641C\u7D22\u5931\u8D25","error"))})});const o=_e.element.querySelector("#notebookSummaryTest");o&&o.addEventListener("click",()=>{const c=_e.element.querySelector("#notebookSummaryId").value;if(!c.trim()){_e.showMessage("\u8BF7\u8F93\u5165\u7B14\u8BB0\u672CID","warning");return}_e.showMessage("\u6B63\u5728\u751F\u6210\u7B14\u8BB0\u672C\u6458\u8981...","info"),A("/api/ai/generateNotebookSummary",{notebookId:c},d=>{const u=_e.element.querySelector("#aiTestResults");d.code===0?(u.textContent=`\u2705 \u7B14\u8BB0\u672C\u6458\u8981:
`+JSON.stringify(d.data,null,2),_e.showMessage("\u6458\u8981\u751F\u6210\u5B8C\u6210","success")):(u.textContent="\u274C \u6458\u8981\u751F\u6210\u5931\u8D25: "+d.msg,_e.showMessage("\u6458\u8981\u751F\u6210\u5931\u8D25","error"))})});const r=_e.element.querySelector("#batchVectorizeTest");r&&r.addEventListener("click",()=>{const c=_e.element.querySelector("#batchVectorizeNotebook").value;if(!c.trim()){_e.showMessage("\u8BF7\u8F93\u5165\u7B14\u8BB0\u672CID","warning");return}confirm("\u6279\u91CF\u5411\u91CF\u5316\u4F1A\u6D88\u8017API\u989D\u5EA6\uFF0C\u786E\u5B9A\u8981\u7EE7\u7EED\u5417\uFF1F")&&(_e.showMessage("\u6B63\u5728\u6267\u884C\u6279\u91CF\u5411\u91CF\u5316\uFF0C\u8BF7\u7A0D\u5019...","info"),A("/api/ai/batchVectorizeNotebook",{notebookId:c},d=>{const u=_e.element.querySelector("#aiTestResults");d.code===0?(u.textContent=`\u2705 \u6279\u91CF\u5411\u91CF\u5316\u5B8C\u6210:
`+JSON.stringify(d.data,null,2),_e.showMessage("\u6279\u91CF\u5411\u91CF\u5316\u5B8C\u6210","success")):(u.textContent="\u274C \u6279\u91CF\u5411\u91CF\u5316\u5931\u8D25: "+d.msg,_e.showMessage("\u6279\u91CF\u5411\u91CF\u5316\u5931\u8D25","error"))}))})},showMessage:(t,e="info")=>{const n=document.createElement("div");n.className=`b3-dialog__message b3-dialog__message--${e}`,n.textContent=t,n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.zIndex="1000",document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},3e3)}},ta={element:void 0,genHTML:()=>{let t=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.reviewMode}
        <div class="b3-label__text">${window.siyuan.languages.reviewModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="reviewMode">
      <option value="0" ${window.siyuan.config.flashcard.reviewMode===0?"selected":""}>${window.siyuan.languages.reviewMode0}</option>
      <option value="1" ${window.siyuan.config.flashcard.reviewMode===1?"selected":""}>${window.siyuan.languages.reviewMode1}</option>
      <option value="2" ${window.siyuan.config.flashcard.reviewMode===2?"selected":""}>${window.siyuan.languages.reviewMode2}</option>
    </select>    
</div>`;return t=`${t}<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardNewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardReviewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.flashcardFSRSParamWeights}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    </div>
</div>`,t},bindEvent:()=>{ta.element.querySelectorAll("input, select.b3-select").forEach(t=>{t.addEventListener("change",()=>{A("/api/setting/setFlashcard",{reviewMode:parseInt(ta.element.querySelector("#reviewMode").value),newCardLimit:parseInt(ta.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(ta.element.querySelector("#reviewCardLimit").value),mark:ta.element.querySelector("#mark").checked,list:ta.element.querySelector("#list").checked,superBlock:ta.element.querySelector("#superBlock").checked,heading:ta.element.querySelector("#heading").checked,deck:ta.element.querySelector("#deck").checked,requestRetention:parseFloat(ta.element.querySelector("#requestRetention").value),maximumInterval:parseInt(ta.element.querySelector("#maximumInterval").value),weights:ta.element.querySelector("#weights").value},e=>{window.siyuan.config.flashcard=e.data})})})}},ln={element:void 0,genHTML:()=>{const t=Y();return`
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishService}
        <div class="b3-label__text">${window.siyuan.languages.publishServiceTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="publishEnable" type="checkbox"${window.siyuan.config.publish.enable?" checked":""}/>
</label>
<div class="b3-label">
    ${t?`
${window.siyuan.languages.publishServicePort}
<span class="fn__hr"></span>
<input class="b3-text-field fn__block" id="publishPort" type="number" min="0" max="65535" value="${window.siyuan.config.publish.port}">
<div class="b3-label__text">${window.siyuan.languages.publishServicePortTip}</div>`:`
<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishServicePort}
        <div class="b3-label__text">${window.siyuan.languages.publishServicePortTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="publishPort" type="number" min="0" max="65535" value="${window.siyuan.config.publish.port}">
</div>`}
</div>
<div class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.publishServiceAddresses}
            <div class="b3-label__text">${window.siyuan.languages.publishServiceAddressesTip}</div>
        </div>
        <div class="fn__space"></div>
    </div>
    <div class="fn__hr"></div>
    <div id="publishAddresses">
    </div>
</div>
<div class="b3-label">
    <label class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.publishServiceAuth}
            <div class="b3-label__text">${window.siyuan.languages.publishServiceAuthTip}</div>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" id="publishAuthEnable" type="checkbox"${window.siyuan.config.publish.auth.enable?" checked":""}/>
    </label>
</div>
<div class="b3-label">
    ${t?`
${window.siyuan.languages.publishServiceAuthAccounts}
<div class="b3-label__text">${window.siyuan.languages.publishServiceAuthAccountsTip}</div>
<div class="b3-label b3-label--inner fn__flex">
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--outline fn__size200 fn__flex-center" id="publishAuthAccountAdd">
        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.publishServiceAuthAccountAdd}
    </button>
</div>`:`
<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishServiceAuthAccounts}
        <div class="b3-label__text">${window.siyuan.languages.publishServiceAuthAccountsTip}</div>
    </div>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200 fn__flex-center" id="publishAuthAccountAdd">
        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.publishServiceAuthAccountAdd}
    </button>
</div>`}
    <div class="fn__flex-1" id="publishAuthAccounts">
    </div>
</div>
`},bindEvent:()=>{ln.element.querySelector("#publishAuthAccountAdd").addEventListener("click",()=>{window.siyuan.config.publish.auth.accounts.push({username:"",password:"",memo:""}),ln._renderPublishAuthAccounts(ln.element)}),ln.element.querySelectorAll("input").forEach(e=>{e.addEventListener("change",()=>{ln._savePublish()})}),ln._refreshPublish()},_refreshPublish:()=>{A("/api/setting/getPublish",{},ln._updatePublishConfig.bind(null,!0))},_savePublish:(t=!0)=>{const e=ln.element.querySelector("#publishEnable"),n=ln.element.querySelector("#publishPort"),a=ln.element.querySelector("#publishAuthEnable");A("/api/setting/setPublish",{enable:e.checked,port:n.valueAsNumber,auth:{enable:a.checked,accounts:window.siyuan.config.publish.auth.accounts}},ln._updatePublishConfig.bind(null,t))},_updatePublishConfig:(t,e)=>{e.code===0?(window.siyuan.config.publish=e.data.publish,t&&ln._renderPublishAuthAccounts(ln.element),ln._renderPublishAddressList(ln.element,e.data.port)):ln._renderPublishAddressList(ln.element,0)},_renderPublishAuthAccounts:(t,e=window.siyuan.config.publish.auth.accounts)=>{const n=Y(),a=t.querySelector("#publishAuthAccounts");a.innerHTML=`<div class="fn__hr"></div><ul class="fn__flex-1">${e.map((i,s)=>`
<li class="b3-label b3-label--inner fn__flex" data-index="${s}">
    <input class="b3-text-field fn__block" data-name="username" value="${i.username}" placeholder="${window.siyuan.languages.userName}">
    <span class="fn__space"></span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field fn__block b3-form__icona-input" type="password" data-name="password" value="${i.password}" placeholder="${window.siyuan.languages.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__block" data-name="memo" value="${i.memo}" placeholder="${window.siyuan.languages.memo}">
    <span class="fn__space"></span>
    ${n?`
<button class="b3-button b3-button--outline fn__block" data-action="remove">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.delete}
</button>`:`
<span data-action="remove" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`}
</li>
`).join("")}</ul>`,a.querySelectorAll("input").forEach(i=>{i.addEventListener("change",()=>{const s=U(i,"LI");if(s){const l=parseInt(s.dataset.index),o=i.dataset.name;o in window.siyuan.config.publish.auth.accounts[l]&&(window.siyuan.config.publish.auth.accounts[l][o]=i.value,ln._savePublish(!1))}})}),a.querySelectorAll('[data-action="remove"]').forEach(i=>{i.addEventListener("click",()=>{const s=U(i,"LI");if(s){const l=parseInt(s.dataset.index);window.siyuan.config.publish.auth.accounts.splice(l,1),ln._savePublish()}})}),a.querySelectorAll('.b3-form__icona-icon[data-action="togglePassword"]').forEach(i=>{i.addEventListener("click",()=>{const s=i.firstElementChild.getAttribute("xlink:href")==="#iconEye";i.firstElementChild.setAttribute("xlink:href",s?"#iconEyeoff":"#iconEye"),i.previousElementSibling.setAttribute("type",s?"text":"password")})})},_renderPublishAddressList:(t,e)=>{const n=t.querySelector("#publishAddresses");e===0?n.innerText=window.siyuan.languages.publishServiceNotStarted:n.innerHTML=`<ul class="b3-list fn__flex-1" style="padding: 2px 0;">${window.siyuan.config.localIPs.filter(a=>!(a.startsWith("[")&&a.endsWith("]"))).map(a=>`<li><code class="fn__code">${a}:${e}</code></li>`).join("")}${window.siyuan.config.localIPs.filter(a=>a.startsWith("[")&&a.endsWith("]")).map(a=>`<li><code class="fn__code">${a}:${e}</code></li>`).join("")}</ul>`}},DS=(t,e,n)=>{switch(t){case"filetree":e.innerHTML=Qt.genHTML(),Qt.element=e,Qt.bindEvent();break;case"AI":e.innerHTML=_e.genHTML(),_e.element=e,_e.bindEvent();break;case"card":e.innerHTML=ta.genHTML(),ta.element=e,ta.bindEvent();break;case"image":e.innerHTML=Wa.genHTML(),Wa.element=e,Wa.bindEvent();break;case"export":e.innerHTML=ct.genHTML(),ct.element=e,ct.bindEvent();break;case"appearance":e.innerHTML=It.genHTML(),It.element=e,It.bindEvent();break;case"keymap":e.innerHTML=St.genHTML(n),St.element=e,St.bindEvent(n);break;case"bazaar":Ce.element=e,e.innerHTML=Ce.genHTML(),Ce.bindEvent(n);break;case"account":e.innerHTML=tn.genHTML(),tn.element=e,tn.bindEvent(tn.element);break;case"repos":e.innerHTML=en.genHTML(),en.element=e,en.bindEvent();break;case"about":e.innerHTML=Rt.genHTML(),Rt.element=e,Rt.bindEvent();break;case"search":e.innerHTML=st.genHTML(),st.element=e,st.bindEvent();break;case"publish":e.innerHTML=ln.genHTML(),ln.element=e,ln.bindEvent();break;default:break}},Kl=t=>{const e=window.siyuan.dialogs.find(i=>{if(i.element.querySelector(".config__tab-container"))return i.destroy(),!0});if(e)return e;let n;getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0));const a=new $e({content:`<div class="fn__flex-1 fn__flex config__panel" style="overflow: hidden;position: relative">
  <ul class="b3-tab-bar b3-list b3-list--background">
    <div class="config__tab-title resize__move">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSettings"></use></svg>
        <span class="b3-list-item__text">${window.siyuan.languages.config}</span>
    </div>
    <div class="b3-form__icon"><svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg><input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input"></div>
    <div class="config__tab-hr"></div>
    <li data-name="editor" class="b3-list-item--focus b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconEdit"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.editor}</span></li>
    <li data-name="filetree" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconFiles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.fileTree}</span></li>
    <li data-name="card" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span></li>
    <li data-name="AI" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI</span></li>
    <li data-name="image" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></li>
    <li data-name="export" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconUpload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.export}</span></li>
    <li data-name="appearance" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconTheme"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.appearance}</span></li>
    <li data-name="bazaar" class="b3-list-item${Df()||bt()?" fn__none":""}"><svg class="b3-list-item__graphic"><use xlink:href="#iconBazaar"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bazaar}</span></li>
    <li data-name="search" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.search}</span></li>
    <li data-name="keymap" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.keymap}</span></li>
    <li data-name="account" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.account}</span></li>
    <li data-name="repos" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconCloud"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.cloud}</span></li>
    <li data-name="publish" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.publish}</span></li>
    <li data-name="about" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconInfo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.about}</span></li>
  </ul>
  <div class="config__tab-wrap">
      <div class="fn__hr--b resize__move"></div>
      <div class="config__tab-container" data-name="editor">${qe.genHTML()}</div>
      <div class="config__tab-container fn__none" data-name="filetree"></div>
      <div class="config__tab-container fn__none" data-name="card"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="AI"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="image"></div>
      <div class="config__tab-container fn__none" data-name="export"></div>
      <div class="config__tab-container fn__none" data-name="appearance"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="bazaar"></div>
      <div class="config__tab-container fn__none" data-name="search"></div>
      <div class="config__tab-container fn__none" style="overflow: scroll" data-name="keymap"></div>
      <div class="config__tab-container config__tab-container--full fn__none" data-name="account"></div>
      <div class="config__tab-container fn__none" data-name="repos"></div>
      <div class="config__tab-container fn__none" data-name="publish"></div>
      <div class="config__tab-container fn__none" data-name="about"></div>
      <div class="fn__hr--b"></div>
  </div>
</div>`,width:"90vw",height:"90vh",destroyCallback(){n&&ne(n)}});return a.element.setAttribute("data-key",p.DIALOG_SETTING),O1(a.element,t),a.element.querySelector(".b3-dialog__container").style.maxWidth="1280px",a.element.querySelectorAll(".b3-tab-bar .b3-list-item").forEach(i=>{i.addEventListener("click",()=>{const s=i.getAttribute("data-name"),l=a.element.querySelector(`.config__tab-container[data-name="${s}"]`);a.element.querySelectorAll(".config__tab-container").forEach(o=>{o.classList.add("fn__none")}),a.element.querySelector(".b3-tab-bar .b3-list-item.b3-list-item--focus").classList.remove("b3-list-item--focus"),i.classList.add("b3-list-item--focus"),l.classList.remove("fn__none"),(l.innerHTML===""||s==="repos"||s==="bazaar")&&DS(s,l,t)})}),qe.element=a.element.querySelector('.config__tab-container[data-name="editor"]'),qe.bindEvent(),a};var F1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});let IS,$S;$S=t=>{if(t.doc&&t.doc.id){y1(t.doc.id,{position:t.position,width:t.width,height:t.height});return}if(t.tab){mS(t.tab,{position:t.position,width:t.width,height:t.height});return}},IS=t=>{if(t.doc)return t.doc.zoomIn&&(t.doc.action&&!t.doc.action.includes(p.CB_GET_ALL)?t.doc.action.push(p.CB_GET_ALL):t.doc.action=[p.CB_GET_ALL]),t.doc.action||(t.doc.action=[]),ve({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,id:t.doc.id,action:t.doc.action,zoomIn:t.doc.zoomIn});if(t.asset)return ea({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,assetPath:t.asset.path});if(t.pdf)return ea({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,assetPath:t.pdf.path,page:t.pdf.id||t.pdf.page});if(t.search)return t.search.idPath||(t.search.idPath=[]),t.search.hPath||(t.search.hPath=""),ea({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,searchData:t.search});if(t.card)return ea({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardType:t.card.type,id:t.card.id||"",title:t.card.title},id:"siyuan-card"}});if(t.custom)return ea(t)};const MS=t=>nt(t).data[t],U1={adaptHotkey:pe,confirm:Re,Constants:p,showMessage:de,hideMessage:At,fetchPost:A,fetchSyncPost:Ae,fetchGet:Qk,getFrontend:ie,getBackend:re,getModelByDockType:MS,openTab:IS,openWindow:$S,openMobileFileById:xx,lockScreen:jp,exitSiYuan:Ns,Protyle:ba,Plugin:gS,Dialog:$e,Menu:dt,Setting:_1,getAllEditor:qn,getActiveTab:ya,getAllModels:Oe,getActiveEditor:(t=!0)=>{let e;const n=getSelection().rangeCount>0?getSelection().getRangeAt(0):null,a=qn();if(n&&(e=a.find(i=>{if(i.protyle.element.contains(n.startContainer))return!0})),e||(e=a.find(i=>{if(T(i.protyle.element,"layout__wnd--active",!0))return!0})),!e&&!t){let i=0;a.forEach(s=>{var l;let o=(l=s.protyle.model)==null?void 0:l.parent.headElement;if(!o&&s.protyle.element.getBoundingClientRect().height>0){const r=s.protyle.element.closest(".fn__flex-1[data-id]");r&&(o=document.querySelector(`.layout-tab-bar .item[data-id="${r.getAttribute("data-id")}"]`))}o?o.classList.contains("item--focus")&&parseInt(o.dataset.activetime)>i&&(i=parseInt(o.dataset.activetime),e=s):s.protyle.element.getBoundingClientRect().height>0&&(e=s)})}return e},platformUtils:vt,openSetting:Kl,openAttributePanel:t=>{t.data?fa(t.data,t.focusName,t.protyle):xi(t.nodeElement,t.focusName,t.protyle)},saveLayout:t=>{Un({cb:t,errorExit:!1})},globalCommand:mi,expandDocTree:t=>F1(void 0,null,function*(){var e;let n=!1;window.siyuan.notebooks.find(o=>{if(t.id===o.id)return n=!0,!0});let a,i=t.id;const s=MS("file");if(typeof t.isSetCurrent=="undefined"&&(t.isSetCurrent=!0),n)a=(e=s.element.querySelector(`.b3-list[data-url="${t.id}"]`))==null?void 0:e.firstElementChild;else{const o=yield Ae("api/block/getBlockInfo",{id:t.id});if(o.code===-1)return;i=o.data.box,a=yield s.selectItem(o.data.box,o.data.path,void 0,void 0,t.isSetCurrent)}!a||((t.isSetCurrent||typeof t.isSetCurrent=="undefined")&&s.setCurrent(a),a.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open"))||s.getLeaf(a,i)})};var og=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const PS=t=>{var e,n;return(n={siyuan:U1}[t])!=null?n:(e=window.require)==null?void 0:e.call(window,t)};window.require instanceof Function&&(PS.__proto__=window.require);const W1=(t,e)=>window.eval("(function anonymous(require, module, exports){".concat(t,`
})
//# sourceURL=`).concat(e,`
`)),Sy=(t,e)=>og(void 0,null,function*(){const n=yield Ae("/api/petal/loadPetals",{frontend:ie()});let a='<style id="pluginsStyle"></style>';n.data.forEach(s=>{(!e||e&&e.includes(s.name))&&NS(t,s),s.css&&(a+=`<style id="pluginsStyle${s.name}">${s.css}</style>`)});const i=document.getElementById("pluginsStyle");i?i.insertAdjacentHTML("afterend",a):document.head.insertAdjacentHTML("beforeend",a)}),NS=(t,e)=>og(void 0,null,function*(){const n={},a={exports:n};try{W1(e.js,"plugin:"+encodeURIComponent(e.name))(PS,a,n)}catch(l){console.error(`plugin ${e.name} run error:`,l);return}const i=(a.exports||n).default||a.exports;if(typeof i!="function"){console.error(`plugin ${e.name} has no export`);return}if(!(i.prototype instanceof gS)){console.error(`plugin ${e.name} does not extends Plugin`);return}const s=new i({app:t,displayName:e.displayName,name:e.name,i18n:e.i18n});t.plugins.push(s);try{yield s.onload()}catch(l){console.error(`plugin ${e.name} onload error:`,l)}return s}),HS=(t,e)=>og(void 0,null,function*(){const n=yield NS(t,e);if(e.css){const a=document.createElement("style");a.id="pluginsStyle"+e.name,a.textContent=e.css,document.head.append(a)}return rg(n),bn(),qn().forEach(a=>{a.protyle.toolbar.update(a.protyle)}),n}),Ly=(t,e,n,a)=>{const i=Object.keys(n.docks);t.forEach((s,l)=>{i.includes(s.type)&&(a==="Left"?n.docks[s.type].config.position=e===0?"LeftTop":"LeftBottom":a==="Right"?n.docks[s.type].config.position=e===0?"RightTop":"RightBottom":a==="Bottom"&&(n.docks[s.type].config.position=e===0?"BottomLeft":"BottomRight"),n.docks[s.type].config.index=l,n.docks[s.type].config.show=s.show,n.docks[s.type].config.size=s.size,window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][n.name]||(window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][n.name]={}),window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][n.name][s.type]=n.docks[s.type].config,Ee(p.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS]))})},rg=t=>{try{t.onLayoutReady()}catch(e){console.error(`plugin ${t.name} onLayoutReady error:`,e)}(!ue()||Y())&&t.topBarIcons.forEach(e=>{document.contains(e)||(Y()?window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(e.id)||document.querySelector("#menuAbout").after(e):ue()||(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(e.id)&&e.classList.add("fn__none"),document.querySelector("#"+(e.getAttribute("data-location")==="right"?"barPlugins":"drag")).before(e)))}),Ed(),t.statusBarIcons.forEach(e=>{if(document.contains(e))return;const n=document.getElementById("status");e.getAttribute("data-location")==="right"?n.insertAdjacentElement("beforeend",e):n.insertAdjacentElement("afterbegin",e)}),!ue()&&(window.siyuan.config.uiLayout.left.data.forEach((e,n)=>{Ly(e,n,t,"Left")}),window.siyuan.config.uiLayout.right.data.forEach((e,n)=>{Ly(e,n,t,"Right")}),window.siyuan.config.uiLayout.bottom.data.forEach((e,n)=>{Ly(e,n,t,"Bottom")}),Object.keys(t.docks).forEach(e=>{var n;window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][t.name]&&window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][t.name][e]&&(t.docks[e].config=window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][t.name][e]);const a=t.docks[e],i=window.siyuan.config.keymap.plugin[t.name]?(n=window.siyuan.config.keymap.plugin[t.name][e])==null?void 0:n.custom:void 0;a.config.position.startsWith("Left")?window.siyuan.layout.leftDock.genButton([{type:e,size:a.config.size,show:a.config.show,icon:a.config.icon,title:a.config.title,hotkey:i}],a.config.position==="LeftBottom"?1:0,a.config.index):a.config.position.startsWith("Bottom")?window.siyuan.layout.bottomDock.genButton([{type:e,size:a.config.size,show:a.config.show,icon:a.config.icon,title:a.config.title,hotkey:i}],a.config.position==="BottomRight"?1:0,a.config.index):a.config.position.startsWith("Right")&&window.siyuan.layout.rightDock.genButton([{type:e,size:a.config.size,show:a.config.show,icon:a.config.icon,title:a.config.title,hotkey:i}],a.config.position==="RightBottom"?1:0,a.config.index)}))},OS=(t,e)=>og(void 0,null,function*(){e.removePlugins.forEach(n=>{lg(t,n,!0)}),e.upsertPlugins.forEach(n=>{lg(t,n,!1)}),Sy(t,e.upsertPlugins).then(()=>{t.plugins.forEach(n=>{e.upsertPlugins.includes(n.name)&&rg(n)})}),bn()});var V1=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const gt=(t,e=!0)=>{var n,a;t.getAttribute("data-type")==="wnd"&&gd(((n=t.querySelector('.layout-tab-bar .item--focus[data-type="tab-header"] .item__text'))==null?void 0:n.textContent)||window.siyuan.languages.siyuanNote),!(t.classList.contains("layout__tab--active")||t.classList.contains("layout__wnd--active"))&&(document.querySelectorAll(".layout__tab--active").forEach(i=>{i.classList.remove("layout__tab--active")}),document.querySelectorAll(".dock__item--activefocus").forEach(i=>{i.classList.remove("dock__item--activefocus")}),document.querySelectorAll(".layout__wnd--active").forEach(i=>{i.classList.remove("layout__wnd--active")}),t.getAttribute("data-type")==="wnd"?(t.classList.add("layout__wnd--active"),(a=t.querySelector(".layout-tab-bar .item--focus"))==null||a.setAttribute("data-activetime",new Date().getTime().toString()),e&&bn()):(t.classList.add("layout__tab--active"),Array.from(t.classList).find(i=>{if(i.startsWith("sy__"))return document.querySelector(`.dock__item[data-type="${i.substring(4)}"]`).classList.add("dock__item--activefocus"),!0})))},Ay=(t,e)=>{const n=[];e.children.forEach(a=>{if(a.model instanceof Ot&&a.model.editor.protyle.toolbar.range){const i=B(a.model.editor.protyle.toolbar.range.startContainer);if(i){const s=_t(i,void 0,a.model.editor.protyle.toolbar.range);n.push({id:i.getAttribute("data-node-id"),start:s.start,end:s.end})}}}),t.element.after(e.element),e.children.forEach(a=>{if(a.model instanceof Ot){const i=n.splice(0,1)[0];if(!i)return;const s=ha(a.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),i.start,i.end);s&&(a.model.editor.protyle.toolbar.range=s)}}),t.element.after(t.element.previousElementSibling),t.parent.children.find((a,i)=>{if(a.id===t.id){const s=t.parent.children[i].resize;t.parent.children[i].resize=t.parent.children[i-1].resize,t.parent.children[i-1].resize=s;const l=a;return t.parent.children[i]=t.parent.children[i-1],t.parent.children[i-1]=l,!0}})},br=t=>{const e=[];return pr(t,e),e.sort((n,a)=>{var i,s;if(((i=n.element.querySelector(".fn__flex .item--focus"))==null?void 0:i.getAttribute("data-activetime"))>((s=a.element.querySelector(".fn__flex .item--focus"))==null?void 0:s.getAttribute("data-activetime")))return-1})[0]},ss=t=>{const e=[],n=s=>{const l=[];return t.element.querySelectorAll(`span[data-index="${s}"]`).forEach(o=>{l.push({type:o.getAttribute("data-type"),size:{height:parseInt(o.getAttribute("data-height")),width:parseInt(o.getAttribute("data-width"))},title:o.getAttribute("data-title"),show:o.classList.contains("dock__item--active"),icon:o.querySelector("use").getAttribute("xlink:href").substring(1),hotkey:o.getAttribute("data-hotkey")||"",hotkeyLangId:o.getAttribute("data-hotkeyLangId")||""})}),l},a=n(0),i=n(1);return(a.length>0||i.length>0)&&e.push(a),i.length>0&&e.push(i),{pin:t.pin,data:e}},BS=()=>{window.siyuan.config.readonly?window.location.reload():A("/api/system/setUILayout",{layout:{}},()=>{window.siyuan.storage[p.LOCAL_FILEPOSITION]={},Ee(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION]),window.siyuan.storage[p.LOCAL_DIALOGPOSITION]={},Ee(p.LOCAL_DIALOGPOSITION,window.siyuan.storage[p.LOCAL_DIALOGPOSITION]),window.location.reload()})};let cg=0;const bn=()=>{const t={};let e={};if(ue())e={layout:{}},$i(window.siyuan.layout.layout,e.layout,t);else{const n=document.querySelector("#barDock use");n&&(e={hideDock:n.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:ss(window.siyuan.layout.bottomDock),left:ss(window.siyuan.layout.leftDock),right:ss(window.siyuan.layout.rightDock)},$i(window.siyuan.layout.layout,e.layout,t),window.siyuan.config.uiLayout=e)}Object.keys(t).length>0&&cg<10?(cg++,setTimeout(()=>{bn()},p.TIMEOUT_LOAD*cg)):(cg=0,ue()?sessionStorage.setItem("layout",JSON.stringify(e)):window.siyuan.config.readonly||A("/api/system/setUILayout",{layout:e,errorExit:!1}))},Un=t=>V1(void 0,null,function*(){const e=Oe().editor;for(let i=0;i<e.length;i++)yield xc(e[i].editor.protyle);if(ue()){const i={layout:{}};$i(window.siyuan.layout.layout,i.layout),sessionStorage.setItem("layout",JSON.stringify(i)),t.cb();return}const n=document.querySelector("#barDock use");if(!n)return;const a={hideDock:n.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:ss(window.siyuan.layout.bottomDock),left:ss(window.siyuan.layout.leftDock),right:ss(window.siyuan.layout.rightDock)};$i(window.siyuan.layout.layout,a.layout),window.siyuan.config.readonly?t.cb():A("/api/system/setUILayout",{layout:a,errorExit:t.errorExit},()=>{t.cb()})}),xy=()=>{const t={hideDock:document.querySelector("#barDock use").getAttribute("xlink:href")==="#iconDock",layout:{},bottom:ss(window.siyuan.layout.bottomDock),left:ss(window.siyuan.layout.leftDock),right:ss(window.siyuan.layout.rightDock)};return $i(window.siyuan.layout.layout,t.layout),t},dg=t=>{t.forEach(e=>{var n;e.hotkeyLangId&&(e.title=window.siyuan.languages[e.hotkeyLangId]||e.hotkeyLangId,e.hotkeyLangId==="ai"&&(e.title="AI Chat"),e.hotkey=((n=window.siyuan.config.keymap.general[e.hotkeyLangId])==null?void 0:n.custom)||"")})},Y1=(t,e)=>{t.left.data.forEach(a=>{dg(a)}),t.right.data.forEach(a=>{dg(a)});let n=!1;t.right.data.forEach(a=>{a.forEach(i=>{i.type==="ai"&&(n=!0)})}),n||(t.right.data[0]||(t.right.data[0]=[]),t.right.data[0].push({type:"ai",size:{width:320,height:0},show:!0,icon:"iconSparkles",hotkeyLangId:"ai"}),dg(t.right.data[0])),t.bottom.data.forEach(a=>{dg(a)}),window.siyuan.layout.centerLayout=window.siyuan.layout.layout.children[0].children[1],window.siyuan.layout.leftDock=new hy({position:"Left",data:t.left,app:e}),window.siyuan.layout.rightDock=new hy({position:"Right",data:t.right,app:e}),window.siyuan.layout.bottomDock=new hy({position:"Bottom",data:t.bottom,app:e})},RS=[],Cy=(t,e,n)=>{let a;if(e.instance==="Layout"){for(;e.children.length===1&&e.children[0].instance==="Layout"&&e.children[0].type==="normal"&&e.children[0].children.length===1;)e.children=e.children[0].children;n?(a=new Ua({direction:e.direction,size:e.size,type:e.type,resize:e.resize}),n.addLayout(a)):window.siyuan.layout.layout=new Ua({element:document.getElementById("layouts"),direction:e.direction,size:e.size,type:e.type,resize:e.resize})}else if(e.instance==="Wnd")a=new fd(t,e.resize,n.type),n.addWnd(a),e.width&&(a.element.classList.remove("fn__flex-1"),a.element.style.width=e.width),e.height&&(a.element.classList.remove("fn__flex-1"),a.element.style.height=e.height);else if(e.instance==="Tab"){if(!e.title)a=pS(t);else{let i=e.title;e.lang&&(i=window.siyuan.languages[e.lang]),a=new Dt({icon:e.icon,docIcon:e.docIcon,title:i})}e.pin&&(a.headElement.classList.add("item--pin"),(e.docIcon||e.icon)&&a.headElement.querySelector(".item__text").classList.add("fn__none")),e.active&&a.headElement&&a.headElement.setAttribute("data-init-active","true"),n.addTab(a,!1,!1,e.activeTime)}else e.instance==="Editor"&&e.blockId?(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.headElement.classList.add("item--unupdate"),n.headElement.setAttribute("data-initdata",JSON.stringify(e))):e.instance==="Asset"?n.addModel(new ts({app:t,tab:n,path:e.path,page:e.page})):e.instance==="Backlink"?n.addModel(new Zi({app:t,tab:n,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Bookmark"?n.addModel(new Wl(t,n)):e.instance==="Files"?n.addModel(new Ki({app:t,tab:n})):e.instance==="Graph"?n.addModel(new Ii({app:t,tab:n,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Outline"?n.addModel(new Is({app:t,tab:n,blockId:e.blockId,type:e.type,isPreview:e.isPreview})):e.instance==="Tag"?n.addModel(new Ps(t,n)):e.instance==="AI"?n.addModel(new gy(t,n)):e.instance==="Search"?n.addModel(new ns({app:t,tab:n,config:e.config})):e.instance==="Custom"&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.headElement.classList.add("item--unupdate"),n.headElement.setAttribute("data-initdata",JSON.stringify(e)));"children"in e&&(Array.isArray(e.children)?e.children.forEach(i=>{Cy(t,i,n?a:window.siyuan.layout.layout)}):e.children&&Object.keys(e.children).length>0?Cy(t,e.children,a):a instanceof Dt&&RS.push(a))},z1=(t,e)=>{Cy(t,window.siyuan.config.uiLayout.layout,void 0),Y1(window.siyuan.config.uiLayout,t),window.siyuan.config.fileTree.closeTabsOnStart&&(sessionStorage.getItem(p.LOCAL_SESSION_FIRSTLOAD)||(pi().forEach(a=>{a.headElement&&!a.headElement.classList.contains("item--pin")&&a.parent.removeTab(a.id,!1,!1,!1)}),sessionStorage.setItem(p.LOCAL_SESSION_FIRSTLOAD,"true"))),document.querySelectorAll('li[data-type="tab-header"]').forEach(a=>{const i=a.getAttribute("data-initdata");if(i){const s=JSON.parse(i);if(s.instance==="Custom"&&s.customModelType!=="siyuan-card"){let l=!1;if(t.plugins.find(o=>{if(Object.keys(o.models).includes(s.customModelType))return l=!0,!0}),!l){const o=a.getAttribute("data-id"),r=on(o);r&&r.parent.removeTab(o,!1,!1,!1)}}}});const n=bA();if(n.id)ve({app:t,id:n.id,action:n.isZoomIn?[p.CB_GET_ALL,p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],zoomIn:n.isZoomIn});else{let a;document.querySelectorAll('li[data-type="tab-header"][data-init-active="true"]').forEach(i=>{a?i.dataset.activetime>a.dataset.activetime&&(a=i):a=i;const s=on(i.getAttribute("data-id"));s.parent.switchTab(i,!1,!1,!0,!1),s.parent.showHeading()}),a&&gt(a.parentElement.parentElement.parentElement,!1),RS.forEach(i=>{i.parent.removeTab(i.id,!1,!1,!1)})}t.plugins.forEach(a=>{rg(a)}),bn(),Ed()},$i=(t,e,n)=>{var a;t instanceof Ua?(e.direction=t.direction,t.parent&&(t.element.classList.contains("fn__flex-1")?e.size="auto":e.size=(t.parent.direction==="tb"?t.element.clientHeight:t.element.clientWidth)+"px"),e.resize=t.resize,e.type=t.type,e.instance="Layout"):t instanceof fd?(e.resize=t.resize,e.height=t.element.style.height,e.width=t.element.style.width,e.instance="Wnd"):t instanceof Dt?(t.headElement&&(e.title=t.title,e.icon=t.icon,e.docIcon=t.docIcon,e.pin=t.headElement.classList.contains("item--pin"),t.model instanceof Ki?e.lang="fileTree":t.model instanceof Zi&&t.model.type==="pin"?e.lang="backlinks":t.model instanceof Wl?e.lang="bookmark":t.model instanceof Ii&&t.model.type!=="local"?e.lang="graphView":t.model instanceof Is&&t.model.type!=="local"?e.lang="outline":t.model instanceof Ps&&(e.lang="tag"),t.headElement.classList.contains("item--focus")&&(e.active=!0)),e.instance="Tab",e.activeTime=(a=t.headElement)==null?void 0:a.getAttribute("data-activetime")):t instanceof Ot?(!t.editor.protyle.notebookId&&n&&(n.editor="true"),e.notebookId=t.editor.protyle.notebookId,e.blockId=t.editor.protyle.block.id,e.rootId=t.editor.protyle.block.rootID,e.mode=t.editor.protyle.preview.element.classList.contains("fn__none")?"wysiwyg":"preview",e.action=t.editor.protyle.block.showAll&&t.editor.protyle.block.id!==t.editor.protyle.block.rootID?p.CB_GET_ALL:p.CB_GET_SCROLL,e.instance="Editor"):t instanceof ts?(e.path=t.path,t.pdfObject&&(e.page=t.pdfObject.page),e.instance="Asset"):t instanceof Zi?(e.blockId=t.blockId,e.rootId=t.rootId,e.type=t.type,e.instance="Backlink"):t instanceof Wl?e.instance="Bookmark":t instanceof Ki?e.instance="Files":t instanceof Ii?(e.blockId=t.blockId,e.rootId=t.rootId,e.type=t.type,e.instance="Graph"):t instanceof Is?(e.blockId=t.blockId,e.type=t.type,e.isPreview=t.isPreview,e.instance="Outline"):t instanceof Ps?e.instance="Tag":t instanceof gy?e.instance="AI":t instanceof ns?(e.instance="Search",e.config=t.config):t instanceof fi&&(e.instance="Custom",e.customModelType=t.type,e.customModelData=Object.assign({},t.data)),t instanceof Ua||t instanceof fd?t instanceof Ua&&(t.type==="bottom"||t.type==="left"||t.type==="right")?t.type==="bottom"?e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]:e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]:(e.children=[],t.children.forEach(i=>{const s={};e.children.push(s),$i(i,s,n)})):t instanceof Dt&&(t.model?(e.children={},$i(t.model,e.children,n)):t.headElement?e.children=JSON.parse(t.headElement.getAttribute("data-initdata")||"{}"):e.children={})},Ed=()=>{const t=document.querySelector("#toolbar");if(!t)return;const e=t.querySelector("#drag");if(!e)return;e.style.padding="";const n=t.querySelector("#barMore");n.classList.remove("fn__none"),n.removeAttribute("data-hideids"),Array.from(t.querySelectorAll('[data-hide="true"]')).forEach(d=>{d.classList.remove("fn__none"),d.removeAttribute("data-hide")});let a=e.nextElementSibling;const i=[];for(;t.scrollWidth>t.clientWidth+2&&(i.push(a.id),a.classList.add("fn__none"),a.setAttribute("data-hide","true"),a=a.nextElementSibling,a.id!=="barMore"););let s=e.previousElementSibling;for(;t.scrollWidth>t.clientWidth+2&&(i.push(s.id),s.classList.add("fn__none"),s.setAttribute("data-hide","true"),s=s.previousElementSibling,s.id!=="barWorkspace"););i.length>0?n.classList.remove("fn__none"):n.classList.add("fn__none"),n.setAttribute("data-hideids",i.join(","));const l=e.clientWidth,o=e.getBoundingClientRect(),r=o.left,c=window.innerWidth-o.right;r>c&&r-c<l/3?e.style.paddingRight=r-c+"px":r<c&&c-r<l/3&&(e.style.paddingLeft=c-r+"px"),window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].forEach(d=>{var u;(u=t.querySelector("#"+d))==null||u.classList.add("fn__none")})},qS=(t,e,n)=>{let a;return n.instance==="Custom"?n.customModelType==="siyuan-card"?a=Jb({app:t,tab:e,data:n.customModelData}):t.plugins.find(i=>{if(i.models[n.customModelType])return a=i.models[n.customModelType]({tab:e,data:n.customModelData}),!0}):n.instance==="Editor"&&(n.rootId===n.blockId&&n.action&&(typeof n.action=="string"?n.action=n.action.replace(p.CB_GET_ALL,""):typeof n.action=="object"&&Array.isArray(n.action)&&(n.action=n.action.filter(i=>i!==p.CB_GET_ALL))),a=new Ot({app:t,tab:e,rootId:n.rootId,blockId:n.blockId,mode:n.mode,action:typeof n.action=="string"?n.action?[n.action,p.CB_GET_FOCUS]:[p.CB_GET_FOCUS]:n.action.concat(p.CB_GET_FOCUS)})),a},Zl=t=>{const e=!!t.querySelector('.layout-tab-container > [data-loading="true"]');return e&&de(window.siyuan.languages.pdfIsLoading),e},on=(t,e=window.siyuan.layout.centerLayout)=>{const n=(a,i)=>{if(a.id===i)return a;if(!a.children)return;let s;for(let l=0;l<a.children.length;l++)if(s=n(a.children[l],i),s)return s};return n(e,t)},FS=t=>{if(!t.resize)return;const e=i=>{let s=232;return Array.from(i.querySelectorAll(".file-tree")).find(l=>{if((l.classList.contains("sy__backlink")||l.classList.contains("sy__graph")||l.classList.contains("sy__globalGraph")||l.classList.contains("sy__inbox"))&&!l.classList.contains("fn__none")&&!T(l,"fn__none"))return s=320,!0}),s},n=(i,s)=>{const l=(r,c)=>{r.classList.contains("fn__flex-1")&&(c==="lr"?r.style.width=r.clientWidth+"px":r.style.height=r.clientHeight+"px",r.classList.remove("fn__flex-1"))};let o;i.addEventListener("mousedown",r=>{Oe().editor.forEach(h=>{h.editor&&h.editor.protyle&&h.element.parentElement&&ce(["gutter"],h.editor.protyle)}),getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0));const c=document,d=i.nextElementSibling,u=i.previousElementSibling;d.style.overflow="auto",u.style.overflow="auto",d.style.transition="none",u.style.transition="none",!d.nextElementSibling||d.nextElementSibling.classList.contains("layout__dockresize")?l(d,s):l(u,s);const m=r[s==="lr"?"clientX":"clientY"],f=s==="lr"?u.clientWidth:u.clientHeight,g=s==="lr"?d.clientWidth:d.clientHeight;c.ondragstart=()=>(document.querySelectorAll(".sy__file .b3-list-item").forEach(h=>{h.style.opacity==="0.38"&&(h.style.opacity="")}),!1),c.onmousemove=h=>{h.preventDefault(),h.stopPropagation();const b=f+(h[s==="lr"?"clientX":"clientY"]-m),y=g-(h[s==="lr"?"clientX":"clientY"]-m);b<8||y<8||window.siyuan.layout.leftDock&&window.siyuan.layout.leftDock.layout.element===u&&b<e(u)&&b<f||window.siyuan.layout.rightDock&&window.siyuan.layout.rightDock.layout.element===d&&y<e(d)&&y<g||window.siyuan.layout.bottomDock&&window.siyuan.layout.bottomDock.layout.element===d&&y<64&&y<g||(u.classList.contains("fn__flex-1")||(u.style[s==="lr"?"width":"height"]=b+"px"),d.classList.contains("fn__flex-1")||(d.style[s==="lr"?"width":"height"]=y+"px"))},c.onmouseup=()=>{c.onmousemove=null,c.onmouseup=null,c.ondragstart=null,c.onselectstart=null,c.onselect=null,kd(ue()?window.siyuan.layout.centerLayout:void 0),Sn(),ue()||(window.siyuan.layout.leftDock.setSize(),window.siyuan.layout.bottomDock.setSize(),window.siyuan.layout.rightDock.setSize()),o&&ne(o),d.style.overflow="",u.style.overflow="",d.style.transition="",u.style.transition=""}})},a=document.createElement("div");t.resize==="lr"&&a.classList.add("layout__resize--lr"),a.classList.add("layout__resize"),t.element.insertAdjacentElement("beforebegin",a),n(a,t.resize),a.addEventListener("dblclick",()=>{const i=a.previousElementSibling,s=a.nextElementSibling;if(i&&s){const l=["graph","inbox","globalGraph","backlink"];let o=232;s.style.transition="none",i.style.transition="none",a.classList.contains("layout__resize--lr")?i.classList.contains("layout__dockl")?(document.querySelectorAll("#dockLeft .dock__item--active").forEach(r=>{l.includes(r.getAttribute("data-type"))&&(o=320)}),i.style.width=o+"px",window.siyuan.layout.leftDock.setSize()):s.classList.contains("layout__dockr")?(document.querySelectorAll("#dockRight .dock__item--active").forEach(r=>{l.includes(r.getAttribute("data-type"))&&(o=320)}),s.style.width=o+"px",window.siyuan.layout.rightDock.setSize()):(i.style.width="",s.style.width="",i.classList.add("fn__flex-1"),s.classList.add("fn__flex-1"),a.parentElement.classList.contains("layout__dockb")&&window.siyuan.layout.bottomDock.setSize()):s.classList.contains("layout__dockb")?(s.style.height="232px",window.siyuan.layout.bottomDock.setSize()):(i.style.height="",s.style.height="",i.classList.add("fn__flex-1"),s.classList.add("fn__flex-1"),a.parentElement.classList.contains("layout__dockl")?window.siyuan.layout.leftDock.setSize():a.parentElement.classList.contains("layout__dockr")&&window.siyuan.layout.rightDock.setSize()),Sn(),s.style.transition="",i.style.transition=""}})},kd=(t=window.siyuan.layout.centerLayout.parent)=>{if(t.children.forEach(e=>{e.element.style.maxWidth="",!e.element.style.width&&!e.element.classList.contains("layout__center")?e.element.style.minWidth="8px":e.element.style.minWidth=""}),t.direction==="lr"&&t.element.scrollWidth>t.element.clientWidth+2){let e=Math.ceil(screen.width/8);for(;e>0;){let n=0;if(t.children.find(a=>{a.element.style.width&&a.element.style.width!=="0px"&&(a.element.style.maxWidth=Math.max(Math.min(a.element.clientWidth,window.innerWidth)-8,64)+"px"),n+=a.element.clientWidth}),e--,n<=t.element.clientWidth)break}}t.children.forEach(e=>{e instanceof Ua&&e.size!=="0px"&&kd(e)})},Ty=t=>{if(t.children.length<2||t.children[t.children.length-2].element.classList.contains("fn__flex-1"))return;t.children.forEach((n,a)=>{a!==t.children.length-2&&(t.direction==="lr"?n.element.classList.contains("fn__flex-1")&&(n.element.style.width=n.element.clientWidth+"px",n.element.classList.remove("fn__flex-1")):n.element.classList.contains("fn__flex-1")&&(n.element.style.height=n.element.clientHeight+"px",n.element.classList.remove("fn__flex-1")))});const e=t.children[t.children.length-2].element;t.direction==="lr"?e.style.width&&(e.style.width="",e.classList.add("fn__flex-1")):e.style.height&&(e.style.height="",e.classList.add("fn__flex-1"))},yr=(t,e)=>new N({label:window.siyuan.languages[t],icon:t.replace("moveTo","icon"),click:()=>{t.indexOf("moveToLeft")>-1?window.siyuan.layout.leftDock.add(t.endsWith("Top")?0:1,e):t.indexOf("moveToRight")>-1?window.siyuan.layout.rightDock.add(t.endsWith("Top")?0:1,e):t.indexOf("moveToBottom")>-1&&window.siyuan.layout.bottomDock.add(t.endsWith("Left")?0:1,e)}}),US=t=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(yr("moveToLeftTop",t).element),window.siyuan.menus.menu.append(yr("moveToLeftBottom",t).element),window.siyuan.menus.menu.append(yr("moveToRightTop",t).element),window.siyuan.menus.menu.append(yr("moveToRightBottom",t).element),window.siyuan.menus.menu.append(yr("moveToBottomLeft",t).element),window.siyuan.menus.menu.append(yr("moveToBottomRight",t).element),window.siyuan.menus.menu);class G1{constructor(e){this.menu=new CA,window.addEventListener("contextmenu",n=>{if(n.shiftKey)return;let a=n.target;if(T(a,"av__panel")&&!T(a,"b3-menu")){document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"})),n.stopPropagation(),n.preventDefault();return}for(a.classList.contains("b3-text-field")||a.tagName==="INPUT"&&a.type==="text"?n.stopPropagation():n.preventDefault();a&&a.parentElement&&!a.parentElement.isEqualNode(document.querySelector("body"));){const i=a.getAttribute("data-type");if(i==="tab-header"){this.unselect(),vS(e,on(a.getAttribute("data-id"))).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}else if(i==="navigation-root"&&!window.siyuan.config.readonly){if(a.querySelector(".b3-list-item__text").classList.contains("ft__on-surface"))return;this.unselect(),sp(e,a).popup({x:n.clientX,y:n.clientY}),gt(T(a,"sy__file")),n.stopPropagation();break}else if(i==="navigation-file"){this.unselect(),lp(e,this.getDir(a),a.getAttribute("data-path"),a).popup({x:n.clientX,y:n.clientY}),gt(T(a,"sy__file")),n.stopPropagation();break}else if(i==="search-item"){const s=a.getAttribute("data-node-id");s&&wS(s).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}else if(i&&a.classList.contains("dock__item")){cn(),US(a).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}a=a.parentElement}},!1)}getDir(e){const n=ot(e,"UL");if(n)return n.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}const j1=(t,e)=>{var n;const a=new dt(p.MENU_BAR_PLUGIN);a.addItem({id:"manage",icon:"iconSettings",label:window.siyuan.languages.manage,ignore:Df()||window.siyuan.config.readonly,click(){Kl(t).element.querySelector('.b3-tab-bar [data-name="bazaar"]').dispatchEvent(new CustomEvent("click"))}}),a.addSeparator({id:"separator_1",ignore:Df()||window.siyuan.config.readonly});let i=!1;if(t.plugins.forEach(s=>{const l=s.setting||s.__proto__.hasOwnProperty("openSetting");let o=!1;for(let r=0;r<s.topBarIcons.length;r++){const c=s.topBarIcons[r];if(!document.contains(c)){s.topBarIcons.splice(r,1),r--;continue}const d=window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(c.id),u=[{id:d?"pin":"unpin",icon:d?"iconPin":"iconUnpin",label:d?window.siyuan.languages.pin:window.siyuan.languages.unpin,click(){d?(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].splice(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].indexOf(c.id),1),c.classList.remove("fn__none")):(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].push(c.id),window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN]=Array.from(new Set(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN])),c.classList.add("fn__none")),Ee(p.LOCAL_PLUGINTOPUNPIN,window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN])}}];l&&u.push({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){s.openSetting()}});const m=e?c.getAttribute("aria-label"):c.textContent.trim();e||u.push({id:"play",icon:"iconPlay",label:m,click(){return c.dispatchEvent(new CustomEvent("click")),!0}});const f={id:c.id,icon:"iconInfo",label:m,click:e?()=>{c.dispatchEvent(new CustomEvent("click"))}:void 0,type:"submenu",submenu:u};if(c.querySelector("use"))f.icon=c.querySelector("use").getAttribute("xlink:href").replace("#","");else{const g=c.querySelector("svg").cloneNode(!0);g.classList.add("b3-menu__icon"),f.iconHTML=g.outerHTML}a.addItem(f),i=!0,o=!0}!o&&l&&(i=!0,a.addItem({id:s.name,icon:"iconSettings",label:s.displayName,click(){s.openSetting()}}))}),i||(e?(n=window.siyuan.menus.menu.element.querySelector(".b3-menu__separator"))==null||n.remove():a.addItem({id:"emptyContent",iconHTML:"",type:"readonly",label:window.siyuan.languages.emptyContent})),e){let s=e.getBoundingClientRect();s.width===0&&(s=document.querySelector("#barMore").getBoundingClientRect()),a.open({x:s.right,y:s.bottom,isLeft:!0})}else a.fullscreen()},K1=t=>{const e=document.getElementById("toolbar");e.innerHTML=`
<div id="barWorkspace" class="ariaLabel toolbar__item toolbar__item--active" aria-label="${window.siyuan.languages.mainMenu} ${pe(window.siyuan.config.keymap.general.mainMenu.custom)}">
    <span class="toolbar__text">${uw()}</span>
    <svg class="toolbar__svg"><use xlink:href="#iconDown"></use></svg>
</div>
<div id="barSync" class="ariaLabel toolbar__item${window.siyuan.config.readonly?" fn__none":""}">
    <svg><use xlink:href="#iconCloudSucc"></use></svg>
</div>
<button id="barBack" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goBack} ${pe(window.siyuan.config.keymap.general.goBack.custom)}">
    <svg><use xlink:href="#iconBack"></use></svg>
</button>
<button id="barForward" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goForward} ${pe(window.siyuan.config.keymap.general.goForward.custom)}">
    <svg><use xlink:href="#iconForward"></use></svg>
</button>
<div class="fn__flex-1 fn__ellipsis" id="drag"><span class="fn__none">\u5F00\u53D1\u7248\uFF0C\u4F7F\u7528\u524D\u8BF7\u8FDB\u884C\u5907\u4EFD Development version, please backup before use</span></div>
<div id="barAccount" class="toolbar__item ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.account}">
    <svg><use xlink:href="#iconAccount"></use></svg>
</div>
<div id="barSettings" class="toolbar__item ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.config} ${pe(window.siyuan.config.keymap.general.config.custom)}">
    <svg><use xlink:href="#iconSettings"></use></svg>
</div>
<div id="barPlugins" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.plugin}">
    <svg><use xlink:href="#iconPlugin"></use></svg>
</div>
<div id="barCommand" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.commandPanel} ${pe(window.siyuan.config.keymap.general.commandPanel.custom)}">
    <svg><use xlink:href="#iconTerminal"></use></svg>
</div>
<div id="barSearch" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.globalSearch} ${pe(window.siyuan.config.keymap.general.globalSearch.custom)}">
    <svg><use xlink:href="#iconSearch"></use></svg>
</div>
<div id="barZoom" class="toolbar__item ariaLabel${window.siyuan.storage[p.LOCAL_ZOOM]===1||Ne()?" fn__none":""}" aria-label="${window.siyuan.languages.zoom}">
    <svg><use xlink:href="#iconZoom${window.siyuan.storage[p.LOCAL_ZOOM]>1?"In":"Out"}"></use></svg>
</div>
<div id="barMode" class="toolbar__item ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.appearanceMode}">
    <svg><use xlink:href="#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}"></use></svg>
</div>
<div id="barExit" class="ft__error toolbar__item ariaLabel${$n()||ht()||bt()?"":" fn__none"}" aria-label="${window.siyuan.languages.safeQuit}">
    <svg><use xlink:href="#iconQuit"></use></svg>
</div>
<div id="barMore" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.more}">
    <svg><use xlink:href="#iconMore"></use></svg>
</div>
<div class="fn__flex" id="windowControls"></div>`,gi(),e.addEventListener("click",a=>{let i=a.target;for(typeof a.detail=="string"&&(i=e.querySelector("#"+a.detail));!i.classList.contains("toolbar");){const s=typeof a.detail=="string"?a.detail:i.id;if(s==="barBack"){Mp(t),a.stopPropagation();break}else if(s==="barMore"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BAR_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BAR_MORE),(i.getAttribute("data-hideids")||"").split(",").forEach(o=>{const r=e.querySelector("#"+o),c=r.querySelector("use"),d={label:r.getAttribute("aria-label"),icon:c?c.getAttribute("xlink:href").substring(1):void 0,click:()=>{o.startsWith("plugin")?r.dispatchEvent(new CustomEvent("click")):e.dispatchEvent(new CustomEvent("click",{detail:o}))}};if(!c&&r.querySelector("svg")){const u=r.querySelector("svg").cloneNode(!0);u.classList.add("b3-menu__icon"),d.iconHTML=u.outerHTML}window.siyuan.menus.menu.append(new N(d).element)});const l=i.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.right,y:l.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="barForward"){Pp(t),a.stopPropagation();break}else if(s==="barSync"){ig(t),a.stopPropagation();break}else if(s==="barWorkspace"){_y(t,i.getBoundingClientRect()),a.stopPropagation();break}else if(s==="barExit"){a.stopPropagation(),Un({errorExit:!0,cb:Ns});break}else if(s==="barMode"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BAR_MODE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BAR_MODE),window.siyuan.menus.menu.append(new N({id:"themeLight",label:window.siyuan.languages.themeLight,icon:"iconLight",current:window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS,click:()=>{hb(0)}}).element),window.siyuan.menus.menu.append(new N({id:"themeDark",label:window.siyuan.languages.themeDark,current:window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS,icon:"iconDark",click:()=>{hb(1)}}).element),window.siyuan.menus.menu.append(new N({id:"themeOS",label:window.siyuan.languages.themeOS,current:window.siyuan.config.appearance.modeOS,icon:"iconMode",click:()=>{hb(2)}}).element);let l=i.getBoundingClientRect();l.width===0&&(l=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:l.right,y:l.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="barSearch"){Hn({app:t,hotkey:p.DIALOG_GLOBALSEARCH}),a.stopPropagation();break}else if(s==="barPlugins"){j1(t,i),a.stopPropagation();break}else if(s==="barCommand"){ES(t),a.stopPropagation();break}else if(s==="barZoom"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BAR_ZOOM){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BAR_ZOOM),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.zoomIn,icon:"iconZoomIn",accelerator:"\u2318=",click:()=>{Dy("zoomIn")}}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.zoomOut,accelerator:"\u2318-",icon:"iconZoomOut",click:()=>{Dy("zoomOut")}}).element),window.siyuan.menus.menu.append(new N({label:window.siyuan.languages.reset,accelerator:"\u23180",click:()=>{Dy("restore")}}).element);let l=i.getBoundingClientRect();l.width===0&&(l=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:l.right,y:l.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="barSettings"){Kl(t),a.stopPropagation();break}else if(s==="barAccount"){window.siyuan.config.readonly||Kl(t).element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),a.stopPropagation();break}i=i.parentElement}});const n=e.querySelector("#barSync");n.addEventListener("mouseenter",a=>{a.stopPropagation(),a.preventDefault(),A("/api/sync/getSyncInfo",{},i=>{let s="";!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&as("")?s=i.data.stat:(s=window.siyuan.languages._kernel[82].replace("%s",Q(i.data.synced).format("YYYY-MM-DD HH:mm"))+"<br>",s+="&emsp;"+i.data.stat,i.data.kernels.length>0&&(s+="<br>",s+=window.siyuan.languages.currentKernel+"<br>",s+="&emsp;"+i.data.kernel+"/"+window.siyuan.config.system.kernelVersion+" ("+window.siyuan.config.system.os+"/"+window.siyuan.config.system.name+")<br>",s+=window.siyuan.languages.otherOnlineKernels+"<br>",i.data.kernels.forEach(l=>{s+=`&emsp;${l.id}/${l.ver} (${l.os}/${l.hostname}) <br>`}))),n.setAttribute("aria-label",s)})}),n.setAttribute("aria-label",window.siyuan.config.sync.stat||window.siyuan.languages.syncNow+" "+pe(window.siyuan.config.keymap.general.syncNow.custom))},Dy=t=>{},Z1=()=>{A("/api/system/getChangelog",{},t=>{if(!t.data.show)return;const e=new $e({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:Y()?"92vw":"768px",height:Y()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${t.data.html}</div>`});e.element.setAttribute("data-key",p.DIALOG_CHANGELOG),rt(e.element)})},WS=(t,e,n)=>{let a=1,i=t;if(i&&i.classList.contains("protyle-action"))return i;for(;i&&(i.classList.contains("list")||i.classList.contains("li"));)i=document.elementFromPoint(e+73*a,n),i=B(i),a++;return i},J1=(t,e)=>{var n;if(document.body.classList.contains("body--blur")||document.getElementById("progress"))return;const a=(n=window.siyuan.coordinates)!=null?n:window.siyuan.coordinates={pageX:0,pageY:0,clientX:0,clientY:0,screenX:0,screenY:0};a.pageX=t.pageX,a.pageY=t.pageY,a.clientX=t.clientX,a.clientY=t.clientY,a.screenX=t.screenX,a.screenY=t.screenY,window.siyuan.hideBreadcrumb&&(window.siyuan.hideBreadcrumb=!1,qn().forEach(o=>{var r;(r=o.protyle.breadcrumb)!=null&&r.element.classList.contains("protyle-breadcrumb__bar--hide")&&(o.protyle.breadcrumb.element.classList.remove("protyle-breadcrumb__bar--hide"),o.protyle.breadcrumb.render(o.protyle,!0))}));const i=t.target;!e&&t.buttons===0&&window.siyuan.layout.bottomDock&&!ue()&&(t.clientX<Math.max(document.getElementById("dockLeft").clientWidth+1,16)?!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.clientWidth>0&&(window.siyuan.layout.leftDock.element.clientWidth>0||window.siyuan.layout.leftDock.element.clientWidth===0&&t.clientX<8)&&(t.clientY>document.getElementById("toolbar").clientHeight&&t.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?!T(i,"b3-menu")&&!T(i,"protyle-toolbar")&&!T(i,"protyle-util")&&!T(i,"b3-dialog",!0)&&!T(i,"layout--float")&&window.siyuan.layout.leftDock.showDock():window.siyuan.layout.leftDock.hideDock()):t.clientX>window.innerWidth-Math.max(document.getElementById("dockRight").clientWidth-2,16)&&!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.clientWidth>0&&(window.siyuan.layout.rightDock.element.clientWidth>0||window.siyuan.layout.rightDock.element.clientWidth===0&&t.clientX>window.innerWidth-8)&&(t.clientY>document.getElementById("toolbar").clientHeight&&t.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?!T(i,"b3-menu")&&!T(i,"layout--float")&&!T(i,"protyle-toolbar")&&!T(i,"protyle-util")&&!T(i,"b3-dialog",!0)&&window.siyuan.layout.rightDock.showDock():window.siyuan.layout.rightDock.hideDock()),t.clientY>Math.min(window.innerHeight-10,window.innerHeight-(window.siyuan.config.uiLayout.hideDock?0:document.getElementById("dockBottom").clientHeight)-document.querySelector("#status").clientHeight)&&window.siyuan.layout.bottomDock.showDock());const s=t.composedPath()[0];if(s&&s.nodeType!==3&&s.classList.contains("protyle-wysiwyg")&&s.style.paddingLeft){const o=document.elementFromPoint(s.getBoundingClientRect().left+parseInt(s.style.paddingLeft)+13,t.clientY),r=B(o);if(r){const c=WS(r,r.getBoundingClientRect().left+1,t.clientY);if(!c)return;let d;c.classList.contains("av")&&(d=T(o,"av__row"));const u=Oe();let m=!1;u.editor.find(f=>{if(f.editor.protyle.wysiwyg.element===s)return f.editor.protyle.gutter.render(f.editor.protyle,c,f.editor.protyle.wysiwyg.element,d),m=!0,!0}),m||window.siyuan.blockPanels.find(f=>{if(f.editors.find(g=>{if(g.protyle.wysiwyg.element.contains(s))return g.protyle.gutter.render(g.protyle,c,g.protyle.wysiwyg.element,d),m=!0,!0}),m)return!0}),m||u.backlink.find(f=>{if(f.editors.find(g=>{if(g.protyle.wysiwyg.element===s)return g.protyle.gutter.render(g.protyle,c,g.protyle.wysiwyg.element,d),m=!0,!0}),m)return!0})}return}if(s&&s.nodeType!==3&&(s.classList.contains("li")||s.classList.contains("list")||s.classList.contains("protyle-action")&&s.getAttribute("data-type")==="NodeListItem")){const o=WS(s,s.getBoundingClientRect().left+1,t.clientY);if(!o)return;const r=Oe();let c=!1;r.editor.find(d=>{if(d.editor.protyle.wysiwyg.element.contains(s))return d.editor.protyle.gutter.render(d.editor.protyle,o,d.editor.protyle.wysiwyg.element),c=!0,!0}),c||window.siyuan.blockPanels.find(d=>{if(d.editors.find(u=>{if(u.protyle.wysiwyg.element.contains(s))return u.protyle.gutter.render(u.protyle,o,u.protyle.wysiwyg.element),c=!0,!0}),c)return!0}),c||r.backlink.find(d=>{if(d.editors.find(u=>{if(u.protyle.wysiwyg.element.contains(s))return u.protyle.gutter.render(u.protyle,o,u.protyle.wysiwyg.element),c=!0,!0}),c)return!0});return}if(s&&s.nodeType!==3&&s.classList.contains("av")&&s.getAttribute("data-type")==="NodeAttributeView"){const o=T(document.elementFromPoint(s.firstElementChild.getBoundingClientRect().left+10,t.clientY),"av__row");if(o&&!o.classList.contains("av__row--header")){qn().find(r=>{if(r.protyle.wysiwyg.element.contains(s))return r.protyle.gutter.render(r.protyle,s,r.protyle.wysiwyg.element,o),!0});return}}T(i,"protyle",!0)||document.querySelectorAll(".protyle-gutters").forEach(o=>{o.classList.add("fn__none"),o.innerHTML=""});const l=T(i,"table");if(l&&l.style.cursor!=="col-resize"&&!T(l,"protyle-wysiwyg__embed")){const o=U(i,"TH")||U(i,"TD"),r=l.querySelector("table");if(o&&r&&r.getAttribute("contenteditable")==="true"){const c=l.querySelector("table").clientHeight,d=l.querySelector(".table__resize");l.style.textAlign==="center"||l.style.textAlign==="right"?d.parentElement.style.left=r.offsetLeft+"px":d.parentElement.style.left="";const u=o.getBoundingClientRect();u.right-t.clientX<3&&u.right-t.clientX>0?(d.setAttribute("data-col-index",(Oa(o)+o.colSpan-1).toString()),d.setAttribute("style",`height:${c}px;left: ${Math.round(o.offsetWidth+o.offsetLeft-l.firstElementChild.scrollLeft-3)}px;display:block`)):t.clientX-u.left<3&&t.clientX-u.left>0&&o.previousElementSibling&&(d.setAttribute("data-col-index",(Oa(o)-1).toString()),d.setAttribute("style",`height:${c}px;left: ${Math.round(o.offsetLeft-l.firstElementChild.scrollLeft-3)}px;display:block`))}}},X1=(t,e)=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1;const n=window.siyuan.dialogs.find(a=>{if(a.element.getAttribute("data-key")===p.DIALOG_SWITCHTAB)return!0});if(n&&n.element.parentElement){if(window.siyuan.config.keymap.general.goToEditTabNext.custom.endsWith(p.KEYCODELIST[e.keyCode])||window.siyuan.config.keymap.general.goToEditTabPrev.custom.endsWith(p.KEYCODELIST[e.keyCode])){let a=n.element.querySelector(".b3-list-item--focus");if(a.classList.remove("b3-list-item--focus"),W(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)){for(;a.previousElementSibling?a=a.previousElementSibling:a.getAttribute("data-original")?(a.removeAttribute("data-original"),a=a.parentElement.lastElementChild):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.lastElementChild?a=a.parentElement.nextElementSibling.lastElementChild:a=a.parentElement.lastElementChild:a.parentElement.previousElementSibling?a=a.parentElement.previousElementSibling.lastElementChild:ue()&&(a=a.parentElement.lastElementChild),a.getBoundingClientRect().height===0;);a.classList.add("b3-list-item--focus")}else{for(;a.nextElementSibling?a=a.nextElementSibling:a.getAttribute("data-original")?(a.removeAttribute("data-original"),a=a.parentElement.firstElementChild):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.firstElementChild?a=a.parentElement.nextElementSibling.firstElementChild:a=a.parentElement.firstElementChild:a.parentElement.previousElementSibling?a=a.parentElement.previousElementSibling.firstElementChild:ue()&&(a=a.parentElement.firstElementChild),a.getBoundingClientRect().height===0;);a.classList.add("b3-list-item--focus")}if(a){const s=a.getAttribute("data-node-id");s?A("/api/filetree/getFullHPathByID",{id:s},r=>{a.parentElement.parentElement.nextElementSibling.innerHTML=he(r.data)}):a.parentElement.parentElement.nextElementSibling.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const l=a.getBoundingClientRect(),o=a.parentElement.getBoundingClientRect();l.top<o.top?a.scrollIntoView(!0):l.bottom>o.bottom&&a.scrollIntoView(!1)}const i=n.element.querySelector('[data-original="true"]');i&&i.removeAttribute("data-original")}else if(window.siyuan.config.keymap.general.goToEditTabNext.custom.startsWith(p.KEYCODELIST[e.keyCode])||window.siyuan.config.keymap.general.goToEditTabPrev.custom.startsWith(p.KEYCODELIST[e.keyCode])){let a=n.element.querySelector(".b3-list-item--focus");a.getAttribute("data-original")&&(a.classList.remove("b3-list-item--focus"),W(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original"),a=n.element.querySelector(".b3-list-item--focus"));const i=a.getAttribute("data-type");if(i)i==="riffCard"?Wo(t):nt(i).toggleModel(i,!0),document.activeElement&&document.activeElement.blur();else{const s=a.getAttribute("data-id");pi().find(l=>{if(l.id===s)return l.parent.switchTab(l.headElement),l.parent.showHeading(),!0})}n.destroy()}}},Q1=t=>{var e;const n=t.target,a=T(n,"protyle-background");if(a&&n.tagName==="IMG"&&a.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none")){const i=T(n,"protyle-content",!0);if(!i)return!1;i.style.overflow="hidden";const s=t.touches[0].clientY,l=n.naturalHeight*n.clientWidth/n.naturalWidth-n.clientHeight;let o=parseFloat(n.style.objectPosition.substring(7))||50;n.style.objectPosition.endsWith("px")&&(o=-parseInt(n.style.objectPosition.substring(7))/l*100);const r=document;return r.ontouchmove=c=>{n.style.objectPosition=`center ${((s-c.touches[0].clientY)/l*100+o).toFixed(2)}%`},r.ontouchend=()=>{i.style.overflow="",r.ontouchmove=null,r.ontouchstart=null,r.ondragstart=null,r.onselectstart=null,r.onselect=null},t.stopImmediatePropagation(),!0}return a?a.classList.contains("protyle-background--enable")&&a.classList.add("protyle-background--mobileshow"):(e=document.querySelector(".protyle-background--mobileshow"))==null||e.classList.remove("protyle-background--mobileshow"),!1},eD=(t,e,n,a)=>{const i=t.target,s=Ha();if(typeof e=="undefined"&&new Date().getTime()-n>900){const l=j(i,"data-type","navigation-root")||j(i,"data-type","navigation-file");if(l){if(!window.siyuan.config.readonly&&l.dataset.type==="navigation-root"){const o=sp(a,l);if(s){const r=l.getBoundingClientRect();o.popup({x:r.right-52,y:r.bottom,h:r.height}),cn()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(l.dataset.type==="navigation-file"){const o=ot(l,"UL");if(o){const r=lp(a,o.dataset.url,l.dataset.path,l);if(s){const c=l.getBoundingClientRect();r.popup({x:c.right-52,y:c.bottom,h:c.height}),cn()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(i.tagName==="SPAN"&&!G(i)){let o;const r=T(i,"protyle",!0);if(r){const u=on(r.dataset.id);u instanceof Dt&&u.model instanceof Ot&&(o=u.model.editor)}if(!o)return!1;const c=(i.getAttribute("data-type")||"").split(" ");if(c.includes("inline-memo")&&o.protyle.toolbar.showRender(o.protyle,i),o.protyle.disabled)return t.stopImmediatePropagation(),t.preventDefault(),!0;if(c.includes("block-ref"))return Rh(o.protyle,i),!0;if(c.includes("file-annotation-ref"))return Bh(o.protyle,i),!0;if(c.includes("tag"))return Uh(o.protyle,i),!0;if(c.includes("a"))return Jo(o.protyle,i),!0;const d=j(i,"data-type","inline-math");if(d)return wp(o.protyle,d),!0}}return!1},tD=t=>{document.body.addEventListener("mouseleave",()=>{window.siyuan.layout.leftDock&&(window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock(),window.siyuan.layout.bottomDock.hideDock()),document.querySelectorAll(".protyle-gutters").forEach(a=>{a.classList.add("fn__none"),a.innerHTML=""}),cn()});let e=!1;document.body.addEventListener("mouseenter",()=>{window.siyuan.layout.leftDock&&(e=!0,setTimeout(()=>{e=!1},p.TIMEOUT_TRANSITION))}),window.addEventListener("mousemove",a=>{J1(a,e)}),window.addEventListener("mouseup",a=>{a.button===3?(a.preventDefault(),Mp(t)):a.button===4&&(a.preventDefault(),Pp(t))}),window.addEventListener("mousedown",a=>{T(a.target,"protyle-toolbar")||_s(["toolbar"])}),window.addEventListener("keyup",a=>{X1(t,a)}),window.addEventListener("keydown",a=>{H1(t,a)}),window.addEventListener("blur",()=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1}),window.addEventListener("click",a=>{V3(a)});let n=0;document.addEventListener("touchstart",a=>{n=new Date().getTime();const i=a.target;if(T(i,"protyle-icons")||T(i,"item")||i.classList.contains("protyle-background__icon"))return;const s=G(i);if(s){s.firstElementChild.classList.toggle("protyle-icons--show");return}Q1(a)},!1),document.addEventListener("touchend",a=>{if(Ha()){if(eD(a,void 0,n,t)){a.stopImmediatePropagation(),a.preventDefault();return}if(new Date().getTime()-n<=900)return;const i=a.target,s=T(i,"dock__item");if(s&&s.getAttribute("data-type")){const r=s.getBoundingClientRect();US(s).popup({x:r.right,y:r.top}),a.stopImmediatePropagation(),a.preventDefault();return}const l=j(i,"data-type","tab-header");if(l){const r=l.getBoundingClientRect();vS(t,on(l.getAttribute("data-id"))).popup({x:r.left,y:r.bottom}),cn(),a.stopImmediatePropagation(),a.preventDefault();return}const o=T(i,"protyle-breadcrumb__item");if(o){const r=o.getAttribute("data-id")||o.getAttribute("data-node-id");r&&ft(r,c=>{ve({app:t,id:r,action:c?[p.CB_GET_FOCUS,p.CB_GET_ALL]:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT],zoomIn:c}),window.siyuan.menus.menu.remove()}),a.stopImmediatePropagation(),a.preventDefault();return}}},!1)};var VS=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const nD=(t,e)=>{I1(e),(!window.siyuan.config.uiLayout||window.siyuan.config.uiLayout&&!window.siyuan.config.uiLayout.left)&&(window.siyuan.config.uiLayout=p.SIYUAN_EMPTY_LAYOUT),tD(e),A("/api/system/getEmojiConf",{},i=>{window.siyuan.emojis=i.data;try{z1(e,t),setTimeout(()=>{kd()}),Z1()}catch(s){BS()}}),K1(e),C3(),aD(e),It.onSetAppearance(window.siyuan.config.appearance),eC(),td(),lw();let n=0,a=!0;window.addEventListener("resize",()=>{a&&(id(),a=!1),window.clearTimeout(n),n=window.setTimeout(()=>{kd(),Sn(),Ed(),a=!0},200)})},RD=()=>VS(void 0,null,function*(){}),aD=t=>VS(void 0,null,function*(){ue()||document.querySelector(".toolbar").classList.add("toolbar--browser")}),iD=(t,e={scope:"/",type:"classic",updateViaCache:"all"})=>{var n;(n=window.webkit)!=null&&n.messageHandlers||window.JSAndroid||window.JSHarmony||!("serviceWorker"in window.navigator)||!("caches"in window)||!("fetch"in window)||navigator.serviceWorker==null||window.navigator.serviceWorker.register(t,e).then(a=>{a.update()}).catch(a=>{console.debug(`Registration failed with ${a}`)})};var sD=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class lD{constructor(){this.plugins=[],iD(`${p.SERVICE_WORKER_PATH}?v=${p.SIYUAN_VERSION}`),wA(),this.appId=p.SIYUAN_APPID,window.siyuan={zIndex:10,transactions:[],reqIds:{},backStack:[],layout:{},dialogs:[],blockPanels:[],closedTabs:[],ctrlIsPressed:!1,altIsPressed:!1,ws:new ia({app:this,id:ee(),type:"main",msgCallback:e=>{var n;if(this.plugins.forEach(a=>{a.eventBus.emit("ws-main",e)}),e)switch(e.cmd){case"setDefRefCount":v3(e.data);break;case"reloadTag":((n=nt("tag"))==null?void 0:n.data.tag)instanceof Ps&&nt("tag").data.tag.update();break;case"setLocalShorthandCount":$A();break;case"setRefDynamicText":w3(e.data);break;case"reloadPlugin":OS(this,e.data);break;case"reloadEmojiConf":mA();break;case"syncMergeResult":ay(this,e.data);break;case"reloaddoc":ay(this,{upsertRootIDs:[e.data],removeRootIDs:[]},!1,!1,!0);break;case"readonly":window.siyuan.config.editor.readOnly=e.data,_s(["util"]);break;case"setConf":window.siyuan.config=e.data,j_();break;case"progress":iy(e);break;case"setLocalStorageVal":window.siyuan.storage[e.data.key]=e.data.val;break;case"rename":pi().forEach(a=>{if(a.headElement){const i=a.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s.instance==="Editor"&&s.rootId===e.data.id&&a.updateTitle(e.data.title)}}});break;case"unmount":pi().forEach(a=>{if(a.headElement){const i=a.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s.instance==="Editor"&&e.data.box===s.notebookId&&a.parent.removeTab(a.id)}}});break;case"removeDoc":pi().forEach(a=>{if(a.headElement){const i=a.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s.instance==="Editor"&&e.data.ids.includes(s.rootId)&&a.parent.removeTab(a.id)}}});break;case"statusbar":k3(e);break;case"downloadProgress":A3(e.data);break;case"txerr":E3();break;case"syncing":gi(e,this.plugins);break;case"backgroundtask":S3(e.data.tasks);break;case"refreshtheme":window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark!=="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight!=="daylight"?document.getElementById("themeStyle").href=e.data.theme:document.getElementById("themeDefaultStyle").href=e.data.theme;break;case"openFileById":ve({app:this,id:e.data.id,action:[p.CB_GET_FOCUS]});break}}})},A("/api/system/getConf",{},e=>sD(this,null,function*(){W_(`${p.PROTYLE_CDN}/js/lute/lute.min.js?v=${p.SIYUAN_VERSION}`,"protyleLuteScript"),jt(`${p.PROTYLE_CDN}/js/protyle-html.js?v=${p.SIYUAN_VERSION}`,"protyleWcHtmlScript"),window.siyuan.config=e.data.conf,j_(),window.siyuan.isPublish=e.data.isPublish,yield Sy(this),U_(()=>{Qk(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${p.SIYUAN_VERSION}`,n=>{window.siyuan.languages=n,window.siyuan.menus=new G1(this),L3(),A("/api/setting/getCloudUser",{},a=>{window.siyuan.user=a.data,nD(e.data.start,this),tn.onSetaccount(),gd(window.siyuan.languages.siyuanNote),uA()})})})})),Gi(),D1(this)}}const oD=new lD;window.openFileByURL=t=>{if(t&&yA(t)){const e=Ie("focus",t)==="1";return ve({app:oD,id:Of(t),action:e?[p.CB_GET_ALL,p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],zoomIn:e}),!0}return!1},window.showKeyboardToolbar=()=>{},window.processIOSPurchaseResponse=R1})()})();})();
