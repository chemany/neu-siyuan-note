(()=>{(()=>{var ff={353:function(it){(function(Ye,mt){it.exports=mt()})(this,function(){"use strict";var Ye=1e3,mt=6e4,Ke=36e5,hn="millisecond",Me="second",J="minute",ee="hour",P="day",me="week",be="month",re="quarter",Ae="year",Pe="date",_t="Invalid Date",bt=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Be=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Kn={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(ue){var le=["th","st","nd","rd"],Y=ue%100;return"["+ue+(le[(Y-20)%10]||le[Y]||le[0])+"]"}},Mn=function(ue,le,Y){var O=String(ue);return!O||O.length>=le?ue:""+Array(le+1-O.length).join(Y)+ue},An={s:Mn,z:function(ue){var le=-ue.utcOffset(),Y=Math.abs(le),O=Math.floor(Y/60),U=Y%60;return(le<=0?"+":"-")+Mn(O,2,"0")+":"+Mn(U,2,"0")},m:function ue(le,Y){if(le.date()<Y.date())return-ue(Y,le);var O=12*(Y.year()-le.year())+(Y.month()-le.month()),U=le.clone().add(O,be),C=Y-U<0,F=le.clone().add(O+(C?-1:1),be);return+(-(O+(Y-U)/(C?U-F:F-U))||0)},a:function(ue){return ue<0?Math.ceil(ue)||0:Math.floor(ue)},p:function(ue){return{M:be,y:Ae,w:me,d:P,D:Pe,h:ee,m:J,s:Me,ms:hn,Q:re}[ue]||String(ue||"").toLowerCase().replace(/s$/,"")},u:function(ue){return ue===void 0}},Hn="en",Ht={};Ht[Hn]=Kn;var ti="$isDayjsObject",Ma=function(ue){return ue instanceof M||!(!ue||!ue[ti])},Z=function ue(le,Y,O){var U;if(!le)return Hn;if(typeof le=="string"){var C=le.toLowerCase();Ht[C]&&(U=C),Y&&(Ht[C]=Y,U=C);var F=le.split("-");if(!U&&F.length>1)return ue(F[0])}else{var de=le.name;Ht[de]=le,U=de}return!O&&U&&(Hn=U),U||!O&&Hn},ie=function(ue,le){if(Ma(ue))return ue.clone();var Y=typeof le=="object"?le:{};return Y.date=ue,Y.args=arguments,new M(Y)},K=An;K.l=Z,K.i=Ma,K.w=function(ue,le){return ie(ue,{locale:le.$L,utc:le.$u,x:le.$x,$offset:le.$offset})};var M=function(){function ue(Y){this.$L=Z(Y.locale,null,!0),this.parse(Y),this.$x=this.$x||Y.x||{},this[ti]=!0}var le=ue.prototype;return le.parse=function(Y){this.$d=function(O){var U=O.date,C=O.utc;if(U===null)return new Date(NaN);if(K.u(U))return new Date;if(U instanceof Date)return new Date(U);if(typeof U=="string"&&!/Z$/i.test(U)){var F=U.match(bt);if(F){var de=F[2]-1||0,pt=(F[7]||"0").substring(0,3);return C?new Date(Date.UTC(F[1],de,F[3]||1,F[4]||0,F[5]||0,F[6]||0,pt)):new Date(F[1],de,F[3]||1,F[4]||0,F[5]||0,F[6]||0,pt)}}return new Date(U)}(Y),this.init()},le.init=function(){var Y=this.$d;this.$y=Y.getFullYear(),this.$M=Y.getMonth(),this.$D=Y.getDate(),this.$W=Y.getDay(),this.$H=Y.getHours(),this.$m=Y.getMinutes(),this.$s=Y.getSeconds(),this.$ms=Y.getMilliseconds()},le.$utils=function(){return K},le.isValid=function(){return this.$d.toString()!==_t},le.isSame=function(Y,O){var U=ie(Y);return this.startOf(O)<=U&&U<=this.endOf(O)},le.isAfter=function(Y,O){return ie(Y)<this.startOf(O)},le.isBefore=function(Y,O){return this.endOf(O)<ie(Y)},le.$g=function(Y,O,U){return K.u(Y)?this[O]:this.set(U,Y)},le.unix=function(){return Math.floor(this.valueOf()/1e3)},le.valueOf=function(){return this.$d.getTime()},le.startOf=function(Y,O){var U=this,C=!!K.u(O)||O,F=K.p(Y),de=function(It,qt){var Ve=K.w(U.$u?Date.UTC(U.$y,qt,It):new Date(U.$y,qt,It),U);return C?Ve:Ve.endOf(P)},pt=function(It,qt){return K.w(U.toDate()[It].apply(U.toDate("s"),(C?[0,0,0,0]:[23,59,59,999]).slice(qt)),U)},We=this.$W,yt=this.$M,At=this.$D,ht="set"+(this.$u?"UTC":"");switch(F){case Ae:return C?de(1,0):de(31,11);case be:return C?de(1,yt):de(0,yt+1);case me:var Nn=this.$locale().weekStart||0,oe=(We<Nn?We+7:We)-Nn;return de(C?At-oe:At+(6-oe),yt);case P:case Pe:return pt(ht+"Hours",0);case ee:return pt(ht+"Minutes",1);case J:return pt(ht+"Seconds",2);case Me:return pt(ht+"Milliseconds",3);default:return this.clone()}},le.endOf=function(Y){return this.startOf(Y,!1)},le.$set=function(Y,O){var U,C=K.p(Y),F="set"+(this.$u?"UTC":""),de=(U={},U[P]=F+"Date",U[Pe]=F+"Date",U[be]=F+"Month",U[Ae]=F+"FullYear",U[ee]=F+"Hours",U[J]=F+"Minutes",U[Me]=F+"Seconds",U[hn]=F+"Milliseconds",U)[C],pt=C===P?this.$D+(O-this.$W):O;if(C===be||C===Ae){var We=this.clone().set(Pe,1);We.$d[de](pt),We.init(),this.$d=We.set(Pe,Math.min(this.$D,We.daysInMonth())).$d}else de&&this.$d[de](pt);return this.init(),this},le.set=function(Y,O){return this.clone().$set(Y,O)},le.get=function(Y){return this[K.p(Y)]()},le.add=function(Y,O){var U,C=this;Y=Number(Y);var F=K.p(O),de=function(yt){var At=ie(C);return K.w(At.date(At.date()+Math.round(yt*Y)),C)};if(F===be)return this.set(be,this.$M+Y);if(F===Ae)return this.set(Ae,this.$y+Y);if(F===P)return de(1);if(F===me)return de(7);var pt=(U={},U[J]=mt,U[ee]=Ke,U[Me]=Ye,U)[F]||1,We=this.$d.getTime()+Y*pt;return K.w(We,this)},le.subtract=function(Y,O){return this.add(-1*Y,O)},le.format=function(Y){var O=this,U=this.$locale();if(!this.isValid())return U.invalidDate||_t;var C=Y||"YYYY-MM-DDTHH:mm:ssZ",F=K.z(this),de=this.$H,pt=this.$m,We=this.$M,yt=U.weekdays,At=U.months,ht=U.meridiem,Nn=function(qt,Ve,qe,ya){return qt&&(qt[Ve]||qt(O,C))||qe[Ve].slice(0,ya)},oe=function(qt){return K.s(de%12||12,qt,"0")},It=ht||function(qt,Ve,qe){var ya=qt<12?"AM":"PM";return qe?ya.toLowerCase():ya};return C.replace(Be,function(qt,Ve){return Ve||function(qe){switch(qe){case"YY":return String(O.$y).slice(-2);case"YYYY":return K.s(O.$y,4,"0");case"M":return We+1;case"MM":return K.s(We+1,2,"0");case"MMM":return Nn(U.monthsShort,We,At,3);case"MMMM":return Nn(At,We);case"D":return O.$D;case"DD":return K.s(O.$D,2,"0");case"d":return String(O.$W);case"dd":return Nn(U.weekdaysMin,O.$W,yt,2);case"ddd":return Nn(U.weekdaysShort,O.$W,yt,3);case"dddd":return yt[O.$W];case"H":return String(de);case"HH":return K.s(de,2,"0");case"h":return oe(1);case"hh":return oe(2);case"a":return It(de,pt,!0);case"A":return It(de,pt,!1);case"m":return String(pt);case"mm":return K.s(pt,2,"0");case"s":return String(O.$s);case"ss":return K.s(O.$s,2,"0");case"SSS":return K.s(O.$ms,3,"0");case"Z":return F}return null}(qt)||F.replace(":","")})},le.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},le.diff=function(Y,O,U){var C,F=this,de=K.p(O),pt=ie(Y),We=(pt.utcOffset()-this.utcOffset())*mt,yt=this-pt,At=function(){return K.m(F,pt)};switch(de){case Ae:C=At()/12;break;case be:C=At();break;case re:C=At()/3;break;case me:C=(yt-We)/6048e5;break;case P:C=(yt-We)/864e5;break;case ee:C=yt/Ke;break;case J:C=yt/mt;break;case Me:C=yt/Ye;break;default:C=yt}return U?C:K.a(C)},le.daysInMonth=function(){return this.endOf(be).$D},le.$locale=function(){return Ht[this.$L]},le.locale=function(Y,O){if(!Y)return this.$L;var U=this.clone(),C=Z(Y,O,!0);return C&&(U.$L=C),U},le.clone=function(){return K.w(this.$d,this)},le.toDate=function(){return new Date(this.valueOf())},le.toJSON=function(){return this.isValid()?this.toISOString():null},le.toISOString=function(){return this.$d.toISOString()},le.toString=function(){return this.$d.toUTCString()},ue}(),p=M.prototype;return ie.prototype=p,[["$ms",hn],["$s",Me],["$m",J],["$H",ee],["$W",P],["$M",be],["$y",Ae],["$D",Pe]].forEach(function(ue){p[ue[1]]=function(le){return this.$g(le,ue[0],ue[1])}}),ie.extend=function(ue,le){return ue.$i||(ue(le,M,ie),ue.$i=!0),ie},ie.locale=Z,ie.isDayjs=Ma,ie.unix=function(ue){return ie(1e3*ue)},ie.en=Ht[Hn],ie.Ls=Ht,ie.p={},ie})},922:function(it,Ye,mt){var Ke;(function(hn){"use strict";function Me(Z,ie){var K=(Z&65535)+(ie&65535),M=(Z>>16)+(ie>>16)+(K>>16);return M<<16|K&65535}function J(Z,ie){return Z<<ie|Z>>>32-ie}function ee(Z,ie,K,M,p,ue){return Me(J(Me(Me(ie,Z),Me(M,ue)),p),K)}function P(Z,ie,K,M,p,ue,le){return ee(ie&K|~ie&M,Z,ie,p,ue,le)}function me(Z,ie,K,M,p,ue,le){return ee(ie&M|K&~M,Z,ie,p,ue,le)}function be(Z,ie,K,M,p,ue,le){return ee(ie^K^M,Z,ie,p,ue,le)}function re(Z,ie,K,M,p,ue,le){return ee(K^(ie|~M),Z,ie,p,ue,le)}function Ae(Z,ie){Z[ie>>5]|=128<<ie%32,Z[(ie+64>>>9<<4)+14]=ie;var K,M,p,ue,le,Y=1732584193,O=-271733879,U=-1732584194,C=271733878;for(K=0;K<Z.length;K+=16)M=Y,p=O,ue=U,le=C,Y=P(Y,O,U,C,Z[K],7,-680876936),C=P(C,Y,O,U,Z[K+1],12,-389564586),U=P(U,C,Y,O,Z[K+2],17,606105819),O=P(O,U,C,Y,Z[K+3],22,-1044525330),Y=P(Y,O,U,C,Z[K+4],7,-176418897),C=P(C,Y,O,U,Z[K+5],12,1200080426),U=P(U,C,Y,O,Z[K+6],17,-1473231341),O=P(O,U,C,Y,Z[K+7],22,-45705983),Y=P(Y,O,U,C,Z[K+8],7,1770035416),C=P(C,Y,O,U,Z[K+9],12,-1958414417),U=P(U,C,Y,O,Z[K+10],17,-42063),O=P(O,U,C,Y,Z[K+11],22,-1990404162),Y=P(Y,O,U,C,Z[K+12],7,1804603682),C=P(C,Y,O,U,Z[K+13],12,-40341101),U=P(U,C,Y,O,Z[K+14],17,-1502002290),O=P(O,U,C,Y,Z[K+15],22,1236535329),Y=me(Y,O,U,C,Z[K+1],5,-165796510),C=me(C,Y,O,U,Z[K+6],9,-1069501632),U=me(U,C,Y,O,Z[K+11],14,643717713),O=me(O,U,C,Y,Z[K],20,-373897302),Y=me(Y,O,U,C,Z[K+5],5,-701558691),C=me(C,Y,O,U,Z[K+10],9,38016083),U=me(U,C,Y,O,Z[K+15],14,-660478335),O=me(O,U,C,Y,Z[K+4],20,-405537848),Y=me(Y,O,U,C,Z[K+9],5,568446438),C=me(C,Y,O,U,Z[K+14],9,-1019803690),U=me(U,C,Y,O,Z[K+3],14,-187363961),O=me(O,U,C,Y,Z[K+8],20,1163531501),Y=me(Y,O,U,C,Z[K+13],5,-1444681467),C=me(C,Y,O,U,Z[K+2],9,-51403784),U=me(U,C,Y,O,Z[K+7],14,1735328473),O=me(O,U,C,Y,Z[K+12],20,-1926607734),Y=be(Y,O,U,C,Z[K+5],4,-378558),C=be(C,Y,O,U,Z[K+8],11,-2022574463),U=be(U,C,Y,O,Z[K+11],16,1839030562),O=be(O,U,C,Y,Z[K+14],23,-35309556),Y=be(Y,O,U,C,Z[K+1],4,-1530992060),C=be(C,Y,O,U,Z[K+4],11,1272893353),U=be(U,C,Y,O,Z[K+7],16,-155497632),O=be(O,U,C,Y,Z[K+10],23,-1094730640),Y=be(Y,O,U,C,Z[K+13],4,681279174),C=be(C,Y,O,U,Z[K],11,-358537222),U=be(U,C,Y,O,Z[K+3],16,-722521979),O=be(O,U,C,Y,Z[K+6],23,76029189),Y=be(Y,O,U,C,Z[K+9],4,-640364487),C=be(C,Y,O,U,Z[K+12],11,-421815835),U=be(U,C,Y,O,Z[K+15],16,530742520),O=be(O,U,C,Y,Z[K+2],23,-995338651),Y=re(Y,O,U,C,Z[K],6,-198630844),C=re(C,Y,O,U,Z[K+7],10,1126891415),U=re(U,C,Y,O,Z[K+14],15,-1416354905),O=re(O,U,C,Y,Z[K+5],21,-57434055),Y=re(Y,O,U,C,Z[K+12],6,1700485571),C=re(C,Y,O,U,Z[K+3],10,-1894986606),U=re(U,C,Y,O,Z[K+10],15,-1051523),O=re(O,U,C,Y,Z[K+1],21,-2054922799),Y=re(Y,O,U,C,Z[K+8],6,1873313359),C=re(C,Y,O,U,Z[K+15],10,-30611744),U=re(U,C,Y,O,Z[K+6],15,-1560198380),O=re(O,U,C,Y,Z[K+13],21,1309151649),Y=re(Y,O,U,C,Z[K+4],6,-145523070),C=re(C,Y,O,U,Z[K+11],10,-1120210379),U=re(U,C,Y,O,Z[K+2],15,718787259),O=re(O,U,C,Y,Z[K+9],21,-343485551),Y=Me(Y,M),O=Me(O,p),U=Me(U,ue),C=Me(C,le);return[Y,O,U,C]}function Pe(Z){var ie,K="",M=Z.length*32;for(ie=0;ie<M;ie+=8)K+=String.fromCharCode(Z[ie>>5]>>>ie%32&255);return K}function _t(Z){var ie,K=[];for(K[(Z.length>>2)-1]=void 0,ie=0;ie<K.length;ie+=1)K[ie]=0;var M=Z.length*8;for(ie=0;ie<M;ie+=8)K[ie>>5]|=(Z.charCodeAt(ie/8)&255)<<ie%32;return K}function bt(Z){return Pe(Ae(_t(Z),Z.length*8))}function Be(Z,ie){var K,M=_t(Z),p=[],ue=[],le;for(p[15]=ue[15]=void 0,M.length>16&&(M=Ae(M,Z.length*8)),K=0;K<16;K+=1)p[K]=M[K]^909522486,ue[K]=M[K]^1549556828;return le=Ae(p.concat(_t(ie)),512+ie.length*8),Pe(Ae(ue.concat(le),640))}function Kn(Z){var ie="0123456789abcdef",K="",M,p;for(p=0;p<Z.length;p+=1)M=Z.charCodeAt(p),K+=ie.charAt(M>>>4&15)+ie.charAt(M&15);return K}function Mn(Z){return unescape(encodeURIComponent(Z))}function An(Z){return bt(Mn(Z))}function Hn(Z){return Kn(An(Z))}function Ht(Z,ie){return Be(Mn(Z),Mn(ie))}function ti(Z,ie){return Kn(Ht(Z,ie))}function Ma(Z,ie,K){return ie?K?Ht(ie,Z):ti(ie,Z):K?An(Z):Hn(Z)}Ke=function(){return Ma}.call(Ye,mt,Ye,it),Ke!==void 0&&(it.exports=Ke)})(this)},975:it=>{"use strict";function Ye(Me){if(typeof Me!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(Me))}function mt(Me,J){for(var ee="",P=0,me=-1,be=0,re,Ae=0;Ae<=Me.length;++Ae){if(Ae<Me.length)re=Me.charCodeAt(Ae);else{if(re===47)break;re=47}if(re===47){if(!(me===Ae-1||be===1))if(me!==Ae-1&&be===2){if(ee.length<2||P!==2||ee.charCodeAt(ee.length-1)!==46||ee.charCodeAt(ee.length-2)!==46){if(ee.length>2){var Pe=ee.lastIndexOf("/");if(Pe!==ee.length-1){Pe===-1?(ee="",P=0):(ee=ee.slice(0,Pe),P=ee.length-1-ee.lastIndexOf("/")),me=Ae,be=0;continue}}else if(ee.length===2||ee.length===1){ee="",P=0,me=Ae,be=0;continue}}J&&(ee.length>0?ee+="/..":ee="..",P=2)}else ee.length>0?ee+="/"+Me.slice(me+1,Ae):ee=Me.slice(me+1,Ae),P=Ae-me-1;me=Ae,be=0}else re===46&&be!==-1?++be:be=-1}return ee}function Ke(Me,J){var ee=J.dir||J.root,P=J.base||(J.name||"")+(J.ext||"");return ee?ee===J.root?ee+P:ee+Me+P:P}var hn={resolve:function(){for(var J="",ee=!1,P,me=arguments.length-1;me>=-1&&!ee;me--){var be;me>=0?be=arguments[me]:(P===void 0&&(P=process.cwd()),be=P),Ye(be),be.length!==0&&(J=be+"/"+J,ee=be.charCodeAt(0)===47)}return J=mt(J,!ee),ee?J.length>0?"/"+J:"/":J.length>0?J:"."},normalize:function(J){if(Ye(J),J.length===0)return".";var ee=J.charCodeAt(0)===47,P=J.charCodeAt(J.length-1)===47;return J=mt(J,!ee),J.length===0&&!ee&&(J="."),J.length>0&&P&&(J+="/"),ee?"/"+J:J},isAbsolute:function(J){return Ye(J),J.length>0&&J.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var J,ee=0;ee<arguments.length;++ee){var P=arguments[ee];Ye(P),P.length>0&&(J===void 0?J=P:J+="/"+P)}return J===void 0?".":hn.normalize(J)},relative:function(J,ee){if(Ye(J),Ye(ee),J===ee||(J=hn.resolve(J),ee=hn.resolve(ee),J===ee))return"";for(var P=1;P<J.length&&J.charCodeAt(P)===47;++P);for(var me=J.length,be=me-P,re=1;re<ee.length&&ee.charCodeAt(re)===47;++re);for(var Ae=ee.length,Pe=Ae-re,_t=be<Pe?be:Pe,bt=-1,Be=0;Be<=_t;++Be){if(Be===_t){if(Pe>_t){if(ee.charCodeAt(re+Be)===47)return ee.slice(re+Be+1);if(Be===0)return ee.slice(re+Be)}else be>_t&&(J.charCodeAt(P+Be)===47?bt=Be:Be===0&&(bt=0));break}var Kn=J.charCodeAt(P+Be),Mn=ee.charCodeAt(re+Be);if(Kn!==Mn)break;Kn===47&&(bt=Be)}var An="";for(Be=P+bt+1;Be<=me;++Be)(Be===me||J.charCodeAt(Be)===47)&&(An.length===0?An+="..":An+="/..");return An.length>0?An+ee.slice(re+bt):(re+=bt,ee.charCodeAt(re)===47&&++re,ee.slice(re))},_makeLong:function(J){return J},dirname:function(J){if(Ye(J),J.length===0)return".";for(var ee=J.charCodeAt(0),P=ee===47,me=-1,be=!0,re=J.length-1;re>=1;--re)if(ee=J.charCodeAt(re),ee===47){if(!be){me=re;break}}else be=!1;return me===-1?P?"/":".":P&&me===1?"//":J.slice(0,me)},basename:function(J,ee){if(ee!==void 0&&typeof ee!="string")throw new TypeError('"ext" argument must be a string');Ye(J);var P=0,me=-1,be=!0,re;if(ee!==void 0&&ee.length>0&&ee.length<=J.length){if(ee.length===J.length&&ee===J)return"";var Ae=ee.length-1,Pe=-1;for(re=J.length-1;re>=0;--re){var _t=J.charCodeAt(re);if(_t===47){if(!be){P=re+1;break}}else Pe===-1&&(be=!1,Pe=re+1),Ae>=0&&(_t===ee.charCodeAt(Ae)?--Ae===-1&&(me=re):(Ae=-1,me=Pe))}return P===me?me=Pe:me===-1&&(me=J.length),J.slice(P,me)}else{for(re=J.length-1;re>=0;--re)if(J.charCodeAt(re)===47){if(!be){P=re+1;break}}else me===-1&&(be=!1,me=re+1);return me===-1?"":J.slice(P,me)}},extname:function(J){Ye(J);for(var ee=-1,P=0,me=-1,be=!0,re=0,Ae=J.length-1;Ae>=0;--Ae){var Pe=J.charCodeAt(Ae);if(Pe===47){if(!be){P=Ae+1;break}continue}me===-1&&(be=!1,me=Ae+1),Pe===46?ee===-1?ee=Ae:re!==1&&(re=1):ee!==-1&&(re=-1)}return ee===-1||me===-1||re===0||re===1&&ee===me-1&&ee===P+1?"":J.slice(ee,me)},format:function(J){if(J===null||typeof J!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof J);return Ke("/",J)},parse:function(J){Ye(J);var ee={root:"",dir:"",base:"",ext:"",name:""};if(J.length===0)return ee;var P=J.charCodeAt(0),me=P===47,be;me?(ee.root="/",be=1):be=0;for(var re=-1,Ae=0,Pe=-1,_t=!0,bt=J.length-1,Be=0;bt>=be;--bt){if(P=J.charCodeAt(bt),P===47){if(!_t){Ae=bt+1;break}continue}Pe===-1&&(_t=!1,Pe=bt+1),P===46?re===-1?re=bt:Be!==1&&(Be=1):re!==-1&&(Be=-1)}return re===-1||Pe===-1||Be===0||Be===1&&re===Pe-1&&re===Ae+1?Pe!==-1&&(Ae===0&&me?ee.base=ee.name=J.slice(1,Pe):ee.base=ee.name=J.slice(Ae,Pe)):(Ae===0&&me?(ee.name=J.slice(1,re),ee.base=J.slice(1,Pe)):(ee.name=J.slice(Ae,re),ee.base=J.slice(Ae,Pe)),ee.ext=J.slice(re,Pe)),Ae>0?ee.dir=J.slice(0,Ae-1):me&&(ee.dir="/"),ee},sep:"/",delimiter:":",win32:null,posix:null};hn.posix=hn,it.exports=hn}},wr={};function cn(it){var Ye=wr[it];if(Ye!==void 0)return Ye.exports;var mt=wr[it]={exports:{}};return ff[it].call(mt.exports,mt,mt.exports,cn),mt.exports}cn.n=it=>{var Ye=it&&it.__esModule?()=>it.default:()=>it;return cn.d(Ye,{a:Ye}),Ye},cn.d=(it,Ye)=>{for(var mt in Ye)cn.o(Ye,mt)&&!cn.o(it,mt)&&Object.defineProperty(it,mt,{enumerable:!0,get:Ye[mt]})},cn.o=(it,Ye)=>Object.prototype.hasOwnProperty.call(it,Ye),cn.r=it=>{typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(it,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(it,"__esModule",{value:!0})};var jb={};(()=>{"use strict";var it={};cn.r(it),cn.d(it,{copyPlainText:()=>qi,encodeBase64:()=>Hl,exportByMobile:()=>hr,getEventName:()=>xs,getLocalStorage:()=>xr,getScreenWidth:()=>Ar,getTextSiyuanFromTextHTML:()=>Oi,isDisabledFeature:()=>Er,isHuawei:()=>vr,isIPad:()=>Ri,isIPhone:()=>_a,isInAndroid:()=>Je,isInHarmony:()=>ut,isInIOS:()=>Rt,isMac:()=>$t,isNotCtrl:()=>Ze,isOnlyMeta:()=>Lt,isSafari:()=>kr,isWin11:()=>Sr,isWindows:()=>Lr,openByMobile:()=>Nt,readClipboard:()=>Ls,readText:()=>ni,setStorageVal:()=>Te,updateHotkeyAfterTip:()=>Xn,updateHotkeyTip:()=>je,writeText:()=>He});var Ye=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const mt=(e,t)=>Ye(void 0,null,function*(){if(document.getElementById(t))return!1;const n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=t,document.head.appendChild(a),typeof Lute=="undefined"&&window.location.reload()}),Ke=(e,t)=>new Promise(n=>{if(document.getElementById(t))return n(!1),!1;const a=document.createElement("script");a.src=e,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(t))return a.remove(),n(!1),!1;a.id=t,n(!0)}}),hn=new Set(["docker","ios","android","harmony"]),Me=new Set(["ios","android","harmony"]),J=()=>hn.has(window.siyuan.config.system.container),ee=()=>Me.has(window.siyuan.config.system.container),P=()=>!!document.getElementById("sidebar"),me=()=>J()?window.siyuan.config.system.container:window.siyuan.config.system.os,be=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",re=()=>!document.getElementById("toolbar"),Ae=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,Pe=(e,t)=>e.length===t.length&&e.every(n=>t.includes(n)),_t=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,bt=(e,t=window.location.search)=>{const n=t.substring(t.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(e)},Be=()=>!0,Kn=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e),Mn=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e),An=e=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(e),Hn=e=>Function(`"use strict";return (${e})`)(),Ht=(e,t)=>{if(e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(!e||!t||typeof e!="object"&&typeof t!="object")return e===t;if(e.prototype!==t.prototype)return!1;const n=Object.keys(e);return n.length!==Object.keys(t).length?!1:n.every(a=>Ht(e[a],t[a]))},ti=e=>{if(!e)return"";const t=e.match(/^(.*) \((\d+)\)$/);return t?e=`${t[1]} (${parseInt(t[2])+1})`:e=`${e} (1)`,e},Ma="3.4.0",Z="production",ie=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",K=()=>{const e={};for(let t=1;t<=32;t++)e[t+111]="F"+t;return e},M=class{};M.SIYUAN_VERSION=Ma,M.NODE_ENV=Z,M.SIYUAN_APPID=Math.random().toString(36).substring(8),M.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",M.PROTYLE_CDN="/stage/protyle",M.UPLOAD_ADDRESS="/upload",M.SERVICE_WORKER_PATH="/service-worker.js",M.SIYUAN_DROP_FILE="application/siyuan-file",M.SIYUAN_DROP_GUTTER="application/siyuan-gutter",M.SIYUAN_DROP_TAB="application/siyuan-tab",M.SIYUAN_DROP_EDITOR="application/siyuan-editor",M.SIYUAN_CMD="siyuan-cmd",M.SIYUAN_GET="siyuan-get",M.SIYUAN_EVENT="siyuan-event",M.SIYUAN_CONFIG_TRAY="siyuan-config-tray",M.SIYUAN_QUIT="siyuan-quit",M.SIYUAN_HOTKEY="siyuan-hotkey",M.SIYUAN_INIT="siyuan-init",M.SIYUAN_SEND_WINDOWS="siyuan-send-windows",M.SIYUAN_SAVE_CLOSE="siyuan-save-close",M.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",M.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",M.SIYUAN_OPEN_URL="siyuan-open-url",M.SIYUAN_OPEN_WINDOW="siyuan-open-window",M.SIYUAN_OPEN_FILE="siyuan-open-file",M.SIYUAN_EXPORT_PDF="siyuan-export-pdf",M.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",M.SIYUAN_CONTEXT_MENU="siyuan-context-menu",M.SIYUAN_SHOW_WINDOW="siyuan-show-window",M.SIYUAN_RELOAD_WINDOW="siyuan-reload-window",M.CUSTOM_SY_READONLY="custom-sy-readonly",M.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",M.CUSTOM_SY_AV_VIEW="custom-sy-av-view",M.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",M.CUSTOM_RIFF_DECKS="custom-riff-decks",M.SIZE_DATABASE_MAZ_SIZE=102400,M.SIZE_SCROLL_TB=24,M.SIZE_SCROLL_STEP=256,M.SIZE_LINK_TEXT_MAX=64,M.SIZE_TOOLBAR_HEIGHT=P()?0:32,M.SIZE_GET_MAX=102400,M.SIZE_UNDO=64,M.SIZE_TITLE=512,M.SIZE_EDITOR_WIDTH=760,M.SIZE_ZOOM=[{zoom:.67,position:{x:0,y:2}},{zoom:.75,position:{x:1,y:4}},{zoom:.8,position:{x:2,y:4}},{zoom:.9,position:{x:5,y:6}},{zoom:1,position:{x:8,y:8}},{zoom:1.1,position:{x:12,y:9}},{zoom:1.25,position:{x:18,y:12}},{zoom:1.5,position:{x:27,y:16}},{zoom:1.75,position:{x:36,y:20}},{zoom:2,position:{x:45,y:23}},{zoom:2.5,position:{x:63,y:31}},{zoom:3,position:{x:80,y:39}}],M.CB_MOVE_NOLIST="cb-move-nolist",M.CB_MOUNT_REMOVE="cb-mount-remove",M.CB_GET_APPEND="cb-get-append",M.CB_GET_BEFORE="cb-get-before",M.CB_GET_UNCHANGEID="cb-get-unchangeid",M.CB_GET_HL="cb-get-hl",M.CB_GET_FOCUS="cb-get-focus",M.CB_GET_FOCUSFIRST="cb-get-focusfirst",M.CB_GET_SETID="cb-get-setid",M.CB_GET_OUTLINE="cb-get-outline",M.CB_GET_ALL="cb-get-all",M.CB_GET_BACKLINK="cb-get-backlink",M.CB_GET_UNUNDO="cb-get-unundo",M.CB_GET_SCROLL="cb-get-scroll",M.CB_GET_CONTEXT="cb-get-context",M.CB_GET_ROOTSCROLL="cb-get-rootscroll",M.CB_GET_HTML="cb-get-html",M.CB_GET_HISTORY="cb-get-history",M.CB_GET_OPENNEW="cb-get-opennew",M.LOCAL_ZOOM="local-zoom",M.LOCAL_SEARCHDATA="local-searchdata",M.LOCAL_SEARCHKEYS="local-searchkeys",M.LOCAL_SEARCHASSET="local-searchasset",M.LOCAL_SEARCHUNREF="local-searchunref",M.LOCAL_DOCINFO="local-docinfo",M.LOCAL_DAILYNOTEID="local-dailynoteid",M.LOCAL_HISTORY="local-history",M.LOCAL_CODELANG="local-codelang",M.LOCAL_FONTSTYLES="local-fontstyles",M.LOCAL_EXPORTPDF="local-exportpdf",M.LOCAL_EXPORTWORD="local-exportword",M.LOCAL_EXPORTIMG="local-exportimg",M.LOCAL_BAZAAR="local-bazaar",M.LOCAL_PDFTHEME="local-pdftheme",M.LOCAL_LAYOUTS="local-layouts",M.LOCAL_AI="local-ai",M.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",M.LOCAL_FLASHCARD="local-flashcard",M.LOCAL_FILEPOSITION="local-fileposition",M.LOCAL_FILESPATHS="local-filespaths",M.LOCAL_DIALOGPOSITION="local-dialogposition",M.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",M.LOCAL_OUTLINE="local-outline",M.LOCAL_PLUGIN_DOCKS="local-plugin-docks",M.LOCAL_IMAGES="local-images",M.LOCAL_EMOJIS="local-emojis",M.LOCAL_MOVE_PATH="local-move-path",M.LOCAL_RECENT_DOCS="local-recent-docs",M.DIALOG_CONFIRM="dialog-confirm",M.DIALOG_OPENCARD="dialog-opencard",M.DIALOG_MAKECARD="dialog-makecard",M.DIALOG_VIEWCARDS="dialog-viewcards",M.DIALOG_DIALYNOTE="dialog-dialynote",M.DIALOG_RECENTDOCS="dialog-recentdocs",M.DIALOG_SWITCHTAB="dialog-switchtab",M.DIALOG_SEARCH="dialog-search",M.DIALOG_REPLACE="dialog-replace",M.DIALOG_GLOBALSEARCH="dialog-globalsearch",M.DIALOG_HISTORYCOMPARE="dialog-historycompare",M.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",M.DIALOG_AICUSTOMACTION="dialog-aicustomaction",M.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",M.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",M.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",M.DIALOG_CHANGELOG="dialog-changelog",M.DIALOG_COMMANDPANEL="dialog-commandpanel",M.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",M.DIALOG_EMOJIS="dialog-emojis",M.DIALOG_EXPORTIMAGE="dialog-exportimage",M.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",M.DIALOG_EXPORTWORD="dialog-exportword",M.DIALOG_HISTORY="dialog-history",M.DIALOG_HISTORYDOC="dialog-historydoc",M.DIALOG_MOVEPATHTO="dialog-movepathto",M.DIALOG_RENAME="dialog-rename",M.DIALOG_RENAMEASSETS="dialog-renameassets",M.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",M.DIALOG_RENAMETAG="dialog-renametag",M.DIALOG_REPLACETYPE="dialog-replacetype",M.DIALOG_SAVECRITERION="dialog-savecriterion",M.DIALOG_SEARCHTYPE="dialog-searchtype",M.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",M.DIALOG_SETTING="dialog-setting",M.DIALOG_SNAPSHOTTAG="dialog-snapshottag",M.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",M.DIALOG_SNIPPETS="dialog-snippets",M.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",M.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",M.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",M.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",M.DIALOG_WECHATREMINDER="dialog-wechatreminder",M.DIALOG_PASSWORD="dialog-password",M.DIALOG_SETPASSWORD="dialog-setpassword",M.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",M.DIALOG_KERNELFAULT="dialog-kernelfault",M.DIALOG_STATEEXCEPTED="dialog-stateexcepted",M.DIALOG_ATTR="dialog-attr",M.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",M.DIALOG_CREATENOTEBOOK="dialog-createnotebook",M.DIALOG_NOTEBOOKCONF="dialog-notebookconf",M.DIALOG_CREATEWORKSPACE="dialog-createworkspace",M.DIALOG_OPENWORKSPACE="dialog-openworkspace",M.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",M.MENU_BAR_WORKSPACE="barWorkspace",M.MENU_BAR_PLUGIN="topBarPlugin",M.MENU_BAR_ZOOM="barZoom",M.MENU_BAR_MODE="barmode",M.MENU_BAR_MORE="barmore",M.MENU_STATUS_HELP="statusHelp",M.MENU_STATUS_BACKGROUND_TASK="statusBackgroundTask",M.MENU_DOCK_MOBILE="dockMobileMenu",M.MENU_BLOCK_SINGLE="block-single",M.MENU_BLOCK_MULTI="block-multi",M.MENU_TITLE="titleMenu",M.MENU_FROM_TITLE_PROTYLE="title-protyle",M.MENU_FROM_TITLE_BREADCRUMB="title-breadcrumb",M.MENU_BREADCRUMB_MORE="breadcrumbMore",M.MENU_BREADCRUMB_MOBILE_PATH="breadcrumb-mobile-path",M.MENU_DOC_TREE_MORE="docTreeMore",M.MENU_FROM_DOC_TREE_MORE_NOTEBOOK="tree-notebook",M.MENU_FROM_DOC_TREE_MORE_DOC="tree-doc",M.MENU_FROM_DOC_TREE_MORE_ITEMS="tree-items",M.MENU_TAG="tagMenu",M.MENU_BOOKMARK="bookmarkMenu",M.MENU_OUTLINE_CONTEXT="outline-context",M.MENU_OUTLINE_EXPAND_LEVEL="outline-expand-level",M.MENU_AV_VIEW="av-view",M.MENU_AV_HEADER_CELL="av-header-cell",M.MENU_AV_HEADER_ADD="av-header-add",M.MENU_AV_ADD_FILTER="av-add-filter",M.MENU_AV_ADD_SORT="av-add-sort",M.MENU_AV_COL_OPTION="av-col-option",M.MENU_AV_COL_FORMAT_NUMBER="av-col-format-number",M.MENU_AV_GROUP_DATE="avGroupDate",M.MENU_AV_GROUP_SORT="avGroupSort",M.MENU_AV_ASSET_EDIT="av-asset-edit",M.MENU_AV_CALC="av-calc",M.MENU_AV_PAGE_SIZE="av-page-size",M.MENU_SEARCH_MORE="searchMore",M.MENU_SEARCH_METHOD="searchMethod",M.MENU_SEARCH_ASSET_MORE="searchAssetMore",M.MENU_SEARCH_ASSET_METHOD="searchAssetMethod",M.MENU_SEARCH_UNREF_MORE="searchUnRefMore",M.MENU_SEARCH_HISTORY="search-history",M.MENU_SEARCH_REPLACE_HISTORY="search-replace-history",M.MENU_SEARCH_ASSET_HISTORY="search-asset-history",M.MENU_MOVE_PATH_HISTORY="move-path-history",M.MENU_BACKGROUND_ASSET="background-asset",M.MENU_AI="ai",M.MENU_TAB="tab",M.MENU_TAB_LIST="tabList",M.MENU_INLINE_CONTEXT="inline-context",M.MENU_INLINE_IMG="inline-img",M.MENU_INLINE_FILE_ANNOTATION_REF="inline-file-annotation-ref",M.MENU_INLINE_REF="inline-block-ref",M.MENU_INLINE_A="inline-a",M.MENU_INLINE_TAG="inline-tag",M.MENU_INLINE_MATH="inline-math",M.TIMEOUT_OPENDIALOG=50,M.TIMEOUT_DBLCLICK=190,M.TIMEOUT_INPUT=256,M.TIMEOUT_LOAD=300,M.TIMEOUT_TRANSITION=300,M.TIMEOUT_COUNT=1e3,M.HELP_PATH={ar_SA:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",en_US:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",it_IT:"20210808180117-6v0mkxr",ja_JP:"20240530133126-axarxgx",pl_PL:"20210808180117-6v0mkxr",pt_BR:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",zh_CHT:"20211226090932-5lcq56f",zh_CN:"20210808180117-czj9bvb"},M.QUICK_DECK_ID="20230218211946-2kw8jgx",M.KEYCODELIST=Object.assign(K(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),M.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:ie+"1",custom:ie+"1"},outline:{default:ie+"2",custom:ie+"2"},bookmark:{default:ie+"3",custom:ie+"3"},tag:{default:ie+"4",custom:ie+"4"},dailyNote:{default:ie+"5",custom:ie+"5"},inbox:{default:ie+"6",custom:ie+"6"},backlinks:{default:ie+"7",custom:ie+"7"},graphView:{default:ie+"8",custom:ie+"8"},globalGraph:{default:ie+"9",custom:ie+"9"},riffCard:{default:ie+"0",custom:ie+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},recentClosed:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""},switchAdjust:{default:"",custom:""},rtl:{default:"",custom:""},ltr:{default:"",custom:""},aiWriting:{default:"",custom:""},openInNewTab:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"",custom:""},insertRowBelow:{default:"",custom:""},insertColumnLeft:{default:"",custom:""},insertColumnRight:{default:"",custom:""},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},M.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},M.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!0,aText:!0,aTitle:!0,aHref:!0,code:!0,em:!0,strong:!0,inlineMath:!0,inlineMemo:!0,blockRef:!0,fileAnnotationRef:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!0,mathBlock:!0,htmlBlock:!0},M.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,M.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],M.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac",".flac"],M.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],M.SIYUAN_ASSETS_EXTS=[".pdf"].concat(M.SIYUAN_ASSETS_IMAGE).concat(M.SIYUAN_ASSETS_AUDIO).concat(M.SIYUAN_ASSETS_VIDEO),M.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub",".cs"],M.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","cybertopia-cherry","cybertopia-dimmer","cybertopia-icecap","cybertopia-saturated","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","rose-pine","rose-pine-moon","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],M.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","1c-light","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","rose-pine-dawn","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],M.ZWSP="\u200B",M.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],M.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],M.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},M.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],M.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],M.PROTYLE_TOOLBAR=P()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"];let p=M;const ue=(e,t,n=!1)=>{let a=C(e,t,n),s=!1,i=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!i;)s=C(a.parentElement,t,n),s?a=s:i=!0;return a||!1},le=(e,t)=>{let n=U(e,t),a=!1,s=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!s;)a=U(n.parentElement,t),a?n=a:s=!0;return n||!1},Y=(e,t,n,a=!1)=>{let s=O(e,t,n,a),i=!1,o=!1;for(;s&&!s.classList.contains("protyle-wysiwyg")&&!o;)i=O(s.parentElement,t,n,a),i?s=i:o=!0;return s||!1},O=(e,t,n,a=!1)=>{var s;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let i=e,o=!1;for(;i&&!o&&(a?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((s=i.getAttribute(t))!=null&&s.split(" ").includes(n))||typeof n!="string"&&i.hasAttribute(t)?o=!0:i=i.parentElement;return o&&i},U=(e,t)=>{if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let n=e,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===t?a=!0:n=n.parentElement;return a&&n},C=(e,t,n=!1)=>{var a;if(!e||e.nodeType===9)return!1;e.nodeType===3&&(e=e.parentElement);let s=e,i=!1;for(;s&&!i&&(n?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)(a=s.classList)!=null&&a.contains(t)?i=!0:s=s.parentElement;return i&&s},F=e=>{var t;const n=O(e,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((t=n.getAttribute("data-type"))!=null&&t.startsWith("Node"))?n:!1},de=e=>{const t=Y(e,"data-type","NodeBlockQueryEmbed");return t?t===e?!1:t:!1},pt=e=>C(e,"av__gallery-cover")?C(e,"av"):!1,We=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const n=F(t.parentElement);if(n)t=n;else return!1}},yt=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!de(n))return t=n,!0}),t||e},At=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!de(n)&&!n.classList.contains("li")&&!n.classList.contains("sb"))return t=n,!0}),t||e},ht=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const n=F(t.parentElement);if(n)t=n;else return!1}return!1},Nn=e=>{let t=e;for(;t;)if(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb"))t=t.querySelector("[data-node-id]");else return t;return!1},oe=e=>{if(!e||e.getAttribute("contenteditable")==="true"&&!e.classList.contains("protyle-wysiwyg"))return e;const t=e.querySelector('[contenteditable="true"]');if(t&&!O(t,"data-type","NodeBlockQueryEmbed"))return t},It=e=>{if(e.classList.contains("sb")){let t=!1;return Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!It(n))return t=!0,!0}),!t}return["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||e.getAttribute("data-type")==="NodeCodeBlock"&&e.classList.contains("render-node")},qt=e=>{var t,n;let a=e;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let s=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(i=>{if(i.textContent.replace(p.ZWSP,"").replace(`
`,"")!=="")return s=!0,!0}),s||(t=a.previousElementSibling)!=null&&t.getAttribute("data-node-id")||(n=a.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;a=a.parentElement}return a},Ve=e=>{if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)for(;e.parentElement&&!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ve(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)for(;e.parentElement&&!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ve(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)for(;e.parentElement&&!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Ve(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)for(;e.parentElement&&!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else{e=Ve(e);break}return e},qe=e=>{let t=e.nextSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.nextSibling;else return t;return!1},ya=e=>{if(e.endContainer.nodeType===3&&e.endContainer.textContent.length!==e.endOffset&&e.endContainer.textContent!==p.ZWSP&&e.endContainer.textContent!==`
`)return!1;let t=e.endContainer;for(e.endContainer.nodeType!==3&&(t=e.endContainer.childNodes[e.endOffset]);t;){if(qe(t))return!1;if(t.parentElement.getAttribute("spellcheck"))return!0;t=t.parentElement}return!0},st=e=>{let t=e.previousSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.previousSibling;else return t;return!1},Gb=e=>{let t=e.nextElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.firstElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.nextElementSibling)t=t.parentElement;else{if(t.nextElementSibling.tagName==="LI")return t.nextElementSibling;if(t.nextElementSibling.tagName==="UL")return t.nextElementSibling.firstElementChild}return!1},zb=e=>{let t=e.previousElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.lastElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.previousElementSibling)t=t.parentElement;else{if(t.previousElementSibling.tagName==="LI")return t.previousElementSibling;if(t.previousElementSibling.tagName==="UL"){const n=t.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},Kb=(e=!1)=>{};let gf,pf;const Mi=(e,t)=>{},Yt=(e,t,n=!1)=>{},Zb=()=>{gf="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(pf)},Xb=e=>{if(!e)return;let t=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${e.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${e.wordCount}<span class="fn__space"></span>`;0<e.linkCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${e.linkCount}<span class="fn__space"></span>`),0<e.imageCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${e.imageCount}<span class="fn__space"></span>`),0<e.refCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${e.refCount}<span class="fn__space"></span>`),0<e.blockCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.blockCount}</span>&nbsp;${e.blockCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=t},wa=()=>{const e=[];return window.siyuan.mobile.editor&&e.push(window.siyuan.mobile.editor),window.siyuan.mobile.popEditor&&e.push(window.siyuan.mobile.popEditor),e},ae=(e,t,n=!1)=>{if(!t){if(e.includes("dialog")){const a=window.siyuan.dialogs.length;for(let s=0;s<a;s++)window.siyuan.dialogs[s].destroy()}return}if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),t.gutter&&e.includes("gutterOnly")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML=""),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const a=t.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.toolbar.subElement.classList.add("fn__none"),t.toolbar.subElementCloseCB&&(t.toolbar.subElementCloseCB(),t.toolbar.subElementCloseCB=void 0))}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},_r=e=>{e.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(t=>{t.classList.add("fn__none"),t.style.display=""}),e.includes("util")&&wa().forEach(t=>{if(t.protyle.toolbar){const n=t.protyle.toolbar.subElement.querySelector('[data-type="pin"]');(!n||n&&n.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.protyle.toolbar.subElement.classList.add("fn__none"),t.protyle.toolbar.subElementCloseCB&&(t.protyle.toolbar.subElementCloseCB(),t.protyle.toolbar.subElementCloseCB=void 0))}}),e.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(t=>{t.classList.add("fn__none")}),e.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""})},da=(e,t=["edit","more"])=>{let n=!0;if(e){const a=e.getAttribute("data-readonly");if(typeof a=="string")n=a==="false";else return'<div class="protyle-icons"></div>'}return t.length===3?`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__reload"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit${n?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`:`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${n?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${n?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},Hi=e=>{if(e.querySelector(".protyle-cursor"))return;const t=e.getAttribute("data-type");t==="NodeBlockQueryEmbed"?e.insertAdjacentHTML("afterbegin",`<div class="protyle-icons${de(e)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div><div class="protyle-cursor">${p.ZWSP}</div>`):(t==="NodeMathBlock"||e.getAttribute("data-subtype")==="math")&&(e.firstElementChild.innerHTML=`<span></span><span class="protyle-cursor">${p.ZWSP}</span>`)},un=e=>(e.querySelectorAll("protyle-html").forEach(t=>{t.setAttribute("data-content",Lute.UnEscapeHTMLStr(t.getAttribute("data-content")))}),e),mf=(e,t)=>{if(!t){if(getSelection().rangeCount===0)return!1;t=getSelection().getRangeAt(0)}const n=t.commonAncestorContainer;return e.isEqualNode(n)||e.contains(n)},Tl=e=>{const t=O(e.startContainer,"data-type","NodeTable");if(e.toString()!==""&&t&&e.commonAncestorContainer.nodeType!==3){const n=e.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=U(e.startContainer,"TD")||U(e.startContainer,"TH"),s=U(e.endContainer,"TD")||U(e.endContainer,"TH");if(!a&&!s){const i=t.querySelector("th")||t.querySelector("td");e.setStart(i.firstChild,0),e.setEnd(i.lastChild,i.lastChild.textContent.length)}else a&&!a.contains(e.endContainer)&&ct(a,e,!1)}}},Il=(e,t,n)=>{const a=oe(t);if(a){let o;if(a.tagName==="TABLE"){const l=U(n.startContainer,"TD")||U(n.startContainer,"TH");if(l&&(o=et(l,t,n),o.start!==0||o.end!==l.textContent.length))return n.setStart(l.firstChild,0),n.setEndAfter(l.lastChild),e.toolbar.render(e,n),Mi(n,e.block.rootID),!0}else if(o=et(a,t,n),o.start!==0||o.end!==a.textContent.length){let l=a.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){n.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){n.setStartBefore(l);break}l=l.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return X(n),e.toolbar.render(e,n),Mi(n,e.block.rootID),!0}}n.collapse(!0);const s=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===s.length&&s[0].parentElement===e.wysiwyg.element)return!0;ae(["select"],e);const i=[];Array.from(e.wysiwyg.element.children).forEach(o=>{const l=o.getAttribute("data-node-id");l&&(o.classList.add("protyle-wysiwyg--select"),i.push(l))}),Yt(i,e.block.rootID)},$l=(e,t)=>{const n=document.caretRangeFromPoint(e,t),a=O(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},ye=e=>{var t,n,a;let s;if(getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0),e===s.startContainer||e.contains(s.startContainer))){if(s.toString()===""&&s.startContainer.nodeType===1){if(s.startOffset===0&&s.startContainer.classList.contains("protyle-wysiwyg")){const o=te(s.startContainer.firstChild);if(o)return o}if(s.startContainer.getAttribute("contenteditable")!=="true"&&oe(s.startContainer)){const o=F(s.startContainer);if(o){const l=te(o);if(l)return l}}}return s}if(e.classList.contains("li")||e.classList.contains("list")){const o=e.querySelector("[data-node-id]");if(o)return ye(o)}e.focus({preventScroll:!0}),s||(s=document.createRange());let i;if(e.classList.contains("table"))i=e.querySelector("th")||e.querySelector("td");else if(i=oe(e),i)i.tagName==="TABLE"&&(i=i.querySelector("th")||e.querySelector("td"));else{const o=e.getAttribute("data-type");o==="NodeThematicBreak"?i=e.firstElementChild:o==="NodeBlockQueryEmbed"?i=(t=e.querySelector(".protyle-cursor"))==null?void 0:t.firstChild:["NodeMathBlock","NodeHTMLBlock"].includes(o)?i=(a=(n=e.lastElementChild.previousElementSibling)==null?void 0:n.lastElementChild)==null?void 0:a.firstChild:o==="NodeVideo"?i=e.firstElementChild.firstChild:o==="NodeAudio"&&(i=e.firstElementChild.lastChild)}return s.setStart(i||e,0),s.collapse(!0),s},Pn=(e,t,n=!1)=>{var a,s;if(t||(t=ye(e)),!e.contains(t.startContainer))return{left:0,top:0};let i;if(t.getClientRects().length===0)if(t.startContainer.nodeType===3){const o=(a=t.startContainer.parentElement)==null?void 0:a.getClientRects(),l=(s=t.startContainer.previousElementSibling)==null?void 0:s.getClientRects();if(o.length>0||l.length>0)o.length===0||l&&l.length>0&&o[0].top<l[l.length-1].bottom?i={left:l[l.length-1].left,top:l[l.length-1].bottom}:i=o[0];else return{left:0,top:0}}else{const o=t.startContainer.children;if(o[t.startOffset]&&o[t.startOffset].getClientRects().length>0)i=o[t.startOffset].getClientRects()[0];else if(t.startContainer.childNodes.length>0){const l=t.cloneRange();t.selectNode(t.startContainer.childNodes[Math.max(0,t.startOffset-1)]),i=t.getClientRects()[0],t.setEnd(l.endContainer,l.endOffset),t.setStart(l.startContainer,l.startOffset)}else i=t.startContainer.getClientRects()[0];if(!i){let l=t.startContainer.childNodes[t.startOffset];if(l||(l=t.startContainer.childNodes[t.startOffset-1]),!l)i=t.getBoundingClientRect();else{for(;!l.getClientRects||l.getClientRects&&l.getClientRects().length===0;)l=l.parentElement;i=l.getClientRects()[0]}}}else{const o=t.getClientRects();if(t.toString())if(n){const l=window.getSelection(),r=l&&"direction"in l&&l.direction!=="none"?l.direction==="backward":t.startContainer===(l==null?void 0:l.focusNode)&&t.startOffset===(l==null?void 0:l.focusOffset),d=!r&&o[0].top!==o[o.length-1].top;return{left:r?o[0].left:o[o.length-1].right,top:d?o[o.length-1].bottom:o[0].top,isBottom:d}}else return{left:o[o.length-1].left,top:o[0].top};else return{left:o[o.length-1].left,top:o[o.length-1].top}}return{left:i.left,top:i.top}},et=(e,t,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(t&&!mf(t,n))return a;const s=n.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?s.setStart(e.childNodes[0].childNodes[0],0):s.selectNodeContents(e),s.setEnd(n.startContainer,n.startOffset),a.start=s.toString().length+s.cloneContents().querySelectorAll("br").length,a.end=a.start+n.toString().length+n.cloneContents().querySelectorAll("br").length,a};function As(e,t,n,a){if(!t)return!1;if(n(t))return!0;for(let s=0,i=t.childNodes.length;s<i;s++)if(As(t,t.childNodes[s],n,!0))return!0;if(!a){let s=t;for(;s&&s!==e;){let i=s.nextSibling;for(;i;){if(As(e,i,n,!0))return!0;i=i.nextSibling}s=s.parentNode}}return!1}const ct=(e,t,n=!0)=>{if(!e)return t;let a=e.lastChild;for(;a&&a.nodeType!==3&&a.lastChild;)a=a.lastChild;return a||(a=e),n?a.nodeType!==3&&(a.classList.contains("render-node")||a.tagName==="BR")&&a.innerHTML===""?t.setStartAfter(a):t.setStart(a,a.textContent.length):a.nodeType!==3&&(a.classList.contains("render-node")||a.tagName==="BR")&&a.innerHTML===""?t.setEndAfter(a):t.setEnd(a,a.textContent.length),t},Ha=(e,t)=>{if(!e)return t;let n=e.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return t.setStartBefore(n),t;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?t.setStartBefore(n):t.setStart(n,0),t):(t.selectNodeContents(e),t)},Ni=(e,t,n,a=!0)=>{if(!e)return!1;const s=oe(e);if(s)e=s;else if(a&&(It(e)||e.classList.contains("av")))return te(e);let i;As(e,e.firstChild,r=>{if(r.nodeType===Node.TEXT_NODE){const d=r.data.length;return t<=d?(i=r,!0):(t-=d,n-=d,!1)}else if(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="BR")return t<=1?(i=r,!0):(t-=1,n-=1,!1)});let o;i&&As(e,i,r=>{if(r.nodeType===Node.TEXT_NODE){const d=r.data.length;return n<=d?(o=r,!0):(n-=d,!1)}});const l=document.createRange();return i?i.nodeType===Node.TEXT_NODE&&t<=i.data.length?l.setStart(i,t):l.setStartAfter(i):t===0?l.setStart(e,0):ct(oe(e),l),o?n<=o.data.length?l.setEnd(o,n):l.setEndAfter(o):n===0?l.setEnd(e,0):ct(oe(e),l,!1),a&&X(l),l},Pi=(e,t,n)=>{const a=oe(e);if(!a)return;const s=et(a,e,t),i=e.cloneNode(!0),o=Ni(i,s.end,s.end,!1);o&&o.insertNode(document.createElement("wbr")),n.wysiwyg.lastHTMLs[e.getAttribute("data-node-id")]=i.outerHTML},fe=(e,t)=>{var n;const a=e.querySelectorAll("wbr");if(a.length===0)return;a.forEach((i,o)=>{o!==0&&i.remove()});const s=a[0];if(!s.previousElementSibling)s.previousSibling?t.setStart(s.previousSibling,s.previousSibling.textContent.length):s.nextSibling?s.nextSibling.nodeType===3?t.setStart(s.nextSibling,0):t.setStartAfter(s):t.setStart(s.parentElement,0);else{const i=st(s);i&&s.previousElementSibling===i?((n=s.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?t.setStart(s.previousElementSibling.lastChild,s.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?t.setStartAfter(i):t.setStartBefore(s):t.setStart(s.previousSibling,s.previousSibling.textContent.length)}t.collapse(!0),s.remove(),X(t)},X=e=>{if(!e)return;const t=e.startContainer.childNodes[e.startOffset];if(t&&t.nodeType!==3&&["INPUT","TEXTAREA"].includes(t.tagName)){t.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(e)},te=(e,t,n=!0)=>{if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")||e.classList.contains("av")){const s=document.createRange(),i=e.getAttribute("data-type");let o=!1;if(i==="NodeThematicBreak")s.selectNodeContents(e.firstElementChild),o=!0;else if(i==="NodeBlockQueryEmbed")Hi(e),s.setStart(e.querySelector(".protyle-cursor").firstChild,0),s.collapse(!0),o=!0;else if(i==="NodeMathBlock")Hi(e),s.setStart(e.firstElementChild.lastElementChild.firstChild,0),o=!0;else if(i==="NodeHTMLBlock")s.setStart(e.lastElementChild.previousElementSibling.lastElementChild.firstChild,0),s.collapse(!0),o=!0;else if(i==="NodeIFrame"||i==="NodeWidget")s.setStart(e,0),o=!0;else if(i==="NodeVideo")s.setStart(e.firstElementChild.firstChild,0),o=!0;else if(i==="NodeAudio")s.setStart(e.firstElementChild.lastChild,0),o=!0;else if(i==="NodeCodeBlock")s.selectNodeContents(e),s.collapse(!0),o=!0;else if(i==="NodeAttributeView")return!1;return o?(X(s),s):(Dl(e),!1)}let a;if(n?a=oe(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find(s=>{if(s.getBoundingClientRect().width>0)return a=s,!0}),a){if(a.tagName==="TABLE")if(n)a=a.querySelector("th, td");else{const i=a.querySelectorAll("th, td");a=i[i.length-1]}let s;if(n)s=Ha(a,ye(a)),s.collapse(!0);else{let i=!1;if(e.getAttribute("data-type")==="NodeCodeBlock"){let o=a.lastChild;if(o||(a.innerHTML=`
`,o=a.lastChild),o.textContent===""&&o.nodeType===3&&(o=st(a.lastChild)),o&&o.textContent.endsWith(`
`)){if(o.nodeType===1)for(o=o.lastChild;o&&o.textContent.indexOf(`
`)===-1;)o=o.previousSibling;s=ye(a),s.setStart(o,o.textContent.length-1),i=!0}}i||(s=ct(a,ye(a))),s.collapse(!1)}return X(s),s}else if(t)t.focus();else if(e.classList.contains("li"))return te(e.querySelector("[data-node-id]"),t,n);return!1},Dl=e=>{if(e.getAttribute("data-node-id")){let n,a;e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=ht(e)):e.previousElementSibling&&(a=!1,n=We(e)),n||(n=e),te(n,void 0,a);return}const t=ye(e);e.nextSibling?(t.selectNodeContents(e.nextSibling),t.collapse(!0)):e.previousSibling&&(t.selectNodeContents(e.previousSibling),t.collapse(!1)),X(t)},Zn=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),bf=()=>{const e=document.getElementById("message");e.innerHTML='<div class="fn__flex-1"></div>',e.addEventListener("click",t=>{let n=t.target;for(;n&&!n.isEqualNode(e);){if(n.classList.contains("b3-snackbar__close")){tt(n.parentElement.getAttribute("data-id")),t.preventDefault();break}else{if(n.tagName==="A"||n.tagName==="BUTTON")break;if(n.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&tt(n.getAttribute("data-id")),t.preventDefault(),t.stopPropagation();break}}n=n.parentElement}}),document.querySelectorAll("#tempMessage > div").forEach(t=>{se(t.innerHTML,parseInt(t.getAttribute("data-timeout")),t.getAttribute("data-type"),t.getAttribute("data-message-id")),t.remove()})},se=(e,t=6e3,n="info",a)=>{const s=document.getElementById("message").firstElementChild;if(!s){let d=document.getElementById("tempMessage");d||(document.body.insertAdjacentHTML("beforeend",`<div style="font-size: 14px;top: 22px;position: fixed;z-index: 100;right: 30px;line-height: 20px;word-break: break-word;display: flex;flex-direction: column;align-items: flex-end;" 
id="tempMessage"></div>`),d=document.getElementById("tempMessage")),d.insertAdjacentHTML("beforeend",`<div style="background: white;padding: 8px 16px;border-radius: 6px;margin-bottom: 16px;"  
data-timeout="${t}" 
data-type="${n}" 
data-message-id="${a||""}">${e}</div>`);return}const i=a||Zn(),o=s.querySelector(`.b3-snackbar[data-id="${i}"]`),l=e+(n==="error"?" v"+p.SIYUAN_VERSION:"");if(o){if(window.clearTimeout(parseInt(o.getAttribute("data-timeoutid"))),o.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>${t===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?o.classList.add("b3-snackbar--error"):o.classList.remove("b3-snackbar--error"),t>0){const d=window.setTimeout(()=>{tt(i)},t);o.setAttribute("data-timeoutid",d.toString())}return}let r=`<div data-id="${i}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>`;if(t===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(t!==-1){const d=window.setTimeout(()=>{tt(i)},t);r=r.replace("<div data-id",`<div data-timeoutid="${d}" data-id`)}return s.parentElement.classList.add("b3-snackbars--show"),s.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),s.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{s.querySelectorAll(".b3-snackbar--hide").forEach(d=>{d.classList.remove("b3-snackbar--hide")})}),s.firstElementChild.nextElementSibling&&s.firstElementChild.nextElementSibling.innerHTML===s.firstElementChild.innerHTML&&s.firstElementChild.nextElementSibling.remove(),s.scrollTo({top:0,behavior:"smooth"}),i},tt=e=>{const t=document.getElementById("message").firstElementChild;if(t)if(e){const n=t.querySelector(`[data-id="${e}"]`);n&&(n.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(n.getAttribute("data-timeoutid"))),setTimeout(()=>{n.remove(),t.childElementCount===0&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},p.TIMEOUT_INPUT));let a=!1;Array.from(t.children).find(s=>{if(!s.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},p.TIMEOUT_INPUT)};var Ml=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Hl=e=>{if(typeof Buffer!="undefined")return Buffer.from(e,"utf8").toString("base64");{const n=new TextEncoder().encode(e);let a="";const s=32768;for(let i=0;i<n.length;i+=s){const o=n.subarray(i,Math.min(i+s,n.length));a+=String.fromCharCode(...o)}return btoa(a)}},Oi=e=>{const t=e.match(/<!--data-siyuan='([^']+)'-->/);let n="",a=e;if(t)try{if(typeof Buffer!="undefined")n=Buffer.from(t[1],"base64").toString("utf8");else{const s=new TextDecoder,i=Uint8Array.from(atob(t[1]),o=>o.charCodeAt(0));n=s.decode(i)}a=e.replace(/<!--data-siyuan='[^']+'-->/,"")}catch(s){console.log("Failed to decode siyuan data from HTML comment:",s)}return{textSiyuan:n,textHtml:a}},Nt=e=>{if(e)if(Rt())if(e.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+"/assets/"+encodeURIComponent(e.replace("assets/","")));else if(e.startsWith("/"))window.webkit.messageHandlers.openLink.postMessage(location.origin+e);else try{new URL(e),window.webkit.messageHandlers.openLink.postMessage(e)}catch(t){window.webkit.messageHandlers.openLink.postMessage("https://"+e)}else Je()?window.JSAndroid.openExternal(e):ut()?window.JSHarmony.openExternal(e):window.open(e)},hr=e=>{e&&(Rt()?Nt(e):Je()?window.JSAndroid.exportByDefault(e):ut()?window.JSHarmony.exportByDefault(e):window.open(e))},ni=()=>Je()?window.JSAndroid.readClipboard():ut()?window.JSHarmony.readClipboard():typeof navigator.clipboard=="undefined"?(alert(window.siyuan.languages.clipboardPermissionDenied),""):navigator.clipboard.readText().catch(()=>{alert(window.siyuan.languages.clipboardPermissionDenied)})||"",Ls=()=>Ml(void 0,null,function*(){const e={textPlain:"",textHTML:"",siyuanHTML:""};if(Je()){e.textPlain=window.JSAndroid.readClipboard(),e.textHTML=window.JSAndroid.readHTMLClipboard();const t=Oi(e.textHTML);return e.textHTML=t.textHtml,e.siyuanHTML=t.textSiyuan,e}if(ut()){e.textPlain=window.JSHarmony.readClipboard(),e.textHTML=window.JSHarmony.readHTMLClipboard();const t=Oi(e.textHTML);return e.textHTML=t.textHtml,e.siyuanHTML=t.textSiyuan,e}if(typeof navigator.clipboard=="undefined")return alert(window.siyuan.languages.clipboardPermissionDenied),e;try{const t=yield navigator.clipboard.read().catch(()=>{alert(window.siyuan.languages.clipboardPermissionDenied)});if(!t)return e;for(const n of t){if(n.types.includes("text/html")){const a=yield n.getType("text/html");e.textHTML=yield a.text();const s=Oi(e.textHTML);e.textHTML=s.textHtml,e.siyuanHTML=s.textSiyuan}if(n.types.includes("text/plain")){const a=yield n.getType("text/plain");e.textPlain=yield a.text()}if(n.types.includes("image/png")){const a=yield n.getType("image/png");e.files=[new File([a],"image.png",{type:"image/png",lastModified:Date.now()})]}}return e}catch(t){return e}}),He=e=>{let t;getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0).cloneRange());try{if(Je()){window.JSAndroid.writeClipboard(e);return}if(ut()){window.JSHarmony.writeClipboard(e);return}if(Rt()){window.webkit.messageHandlers.setClipboard.postMessage(e);return}navigator.clipboard.writeText(e)}catch(n){if(Rt())window.webkit.messageHandlers.setClipboard.postMessage(e);else if(Je())window.JSAndroid.writeClipboard(e);else if(ut())window.JSHarmony.writeClipboard(e);else{const a=document.createElement("textarea");a.value=e,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),t&&X(t)}}},qi=e=>Ml(void 0,null,function*(){e=e.replace(new RegExp(p.ZWSP,"g"),""),yield He(e)}),xs=()=>_a()?"touchstart":"click",Lt=e=>$t()?!!(e.metaKey&&!e.ctrlKey):!!(!e.metaKey&&e.ctrlKey),Ze=e=>!e.metaKey&&!e.ctrlKey,vr=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,Er=e=>{var t;return((t=window.siyuan.config.system.disabledFeatures)==null?void 0:t.indexOf(e))>-1},_a=()=>navigator.userAgent.indexOf("iPhone")>-1,kr=()=>{const e=navigator.userAgent;return e.includes("Safari")&&!e.includes("Chrome")&&!e.includes("Chromium")},Ri=()=>navigator.userAgent.indexOf("iPad")>-1,$t=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,Sr=()=>Ml(void 0,null,function*(){if(!navigator.userAgentData||!navigator.userAgentData.getHighEntropyValues)return!1;const e=yield navigator.userAgentData.getHighEntropyValues(["platformVersion"]);return navigator.userAgentData.platform==="Windows"&&parseInt(e.platformVersion.split(".")[0])>=13}),Ar=()=>Je()?window.JSAndroid.getScreenWidthPx():ut()?window.JSHarmony.getScreenWidthPx():window.outerWidth,Lr=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,Je=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Rt=()=>{var e;return window.siyuan.config.system.container==="ios"&&((e=window.webkit)==null?void 0:e.messageHandlers)},ut=()=>window.siyuan.config.system.container==="harmony"&&window.JSHarmony,Xn=(e,t=" ")=>e?t+je(e):"",je=e=>{if(!e||$t())return e;const t=[];(e.indexOf("\u2318")>-1||e.indexOf("\u2303")>-1)&&t.push("Ctrl"),e.indexOf("\u21E7")>-1&&t.push("Shift"),e.indexOf("\u2325")>-1&&t.push("Alt");const n=e.replace(/[]/g,"");return n&&t.push({"\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"}[n]||n),t.join("+")},xr=e=>{L("/api/storage/getLocalStorage",void 0,t=>{window.siyuan.storage=t.data;const n={};n[p.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},n[p.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},p.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[p.LOCAL_SEARCHASSET].types[a]=!0}),n[p.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[p.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[p.LOCAL_LAYOUTS]=[],n[p.LOCAL_AI]=[],n[p.LOCAL_PLUGIN_DOCKS]={},n[p.LOCAL_PLUGINTOPUNPIN]=[],n[p.LOCAL_OUTLINE]={keepCurrentExpand:!1},n[p.LOCAL_FILEPOSITION]={},n[p.LOCAL_DIALOGPOSITION]={},n[p.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all",sideWidth:"256px",sideDocWidth:"256px",sideDiffWidth:"256px"},n[p.LOCAL_FLASHCARD]={fullscreen:!1},n[p.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[p.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[p.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[p.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[p.LOCAL_DOCINFO]={id:""},n[p.LOCAL_IMAGES]={file:"1f4c4",note:"1f5c3",folder:"1f4d1"},n[p.LOCAL_EMOJIS]={currentTab:"emoji"},n[p.LOCAL_FONTSTYLES]=[],n[p.LOCAL_FILESPATHS]=[],n[p.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},n[p.LOCAL_ZOOM]=1,n[p.LOCAL_MOVE_PATH]={keys:[],k:""},n[p.LOCAL_RECENT_DOCS]={type:"viewedAt"},[p.LOCAL_EXPORTIMG,p.LOCAL_SEARCHKEYS,p.LOCAL_PDFTHEME,p.LOCAL_BAZAAR,p.LOCAL_EXPORTWORD,p.LOCAL_EXPORTPDF,p.LOCAL_DOCINFO,p.LOCAL_FONTSTYLES,p.LOCAL_SEARCHDATA,p.LOCAL_ZOOM,p.LOCAL_LAYOUTS,p.LOCAL_AI,p.LOCAL_PLUGINTOPUNPIN,p.LOCAL_SEARCHASSET,p.LOCAL_FLASHCARD,p.LOCAL_DIALOGPOSITION,p.LOCAL_SEARCHUNREF,p.LOCAL_HISTORY,p.LOCAL_OUTLINE,p.LOCAL_FILEPOSITION,p.LOCAL_FILESPATHS,p.LOCAL_IMAGES,p.LOCAL_PLUGIN_DOCKS,p.LOCAL_EMOJIS,p.LOCAL_MOVE_PATH,p.LOCAL_RECENT_DOCS].forEach(a=>{if(typeof t.data[a]=="string")try{const s=JSON.parse(t.data[a]);typeof s=="number"?window.siyuan.storage[a]=s:window.siyuan.storage[a]=Object.assign(n[a],s)}catch(s){window.siyuan.storage[a]=n[a]}else typeof t.data[a]=="undefined"&&(window.siyuan.storage[a]=n[a])}),(!window.siyuan.storage[p.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[p.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[p.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)),e()})},Te=(e,t,n)=>{window.siyuan.config.readonly||window.siyuan.isPublish||L("/api/storage/setLocalStorageVal",{app:p.SIYUAN_APPID,key:e,val:t},()=>{n&&n()})},Nl=e=>{var t,n,a;if(e.cmd==="msg"){const s=se(e.msg,e.data.closeTimeout,e.code===0?"info":"error",e.data.id);return(t=document.querySelector("#message #addMicrosoftDefenderExclusion"))==null||t.addEventListener("click",i=>{i.target.innerHTML='<svg class="fn__rotate" style="margin-right: 0;"><use xlink:href="#iconRefresh"></use></svg>',L("/api/system/addMicrosoftDefenderExclusion",{},()=>{tt(s)})},{once:!0}),(n=document.querySelector("#message #ignoreAddMicrosoftDefenderExclusion"))==null||n.addEventListener("click",()=>{tt(s),L("/api/system/ignoreAddMicrosoftDefenderExclusion")},{once:!0}),!1}if(e.cmd==="cmsg")return tt(e.data.id),!1;if(e.cmd==="cprogress"){const s=document.getElementById("progress");return s&&s.remove(),!1}return e.cmd==="reloadui"?((a=e.data)!=null&&a.resetScroll?(window.siyuan.storage[p.LOCAL_FILEPOSITION]={},Te(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION],()=>{window.location.reload()})):window.location.reload(),!1):e.code<0?(se(e.msg,e.data&&e.data.closeTimeout||0,e.code===-1?"error":"info"),!1):e};class ke{constructor(t){this.disableClose=t.disableClose,this.id=Zn(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div");let n,a;if(!P()&&t.positionId){const s=window.siyuan.storage[p.LOCAL_DIALOGPOSITION][t.positionId];s&&s.left+s.width+34<=window.innerWidth&&s.top+s.height<=window.innerHeight&&(n=s.left+"px",a=s.top+"px",t.width=s.width+"px",t.height=s.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container ${t.containerClassName||""}" style="width:${t.width||"auto"};height:${t.height||"auto"};
left:${n||"auto"};top:${a||"auto"}">
  <svg ${P()&&t.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||t.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>
  <div class="b3-dialog__body">${t.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",s=>{this.disableClose||this.destroy(),s.preventDefault(),s.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",s=>{this.destroy(),s.preventDefault(),s.stopPropagation()}),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")},p.TIMEOUT_OPENDIALOG)}destroy(t){this.element.classList.remove("b3-dialog--open"),setTimeout(()=>{var n;this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(t),window.siyuan.dialogs.find((a,s)=>{if(a.id===this.id)return window.siyuan.dialogs.splice(s,1),!0}),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")},p.TIMEOUT_DBLCLICK)}bindInput(t,n,a=!0){t.focus();let s;t.addEventListener("keydown",i=>{if(i.isComposing||i.repeat){i.preventDefault();return}if(i.key==="Escape"){this.destroy(),i.preventDefault(),i.stopPropagation();return}if(!i.shiftKey&&Ze(i)&&i.key==="Enter"&&n&&a){if(s&&i.timeStamp-s<124)return;s=i.timeStamp,n(),i.preventDefault(),i.stopPropagation()}})}}const Ne=(e,t,n,a,s=!1)=>{if(!t&&!e){n();return}const i=new ke({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${t}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel" id="cancelDialogConfirmBtn">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button ${s?"b3-button--remove":"b3-button--text"}" id="confirmDialogConfirmBtn">${window.siyuan.languages[s?"delete":"confirm"]}</button>
</div>`,width:P()?"92vw":"520px"});i.element.addEventListener("click",o=>{let l=o.target;const r=typeof o.detail=="string";for(;l&&l!==i.element||r;){if(l.id==="cancelDialogConfirmBtn"||r&&o.detail==="Escape"){a&&a(i),i.destroy();break}else if(l.id==="confirmDialogConfirmBtn"||r&&o.detail==="Enter"){n&&n(i),i.destroy();break}l=l.parentElement}}),i.element.setAttribute("data-key",p.DIALOG_CONFIRM)},pe=e=>e&&e.replace(/&/g,"&amp;").replace(/</g,"&lt;"),Cs=e=>e.replace(/</g,"&lt;"),Ue=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Wt=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;");var Pl=cn(975);const Ee=(e,t,n,a=0,s=0)=>{e.style.top=n+"px",e.style.left=t+"px";const i=e.getBoundingClientRect();if(i.bottom>window.innerHeight||i.top<p.SIZE_TOOLBAR_HEIGHT){const o=n-i.height-a;o>p.SIZE_TOOLBAR_HEIGHT&&o+i.height<window.innerHeight?e.style.top=o+"px":o<=p.SIZE_TOOLBAR_HEIGHT?e.style.top=p.SIZE_TOOLBAR_HEIGHT+"px":e.style.top=Math.max(p.SIZE_TOOLBAR_HEIGHT,window.innerHeight-i.height)+"px"}i.right>window.innerWidth?e.style.left=`${window.innerWidth-i.width-s}px`:i.left<0&&(e.style.left="0")};var G=cn(353);const Cr=()=>{const e=window.siyuan.emojis[_t(0,window.siyuan.emojis.length-1)];return typeof e.items[_t(0,e.items.length-1)]=="undefined"?"1f600":e.items[_t(0,e.items.length-1)].unicode},ge=(e,t="",n=!1,a=!1)=>{if(!e)return"";let s="";if(e.startsWith("api/icon/getDynamicIcon"))s=`<img class="${t}" ${a?"data-":""}src="${e}"/>`;else if(e.indexOf(".")>-1)s=`<img class="${t}" ${a?"data-":""}src="/emojis/${e}"/>`;else try{e.split("-").forEach(i=>{i.length<5?s+=String.fromCodePoint(parseInt("0"+i,16)):s+=String.fromCodePoint(parseInt(i,16))}),n&&(s=`<span class="${t}">${s}</span>`)}catch(i){}return s},Ts=e=>{const t=new IntersectionObserver(n=>{n.forEach(a=>{const s=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&s){let i="";window.siyuan.emojis[parseInt(s)].items.forEach(o=>{i+=`<button data-unicode="${o.unicode}" class="emojis__item ariaLabel" aria-label="${Oa(o)}">
${ge(o.unicode)}</button>`}),a.target.innerHTML=i,a.target.removeAttribute("data-index"),a.target.style.minHeight=""}})});e.querySelectorAll(".emojis__content").forEach(n=>{t.observe(n)})},Bi=e=>{const t=new IntersectionObserver(n=>{n.forEach(a=>{const s=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&s&&(a.target.src=s,a.target.removeAttribute("data-src"))})});e.querySelectorAll("img").forEach(n=>{t.observe(n)})},Ui=(e="",t)=>{let n="";const a=[];e&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let s=0,i="";const o=[];window.siyuan.emojis.forEach((r,d)=>{e||(n+=`<div class="emojis__title" data-type="${d+1}">${Dt(d)}</div><div style="min-height:${d===0?"30px":"300px"}" class="emojis__content"${d>1?' data-index="'+d+'"':""}>`),r.items.length===0&&d===0&&!e&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(c=>{if(e){if(window.siyuan.config.editor.emoji.includes(c.unicode)&&(ge(c.unicode)===e||c.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||c.description.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&a.push(c),t&&s>t)return;(ge(c.unicode)===e||c.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||c.description.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&(r.id==="custom"?o.push(c):i+=`<button data-unicode="${c.unicode}" class="emojis__item ariaLabel" aria-label="${Oa(c)}">
${ge(c.unicode,void 0,!1,!0)}</button>`,s++)}else window.siyuan.config.editor.emoji.includes(c.unicode)&&a.push(c),d<2&&(n+=`<button data-unicode="${c.unicode}" class="emojis__item ariaLabel" aria-label="${Oa(c)}">
${ge(c.unicode,void 0,!1,!0)}</button>`)}),e||(n+="</div>")}),e&&(o.sort((r,d)=>{const c=r.keywords.split("/"),f=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(e.toLowerCase())<f[f.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0}).sort((r,d)=>{const c=r.keywords.split("/"),f=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(e.toLowerCase())===f[f.length-1].toLowerCase().indexOf(e.toLowerCase())&&c[c.length-1].length<f[f.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${Oa(r)}">
${ge(r.unicode,void 0,!1,!0)}</button>`}),n=n+i+"</div>");let l="";return a.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const d=a.filter(c=>c.unicode===r);d[0]&&(l+=`<button data-unicode="${d[0].unicode}" class="emojis__item ariaLabel" aria-label="${Oa(d[0])}">
${ge(d[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+n},Na=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>p.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),L("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},Tr=(e,t)=>{const n={1:["Sun","\u5468\u65E5","\u9031\u65E5"],2:["SUN","\u5468\u5929","\u9031\u5929"],3:["Sunday","\u661F\u671F\u65E5","\u661F\u671F\u65E5"],4:["SUNDAY","\u661F\u671F\u5929","\u661F\u671F\u5929"]};let a=0;return e===""&&(e=window.siyuan.config.lang),e==="zh_CN"?a=1:e==="zh_CHT"&&(a=2),`<option value="1" ${t==="1"?" selected":""}>${n[1][a]}</option>
<option value="2" ${t==="2"?" selected":""}>${n[2][a]}</option>
<option value="3" ${t==="3"?" selected":""}>${n[3][a]}</option>
<option value="4" ${t==="4"?" selected":""}>${n[4][a]}</option>`},Ir=(e,t)=>{if(!e)return;let n="";window.siyuan.emojis[parseInt(e)].items.forEach(a=>{n+=`<button data-unicode="${a.unicode}" class="emojis__item ariaLabel" aria-label="${Oa(a)}">${ge(a.unicode)}</button>`}),t.innerHTML=n,t.removeAttribute("data-index"),t.removeAttribute("style")},ha=(e,t,n,a,s)=>{t!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i="api/icon/getDynamicIcon?",o={color:"#d23f31",lang:"",date:G().format("YYYY-MM-DD"),weekdayType:"1",type:"1",content:"SiYuan"};if(s&&s.getAttribute("src").startsWith(i)){const b=new URLSearchParams(s.getAttribute("src").replace(i,""));o.color=b.get("color")||"#d23f31",o.color.startsWith("#")||(o.color="#"+o.color),o.lang=b.get("lang")||"",o.date=b.get("date")||"",o.weekdayType=b.get("weekdayType")||"1",o.type=b.get("type")||"1",o.content=b.get("content")||"SiYuan"}const l=new ke({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:P()?"80vw":"368px",height:"50vh",content:`<div class="emojis">
    <div class="emojis__tabheader">
        <div data-type="tab-emoji" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.emoji}"><svg><use xlink:href="#iconEmoji"></use></svg></div>
        <div class="fn__space"></div>
        <div data-type="tab-dynamic" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicIcon}"><svg><use xlink:href="#iconCalendar"></use></svg></div>
        <div class="fn__flex-1"></div>
        <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="emojis__tabbody">
        <div class="fn__none" data-type="tab-emoji">
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
                    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                    <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
                </label>
                <span class="fn__space"></span>
                <span class="block__icon block__icon--show fn__flex-center ariaLabel" data-action="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="emojis__panel">${Ui()}</div>
            <div class="fn__flex">
                ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",Dt(0)],["1f60d",Dt(1)],["1f433",Dt(2)],["1f96a",Dt(3)],["1f3a8",Dt(4)],["1f3dd-fe0f",Dt(5)],["1f52e",Dt(6)],["267e-fe0f",Dt(7)],["1f6a9",Dt(8)]].map(([b,w],h)=>`<div data-type="${h}" class="emojis__type ariaLabel" aria-label="${w}">${ge(b)}</div>`).join("")}
            </div>
        </div>
        <div class="fn__none" data-type="tab-dynamic">
            <div class="fn__flex emoji__dynamic-color">
                <div class="color__square fn__pointer${o.color==="#d23f31"?" color__square--current":""}" style="background-color:#d23f31"></div>
                <div class="color__square fn__pointer${o.color==="#3575f0"?" color__square--current":""}" style="background-color:#3575f0"></div>
                <div class="color__square fn__pointer${o.color==="#f3a92f"?" color__square--current":""}" style="background-color:#f3a92f"></div>
                <div class="color__square fn__pointer${o.color==="#65b84d"?" color__square--current":""}" style="background-color:#65b84d"></div>
                <div class="color__square fn__pointer${o.color==="#e099ff"?" color__square--current":""}" style="background-color:#e099ff"></div>
                <div class="color__square fn__pointer${o.color==="#ea5d97"?" color__square--current":""}" style="background-color:#ea5d97"></div>
                <div class="color__square fn__pointer${o.color==="#93627f"?" color__square--current":""}" style="background-color:#93627f"></div>
                <div class="color__square fn__pointer${o.color==="#5f6368"?" color__square--current":""}" style="background-color:#5f6368"></div>
                <div class="fn__space--small"></div>
                <input type="text" class="b3-text-field fn__flex-1 fn__flex-center" value="${o.color}">
            </div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.language}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    <option value="" ${o.lang===""?" selected":""}>${window.siyuan.languages.themeOS}</option>
                    <option value="en_US" ${o.lang==="en_US"?" selected":""}>English (en_US)</option>
                    <option value="zh_CHT" ${o.lang==="zh_CHT"?" selected":""}>\u7E41\u9AD4\u4E2D\u6587 (zh_CHT)</option>
                    <option value="zh_CN" ${o.lang==="zh_CN"?" selected":""}>\u7B80\u4F53\u4E2D\u6587 (zh_CN)</option>
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.date}</span>
                <span class="fn__space--small"></span>
                <input type="date" max="9999-12-31" class="b3-text-field fn__flex-1" value="${o.date}"/>
                <span class="fn__space--small"></span>
                <span data-action="clearDate" class="ariaLabel block__icon block__icon--show" aria-label="${window.siyuan.languages.dynamicIconDateEmptyInfo}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
                <span class="fn__space"></span>
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.format}</span>
                <span class="fn__space--small"></span>
                <select class="b3-select fn__flex-1">
                    ${Tr(o.lang,o.weekdayType)}
                </select>
                <span class="fn__space"></span>
            </div>
            <div class="fn__flex fn__flex-wrap">
                <img class="emoji__dynamic-item${o.type==="1"?" emoji__dynamic-item--current":""}" src="${i}type=1&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="2"?" emoji__dynamic-item--current":""}" src="${i}type=2&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="3"?" emoji__dynamic-item--current":""}" src="${i}type=3&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="4"?" emoji__dynamic-item--current":""}" src="${i}type=4&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="5"?" emoji__dynamic-item--current":""}" src="${i}type=5&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="6"?" emoji__dynamic-item--current":""}" src="${i}type=6&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
                <img class="emoji__dynamic-item${o.type==="7"?" emoji__dynamic-item--current":""}" src="${i}type=7&color=${encodeURIComponent(o.color)}&date=${o.date}&weekdayType=${o.weekdayType}&lang=${o.lang}">
            </div>
            <div class="fn__hr"></div>
            <div class="fn__flex">
                <span class="fn__space"></span>
                <span class="fn__flex-center ft__on-surface" style="width: 89px">${window.siyuan.languages.custom}</span>
                <span class="fn__space--small"></span>
                <input type="text" class="b3-text-field fn__flex-1" value="">
                <span class="fn__space"></span>
            </div>
            <div>
                <img data-type="text" class="emoji__dynamic-item${o.type==="8"?" emoji__dynamic-item--current":""}" src="${i}type=8&color=${encodeURIComponent(o.color)}&content=${encodeURIComponent(o.content)}&id=${e}">
            </div>
        </div>
    </div>
</div>`});l.element.setAttribute("data-key",p.DIALOG_EMOJIS),l.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const r=l.element.querySelector(".b3-dialog");r.style.justifyContent="inherit",r.style.alignItems="inherit";const d=window.siyuan.storage[p.LOCAL_EMOJIS].currentTab;l.element.querySelector(`.emojis__tabheader [data-type="tab-${d}"]`).classList.add("block__icon--active"),l.element.querySelector(`.emojis__tabbody [data-type="tab-${d}"]`).classList.remove("fn__none"),Ee(l.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),l.element.querySelector(".emojis__item").classList.add("emojis__item--current");const c=l.element.querySelector('[data-type="tab-emoji"] .b3-text-field'),f=l.element.querySelector(".emojis__panel");c.addEventListener("compositionend",()=>{var b;f.innerHTML=Ui(c.value),c.value?f.nextElementSibling.classList.add("fn__none"):f.nextElementSibling.classList.remove("fn__none"),f.scrollTop=0,(b=l.element.querySelector(".emojis__item"))==null||b.classList.add("emojis__item--current"),c.value===""&&Ts(l.element),Bi(l.element)}),c.addEventListener("input",b=>{var w;b.isComposing||(f.innerHTML=Ui(c.value),c.value?f.nextElementSibling.classList.add("fn__none"):f.nextElementSibling.classList.remove("fn__none"),f.scrollTop=0,(w=l.element.querySelector(".emojis__item"))==null||w.classList.add("emojis__item--current"),c.value===""&&Ts(l.element),Bi(l.element))}),c.addEventListener("keydown",b=>{var w,h,S,$;if(b.isComposing||b.key.indexOf("Arrow")===-1&&b.key!=="Enter")return;const D=l.element.querySelector(".emojis__item--current");if(!D)return;if(b.key==="Enter"){const k=D.getAttribute("data-unicode");t==="notebook"?L("/api/notebook/setNotebookIcon",{notebook:e,icon:k},()=>{l.destroy(),Na(k),Pa(k,e,"iconFilesRoot")}):t==="doc"&&L("/api/attr/setBlockAttrs",{id:e,attrs:{icon:k}},()=>{l.destroy(),Na(k),Pa(k,e),Is(k,e)}),a&&a(k),b.preventDefault(),b.stopPropagation();return}let v;if(b.key==="ArrowLeft")D.previousElementSibling?(D.classList.remove("emojis__item--current"),v=D.previousElementSibling,b.preventDefault(),b.stopPropagation()):(w=D.parentElement.previousElementSibling)!=null&&w.previousElementSibling&&(D.classList.remove("emojis__item--current"),v=D.parentElement.previousElementSibling.previousElementSibling.lastElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowRight")D.nextElementSibling?(D.classList.remove("emojis__item--current"),v=D.nextElementSibling,b.preventDefault(),b.stopPropagation()):(h=D.parentElement.nextElementSibling)!=null&&h.nextElementSibling&&(D.classList.remove("emojis__item--current"),v=D.parentElement.nextElementSibling.nextElementSibling.firstElementChild,b.preventDefault(),b.stopPropagation());else if(b.key==="ArrowDown"){if(D.nextElementSibling){D.classList.remove("emojis__item--current");let k=Math.floor(D.parentElement.clientWidth/(D.clientWidth+2));for(v=D;v.nextElementSibling&&k>0;)v=v.nextElementSibling,k--}else{const k=(S=D.parentElement.nextElementSibling)==null?void 0:S.nextElementSibling;k&&(v=k.firstElementChild,D.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}else if(b.key==="ArrowUp"){if(D.previousElementSibling){D.classList.remove("emojis__item--current");let k=Math.floor(D.parentElement.clientWidth/(D.clientWidth+2));for(v=D;v.previousElementSibling&&k>0;)v=v.previousElementSibling,k--}else{const k=($=D.parentElement.previousElementSibling)==null?void 0:$.previousElementSibling;k&&(v=k.lastElementChild,D.classList.remove("emojis__item--current"))}b.preventDefault(),b.stopPropagation()}if(v){v.classList.add("emojis__item--current");const k=c.clientHeight+6;v.offsetTop-k<f.scrollTop?f.scrollTop=v.offsetTop-k-6:v.offsetTop-k-f.clientHeight+v.clientHeight>f.scrollTop&&(f.scrollTop=v.offsetTop-k-f.clientHeight+v.clientHeight)}}),!P()&&d==="emoji"&&c.focus(),Ts(l.element),Bi(l.element),l.element.addEventListener("click",b=>{var w,h;let S=b.target;for(;S&&S!==l.element;){if(S.classList.contains("emojis__type")){const $=f.querySelector(`[data-type="${S.getAttribute("data-type")}"]`);if($){const D=$.nextElementSibling.getAttribute("data-index");D&&(Ir((w=$.previousElementSibling)==null?void 0:w.getAttribute("data-index"),$.previousElementSibling),Ir(D,$.nextElementSibling)),f.scrollTo({top:$.offsetTop-77})}break}else if(S.getAttribute("data-action")==="remove"){t==="notebook"?L("/api/notebook/setNotebookIcon",{notebook:e,icon:""},()=>{l.destroy(),Pa("",e,"iconFilesRoot")}):t==="doc"&&L("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},()=>{l.destroy(),Pa("",e),Is("",e)}),a&&a("");break}else if(S.classList.contains("emojis__item")||S.getAttribute("data-action")==="random"||S.classList.contains("emoji__dynamic-item")){let $="";S.classList.contains("emojis__item")?($=S.getAttribute("data-unicode"),l.destroy()):S.classList.contains("emoji__dynamic-item")?($=S.getAttribute("src"),l.destroy()):$=Cr(),t==="notebook"?L("/api/notebook/setNotebookIcon",{notebook:e,icon:$},()=>{Na($),Pa($,e,"iconFilesRoot")}):t==="doc"&&L("/api/attr/setBlockAttrs",{id:e,attrs:{icon:$}},()=>{Na($),Pa($,e),Is($,e)}),a&&a($);break}else if((h=S.getAttribute("data-type"))!=null&&h.startsWith("tab-")){r.querySelectorAll('.emojis__tabheader [data-type|="tab"]').forEach($=>{$.dataset.type===S.dataset.type?$.classList.add("block__icon--active"):$.classList.remove("block__icon--active")}),r.querySelectorAll(".emojis__tabbody > div").forEach($=>{$.dataset.type===S.dataset.type?$.classList.remove("fn__none"):$.classList.add("fn__none")}),window.siyuan.storage[p.LOCAL_EMOJIS].currentTab=S.dataset.type.replace("tab-",""),Te(p.LOCAL_EMOJIS,window.siyuan.storage[p.LOCAL_EMOJIS]);break}else if(S.classList.contains("color__square")){g[0].value=S.getAttribute("style").replace("background-color:",""),g[0].dispatchEvent(new CustomEvent("input"));break}else if(S.dataset.action==="clearDate"){u.value="",u.dispatchEvent(new CustomEvent("change"));break}S=S.parentElement}});const m=l.element.querySelectorAll('[data-type="tab-dynamic"] .b3-select');m[0].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));m[0].value?w.set("lang",m[0].value):w.delete("lang"),b.setAttribute("src",i+w.toString()),m[1].innerHTML=Tr(m[0].value,m[1].value)})}),m[1].addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));w.set("weekdayType",m[1].value),b.setAttribute("src",i+w.toString())})});const u=l.element.querySelector('[data-type="tab-dynamic"] [type="date"]');u.addEventListener("change",()=>{l.element.querySelectorAll(".fn__flex-wrap .emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));w.set("date",u.value?G(u.value).format("YYYY-MM-DD"):""),b.setAttribute("src",i+w.toString())})});const g=l.element.querySelectorAll('[data-type="tab-dynamic"] [type="text"]'),y=l.element.querySelector('.emoji__dynamic-item[data-type="text"]');g[0].addEventListener("input",()=>{g[0].value.startsWith("#")&&(l.element.querySelectorAll(".emoji__dynamic-item").forEach(b=>{const w=new URLSearchParams(b.getAttribute("src").replace(i,""));w.set("color",g[0].value),b.setAttribute("src",i+w.toString())}),l.element.querySelectorAll(".color__square").forEach(b=>{b.style.backgroundColor===g[0].value?b.classList.add("color__square--current"):b.classList.remove("color__square--current")}))}),g[1].value=o.content,g[1].addEventListener("input",()=>{const b=new URLSearchParams(y.getAttribute("src").replace(i,""));b.set("content",g[1].value),y.setAttribute("src",i+b.toString())})},Is=(e,t)=>{},Pa=(e,t,n="iconFile")=>{let a;a=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${t}"] .b3-list-item__icon`),a&&(a.innerHTML=ge(e||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?window.siyuan.storage[p.LOCAL_IMAGES].file:window.siyuan.storage[p.LOCAL_IMAGES].folder:window.siyuan.storage[p.LOCAL_IMAGES].note))),n!=="iconFile"&&ua()},Oa=e=>window.siyuan.config.lang==="zh_CN"?e.description_zh_cn:window.siyuan.config.lang==="ja_JP"?e.description_ja_jp:e.description,Dt=e=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[e].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[e].title_ja_jp:window.siyuan.emojis[e].title,yf=e=>{if(window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(n=>{t[n.keywords]=e.options.hint.emojiPath+"/"+n.unicode}),e.lute.PutEmojis(t)}},wf=()=>{L("/api/system/getEmojiConf",{},e=>{window.siyuan.emojis=e.data,wa().forEach(t=>{yf(t.protyle)})})},Jb=(e,t)=>{if(e.includes("\u2303")){if(!t.ctrlKey)return!1}else if(isMac()?t.ctrlKey:e.includes("\u2318")?!t.ctrlKey:t.ctrlKey)return!1;if(e.includes("\u2325")){if(!t.altKey)return!1}else if(t.altKey)return!1;if(e.includes("\u21E7")){if(!t.shiftKey)return!1}else if(t.shiftKey)return!1;if(e.includes("\u2318")){if(isMac()?!t.metaKey:!t.ctrlKey)return!1}else if(isMac()?t.metaKey:e.includes("\u2303")?!t.ctrlKey:t.ctrlKey)return!1;return!0},$s=(e,t)=>{const n=e.replace(t,p.ZWSP).split("");return n.forEach((a,s)=>{a===p.ZWSP&&(n[s]=t)}),n},ne=(e,t)=>{if(!e)return!1;if(e.startsWith("\u2303")&&!$t()){if(e==="\u2303D")return!1;e=e.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(e.indexOf("\u21E7")===-1&&e.indexOf("\u2318")===-1&&e.indexOf("\u2325")===-1&&e.indexOf("\u2303")===-1)return!!(Ze(t)&&!t.altKey&&!t.shiftKey&&e===p.KEYCODELIST[t.keyCode]);let n=e.split("");if(e.indexOf("F")>-1?n.forEach((s,i)=>{s==="F"&&(n[i]="F"+n.splice(i+1,1),n[i+1]&&(n[i+1]+=n.splice(i+1,1)))}):e.indexOf("PageUp")>-1?n=$s(e,"PageUp"):e.indexOf("PageDown")>-1?n=$s(e,"PageDown"):e.indexOf("Home")>-1?n=$s(e,"Home"):e.indexOf("End")>-1&&(n=$s(e,"End")),e.startsWith("\u21E7")&&n.length===2)return!!(Ze(t)&&!t.altKey&&t.shiftKey&&n[1]===p.KEYCODELIST[t.keyCode]);if(e.startsWith("\u2325")){let s=n.length===3?n[2]:n[1];n.length===4&&(s=n[3]);const i=s===p.KEYCODELIST[t.keyCode];return!!(i&&t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?Lt(t)&&e.startsWith("\u2325\u2318"):Ze(t))||i&&e.startsWith("\u2325\u21E7\u2318")&&n.length===4&&t.altKey&&t.shiftKey&&Lt(t)||i&&e.startsWith("\u2325\u21E7")&&n.length===3&&t.altKey&&t.shiftKey&&Ze(t))}if(e.startsWith("\u2303")){if(!$t())return!1;let s=n.length===3?n[2]:n[1];n.length===4?s=n[3]:n.length===5&&(s=n[4]);const i=s===p.KEYCODELIST[t.keyCode];return!!(i&&t.ctrlKey&&!t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?t.metaKey&&e.startsWith("\u2303\u2318"):!t.metaKey)||i&&e.startsWith("\u2303\u21E7")&&n.length===3&&t.ctrlKey&&!t.altKey&&t.shiftKey&&!t.metaKey||i&&e.startsWith("\u2303\u2325")&&n.length===3&&t.ctrlKey&&t.altKey&&!t.shiftKey&&!t.metaKey||i&&n.length===4&&t.ctrlKey&&(e.startsWith("\u2303\u2325\u21E7")&&t.shiftKey&&!t.metaKey&&t.altKey||e.startsWith("\u2303\u2325\u2318")&&!t.shiftKey&&t.metaKey&&t.altKey||e.startsWith("\u2303\u21E7\u2318")&&t.shiftKey&&t.metaKey&&!t.altKey)||i&&n.length===5&&t.ctrlKey&&t.shiftKey&&t.metaKey&&t.altKey)}const a=n.length>2&&n[0]==="\u21E7";return Lt(t)&&!t.altKey&&(!a&&!t.shiftKey||a&&t.shiftKey)?(a?n[2]:n[1])===p.KEYCODELIST[t.keyCode]:!1},Ol=e=>{let t=!1;return Object.keys(window.siyuan.config.keymap).find(n=>{const a=window.siyuan.config.keymap[n];if(Object.keys(a).find(s=>{const i=a[s];if(typeof i.custom=="string"){if(i.custom===e)return t=!0,!0}else if(Object.keys(i).forEach(o=>{if(i[o].custom===e)return t=!0,!0}),t)return!0}),t)return!0}),t},$r=()=>{window.siyuan.config.keymap.general&&Object.keys(window.siyuan.config.keymap.general).forEach(e=>{["fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","graphView","globalGraph","riffCard"].includes(e)&&(navigator.platform.toUpperCase().indexOf("MAC")>-1?(window.siyuan.config.keymap.general[e].default=window.siyuan.config.keymap.general[e].default.replace("\u2325","\u2303"),window.siyuan.config.keymap.general[e].default===window.siyuan.config.keymap.general[e].custom&&(window.siyuan.config.keymap.general[e].custom=window.siyuan.config.keymap.general[e].default.replace("\u2325","\u2303"))):(window.siyuan.config.keymap.general[e].default=window.siyuan.config.keymap.general[e].default.replace("\u2303","\u2325"),window.siyuan.config.keymap.general[e].default===window.siyuan.config.keymap.general[e].custom&&(window.siyuan.config.keymap.general[e].custom=window.siyuan.config.keymap.general[e].default.replace("\u2303","\u2325"))))})};class Fe{constructor(t,n){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,t){const a=this.menu.element.getAttribute("data-name");a&&a===t&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(t&&this.menu.element.setAttribute("data-name",t),this.menu.removeCB=n)}showSubMenu(t){this.menu.showSubMenu(t)}addItem(t){if(!this.isOpen)return this.menu.addItem(t)}addSeparator(t,n=!1){let a,s,i=!1;if(typeof t=="object"?(i=t.ignore||!1,s=t.index,a=t.id):typeof t=="number"&&(s=t,i=n),!(i||this.isOpen))return this.menu.addItem({id:a,type:"separator",index:s})}open(t){this.isOpen||this.menu.popup(t)}fullscreen(t="all"){this.isOpen||this.menu.fullscreen(t)}close(){this.menu.remove()}}const _f=(e,t)=>{},hf=()=>{const e=new URLSearchParams(window.location.search),t=e.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t))n=t.substring(20,42),a=bt("focus",t)==="1";else if(window.JSAndroid){const s=window.JSAndroid.getBlockURL();n=Ds(s),a=bt("focus",s)==="1"}else n=e.get("id"),a=e.get("focus")==="1";return{id:n,isZoomIn:a}},vf=e=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e),Ds=e=>e.substring(16,38),Ef=(e=window.location.href)=>{const t=new URL(window.location.origin);t.pathname="/check-auth",t.searchParams.set("to",e),window.location.href=t.href},kf=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)},vt=(e,t=!0,n=!1)=>{let a=e;return t&&(a=_e().basename(e)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},ql=e=>_e().basename(e,_e().extname(e)).replace(/-\d{14}-\w{7}/,""),Dr=e=>!e||(e=e.trim(),1>e.length)?!1:(e=e.toLowerCase(),e.startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\")?!0:Lr()?e.indexOf(":")===1:e.startsWith("/")),_e=()=>Pl.posix?Pl.posix:Pl,Qb=()=>path,Rl=e=>{const t=[];return e.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");t.find(i=>{if(a.startsWith(i.replace(".sy","")))return!0})||t.push(a)}}),t},Bl=(e,t,n)=>{L("/api/filetree/moveDocs",{toNotebook:t,fromPaths:e,toPath:n})},ca=(e,t,n,a,s=!1)=>{if(window.siyuan.dialogs.find(u=>{if(u.element.querySelector("#foldList"))return u.destroy(),!0}))return;const o=new ke({title:`<div style="padding: 8px;">
    ${a||window.siyuan.languages.move}
    <div style="max-height: 16px;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>
</div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <span data-menu="true" class="b3-form__icon-list fn__a b3-tooltips b3-tooltips__s" aria-label="${je("\u2325\u2193")}">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input class="b3-text-field fn__block" style="padding-left: 42px;" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${P()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${P()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"50vw",height:P()?"80vh":"70vh",destroyCallback(){n&&X(n)}});o.element.querySelector(".b3-dialog__header").setAttribute("style","padding:0"),o.element.setAttribute("data-key",p.DIALOG_MOVEPATHTO),t&&t.length>0&&L("/api/filetree/getHPathsByPaths",{paths:t},u=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=pe(u.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");ua(u=>{let g="";u.forEach(y=>{if(!y.closed){let b="";s&&(b=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${y.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${y.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${y.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${y.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ge(y.icon||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${pe(y.name)}</span>
    ${b}
</li></ul>`}}),r.innerHTML=g},s);const d=o.element.querySelector(".b3-text-field");d.value=window.siyuan.storage[p.LOCAL_MOVE_PATH].k;const c=u=>{if(!(u&&u.isComposing)){if(d.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),L("/api/filetree/searchDocs",{k:d.value,flashcard:s},g=>{let y="";g.data.forEach(b=>{let w="";s&&(w=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),y+=`<li class="b3-list-item${y===""?" b3-list-item--focus":""}" data-path="${b.path}" data-box="${b.box}">
    ${ge(b.boxIcon||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding: 4px 0">${pe(b.hPath)}</span>
    ${w}
</li>`}),l.innerHTML=y})}},f=()=>{const u=window.siyuan.storage[p.LOCAL_MOVE_PATH].keys;if(!u||u.length===0||u.length===1&&u[0]===d.value)return;const g=new Fe(p.MENU_MOVE_PATH_HISTORY);if(g.isOpen)return;g.element.classList.add("b3-menu--list"),g.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_MOVE_PATH].keys=[],Te(p.LOCAL_MOVE_PATH,window.siyuan.storage[p.LOCAL_MOVE_PATH])}});const y=g.addSeparator(1);let b=!0;u.forEach(h=>{if(h!==d.value&&h){const S=g.addItem({iconHTML:"",label:pe(h),action:"iconCloseRound",bind($){$.addEventListener("click",D=>{var v;C(D.target,"b3-menu__action")?(u.find((k,_)=>{if(k===h)return u.splice(_,1),!0}),window.siyuan.storage[p.LOCAL_MOVE_PATH].keys=u,Te(p.LOCAL_MOVE_PATH,window.siyuan.storage[p.LOCAL_MOVE_PATH]),(v=$.previousElementSibling)!=null&&v.classList.contains("b3-menu__separator")&&!$.nextElementSibling?window.siyuan.menus.menu.remove():$.remove()):(d.value=$.textContent,c(),window.siyuan.menus.menu.remove()),D.preventDefault(),D.stopPropagation()})}});b&&S.classList.add("b3-menu__item--current"),b=!1}}),b&&y.remove();const w=d.getBoundingClientRect();g.open({x:w.left,y:w.bottom})};c(),d.addEventListener("compositionend",u=>{c(u)}),d.addEventListener("input",u=>{c(u)}),d.addEventListener("blur",()=>{if(d.value){let u=window.siyuan.storage[p.LOCAL_MOVE_PATH].keys;u.splice(0,0,d.value),u=Array.from(new Set(u)),u.length>window.siyuan.config.search.limit&&u.splice(window.siyuan.config.search.limit,u.length-window.siyuan.config.search.limit),window.siyuan.storage[p.LOCAL_MOVE_PATH].keys=u}window.siyuan.storage[p.LOCAL_MOVE_PATH].k=d.value,Te(p.LOCAL_MOVE_PATH,window.siyuan.storage[p.LOCAL_MOVE_PATH])});const m=28;d.addEventListener("keydown",u=>{if(u.isComposing)return;if(ne("\u2325\u2193",u)){u.stopPropagation(),f();return}if(window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_MOVE_PATH_HISTORY)return;const g=l.classList.contains("fn__none")?r:l,y=g.querySelectorAll(".b3-list-item--focus");if(y.length===0)return;let b=y[0];if(u.key.startsWith("Arrow")&&y.forEach((w,h)=>{h!==0&&w.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(u.key==="ArrowRight"&&!b.querySelector(".b3-list-item__arrow--open")&&!b.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||u.key==="ArrowLeft"&&b.querySelector(".b3-list-item__arrow--open")){Ul(b,s),u.preventDefault();return}if(u.key==="ArrowLeft"){let w=b.parentElement.previousElementSibling;if(w){w.tagName!=="LI"&&(w=g.querySelector(".b3-list-item")),b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus");const h=w.getBoundingClientRect(),S=g.getBoundingClientRect();(h.top<S.top||h.bottom>S.bottom)&&w.scrollIntoView(h.top<S.top)}return u.preventDefault(),!0}if(u.key==="ArrowDown"||u.key==="ArrowRight"){let w=b;for(;w;)if(w.nextElementSibling)if(w.nextElementSibling.classList.contains("fn__none"))w=w.nextElementSibling;else{w.nextElementSibling.tagName==="UL"?w=w.nextElementSibling.firstElementChild:w=w.nextElementSibling;break}else{if(w.parentElement.id==="foldTree")break;w=w.parentElement}if(w.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus");const h=w.getBoundingClientRect(),S=r.getBoundingClientRect();(h.top<S.top||h.bottom>S.bottom)&&w.scrollIntoView(h.top<S.top)}return u.preventDefault(),!0}if(u.key==="ArrowUp"){let w=b;for(;w;)if(w.previousElementSibling)if(w.previousElementSibling.classList.contains("fn__none"))w=w.previousElementSibling;else{if(w.previousElementSibling.tagName==="LI")w=w.previousElementSibling;else{const h=w.previousElementSibling.querySelectorAll(".b3-list-item");w=h[h.length-1]}break}else{if(w.parentElement.id==="foldTree")break;w=w.parentElement}if(w.classList.contains("b3-list-item")){b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus");const h=w.getBoundingClientRect(),S=r.getBoundingClientRect();(h.top<S.top||h.bottom>S.bottom)&&w.scrollIntoView(h.top<S.top)}u.preventDefault()}}else{if(u.key==="ArrowDown"){b.classList.remove("b3-list-item--focus"),b.nextElementSibling?b.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),b=g.querySelector(".b3-list-item--focus"),(g.scrollTop<b.offsetTop-g.clientHeight+m||g.scrollTop>b.offsetTop)&&(g.scrollTop=b.offsetTop-g.clientHeight+m),u.preventDefault();return}if(u.key==="ArrowUp"){if(b.classList.remove("b3-list-item--focus"),b.previousElementSibling)b.previousElementSibling.classList.add("b3-list-item--focus");else{const w=g.children.length;g.children[w-1].classList.add("b3-list-item--focus")}b=g.querySelector(".b3-list-item--focus"),(g.scrollTop<b.offsetTop-g.clientHeight+m||g.scrollTop>b.offsetTop-m*2)&&(g.scrollTop=b.offsetTop-m*2),u.preventDefault();return}}if(u.key==="Enter"){const w=g.querySelectorAll(".b3-list-item--focus");if(w.length===0)return;const h=[],S=[];w.forEach($=>{h.push($.getAttribute("data-path")),S.push($.getAttribute("data-box"))}),e(h,S),o.destroy(),u.preventDefault()}}),o.element.addEventListener("click",u=>{let g=u.target;for(;g&&!g.isEqualNode(o.element);){if(g.classList.contains("b3-list-item__toggle")){Ul(g.parentElement,s),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-form__icon-list")){f(),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const b=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const w=[],h=[];b.forEach(S=>{w.push(S.getAttribute("data-path")),h.push(S.getAttribute("data-box"))}),e(w,h),o.destroy(),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){o.destroy(),u.preventDefault(),u.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const b=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(b.length===0)return;a===window.siyuan.languages.specifyPath&&Lt(u)?b.length===1&&b[0]===g||g.classList.toggle("b3-list-item--focus"):(b[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&Ul(g,s),u.preventDefault(),u.stopPropagation();break}g=g.parentElement}})},Ul=(e,t)=>{const n=e.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling&&e.nextElementSibling.tagName==="UL"&&e.nextElementSibling.classList.add("fn__none");return}if(e.nextElementSibling&&e.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none");return}const a=e.getAttribute("data-box");L("/api/filetree/listDocsByPath",{notebook:a,path:e.getAttribute("data-path"),flashcard:t,app:p.SIYUAN_APPID},s=>{if(s.data.files.length===0){se(window.siyuan.languages.emptyContent);return}let i="";if(s.data.files.forEach(l=>{let r="";t?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),i+=`<li data-box="${a}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ge(l.icon||(l.subFileCount===0?window.siyuan.storage[p.LOCAL_IMAGES].file:window.siyuan.storage[p.LOCAL_IMAGES].folder),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${vt(l.name,!0,!0)} <small class='ft__on-surface'>${l.hSize}</small>${l.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?"<br>"+window.siyuan.languages.name+" "+l.name1:""}${l.alias?"<br>"+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?"<br>"+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${l.hMtime}<br>${window.siyuan.languages.createdAt} ${l.hCtime}">${vt(l.name,!0,!0)}</span>
    ${r}
</li>`}),i==="")return;n.classList.add("b3-list-item__arrow--open"),e.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${i}</ul>`);const o=e.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*e.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},en=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.name,!0}),t},Sf=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.icon,!0}),t},Af=(e,t)=>{window.siyuan.notebooks.find(n=>{if(n.id===e)return n.name=t,!0})},Ms=()=>{let e=0;return window.siyuan.notebooks.forEach(t=>{t.closed||e++}),e},ua=(e,t=!1)=>{L("/api/notebook/lsNotebooks",{flashcard:t},n=>{t||(window.siyuan.notebooks=n.data.notebooks),e&&e(n.data.notebooks)})},ii=(e,t)=>e&&(!e.classList.contains(t)||e.getBoundingClientRect().height===0),Vt=(e,t,n="b3-list-item--focus",a)=>{var s;let i=e.querySelector("."+n);if(!i&&a){a.classList.add(n),a.scrollIntoView(!0);return}if(!i)return;const o=n.split("--")[0];if(t.key==="ArrowDown"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=i.nextElementSibling;ii(i,o);)i=i.nextElementSibling;if(!i)for(i=e.children[0];ii(i,o);)i=i.nextElementSibling;return i?(i.classList.add(n),(e.scrollTop<i.offsetTop-e.clientHeight+i.clientHeight||e.scrollTop>i.offsetTop)&&i.scrollIntoView(e.scrollTop>i.offsetTop),i):void 0}else if(t.key==="ArrowUp"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=i.previousElementSibling;ii(i,o);)i=i.previousElementSibling;if(!i)for(i=e.children[e.children.length-1];i&&(i.classList.contains("fn__none")||!i.classList.contains(o));)i=i.previousElementSibling;if(!i)return;i.classList.add(n);const l=e.scrollTop>i.offsetTop-(((s=i.previousElementSibling)==null?void 0:s.clientHeight)||0);return(e.scrollTop<i.offsetTop-e.clientHeight+i.clientHeight||l)&&i.scrollIntoView(l),i}else if(t.key==="Home"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=e.children[0];ii(i,o);)i=i.nextElementSibling;return i?(i.classList.add(n),i.scrollIntoView(),i):void 0}else if(t.key==="End"){for(t.preventDefault(),t.stopPropagation(),i.classList.remove(n),i=e.children[e.children.length-1];ii(i,o);)i=i.previousElementSibling;return i?(i.classList.add(n),i.scrollIntoView(!1),i):void 0}},Lf=(e,t,n="b3-list-item--focus",a)=>{var s,i;let o=e.querySelector("."+n);if(!o&&a){a.classList.add(n),a.scrollIntoView(!0);return}if(!o)return;const l=n.split("--")[0];if(t.key==="ArrowLeft"){t.preventDefault(),t.stopPropagation(),o.classList.remove(n),o.parentElement.classList.contains("b3-list")?o.querySelector(".b3-list-item__arrow--open")?(o.querySelector(".b3-list-item__arrow--open").classList.remove("b3-list-item__arrow--open"),o.nextElementSibling.classList.add("fn__none")):o=e.firstElementChild:o=o.parentElement.previousElementSibling,o.classList.add(n);const r=e.scrollTop>o.offsetTop-46-(((s=o.previousElementSibling)==null?void 0:s.clientHeight)||0);return(e.scrollTop<o.offsetTop-46-e.clientHeight+o.clientHeight||r)&&o.scrollIntoView(r),o}else{if(t.key==="ArrowRight")return t.preventDefault(),t.stopPropagation(),o.classList.remove(n),o.parentElement.classList.contains("b3-list")?o.querySelector(".b3-list-item__arrow--open")?o=o.nextElementSibling.firstElementChild:(o.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),o.nextElementSibling.classList.remove("fn__none")):o.nextElementSibling?o=o.nextElementSibling:o.parentElement.nextElementSibling&&(o=o.parentElement.nextElementSibling),o.classList.add(n),(e.scrollTop<o.offsetTop-46-e.clientHeight+o.clientHeight||e.scrollTop>o.offsetTop-46)&&o.scrollIntoView(e.scrollTop>o.offsetTop-46),o;if(t.key==="ArrowDown")return t.preventDefault(),t.stopPropagation(),o.classList.remove(n),o.nextElementSibling?(o=o.nextElementSibling,o.classList.contains(l)||(o.classList.contains("fn__none")?(o=o.nextElementSibling,o||(o=e.firstElementChild)):o=o.firstElementChild)):o=o.parentElement.nextElementSibling||e.firstElementChild,o.classList.add(n),(e.scrollTop<o.offsetTop-46-e.clientHeight+o.clientHeight||e.scrollTop>o.offsetTop-46)&&o.scrollIntoView(e.scrollTop>o.offsetTop-46),o;if(t.key==="ArrowUp"){t.preventDefault(),t.stopPropagation(),o.classList.remove(n),o.previousElementSibling?(o=o.previousElementSibling,o.classList.contains(l)||(o.classList.contains("fn__none")?o=o.previousElementSibling:o=o.lastElementChild)):o.parentElement.classList.contains("b3-list")?e.lastElementChild.classList.contains("fn__none")?o=e.lastElementChild.previousElementSibling:o=e.lastElementChild.lastElementChild:o=o.parentElement.previousElementSibling,o.classList.add(n);const r=e.scrollTop>o.offsetTop-46-(((i=o.previousElementSibling)==null?void 0:i.clientHeight)||0);return(e.scrollTop<o.offsetTop-46-e.clientHeight+o.clientHeight||r)&&o.scrollIntoView(r),o}else{if(t.key==="Home")return t.preventDefault(),t.stopPropagation(),o.classList.remove(n),o=e.children[0],o.classList.add(n),o.scrollIntoView(),o;if(t.key==="End")return t.preventDefault(),t.stopPropagation(),o.classList.remove(n),e.lastElementChild.classList.contains("fn__none")?o=e.lastElementChild.previousElementSibling:o=e.lastElementChild.lastElementChild,o.classList.add(n),o.scrollIntoView(!1),o}}},Mr=e=>{const t=new ke({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
    <div class="b3-list fn__flex-1 b3-list--background fn__none protyle-hint" style="    position: absolute;
    width: calc(100% - 48px);">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});t.element.setAttribute("data-key",p.DIALOG_RENAMETAG);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{L("/api/tag/renameTag",{oldLabel:e,newLabel:a.value},()=>{t.destroy(),window.siyuan.mobile.docks.tag.update()})});const a=t.element.querySelector("input");a.value=e,a.focus(),a.select();const s=t.element.querySelector(".b3-list--background");a.addEventListener("keydown",i=>{if(i.stopPropagation(),!i.isComposing){if(Vt(s,i),i.key==="Escape")s.classList.contains("fn__none")?t.destroy():s.classList.add("fn__none"),i.preventDefault();else if(!i.shiftKey&&Ze(i)&&i.key==="Enter"){if(s.classList.contains("fn__none"))n[1].click();else{const o=s.querySelector(".b3-list-item--focus");a.value=o.dataset.type==="new"?o.querySelector("mark").textContent.trim():o.textContent.trim(),s.classList.add("fn__none")}i.preventDefault()}}}),a.addEventListener("input",i=>{i.stopPropagation(),s.classList.remove("fn__none"),L("/api/search/searchTag",{k:a.value.trim()},o=>{let l="",r=!1;o.data.tags.forEach((d,c)=>{l+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${d}</div>
</div>`,d===`<mark>${o.data.k}</mark>`&&(r=!0)}),!r&&o.data.k&&(l=`<div data-type="new" class="b3-list-item${l?"":" b3-list-item--focus"}"><div class="fn__flex-1">${window.siyuan.languages.new} <mark>${pe(o.data.k)}</mark></div></div>`+l),s.innerHTML=l})}),s.addEventListener("click",i=>{const o=i.target,l=C(o,"b3-list-item");l&&(a.value=l.dataset.type==="new"?l.querySelector("mark").textContent.trim():l.textContent.trim(),s.classList.add("fn__none"))})},xf=()=>_e().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),Jn=(e,t)=>{e&&L("/api/block/checkBlockFold",{id:e},n=>{t(n.data.isFolded,n.data.isFolded?[p.CB_GET_FOCUS,p.CB_GET_ALL]:[p.CB_GET_FOCUS,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL],n.data.isRoot)})},Cf=()=>{let e;e=window.siyuan.mobile.docks.file.element;const t=[];Object.keys(p.HELP_PATH).forEach(n=>{t.push(p.HELP_PATH[n])}),e.childNodes.forEach(n=>{n.querySelector('[data-type="addLocal"]')||t.includes(n.getAttribute("data-url"))||n.querySelector('[data-type="more-root"]').insertAdjacentHTML("beforebegin",`<span data-type="addLocal" class="b3-list-item__action">
    <svg><use xlink:href="#iconRiffCard"></use></svg>
</span>`)})},Tf=()=>{const e=new ke({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"}),t=e.element.querySelector("input"),n=e.element.querySelectorAll(".b3-button");e.element.setAttribute("data-key",p.DIALOG_ACCESSAUTHCODE),e.bindInput(t,()=>{n[1].click()}),t.select(),n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{L("/api/system/setAccessAuthCode",{accessAuthCode:t.value})})},Mt=e=>{const t=window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io";return!e||e===""?t:`${t}/${e}`},Hr=e=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${e}`,fa=(e=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(e&&(e===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?se(window.siyuan.languages._kernel[122]):(e===window.siyuan.languages._kernel[29]&&(e=window.siyuan.languages._kernel[29].replaceAll("${accountServer}",Mt(""))),se(e))),!0),Fi=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),Yi=(e,t)=>{if(!document.getElementById(t)){const n=document.createElement("link");n.id=t,n.rel="stylesheet",n.type="text/css",n.href=e;const a=document.querySelector("#pluginsStyle");a?a.before(n):document.getElementsByTagName("head")[0].appendChild(n)}};var Nr=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Pr=e=>{var t;const n=document.getElementsByTagName("html")[0];n.setAttribute("lang",window.siyuan.config.appearance.lang),n.setAttribute("data-theme-mode",Rr()),n.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),n.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&a==="light"||window.siyuan.config.appearance.mode===0&&a==="dark")&&(L("/api/system/setAppearanceMode",{mode:a==="light"?0:1}),window.siyuan.config.appearance.mode=a==="light"?0:1);const s=document.getElementById("themeDefaultStyle"),i=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${p.SIYUAN_VERSION}`;if(s){if(!s.getAttribute("href").startsWith(i)){const g=document.createElement("link");new Promise(y=>{g.rel="stylesheet",g.href=i,g.onload=y,s.parentNode.insertBefore(g,s)}).then(()=>{s.remove(),g.id="themeDefaultStyle"})}}else Yi(i,"themeDefaultStyle");const o=document.getElementById("themeStyle");if(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight"){const g=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.css?v=${e.themeVer}`;o?o.getAttribute("href").startsWith(g)||o.setAttribute("href",g):Yi(g,"themeStyle")}else o&&o.remove();!((t=window.webkit)!=null&&t.messageHandlers)&&!window.JSAndroid&&!window.JSHarmony&&"serviceWorker"in window.navigator&&"caches"in window&&"fetch"in window&&navigator.serviceWorker&&document.head.insertAdjacentHTML("afterbegin",`<meta name="theme-color" content="${getComputedStyle(document.body).getPropertyValue("--b3-toolbar-background").trim()}">`),Or();const l=document.getElementById("themeScript"),r=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;l?l.getAttribute("src").startsWith(r)||(l.remove(),Ke(r,"themeScript")):Ke(r,"themeScript");const d=["ant","material"].includes(e.icon),c=document.getElementById("iconScript"),f=document.getElementById("iconDefaultScript"),m=`/appearance/icons/${d?e.icon:"material"}/icon.js?v=${p.SIYUAN_VERSION}`,u=`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`;if(d&&f&&f.getAttribute("src").startsWith(m)||!d&&c&&c.getAttribute("src").startsWith(u)){d&&(c==null||c.remove(),Array.from(document.body.children).forEach(g=>{g.tagName==="svg"&&!g.getAttribute("data-name")&&!["iconsMaterial","iconsAnt"].includes(g.id)&&g.remove()}));return}f&&!f.getAttribute("src").startsWith(m)&&(f.remove(),e.icon==="ant"?document.querySelectorAll("#iconsMaterial").forEach(g=>{g.remove()}):document.querySelectorAll("#iconsAnt").forEach(g=>{g.remove()})),Ke(m,"iconDefaultScript").then(()=>{c==null||c.remove(),d||Ke(u,"iconScript").then(()=>{Array.from(document.body.children).forEach((g,y)=>{g.tagName==="svg"&&y!==0&&!g.getAttribute("data-name")&&!["iconsMaterial","iconsAnt"].includes(g.id)&&g.remove()})})})},If=()=>{const e=document.getElementById("loading");e&&setTimeout(()=>{e.remove()},160),qr(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{const n=t.matches?"dark":"light";qr(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||L("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>Nr(void 0,null,function*(){if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0,document.getElementById("themeScript").remove()}catch(s){console.error("destroyTheme error: "+s)}else{window.location.reload();return}window.siyuan.config.appearance=a.data.appearance,Pr(a.data.appearance)})))})},Wi=(e=!0,t="../../../")=>Nr(void 0,null,function*(){let n;if($t()||Ri()||_a()?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1fa8f;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+21a9, U+21aa, U+2122, U+2194-2199, U+23cf, U+25b6, U+25c0, U+25fb, U+25fc, U+25aa, U+25ab, U+2600-2603,
  U+260e, U+2611, U+261d, U+2639, U+263a, U+2640, U+2642, U+2660, U+2663, U+2665, U+2666, U+2668, U+267b, U+26aa, U+26ab, 
  U+2702, U+2708, U+2934, U+2935, U+1f170, U+1f171, U+1f17e, U+1f17f, U+1f202, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, 
  U+1f251, U+1fae4, U+2049, U+203c, U+3030, U+303d, U+24c2, U+26a0, U+26a1, U+26be, U+27a1, U+2b05-2b07, U+3297, U+3299, U+a9, U+ae;
  size-adjust: 115%;
}
@font-face {
  font-family: "Emojis";
  src: local("Apple Color Emoji"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 115%;
}`:(yield Sr())?n=`@font-face {
  font-family: "Emojis Additional";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}`:n=`@font-face {
  font-family: "Emojis Reset";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1f170-1f171, U+1f17e, U+1f17f, U+1f21a, U+1f22f, U+1f232-1f23a, U+1f250, U+1f251, U+1f32b, U+1f3bc,
  U+1f411, U+1f42d, U+1f42e, U+1f431, U+1f435, U+1f441, U+1f4a8, U+1f4ab, U+1f525, U+1f600-1f60d, U+1f60f-1f623,
  U+1f625-1f62b, U+1f62d-1f63f, U+1F643, U+1F640, U+1f79, U+1f8f, U+1fa79, U+1fae4, U+1fae9, U+1fac6, U+1fabe, U+1fadf,
  U+200d, U+203c, U+2049, U+2122, U+2139, U+2194-2199, U+21a9, U+21aa, U+23cf, U+25aa, U+25ab, U+25b6, U+25c0, U+25fb-25fe,
  U+2611, U+2615, U+2618, U+261d, U+2620, U+2622, U+2623, U+2626, U+262a, U+262e, U+2638-263a, U+2640, U+2642, U+2648-2653,
  U+265f, U+2660, U+2663, U+2665, U+2666, U+267b, U+267e, U+267f, U+2692-2697, U+2699, U+269b, U+269c, U+26a0, U+26a1,
  U+26a7, U+26aa, U+26ab, U+26b0, U+26b1, U+2702, U+2708, U+2709, U+270c, U+270d, U+2712, U+2714, U+2716, U+271d, U+2733,
  U+2734, U+2744, U+2747, U+2763, U+2764, U+2934-2935, U+3030, U+303d, U+3297, U+3299, U+fe0f, U+e50a, U+a9, U+ae;
  size-adjust: 92%;
}
@font-face {
  font-family: "Emojis";
  src: url(${t}appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2"),
  local("Segoe UI Emoji"),
  local("Segoe UI Symbol"),
  local("Apple Color Emoji"),
  local("Twemoji Mozilla"),
  local("Noto Color Emoji"),
  local("Android Emoji"),
  local("EmojiSymbols");
  size-adjust: 92%;
}`,n+=`
:root { --b3-font-size-editor: ${window.siyuan.config.editor.fontSize}px }
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }${window.siyuan.config.editor.justify?`
.protyle-wysiwyg [data-node-id] { text-align: justify }`:""}`,window.siyuan.config.editor.rtl&&(n+=`
.protyle-title__input,
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {direction: rtl}
.protyle-wysiwyg [data-node-id].li > .protyle-action {
    right: 0;
    left: auto;
    direction: rtl;
}
.protyle-wysiwyg [data-node-id].li > [data-node-id] {
    margin-right: 34px;
    margin-left: 0;
}
.protyle-wysiwyg [data-node-id].li::before {
    right: 17px;
    left: auto;
}
.b3-typography table:not([style*="text-align: left"]) {
  margin-left: auto;
}`),window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "Emojis Additional", "Emojis Reset", "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),e){const a=document.getElementById("siyuanStyle");a?a.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n}),Or=(e=p.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,p.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,p.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${e}/js/highlight.js/styles/${n}.min.css?v=11.11.1`;t?t.href.includes(a)||(t.remove(),Yi(a,"protyleHljsStyle")):Yi(a,"protyleHljsStyle")},ey=e=>{},$f=e=>{if(e.startsWith("#"))return e;let t;const n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),a=(n&&n[4]||"").trim();let s=n?(n[1]|256).toString(16).slice(1)+(n[2]|256).toString(16).slice(1)+(n[3]|256).toString(16).slice(1):e;return a!==""?t=a:t=1,t=(t*255|256).toString(16).slice(1),s=s+t,s},qr=e=>{(Rt()||Je()||ut())&&setTimeout(()=>{const t=$f(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(e==="dark"?n=1:n=0),Rt()?window.webkit.messageHandlers.changeStatusBar.postMessage((t||(n===0?"#fff":"#1e1e1e"))+" "+n):Je()?window.JSAndroid.changeStatusBarColor(t,n):ut()&&window.JSHarmony.changeStatusBarColor(t,n)},500)},Rr=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?e:window.siyuan.config.appearance.mode===0?"light":"dark"},Re=(e,t=p.PROTYLE_CDN,n=1)=>{let a,s=!1;e.classList.contains("code-block")?a=e.querySelectorAll(".hljs"):e.classList.contains("item__readme")?(a=e.querySelectorAll("pre code"),a.forEach(i=>{i.parentElement.setAttribute("linenumber","false")})):e.classList.contains("b3-typography")?(a=e.querySelectorAll(".code-block code"),s=!0):a=e.querySelectorAll(".code-block .hljs"),a.length!==0&&(Or(t),Ke(`${t}/js/highlight.js/highlight.min.js?v=11.11.1`,"protyleHljsScript").then(()=>{Ke(`${t}/js/highlight.js/third-languages.js?v=2.0.1`,"protyleHljsThirdScript").then(()=>{a.forEach(i=>{const o=i.parentElement.querySelectorAll(".protyle-icon");if(o.length===2&&(o[0].setAttribute("aria-label",window.siyuan.languages.copy),o[1].setAttribute("aria-label",window.siyuan.languages.more)),i.getAttribute("data-render")==="true")return;const l=i.querySelector("wbr");let r=0;if(l){let y=l.previousSibling;for(;y;){for(r+=y.textContent.length;!y.previousSibling&&y.parentElement.tagName!=="DIV";)y=y.parentElement;y=y.previousSibling}l.remove()}let d;s?d=i.parentElement.getAttribute("data-language"):i.previousElementSibling?d=i.previousElementSibling.firstElementChild.textContent:d=i.className.replace("language-",""),window.hljs.getLanguage(d)||(d="plaintext"),i.classList.add("hljs"),i.setAttribute("data-render","true");const c=i.parentElement.getAttribute("linewrap"),f=i.parentElement.getAttribute("ligatures"),m=i.parentElement.getAttribute("linenumber"),u=i.lastElementChild?i.lastElementChild:i;c==="true"||c!=="false"&&window.siyuan.config.editor.codeLineWrap?(u.style.setProperty("white-space","pre-wrap"),u.style.setProperty("word-break","break-word")):(u.style.setProperty("white-space","pre"),u.style.setProperty("word-break","initial")),f==="true"||f!=="false"&&window.siyuan.config.editor.codeLigatures?u.style.fontVariantLigatures="normal":u.style.fontVariantLigatures="none";const g=u.textContent;i.firstElementChild&&(!s&&(m==="true"||m!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(i.firstElementChild.className="protyle-linenumber__rows",i.firstElementChild.setAttribute("contenteditable","false"),si(i,n),i.style.display=""):(i.firstElementChild.className="fn__none",i.firstElementChild.innerHTML="",u.style.paddingLeft="",i.style.display="block")),u.innerHTML=window.hljs.highlight(g+(g.endsWith(`
`)?"":`
`),{language:d,ignoreIllegals:!0}).value,l&&getSelection().rangeCount>0&&Ni(i,r,r)})})}))},si=(e,t=1)=>{const n=e.parentElement.getAttribute("lineNumber");if(n==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&n!=="true")return;e.parentElement.style.lineHeight=`${((parseInt(e.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const a=e.lastElementChild,s=a.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);s[s.length-1]===""&&s.length>1&&s.pop(),e.firstElementChild.innerHTML=`<span>${s.length}</span>`,a.style.paddingLeft=`${e.firstElementChild.clientWidth+16}px`;let i="";if(a.style.wordBreak==="break-word"){const o=window.getComputedStyle(a),l=document.createElement("div");l.className="hljs",l.setAttribute("style",`padding-left:${a.style.paddingLeft};
width: ${a.getBoundingClientRect().width/t}px;
white-space:${o.whiteSpace};
word-break:${o.wordBreak};
font-variant-ligatures:${o.fontVariantLigatures};
padding-right:0;max-height: none;box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),l.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",l),s.map(r=>{l.textContent=r.trim()?r:"<br>",i+=`<span style="height:${l.clientHeight}px"></span>`}),l.remove()}else i="<span></span>".repeat(s.length);if(e.firstElementChild.innerHTML=i,e.scrollHeight>e.clientHeight&&getSelection().rangeCount>0){const o=getSelection().getRangeAt(0);if(e.contains(o.startContainer)){const l=document.createElement("br");o.insertNode(l),l.scrollIntoView({block:"nearest"}),l.remove()}}},Br="%%params",Df=e=>{let t={responsive:"resize"};const n=e.substring(0,e.indexOf(`
`));if(n.startsWith(Br))try{t=Hn(n.substring(Br.length))}catch(a){console.error(`Failed to parse ABCJS params: ${a}`)}return t},Ur=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="abc"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&Ke(`${t}/js/abcjs/abcjs-basic-min.js?v=6.5.0`,"protyleAbcjsScript").then(()=>{const a=C(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",da(a));const i=s.firstElementChild.nextElementSibling;i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false"></div>`;const o=Lute.UnEscapeHTMLStr(s.getAttribute("data-content"));window.ABCJS.renderAbc(i.lastElementChild,o,Df(o)),s.setAttribute("data-render","true")})})};var Mf=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Fl=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="echarts"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&Ke(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{Ke(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{const a=C(e,"protyle-wysiwyg",!0);let s;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(s=a.firstElementChild.clientWidth),n.forEach(i=>Mf(void 0,null,function*(){var o,l,r;if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",da(a,["refresh","edit","more"]));const d=i.firstElementChild.nextElementSibling;if(!i.getAttribute("data-content")){d.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{!d.lastElementChild||d.childElementCount===1?d.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div style="height:${i.style.height||"420px"}" contenteditable="false"></div>`:d.lastElementChild.classList.remove("ft__error");const c=window.echarts.getInstanceById((o=d.lastElementChild)==null?void 0:o.getAttribute("_echarts_instance_")),f=yield Hn(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));c&&(((l=c.getOption().series[0])==null?void 0:l.type)!==((r=f.series[0])==null?void 0:r.type)&&c.clear(),c==null||c.resize()),window.echarts.init(d.lastElementChild,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:s}).setOption(f)}catch(c){window.echarts.dispose(d.lastElementChild),d.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" style="height:${i.style.height||"420px"}" contenteditable="false">echarts render error: <br>${c}</div>`}i.setAttribute("data-render","true")}))})})},Fr=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="graphviz"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&Ke(`${t}/js/graphviz/viz.js?v=3.11.0`,"protyleGraphVizScript").then(()=>{const a=C(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",da(a));const i=s.firstElementChild.nextElementSibling;if(!s.getAttribute("data-content")){i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{Viz.instance().then(o=>{const l=o.renderSVGElement(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false">${l.outerHTML}</div>`}).catch(o=>{i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${o}</div>`})}catch(o){console.error("Graphviz error",o)}s.setAttribute("data-render","true")})})},jt=(e,t=p.PROTYLE_CDN,n=!1)=>{let a=[];e.getAttribute("data-subtype")==="math"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(Yi(`${t}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),Ke(`${t}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{Ke(`${t}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{a.forEach(s=>{var i,o;if(s.getAttribute("data-render")==="true")return;s.setAttribute("data-render","true");let l={};try{l=Hn(window.siyuan.config.editor.katexMacros||"{}")}catch(d){console.warn("KaTex macros is not JSON",d)}const r=s.tagName==="DIV";try{const d=window.katex.renderToString(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")),{displayMode:r,output:"html",macros:l,trust:!0,strict:f=>f==="unicodeTextInMathMode"?"ignore":"warn"}),c=F(s);if(r){Hi(s),s.firstElementChild.firstElementChild.classList.remove("ft__error"),s.firstElementChild.firstElementChild.setAttribute("contenteditable","false"),s.firstElementChild.firstElementChild.innerHTML=d;const f=s.querySelectorAll(".base");f.length>0&&f[f.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const m=s.querySelector(".katex-html > .newline");m&&(m.parentElement.style.display="block")}else{s.classList.remove("ft__error"),s.innerHTML=d,c&&s.getBoundingClientRect().width>c.clientWidth?(s.style.maxWidth="100%",s.style.overflowX="auto",s.style.overflowY="hidden",s.style.display="inline-block"):(s.style.maxWidth="",s.style.overflowX="",s.style.overflowY="",s.style.display="");const f=qe(s);f?f&&f.nodeType!==3&&(((i=f.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1||f.classList.contains("img"))?s.after(document.createTextNode(p.ZWSP)):f&&!f.textContent.startsWith(`
`)&&f.textContent!==p.ZWSP&&s.insertAdjacentHTML("beforeend","&#xFEFF;"):s.parentElement.tagName!=="TH"&&s.parentElement.tagName!=="TD"?s.insertAdjacentText("afterend",`
`):s.insertAdjacentText("afterend",p.ZWSP),(o=s.previousSibling)!=null&&o.textContent.endsWith(`
`)?s.insertAdjacentText("beforebegin",p.ZWSP):!st(s)&&["TH","TD"].includes(s.parentElement.tagName)&&s.insertAdjacentText("afterbegin",p.ZWSP)}n&&setTimeout(()=>{if(r){const f=s.querySelector(".katex-display");f.clientWidth<f.scrollWidth&&f.firstElementChild.setAttribute("style",`font-size:${f.clientWidth*100/f.scrollWidth}%`)}else c&&s.offsetWidth>c.clientWidth&&s.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/s.offsetWidth}%`)})}catch(d){r?(Hi(s),s.firstElementChild.firstElementChild.setAttribute("contenteditable","false"),s.firstElementChild.firstElementChild.innerHTML=d.message,s.firstElementChild.firstElementChild.classList.add("ft__error")):(s.innerHTML=d.message,s.classList.add("ft__error"))}})})}))};var Yr=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Wr=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mermaid"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&Ke(`${t}/js/mermaid/mermaid.min.js?v=11.12.0`,"protyleMermaidScript").then(()=>{Ke(`${t}/js/mermaid/mermaid-zenuml.min.js?v=0.2.2`,"protyleMermaidZenumlScript").then(()=>Yr(void 0,null,function*(){yield window.mermaid.registerExternalDiagrams([window.zenuml]),window.mermaid.registerIconPacks([{name:"logos",loader:()=>fetch(`${t}/js/mermaid/icons.json?v=11.11.0`).then(s=>s.json())}]);const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const s=new MutationObserver(()=>{Vr(n),s.disconnect()}),i=O(n[0],"fold","1");if(i)s.observe(i,{attributeFilter:["fold"]});else{const o=C(n[0],"card__block",!0);o&&s.observe(o,{attributeFilter:["class"]})}}else Vr(n)}))})},Vr=e=>{const t=C(e[0],"protyle-wysiwyg",!0);e.forEach(n=>Yr(void 0,null,function*(){if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",da(t));const a=n.firstElementChild.nextElementSibling;if(!n.getAttribute("data-content")){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}const s="mermaid"+Lute.NewNodeID();try{a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false"><span id="${s}"></span></div>`;const i=yield window.mermaid.render(s,Lute.UnEscapeHTMLStr(n.getAttribute("data-content")));a.lastElementChild.innerHTML=i.svg}catch(i){const o=document.querySelector("#"+s);a.lastElementChild.innerHTML=`${o.outerHTML}<div class="fn__hr"></div><div class="ft__error">${i.message.replace(/\n/,"<br>")}</div>`,o.parentElement.remove()}n.setAttribute("data-render","true")}))},jr=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mindmap"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&Ke(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{const a=C(e,"protyle-wysiwyg",!0);let s;a&&a.clientWidth>0&&n[0].firstElementChild.clientWidth===0&&a.firstElementChild&&(s=a.firstElementChild.clientWidth),n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",da(a));const o=i.firstElementChild.nextElementSibling;if(!i.getAttribute("data-content")){o.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{!o.lastElementChild||o.childElementCount===1?o.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div style="height:${i.style.height||"420px"}" contenteditable="false"></div>`:o.lastElementChild.classList.remove("ft__error"),window.echarts.init(o.lastElementChild,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:s}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,r)=>{var d;return(d=r==null?void 0:r.data)!=null&&d.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"})}catch(l){window.echarts.dispose(o.lastElementChild),o.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" style="height:${i.style.height||"420px"}" contenteditable="false">Mindmap render error: <br>${l}</div>`}i.setAttribute("data-render","true")})})},Gr=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="flowchart"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&Ke(`${t}/js/flowchart.js/flowchart.min.js?v=1.18.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=new MutationObserver(()=>{zr(n),a.disconnect()}),s=O(n[0],"fold","1");if(s)a.observe(s,{attributeFilter:["fold"]});else{const i=C(n[0],"card__block",!0);i&&a.observe(i,{attributeFilter:["class"]})}}else zr(n)})},zr=e=>{const t=C(e[0],"protyle-wysiwyg",!0);e.forEach(n=>{if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",da(t));const a=n.firstElementChild.nextElementSibling;if(!n.getAttribute("data-content")){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div contenteditable="false"></div>`,flowchart.parse(Lute.UnEscapeHTMLStr(n.getAttribute("data-content"))).drawSVG(a.lastElementChild)}catch(s){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${s}</div>`}n.setAttribute("data-render","true")})},Kr=(e,t=p.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="plantuml"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&Ke(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const a=C(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",da(a));const i=s.firstElementChild.nextElementSibling;if(!s.getAttribute("data-content")){i.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${p.ZWSP}</span>`;return}try{const o=`${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")))}`;i.innerHTML=`<object type="image/svg+xml" data="${o}"/>`,i.classList.remove("ft__error"),i.firstElementChild.addEventListener("error",()=>{i.innerHTML=`<img src=${o}">`})}catch(o){i.classList.add("ft__error"),i.innerHTML=`plantuml render error: <br>${o}`}s.setAttribute("data-render","true")})})},Zr=e=>{let t=[];e.getAttribute("data-type")==="NodeHTMLBlock"?t=[e]:t=Array.from(e.querySelectorAll('[data-type="NodeHTMLBlock"]')),t.length!==0&&t.length>0&&t.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Hf=(e,t,n)=>{const a=document.createElement("div");a.innerHTML=e;let s=!1;if((a.childElementCount===1&&a.lastElementChild.style.fontFamily.indexOf("monospace")>-1||a.childElementCount===1&&a.querySelectorAll("pre").length===1||e.indexOf(`
<p class="p1">`)===0||a.childElementCount===1&&a.firstElementChild.tagName==="TABLE"&&a.querySelector(".line-number")&&a.querySelector(".line-content"))&&(s=!0),s){let i=t||e;return/\n/.test(i)?n.lute.Md2BlockDOM(i):(i=i.replace("<","&lt;").replace(">","&gt;"),"`"+i+"`")}return!1},Xe=e=>{const t=e.getAttribute("data-subtype");if(!p.SIYUAN_RENDER_CODE_LANGUAGES.includes(t)||e.getAttribute("data-type")!=="NodeHTMLBlock"){Ur(e),Zr(e),Kr(e),Wr(e),Gr(e),Fl(e),jr(e),Fr(e),jt(e);return}t==="abc"?Ur(e):t==="plantuml"?Kr(e):t==="mermaid"?Wr(e):t==="flowchart"?Gr(e):t==="echarts"?Fl(e):t==="mindmap"?jr(e):t==="graphviz"?Fr(e):t==="math"?jt(e):e.getAttribute("data-type")==="NodeHTMLBlock"&&Zr(e)},Ln=(e,t)=>{let n="";switch(e){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":t?n="icon"+t.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":t==="t"?n="iconCheck":t==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n},Hs=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){e.classList.remove("protyle-wysiwyg--hl")},1024)},Nf=(e,t,n="nearest")=>{let a;const s=e.wysiwyg.element;if(!e.preview.element.classList.contains("fn__none")){a=document.getElementById(t),a&&(e.preview.element.scrollTop=a.offsetTop,Hs(a));return}if(Array.from(s.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!de(i))return a=i,!0}),a)return Oe(e,a,n),Hs(a),a;if(t===e.block.rootID&&e.options.render.title&&e.title.editElement)return Hs(e.title.editElement),e.title.editElement},Oe=(e,t,n="nearest",a="auto")=>{var s,i,o,l,r,d;if(!e.disabled&&!t&&getSelection().rangeCount>0){const m=getSelection().getRangeAt(0),u=F(m.startContainer);if(u){if(u.classList.contains("code-block")){const S=document.createElement("br");m.insertNode(S),S.scrollIntoView({block:n,behavior:a}),S.remove();return}if(u.classList.contains("av")&&u.dataset.render==="true"){if(((i=(s=u.querySelector(".av__row--header"))==null?void 0:s.getAttribute("style"))==null?void 0:i.indexOf("transform"))>-1||((l=(o=u.querySelector(".av__row--footer"))==null?void 0:o.getAttribute("style"))==null?void 0:l.indexOf("transform"))>-1)return;const S=u.querySelector(".av__cell--select, .av__row--select, .av__gallery-item--select");S?S.scrollIntoView({block:n,behavior:a}):u.scrollIntoView({block:n,behavior:a});return}const g=m.cloneRange(),y=document.createElement("br");m.insertNode(y);const b=e.contentElement,w=y.getBoundingClientRect().top-b.getBoundingClientRect().top;let h=0;w<0?h=b.scrollTop+w:w>b.clientHeight-74&&(h=b.scrollTop+(w+74-b.clientHeight)),h!==0&&b.scroll({top:h,behavior:a}),y.remove(),X(g);return}}if(!t&&((r=document.activeElement)==null?void 0:r.tagName)!=="TEXTAREA"&&((d=document.activeElement)==null?void 0:d.tagName)!=="INPUT"&&(t=F(ye(e.wysiwyg.element).startContainer)),!t)return;const c=t.getBoundingClientRect(),f=e.contentElement.getBoundingClientRect();if(n==="start"){e.contentElement.scroll({top:e.contentElement.scrollTop+c.top-f.top,behavior:a});return}if(n==="nearest"){c.top<f.top?e.contentElement.scroll({top:e.contentElement.scrollTop+c.top-f.top,behavior:a}):c.bottom>f.bottom&&e.contentElement.scroll({top:e.contentElement.scrollTop+c.bottom-f.bottom,behavior:a});return}n==="center"&&e.contentElement.scroll({top:e.contentElement.scrollTop+c.top-(f.top+f.height/2),behavior:a})},fn=(e,t=0,n=1e3)=>{e.scroll.lastScrollTop=-1,setTimeout(()=>{e.scroll.lastScrollTop=t},n)};class Pf{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(P()?"click":"mouseover",t=>{const n=t.target;if(P()&&(C(n,"b3-menu__title")||typeof t.detail=="string"&&t.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):(this.element.style.transform="",setTimeout(()=>{this.remove()},p.TIMEOUT_DBLCLICK));return}const a=C(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const s=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(i=>{!i.contains(a)&&i!==a&&!a.contains(i)&&i.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(i=>{i.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),s&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(s))})}showSubMenu(t){const n=t.parentElement.getBoundingClientRect();t.style.top=n.top-8+"px",t.style.left=n.right+8+"px",t.style.bottom="auto";const a=t.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?t.style.left=n.left-8-a.width+"px":t.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(t.style.top="auto",t.style.bottom="8px")}preventDefault(t){!C(t.target,"b3-menu")&&!C(t.target,"keyboard__bar")&&t.preventDefault()}addItem(t){const n=new H(t);if(n)return this.append(n.element,t.index),n.element}removeScrollEvent(){window.removeEventListener(P()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(t=!1){var n;if(t){const a=window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item--show");if(a.length>0){const s=a[a.length-1];s.classList.remove("b3-menu__item--show"),s.classList.add("b3-menu__item--current"),(n=s.querySelector(".b3-menu__item--current"))==null||n.classList.remove("b3-menu__item--current");return}}window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(t,n){if(t){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(t);return}}this.element.lastElementChild.append(t)}}popup(t){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(P()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),Ee(this.element,t.x-(t.isLeft?this.element.clientWidth:0),t.y,t.h,t.w))}fullscreen(t="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{t==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100%)"}),this.element.lastElementChild.scrollTop=0)}}class H{constructor(t){if(!t.ignore){if(t.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=t.label,t.bind&&t.bind(this.element);return}if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),t.id&&this.element.setAttribute("data-id",t.id),t.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=t.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),t.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),(t.icon==="iconTrashcan"||t.warning)&&this.element.classList.add("b3-menu__item--warning"),t.element)this.element.append(t.element);else{let n=`<span class="b3-menu__label">${t.label||"&nbsp;"}</span>`;typeof t.iconHTML=="string"?n=t.iconHTML+n:n=`<svg class="b3-menu__icon ${t.iconClass||""}" style="${t.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${n}`,t.accelerator&&(n+=`<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(t.accelerator)}</span>`),t.action&&(n+=`<svg class="b3-menu__action${t.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${t.action}"></use></svg>`),t.checked&&(n+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=n}if(t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',t.submenu.forEach(a=>{var s;n.firstElementChild.append(((s=new H(a))==null?void 0:s.element)||"")}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}}const va=(e,t)=>{let n=e;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly")||n.getBoundingClientRect().height===0)&&!n.querySelector(".b3-text-field");)t?n=n.nextElementSibling:n=n.previousElementSibling;return n},ty=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return!1;const t=e.target;if(window.siyuan.menus.menu.element.contains(t)&&["INPUT","TEXTAREA"].includes(t.tagName))return!1;const n=Constants.KEYCODELIST[e.keyCode];if(n==="\u2193"||n==="\u2191"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let s;if(a?(a.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(s=va(a.previousElementSibling,!1),s||(s=va(a.parentElement.lastElementChild,!1))):(s=va(a.nextElementSibling,!0),s||(s=va(a.parentElement.firstElementChild,!0)))):n==="\u2191"?s=va(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):s=va(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),s){s.classList.contains("b3-menu__item")&&s.classList.add("b3-menu__item--current");const i=s.querySelector(":scope > .b3-text-field");i&&i.focus(),s.classList.remove("b3-menu__item--show");const o=s.parentElement.getBoundingClientRect(),l=s.getBoundingClientRect();(o.top>l.top||o.bottom<l.bottom)&&s.scrollIntoView(o.top>l.top)}return!0}else if(n==="\u2192"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!a)return!0;const s=a.querySelector(".b3-menu__submenu");if(!s)return!0;a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const i=va(s.firstElementChild.firstElementChild,!0);return i&&i.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(s),!0}else if(n==="\u2190"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!a)return!0;const s=hasClosestByClassName(a,"b3-menu__item--show");return s&&(s.classList.remove("b3-menu__item--show"),s.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(a){const s=a.querySelector(".b3-menu__submenu");if(s){a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const l=va(s.firstElementChild.firstElementChild,!0);return l&&l.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(s),!0}const i=a.querySelector(".b3-text-field"),o=a.querySelector(".b3-switch");if(i)return i.focus(),!0;o?o.click():a.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.element.contains(a)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class Of{constructor(){this.menus=[]}addSeparator(t,n){typeof t=="number"?this.menus.splice(t,0,{type:"separator",id:n}):this.menus.push({type:"separator",id:n})}addItem(t){typeof t.index=="number"?this.menus.splice(t.index,0,t):this.menus.push(t)}}class qf{constructor(t=""){this.eventTarget=document.appendChild(document.createComment(t))}on(t,n){this.eventTarget.addEventListener(t,n)}once(t,n){this.eventTarget.addEventListener(t,n,{once:!0})}off(t,n){this.eventTarget.removeEventListener(t,n)}emit(t,n){return this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:n,cancelable:!0}))}}const tn=e=>{const t=new Of;e.detail.menu=t,e.plugins.forEach(n=>{n.eventBus.emit(e.type,e.detail)}),t.menus.length>0&&(e.separatorPosition==="top"&&window.siyuan.menus.menu.append(new H({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:t.menus}).element),e.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new H({id:"separator_pluginBottom",type:"separator"}).element))},Ns=(e,t)=>{Ke(`${p.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.11.7`,"protyleViewerScript").then(()=>{const n=document.createElement("ul");let a="",s=-1;e.forEach((i,o)=>{i&&(a+=`<li><img src="${i}"></li>`,t&&s===-1&&(t.endsWith(encodeURI(i))||t.endsWith(i))&&(s=o))}),n.innerHTML=a,window.siyuan.viewer=new Viewer(n,{initialViewIndex:t?s:0,title:[1,(i,o)=>{let l=i.alt;return l||(l=i.src.substring(i.src.lastIndexOf("/")+1)),l=l.substring(0,l.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${l} [${o.naturalWidth} \xD7 ${o.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},Xr=(e,t)=>{L("/api/asset/getDocImageAssets",{id:t},n=>{Ns(n.data,e)})},Yl=(e,t,n,a)=>{L("/api/av/getCurrentAttrViewImages",{id:t,viewID:n,query:a},s=>{Ns(s.data,e)})},Vi=e=>{if(e.protyle.disabled)return;const t=new Fe(p.MENU_AV_VIEW);if(t.isOpen)return;t.addItem({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),Pt({protyle:e.protyle,blockElement:e.blockElement,type:"config",cb:s=>{s.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),t.addItem({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),Pt({protyle:e.protyle,blockElement:e.blockElement,type:"config"})}}),t.addSeparator(),t.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove();const s=Lute.NewNodeID();B(e.protyle,[{action:"duplicateAttrViewView",avID:e.blockElement.dataset.avId,previousID:e.element.dataset.id,id:s,blockID:e.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:s,blockID:e.blockElement.dataset.nodeId}])}}),e.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&t.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),B(e.protyle,[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:e.element.dataset.id,blockID:e.blockElement.dataset.nodeId}])}});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom})},Jr=e=>{const t=e.menuElement.querySelector('.b3-text-field[data-type="name"]');t.addEventListener("blur",()=>{t.value!==t.dataset.value&&(B(e.protyle,[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.value}],[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.dataset.value}]),t.dataset.value=t.value)}),t.addEventListener("keydown",a=>{a.isComposing||a.key==="Enter"&&(a.preventDefault(),t.blur(),e.menuElement.parentElement.remove())}),t.select(),t.value=t.dataset.value;const n=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');t.nextElementSibling.addEventListener("click",()=>{const a=n.parentElement;a.classList.toggle("fn__none"),a.classList.contains("fn__none")||n.focus()}),n.addEventListener("blur",()=>{n.value!==n.dataset.value&&(B(e.protyle,[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:n.value}],[{action:"setAttrViewViewDesc",avID:e.data.id,id:e.data.viewID,data:n.dataset.value}]),n.dataset.value=n.value)}),n.addEventListener("keydown",a=>{a.isComposing||a.key==="Enter"&&(a.preventDefault(),n.blur(),e.menuElement.parentElement.remove())}),n.addEventListener("input",()=>{t.nextElementSibling.setAttribute("aria-label",n.value?pe(n.value):window.siyuan.languages.addDesc)})},Qr=e=>{const t=e.view,n=Ge(e);return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-type="update-view-icon">${t.icon?ge(t.icon):`<svg style="height: 14px;width: 14px"><use xlink:href="#${Ps(e.viewType)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text" data-value="${Ue(t.name)}">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${t.desc?Wt(t.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__block" type="text" data-value="${Ue(t.desc)}">${t.desc}</textarea>
        </div>
        <div class="fn__hr"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="go-layout">
    <svg class="b3-menu__icon"><use xlink:href="#${Ps(e.viewType)}"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.layout}</span>
    <span class="b3-menu__accelerator">${nd(e.viewType)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.fields}</span>
    <span class="b3-menu__accelerator">${n.filter(a=>!a.hidden).length}/${n.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goGroups">
    <svg class="b3-menu__icon"><use xlink:href="#iconGroups"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.group}</span>
    <span class="b3-menu__accelerator">${e.view.group&&e.view.group.field?n.filter(a=>a.id===e.view.group.field)[0].name:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${e.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Rf=e=>{const t=e.menuElement.querySelector(".b3-text-field");t.focus(),t.addEventListener("keydown",n=>{if(n.stopPropagation(),!n.isComposing)if(Vt(e.menuElement.querySelector(".fn__flex-1"),n,"b3-menu__item--current"),n.key==="Enter"){const a=e.menuElement.querySelector(".b3-menu__item--current");a&&(B(e.protyle,[{action:"setAttrViewBlockView",blockID:e.blockElement.getAttribute("data-node-id"),id:a.dataset.id,avID:e.blockElement.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:e.blockElement.getAttribute("data-node-id"),id:e.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:e.blockElement.getAttribute("data-av-id")}]),e.menuElement.remove(),te(e.blockElement))}else n.key==="Escape"&&(e.menuElement.remove(),te(e.blockElement))}),t.addEventListener("input",n=>{n.isComposing||ed(e.menuElement)}),t.addEventListener("compositionend",()=>{ed(e.menuElement)})},ed=e=>{var t;const a=e.querySelector(".b3-text-field").value;e.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(s=>{!a||a.toLowerCase().indexOf(s.textContent.trim().toLowerCase())>-1||s.textContent.trim().toLowerCase().indexOf(a.toLowerCase())>-1?s.classList.remove("fn__none"):(s.classList.add("fn__none"),s.classList.remove("b3-menu__item--current"))}),e.querySelector(".b3-menu__item--current")||(t=e.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)"))==null||t.classList.add("b3-menu__item--current")},Bf=(e,t)=>{let n="";return e.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item${a.id===t?" b3-menu__item--current":""}" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch" data-av-type="${a.type}">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Ps(a.type)}"></use></svg>`}
        <span class="fn__ellipsis">${a.name}</span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${n}
</div>
</div>`},td=(e,t)=>{var n;const a=Lute.NewNodeID(),s=t.getAttribute("data-av-id"),i=t.querySelector(".av__views"),o=new Fe(void 0,()=>{i.classList.remove("av__views--show")});o.addItem({icon:"iconTable",label:window.siyuan.languages.table,click(){B(e,[{action:"addAttrViewView",avID:s,id:a,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:s,id:a,blockID:t.getAttribute("data-node-id")}])}}),o.addItem({icon:"iconBoard",label:window.siyuan.languages.kanban,click(){B(e,[{action:"addAttrViewView",avID:s,layout:"kanban",id:a,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",layout:"kanban",avID:s,id:a,blockID:t.getAttribute("data-node-id")}])}}),o.addItem({icon:"iconGallery",label:window.siyuan.languages.gallery,click(){B(e,[{action:"addAttrViewView",avID:s,layout:"gallery",id:a,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",layout:"gallery",avID:s,id:a,blockID:t.getAttribute("data-node-id")}])}}),i.classList.add("av__views--show");const l=(n=i.querySelector('.block__icon[data-type="av-add"]'))==null?void 0:n.getBoundingClientRect();o.open({x:l.left,y:l.bottom+8})},Ps=e=>{switch(e){case"table":return"iconTable";case"gallery":return"iconGallery";case"kanban":return"iconBoard"}},nd=e=>{switch(e){case"table":return window.siyuan.languages.table;case"gallery":return window.siyuan.languages.gallery;case"kanban":return window.siyuan.languages.kanban}},Ge=e=>e.viewType==="table"?e.view.columns:e.view.fields,Uf=e=>{const t=window.siyuan.dragElement.parentElement;if(t.scrollWidth>t.clientWidth){const s=t.getBoundingClientRect();e.clientX<s.left?t.scroll({left:t.scrollLeft-p.SIZE_SCROLL_STEP,behavior:"smooth"}):e.clientX>s.right&&t.scroll({left:t.scrollLeft+p.SIZE_SCROLL_STEP,behavior:"smooth"})}const n=C(document.elementFromPoint(e.clientX,window.siyuan.dragElement.getBoundingClientRect().top+10),"item");if(!n||t!==window.siyuan.dragElement.parentElement||n===window.siyuan.dragElement)return;const a=n.getBoundingClientRect();if(a.left+a.width/2<e.clientX){if(n.nextElementSibling&&n.nextElementSibling===window.siyuan.dragElement)return;n.after(window.siyuan.dragElement)}else{if(n.previousElementSibling&&n.previousElementSibling===window.siyuan.dragElement)return;n.before(window.siyuan.dragElement)}};var Ff=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const wt=e=>{e.menu.addItem({iconHTML:"",label:Wl(e.operator,!!e.data),click(){if(!e.data)B(e.protyle,[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.operator},blockID:e.blockID}],[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.oldOperator},blockID:e.blockID}]);else{e.target.querySelector(".b3-menu__accelerator").textContent=Wl(e.operator,!0);const t=Ge(e.data).find(n=>{if(n.id===e.colId)return n.rollup||(n.rollup={}),!0});t.rollup.calc={operator:e.operator},B(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:t.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:{operator:e.oldOperator}}}])}}})},ad=(e,t,n,a)=>Ff(void 0,null,function*(){let s,i,o,l,r,d;if(n)l=n.data.id,i=t.dataset.colType,r=t.dataset.calc,o=n.colId,d=n.blockID;else{const u=F(t);if(!u||(s=C(t,"av__row--footer"),!s))return;s.classList.add("av__row--show"),i=t.dataset.dtype,o=t.dataset.colId,l=u.dataset.avId,r=t.dataset.operator,d=u.dataset.nodeId}if(i==="lineNumber")return;const c=new Fe(p.MENU_AV_CALC,()=>{s&&s.classList.remove("av__row--show")});if(c.isOpen)return;wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"",data:n==null?void 0:n.data,blockID:d,target:t}),n!=null&&n.data&&i!=="checkbox"&&wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Unique values",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count all",data:n==null?void 0:n.data,blockID:d,target:t}),i!=="checkbox"?(wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count empty",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count not empty",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count values",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Count unique values",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent empty",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent not empty",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent unique values",data:n==null?void 0:n.data,blockID:d,target:t})):(wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Checked",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Unchecked",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent checked",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Percent unchecked",data:n==null?void 0:n.data,blockID:d,target:t}));let f=!1;if(i==="rollup"){let u,g,y=n==null?void 0:n.data;if(y||(y=(yield he("api/av/renderAttributeView",{id:l})).data),Ge(y).find(b=>{var w,h;if(b.id===o)return u=(w=b.rollup)==null?void 0:w.relationKeyID,g=(h=b.rollup)==null?void 0:h.keyID,!0}),u&&g){let b;Ge(y).find(w=>{var h;if(w.id===u)return b=(h=w.relation)==null?void 0:h.avID,!0}),b&&(yield he("api/av/getAttributeView",{id:b})).data.av.keyValues.find(h=>{if(h.key.id===g)return f=h.key.type==="number",!0})}}["number","template"].includes(i)||f?(wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Sum",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Average",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Median",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Min",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Max",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Range",data:n==null?void 0:n.data,blockID:d,target:t})):["date","created","updated"].includes(i)&&(wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Earliest",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Latest",data:n==null?void 0:n.data,blockID:d,target:t}),wt({menu:c,protyle:e,colId:o,avId:l,oldOperator:r,operator:"Range",data:n==null?void 0:n.data,blockID:d,target:t}));const m=t.getBoundingClientRect();c.open({x:Math.max(a||0,m.left),y:m.bottom,h:m.height})}),Yf=e=>{if(!e.calc||!e.calc.result)return"";let t=e.calc.result.number;(e.calc.operator==="Earliest"||e.calc.operator==="Latest"||e.calc.operator==="Range"&&["date","created","updated"].includes(e.type))&&(t=e.calc.result[e.type]);let n="";switch(e.calc.operator){case"Count all":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountAll}</small>`;break;case"Count values":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountValues}</small>`;break;case"Count unique values":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountUniqueValues}</small>`;break;case"Count empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountEmpty}</small>`;break;case"Count not empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultCountNotEmpty}</small>`;break;case"Percent empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentEmpty}</small>`;break;case"Percent not empty":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentNotEmpty}</small>`;break;case"Percent unique values":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultPercentUniqueValues}</small>`;break;case"Sum":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultSum}</small>`;break;case"Average":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultAverage}</small>`;break;case"Median":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMedian}</small>`;break;case"Min":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMin}</small>`;break;case"Max":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultMax}</small>`;break;case"Range":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcResultRange}</small>`;break;case"Earliest":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorEarliest}</small>`;break;case"Latest":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.calcOperatorLatest}</small>`;break;case"Checked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.checked}</small>`;break;case"Unchecked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.unchecked}</small>`;break;case"Percent checked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentChecked}</small>`;break;case"Percent unchecked":n=`<span>${t.formattedContent}</span><small>${window.siyuan.languages.percentUnchecked}</small>`;break}return n},Wl=(e,t)=>{switch(e){case void 0:case"":return t?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Unique values":return window.siyuan.languages.uniqueValues;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Percent unique values":return window.siyuan.languages.calcOperatorPercentUniqueValues;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},Vl=(e,t,n,a=!0,s)=>{L("/api/av/searchAttributeView",{keyword:t,excludes:a&&n?[n]:void 0},i=>{let o="";i.data.results.forEach((l,r)=>{const d=l.children&&l.children.length>0&&a;o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${l.avID}" data-block-id="${l.blockID}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl${a?"":" fn__none"}" style="height:auto;align-self: stretch;margin: 4px 0;">
        <svg class="b3-list-item__arrow">${d?'<use xlink:href="#iconRight"></use>':""}</svg>
    </span>
    <span class="fn__space--small"></span>
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${pe(l.avName||window.siyuan.languages._kernel[267])}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${Cs(l.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${l.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`,d&&(o+='<div class="fn__none">',l.children.forEach(c=>{const f=nd(c.viewLayout);o+=`<div style="padding-left: 48px;" class="b3-list-item b3-list-item--narrow" data-av-id="${c.avID}" data-view-id="${c.viewID}">
<span class="b3-list-item__text">${pe(c.viewName)}</span> 
<span class="b3-list-item__meta">${f}</span>
</div>`}),o+="</div>")}),e.innerHTML=o,s&&s()})},id=(e,t,n)=>{t.dataset.avId=n.dataset.avId,t.dataset.blockId=n.dataset.blockId,t.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const a=C(t,"b3-menu__items");a&&Gi(a,e,!0)},ji=(e,t,n,a=!0)=>{window.siyuan.menus.menu.remove();const s=new Fe;s.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter"${P()?"":' style="width: 50vw"'} >
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(o){const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",d=>{if(!d.isComposing&&(Lf(l,d),d.key==="Enter")){d.preventDefault(),d.stopPropagation();const c=l.querySelector(".b3-list-item--focus");n?n(c):id(e,t,c),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",d=>{d.stopPropagation(),!d.isComposing&&Vl(l,r.value,e,a)}),r.addEventListener("compositionend",()=>{Vl(l,r.value,e,a)}),o.lastElementChild.addEventListener("click",d=>{let c=d.target;for(;c&&!c.classList.contains("b3-list");){if(c.classList.contains("b3-list-item__toggle")){c.firstElementChild.classList.contains("b3-list-item__arrow--open")?(c.firstElementChild.classList.remove("b3-list-item__arrow--open"),c.parentElement.nextElementSibling.classList.add("fn__none")):(c.firstElementChild.classList.add("b3-list-item__arrow--open"),c.parentElement.nextElementSibling.classList.remove("fn__none")),d.preventDefault(),d.stopPropagation();break}else if(c.classList.contains("b3-list-item")){d.preventDefault(),d.stopPropagation(),n?n(c):id(e,t,c),window.siyuan.menus.menu.remove();break}c=c.parentElement}}),Vl(l,"",e,a,()=>{const d=t.getBoundingClientRect();s.open({x:d.left,y:d.bottom,h:d.height}),o.querySelector("input").focus()})}}),s.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const i=ue(t,"block__popover",!0);s.element.setAttribute("data-from",i?i.dataset.level+"popover":"app")},Wf=e=>{const t=e.avElement.querySelector('input[data-type="colName"]'),a=e.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),s=e.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let i;e.colsData.find(l=>{if(l.id===s)return l.relation||(l.relation={}),i=l,!0});const o=e.avElement.querySelector('[data-type="name"]').value;B(e.protyle,[{action:"updateAttrViewColRelation",avID:e.avID,keyID:s,id:a||i.relation.avID,backRelationKeyID:i.relation.avID===a&&i.relation.backKeyID||Lute.NewNodeID(),isTwoWay:e.avElement.querySelector(".b3-switch").checked,name:t.value,format:o},{action:"doUpdateUpdated",id:e.blockElement.getAttribute("data-node-id"),data:G().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColRelation",avID:e.avID,keyID:s,id:i.relation.avID||a,backRelationKeyID:i.relation.backKeyID,isTwoWay:i.relation.isTwoWay,name:t.dataset.oldValue,format:i.name}]),e.avElement.remove(),Gt(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{name:o}),te(e.blockElement)},Gi=(e,t,n=!1)=>{const a=e.querySelector('.b3-menu__item[data-type="goSearchAV"]'),s=a.nextElementSibling,i=s.querySelector(".b3-switch"),o=s.nextElementSibling,l=o.nextElementSibling,r=JSON.parse(a.dataset.oldValue);if(r.avID){const d=o.querySelector("input");n&&(a.dataset.avId!==r.avID?(d.value="",i.checked=!1):(d.value=d.dataset.oldValue,i.checked=r.isTwoWay)),i.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),a.dataset.avId&&r.avID!==a.dataset.avId||r.isTwoWay!==i.checked||d.dataset.oldValue!==d.value?l.classList.remove("fn__none"):l.classList.add("fn__none")}else a.dataset.avId&&(i.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),l.classList.remove("fn__none"))},jl=e=>{const t=e.querySelector(".b3-form__icona .b3-text-field");e.querySelector(".b3-menu__icon.fn__grab")?(t.nextElementSibling.classList.remove("fn__none"),t.style.paddingRight="26px"):(t.nextElementSibling.classList.add("fn__none"),t.style.paddingRight="")},On=e=>{if(e.type==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label fn__ellipsis ${e.isDetached?"":" popover__block"}" ${e.isDetached?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${e.id}">${e.text}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(e.type==="empty")return e.newName?`<button class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis">${window.siyuan.languages.newRowInRelation.replace("${x}",e.text).replace("${y}",e.newName)}</span>
</button>`:`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(e.type=="unselect")return`<button data-row-id="${e.rowId}" class="${e.className||"b3-menu__item ariaLabel"}" data-position="west" data-type="setRelationCell">
    <span class="b3-menu__label fn__ellipsis${e.isDetached?"":" popover__block"}" ${e.isDetached?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${e.id}">${e.text}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},sd=(e,t,n)=>{L("/api/av/getAttributeViewPrimaryKeyValues",{id:e.firstElementChild.getAttribute("data-av-id"),keyword:n},a=>{const s=a.data.rows.values||[];let i="",o="";const l=[];t.querySelectorAll(".av__cell--relation").forEach(d=>{const c=d.querySelector(".av__celltext");l.push(d.dataset.rowId),o+=`<button data-row-id="${d.dataset.rowId}" data-position="west" data-type="setRelationCell" 
class="b3-menu__item ariaLabel${c.textContent.indexOf(n)>-1?"":" fn__none"}" 
draggable="true">${On({type:"selected",id:c.dataset.id,isDetached:!c.classList.contains("av__celltext--ref"),text:Lute.EscapeHTMLStr(c.textContent||window.siyuan.languages.untitled)})}</button>`}),s.forEach(d=>{l.includes(d.blockID)||(i+=On({type:"unselect",rowId:d.blockID,id:d.block.id,isDetached:d.isDetached,text:Lute.EscapeHTMLStr(d.block.content||window.siyuan.languages.untitled)}))});const r=e.querySelector(".popover__block");e.querySelector(".b3-menu__items").innerHTML=`${o}
<button class="b3-menu__separator"></button>
${i}
${n?On({type:"empty",newName:Lute.EscapeHTMLStr(n),text:`<span style="color: var(--b3-protyle-inline-blockref-color);" class="popover__block" data-id="${r.getAttribute("data-id")}">${r.textContent}</span>`}):i?"":On({type:"empty"})}`,e.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current"),jl(e)})},Vf=e=>{L("/api/av/getAttributeViewPrimaryKeyValues",{id:e.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},t=>{const n=t.data.rows.values||[];let a="",s="";const i=[];e.cellElements[0].querySelectorAll(".av__cell--relation").forEach(c=>{const f=c.querySelector(".av__celltext");i.push(c.dataset.rowId),s+=`<button data-row-id="${c.dataset.rowId}" data-position="west" data-type="setRelationCell" class="b3-menu__item ariaLabel" 
draggable="true">${On({type:"selected",id:f.dataset.id,isDetached:!f.classList.contains("av__celltext--ref"),text:Lute.EscapeHTMLStr(f.textContent||window.siyuan.languages.untitled)})}</button>`}),n.forEach(c=>{i.includes(c.blockID)||(a+=On({type:"unselect",rowId:c.blockID,id:c.block.id,isDetached:c.isDetached,text:Lute.EscapeHTMLStr(c.block.content||window.siyuan.languages.untitled)}))}),e.menuElement.querySelector(".b3-menu__items").innerHTML=`${s}
<button class="b3-menu__separator"></button>
${a||On({type:"empty"})}`;const o=e.cellElements[e.cellElements.length-1].getBoundingClientRect();Ee(e.menuElement,o.left,o.bottom,o.height),e.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const l=e.menuElement.querySelector("input");l.focus();const r=l.parentElement.parentElement.querySelector(".popover__block");r.innerHTML=Lute.EscapeHTMLStr(t.data.name),r.setAttribute("data-id",t.data.blockIDs[0]);const d=e.menuElement.querySelector(".b3-menu__items");l.addEventListener("keydown",c=>{if(c.isComposing)return;Vt(d,c,"b3-menu__item--current");const f=e.menuElement.querySelector(".b3-menu__item--current");c.key==="Enter"&&f&&f.getAttribute("data-type")==="setRelationCell"&&(ld(e.protyle,e.blockElement,f,e.cellElements),c.preventDefault(),c.stopPropagation())}),l.addEventListener("input",c=>{c.isComposing||(sd(e.menuElement,e.cellElements[0],l.value),c.stopPropagation())}),l.addEventListener("compositionend",c=>{c.stopPropagation(),sd(e.menuElement,e.cellElements[0],l.value)}),jl(e.menuElement),e.menuElement.querySelector('[data-type="copyRelatedItems"]').addEventListener("click",()=>{let c="";const f=e.menuElement.querySelectorAll('.b3-menu__item[draggable="true"]');f.forEach(m=>{f.length>1&&(c+="- ");const u=m.querySelector(".b3-menu__label");!u.dataset.id||u.dataset.id==="undefined"?c+=u.textContent+`
`:c+=`((${u.dataset.id} "${u.textContent}"))
`}),c&&(He(c.trimEnd()),se(window.siyuan.languages.copied))})})},jf=(e,t)=>{let n;return Ge(e).find(a=>{if(a.id===rn(t[0],e.viewType))return n=a.relation,!0}),n&&n.avID?`<div data-av-id="${n.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <div class="b3-form__icona fn__flex-1" style="overflow: visible">
        <input class="b3-text-field fn__block" style="min-width: 190px"/>
        <svg class="b3-form__icona-icon ariaLabel fn__none" data-position="north" data-type="copyRelatedItems" aria-label="${window.siyuan.languages.copy} ${window.siyuan.languages.relatedItems}"><use xlink:href="#iconCopy"></use></svg>
    </div>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);max-width: 200px" data-id="" class="popover__block fn__pointer fn__ellipsis"></span>
</div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},ld=(e,t,n,a)=>{const s=C(n,"b3-menu");if(!s||s.querySelector(".dragover__bottom, .dragover__top"))return;if(!t.contains(a[0])){const o=t.getAttribute("data-av-type"),l=Tn(a[0],o);o==="table"?a[0]=t.querySelector(`.av__row[data-id="${l}"] .av__cell[data-col-id="${a[0].dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${a[0].dataset.colId}"]`):a[0]=t.querySelector(`.av__gallery-item[data-id="${l}"] .av__cell[data-field-id="${a[0].dataset.fieldId}"]`)}const i={blockIDs:[],contents:[]};if(s.querySelectorAll('[draggable="true"]').forEach(o=>{const l=o.getAttribute("data-row-id"),r=o.querySelector(".b3-menu__label");i.blockIDs.push(l),i.contents.push({type:"block",block:{id:r.getAttribute("data-id"),content:r.textContent},isDetached:!r.classList.contains("popover__block")})}),n.classList.contains("b3-menu__item")){const o=n.getAttribute("data-row-id"),l=n.querySelector(".b3-menu__label").getAttribute("data-id"),r=s.querySelector(".b3-menu__separator"),d=s.querySelector("input").value;if(n.getAttribute("draggable")){!r.nextElementSibling.getAttribute("data-row-id")&&!d&&r.nextElementSibling.remove();const c=i.blockIDs.indexOf(o);i.blockIDs.splice(c,1),i.contents.splice(c,1),r.after(n),n.outerHTML=On({type:"unselect",rowId:o,id:l,isDetached:!n.querySelector(".popover__block"),text:Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent),className:n.className})}else if(o)i.blockIDs.push(o),i.contents.push({type:"block",block:{id:l,content:n.firstElementChild.textContent},isDetached:!n.firstElementChild.getAttribute("style")}),r.before(n),n.outerHTML=`<button data-row-id="${o}" data-position="west" data-type="setRelationCell" class="${n.className}" 
draggable="true">${On({type:"selected",rowId:o,id:l,isDetached:!n.querySelector(".popover__block"),text:Lute.EscapeHTMLStr(n.querySelector(".b3-menu__label").textContent)})}</button>`,r.nextElementSibling||r.insertAdjacentHTML("afterend",On({type:"empty"}));else{const c=n.querySelector(".popover__block").getAttribute("data-id"),f=n.querySelector("b").textContent,m=Lute.NewNodeID(),u=C(a[0],"av__body");B(e,[{action:"insertAttrViewBlock",avID:s.firstElementChild.getAttribute("data-av-id"),srcs:[{itemID:m,id:Lute.NewNodeID(),isDetached:!0,content:f}],blockID:c,groupID:u?u.getAttribute("data-group-id"):""},{action:"doUpdateUpdated",id:c,data:G().format("YYYYMMDDHHmmss")}]),i.blockIDs.push(m),i.contents.push({type:"block",block:{content:f},isDetached:!0}),r.insertAdjacentHTML("beforebegin",`<button data-row-id="${m}" data-position="west" data-type="setRelationCell" 
class="${n.className} ariaLabel" draggable="true">${On({type:"selected",rowId:m,isDetached:!0,text:Lute.EscapeHTMLStr(f)})}</button>`)}}Zt(e,t,i,a),jl(s)},Gf=e=>{const t=e.nodeElement.getAttribute("data-av-id"),n=e.nodeElement.getAttribute("data-node-id"),a=e.target.querySelector(".b3-menu__accelerator"),s=new Fe;s.addItem({iconHTML:"",checked:e.view.coverFrom===0,label:window.siyuan.languages.calcOperatorNone,click(){B(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:0}],[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:e.view.coverFrom}]),e.view.coverFrom=0,a.textContent=window.siyuan.languages.calcOperatorNone}}),s.addItem({iconHTML:"",checked:e.view.coverFrom===3,label:window.siyuan.languages.contentBlock,click(){B(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:3}],[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:e.view.coverFrom}]),e.view.coverFrom=3,a.textContent=window.siyuan.languages.contentBlock}}),s.addItem({iconHTML:"",checked:e.view.coverFrom===1,label:window.siyuan.languages.contentImage,click(){B(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:1}],[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:e.view.coverFrom}]),e.view.coverFrom=1,a.textContent=window.siyuan.languages.contentImage}});let i=!1;e.view.fields.forEach(l=>{l.type==="mAsset"&&(i||(s.addSeparator(),i=!0),s.addItem({iconHTML:l.icon?ge(l.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(l.type)}"></use></svg>`,checked:e.view.coverFrom===2&&e.view.coverFromAssetKeyID===l.id,label:l.name,click(){B(e.protyle,[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:2},{action:"setAttrViewCoverFromAssetKeyID",avID:t,blockID:n,keyID:l.id}],[{action:"setAttrViewCoverFrom",avID:t,blockID:n,data:e.view.coverFrom},{action:"setAttrViewCoverFromAssetKeyID",avID:t,blockID:n,keyID:e.view.coverFromAssetKeyID}]),e.view.coverFrom=2,e.view.coverFromAssetKeyID=l.id,a.textContent=l.name}}))});const o=e.target.getBoundingClientRect();s.open({x:o.left,y:o.bottom})},zf=e=>{const t=new Fe,n=e.nodeElement.getAttribute("data-av-id"),a=e.nodeElement.getAttribute("data-node-id"),s=e.nodeElement.getAttribute(p.CUSTOM_SY_AV_VIEW),i=e.target.querySelector(".b3-menu__accelerator");t.addItem({iconHTML:"",checked:e.view.cardSize===0,label:window.siyuan.languages.small,click(){B(e.protyle,[{action:"setAttrViewCardSize",avID:n,blockID:a,data:0,viewID:s}],[{action:"setAttrViewCardSize",avID:n,blockID:a,data:e.view.cardSize,viewID:s}]),e.view.cardSize=0,i.textContent=window.siyuan.languages.small}}),t.addItem({iconHTML:"",checked:e.view.cardSize===1,label:window.siyuan.languages.medium,click(){B(e.protyle,[{action:"setAttrViewCardSize",avID:n,blockID:a,data:1,viewID:s}],[{action:"setAttrViewCardSize",avID:n,blockID:a,data:e.view.cardSize,viewID:s}]),e.view.cardSize=1,i.textContent=window.siyuan.languages.medium}}),t.addItem({iconHTML:"",checked:e.view.cardSize===2,label:window.siyuan.languages.large,click(){B(e.protyle,[{action:"setAttrViewCardSize",avID:n,blockID:a,data:2,viewID:s}],[{action:"setAttrViewCardSize",avID:n,blockID:a,data:e.view.cardSize,viewID:s}]),e.view.cardSize=2,i.textContent=window.siyuan.languages.large}});const o=e.target.getBoundingClientRect();t.open({x:o.left,y:o.bottom})},Gl=e=>{switch(e){case 0:return"16:9";case 1:return"9:16";case 2:return"4:3";case 3:return"3:4";case 4:return"3:2";case 5:return"2:3";case 6:return"1:1"}return"16:9"},Kf=e=>{const t=new Fe,n=e.nodeElement.getAttribute("data-av-id"),a=e.nodeElement.getAttribute("data-node-id"),s=e.nodeElement.getAttribute(p.CUSTOM_SY_AV_VIEW),i=e.target.querySelector(".b3-menu__accelerator");[0,1,2,3,4,5,6].forEach(l=>{t.addItem({iconHTML:"",checked:e.view.cardAspectRatio===l,label:Gl(l),click(){B(e.protyle,[{action:"setAttrViewCardAspectRatio",avID:n,blockID:a,data:l,viewID:s}],[{action:"setAttrViewCardAspectRatio",avID:n,blockID:a,data:e.view.cardAspectRatio,viewID:s}]),e.view.cardAspectRatio=l,i.textContent=Gl(l)}})});const o=e.target.getBoundingClientRect();t.open({x:o.left,y:o.bottom})},od=e=>{const t=C(e.target,"av__gallery-item");t&&Ki(e.protyle,t,e.position)},Zf=e=>{const t=C(e,"av__gallery-item");if(t){const n=t.querySelector(".av__gallery-fields");n&&(e.setAttribute("aria-label",window.siyuan.languages[n.classList.contains("av__gallery-fields--edit")?"displayEmptyFields":"hideEmptyFields"]),n.classList.toggle("av__gallery-fields--edit"))}},Et=(e,t)=>{e.includes("cell")&&t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(n=>{var a;(a=n.querySelector(".av__drag-fill"))==null||a.remove(),n.classList.remove("av__cell--select","av__cell--active")}),e.includes("row")&&t.querySelectorAll(".av__row--select").forEach(n=>{n.classList.remove("av__row--select"),n.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),La(n)}),e.includes("galleryItem")&&t.querySelectorAll(".av__gallery-item--select").forEach(n=>{n.classList.remove("av__gallery-item--select")}),e.includes("av")&&t.querySelectorAll(" .av__cell--select, .av__cell--active, .av__row--select, .av__gallery-item--select").forEach(n=>{var a;n.classList.contains("av__row--select")?(n.classList.remove("av__row--select"),n.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),La(n)):((a=n.querySelector(".av__drag-fill"))==null||a.remove(),n.classList.remove("av__cell--select","av__cell--active","av__gallery-item--select"))}),e.includes("img")&&t.querySelectorAll(".img--select").forEach(n=>{n.classList.remove("img--select")})},zi=e=>e.startsWith("assets/")&&(e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg"))?e+"?style=thumb":e,zl=e=>e.startsWith("assets/")&&(e.endsWith(".png?style=thumb")||e.endsWith(".jpg?style=thumb")||e.endsWith(".jpeg?style=thumb"))?e.replace("?style=thumb",""):e;var Xf=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Jf=(e,t)=>{var n,a,s,i,o;if(Lt(t))return!1;const l=F(t.target);if(!l)return!1;const r=l.getAttribute("data-av-type");let d=t.target;for(;d&&!d.isEqualNode(l);){const c=d.getAttribute("data-type");if(c==="av-header-add"&&!e.disabled){const f=os(e,l),m=d.getBoundingClientRect();return f.open({x:m.left,y:m.bottom,h:m.height}),t.preventDefault(),t.stopPropagation(),!0}else{if(c==="av-header-more"&&!e.disabled)return Pt({protyle:e,blockElement:l,type:"properties"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-add-more"&&!e.disabled)return Ca({blockElement:l,protyle:e,count:1,previousID:"",groupID:((n=l.querySelector(".av__body"))==null?void 0:n.getAttribute("data-group-id"))||""}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-more"&&!e.disabled)return Pt({protyle:e,blockElement:l,type:"config"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-switcher"&&!e.disabled)return Pt({protyle:e,blockElement:l,type:"switcher"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-sort"&&!e.disabled)return Pt({protyle:e,blockElement:l,type:"sorts"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-filter"&&!e.disabled)return Pt({protyle:e,blockElement:l,type:"filters"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-add"&&!e.disabled)return td(e,l),t.preventDefault(),t.stopPropagation(),!0;if(c==="block-more"&&!e.disabled)return window.siyuan.menus.menu.remove(),e.toolbar.range=document.createRange(),e.toolbar.range.selectNodeContents(d),X(e.toolbar.range),r==="table"&&(d.parentElement.classList.add("av__cell--select"),wn(d.parentElement)),Ia(d.previousElementSibling.textContent.trim(),e,"av"),t.preventDefault(),t.stopPropagation(),!0;if(c==="set-page-size"&&!e.disabled)return zc({target:d,protyle:e,avID:l.getAttribute("data-av-id"),nodeElement:l}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-add-bottom"&&!e.disabled){const f=C(d,"av__body");return Ca({blockElement:l,protyle:e,count:1,previousID:f&&((s=(a=f.querySelector(".av__row--util"))==null?void 0:a.previousElementSibling)==null?void 0:s.getAttribute("data-id"))||((i=d.previousElementSibling)==null?void 0:i.getAttribute("data-id"))||void 0,groupID:f?f.getAttribute("data-group-id"):""}),t.preventDefault(),t.stopPropagation(),!0}else if(c==="av-add-top"&&!e.disabled){const f=C(d,"av__group-title");return Ca({blockElement:l,protyle:e,count:1,previousID:"",groupID:f?f.nextElementSibling.getAttribute("data-group-id"):""}),t.preventDefault(),t.stopPropagation(),!0}else{if(d.classList.contains("av__cell--header")&&!e.disabled)return Sc(e,l,d),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("av__cell")&&!e.disabled){if(!C(d,"av__row--header")){if(d.querySelector(".av__pulse"))return;const f=ln(d);if(r==="table"){const m=C(d,"av__scroll");if(!m)return;const u=C(d,"av__row");if(!u)return;f==="updated"||f==="created"||f==="lineNumber"?Vn(u.querySelector(".av__firstcol"),"toggle"):(m.querySelectorAll(".av__row--select").forEach(g=>{g.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),g.classList.remove("av__row--select")}),La(u),on(e,[d]))}else C(d,"av__gallery-item")&&f!=="updated"&&f!=="created"&&f!=="lineNumber"&&on(e,[d])}return t.preventDefault(),t.stopPropagation(),!0}else{if(d.classList.contains("av__calc")&&!e.disabled)return ad(e,d,void 0,t.clientX-64),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("b3-menu__avemoji")&&!e.disabled){const f=d.getBoundingClientRect();return ha(d.nextElementSibling.getAttribute("data-id"),"doc",{x:f.left,y:f.bottom,h:f.height,w:f.width},m=>{d.innerHTML=ge(m||window.siyuan.storage[p.LOCAL_IMAGES].file)},d.querySelector("img")),t.preventDefault(),t.stopPropagation(),!0}else{if(c==="av-gallery-edit"&&!e.disabled)return Zf(d),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-gallery-more"&&!e.disabled){const f=d.getBoundingClientRect();return od({target:d,protyle:e,position:{x:f.left,y:f.bottom}}),t.preventDefault(),t.stopPropagation(),!0}else if(c==="av-group-fold"){if(d.getAttribute("data-folding")!=="true"){d.setAttribute("data-folding","true");const f=d.firstElementChild.classList.contains("av__group-arrow--open");B(e,[{action:"foldAttrViewGroup",avID:l.dataset.avId,blockID:l.dataset.nodeId,id:d.dataset.id,data:f}],[{action:"foldAttrViewGroup",avID:l.dataset.avId,blockID:l.dataset.nodeId,id:d.dataset.id,data:!f}]),f?(d.firstElementChild.classList.remove("av__group-arrow--open"),d.parentElement.nextElementSibling.classList.add("fn__none")):(d.firstElementChild.classList.add("av__group-arrow--open"),d.parentElement.nextElementSibling.classList.remove("fn__none"))}return t.preventDefault(),t.stopPropagation(),!0}else if(c==="av-load-more"){l.querySelectorAll(".av__row--footer").forEach(m=>{m.style.transform=""}),l.removeAttribute("data-render");const f=C(d,"av__body");return f.dataset.pageSize=(parseInt(f.dataset.pageSize)+parseInt(f.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),ot(l,e),t.preventDefault(),t.stopPropagation(),!0}else{if(d.classList.contains("av__firstcol"))return window.siyuan.menus.menu.remove(),Vn(d,"toggle"),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("item")&&d.parentElement.classList.contains("layout-tab-bar"))return d.classList.contains("item--focus")?Vi({protyle:e,blockElement:l,element:d}):B(e,[{action:"setAttrViewBlockView",blockID:l.getAttribute("data-node-id"),id:d.dataset.id,avID:l.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:l.getAttribute("data-node-id"),id:d.parentElement.querySelector(".item--focus").getAttribute("data-id"),avID:l.getAttribute("data-av-id")}]),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("av__cellassetimg"))return Yl(zl(d.getAttribute("src")),l.getAttribute("data-av-id"),l.getAttribute(p.CUSTOM_SY_AV_VIEW),((o=l.querySelector('[data-type="av-search"]'))==null?void 0:o.value.trim())||""),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("av__row")&&t.shiftKey&&!d.classList.contains("av__row--header"))return Vn(d.querySelector(".av__firstcol"),"toggle"),t.preventDefault(),t.stopPropagation(),!0;if(c==="copy")return He(nl(C(d,"av__cell"))),se(window.siyuan.languages.copied),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-search-icon"){const f=l.querySelector('input[data-type="av-search"]');f.style.width="128px",f.style.paddingLeft="",f.style.paddingRight="";const m=C(f,"av__views");return m&&m.classList.add("av__views--show"),setTimeout(()=>{f.focus()},p.TIMEOUT_TRANSITION),t.preventDefault(),t.stopPropagation(),!0}}}}}}d=d.parentElement}return!1},Ki=(e,t,n)=>{var a;if(ae(["hint"],e),t.classList.contains("av__row--header"))return!1;const s=F(t);if(!s)return!1;const i=s.getAttribute("data-av-type");i==="table"?(t.classList.contains("av__row--select")||Et(["row"],s),Et(["cell"],s),t.classList.add("av__row--select"),t.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),La(t)):(t.classList.contains("av__gallery-item--select")||Et(["galleryItem"],s),t.classList.add("av__gallery-item--select"));const o=new Fe,l=s.querySelectorAll(".av__row--select:not(.av__row--header), .av__gallery-item--select"),r=l[0].querySelector('.av__cell[data-dtype="block"]'),d=Array.from(l).map(m=>m.querySelector('[data-dtype="block"] .av__celltext').getAttribute("data-id"));l.length===1&&r.getAttribute("data-detached");let c=!1;l.forEach(m=>{m.querySelector('.av__cell[data-dtype="block"]').getAttribute("data-detached")!=="true"&&(c=!0)});const f=[{id:"copyKeyContent",iconHTML:"",label:window.siyuan.languages.copyKeyContent,click(){let m="";l.forEach((u,g)=>{l.length>1&&(m+="- "),m+=u.querySelector('.av__cell[data-dtype="block"] .av__celltext').textContent.trim(),d.length>1&&g!==d.length-1&&(m+=`
`)}),He(m)}}];if(c&&f.splice(1,0,{id:"copyBlockRef",iconHTML:"",label:window.siyuan.languages.copyBlockRef,click:()=>{let m="";for(let u=0;u<d.length;u++){const g=d[u];let y="";const b=l[u].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?y=b.querySelector(".av__celltext").textContent:y=`((${g} '${b.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}'))`,d.length>1&&(m+="- "),m+=y,d.length>1&&u!==d.length-1&&(m+=`
`)}He(m)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,click:()=>{let m="";d.forEach((u,g)=>{d.length>1&&(m+="- ");const y=l[g].querySelector(".av__cell[data-dtype='block']");y.getAttribute("data-detached")==="true"?m+=y.querySelector(".av__celltext").textContent:m+=`{{select * from blocks where id='${u}'}}`,d.length>1&&g!==d.length-1&&(m+=`
`)}),He(m)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,click:()=>{let m="";d.forEach((u,g)=>{d.length>1&&(m+="- ");const y=l[g].querySelector(".av__cell[data-dtype='block']");y.getAttribute("data-detached")==="true"?m+=y.querySelector(".av__celltext").textContent:m+=`siyuan://blocks/${u}`,d.length>1&&g!==d.length-1&&(m+=`
`)}),He(m)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,click:()=>{let m="";for(let u=0;u<d.length;u++){const g=d[u];let y="";const b=l[u].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?y=b.querySelector(".av__celltext").textContent:y=`[${b.querySelector(".av__celltext").textContent.replace(/[\n]+/g," ")}](siyuan://blocks/${g})`,d.length>1&&(m+="- "),m+=y,d.length>1&&u!==d.length-1&&(m+=`
`)}He(m)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,click:()=>Xf(void 0,null,function*(){let m="";for(let u=0;u<d.length;u++){const g=d[u];let y="";const b=l[u].querySelector(".av__cell[data-dtype='block']");b.getAttribute("data-detached")==="true"?y=b.querySelector(".av__celltext").textContent:y=(yield he("/api/filetree/getHPathByID",{id:g})).data,d.length>1&&(m+="- "),m+=y,d.length>1&&u!==d.length-1&&(m+=`
`)}He(m)})},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,click:()=>{let m="";d.forEach((u,g)=>{d.length>1&&(m+="- ");const y=l[g].querySelector(".av__cell[data-dtype='block']");y.getAttribute("data-detached")==="true"?m+=y.querySelector(".av__celltext").textContent:m+=u,d.length>1&&g!==d.length-1&&(m+=`
`)}),He(m)}}),o.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:f}),!e.disabled){o.addItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){ji(s.getAttribute("data-av-id"),l[0],u=>{const g=[],y=[];l.forEach(h=>{const S=h.getAttribute("data-id"),$=ia("block",h.querySelector('.av__cell[data-dtype="block"]'));g.push({itemID:Lute.NewNodeID(),content:$.block.content,id:$.block.id||"",isDetached:$.isDetached}),y.push(S)});const b=u.dataset.avId,w=u.dataset.viewId;B(e,[{action:"insertAttrViewBlock",ignoreDefaultFill:!w,viewID:w,avID:b,srcs:g,context:{ignoreTip:"true"},blockID:u.dataset.blockId,groupID:t.parentElement.getAttribute("data-group-id")},{action:"doUpdateUpdated",id:u.dataset.blockId,data:G().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:y,avID:b}])})}}),l.length===1&&(r.getAttribute("data-detached")!=="true"&&o.addSeparator({id:"separator_1"}),o.addItem({id:i==="table"?"insertRowBefore":"insertItemBefore",icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages[i==="table"?"insertRowBefore":"insertItemBefore"].replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>`)}
</div>`,bind(u){const g=u.querySelector("input");u.addEventListener("click",()=>{var y;document.activeElement!==g&&(Ca({blockElement:s,protyle:e,count:parseInt(g.value),previousID:(y=l[0].previousElementSibling)==null?void 0:y.getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())}),g.addEventListener("keydown",y=>{var b;!y.isComposing&&y.key==="Enter"&&(Ca({blockElement:s,protyle:e,count:parseInt(g.value),previousID:(b=l[0].previousElementSibling)==null?void 0:b.getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())})}}),o.addItem({id:i==="table"?"insertRowAfter":"insertItemAfter",icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages[i==="table"?"insertRowAfter":"insertItemAfter"].replace("${x}",`<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>`)}
</div>`,bind(u){const g=u.querySelector("input");u.addEventListener("click",()=>{document.activeElement!==g&&(Ca({blockElement:s,protyle:e,count:parseInt(g.value),previousID:l[0].getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())}),g.addEventListener("keydown",y=>{!y.isComposing&&y.key==="Enter"&&(Ca({blockElement:s,protyle:e,count:parseInt(g.value),previousID:l[0].getAttribute("data-id"),groupID:l[0].parentElement.getAttribute("data-group-id")}),o.close())})}}),o.addSeparator({id:"separator_2"}),r.getAttribute("data-detached")!=="true"&&o.addItem({id:"unbindBlock",label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){Zt(e,s,{content:r.querySelector(".av__celltext").textContent},[r])}})),o.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Kc(s,e)}});const m=[];i==="table"?t.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(u=>{const g=Array.from(s.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${u.dataset.colId}"]`)),y=u.getAttribute("data-dtype");if(!["updated","created"].includes(y)){const b=u.dataset.icon;m.push({iconHTML:b?ge(b,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(y)}"></use></svg>`,label:pe(u.querySelector(".av__celltext").textContent.trim()),click(){on(e,g)}})}}):t.querySelectorAll(".av__cell").forEach(u=>{const g=Array.from(s.querySelectorAll(`.av__gallery-item--select .av__cell[data-field-id="${u.dataset.fieldId}"]`)),y=u.getAttribute("data-dtype");if(!["updated","created"].includes(y)){const b=u.parentElement.querySelector(".av__gallery-tip, .av__gallery-name").firstElementChild.cloneNode(!0);b.classList.add("b3-menu__icon"),m.push({iconHTML:b.outerHTML,label:pe(u.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]),click(){t.querySelector(".av__gallery-fields").classList.add("av__gallery-fields--edit"),t.querySelector('[data-type="av-gallery-edit"]').setAttribute("aria-label",window.siyuan.languages.hideEmptyFields),on(e,g)}})}}),o.addItem({id:"fields",icon:"iconAttr",label:window.siyuan.languages.fields,type:"submenu",submenu:m})}return(a=e==null?void 0:e.app)!=null&&a.plugins&&tn({plugins:e.app.plugins,type:"open-menu-av",detail:{protyle:e,element:s,selectRowElements:l},separatorPosition:"top"}),o.open(n),!0},Kl=(e,t)=>{const n=t.getAttribute("data-av-id"),a=t.getAttribute("data-node-id"),s=t.querySelector(".av__title");s.textContent===""&&s.querySelectorAll("br").forEach(l=>{l.remove()});const i=s.textContent.trim();if(i===s.dataset.title.trim())return;if(i.length>p.SIZE_TITLE)return se(window.siyuan.languages._kernel[106]),!1;const o=G().format("YYYYMMDDHHmmss");B(e,[{action:"setAttrViewName",id:n,data:i},{action:"doUpdateUpdated",id:a,data:o}],[{action:"setAttrViewName",id:n,data:s.dataset.title},{action:"doUpdateUpdated",id:a,data:t.getAttribute("updated")}]),t.setAttribute("updated",o),s.dataset.title=i,Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${n}"]`)).forEach(l=>{if(t===l)return;const r=l.querySelector(".av__title");r&&(r.textContent=i,r.dataset.title=i)})},Gt=(e,t,n)=>{var a;if(e)if(n)$p(e,n);else{const s=e.querySelector(".av__drag-fill"),i=F(e);if(!i)return;const o=i.getAttribute("data-av-type"),l=e.querySelector(".b3-menu__avemoji");["gallery","kanban"].includes(o)?(t.type==="checkbox"&&(t.checkbox={checked:((a=t.checkbox)==null?void 0:a.checked)||!1,content:e.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]}),e.innerHTML=Fn(t,0,l?!l.classList.contains("fn__none"):!1,o),e.parentElement.setAttribute("data-empty",xo(t).toString())):e.innerHTML=Fn(t,0,l?!l.classList.contains("fn__none"):!1),s&&wn(e),al(e,t)}},rd=(e,t)=>{e.querySelectorAll(`.av__cell[data-col-id="${t}"]`).forEach(n=>{n.remove()})},Qf=(e,t)=>{L("/api/av/duplicateAttributeViewBlock",{avID:t.getAttribute("data-av-id")},n=>{t.classList.remove("protyle-wysiwyg--select");const a=document.createElement("template");a.innerHTML=e.lute.SpinBlockDOM(`<div data-node-id="${n.data.blockID}" data-av-id="${n.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const s=a.content.firstElementChild;t.after(s),ot(s,e,()=>{te(s),Oe(e)}),B(e,[{action:"insert",data:s.outerHTML,id:n.data.blockID,previousID:t.dataset.nodeId}],[{action:"delete",id:n.data.blockID}])})},Zl=(e,t,n)=>{if(e.getAttribute("custom-pinthead")==="true"){const a=e.querySelector("table");a.clientHeight+a.scrollTop<t.offsetTop+t.clientHeight?a.scrollTop=t.offsetTop-a.clientHeight+t.clientHeight+1:a.scrollTop>t.offsetTop-t.clientHeight&&(a.scrollTop=t.offsetTop-t.clientHeight+1)}else Oe(n,t)},Qn=e=>{let t=e.previousElementSibling,n=0;for(;t;)n++,t=t.previousElementSibling;return n},dd=(e,t,n=!0)=>{let a=e.previousElementSibling;return a||(e.parentElement.previousElementSibling?a=e.parentElement.previousElementSibling.lastElementChild:e.parentElement.parentElement.tagName==="TBODY"&&e.parentElement.parentElement.previousElementSibling?a=e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(t.selectNodeContents(a),n||t.collapse(!1),X(t)),a},qn=(e,t,n,a,s)=>{s.insertNode(document.createElement("wbr"));const i=n.outerHTML,o=n.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,d=[];for(let c=0;c<r;c++){for(let f=0;f<l;f++)o.rows[c].cells[f]===t[d.length]&&d.push(f);if(d.length>0)break}for(let c=0;c<r;c++)d.forEach(f=>{o.rows[c].cells[f].setAttribute("align",a)});Q(e,n.getAttribute("data-node-id"),n.outerHTML,i),fe(o,s)},Xl=(e,t,n,a)=>{const s=document.createElement("wbr");t.insertNode(s);const i=a.outerHTML;s.remove();let o="";for(let r=0;r<n.parentElement.childElementCount;r++)o+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=n.parentElement.nextElementSibling;t.selectNodeContents(l.cells[Qn(n)]),t.collapse(!0),X(t),Q(e,a.getAttribute("data-node-id"),a.outerHTML,i),Zl(a,l,e)},cd=(e,t,n,a)=>{const s=document.createElement("wbr");t.insertNode(s);const i=a.outerHTML;s.remove();let o="",l=!1;for(let d=0;d<n.parentElement.childElementCount;d++){const c=n.parentElement.children[d];c.className==="fn__none"&&(l=!0),n.tagName==="TH"?o+=`<th class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></th>`:o+=`<td class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></td>`}if(l){let d=n.parentElement.previousElementSibling,c=1;for(;d;)c++,Array.from(d.children).forEach(f=>{f.rowSpan>=c&&f.rowSpan>1&&(f.rowSpan=f.rowSpan+1)}),d=d.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML.replace(/<th/g,"<td").replace(/<\/th>/g,"</td>")),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=n.parentElement.previousElementSibling),t.selectNodeContents(r.cells[Qn(n)]),t.collapse(!0),X(t),Q(e,a.getAttribute("data-node-id"),a.outerHTML,i),Zl(a,r,e)},Os=(e,t,n,a,s)=>{const i=document.createElement("wbr");s.insertNode(i);const o=t.outerHTML;i.remove();const l=Qn(n),r=t.querySelector("table");for(let d=0;d<r.rows.length;d++){const c=r.rows[d].cells[l],f=document.createElement(c.tagName);c.insertAdjacentElement(a,f),c===n?(f.innerHTML="<wbr> ",f.offsetLeft+f.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=f.offsetLeft+f.clientWidth-t.firstElementChild.clientWidth)):f.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(a,"<col style='min-width: 60px;'>"),fe(t,s),Q(e,t.getAttribute("data-node-id"),t.outerHTML,o)},ud=(e,t,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const s=document.createElement("wbr");t.insertNode(s);const i=a.outerHTML;s.remove();const o=Qn(n),l=n.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),l.childElementCount===1?l.remove():n.parentElement.remove(),t.selectNodeContents(r.cells[o]),t.collapse(!0),X(t),Zl(a,r,e),Q(e,a.getAttribute("data-node-id"),a.outerHTML,i)}},fd=(e,t,n,a)=>{var s;const i=document.createElement("wbr");t.insertNode(i);const o=n.outerHTML;i.remove();const l=Qn(a),r=a.previousElementSibling||a.nextElementSibling;if(r)t.selectNodeContents(r),t.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth);else{n.classList.add("protyle-wysiwyg--select"),bn(e,n,t,"remove");return}const d=n.querySelector("table");for(let c=0;c<d.rows.length;c++){const f=d.rows[c].cells;if(f.length===1){d.remove();break}f[l].remove()}(s=n.querySelectorAll("col")[l])==null||s.remove(),Q(e,n.getAttribute("data-node-id"),n.outerHTML,o),X(t)},gd=(e,t,n,a)=>{const s=n.parentElement;if(s.parentElement.tagName==="THEAD")return;t.insertNode(document.createElement("wbr"));const i=a.outerHTML;if(s.previousElementSibling)s.after(s.previousElementSibling);else{const o=s.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.after(o),s.parentElement.previousElementSibling.append(s)}Q(e,a.getAttribute("data-node-id"),a.outerHTML,i),fe(a,t),Oe(e,s)},pd=(e,t,n,a)=>{const s=n.parentElement;if(s.parentElement.tagName==="TBODY"&&!s.nextElementSibling||s.parentElement.tagName==="THEAD"&&!s.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const i=a.outerHTML;if(s.nextElementSibling)s.before(s.nextElementSibling);else{const o=s.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),s.after(o),s.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",s)}Q(e,a.getAttribute("data-node-id"),a.outerHTML,i),fe(a,t),Oe(e,s)},md=(e,t,n,a)=>{if(!n.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const s=a.outerHTML;let i=0;Array.from(n.parentElement.children).find((l,r)=>{if(n===l)return i=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[i].after(l.cells[i-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const o=a.querySelectorAll("col");o[i].after(o[i-1]),Q(e,a.getAttribute("data-node-id"),a.outerHTML,s),fe(a,t)},bd=(e,t,n,a)=>{if(!n.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const s=a.outerHTML;let i=0;Array.from(n.parentElement.children).find((l,r)=>{if(n===l)return i=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[i].before(l.cells[i+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const o=a.querySelectorAll("col");o[i].before(o[i+1]),Q(e,a.getAttribute("data-node-id"),a.outerHTML,s),fe(a,t)},eg=(e,t,n)=>{var a,s;const i=U(n.startContainer,"TD")||U(n.startContainer,"TH"),o=F(n.startContainer);if(!i||!o)return!1;if(t.key==="Backspace"&&n.toString()===""){const k=st(n.startContainer);if(n.startOffset===1&&k.nodeType===1&&k.tagName==="BR"&&n.startContainer.textContent.length===1&&!qe(n.startContainer))return k.insertAdjacentHTML("beforebegin","<br>"),!1}if(t.key==="Enter"&&t.shiftKey&&Ze(t)&&!t.altKey){const k=document.createElement("wbr");n.insertNode(k);const _=o.outerHTML;if(k.remove(),i&&!i.innerHTML.endsWith("<br>")&&i.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),e.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const A=document.createElement("br");n.startContainer.after(A),n.setStartAfter(A)}else n.insertNode(document.createElement("br"));return n.collapse(!1),Oe(e),Q(e,o.getAttribute("data-node-id"),o.outerHTML,_),t.preventDefault(),!0}if(!o.classList.contains("protyle-wysiwyg--select")&&!C(o,"protyle-wysiwyg--select")){if(Ze(t)&&!t.shiftKey&&!t.altKey&&t.key==="Enter"){t.preventDefault();const k=i.parentElement;if(!k.nextElementSibling&&k.parentElement.tagName==="TBODY"||k.parentElement.tagName==="THEAD"&&!k.parentElement.nextElementSibling)return an(e,"afterend",o.getAttribute("data-node-id")),!0;let _=k.nextElementSibling;return _||(_=k.parentElement.nextElementSibling.firstChild),_&&(n.selectNodeContents(_.cells[Qn(i)]),n.collapse(!0),Oe(e)),!0}if(t.key==="ArrowRight"&&n.toString()===""&&!o.nextElementSibling&&i===o.querySelector("table").lastElementChild.lastElementChild.lastElementChild&&et(i,e.wysiwyg.element,n).start===i.textContent.length)return t.preventDefault(),an(e,"afterend",o.getAttribute("data-node-id")),!0;if(t.key==="Tab"&&Ze(t)){if(t.shiftKey)return dd(i,n),t.preventDefault(),!0;let k=i.nextElementSibling;return k||(i.parentElement.nextElementSibling?k=i.parentElement.nextElementSibling.firstElementChild:i.parentElement.parentElement.tagName==="THEAD"&&i.parentElement.parentElement.nextElementSibling?k=i.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:k=null),k?n.selectNodeContents(k):Xl(e,n,i.parentElement.firstElementChild,o),t.preventDefault(),!0}if(t.key==="ArrowUp"&&Ze(t)&&!t.shiftKey&&!t.altKey){const k=n.startContainer;let _;for(k.nodeType!==3&&(k.tagName==="TH"||k.tagName==="TD")?_=k.childNodes[Math.min(n.startOffset,k.childNodes.length-1)]:k.parentElement.tagName==="SPAN"?_=k.parentElement.previousElementSibling:_=k.previousElementSibling;_;){if(_.tagName==="BR"&&st(_))return!1;_=_.previousElementSibling}const E=i.parentElement;let A=E.previousElementSibling;return A||(A=E.parentElement.previousElementSibling.lastElementChild),!A||(A==null?void 0:A.tagName)==="COL"?!1:(n.selectNodeContents(A.cells[Qn(i)]),n.collapse(!1),Oe(e),t.preventDefault(),!0)}if(t.key==="ArrowDown"&&Ze(t)&&!t.shiftKey&&!t.altKey){const k=n.endContainer;let _;for(k.nodeType!==3&&(k.tagName==="TH"||k.tagName==="TD")?_=(a=k.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:a.nextElementSibling:k.parentElement.tagName==="SPAN"?_=k.parentElement.nextElementSibling:_=k.nextElementSibling;_;){if(_.tagName==="BR"&&_.nextSibling)return!1;_=_.nextElementSibling}const E=i.parentElement;if(!E.nextElementSibling&&E.parentElement.tagName==="TBODY"||E.parentElement.tagName==="THEAD"&&!E.parentElement.nextElementSibling)return!1;let A=E.nextElementSibling;return A||(A=E.parentElement.nextElementSibling.firstChild),A?(n.selectNodeContents(A.cells[Qn(i)]),n.collapse(!0),Oe(e),t.preventDefault(),!0):!1}if(Ze(t)&&!t.shiftKey&&!t.altKey&&t.key==="Backspace"&&et(i,e.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&i.querySelectorAll("br").length===1))return!dd(i,n,!1)&&o.previousElementSibling&&te(o.previousElementSibling,void 0,!1),Oe(e),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.general.alignLeft.custom,t))return qn(e,[i],o,"left",n),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.general.alignCenter.custom,t))return qn(e,[i],o,"center",n),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.general.alignRight.custom,t))return qn(e,[i],o,"right",n),t.preventDefault(),!0}const l=o.querySelector("table"),r=i.parentElement.querySelector(".fn__none");let d=!1,c=!1;Array.from(i.parentElement.children).forEach(k=>{k.colSpan>1&&(d=!0),k.rowSpan>1&&(c=!0)});let f=!1,m=!1,u=!1,g=i.parentElement.previousElementSibling;!g&&i.parentElement.parentElement.tagName==="TBODY"&&(g=l.querySelector("thead").lastElementChild),g&&(f=g.querySelector(".fn__none"),Array.from(g.children).forEach(k=>{k.colSpan>1&&(m=!0),k.rowSpan>1&&(u=!0)}));let y=!1,b=!1,w=!1,h=i.parentElement.nextElementSibling;!h&&i.parentElement.parentElement.tagName==="THEAD"&&(h=(s=l.querySelector("tbody"))==null?void 0:s.firstElementChild),h&&(y=h.querySelector(".fn__none"),Array.from(h.children).forEach(k=>{k.colSpan>1&&(b=!0),k.rowSpan>1&&(w=!0)}));const S=Qn(i);let $=!0;Array.from(l.rows).find(k=>{const _=k.cells[S];if(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1)return $=!1,!0});let D=!0;Array.from(l.rows).find(k=>{const _=k.cells[S+1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return D=!1,!0});let v=!0;if(Array.from(l.rows).find(k=>{const _=k.cells[S-1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return v=!1,!0}),ne(window.siyuan.config.keymap.editor.table.moveToUp.custom,t))return(!r||r&&!c&&d)&&(!f||f&&!u&&m)&&gd(e,n,i,o),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table.moveToDown.custom,t))return(!r||r&&!c&&d)&&(!y||y&&!w&&b)&&pd(e,n,i,o),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table.moveToLeft.custom,t))return $&&v&&md(e,n,i,o),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table.moveToRight.custom,t))return $&&D&&bd(e,n,i,o),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,t))return cd(e,n,i,o),t.preventDefault(),t.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,t))return(!y||y&&!w&&b)&&Xl(e,n,i,o),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,t))return($||v)&&Os(e,o,i,"beforebegin",n),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,t))return($||D)&&Os(e,o,i,"afterend",n),t.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.table["delete-row"].custom,t))return(!r&&!c||r&&!c&&d)&&ud(e,n,i,o),t.preventDefault(),t.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.table["delete-column"].custom,t))return $&&fd(e,n,o,i),t.preventDefault(),!0},ea=e=>e.item.offsetLeft+6>e.tableSelectElement.offsetLeft+e.scrollLeft&&e.item.offsetLeft+e.item.clientWidth-6<e.tableSelectElement.offsetLeft+e.scrollLeft+e.tableSelectElement.clientWidth&&e.item.offsetTop+6>e.tableSelectElement.offsetTop+e.scrollTop&&e.item.offsetTop+e.item.clientHeight-6<e.tableSelectElement.offsetTop+e.scrollTop+e.tableSelectElement.clientHeight,yd=(e,t)=>{var n;if(!t)return;const a=t.querySelector(".table__select"),s=[],i=t.firstElementChild.scrollLeft,o=t.querySelector("table").scrollTop;if(t.querySelectorAll("th, td").forEach(r=>{!r.classList.contains("fn__none")&&ea({tableSelectElement:a,scrollLeft:i,scrollTop:o,item:r})&&s.push(r)}),a.removeAttribute("style"),getSelection().rangeCount>0){const r=getSelection().getRangeAt(0);t.contains(r.startContainer)&&r.insertNode(document.createElement("wbr"))}const l=t.outerHTML;(n=t.querySelector("wbr"))==null||n.remove(),t.setAttribute("updated",G().format("YYYYMMDDHHmmss")),s.forEach(r=>{r.innerHTML=""}),Q(e,t.getAttribute("data-node-id"),t.outerHTML,l)};var Jl=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const tg=()=>Jl(void 0,null,function*(){const e=yield he("/api/petal/loadPetals",{frontend:be()});let t="";return e.data.forEach(n=>{t+=n.css||""}),t}),ng=e=>(["ant","material"].includes(window.siyuan.config.appearance.icon)?"":`<script src="${e}appearance/icons/material/icon.js?v=${p.SIYUAN_VERSION}"><\/script>`)+`<script src="${e}appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?v=${p.SIYUAN_VERSION}"><\/script>`,wd=e=>{if(["html","htmlmd"].includes(e.type)){const t=se(window.siyuan.languages.exporting,-1),n=e.type==="htmlmd"?"/api/export/exportMdHTML":"/api/export/exportHTML";L(n,{id:e.id,pdf:!1,removeAssets:!1,merge:!0,savePath:""},a=>Jl(void 0,null,function*(){const s=yield _d(a,void 0,"",e);L("/api/export/exportBrowserHTML",{folder:a.data.folder,html:s,name:a.data.name},i=>{if(tt(t),i.code===-1){se(window.siyuan.languages._kernel[14]+": "+i.msg,0,"error");return}window.open(i.data.zip),se(window.siyuan.languages.exported)})}));return}},ag=()=>{let e="";return document.querySelectorAll("style").forEach(t=>{t.id.startsWith("snippet")&&(e+=t.outerHTML)}),e},_d=(e,t,n,a,s)=>Jl(void 0,null,function*(){let i=window.siyuan.config.appearance.themeLight,o=0;["html","htmlmd"].includes(a.type)&&window.siyuan.config.appearance.mode===1&&(i=window.siyuan.config.appearance.themeDark,o=1);const l=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let r="";l||(r=`<link rel="stylesheet" type="text/css" id="themeStyle" href="${n}appearance/themes/${i}/theme.css?${p.SIYUAN_VERSION}"/>`);const d=Ar(),c=Je()||ut()?{js:`document.body.style.minWidth = "${d}px";`,css:`@page { size: A4; margin: 10mm 0 10mm 0; }
.protyle-wysiwyg {padding: 0; margin: 0;}`}:{js:"",css:""},f=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="${Rr()}" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <base href="${n}">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="${n}stage/build/export/base.css?v=${p.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="${n}appearance/themes/${i}/theme.css?v=${p.SIYUAN_VERSION}"/>
    <script src="${n}stage/protyle/js/protyle-html.js?v=${p.SIYUAN_VERSION}"><\/script>
    ${r}
    <title>${e.data.name}</title>
    <!-- Exported by SiYuan v${p.SIYUAN_VERSION} -->
    <style>
        body {font-family: var(--b3-font-family);background-color: var(--b3-theme-background);color: var(--b3-theme-on-background)}
        ${yield Wi(!1,n)}
        ${yield tg()}
        ${c.css}
    </style>
    ${ag()}
</head>
<body>
<div class="${["htmlmd","word"].includes(a.type)?"b3-typography":"protyle-wysiwyg"+(window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":"")}" 
style="max-width: 800px;margin: 0 auto;" id="preview">${e.data.content}</div>
${ng(n)}
<script src="${n}stage/build/export/protyle-method.js?v=${p.SIYUAN_VERSION}"><\/script>
<script src="${n}stage/protyle/js/lute/lute.min.js?v=${p.SIYUAN_VERSION}"><\/script>  
<script>
    ${c.js}
    window.siyuan = {
      config: {
        appearance: { mode: ${o}, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
        editor: { 
          codeLineWrap: true,
          fontSize: ${window.siyuan.config.editor.fontSize},
          codeLigatures: ${window.siyuan.config.editor.codeLigatures},
          plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
          codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
          katexMacros: decodeURI(\`${encodeURI(window.siyuan.config.editor.katexMacros)}\`),
        }
      },
      languages: {copy:"${window.siyuan.languages.copy}"}
    };
    const previewElement = document.getElementById('preview');
    Protyle.highlightRender(previewElement, "stage/protyle");
    Protyle.mathRender(previewElement, "stage/protyle", ${a.type==="pdf"});
    Protyle.mermaidRender(previewElement, "stage/protyle");
    Protyle.flowchartRender(previewElement, "stage/protyle");
    Protyle.graphvizRender(previewElement, "stage/protyle");
    Protyle.chartRender(previewElement, "stage/protyle");
    Protyle.mindmapRender(previewElement, "stage/protyle");
    Protyle.abcRender(previewElement, "stage/protyle");
    Protyle.htmlRender(previewElement);
    Protyle.plantumlRender(previewElement, "stage/protyle");
    document.querySelectorAll(".protyle-action__copy").forEach((item) => {
      item.addEventListener("click", (event) => {
            let text = item.parentElement.nextElementSibling.textContent.trimEnd();
            text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying
            navigator.clipboard.writeText(text);
            event.preventDefault();
            event.stopPropagation();
      })
    });
<\/script></body></html>`;if(typeof t=="undefined")return f}),qs=(e,t="outerHTML")=>{if(!e.querySelector("[data-type='block-render']"))return e[t];const n=e.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),n[t]},ig=e=>{const t=document.createElement("template");return t.innerHTML=e,t.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{C(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),t.innerHTML},Rs=(e,t,n)=>{if(P())return;const a=t.getBoundingClientRect();if(a.height===0||!e){xn();return}const s=document.getElementById("tooltip");s.className=n?`tooltip tooltip--${n}`:"tooltip",s.innerHTML=e,s.removeAttribute("style");const i=t.getAttribute("data-position"),o=t.parentElement.getBoundingClientRect();let l,r;if(i==="parentE")r=Math.max(0,o.top-(s.clientHeight-o.height)/2),r>window.innerHeight-s.clientHeight&&(r=window.innerHeight-s.clientHeight),l=o.right+8,l+s.clientWidth>window.innerWidth&&(l=o.left-s.clientWidth-8);else if(i==="parentW")r=Math.max(0,o.top-(s.clientHeight-o.height)/2),r>window.innerHeight-s.clientHeight&&(r=window.innerHeight-s.clientHeight),l=o.left-s.clientWidth,l<0&&(l=o.right);else if(i!=null&&i.endsWith("west")){const d=parseInt(i)||.5;r=Math.max(0,a.top-(s.clientHeight-a.height)/2),r>window.innerHeight-s.clientHeight&&(r=window.innerHeight-s.clientHeight),l=a.left-s.clientWidth-d,l<0&&(l=a.right)}else if(i==="north")l=Math.max(0,a.left-(s.clientWidth-a.width)/2),r=a.top-s.clientHeight-.5,r<0&&(a.top<window.innerHeight-a.bottom?(r=a.bottom+.5,s.style.maxHeight=window.innerHeight-r+"px"):(r=0,s.style.maxHeight=a.top-.5+"px")),l+s.clientWidth>window.innerWidth&&(l=window.innerWidth-s.clientWidth);else{const d=parseInt(i)||.5;l=Math.max(0,a.left-(s.clientWidth-a.width)/2),r=a.bottom+d,r+s.clientHeight>window.innerHeight&&(a.top-d>window.innerHeight-r?(r=a.top-d-s.clientHeight,s.style.maxHeight=a.top-d+"px"):s.style.maxHeight=window.innerHeight-r+"px"),l+s.clientWidth>window.innerWidth&&(l=window.innerWidth-s.clientWidth)}s.style.top=r+"px",s.style.left=l+"px"},xn=()=>{document.getElementById("tooltip").classList.add("fn__none")},Zi=(e,t)=>/\r\n|\r|\n|\u2028|\u2029|\t/.test(e)?(t?Rs(window.siyuan.languages.fileNameRule,t,"error"):se(window.siyuan.languages.fileNameRule),!1):e.length>p.SIZE_TITLE?(t?Rs(window.siyuan.languages._kernel[106],t,"error"):se(window.siyuan.languages._kernel[106]),!1):!0,gn=e=>(e.indexOf("/")>-1&&(se(window.siyuan.languages.fileNameRule),e=e.replace(/\//g,"\uFF0F")),e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|/g,"").substring(0,p.SIZE_TITLE)),ny=e=>e.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),hd=e=>{if(window.siyuan.config.readonly)return;const t=new ke({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px",destroyCallback(){e.range&&X(e.range)}});t.element.setAttribute("data-key",p.DIALOG_RENAME);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(e.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{if(!Zi(n.value))return!1;if(n.value===e.name)return t.destroy(),!1;n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=gn(n.value),e.type==="notebook"?L("/api/notebook/renameNotebook",{notebook:e.notebookId,name:n.value},()=>{Af(e.notebookId,n.value)}):L("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n.value}),t.destroy()})},Bs=e=>{const t=new ke({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});t.element.setAttribute("data-key",p.DIALOG_RENAMEASSETS);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()});const s=ql(e);n.value=s,n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{if(n.value===s||!n.value)return t.destroy(),!1;L("/api/asset/renameAsset",{oldPath:e,newName:n.value},i=>{wa().forEach(o=>{o.reload(!1)}),t.destroy()})})},sg=e=>{if(getSelection().rangeCount===0)return;const t=getSelection().getRangeAt(0),n=F(t.startContainer);if(!n)return;let a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let s="",i=t.toString();if(i===""){if(i=a[0].textContent,a.forEach(o=>{s+=qs(o)}),!i)return}else{const o=document.createElement("div");o.appendChild(t.cloneContents()),s=o.innerHTML}i.length>10&&(i=i.substr(0,10)+"..."),i=gn(i),L("/api/filetree/createDoc",{notebook:e.notebookId,path:_e().join(vt(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:i,md:e.lute.BlockDOM2StdMd(s)})};var vd=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const ay=(e,t)=>{},lg=e=>{const t=new ke({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${P()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${P()?"margin: 8px 0":"padding: 48px;margin: 8px 0"}" class="export-img">
        <div ${P()?'style="padding:8px"':""} class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:P()?"92vw":"990px",height:"70vh"});t.element.setAttribute("data-key",p.DIALOG_EXPORTIMAGE);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>vd(void 0,null,function*(){const r=se(window.siyuan.languages.exporting,0),d=t.element.querySelector(".b3-dialog__container");d.style.height="",d.style.width="100vw";const c=t.element.querySelector(".b3-dialog__content");c.style.overflow="hidden",Te(p.LOCAL_EXPORTIMG,window.siyuan.storage[p.LOCAL_EXPORTIMG]);const f=a.querySelectorAll("[data-subtype='plantuml']");for(let m=0;m<f.length;m++){const u=f[m].querySelector("object");if(u){const y=yield(yield fetch(u.getAttribute("data"))).text();u.insertAdjacentHTML("beforebegin",y),u.remove()}}a.querySelectorAll(".protyle-linenumber__rows span").forEach((m,u)=>{m.textContent=(u+1).toString()}),setTimeout(()=>{Ke("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>vd(void 0,null,function*(){let m=yield window.htmlToImage.toBlob(t.element.querySelector(".b3-dialog__content"));(_a()||kr())&&(yield window.htmlToImage.toBlob(c),yield window.htmlToImage.toBlob(c),yield window.htmlToImage.toBlob(c),m=yield window.htmlToImage.toBlob(c));const u=new FormData;u.append("file",m,n[1].getAttribute("data-title")),u.append("type","image/png"),L("/api/export/exportAsFile",u,g=>{Nt(g.data.file)}),tt(r),t.destroy()}))},p.TIMEOUT_LOAD)}));const a=t.element.querySelector(".protyle-wysiwyg"),s=t.element.querySelector("#keepFold");s.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[p.LOCAL_EXPORTIMG].keepFold=s.checked,L("/api/export/exportPreviewHTML",{id:e,keepFold:s.checked,image:!0},r=>{l(r)})});const i=t.element.querySelector("#watermark");i.addEventListener("change",()=>{window.siyuan.storage[p.LOCAL_EXPORTIMG].watermark=i.checked,o()});const o=()=>{const r=t.element.querySelector(".export-img__watermark");r.innerHTML="",i.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):Ke("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>{const d=Math.max(t.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${d}px;height: ${d}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.htmlToImage.toCanvas(r).then(c=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${c.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},l=r=>{a.innerHTML=r.data.content,a.setAttribute("data-doc-type",r.data.type||"NodeDocument"),Object.keys(r.data.attrs).forEach(d=>{a.setAttribute(d,r.data.attrs[d])}),a.querySelectorAll(".code-block").forEach(d=>{d.setAttribute("linewrap","true")}),Xe(a),Re(a),a.querySelectorAll("table").forEach(d=>{d.clientWidth>d.parentElement.clientWidth&&(d.setAttribute("style",`margin-bottom:${d.parentElement.clientWidth*d.clientHeight/d.clientWidth-d.parentElement.clientHeight+1}px;transform: scale(${d.parentElement.clientWidth/d.clientWidth});transform-origin: top left;`),d.parentElement.style.overflow="hidden")}),o(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),t.element.querySelector(".fn__loading").remove()};L("/api/export/exportPreviewHTML",{id:e,keepFold:s.checked,image:!0},r=>{l(r),n[1].setAttribute("data-title",r.data.name+".png")})};var og=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const li=(e,t,n)=>{if(!e){t.innerHTML="";return}L("/api/template/render",{id:n,path:e,preview:!0},a=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},Ed=(e,t,n=!0)=>{if(!e.getAttribute("data-type")||!t.getAttribute("data-type"))return!1;e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim()),t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim());const a=e.attributes;let s=!0;for(let i=0;i<a.length;i++)t.getAttribute(a[i].name)!==a[i].value&&(s=!1);return s&&(n?e.innerHTML=e.innerHTML+t.innerHTML:e.innerHTML=t.innerHTML+e.innerHTML,t.remove()),s},kd=e=>{let t=e.previousSibling;for(;t&&t.nodeType!==3&&Ed(e,t,!1);)t=e.previousSibling;let n=e.nextSibling;for(;n&&n.nodeType!==3&&Ed(e,n);)n=e.nextSibling;(e.getAttribute("data-type")||"").includes("search-mark")&&e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim())},Ql=(e,t,n)=>{const a=e.getAttribute("data-type").split(" ");if(a.length===1){const s=e.parentElement;e.outerHTML=e.innerHTML.replace(p.ZWSP,"")+"<wbr>",n&&fe(s,n)}else a.find((s,i)=>{if(t===s)return a.splice(i,1),!0}),e.setAttribute("data-type",a.join(" ")),t==="a"?e.removeAttribute("data-href"):t==="file-annotation-ref"?e.removeAttribute("data-id"):t==="block-ref"&&(e.removeAttribute("data-id"),e.removeAttribute("data-subtype")),n&&(n.selectNodeContents(e),n.collapse(!1),X(n))},Us=e=>{const t=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],n=[];return e.forEach(a=>{let s=a;t.find(i=>{if(typeof a=="string"&&i.name===a)return s=i,!0;if(typeof a=="object"&&i.name===a.name)return s=Object.assign({},i,a),!0}),n.push(s)}),n},pn=(e,t)=>og(void 0,null,function*(){let n="";for(let a=0;a<e.length;a++){const s=e[a];if(e.length>1&&(n+="- "),t==="ref"){const i=yield he("/api/block/getRefText",{id:s});n+=`((${s} '${i.data}'))`}else if(t==="blockEmbed")n+=`{{select * from blocks where id='${s}'}}`;else if(t==="protocol")n+=`siyuan://blocks/${s}`;else if(t==="protocolMd"){const i=yield he("/api/block/getRefText",{id:s});n+=`[${i.data}](siyuan://blocks/${s})`}else if(t==="hPath"){const i=yield he("/api/filetree/getHPathByID",{id:s});n+=i.data}else t==="id"&&(n+=s);e.length>1&&a!==e.length-1&&(n+=`
`)}He(n)});var eo=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Sd=(e,t)=>{e.addEventListener("change",()=>{L("/api/attr/setBlockAttrs",{id:t,attrs:{[e.dataset.name]:e.value}})})},rg=e=>{const t=e.getAttribute("data-node-id"),n=ye(e),a=e.getAttribute(p.CUSTOM_REMINDER_WECHAT);let s="";a&&(s=G(a).format("YYYY-MM-DD HH:mm"));const i=new ke({width:P()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${s}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){X(n)}});i.element.setAttribute("data-key",p.DIALOG_WECHATREMINDER);const o=i.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),L("/api/block/setBlockReminder",{id:t,timed:"0"},()=>{e.removeAttribute(p.CUSTOM_REMINDER_WECHAT),i.destroy()}))}),o[2].addEventListener("click",()=>{const l=i.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){se(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=G(l).format("YYYYMMDDHHmmss");L("/api/block/setBlockReminder",{id:t,timed:r},()=>{e.setAttribute(p.CUSTOM_REMINDER_WECHAT,r),i.destroy()})}else se(window.siyuan.languages.notEmpty)})},dg=e=>{L("/api/block/getDocInfo",{id:e.block.rootID},t=>{const n=t.data.ial[p.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=G(n).format("YYYY-MM-DD HH:mm"));const s=new ke({width:P()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});s.element.setAttribute("data-key",p.DIALOG_WECHATREMINDER);const i=s.element.querySelectorAll(".b3-button");i[0].addEventListener("click",()=>{s.destroy()}),i[1].addEventListener("click",()=>{L("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},()=>{s.destroy()})}),i[2].addEventListener("click",()=>{const o=s.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){se(window.siyuan.languages.reminderTip);return}L("/api/block/setBlockReminder",{id:e.block.rootID,timed:G(o).format("YYYYMMDDHHmmss")},()=>{s.destroy()})}else se(window.siyuan.languages.notEmpty)})})},vn=(e,t="bookmark",n)=>{let a="",s="",i=!1;const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;let l;n||(wa().find(d=>{if(e.id===d.protyle.block.rootID)return n=d.protyle,!0}),n||(l=new Gn(window.siyuan.ws.app,document.createElement("div"),{blockId:e.id}))),Object.keys(e).forEach(d=>{p.CUSTOM_RIFF_DECKS===d||d.startsWith("custom-sy-")||(d===p.CUSTOM_REMINDER_WECHAT?s=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${d}" value="${G(e[d]).format("YYYY-MM-DD HH:mm")}">
</label>`:d.indexOf("custom-av")>-1?i=!0:d.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${d.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${d}">${e[d]}</textarea>
</label>`))});const r=new ke({width:P()?"92vw":"50vw",containerClassName:"b3-dialog__container--theme",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${i?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${e.memo||""}</textarea>
            </label>
            ${s}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--cancel">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){X(o),n?ae(["select"],n):l.destroy()}});r.element.setAttribute("data-key",p.DIALOG_ATTR),r.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",r.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",r.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"",r.element.addEventListener("click",d=>{let c=d.target;for(typeof d.detail=="string"&&(c=r.element.querySelector(`.item--full[data-type="${d.detail}"]`));c!==r.element;){const f=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),r.element.querySelectorAll(".custom-attr").forEach(m=>{m.dataset.type===c.dataset.type?(m.dataset.type==="NodeAttributeView"&&m.innerHTML===""&&So(m,e.id,n||l.protyle),m.classList.remove("fn__none")):m.classList.add("fn__none")});else if(f==="remove"){L("/api/attr/setBlockAttrs",{id:e.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),d.stopPropagation(),d.preventDefault();break}else if(f==="bookmark"){L("/api/attr/getBookmarkLabels",{},m=>{window.siyuan.menus.menu.remove(),m.data.length===0?window.siyuan.menus.menu.append(new H({id:"emptyContent",iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):m.data.forEach(u=>{window.siyuan.menus.menu.append(new H({label:u,click(){const g=c.parentElement.parentElement.querySelector("input");g.value=u,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:d.clientX,y:d.clientY+16,w:16})}),d.stopPropagation(),d.preventDefault();break}else if(f==="addCustom"){const m=new ke({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});m.element.setAttribute("data-key",p.DIALOG_SETCUSTOMATTR);const u=m.element.querySelector("input"),g=m.element.querySelectorAll(".b3-button");m.bindInput(u,()=>{g[1].click()}),u.focus(),u.select(),g[0].addEventListener("click",()=>{m.destroy()}),g[1].addEventListener("click",()=>{if(!An(u.value))return se(window.siyuan.languages.attrName+" <b>"+pe(u.value)+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${u.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${u.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const y=c.parentElement.previousElementSibling.querySelector(".b3-text-field");y.focus(),Sd(y,e.id),m.destroy()}),d.stopPropagation(),d.preventDefault();break}c=c.parentElement}}),r.element.querySelectorAll(".b3-text-field").forEach(d=>{t!=="av"&&t!=="custom"&&t===d.getAttribute("data-name")&&d.focus(),Sd(d,e.id)}),t==="av"?r.element.dispatchEvent(new CustomEvent("click",{detail:"NodeAttributeView"})):t==="custom"&&r.element.dispatchEvent(new CustomEvent("click",{detail:"custom"}))},ta=(e,t="bookmark",n)=>{if(e.getAttribute("data-type")==="NodeThematicBreak")return;const a=e.getAttribute("data-node-id");L("/api/attr/getBlockAttrs",{id:a},s=>{vn(s.data,t,n)})},oi=(e,t=!0,n,a)=>{const s=[{id:"copyBlockRef",iconHTML:"",accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{pn(e,"ref"),n&&te(n)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{pn(e,"blockEmbed"),n&&te(n)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{pn(e,"protocol"),n&&te(n)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{pn(e,"protocolMd"),n&&te(n)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:t?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{pn(e,"hPath"),n&&te(n)}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:t?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{pn(e,"id"),n&&te(n)}}];return a&&s.push({id:"copyMarkdown",iconHTML:"",label:window.siyuan.languages.copyMarkdown,accelerator:void 0,click:()=>eo(void 0,null,function*(){const o=(yield he("/api/export/exportMdContent",{id:a,refMode:3,embedMode:1,yfm:!1,fillCSSVar:!1,adjustHeadingLevel:!1})).data.content;He(o),n&&te(n)})}),s},Ad=e=>{if(!window.siyuan.isPublish)return new H({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>eo(void 0,null,function*(){const t=yield he("/api/block/getRefText",{id:e}),n=new ke({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});n.element.setAttribute("data-key",p.DIALOG_EXPORTTEMPLATE);const a=n.element.querySelector("input"),s=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{s[1].click()});let i=gn(t.data);const o=32;i.length>o&&(i=i.substring(0,o)),a.value=i,a.focus(),a.select(),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=gn(a.value),i.length>o&&(i=i.substring(0,o)),L("/api/template/docSaveAsTemplate",{id:e,name:a.value,overwrite:!1},l=>{if(l.code===1){Ne(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{L("/api/template/docSaveAsTemplate",{id:e,name:a.value,overwrite:!0},r=>{r.code===0&&se(window.siyuan.languages.exportTplSucc)})});return}se(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=se(window.siyuan.languages.exporting,-1);L("/api/export/exportSY",{id:e},n=>{tt(t),Nt(n.data.zip)})}},{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const t=se(window.siyuan.languages.exporting,-1);L("/api/export/exportMd",{id:e},n=>{tt(t),Nt(n.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{lg(e)}},{id:"exportPDF",label:window.siyuan.languages.print,icon:"iconPDF",ignore:!Je()&&!ut(),click:()=>{const t=se(window.siyuan.languages.exporting),n=window.siyuan.storage[p.LOCAL_EXPORTPDF];L("/api/export/exportPreviewHTML",{id:e,keepFold:n.keepFold,merge:n.mergeSubdocs},a=>eo(void 0,null,function*(){const s=window.location.protocol+"//"+window.location.host+"/",i=yield _d(a,void 0,s,{type:"pdf",id:e});Je()?window.JSAndroid.print(i):ut()&&window.JSHarmony.print(i),setTimeout(()=>{tt(t)},3e3)}))}},{id:"exportHTML_SiYuan",label:"HTML (SiYuan)",iconClass:"ft__error",icon:"iconHTML5",click:()=>{wd({type:"html",id:e})}},{id:"exportHTML_Markdown",label:"HTML (Markdown)",icon:"iconHTML5",click:()=>{wd({type:"htmlmd",id:e})}}]}).element},Xi=(e,t,n,a)=>{const s=[];if(s.push({id:Je()?"useDefault":"useBrowserView",label:Je()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:a?window.siyuan.languages.click:"",click:()=>{Nt(t)}}),n)return s;window.siyuan.menus.menu.append(new H({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:s}).element)},Ld=e=>new H({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{hd(e)}}).element,to=e=>new H({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){ca((t,n)=>{Bl(e,n[0],t[0])},e)}}).element,xd=e=>{var t;const n=parseInt(e.getAttribute("data-subtype").substr(1));let a=e.nextElementSibling;for(;a;){const s=parseInt((t=a.getAttribute("data-subtype"))==null?void 0:t.substr(1));if(!a.classList.contains("protyle-attr")&&(isNaN(s)||s>n)){const i=a;a=a.nextElementSibling,i.remove()}else break}};class cg{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(t){if(t.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();if(this.render(t,n,!1),this.hasUndo=!0,this.redoStack.push(n),t.breadcrumb){const a=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&(this.undoStack.length===0&&a.setAttribute("disabled","true"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(t){if(t.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();if(this.render(t,n,!0),this.undoStack.push(n),t.breadcrumb){const a=t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&(t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&a.setAttribute("disabled","true"))}}render(t,n,a){var s;ae(["hint","gutter"],t),t.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(i=>{il(t,i,!0)}),B(t,n.doOperations)):(n.undoOperations.forEach(i=>{il(t,i,!0)}),B(t,n.undoOperations)),(s=document.querySelector(".av__panel"))==null||s.remove(),fn(t),Oe(t)}replace(t,n){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,n.breadcrumb)){const a=n.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&a.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=t)}add(t,n,a){if(this.undoStack.push({undoOperations:n,doOperations:t}),this.undoStack.length>p.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),a.breadcrumb){const s=a.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');s&&s.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const Rn=e=>!1,Cd=(e,t,n)=>{var a,s,i,o,l,r,d,c,f;let m,u="",g=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(g.length===0){let b=Ve(t);const w=O(b,"fold","1");w&&(b=w),(a=b.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(b=Ve(b.parentElement)),g=[b]}const y=g[0].getAttribute("data-type");if(y==="NodeListItem"&&!g[0].previousElementSibling&&((i=(s=g[0].parentElement.previousElementSibling)==null?void 0:s.previousElementSibling)!=null&&i.classList.contains("protyle-action")))if((o=g[0].parentElement.parentElement.previousElementSibling)!=null&&o.classList.contains("li")){if(m=g[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),u=g[0].parentElement.parentElement.parentElement.outerHTML,!m){const b=Lute.NewNodeID();g[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),m=g[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(y==="NodeList"&&((r=(l=g[0].previousElementSibling)==null?void 0:l.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((d=g[0].parentElement.previousElementSibling)!=null&&d.classList.contains("li")){if(m=g[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),u=g[0].parentElement.parentElement.outerHTML,!m){const b=Lute.NewNodeID();g[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),m=g[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(m){m=m.lastElementChild.previousElementSibling;const b=g[0].classList.contains("list")?g[0]:g[0].parentElement;g.reverse().forEach(w=>{w.classList.contains("list")?m.after(w.firstElementChild):m.after(w)}),m.id==="moveTempLi"&&(m=m.nextElementSibling,m.previousElementSibling.remove()),b.childElementCount===1?b.remove():b.getAttribute("data-subtype")==="o"&&b.classList.contains("list")&&Qe(b,1),m.getAttribute("data-subtype")==="o"&&Qe(m.parentElement),Q(e,m.parentElement.parentElement.parentElement.getAttribute("data-node-id"),m.parentElement.parentElement.parentElement.outerHTML,u),fn(e),fe(m.parentElement,n),Oe(e);return}if(!(!g[0].previousElementSibling||(c=g[0].previousElementSibling)!=null&&c.classList.contains("protyle-action"))){if(m=g[0].previousElementSibling,g[0].getAttribute("data-subtype")==="o"&&y==="NodeListItem"){const b=g[0].parentElement.outerHTML;g[g.length-1].after(m),Qe(g[0].parentElement,1),Q(e,g[0].parentElement.getAttribute("data-node-id"),g[0].parentElement.outerHTML,b)}else{const b=m.getAttribute("data-node-id");B(e,[{action:"move",id:b,previousID:g[g.length-1].getAttribute("data-node-id")}],[{action:"move",id:b,previousID:(f=m.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||e.block.parentID}]),g[g.length-1].after(m)}fn(e),Oe(e)}},Td=(e,t,n)=>{var a,s,i,o,l,r,d;let c,f="",m=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){let g=Ve(t);const y=O(g,"fold","1");y&&(g=y),(a=g.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(g=Ve(g.parentElement)),m=[g]}const u=m[0].getAttribute("data-type");if(u==="NodeListItem"&&m[m.length-1].nextElementSibling.classList.contains("protyle-attr")&&((s=m[0].parentElement.parentElement)!=null&&s.classList.contains("li")))if((i=m[0].parentElement.parentElement.nextElementSibling)!=null&&i.classList.contains("li")){if(c=m[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),f=m[0].parentElement.parentElement.parentElement.outerHTML,!c){const g=Lute.NewNodeID();m[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${g}" data-type="NodeList" class="list" updated="${g.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),c=m[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(u==="NodeList"&&m[m.length-1].nextElementSibling.classList.contains("protyle-attr")&&((o=m[0].parentElement)!=null&&o.classList.contains("li")))if((l=m[0].parentElement.nextElementSibling)!=null&&l.classList.contains("li")){if(c=m[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),f=m[0].parentElement.parentElement.outerHTML,!c){const g=Lute.NewNodeID();m[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${m[0].getAttribute("data-subtype")}" data-node-id="${g}" data-type="NodeList" class="list" updated="${g.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),c=m[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(c){const g=m[0].classList.contains("list")?m[0]:m[0].parentElement;m.forEach(y=>{y.classList.contains("list")?c.before(y.firstElementChild):c.before(y)}),g.childElementCount===1?g.remove():g.getAttribute("data-subtype")==="o"&&g.classList.contains("list")&&Qe(g,1),c.getAttribute("data-subtype")==="o"&&Qe(c.parentElement,1),Q(e,c.parentElement.parentElement.parentElement.getAttribute("data-node-id"),c.parentElement.parentElement.parentElement.outerHTML,f),fn(e),fe(c.parentElement,n),Oe(e);return}if(!(!m[m.length-1].nextElementSibling||(r=m[m.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(c=m[m.length-1].nextElementSibling,c.getAttribute("data-subtype")==="o"&&c.getAttribute("data-type")==="NodeListItem"){const g=c.parentElement.outerHTML;m[0].before(c),Qe(c.parentElement,1),Q(e,c.parentElement.getAttribute("data-node-id"),c.parentElement.outerHTML,g)}else{const g=c.getAttribute("data-node-id");B(e,[{action:"move",id:g,previousID:(d=m[0].previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:c.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:g,previousID:m[m.length-1].getAttribute("data-node-id")}]),m[0].before(c)}fn(e),Oe(e)}};class qa{constructor(t,n){this.element=document.createElement("button");const a=n.hotkey?` ${je(n.hotkey)}`:"",s=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",s+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(xs(),i=>{i.preventDefault(),p.INLINE_TYPE.includes(n.name)?t.toolbar.setInlineMark(t,n.name,"toolbar"):n.click&&n.click(t.getInstance())})}}class ug extends qa{constructor(t,n){super(t,n),this.element.addEventListener("click",()=>{t.toolbar.element.classList.add("fn__none"),t.toolbar.subElement.innerHTML="",t.toolbar.subElement.style.width="",t.toolbar.subElement.style.padding="",t.toolbar.subElement.append(fg(t,ao(t))),t.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),t.toolbar.subElement.classList.remove("fn__none"),t.toolbar.subElementCloseCB=void 0,X(t.toolbar.range)})}}const fg=(e,t)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(u=>{n+=`<button ${u?`class="color__square" style="color:${u}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="color">A</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(u=>{a+=`<button ${u?`class="color__square" style="background-color:${u}"`:`class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.default}"`} data-type="backgroundColor"></button>`});const s=document.createElement("div");s.classList.add("protyle-font");let i=!1;t==null||t.find(u=>{if(u.classList.contains("li"))return i=!0,!0});let o="";const l=window.siyuan.storage[p.LOCAL_FONTSTYLES];l.length>0&&(o=`<div data-id="lastUsed" class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="fn__kbd fn__flex-center${window.siyuan.config.keymap.editor.insert.lastUsed.custom?"":" fn__none"}">${je(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div data-id="lastUsedWrap" class="fn__flex fn__flex-wrap" style="align-items: center">`,l.forEach(u=>{const g=u.split(p.ZWSP);switch(g[0]){case"color":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorFont}${g[1]?"":" "+window.siyuan.languages.default}" ${g[1]?`style="color:${g[1]}"`:""} data-type="${g[0]}">A</button>`;break;case"backgroundColor":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.colorPrimary}${g[1]?"":" "+window.siyuan.languages.default}" ${g[1]?`style="background-color:${g[1]}"`:""} data-type="${g[0]}"></button>`;break;case"style2":o+=`<button data-type="${g[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="${g[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":i||(o+=`<button data-type="${g[0]}" class="protyle-font__style">${g[1]}</button>`);break;case"style1":o+=`<button class="color__square ariaLabel" data-position="3south" aria-label="${window.siyuan.languages.color}${g[1]?"":" "+window.siyuan.languages.default}" ${g[1]?`style="background-color:${g[1]};color:${g[2]}"`:""} data-type="${g[0]}">A</button>`;break;case"clear":o+=`<button style="height: 26px;display: flex;align-items: center;padding: 0 5px;" data-type="${g[0]}" class="protyle-font__style ariaLabel" aria-label="${window.siyuan.languages.clearFontStyle}"><svg class="svg--mid"><use xlink:href="#iconTrashcan"></use></svg></button>`;break}}),o+="</div>");let r,d=window.siyuan.config.editor.fontSize+"px";t&&t.length>0?r=t[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=O(e.toolbar.range.startContainer,"data-type","text"))),r&&(d=r.style.fontSize||window.siyuan.config.editor.fontSize+"px"),s.innerHTML=`${o}
<div class="fn__hr"></div>
<div data-id="color">${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div data-id="colorWrap" class="fn__flex fn__flex-wrap">
    <button class="color__square ariaLabel" data-position="3south" data-type="style1" aria-label="${window.siyuan.languages.default}">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div data-id="colorFont">${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div data-id="colorFontWrap" class="fn__flex fn__flex-wrap">
    ${n}
</div>
<div class="fn__hr"></div>
<div data-id="colorPrimary">${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div data-id="colorPrimaryWrap" class="fn__flex fn__flex-wrap">
    ${a}
</div>
<div class="fn__hr"></div>
<div data-id="fontStyle">${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div data-id="fontStyleWrap" class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${i?" fn__none":""}"></div>
<div data-id="fontSize" class="fn__flex${i?" fn__none":""}">
    ${window.siyuan.languages.fontSize}
    <span class="fn__flex-1"></span>
    <label class="fn__flex">
        ${window.siyuan.languages.relativeFontSize}
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" ${d.endsWith("em")?"checked":""} type="checkbox">
        <span class="fn__space--small"></span>
    </label>
</div>
<div data-id="fontSizeWrap" class="${i?" fn__none":""}">
    <div class="fn__hr"></div>
    <div class="b3-tooltips b3-tooltips__n fn__flex${d.endsWith("em")?" fn__none":""}" aria-label="${d}">   
        <input class="b3-slider fn__block" id="fontSizePX" max="72" min="9" step="1" type="range" value="${parseInt(d)}">
    </div>
    <div class="b3-tooltips b3-tooltips__n fn__flex${d.endsWith("em")?"":" fn__none"}" aria-label="${parseFloat(d)*100}%">   
        <input class="b3-slider fn__block" id="fontSizeEM" max="4.5" min="0.56" step="0.01" type="range" value="${parseFloat(d)}">
    </div>
</div>
<div class="fn__hr--b"></div>
<div data-id="clearFontStyle" class="fn__flex">
    <div class="fn__space--small"></div>
    <button class="b3-button b3-button--remove fn__block" data-type="clear">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
    </button>
    <div class="fn__space--small"></div>
</div>`,s.addEventListener("click",function(u){let g=u.target;for(;g&&!g.isEqualNode(s);){const y=g.getAttribute("data-type");if(g.tagName==="BUTTON"){y==="style1"?zt(e,t,y,g.style.backgroundColor+p.ZWSP+g.style.color):y==="fontSize"?zt(e,t,y,g.textContent.trim()):y==="backgroundColor"?zt(e,t,y,g.style.backgroundColor):y==="color"?zt(e,t,y,g.style.color):zt(e,t,y);break}g=g.parentElement}});const c=s.querySelector(".b3-switch"),f=s.querySelector("#fontSizePX"),m=s.querySelector("#fontSizeEM");return c.addEventListener("change",function(){if(c.checked){const u=parseFloat((parseInt(f.value)/16).toFixed(2));m.parentElement.setAttribute("aria-label",(u*100).toString()+"%"),m.value=u.toString(),f.parentElement.classList.add("fn__none"),m.parentElement.classList.remove("fn__none"),zt(e,t,"fontSize",m.value+"em")}else{const u=Math.round(parseFloat(m.value)*16);f.parentElement.setAttribute("aria-label",u+"px"),f.value=u.toString(),f.parentElement.classList.remove("fn__none"),m.parentElement.classList.add("fn__none"),zt(e,t,"fontSize",f.value+"px")}}),f.addEventListener("change",function(){zt(e,t,"fontSize",f.value+"px")}),m.addEventListener("change",function(){zt(e,t,"fontSize",m.value+"em")}),f.addEventListener("input",function(){f.parentElement.setAttribute("aria-label",f.value+"px")}),m.addEventListener("input",function(){m.parentElement.setAttribute("aria-label",(parseFloat(m.value)*100).toFixed(0)+"%")}),s},zt=(e,t,n,a)=>{let s=window.siyuan.storage[p.LOCAL_FONTSTYLES];if(n)s.splice(0,0,`${n}${p.ZWSP}${a}`),s=[...new Set(s)],s.length>8&&s.splice(8,1),window.siyuan.storage[p.LOCAL_FONTSTYLES]=s,Te(p.LOCAL_FONTSTYLES,window.siyuan.storage[p.LOCAL_FONTSTYLES]);else if(s.length===0)n="style1",a="var(--b3-card-error-color)"+p.ZWSP+"var(--b3-card-error-background)";else{const i=s[0].split(p.ZWSP);n=i.splice(0,1)[0],a=i.join(p.ZWSP)}t&&t.length>0?(Aa(t,e,i=>{if(n==="clear")i.style.color="",i.style.webkitTextFillColor="",i.style.webkitTextStroke="",i.style.textShadow="",i.style.backgroundColor="",i.style.fontSize="",i.style.removeProperty("--b3-parent-background");else if(n==="style1"){const o=a.split(p.ZWSP);i.style.backgroundColor=o[0],i.style.color=o[1],i.style.setProperty("--b3-parent-background",o[0])}else n==="style2"?(i.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",i.style.webkitTextFillColor="transparent"):n==="style4"?i.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?i.style.color=a:n==="backgroundColor"?(i.style.backgroundColor=a,i.style.setProperty("--b3-parent-background",a)):n==="fontSize"&&(i.style.fontSize=a);(n==="fontSize"||n==="clear")&&i.getAttribute("data-type")==="NodeCodeBlock"&&si(i.querySelector(".hljs"))}),X(e.toolbar.range)):n==="clear"?e.toolbar.setInlineMark(e,"clear","range",{type:"text"}):e.toolbar.setInlineMark(e,"text","range",{type:n,color:a})},no=(e,t)=>{const n=i=>{const o=i.split(p.ZWSP),l=o.splice(0,1)[0];e.setAttribute("data-id",l),e.setAttribute("data-subtype",o.splice(0,1)[0]),e.removeAttribute("data-href");let r=o.join("");r.replace(/\s/g,"")===""&&(r=l),e.innerText=r},a=i=>{const o=i.split(p.ZWSP);e.setAttribute("data-href",o[0]),e.removeAttribute("data-subtype"),e.removeAttribute("data-id"),o[1]&&(e.textContent=o[1])},s=i=>{const o=i.split(p.ZWSP);e.setAttribute("data-id",o[0]),e.removeAttribute("data-href"),e.removeAttribute("data-subtype"),o[1]&&(e.textContent=o[1])};if(t){switch(t.type){case"color":e.style.color=t.color;break;case"fontSize":e.style.fontSize=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style1":e.style.backgroundColor=t.color.split(p.ZWSP)[0],e.style.color=t.color.split(p.ZWSP)[1];break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(t.color);break;case"inline-math":e.className="render-node",e.setAttribute("contenteditable","false"),e.setAttribute("data-subtype","math"),e.setAttribute("data-content",e.textContent.replace(p.ZWSP,"")),e.removeAttribute("data-render"),e.textContent="";break;case"a":a(t.color);break;case"file-annotation-ref":s(t.color);break;case"inline-memo":e.removeAttribute("contenteditable"),e.removeAttribute("data-content");break}e.getAttribute("style")||e.removeAttribute("style")}},Id=(e,t,n)=>{if(!n&&e){const a=t.getAttribute("data-type").split(" ");return a.includes("inline-math")||a.includes("inline-memo")||a.includes("a")||a.includes("block-ref")&&(e.getAttribute("data-id")!==t.getAttribute("data-id")||e.getAttribute("data-subtype")!==t.getAttribute("data-subtype")||e.textContent!==t.textContent)||a.includes("file-annotation-ref")&&(e.getAttribute("data-id")!==t.getAttribute("data-id")||e.textContent!==t.textContent)?!1:t.style.color===e.style.color&&t.style.webkitTextFillColor===e.style.webkitTextFillColor&&t.style.webkitTextStroke===e.style.webkitTextStroke&&t.style.textShadow===e.style.textShadow&&t.style.backgroundColor===e.style.backgroundColor&&t.style.fontSize===e.style.fontSize}if(n){if(n.type==="text")return!t.style.color&&!t.style.webkitTextFillColor&&!t.style.webkitTextStroke&&!t.style.textShadow&&!t.style.fontSize&&!t.style.backgroundColor;if(n.type==="color")return n.color===t.style.color;if(n.type==="backgroundColor")return n.color===t.style.backgroundColor;if(n.type==="style1")return n.color.split(p.ZWSP)[0]===t.style.color&&n.color.split(p.ZWSP)[1]===t.style.backgroundColor;if(n.type==="style2")return t.style.webkitTextFillColor==="transparent"&&t.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)";if(n.type==="style4")return t.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";if(n.type==="fontSize")return n.color===t.style.fontSize}return!1},ao=e=>{let t;if(e.toolbar.range.toString()===""&&(t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0)){const n=F(e.toolbar.range.startContainer);n&&(t=[n])}return t},gg=(e,t,n)=>{var a,s,i;if(C(e,"protyle-wysiwyg__embed"))return;const o=It(e);if(!o&&e.classList.contains("protyle-wysiwyg--select")){ct(oe(e),t,!1),t.collapse(!1),ae(["select"],n);return}if((a=n.observerLoad)==null||a.disconnect(),o||e.classList.contains("table")){e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?n.toolbar.showRender(n,e):an(n,"afterend");return}const l=oe(e);if(l.querySelectorAll(".img--select").forEach(_=>{_.classList.remove("img--select")}),e.getAttribute("data-type")==="NodeAttributeView")return!0;const r=l.innerHTML.trimStart(),d=l.textContent.trimStart();if((r.startsWith("```")||r.startsWith("\xB7\xB7\xB7")||r.startsWith("~~~")||r.indexOf("\n```")>-1&&d.indexOf("\n```")>-1||r.indexOf(`
~~~`)>-1&&d.indexOf(`
~~~`)>-1||r.indexOf(`
\xB7\xB7\xB7`)>-1&&d.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(r.indexOf(`
`)===-1&&r.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(e.classList.contains("p")){const _=e.outerHTML;let E=l.innerHTML.replace(/\n(~||`){3,}/g,"\n```").trim().replace(/^(~||`){3,}/g,"```");E.endsWith("\n```")||(E+="<wbr>\n```"),l.innerHTML=E,e.outerHTML=n.lute.SpinBlockDOM(e.outerHTML),e=n.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);const A=e.querySelector(".protyle-action__language");return A?(window.siyuan.storage[p.LOCAL_CODELANG]&&A.textContent===""?A.textContent=window.siyuan.storage[p.LOCAL_CODELANG]:p.SIYUAN_RENDER_CODE_LANGUAGES.includes(A.textContent)||(window.siyuan.storage[p.LOCAL_CODELANG]=A.textContent,Te(p.LOCAL_CODELANG,window.siyuan.storage[p.LOCAL_CODELANG])),p.SIYUAN_RENDER_CODE_LANGUAGES.includes(A.textContent)?(e.dataset.content="",e.dataset.subtype=A.textContent,e.className="render-node",e.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,n.toolbar.showRender(n,e),Xe(e)):Re(e)):(n.toolbar.showRender(n,e),Xe(e)),Q(n,e.getAttribute("data-node-id"),e.outerHTML,_),!0}}if(e.getAttribute("data-type")==="NodeCodeBlock"){const _=document.createElement("wbr");t.insertNode(_);const E=e.outerHTML;return _.remove(),t.extractContents(),l.textContent.endsWith(`
`)||l.insertAdjacentText("beforeend",`
`),t.insertNode(document.createTextNode(`
`)),t.collapse(!1),t.insertNode(_),l.parentElement.removeAttribute("data-render"),Re(e),Q(n,e.getAttribute("data-node-id"),e.outerHTML,E),Oe(n),!0}if(l.textContent.replace(p.ZWSP,"").replace(`
`,"")===""&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const _=qt(e),E=e.getAttribute("data-node-id"),A=_.getAttribute("data-node-id"),x={action:"insert",id:E,data:e.outerHTML},I={action:"insert",id:A,data:_.outerHTML};return A===E?(x.previousID=e.parentElement.getAttribute("data-node-id"),I.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(x.previousID=_.previousElementSibling?_.previousElementSibling.getAttribute("data-node-id"):void 0,x.parentID=_.parentElement.getAttribute("data-node-id")||n.block.parentID,I.previousID=x.previousID,I.parentID=x.parentID,_.after(e),_.remove()),B(n,[{action:"delete",id:A},x],[{action:"delete",id:E},I]),A===E&&e.parentElement.classList.contains("sb")&&e.parentElement.getAttribute("data-sb-layout")==="col"&&_n({protyle:n,selectsElement:[e.previousElementSibling,e],type:"BlocksMergeSuperBlock",level:"row"}),fe(e,t),!0}const c=et(l,n.wysiwyg.element,t);if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&((s=e.previousElementSibling)!=null&&s.classList.contains("protyle-action"))||c.start===0&&e.previousElementSibling.classList.contains("protyle-action")||e.parentElement.getAttribute("fold")==="1")&&pg(n,e,t))return!0;if(l.textContent!==""&&t.toString()===""&&c.start===0){let _;e.previousElementSibling&&e.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&e.previousElementSibling.getAttribute("fold")==="1"?_=ts(e.previousElementSibling,!1,!0):_=yn(!1,!0);const E=_.getAttribute("data-node-id");return B(n,[{action:"insert",data:_.outerHTML,id:E,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:E}]),_.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",_),Fs(_),!0}t.insertNode(document.createElement("wbr"));const f=e.outerHTML;if(t.toString()!==""){const _=O(t.startContainer,"data-type","inline-math");if(_){const E=qe(_);return E&&(t=getSelection().getRangeAt(0),t.setEnd(E,E.textContent.startsWith(p.ZWSP)?1:0),t.collapse(!1)),(i=_.querySelector("wbr"))==null||i.remove(),!0}t.extractContents(),t.insertNode(document.createElement("wbr"))}l.lastChild&&t.setEndAfter(l.lastChild);const m=e.getAttribute("data-node-id"),u=document.createElement("div");e.getAttribute("data-type")==="NodeHeading"&&e.getAttribute("fold")==="1"?u.innerHTML=ts(e,!0):u.appendChild(yn(!1,!1));const g=u.querySelector('[contenteditable="true"]');g.appendChild(t.extractContents());const y=g.querySelector("wbr");y&&y.parentElement.tagName==="SPAN"&&y.parentElement.innerHTML==="<wbr>"&&(y.parentElement.outerHTML="<wbr>");const b=g.innerHTML.trimStart(),w=g.textContent.trimStart();if((b.startsWith("```")||b.startsWith("\xB7\xB7\xB7")||b.startsWith("~~~")||b.indexOf("\n```")>-1&&w.indexOf("\n```")>-1||b.indexOf(`
~~~`)>-1&&w.indexOf(`
~~~`)>-1||b.indexOf(`
\xB7\xB7\xB7`)>-1&&w.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(b.indexOf(`
`)===-1&&b.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let _=g.innerHTML.replace(/\n(~||`){3,}/g,"\n```").trim().replace(/^(~||`){3,}/g,"```");_.endsWith("\n```")||(_+="\n```"),g.innerHTML=_}u.innerHTML=n.lute.SpinBlockDOM(u.innerHTML);const h=document.createElement("div");h.innerHTML=n.lute.SpinBlockDOM(l.parentElement.outerHTML);const S=[],$=[];let D=e;const v=[];Array.from(h.children).forEach(_=>{_.dataset.nodeId===m?(e.before(_),e.remove(),S.push({action:"update",data:_.outerHTML,id:m}),$.push({action:"update",data:f,id:m})):(S.push({action:"insert",data:_.outerHTML,id:_.dataset.nodeId,nextID:m}),D.insertAdjacentElement("afterend",_),$.push({action:"delete",id:_.dataset.nodeId})),_.dataset.type==="NodeBlockQueryEmbed"?xe(n,_):jt(_),D=_,v.push(_)}),Array.from(u.children).forEach(_=>{const E=_.getAttribute("data-node-id");S.push({action:"insert",data:_.outerHTML,id:E,previousID:D.getAttribute("data-node-id")}),$.push({action:"delete",id:E}),D.insertAdjacentElement("afterend",_),_.classList.contains("code-block")?Re(_):_.dataset.type==="NodeBlockQueryEmbed"?xe(n,_):jt(D.nextElementSibling),D=_,v.push(_)});const k=D.parentElement;return B(n,S,$),k.classList.contains("sb")&&k.getAttribute("data-sb-layout")==="col"&&_n({protyle:n,selectsElement:v,type:"BlocksMergeSuperBlock",level:"row"}),fe(D,t),Oe(n),!0},pg=(e,t,n)=>{var a,s;const i=t.parentElement,o=oe(t);if(["",`
`].includes(o.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if((a=i.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return di(e,[t.parentElement],n),!0;if(!i.parentElement.classList.contains("protyle-wysiwyg"))return ep(e,t,n),!0}const l=et(o,e.wysiwyg.element,n);if(n.toString()===""&&l.start===0&&!st(n.startContainer)){if(i.parentElement.classList.contains("protyle-wysiwyg"))return!0;const g=document.createElement("wbr");n.insertNode(g);const y=i.parentElement.outerHTML;g.remove();let b=Wa(i,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))oe(t).textContent===""?i.insertAdjacentElement("afterend",b):i.insertAdjacentElement("beforebegin",b);else{if(oe(t).textContent!=="")return!1;t.remove(),b=Wa(i,-1,!0),i.insertAdjacentElement("afterend",b)}return i.getAttribute("data-subtype")==="o"&&Qe(i.parentElement),Q(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,y),fe(b,n),Oe(e),Fs(b),!0}const r=i.querySelector(".list");let d;if(r&&i.getAttribute("fold")!=="1"&&t.nextElementSibling===r){if(l.end>=o.textContent.length-(o.textContent.endsWith(p.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const g=i.outerHTML;t.querySelector("wbr").remove(),d=Wa(r.firstElementChild,-1,!0),r.firstElementChild.before(d),r.getAttribute("data-subtype")==="o"&&Qe(r),Q(e,i.getAttribute("data-node-id"),i.outerHTML,g),fe(i,n),Oe(e)}else{n.insertNode(document.createElement("wbr"));const g=i.outerHTML,y=i.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(o.lastChild),d=Wa(i,0,!1);const b=oe(d);b.appendChild(n.extractContents());const w=b.querySelector("wbr");w&&w.parentElement.tagName==="SPAN"&&w.parentElement.innerHTML==="<wbr>"&&(w.parentElement.outerHTML="<wbr>");let h=r.nextElementSibling;for(d.lastElementChild.before(r);!h.classList.contains("protyle-attr");)h=h.nextElementSibling,d.lastElementChild.before(h.previousElementSibling);i.insertAdjacentElement("afterend",d),i.getAttribute("data-subtype")==="o"&&Qe(i.parentElement),i.parentElement.classList.contains("protyle-wysiwyg")?B(e,[{action:"update",data:i.outerHTML,id:i.getAttribute("data-node-id")},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",data:g,id:i.getAttribute("data-node-id")}]):Q(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,y),fe(d,n),Oe(e)}return Fs(d),!0}if((n.toString()===""||n.toString()===p.ZWSP)&&n.startContainer.nodeType===3&&n.startOffset===0){let g=n.startContainer;for(;g;)if(g.textContent===p.ZWSP){n.setStart(g,1),n.collapse(!1);break}else g=g.nextSibling}n.insertNode(document.createElement("wbr"));const c=i.outerHTML,f=i.parentElement.outerHTML;if(n.toString()!==""){const g=O(n.startContainer,"data-type","inline-math");if(g){const y=qe(g);return y&&(n=getSelection().getRangeAt(0),n.setEnd(y,y.textContent.startsWith(p.ZWSP)?1:0),n.collapse(!1)),(s=g.querySelector("wbr"))==null||s.remove(),!0}n.extractContents(),n.insertNode(document.createElement("wbr"))}o.lastChild&&n.setEndAfter(o.lastChild),d=Wa(i,0,!1);const m=oe(d);m.appendChild(n.extractContents());const u=m.querySelector("wbr");return u&&u.parentElement.tagName==="SPAN"&&u.parentElement.innerHTML==="<wbr>"&&(u.parentElement.outerHTML="<wbr>"),m.parentElement.outerHTML=e.lute.SpinBlockDOM(m.parentElement.outerHTML),i.insertAdjacentElement("afterend",d),xe(e,d),jt(d),Xe(d),o.parentElement.outerHTML=e.lute.SpinBlockDOM(o.parentElement.outerHTML),xe(e,i),jt(i),Xe(i),i.getAttribute("data-subtype")==="o"&&Qe(i.parentElement),i.parentElement.classList.contains("protyle-wysiwyg")?B(e,[{action:"update",id:i.getAttribute("data-node-id"),data:i.outerHTML},{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:d.getAttribute("data-node-id")},{action:"update",id:i.getAttribute("data-node-id"),data:c}]):Q(e,i.parentElement.getAttribute("data-node-id"),i.parentElement.outerHTML,f),fe(d,n),Oe(e),Fs(d),!0},Fs=e=>{const t=oe(e).childNodes;for(let n=0;n<t.length;n++)t[n].nodeType===3&&t[n].textContent.length===0&&(t[n].remove(),n--)},$d=(e,t,n)=>{let a=e.startContainer;const s=qe(a);if(t.getAttribute("data-type")==="NodeAttributeView")return!0;if(s&&s.nodeType!==3&&et(e.startContainer,n.wysiwyg.element,e).end===e.endContainer.textContent.length&&(s.classList.contains("img")||s.getAttribute("data-type")==="inline-math")){s.insertAdjacentHTML("beforebegin","<wbr>");const o=t.outerHTML;s.previousElementSibling.remove();const l=document.createTextNode(`
`);return a.after(document.createTextNode(p.ZWSP)),a.after(l),e.selectNode(l),e.collapse(!1),Q(n,t.getAttribute("data-node-id"),t.outerHTML,o),!0}if(a.nodeType===3&&(a=a.parentElement),a&&n.toolbar.getCurrentType(e).length>0&&et(a,a,e).end===a.textContent.length)return Dd(e,t,n,a),!0;if(Ri()||P()){a=e.startContainer;const i=qe(a);return i&&i.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(Dd(e,t,n,a),!0)}return!1},Dd=(e,t,n,a)=>{const s=document.createElement("wbr");a.nodeType===3?e.insertNode(s):a.insertAdjacentElement("afterend",s);const i=t.outerHTML;s.remove();let o;qe(a)||(o=document.createTextNode(`
`),a.after(o));const l=document.createTextNode(`
`);a.after(l),o?e.setStart(o,0):e.setStart(l,1),e.collapse(!0),X(e),Q(n,t.getAttribute("data-node-id"),t.outerHTML,i)};let Md,Ji=!1;const Ie=(e,t,n,a="false")=>{let s;return t&&t.startsWith("icon")?s=`<svg class="keyboard__slash-icon"><use xlink:href="#${t}"></use></svg>`:s=t,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(e)}">
    ${s}
    <span class="keyboard__slash-text">${n}</span>
</button>`},Hd=(e,t)=>{let n="";["","var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((f,m)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" ${f?`style="color:${f}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${f?m+1:window.siyuan.languages.default}</span>
</button>`});let a="";["","var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((f,m)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" ${f?`style="background-color:${f}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${f?m+1:window.siyuan.languages.default}</span>
</button>`});const s=ao(e);let i=!1;s==null||s.find(f=>{if(f.classList.contains("li"))return i=!0,!0});let o="";const l=window.siyuan.storage[p.LOCAL_FONTSTYLES];l.length>0&&(o=`<div data-id="lastUsed" class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div data-id="lastUsedWrap" class="keyboard__slash-block">`,l.forEach(f=>{const m=f.split(p.ZWSP);switch(m[0]){case"color":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" ${m[1]?`style="color:${m[1]}"`:""} >A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${m[1]?parseInt(m[1].replace("var(--b3-font-color",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"backgroundColor":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" ${m[1]?`style="background-color:${m[1]}"`:""}>A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${m[1]?parseInt(m[1].replace("var(--b3-font-background",""))+1:window.siyuan.languages.default}</span>
</button>`;break;case"style2":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":i||(o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text">${m[1]}</span>
</button>`);break;case"style1":m[1]?o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon" style="background-color:${m[1]};color:${m[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[m[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`:o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-icon">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
</button>`;break;case"clear":o+=`<button class="keyboard__slash-item" data-type="${m[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),o+="</div>");let r,d="16px";s&&s.length>0?r=s[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=O(e.toolbar.range.startContainer,"data-type","text"))),r&&(d=r.style.fontSize||"16px");const c=t.querySelector(".keyboard__util");c.innerHTML=`${o}
<div data-id="color" class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div data-id="colorWrap" class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.color} ${window.siyuan.languages.default}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div data-id="colorFont" class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div data-id="colorFontWrap" class="keyboard__slash-block">
    ${n}
</div>
<div data-id="colorPrimary" class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div data-id="colorPrimaryWrap" class="keyboard__slash-block">
    ${a}
</div>
<div data-id="fontStyle" class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div data-id="fontStyleWrap" class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div data-id="fontSize" class="keyboard__slash-title${i?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div data-id="fontSizeWrap" class="keyboard__slash-block${i?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${d==="12px"?"selected":""} value="12px">12px</option>
        <option ${d==="13px"?"selected":""} value="13px">13px</option>
        <option ${d==="14px"?"selected":""} value="14px">14px</option>
        <option ${d==="15px"?"selected":""} value="15px">15px</option>
        <option ${d==="16px"?"selected":""} value="16px">16px</option>
        <option ${d==="19px"?"selected":""} value="19px">19px</option>
        <option ${d==="22px"?"selected":""} value="22px">22px</option>
        <option ${d==="24px"?"selected":""} value="24px">24px</option>
        <option ${d==="29px"?"selected":""} value="29px">29px</option>
        <option ${d==="32px"?"selected":""} value="32px">32px</option>
        <option ${d==="40px"?"selected":""} value="40px">40px</option>
        <option ${d==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,c.querySelector("select").addEventListener("change",function(f){zt(e,s,"fontSize",f.target.value)})},mg=(e,t)=>{e.hint.splitChar="/",e.hint.lastIndex=-1;let n="";e.app.plugins.forEach(s=>{s.protyleSlash.forEach(i=>{n+=Ie(`plugin${p.ZWSP}${s.name}${p.ZWSP}${i.id}`,"",i.html,"true")})}),n&&(n=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${n}</div>`);const a=t.querySelector(".keyboard__util");a.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ie(p.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${Ie(p.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${Ie(p.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${Ie("((","iconRef",window.siyuan.languages.ref,"true")}
    ${Ie("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${Ie(p.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${Ie('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${Ie(p.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ie(p.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true")}
    ${Je()?Ie(p.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true"):""}
    ${Ie('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${Ie("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${Ie('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${Ie('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${Ie("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ie("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${Ie("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${Ie("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${Ie("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${Ie("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${Ie("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${Ie("- "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${Ie("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${Ie("- [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${Ie("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${Ie("```","iconCode",window.siyuan.languages.code,"true")}
    ${Ie(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${Ie("---","iconLine",window.siyuan.languages.line,"true")}
    ${Ie("$$","iconMath",window.siyuan.languages.math)}
    ${Ie("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ie("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${Ie("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${Ie("```flowchart\n```","","Flow Chart","true")}
    ${Ie("```graphviz\n```","","Graph","true")}
    ${Ie("```mermaid\n```","","Mermaid","true")}
    ${Ie("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${Ie("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ie(`style${p.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${Ie(`style${p.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${Ie(`style${p.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${Ie(`style${p.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${Ie(`style${p.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${n}`,e.hint.bindUploadEvent(e,a)},io=e=>{window.siyuan.menus.menu.remove(),Ji=!0;const t=document.getElementById("keyboardToolbar");let n=t.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const a=Ft();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=e),setTimeout(()=>{t.style.height=n},p.TIMEOUT_TRANSITION),setTimeout(()=>{Ji=!1},1e3)},Qi=()=>{const e=document.getElementById("keyboardToolbar");e.style.height="";const t=Ft();t&&(t.protyle.element.parentElement.style.paddingBottom="42px"),e.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},bg=()=>{clearTimeout(Md),Md=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){Ys();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){Ys();return}Ji||Qi(),Nd();const e=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),t=getSelection().getRangeAt(0);if(!C(t.startContainer,"protyle-wysiwyg",!0)){e[0].classList.add("fn__none"),e[1].classList.add("fn__none");return}t.toString()||e[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(e[0].classList.add("fn__none"),e[1].classList.remove("fn__none")):(e[0].classList.remove("fn__none"),e[1].classList.add("fn__none"));const s=Ft().protyle;if(s.toolbar.range=t,!e[0].classList.contains("fn__none")){s.undo.undoStack.length===0?e[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),s.undo.redoStack.length===0?e[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const i=F(t.startContainer);if(i){const o=e[0].querySelector('[data-type="outdent"]');i.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"))}}e[1].classList.contains("fn__none")||(e[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),s.toolbar.getCurrentType(t).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=e[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},Nd=()=>{Ji||Qi();const e=document.getElementById("keyboardToolbar");if(!e.classList.contains("fn__none"))return;e.classList.remove("fn__none"),e.style.zIndex=(++window.siyuan.zIndex).toString();const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=Ft();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),Ft().protyle.app.plugins.forEach(s=>{s.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const s=C(n.startContainer,"protyle-content",!0);if(s){const i=s.getBoundingClientRect().top,o=Pn(s).top;if(o<window.innerHeight-42&&o>i)return;s.scroll({top:s.scrollTop+o-window.innerHeight+42+26,left:s.scrollLeft,behavior:"smooth"})}},p.TIMEOUT_TRANSITION)},Ys=()=>{if(Ji)return;const e=document.getElementById("keyboardToolbar");if(e.classList.contains("fn__none"))return;e.classList.add("fn__none"),e.style.height="";const t=Ft();t&&(t.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),Ft().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-hide")})},mn=()=>{window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard(),Ys(),document.activeElement.blur()},yg=()=>{let e=!1;document.addEventListener("selectionchange",()=>{e||bg()},!1);const t=document.getElementById("keyboardToolbar");t.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`;let n=0,a=0,s=!1;t.addEventListener("touchstart",i=>{n=i.touches[0].clientY,a=i.touches[0].clientX,s=!1}),t.addEventListener("touchmove",i=>{(Math.abs(i.touches[0].clientY-n)>10||Math.abs(i.touches[0].clientX-a)>10)&&(s=!0)}),t.addEventListener(Je()||ut()?"touchend":"click",i=>{var o;if(s)return;const l=(o=Ft())==null?void 0:o.protyle,r=i.target,d=C(i.target,"keyboard__slash-item");if(d&&!d.getAttribute("data-type")){const g=decodeURIComponent(d.getAttribute("data-value"));if(g===p.ZWSP+3)return;l.hint.fill(g,l,!1),i.preventDefault(),i.stopPropagation(),d.getAttribute("data-focus")==="true"&&X(l.toolbar.range);return}const c=U(r,"BUTTON");if(!c||c.getAttribute("disabled"))return;const f=c.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(f)){const g=ao(l),y=c.firstElementChild;f==="style1"?zt(l,g,f,y.style.backgroundColor+p.ZWSP+y.style.color):f==="fontSize"?zt(l,g,f,y.textContent.trim()):f==="backgroundColor"?zt(l,g,f,y.style.backgroundColor):f==="color"?zt(l,g,f,y.style.color):zt(l,g,f)}if(i.preventDefault(),i.stopPropagation(),getSelection().rangeCount===0)return;const m=getSelection().getRangeAt(0);if(f==="done"){t.clientHeight>100?(Qi(),X(m)):mn();return}if(window.siyuan.config.readonly||!l||l.disabled)return;if(f==="undo"){l.undo.undo(l);return}else if(f==="redo"){l.undo.redo(l);return}if(getSelection().rangeCount===0)return;const u=F(m.startContainer);if(u){if(f==="goback"){t.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const g=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");g[0].classList.remove("fn__none"),g[1].classList.add("fn__none"),X(m),e=!0,setTimeout(()=>{e=!1},1e3);return}else if(f==="goinline"){c.classList.add("protyle-toolbar__item--current");const g=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");g[1].classList.remove("fn__none"),g[0].classList.add("fn__none"),X(m);return}else if(["a","block-ref","inline-math","inline-memo"].includes(f)){O(m.startContainer,"data-type","NodeCodeBlock")||(ae(["util"],l),l.toolbar.element.querySelector(`[data-type="${f}"]`).dispatchEvent(new CustomEvent("click")));return}else if(c.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(f)){O(m.startContainer,"data-type","NodeCodeBlock")||l.toolbar.setInlineMark(l,f,"toolbar");return}else if(f==="text"){if(c.classList.contains("protyle-toolbar__item--current"))Qi(),X(m);else{c.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const g=l.contentElement.scrollTop;Hd(l,t),io(g),window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard()}return}else if(f==="moveup"){Cd(l,u,m),X(m);return}else if(f==="movedown"){Td(l,u,m),X(m);return}else if(f==="softLine"){m.extractContents(),$d(m,u,l),X(m);return}else if(f==="add"){if(c.classList.contains("protyle-toolbar__item--current"))Qi(),X(m);else{c.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const g=l.contentElement.scrollTop;mg(l,t),io(g),window.JSAndroid&&window.JSAndroid.hideKeyboard&&window.JSAndroid.hideKeyboard()}return}else if(f==="block"){l.gutter.renderMenu(l,u),window.siyuan.menus.menu.fullscreen(),mn();return}else if(f==="outdent"){di(l,[u.parentElement],m),X(m);return}else if(f==="indent"){Ks(l,[u.parentElement],m),X(m);return}}})},nt=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const e=document.querySelector(".side-mask");e.classList.add("fn__none"),e.style.opacity="",window.siyuan.menus.menu.remove()},so=()=>{mn(),document.getElementById("model").style.transform=""},lo=[],wg=e=>{var t;const n=Ft().protyle;if((t=n.observerLoad)==null||t.disconnect(),window.siyuan.storage[p.LOCAL_DOCINFO]={id:e.id},Te(p.LOCAL_DOCINFO,window.siyuan.storage[p.LOCAL_DOCINFO]),ae(["toolbar","hint","util"],n),n.contentElement.classList.contains("fn__none")&&us(n,"wysiwyg"),n.notebookId=e.data.notebookId,n.path=e.data.path,e.data.startId===n.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&e.data.endId===n.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){n.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"});return}e.id!==n.block.rootID&&L("/api/block/getDocInfo",{id:e.id},s=>{xi(s.data.name),n.title.setTitle(s.data.name),n.background.render(s.data.ial,n.block.rootID),n.wysiwyg.renderCustom(s.data.ial)});const a=n.breadcrumb.element.parentElement.querySelector('[data-type="exit-focus"]');if(e.zoomId){e.zoomId!==n.block.id?L("/api/block/checkBlockExist",{id:e.id},s=>{s.data&&Bt({protyle:n,id:e.id,isPushBack:!1,callback:()=>{n.contentElement.scrollTop=e.scrollTop}})}):n.contentElement.scrollTop=e.scrollTop,a.classList.remove("fn__none");return}L("/api/filetree/getDoc",{id:e.id,startID:e.data.startId,endID:e.data.endId},s=>{n.block.parentID=s.data.parentID,n.block.parent2ID=s.data.parent2ID,n.block.rootID=s.data.rootID,n.block.showAll=!1,n.block.mode=s.data.mode,n.block.blockCount=s.data.blockCount,n.block.id=s.data.id,n.block.action=e.callback,n.wysiwyg.element.setAttribute("data-doc-type",s.data.type),n.wysiwyg.element.innerHTML=s.data.content,Xe(n.wysiwyg.element),Re(n.wysiwyg.element),ot(n.wysiwyg.element,n),xe(n,n.wysiwyg.element,e.scrollTop),s.data.isSyncing?Ho(n):No(n,!0),n.contentElement.scrollTop=e.scrollTop,setTimeout(()=>{n.contentElement.scrollTop=e.scrollTop},p.TIMEOUT_LOAD),n.app.plugins.forEach(i=>{i.eventBus.emit("switch-protyle",{protyle:n}),i.eventBus.emit("loaded-protyle-static",{protyle:n})}),a.classList.add("fn__none")})},oo=()=>{const e=Ft().protyle;e.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,data:{startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:e.notebookId,path:e.path},scrollTop:e.contentElement.scrollTop,callback:e.block.action,zoomId:e.block.showAll?e.block.id:void 0})},_g=()=>{const e=Ft();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){nt();return}else if(e&&!e.protyle.toolbar.subElement.classList.contains("fn__none")){ae(["util"],e.protyle),nt();return}else if(window.siyuan.dialogs.length!==0){ae(["dialog"]),nt();return}if((window.JSAndroid||window.JSHarmony)&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid?window.JSAndroid.returnDesktop():window.JSHarmony&&window.JSHarmony.returnDesktop():se(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(lo.length===0&&e){const n=e.protyle;lo.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const t=window.siyuan.backStack.pop();lo.push(t),wg(t)};var hg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Ws=e=>({id:"export",label:window.siyuan.languages.export,icon:"iconUpload",click(){return hg(this,null,function*(){hr(e)})}}),Pd=(e,t,n,a,s=!1)=>{},Od=e=>{if(Je())window.JSAndroid.writeImageClipboard(e);else{const t=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{t.width=a.target.width,t.height=a.target.height,t.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),t.toBlob(s=>{navigator.clipboard.write([new ClipboardItem({"image/png":s})])},"image/png",1)},n.src=e}},Vs=(e,t)=>{e.element.querySelector(".wysiwygLoading")||(vi(e),ae(["toolbar"],e),L(`/api/format/net${t}2LocalAssets`,{id:e.block.rootID},()=>{la(e,!1)}))},ro=(e,t)=>{var n,a;setTimeout(()=>{_r(["gutter"])},p.TIMEOUT_TRANSITION);const s=e.className.includes("fullscreen");if(s?(e.classList.remove("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")):(e.classList.add("fullscreen"),(a=document.getElementById("drag"))==null||a.classList.add("fn__hidden")),re(),t){s?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const i=C(e,"layout--float");i&&(s?(i.setAttribute("data-temp",i.style.transform),i.style.transform="none"):(i.style.transform=i.getAttribute("data-temp"),i.removeAttribute("data-temp")));return}},qd=(e,t)=>{if(!window.siyuan.config.readonly){const n=e.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?n?ds(t):En(t):L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[p.CUSTOM_SY_READONLY]:n?"false":"true"}})}};var vg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Eg=(e,t,n)=>{if(ne(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,t))return Vs(e,"Img"),t.preventDefault(),t.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,t))return Vs(e,"Assets"),t.preventDefault(),t.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,t))return L("/api/format/autoSpace",{id:e.block.rootID}),t.preventDefault(),t.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.copyHPath.custom,t))return L("/api/filetree/getHPathByID",{id:e.block.rootID},a=>{He(a.data)}),t.preventDefault(),t.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),pn(a.map(s=>s.getAttribute("data-node-id")),"protocolMd")}else pn([e.block.rootID],"protocolMd");return t.preventDefault(),t.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.general.copyID.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),pn(a.map(s=>s.getAttribute("data-node-id")),"id")}else pn([e.block.rootID],"id");return t.preventDefault(),t.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.general.copyProtocol.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),pn(a.map(s=>s.getAttribute("data-node-id")),"protocol")}else pn([e.block.rootID],"protocol");return t.preventDefault(),t.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,t)){if(n){const a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&a.push(n),pn(a.map(s=>s.getAttribute("data-node-id")),"blockEmbed")}else pn([e.block.rootID],"blockEmbed");return t.preventDefault(),t.stopPropagation(),!0}},Rd=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const s=U(e.range.startContainer,"TD")||U(e.range.startContainer,"TH")||oe(e.nodeElement)||e.nodeElement,i=et(s,e.editorElement,e.range).start,o=s.innerText,l=ne(window.siyuan.config.keymap.editor.general.expandUp.custom,e.event);if(!(!$t()&&l)){if(i>0){o.substr(0,i).indexOf(`
`)===-1&&e.range.getBoundingClientRect().top-s.getBoundingClientRect().top-parseInt(getComputedStyle(s).paddingTop)<14&&(Ha(s,e.range),e.event.preventDefault());return}}}e.range.collapse(!0),ae(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Yt(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Bd=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const a=U(e.range.startContainer,"TD")||U(e.range.startContainer,"TH"),s=a||oe(e.nodeElement)||e.nodeElement,i=et(s,e.editorElement,e.range).end,o=s.innerText,l=ne(window.siyuan.config.keymap.editor.general.expandDown.custom,e.event);if(!(!$t()&&l)){if(i<o.length){!ht(e.nodeElement)&&o.trimRight().substr(i).indexOf(`
`)===-1&&s.getBoundingClientRect().bottom-e.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(s).paddingBottom)<14?(ct(s,e.range,!1),e.nodeElement.classList.contains("code-block")&&l&&e.event.preventDefault()):a&&(ct(a,e.range,!1),e.event.preventDefault());return}}}e.range.collapse(!1),ae(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Yt(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Ud=e=>{let t,n;return e.forEach(a=>{a.getAttribute("select-start")&&(t=a),a.getAttribute("select-end")&&(n=a)}),t||(t=e[0],t.setAttribute("select-start","true")),n||(n=e[e.length-1],n.setAttribute("select-end","true")),{startElement:t,endElement:n}},co=(e,t)=>vg(void 0,null,function*(){var n;let a;const s=[],i=[];let o,l=e[e.length-1],r=!0;l.classList.contains("li")&&(l.getAttribute("data-subtype")==="o"&&(o=parseInt(l.getAttribute("data-marker"),10)),e.find(f=>{if(!f.classList.contains("li")||l.getAttribute("data-subtype")!==f.getAttribute("data-subtype"))return r=!1,!0}),r||(l=ue(l,"list")||l));let d="";const c=[];for(let f=e.length-1;f>=0;--f){const m=e[f];m.classList.remove("protyle-wysiwyg--select");let u=m.cloneNode(!0);const g=Lute.NewNodeID();if(m.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&m.querySelector('[data-type="NodeHeading"][fold="1"]')){const y=yield he("/api/block/getBlockDOM",{id:m.getAttribute("data-node-id")}),b=document.createElement("template");b.innerHTML=y.data.dom,u=b.content.firstElementChild}if(m.getAttribute("data-type")==="NodeListItem"&&!r)if(d||(d=`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`),d=qs(m)+d,f===0||e[f-1].getAttribute("data-type")!=="NodeListItem"||e[f-1].getAttribute("data-subtype")!==m.getAttribute("data-subtype")){const y=document.createElement("template");y.innerHTML=`<div data-subtype="${m.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${d}`,u=y.content.firstElementChild,d=""}else continue;if(f===e.length-1&&(a=u),u.setAttribute("data-node-id",g),u.removeAttribute(p.CUSTOM_RIFF_DECKS),u.classList.remove("protyle-wysiwyg--hl"),u.setAttribute("updated",g.split("-")[0]),u.removeAttribute("refcount"),(n=u.lastElementChild.querySelector(".protyle-attr--refcount"))==null||n.remove(),u.querySelectorAll("[data-node-id]").forEach(y=>{var b;const w=Lute.NewNodeID();y.setAttribute("data-node-id",w),y.removeAttribute(p.CUSTOM_RIFF_DECKS),y.classList.remove("protyle-wysiwyg--hl"),y.setAttribute("updated",w.split("-")[0]),y.removeAttribute("refcount"),(b=y.lastElementChild.querySelector(".protyle-attr--refcount"))==null||b.remove()}),typeof o=="number"){const y=o+f+1;u.setAttribute("data-marker",y+"."),u.querySelector(".protyle-action--order").textContent=y+"."}if(l.after(un(u)),s.push({action:"insert",data:u.outerHTML,id:g,previousID:l.getAttribute("data-node-id")}),i.push({action:"delete",id:g}),m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"){c.push({oldId:m.getAttribute("data-node-id"),newId:g});const y=yield he("/api/block/getHeadingChildrenDOM",{id:m.getAttribute("data-node-id")}),b=document.createElement("template");b.innerHTML=y.data,Array.from(b.content.children).reverse().forEach((w,h)=>{if(h===b.content.children.length-1)return;w.querySelectorAll("[data-node-id]").forEach($=>{$.setAttribute("data-node-id",Lute.NewNodeID()),$.removeAttribute(p.CUSTOM_RIFF_DECKS),$.removeAttribute("refcount")});const S=Lute.NewNodeID();w.setAttribute("data-node-id",S),w.removeAttribute(p.CUSTOM_RIFF_DECKS),w.removeAttribute("refcount"),s.push({context:{ignoreProcess:"true"},action:"insert",data:w.outerHTML,id:S,previousID:g}),i.push({action:"delete",id:S})})}}if(t.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(f=>{f.remove()}),typeof o=="number"){let f=a.nextElementSibling;for(o=o+e.length;f&&f.getAttribute("data-subtype")==="o";){o++;const m=f.getAttribute("data-node-id");i.push({action:"update",id:m,data:f.outerHTML}),f.setAttribute("data-marker",o+"."),f.querySelector(".protyle-action--order").textContent=o+".",s.push({action:"update",data:f.outerHTML,id:m}),f=f.nextElementSibling}}B(t,s,i),te(a),Oe(t)}),kg=e=>{e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.options.backlinkData?(te(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):L("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{rt({data:t,protyle:e,action:[p.CB_GET_FOCUS]})})},Sg=e=>{!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?L("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{rt({data:t,protyle:e,action:[p.CB_GET_FOCUS],afterCB(){te(e.wysiwyg.element.lastElementChild,void 0,!1)}})}):(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,te(e.wysiwyg.element.lastElementChild,void 0,!1))},Fd=(e,t,n,a,s)=>{t.setAttribute("updated",G().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.style.minWidth="calc(100% - 0.1em)"}),Q(e,a,t.outerHTML,s)},Yd=(e,t,n,a,s)=>{t.setAttribute("updated",G().format("YYYYMMDDHHmmss")),n.forEach(i=>{i.removeAttribute("style")}),Q(e,a,t.outerHTML,s)},Ra=e=>{if(!e)return"";const t=_e().extname(e).toLowerCase();return p.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:p.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:p.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e},iy=()=>{},Wd=(e,t,n,a)=>{let s="";if(p.SIYUAN_ASSETS_AUDIO.includes(e))s=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${G().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${t}"></audio>${p.ZWSP}</div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;else if(p.SIYUAN_ASSETS_IMAGE.includes(e)){let i="";t.startsWith("assets/")||(i='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),s=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${t}" data-src="${t}" alt="${n}" /><span class="protyle-action__drag"></span>${i}<span class="protyle-action__title"></span></span><span> </span></span>`}else p.SIYUAN_ASSETS_VIDEO.includes(e)?s=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${G().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${p.ZWSP}<video controls="controls" src="${t}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`:s=`<span data-type="a" data-href="${t}">${a}</span>`;return s},nn=e=>{const t=document.getElementById("model");t.style.transform="translateY(0px)",t.style.zIndex=(++window.siyuan.zIndex).toString();const n=t.querySelector(".toolbar__icon");e.icon?(n.classList.remove("fn__none"),n.querySelector("use").setAttribute("xlink:href","#"+e.icon)):n.classList.add("fn__none"),t.querySelector(".toolbar__text").innerHTML=e.title;const a=t.querySelector("#modelMain");a.innerHTML=e.html,e.bindEvent(a)};var Ag=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Lg=(e,t)=>{const n=new ke({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${e.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${e.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${e.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${e.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${e.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${e.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${e.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${e.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${e.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${e.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${e.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${e.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${e.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${e.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${e.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${e.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${e.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",p.DIALOG_SEARCHTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{e.types[s.getAttribute("data-type")]=s.checked}),t(),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},e),Te(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),n.destroy()})},xg=e=>{let t="";Object.keys(p.SIYUAN_DEFAULT_REPLACETYPES).forEach(s=>{t+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[s]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${s}" type="checkbox"${e.replaceTypes[s]?" checked":""}>
</label>`});const n=new ke({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${t}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",p.DIALOG_REPLACETYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{e.replaceTypes[s.getAttribute("data-type")]=s.checked}),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},e),Te(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),n.destroy()})},sy=(e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_SEARCH_METHOD){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",Constants.MENU_SEARCH_METHOD),window.siyuan.menus.menu.append(new MenuItem({icon:"iconExact",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconQuote",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconDatabase",label:"SQL",current:e.method===2,click(){e.method=2,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconRegex",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,t()}}).element)},js=(e,t,n,a,s)=>{e.removed=!1;const i=e;i.name=a,t.push(Object.assign({},i)),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},e),Te(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),L("/api/storage/setCriterion",{criterion:i},()=>{var o;s.destroy();const l=n.querySelector("#criteria").firstElementChild;l.classList.remove("fn__none"),(o=l.querySelector(".b3-chip--current"))==null||o.classList.remove("b3-chip--current"),l.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer">${i.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},Cg=(e,t,n)=>{const a=new ke({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});a.element.setAttribute("data-key",p.DIALOG_SAVECRITERION);const s=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{s[1].dispatchEvent(new CustomEvent("click"))}),s[0].addEventListener("click",()=>{a.destroy()}),s[1].addEventListener("click",()=>{const i=a.element.querySelector("input"),o=i.value.trim();if(!o){se(window.siyuan.languages._kernel[142]);return}P()?(e.k=document.querySelector("#toolbarSearch").value,e.r=n.querySelector("#toolbarReplace").value):(e.k=n.querySelector("#searchInput").value,e.r=n.querySelector("#replaceInput").value);const l=n.querySelector("#criteria").firstElementChild;let r="",d="";if(t.forEach(c=>{c.name===o&&(r=c.name),Vd(c,e)&&(d=c.name)}),i.blur(),r&&!d)Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(c=>{c.textContent===o&&c.remove()}),t.find((c,f)=>{if(c.name===o)return t.splice(f,1),!0}),js(e,t,n,o,a)});else if(r&&d)if(r===d)a.destroy();else{const c=r===o?d:r;Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",o),()=>{Array.from(l.children).forEach(f=>{(f.textContent===d||f.textContent===r)&&f.remove()}),t.find((f,m)=>{if(f.name===c||f.name===r)return L("/api/storage/removeCriterion",{name:c}),t.splice(m,1),!0}),js(e,t,n,o,a)})}else!r&&d?Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",d).replace("${y}",o),()=>{Array.from(l.children).forEach(c=>{c.textContent===d&&c.remove()}),t.find((c,f)=>{if(c.name===d)return L("/api/storage/removeCriterion",{name:d}),t.splice(f,1),!0}),js(e,t,n,o,a)}):js(e,t,n,o,a)})},Tg=(e,t,n,a,s,i)=>Ag(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_MORE),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.listInvalidRefBlocks,click(){Wg()}}).element),window.siyuan.menus.menu.append(new H({type:"separator"}).element),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.searchType,click(){Lg(e,()=>{xt(e,n,!0)})}}).element),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.replaceType,click(){xg(e)}}).element),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,e.page=1,xt(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,e.page=1,xt(e,n,!0)}},{iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,e.page=1,xt(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,e.page=1,xt(e,n,!0)}}]}).element);const o=[{iconHTML:"",label:window.siyuan.languages.type,current:e.sort===0,click(){e.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:e.sort===1,click(){e.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:e.sort===2,click(){e.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:e.sort===3,click(){e.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:e.sort===4,click(){e.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:e.sort===6,click(){e.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:e.sort===7,click(){e.sort=7,a()}}];e.group===1&&o.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:e.sort===5,click(){e.sort=5,a()}}),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:e.group===0,click(){P()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),e.group=0,e.sort===5&&(e.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:e.group===1,click(){P()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),e.group=1,a()}}]}).element),i&&i(),window.siyuan.menus.menu.append(new H({type:"separator"}).element),window.siyuan.menus.menu.append(new H({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){Cg(e,t,n)}}).element),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){s()}}).element)}),Vd=(e,t)=>!!(t.group===e.group&&t.hPath===e.hPath&&t.hasReplace===e.hasReplace&&t.k===e.k&&t.method===e.method&&t.r===e.r&&t.sort===e.sort&&Ht(t.types,e.types)&&Ht(t.replaceTypes,e.replaceTypes)&&Ht(t.idPath,e.idPath)),Ig=(e,t,n)=>{L("/api/storage/getCriteria",{},a=>{let s="";a.data.forEach(i=>{t.push(i);let o=!1;Vd(i,n)&&(o=!0),s+=`<div data-type="set-criteria" class="${o?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer">${pe(i.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),e.innerHTML=`<div class="b3-chips${s?"":" fn__none"}">
    ${s}
</div>`})},$g=e=>{const t=[];return e.querySelectorAll(".b3-list-item__text mark").forEach(n=>{t.push(n.textContent)}),t.length===0&&e.querySelectorAll(".b3-list-item__meta mark").forEach(n=>{t.push(n.textContent)}),[...new Set(t)].join(" ")},Dg=e=>{let t="",n="";return window.siyuan.mobile.editor&&document.getElementById("empty").classList.contains("fn__none")&&(t=window.siyuan.mobile.editor.protyle.notebookId,e?n=window.siyuan.mobile.editor.protyle.path:n=_e().dirname(window.siyuan.mobile.editor.protyle.path)),t||window.siyuan.notebooks.find(a=>{if(!a.closed)return t=a.id,n="/",!0}),{notebookId:t,currentPath:n}},ga=e=>{if(Ms()===0){se(window.siyuan.languages.newFileTip);return}if(!e.notebookId){const t=Dg(e.useSavePath);e.notebookId=t.notebookId,e.currentPath=t.currentPath}L("/api/filetree/getDocCreateSavePath",{notebook:e.notebookId},t=>{if(e.useSavePath||(t.data.box=e.notebookId),t.data.path.indexOf("/")>-1&&e.useSavePath||e.name)if(t.data.path.startsWith("/")||e.currentPath==="/"){const n=_e().join(t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));L("/api/filetree/createDocWithMd",{notebook:t.data.box,path:n,markdown:"",listDocTree:e.listDocTree},a=>{e.afterCB&&e.afterCB(a.data,_e().basename(n)),ft(e.app,a.data,[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW])})}else L("/api/filetree/getHPathByPath",{notebook:t.data.box,path:e.notebookId===t.data.box?e.currentPath.endsWith(".sy")?e.currentPath:e.currentPath+".sy":t.data.path||"/"},n=>{const a=_e().join(n.data,t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));L("/api/filetree/createDocWithMd",{notebook:t.data.box,path:a,parentID:vt(e.currentPath,!0,!0),markdown:"",listDocTree:e.listDocTree},s=>{e.afterCB&&e.afterCB(s.data,_e().basename(a)),ft(e.app,s.data,[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW])})});else{const n=_e().basename(t.data.path||window.siyuan.languages.untitled);if(!Zi(n))return;if(e.notebookId!==t.data.box){const i=_e().join(t.data.path||"/",e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));L("/api/filetree/createDocWithMd",{notebook:t.data.box,path:i,markdown:"",listDocTree:e.listDocTree},o=>{e.afterCB&&e.afterCB(o.data,_e().basename(i)),ft(e.app,o.data,[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW])});return}const a=Lute.NewNodeID(),s=_e().join(vt(e.currentPath,!1,!0),a+".sy");e.paths&&(e.paths[e.paths.indexOf(void 0)]=s),L("/api/filetree/createDoc",{notebook:t.data.box,path:s,title:n,md:"",sorts:e.paths,listDocTree:e.listDocTree},()=>{e.afterCB&&e.afterCB(a,n),ft(e.app,a,[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW])})}})},uo=(e,t,n)=>{L("/api/filetree/getRefCreateSavePath",{notebook:t},a=>{let s=e;t!==a.data.box&&(s=a.data.path||"/"),a.data.path?a.data.path.startsWith("/")?n(vt(a.data.path,!1,!0),a.data.box):L("/api/filetree/getHPathByPath",{notebook:a.data.box,path:s},i=>{n(vt(_e().join(i.data,a.data.path),!1,!0),a.data.box)}):L("/api/filetree/getHPathByPath",{notebook:a.data.box,path:s},i=>{n(vt(i.data,!1,!0),a.data.box)})})},jd=(e,t)=>{ae(["dialog"]),ga({app:e,useSavePath:!0,name:gn(t.trim())||window.siyuan.languages.untitled})},Gd=(e,t,n,a,s)=>{const i=gn(t.trim()?t.trim():e.lute.BlockDOM2Content(n.outerHTML).replace(/\n/g,"").trim())||window.siyuan.languages.untitled,o=_e().join(a,i);L("/api/filetree/getIDsByHPath",{path:o,notebook:s},l=>{const r=i.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen);if(l.data&&l.data.length>0){const d=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${l.data[0]}${p.ZWSP}d${p.ZWSP}${r}`});d[0]&&e.toolbar.range.selectNodeContents(d[0])}else L("/api/filetree/createDocWithMd",{notebook:s,path:o,parentID:e.notebookId===s?e.block.rootID:"",markdown:""},d=>{const c=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${d.data}${p.ZWSP}d${p.ZWSP}${r}`});c[0]&&e.toolbar.range.selectNodeContents(c[0])});ae(["toolbar"],e)})},ly=(e,t)=>{};let zd;const Bn=(e,t,n=1)=>{const a=e.parentElement.querySelector(".fn__loading--top");a.classList.remove("fn__none"),clearTimeout(zd),zd=window.setTimeout(()=>{t||(t=window.siyuan.storage[p.LOCAL_SEARCHASSET]);const s=e.querySelector('[data-type="assetPrevious"]');n>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");const i=e.querySelector("#searchAssetInput");L("/api/search/fullTextSearchAssetContent",{page:n,query:i.value,types:t.types,method:t.method,orderBy:t.sort},o=>{var l,r;a.classList.add("fn__none");const d=e.querySelector('[data-type="assetNext"]');n<o.data.pageCount?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled");let c="";o.data.assetContents.forEach((m,u)=>{c+=`<div data-type="search-item" class="b3-list-item${u===0?" b3-list-item--focus":""}" data-id="${m.id}">
<span class="ft__on-surface">${m.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${m.content}</span>
<span class="b3-list-item__meta">${m.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Wt(m.path)}">${m.name}</span>
</div>`});const f=e.querySelector("#searchAssetPreview");o.data.assetContents.length>0?(f.classList.remove("fn__none"),(l=e.querySelector(".search__drag"))==null||l.classList.remove("fn__none"),Kd(f,o.data.assetContents[0].id,i.value,t.method)):(f.classList.add("fn__none"),(r=e.querySelector(".search__drag"))==null||r.classList.add("fn__none")),e.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${o.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${o.data.matchedAssetCount}</span>`,e.querySelector("#searchAssetList").innerHTML=c||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},p.TIMEOUT_INPUT)},Kd=(e,t,n,a)=>{L("/api/search/getAssetContent",{id:t,query:n,queryMethod:a},s=>{e.innerHTML=`<p style="white-space: pre-wrap;">${s.data.assetContent.content}</p>`;const i=e.querySelector("mark");if(i){i.classList.add("mark--hl");const o=e.getBoundingClientRect();e.scrollTop=e.scrollTop+i.getBoundingClientRect().top-o.top-o.height/2}})},Mg=e=>{let t;const n=Array.from(e.querySelectorAll("mark"));if(n.find((a,s)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),t=n[s+1];return}}),t||(t=n[0]),t){t.classList.add("mark--hl");const a=e.getBoundingClientRect();e.scrollTop=e.scrollTop+t.getBoundingClientRect().top-a.top-a.height/2}},Hg=(e,t)=>{const n=window.siyuan.storage[p.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_ASSET_METHOD){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_ASSET_METHOD),window.siyuan.menus.menu.append(new H({icon:"iconExact",label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].method=0,t()}}).element),window.siyuan.menus.menu.append(new H({icon:"iconQuote",label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].method=1,t()}}).element),window.siyuan.menus.menu.append(new H({icon:"iconRegex",label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].method=3,t()}}).element),window.siyuan.menus.menu.fullscreen()},Ng=e=>{let t="";return p.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{t+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${e[n]?" checked":""}>
    </label>`}),t},Pg=e=>{const t=window.siyuan.storage[p.LOCAL_SEARCHASSET].types,n=new ke({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${Ng(t)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});n.element.setAttribute("data-key",p.DIALOG_SEARCHASSETSTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(s=>{t[s.getAttribute("data-type")]=s.checked}),Bn(e),Te(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET]),n.destroy()})},Og=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_SEARCH_ASSET_MORE){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_SEARCH_ASSET_MORE);const a=window.siyuan.storage[p.LOCAL_SEARCHASSET],s=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:s}).element),window.siyuan.menus.menu.append(new H({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),L("/api/asset/fullReindexAssetContent",{},()=>{Bn(t,a)})}}).element),window.siyuan.menus.menu.fullscreen()},fo=(e,t,n)=>{e.value===""?(t.classList.add("fn__none"),typeof n=="number"&&(e.style.paddingRight=e.dataset.oldPaddingRight)):(t.classList.remove("fn__none"),typeof n=="number"&&e.style.setProperty("padding-right",`${n*2+t.clientWidth}px`,"important"))},es=e=>{e.inputElement.dataset.oldPaddingRight=e.inputElement.style.paddingRight,e.inputElement.insertAdjacentHTML("afterend",`<svg class="${e.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${e.right?"right: "+e.right+"px;":""}${e.height?"height:"+e.height+"px;":""}${e.width?"width:"+e.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const t=e.inputElement.nextElementSibling;t.addEventListener("click",()=>{e.inputElement.value="",e.inputElement.focus(),fo(e.inputElement,t,e.right),e.clearCB&&e.clearCB()}),e.inputElement.addEventListener("input",()=>{fo(e.inputElement,t,e.right)}),fo(e.inputElement,t,e.right)},Zd=()=>({audioBlock:window.siyuan.config.search.audioBlock,videoBlock:window.siyuan.config.search.videoBlock,iframeBlock:window.siyuan.config.search.iframeBlock,widgetBlock:window.siyuan.config.search.widgetBlock,document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}),qg=e=>{const t=window.siyuan.storage[p.LOCAL_SEARCHKEYS];if(!t.replaceKeys||t.replaceKeys.length===0||t.length===1&&t[0]===e.value)return;const n=new Fe(p.MENU_SEARCH_REPLACE_HISTORY);if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_SEARCHKEYS].replaceKeys=[],Te(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])}});const a=n.addSeparator(1);let s=!0;t.replaceKeys.forEach(o=>{if(o!==e.value&&o){const l=n.addItem({iconHTML:"",label:pe(o),action:"iconCloseRound",bind(r){r.addEventListener("click",d=>{var c;C(d.target,"b3-menu__action")?(t.replaceKeys.find((f,m)=>{if(f===o)return t.replaceKeys.splice(m,1),!0}),window.siyuan.storage[p.LOCAL_SEARCHKEYS].replaceKeys=t.replaceKeys,Te(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS]),(c=r.previousElementSibling)!=null&&c.classList.contains("b3-menu__separator")&&!r.nextElementSibling?window.siyuan.menus.menu.remove():r.remove()):(e.value=r.textContent,window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});s&&l.classList.add("b3-menu__item--current"),s=!1}}),s&&a.remove();const i=e.previousElementSibling.getBoundingClientRect();n.open({x:i.left,y:i.bottom})},Rg=(e,t,n)=>{const a=e.querySelector("#searchInput, #toolbarSearch"),s=window.siyuan.storage[p.LOCAL_SEARCHKEYS];if(!s.keys||s.keys.length===0||s.length===1&&s[0]===a.value)return;const i=new Fe(p.MENU_SEARCH_HISTORY);if(i.isOpen)return;i.element.classList.add("b3-menu--list"),i.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_SEARCHKEYS].keys=[],Te(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])}});const o=i.addSeparator(1);let l=!0;s.keys.forEach(d=>{if(d!==a.value&&d){const c=i.addItem({iconHTML:"",label:pe(d),action:"iconCloseRound",bind(f){f.addEventListener("click",m=>{var u;C(m.target,"b3-menu__action")?(s.keys.find((g,y)=>{if(g===d)return s.keys.splice(y,1),!0}),window.siyuan.storage[p.LOCAL_SEARCHKEYS].keys=s.keys,Te(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS]),(u=f.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!f.nextElementSibling?window.siyuan.menus.menu.remove():f.remove()):(a.value=f.textContent,t.page=1,xt(t,e,!0),window.siyuan.menus.menu.remove()),m.preventDefault(),m.stopPropagation()})}});l&&c.classList.add("b3-menu__item--current"),l=!1}}),l&&o.remove();const r=a.previousElementSibling.getBoundingClientRect();i.open({x:r.left,y:r.bottom})},Bg=e=>{const t=e.querySelector("#searchAssetInput"),n=window.siyuan.storage[p.LOCAL_SEARCHASSET].keys;if(!n||n.length===0||n.length===1&&n[0]===t.value)return;const a=new Fe(p.MENU_SEARCH_ASSET_HISTORY);if(a.isOpen)return;a.element.classList.add("b3-menu--list"),a.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.LOCAL_SEARCHASSET].keys=[],Te(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])}});const s=a.addSeparator(1);let i=!0;n.forEach(l=>{if(l!==t.value&&l){const r=a.addItem({iconHTML:"",label:pe(l),action:"iconCloseRound",bind(d){d.addEventListener("click",c=>{var f;C(c.target,"b3-menu__action")?(n.find((m,u)=>{if(m===l)return n.splice(u,1),!0}),window.siyuan.storage[p.LOCAL_SEARCHASSET].keys=n,Te(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET]),(f=d.previousElementSibling)!=null&&f.classList.contains("b3-menu__separator")&&!d.nextElementSibling?window.siyuan.menus.menu.remove():d.remove()):(t.value=d.textContent,Bn(e),window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});i&&r.classList.add("b3-menu__item--current"),i=!1}}),i&&s.remove();const o=t.previousElementSibling.getBoundingClientRect();a.open({x:o.left,y:o.bottom})},Xd=(e,t)=>{let n=window.siyuan.storage[p.LOCAL_SEARCHKEYS][e];n.splice(0,0,t),n=Array.from(new Set(n)),n.length>window.siyuan.config.search.limit&&n.splice(window.siyuan.config.search.limit,n.length-window.siyuan.config.search.limit),window.siyuan.storage[p.LOCAL_SEARCHKEYS][e]=n,Te(p.LOCAL_SEARCHKEYS,window.siyuan.storage[p.LOCAL_SEARCHKEYS])},Ug=e=>{if(!e.value)return;let t=window.siyuan.storage[p.LOCAL_SEARCHASSET].keys;t.splice(0,0,e.value),t=Array.from(new Set(t)),t.length>window.siyuan.config.search.limit&&t.splice(window.siyuan.config.search.limit,t.length-window.siyuan.config.search.limit),window.siyuan.storage[p.LOCAL_SEARCHASSET].k=e.value,window.siyuan.storage[p.LOCAL_SEARCHASSET].keys=t,Te(p.LOCAL_SEARCHASSET,window.siyuan.storage[p.LOCAL_SEARCHASSET])},Jd=(e,t,n)=>{if(t.method===2){se(window.siyuan.languages._kernel[132]);return}const a=e.querySelector("#searchList"),s=e.querySelector("#toolbarReplace"),i=s.parentElement.querySelector(".fn__rotate");if(!i.classList.contains("fn__none"))return;Xd("replaceKeys",s.value);const o=a.querySelector(".b3-list-item--focus");if(!o)return;i.classList.remove("fn__none"),i.nextElementSibling.classList.add("fn__none");const l=o.getAttribute("data-node-id");L("/api/search/findReplace",{k:t.method===0||t.method===1?$g(o):document.querySelector("#toolbarSearch").value,r:s.value,ids:n?[]:[l],types:t.types,method:t.method,replaceTypes:t.replaceTypes,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},r=>{var d;if(i.classList.add("fn__none"),i.nextElementSibling.classList.remove("fn__none"),r.code===1){se(r.msg);return}if(n){xt(t,e,!1);return}la(window.siyuan.mobile.editor.protyle,!1);let c=o.getAttribute("data-node-id");if(o.nextElementSibling?c=o.nextElementSibling.getAttribute("data-node-id"):o.previousElementSibling&&(c=o.previousElementSibling.getAttribute("data-node-id")),t.group===1&&!c){const f=o.parentElement.nextElementSibling||((d=o.parentElement.previousElementSibling.previousElementSibling)==null?void 0:d.previousElementSibling);f&&(c=f.nextElementSibling.firstElementChild.getAttribute("data-node-id"))}xt(t,e,!1,{currentId:l,newId:c})})},go=(e,t,n)=>{n.hasReplace!==t.hasReplace&&(t.hasReplace?(e.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),e.querySelector(".toolbar").classList.remove("fn__none")):(e.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),e.querySelector(".toolbar").classList.add("fn__none")));const a=e.querySelector("#searchPath");t.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${pe(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==t.group&&(t.group===0?(e.querySelector('[data-type="expand"]').classList.add("fn__none"),e.querySelector('[data-type="contract"]').classList.add("fn__none")):(e.querySelector('[data-type="expand"]').classList.remove("fn__none"),e.querySelector('[data-type="contract"]').classList.remove("fn__none")));let s=!0,i=!1;t.idPath.forEach(l=>{l.endsWith(".sy")&&(s=!1),l.split("/").length>1&&(i=!0)});const o=e.querySelector('[data-type="include"]');s?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),i?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=t.k,e.querySelector("#toolbarReplace").value=t.r,Object.assign(n,t),window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},n),Te(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA]),xt(n,e),window.siyuan.menus.menu.remove()},Qd=(e,t,n,a)=>{const s=document.querySelector("#searchList");let i="",o,l;e.forEach(d=>{const c=en(d.box)+vt(d.hPath,!1);d.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${ge(Sf(d.box)||window.siyuan.storage[p.LOCAL_IMAGES].note,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${Cs(c)}</span>
</div><div>`,d.children.forEach(f=>{a&&(f.id===a.currentId&&(o=f),f.id===a.newId&&(l=f)),i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item" data-node-id="${f.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${Ln(f.type)}"></use></svg>
${ge(f.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${f.content}</span>
${f.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${f.tag.replace(/#/g,"")}</span>`:""}
</div>`}),i+="</div>"):(a&&(d.id===a.currentId&&(o=d),d.id===a.newId&&(l=d)),i+=`<div class="b3-list-item b3-list-item--two" data-type="search-item" data-node-id="${d.id}">
    <div class="b3-list-item__first">
        <svg class="b3-list-item__graphic"><use xlink:href="#${Ln(d.type)}"></use></svg>
        ${ge(d.ial.icon,"b3-list-item__graphic",!0)}
        <span class="b3-list-item__text">${d.content}</span>
    </div>
    <div class="fn__flex">
        ${d.tag?`<span class="b3-list-item__meta b3-list-item__meta--ellipsis">${d.tag.replace(/#/g,"")}</span><span class="fn__space"></span>`:""}
        <span class="b3-list-item__text b3-list-item__meta">${Cs(c)}</span>
    </div>
</div>`)}),s.innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,s.scrollTop=0;let r="";if(n){let d=window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount);n.data.docMode&&(d=window.siyuan.languages.matchDoc.replace("${x}",n.data.matchedRootCount)),r=`<span class="fn__flex-center">${d}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t.page}/${n.data.pageCount||1}</span>`}if(s.previousElementSibling.querySelector('[data-type="result"]').innerHTML=r,o||(o=l),!o&&e.length>0&&(e[0].children?o=e[0].children[0]:o=e[0]),o){const d=s.querySelector(`[data-node-id="${o.id}"]`);d&&(d.classList.add("b3-list-item--focus"),d.scrollIntoView())}};let ec=0;const xt=(e,t,n=!1,a)=>{clearTimeout(ec),ec=window.setTimeout(()=>{var s;n&&((s=t.querySelector("#criteria .b3-chip--current"))==null||s.classList.remove("b3-chip--current"));const i=t.querySelector(".fn__loading--top");i.classList.remove("fn__none");const o=t.querySelector('[data-type="previous"]'),l=t.querySelector('[data-type="next"]'),r=document.getElementById("toolbarSearch");e.query=r.value,e.query===""&&(!e.idPath||e.idPath.length===0)?L("/api/block/getRecentUpdatedBlocks",{},d=>{Qd(d.data,e,void 0,a),i.classList.add("fn__none"),o.setAttribute("disabled","true"),l.setAttribute("disabled","true")}):(e.page||(e.page=1),e.page>1?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),L("/api/search/fullTextSearchBlock",{query:e.query,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},d=>{Qd(d.data.blocks,e,d,a),i.classList.add("fn__none"),e.page<d.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled")}))},p.TIMEOUT_INPUT)},Fg=(e,t,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",c=>{c&&c.isComposing||(n.page=1,xt(n,t,!0))}),a.addEventListener("input",c=>{c&&c.isComposing||(n.page=1,xt(n,t,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[p.LOCAL_SEARCHDATA]=Object.assign({},n),Te(p.LOCAL_SEARCHDATA,window.siyuan.storage[p.LOCAL_SEARCHDATA])),Xd("keys",a.value)}),es({inputElement:a,className:"toolbar__icon",clearCB(){n.page=1,xt(n,t)}});const s=t.querySelector(".toolbar .toolbar__title");s.value=n.r||"",es({inputElement:s,className:"toolbar__icon"});const i=[];Ig(t.querySelector("#criteria"),i,n);const o=document.querySelector("#searchAssetsPanel"),l=document.querySelector("#searchUnRefPanel"),r=t.querySelector("#searchList"),d=window.siyuan.storage[p.LOCAL_SEARCHASSET];t.addEventListener("click",c=>{var f,m;let u=c.target;for(;u&&u!==t;){const g=u.getAttribute("data-type");if(g==="replaceHistory"){qg(u.nextElementSibling),c.stopPropagation(),c.preventDefault();break}else if(g==="assetHistory"){Bg(o),c.stopPropagation(),c.preventDefault();break}else if(g==="previous"){u.getAttribute("disabled")||(n.page--,xt(n,t)),c.stopPropagation(),c.preventDefault();break}else if(g==="next"){u.getAttribute("disabled")||(n.page++,xt(n,t)),c.stopPropagation(),c.preventDefault();break}else if(g==="set-criteria"){n.removed=!1,(f=u.parentElement.querySelector(".b3-chip--current"))==null||f.classList.remove("b3-chip--current"),u.classList.add("b3-chip--current"),i.find(y=>{if(y.name===u.innerText.trim())return go(t,y,n),!0}),c.stopPropagation(),c.preventDefault();break}else if(g==="remove-criteria"){const y=u.parentElement.innerText.trim();L("/api/storage/removeCriterion",{name:y}),i.find((b,w)=>{if(b.name===y)return i.splice(w,1),!0}),u.parentElement.classList.contains("b3-chip--current")&&go(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Zd(),replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},n),u.parentElement.parentElement.childElementCount===1&&u.parentElement.parentElement.classList.add("fn__none"),u.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(g==="remove-path"){n.idPath=[],n.hPath="",t.querySelector("#searchPath").classList.add("fn__none"),n.page=1,xt(n,t,!0);const y=t.querySelector('[data-type="include"]');y.classList.remove("toolbar__icon--active"),y.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(g==="expand"){Array.from(r.children).forEach(y=>{y.classList.contains("b3-list-item")&&(y.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),y.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(g==="contract"){Array.from(r.children).forEach(y=>{y.classList.contains("b3-list-item")&&(y.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),y.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(g==="currentPath"&&!u.hasAttribute("disabled")){const y=Ft().protyle;L("/api/filetree/getHPathsByPaths",{paths:[y.path]},b=>{n.idPath=[_e().join(y.notebookId,y.path)],n.hPath=b.data[0];const w=t.querySelector("#searchPath");w.classList.remove("fn__none"),w.innerHTML=`<div class="b3-chip b3-chip--middle">${pe(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const h=t.querySelector('[data-type="include"]');h.classList.remove("toolbar__icon--active"),h.removeAttribute("disabled"),n.page=1,xt(n,t,!0)}),c.stopPropagation(),c.preventDefault();break}else if(g==="path"){ca((y,b)=>{L("/api/filetree/getHPathsByPaths",{paths:y},w=>{n.idPath=[];const h=[];let S=!1;y.forEach((v,k)=>{v==="/"?(n.idPath.push(b[k]),h.push(en(b[k]))):(S=!0,n.idPath.push(_e().join(b[k],v.replace(".sy",""))))}),w.data&&h.push(...w.data),n.hPath=h.join(" ");const $=t.querySelector("#searchPath");$.classList.remove("fn__none"),$.innerHTML=`<div class="b3-chip b3-chip--middle">${pe(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const D=t.querySelector('[data-type="include"]');D.classList.add("toolbar__icon--active"),S?D.removeAttribute("disabled"):D.setAttribute("disabled","disabled"),n.page=1,xt(n,t,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(g==="include"&&!u.hasAttribute("disabled")){u.classList.toggle("toolbar__icon--active"),u.classList.contains("toolbar__icon--active")?n.idPath.forEach((y,b)=>{y.endsWith(".sy")&&(n.idPath[b]=y.replace(".sy",""))}):n.idPath.forEach((y,b)=>{!y.endsWith(".sy")&&y.split("/").length>1&&(n.idPath[b]=y+".sy")}),n.page=1,xt(n,t,!0),c.stopPropagation(),c.preventDefault();break}else if(g==="toggle-replace"){n.hasReplace=!n.hasReplace,s.parentElement.classList.toggle("fn__none"),u.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(g==="more"){Tg(n,i,t,()=>{n.page=1,xt(n,t,!0)},()=>{go(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:Zd(),replaceTypes:Object.assign({},p.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(g==="replace-all"){Jd(t,n,!0),c.stopPropagation(),c.preventDefault();break}else if(g==="refreshUnRef"){Gs(l),c.stopPropagation(),c.preventDefault();break}else if(g==="unRefPrevious"){if(!u.getAttribute("disabled")){let y=parseInt(l.querySelector("#searchUnRefResult").lastElementChild.textContent);y>1&&(y--,Gs(l,y))}c.stopPropagation(),c.preventDefault();break}else if(g==="unRefNext"){const y=l.querySelector("#searchUnRefResult").lastElementChild;let b=parseInt(y.textContent);b<parseInt(y.textContent.split("/")[1])&&(b++,Gs(l,b)),c.stopPropagation(),c.preventDefault();break}else if(g==="queryAsset"){Hg(u,()=>{Bn(o,d),Te(p.LOCAL_SEARCHASSET,d)}),c.stopPropagation(),c.preventDefault();break}else if(g==="filterAsset"){Pg(o),c.stopPropagation(),c.preventDefault();break}else if(g==="moreAsset"){Og(u,o,()=>{Bn(o),Te(p.LOCAL_SEARCHASSET,d)}),c.stopPropagation(),c.preventDefault();break}else if(g==="goAsset"){Yg(),c.stopPropagation(),c.preventDefault();break}else if(g==="goSearch"){o.classList.add("fn__none"),l.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(g==="assetPrevious"){u.getAttribute("disabled")||Bn(o,d,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(g==="assetNext"){u.getAttribute("disabled")||Bn(o,d,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(g==="replace"){Jd(t,n,!1),c.stopPropagation(),c.preventDefault();break}else if(u.classList.contains("b3-list-item__toggle")){u.parentElement.nextElementSibling.classList.toggle("fn__none"),u.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(u.classList.contains("b3-list-item")){if(u.getAttribute("data-type")==="search-new")jd(e,a.value);else if(u.getAttribute("data-type")==="search-item"){const y=u.getAttribute("data-node-id");y?((m=window.siyuan.mobile.editor)!=null&&m.protyle&&fn(window.siyuan.mobile.editor.protyle),Jn(y,b=>{ft(e,y,b?[p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL])}),nt()):u.classList.contains("b3-list-item--focus")?u.classList.contains("b3-list-item--focus")&&Mg(t.querySelector("#searchAssetPreview")):(t.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),u.classList.add("b3-list-item--focus"),Kd(t.querySelector("#searchAssetPreview"),u.dataset.id,t.querySelector("#searchAssetInput").value,window.siyuan.storage[p.LOCAL_SEARCHASSET].method))}else u.querySelector(".b3-list-item__toggle")&&(u.nextElementSibling.classList.toggle("fn__none"),u.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}u=u.parentElement}},!1)},Kt=(e,t)=>{var n;const a=JSON.parse(JSON.stringify(window.siyuan.storage[p.LOCAL_SEARCHDATA])),s=(((n=Ft())==null?void 0:n.protyle.toolbar.range)||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();s&&(a.k=s),t&&Object.keys(t).forEach(l=>{a[l]=t[l]}),mn();let i=!0,o=!1;a.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(o=!0)}),nn({title:`<div class="fn__flex">
    <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="history">
        <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
        <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block" autocomplete="off" autocorrect="off" spellcheck="false">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${a.hasReplace?"":" fn__none"}">
        <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="replaceHistory">
            <svg class="svg--mid"><use xlink:href="#iconReplace"></use></svg>
            <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${a.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${pe(a.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${a.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${o?"":"disabled"} data-type="include" class="toolbar__icon${i?" toolbar__icon--active":""}"><use xlink:href="#iconInclude"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
           <span data-menu="true" class="toolbar__icon toolbar__icon--history" data-type="assetHistory">
                <svg class="svg--mid"><use xlink:href="#iconSearch"></use></svg>
                <svg class="svg--smaller"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(l){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{jd(e,document.querySelector("#toolbarSearch").value)}),document.querySelector('.toolbar [data-type="history"]').addEventListener("click",()=>{Rg(document.querySelector("#model"),a,void 0)}),Fg(e,l.firstElementChild,a),xt(a,l)}})},Yg=()=>{const e=document.querySelector("#searchAssetsPanel");if(e.classList.remove("fn__none"),e.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[p.LOCAL_SEARCHASSET],a=e.querySelector("input");a.value=n.k,a.addEventListener("compositionend",s=>{s.isComposing||Bn(e,n)}),a.addEventListener("input",s=>{s.isComposing||Bn(e,n)}),a.addEventListener("blur",()=>{Ug(a)}),Bn(e,n),es({inputElement:a,className:"toolbar__icon",clearCB(){Bn(e,n)}})},Wg=()=>{window.siyuan.menus.menu.remove();const e=document.querySelector("#searchUnRefPanel");e.classList.remove("fn__none"),!e.querySelector("#searchUnRefList").innerHTML&&Gs(e)},Gs=(e,t=1)=>{const n=e.querySelector('[data-type="unRefPrevious"]');t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),L("/api/search/listInvalidBlockRefs",{page:t},a=>{e.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const s=e.querySelector('[data-type="unRefNext"]');t<a.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");let i="";a.data.blocks.forEach((o,l)=>{const r=en(o.box)+vt(o.hPath,!1);i+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${Ln(o.type)}"></use></svg>
    ${ge(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${Cs(r)}</span>
</div>`}),e.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t}/${a.data.pageCount||1}</span>`,e.querySelector("#searchUnRefList").innerHTML=i||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Ba=e=>{e.style.minWidth?e.style.width="":e.removeAttribute("style")};var Vg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const po=(e,t,n,a=[])=>{L("/api/search/searchAsset",{k:t,exts:a},s=>{let i="";s.data.forEach((d,c)=>{i+=`<div data-value="${d.path}" class="b3-list-item${c===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${d.hName}</div></div>`});const o=e.querySelector(".b3-list"),l=e.querySelector("#preview"),r=e.querySelector("input");o.innerHTML=i||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,s.data.length>0?l.innerHTML=Ra(s.data[0].path):l.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.fullscreen(),t||r.select()})},mo=(e,t,n,a)=>{const s=new Fe(p.MENU_BACKGROUND_ASSET);s.isOpen||s.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: ${P()?"80":"50"}vh">
<div class="fn__flex-column" style="${P()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${P()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(i){i.style.maxWidth="none";const o=i.querySelector(".b3-list"),l=i.querySelector("#preview");o.addEventListener("mouseover",d=>{const c=d.target,f=C(c,"b3-list-item");f&&(l.innerHTML=Ra(f.getAttribute("data-value")))});const r=i.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;const c=i.querySelector(".b3-list--empty");if(!c){const f=Vt(o,d);f&&(l.innerHTML=Ra(f.getAttribute("data-value")),d.stopPropagation())}if(d.key==="Enter"){if(c)n||(window.siyuan.menus.menu.remove(),X(e.toolbar.range));else{const f=i.querySelector(".b3-list-item--focus");n?n(f.getAttribute("data-value"),f.textContent):(cu(f.getAttribute("data-value"),e),window.siyuan.menus.menu.remove())}d.preventDefault(),d.stopPropagation()}else d.key==="Escape"&&(n||X(e.toolbar.range))}),r.addEventListener("input",d=>{d.isComposing||(d.stopPropagation(),po(i,r.value,t,a))}),r.addEventListener("compositionend",d=>{d.stopPropagation(),po(i,r.value,t,a)}),i.lastElementChild.addEventListener("click",d=>{const c=d.target;if(O(c,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),d.stopPropagation();return}if(O(c,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),d.stopPropagation();return}const u=C(c,"b3-list-item");if(u){d.stopPropagation();const g=u.getAttribute("data-value");n?n(g,u.textContent):(cu(g,e),window.siyuan.menus.menu.remove())}}),po(i,"",t,a)}})},bo=(e,t)=>{var n;const a=F(t);if(!a)return;ae(["util","toolbar","hint"],e);const s=a.getAttribute("data-node-id");let i=a.outerHTML;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_FILE_ANNOTATION_REF);let o;window.siyuan.menus.menu.append(new H({id:"idAndAnchor",iconHTML:"",type:"readonly",label:`<div>ID</div><textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${P()?"100%":"360px"}" class="b3-text-field" readonly>${t.getAttribute("data-id")||""}</textarea><div class="fn__hr"></div><div>${window.siyuan.languages.anchor}</div><textarea rows="1" style="margin:4px 0;width: ${P()?"100%":"360px"}" class="b3-text-field"></textarea>`,bind(r){r.style.maxWidth="none",o=r.querySelectorAll(".b3-text-field")[1],o.value=t.textContent;const d=()=>{o.value?t.innerHTML=Lute.EscapeHTMLStr(o.value):t.innerHTML="*"};o.addEventListener("input",c=>{c.isComposing||(d(),c.stopPropagation())}),o.addEventListener("compositionend",c=>{c.isComposing||(d(),c.stopPropagation())}),o.addEventListener("keydown",c=>{if(!c.isComposing){if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(Rn(c))return}})}}).element),window.siyuan.menus.menu.append(new H({type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:[{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Ql(t,"file-annotation-ref",e.toolbar.range),Q(e,s,a.outerHTML,i),i=a.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.textContent="*",a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,s,a.outerHTML,i),i=a.outerHTML}}]}).element),window.siyuan.menus.menu.append(new H({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,s,a.outerHTML,i),fe(a,e.toolbar.range),i=a.outerHTML}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&tn({plugins:e.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const l=ue(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),o.select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==i&&(a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,s,a.outerHTML,i));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!e.element.contains(r.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range))}},yo=(e,t)=>{var n;const a=F(t);if(!a)return;ae(["util","toolbar","hint"],e);const s=t.getAttribute("data-id"),i=a.getAttribute("data-node-id");let o=a.outerHTML;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_REF),e.disabled||(window.siyuan.menus.menu.append(new H({id:"anchor",iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const d=r.querySelector("input");d.value=t.getAttribute("data-subtype")==="d"?"":t.textContent,d.addEventListener("input",()=>{d.value?t.innerHTML=Lute.EscapeHTMLStr(d.value).trim()||s:L("/api/block/getRefText",{id:s},c=>{t.innerHTML=c.data}),t.setAttribute("data-subtype",d.value?"s":"d")}),d.addEventListener("keydown",c=>{if(!c.isComposing){if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(Rn(c))return}})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element)),!e.disabled){let r=[];t.getAttribute("data-subtype")==="s"?r.push({id:"turnToDynamic",iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),L("/api/block/getRefText",{id:s},d=>{t.innerHTML=d.data,a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),o=a.outerHTML}),X(e.toolbar.range)}}):r.push({id:"turnToStatic",iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),X(e.toolbar.range),o=a.outerHTML}}),r=r.concat([{id:"text",iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Ql(t,"block-ref",e.toolbar.range),Q(e,i,a.outerHTML,o),o=a.outerHTML}},{id:"*",iconHTML:"",label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),X(e.toolbar.range),o=a.outerHTML}},{id:"text*",iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),X(e.toolbar.range),o=a.outerHTML}},{id:"link",label:window.siyuan.languages.link,iconHTML:"",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),fe(a,e.toolbar.range),o=a.outerHTML}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&t.parentElement.tagName==="DIV"&&r.push({id:"blockEmbed",iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const d=`<div data-content="select * from blocks where id='${s}'" data-node-id="${i}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${G().format("YYYYMMDDHHmmss")}">${a.querySelector(".protyle-attr").outerHTML}</div>`;a.outerHTML=d,Q(e,i,d,o),xe(e,e.wysiwyg.element),o=a.outerHTML}}),r.push({id:"defBlock",iconHTML:"",label:window.siyuan.languages.defBlock,click(){L("/api/block/swapBlockRef",{refID:i,defID:s,includeChildren:!1})}}),r.push({id:"defBlockChildren",iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){L("/api/block/swapBlockRef",{refID:i,defID:s,includeChildren:!0})}}),window.siyuan.menus.menu.append(new H({id:"turnInto",label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:r}).element)}window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){He(e.lute.BlockDOM2StdMd(t.outerHTML).trim())}}).element),e.disabled||(window.siyuan.menus.menu.append(new H({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){He(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),fe(a,e.toolbar.range),o=a.outerHTML}}).element),window.siyuan.menus.menu.append(new H({id:"remove",label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o),fe(a,e.toolbar.range),o=a.outerHTML}}).element)),(n=e==null?void 0:e.app)!=null&&n.plugins&&tn({plugins:e.app.plugins,type:"open-menu-blockref",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const l=ue(e.element,"block__popover",!0);window.siyuan.menus.menu.data=t,window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),e.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==o&&(a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,a.outerHTML,o));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!e.element.contains(r.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range))})},jg=(e,t)=>{var n;const a=ye(t);window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_CONTEXT),e.toolbar.showContent(e,a,t),(n=e==null?void 0:e.app)!=null&&n.plugins&&tn({plugins:e.app.plugins,type:"open-menu-content",detail:{protyle:e,range:a,element:t},separatorPosition:"top"})},wo=(e,t)=>{if(e.block.showAll)Bt({protyle:e,id:e.block.parent2ID,focusId:t});else{const n=e.path.split("/");n.length>2&&ft(e.app,n[n.length-2],[p.CB_GET_FOCUS,p.CB_GET_SCROLL])}},Bt=e=>{var t,n;if(e.protyle.options.backlinkData)return;typeof e.isPushBack=="undefined"&&(e.isPushBack=!0),typeof e.reload=="undefined"&&(e.reload=!1);const a=C(e.protyle.element,"block__popover",!0);if(a){const i=a.querySelector('[data-type="pin"]');i&&a.getAttribute("data-pin")!=="true"&&(i.setAttribute("aria-label",window.siyuan.languages.unpin),i.querySelector("use").setAttribute("xlink:href","#iconUnpin"),a.setAttribute("data-pin","true"))}const s=(t=e.protyle.breadcrumb)==null?void 0:t.element.querySelector(".protyle-breadcrumb__item--active");if(!e.reload&&s&&s.getAttribute("data-node-id")===e.id){if(e.id===e.protyle.block.rootID)return;const i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId||e.id}"]`);if(i){te(i),i.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[p.LOCAL_DOCINFO]={id:e.id},Te(p.LOCAL_DOCINFO,window.siyuan.storage[p.LOCAL_DOCINFO]),e.isPushBack&&oo()),L("/api/filetree/getDoc",{id:e.id,size:e.id===e.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.SIZE_GET_MAX},i=>Vg(void 0,null,function*(){if(e.isPushBack?rt({data:i,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_HTML],afterCB:e.callback}):rt({data:i,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML,p.CB_GET_UNUNDO]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_UNUNDO,p.CB_GET_HTML],afterCB:e.callback}),e.focusId){let o=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId}"]`);if(!o){const l=yield he("/api/block/getUnfoldedParentID",{id:e.focusId});e.focusId=l.data.parentID,o=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.data.parentID}"]`)}if(o){let l=o;for(;l.getBoundingClientRect().height===0;)l=l.parentElement;l.classList.contains("protyle-wysiwyg")?l=o.previousElementSibling||o.nextElementSibling:l=At(l),te(l);const r=new ResizeObserver(()=>{Oe(e.protyle,o,"start")});r.observe(e.protyle.wysiwyg.element),setTimeout(()=>{r.disconnect()},1e3*3)}else if(e.focusId){if(e.id===e.protyle.block.rootID){L("/api/filetree/getDoc",{id:e.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{rt({data:l,protyle:e.protyle,action:e.isPushBack?[p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_UNUNDO]})});return}}else{L("/api/filetree/getDoc",{id:e.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{rt({data:l,protyle:e.protyle,action:e.isPushBack?[p.CB_GET_FOCUS]:[p.CB_GET_FOCUS,p.CB_GET_UNUNDO]})});return}}else e.id!==e.protyle.block.rootID&&(e.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{e.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))}))},_o=(e,t,n,a)=>{var s;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_IMG);const i=F(n);if(!i)return;ae(["util","toolbar","hint"],e);const o=i.getAttribute("data-node-id"),l=n.querySelector("img"),r=n.querySelector(".protyle-action__title span"),d=i.outerHTML;let c=l.getAttribute("src");if(c||(c=""),e.disabled||(window.siyuan.menus.menu.append(new H({id:"imageUrlAndTitleAndTooltipText",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea spellcheck="false" style="margin:4px 0;width: ${P()?"100%":"360px"}" rows="1" class="b3-text-field">${c}</textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="margin:4px 0;width: ${P()?"100%":"360px"}" rows="1" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="margin:4px 0;width: ${P()?"100%":"360px"}" rows="1" class="b3-text-field"></textarea>`,bind(g){g.style.maxWidth="none";const y=g.querySelectorAll("textarea");y[0].addEventListener("input",b=>{const w=b.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim();if(l.setAttribute("src",w),l.setAttribute("data-src",w),w.startsWith("assets/")){const h=n.querySelector(".img__net");h&&h.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),y[1].value=r.innerText,y[1].addEventListener("input",b=>{const w=b.target.value;l.setAttribute("title",w),r.innerText=w,jt(r)}),y[2].value=l.getAttribute("alt")||"",g.addEventListener("click",b=>{let w=b.target;for(;w;){if(w.dataset.action==="copy"){He(w.parentElement.nextElementSibling.value),se(window.siyuan.languages.copied);break}w=w.parentElement}})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let g=e.lute.BlockDOM2StdMd(n.outerHTML);g=g.replace(/%20/g," "),He(g)}}).element),e.disabled&&window.siyuan.menus.menu.append(new H({id:"copyImageURL",label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){He(l.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new H({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){Od(l.getAttribute("src"))}}).element),!e.disabled){window.siyuan.menus.menu.append(new H({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let w=e.lute.BlockDOM2StdMd(n.outerHTML);w=w.replace(/%20/g," "),He(w),n.outerHTML="<wbr>",i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d),fe(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d),fe(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element);const g=l.getAttribute("data-src");g.startsWith("assets/")&&window.siyuan.menus.menu.append(new H({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Bs(g)}}).element),window.siyuan.menus.menu.append(new H({id:"ocr",label:"OCR",submenu:[{id:"ocrResult",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(w){w.style.maxWidth="none",L("/api/asset/getImageOCRText",{path:l.getAttribute("src")},h=>{const S=w.querySelector("textarea");S.value=h.data.text,S.dataset.ocrText=h.data.text})}},{type:"separator"},{id:"reOCR",iconHTML:"",label:window.siyuan.languages.reOCR,click(){L("/api/asset/ocr",{path:l.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new H({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){Fd(e,i,[n],o,d)}}).element),window.siyuan.menus.menu.append(new H({id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){Yd(e,i,[n],o,d)}}).element);let y;window.siyuan.menus.menu.append(new H({id:"width",label:window.siyuan.languages.width,submenu:[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" style="margin: 4px 8px 4px 0" value="${l.parentElement.style.width.endsWith("px")?parseInt(l.parentElement.style.width):""}" type="number" placeholder="${window.siyuan.languages.width}"><span class="fn__flex-center">px</span></div>`,bind(w){const h=w.querySelector("input");h.addEventListener("input",()=>{y.value="0",y.parentElement.setAttribute("aria-label",h.value?h.value+"px":window.siyuan.languages.default),Ba(n),l.parentElement.style.width=h.value?h.value+"px":"",l.style.height=""}),h.addEventListener("blur",()=>{h.value!==l.parentElement.style.width.replace("px","")&&(i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d),window.siyuan.menus.menu.remove(),te(i))})}},Ua("25%",l,e,o,i,d),Ua("33%",l,e,o,i,d),Ua("50%",l,e,o,i,d),Ua("67%",l,e,o,i,d),Ua("75%",l,e,o,i,d),Ua("100%",l,e,o,i,d),{id:"separator_1",type:"separator"},{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${l.parentElement.style.width?l.parentElement.style.width.replace("vw","%").replace("calc(","").replace(" - 8px)",""):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l.parentElement.style.width.indexOf("%")>-1||l.parentElement.style.width.endsWith("vw")?parseInt(l.parentElement.style.width.replace("calc(","")):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind(w){y=w.querySelector("input"),y.addEventListener("input",()=>{Ba(n),l.parentElement.style.width=`calc(${y.value}% - 8px)`,l.style.height="",y.parentElement.setAttribute("aria-label",`${y.value}%`)}),y.addEventListener("change",()=>{i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d),window.siyuan.menus.menu.remove(),te(i)})}},{id:"separator_2",type:"separator"},Ua(window.siyuan.languages.default,l,e,o,i,d)]}).element);let b;window.siyuan.menus.menu.append(new H({id:"height",label:window.siyuan.languages.height,submenu:[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${l.style.height.endsWith("px")?parseInt(l.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind(w){const h=w.querySelector("input");h.addEventListener("input",()=>{b.value="0",b.parentElement.setAttribute("aria-label",h.value?h.value+"px":window.siyuan.languages.default),l.style.height=h.value?h.value+"px":"",Ba(n),l.parentElement.style.width=""}),h.addEventListener("blur",()=>{h.value!==l.style.height.replace("px","")&&(i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d),window.siyuan.menus.menu.remove(),te(i))})}},Fa("25%",l,e,o,i,d),Fa("33%",l,e,o,i,d),Fa("50%",l,e,o,i,d),Fa("67%",l,e,o,i,d),Fa("75%",l,e,o,i,d),Fa("100%",l,e,o,i,d),{id:"separator_1",type:"separator"},{id:"heightDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${l.style.height?l.style.height.replace("vh","%"):window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l.style.height.endsWith("vh")?parseInt(l.style.height):0}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind(w){b=w.querySelector("input"),b.addEventListener("input",()=>{Ba(n),l.parentElement.style.width="",l.style.height=b.value+"vh",b.parentElement.setAttribute("aria-label",`${b.value}%`)}),b.addEventListener("change",()=>{i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d),window.siyuan.menus.menu.remove(),te(i)})}},{id:"separator_2",type:"separator"},Fa(window.siyuan.languages.default,l,e,o,i,d)]}).element)}const f=l.getAttribute("src");f&&(window.siyuan.menus.menu.append(new H({id:"separator_3",type:"separator"}).element),Xi(e.app,f,!1,!1));const m=l.getAttribute("data-src");m&&m.startsWith("assets/")&&window.siyuan.menus.menu.append(new H(Ws(m)).element),(s=e==null?void 0:e.app)!=null&&s.plugins&&tn({plugins:e.app.plugins,type:"open-menu-image",detail:{protyle:e,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const u=ue(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",u?u.dataset.level+"popover":"app"),!e.disabled){const g=window.siyuan.menus.menu.element.querySelectorAll("textarea");g[0].value?g[1].select():g[0].select(),window.siyuan.menus.menu.removeCB=()=>{const y=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');y&&y.dataset.ocrText!==y.value&&L("/api/asset/setImageOCRText",{path:l.getAttribute("src"),text:y.value}),l.setAttribute("alt",g[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,o,i.outerHTML,d)}}},ri=(e,t,n=!1)=>{var a;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_A);const s=F(t);if(!s)return;xn(),ae(["util","toolbar","hint"],e);const i=s.getAttribute("data-node-id");let o=s.outerHTML;const l=t.getAttribute("data-href");let r;e.disabled||(window.siyuan.menus.menu.append(new H({id:"linkAndAnchorAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea spellcheck="false" rows="1" 
style="margin:4px 0;width: ${P()?"100%":"360px"}" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="width: ${P()?"100%":"360px"};margin: 4px 0;" rows="1" class="b3-text-field"></textarea><div class="fn__hr"></div><div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div><textarea style="width: ${P()?"100%":"360px"};margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(c){c.style.maxWidth="none",r=c.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(l)||"",r[0].addEventListener("keydown",m=>{if((m.key==="Enter"||m.key==="Escape")&&!m.isComposing)m.preventDefault(),m.stopPropagation(),window.siyuan.menus.menu.remove();else if(m.key==="Tab"&&!m.isComposing)m.preventDefault(),m.stopPropagation(),r[1].focus();else if(Rn(m))return});let f=t.textContent.replace(p.ZWSP,"");!f&&l&&(f=decodeURIComponent(l.replace("https://","").replace("http://","")),f.length>p.SIZE_LINK_TEXT_MAX&&(f=f.substring(0,p.SIZE_LINK_TEXT_MAX)+"..."),t.innerHTML=Lute.EscapeHTMLStr(f)),r[1].value=f,r[1].addEventListener("compositionend",()=>{t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()||"*")}),r[1].addEventListener("input",m=>{m.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim())||"*")}),r[1].addEventListener("keydown",m=>{if((m.key==="Enter"||m.key==="Escape")&&!m.isComposing)m.preventDefault(),m.stopPropagation(),window.siyuan.menus.menu.remove();else if(m.key==="Tab"&&!m.isComposing)m.preventDefault(),m.stopPropagation(),m.shiftKey?r[0].focus():r[2].focus();else if(Rn(m))return}),r[2].value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),r[2].addEventListener("keydown",m=>{if((m.key==="Enter"||m.key==="Escape")&&!m.isComposing)m.preventDefault(),m.stopPropagation(),window.siyuan.menus.menu.remove();else if(m.key==="Tab"&&m.shiftKey&&!m.isComposing)m.preventDefault(),m.stopPropagation(),r[1].focus();else if(Rn(m))return}),c.addEventListener("click",m=>{let u=m.target;for(;u;){if(u.dataset.action==="copy"){He(u.parentElement.nextElementSibling.value),se(window.siyuan.languages.copied);break}u=u.parentElement}})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const c=document.createRange();c.selectNode(t),X(c),document.execCommand("copy")}}).element),e.disabled&&window.siyuan.menus.menu.append(new H({id:"copyAHref",label:window.siyuan.languages.copyAHref,icon:"iconLink",click(){He(l)}}).element),e.disabled||(window.siyuan.menus.menu.append(new H({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const c=document.createRange();c.selectNode(t),X(c),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new H({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),s.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,s.outerHTML,o),fe(s,e.toolbar.range),o=s.outerHTML}}).element),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new H({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Bs(l)}}).element),l!=null&&l.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new H({id:"turnIntoRef",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){t.setAttribute("data-subtype","s");const c=t.getAttribute("data-type").split(" ");c.push("block-ref"),c.splice(c.indexOf("a"),1),t.setAttribute("data-type",c.join(" ")),t.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",t.removeAttribute("data-href"),t.removeAttribute("data-title"),s.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,s.outerHTML,o),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),X(e.toolbar.range),o=s.outerHTML}}).element),window.siyuan.menus.menu.append(new H({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",s.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Ql(t,"a",e.toolbar.range),Q(e,i,s.outerHTML,o),o=s.outerHTML}}).element)),l&&(window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),Xi(e.app,l,!1,!0),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new H(Ws(l)).element)),!e.disabled&&((a=e==null?void 0:e.app)!=null&&a.plugins)&&tn({plugins:e.app.plugins,type:"open-menu-link",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const d=ue(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",d?d.dataset.level+"popover":"app"),!e.disabled&&(n||e.lute.GetLinkDest(l)||l!=null&&l.startsWith("assets/")?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?t.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-title"),t.getAttribute("data-type").indexOf("a")>-1?t.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-href"),!r[1].value&&(r[0].value||r[2].value)&&(t.textContent="*");const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!e.element.contains(c.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range)),!r[1].value&&!r[0].value&&!r[2].value&&t.remove(),o!==s.outerHTML&&(s.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,i,s.outerHTML,o))})},ho=(e,t)=>{var n;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_TAG);const a=F(t);if(!a)return;ae(["util","toolbar","hint"],e);const s=a.getAttribute("data-node-id");let i=a.outerHTML;window.siyuan.menus.menu.append(new H({id:"tag",iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__block" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(l){const r=l.querySelector("input");r.value=t.textContent.replace(p.ZWSP,""),r.addEventListener("change",()=>{Q(e,s,a.outerHTML,i),i=a.outerHTML}),r.addEventListener("compositionend",()=>{t.innerHTML=p.ZWSP+Lute.EscapeHTMLStr(r.value||"")}),r.addEventListener("input",d=>{d.isComposing||(t.innerHTML=p.ZWSP+Lute.EscapeHTMLStr(r.value||""))}),r.addEventListener("keydown",d=>{if((d.key==="Enter"||d.key==="Escape")&&!d.isComposing){if(d.preventDefault(),d.stopPropagation(),r.value)e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),X(e.toolbar.range);else{const c=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,s,a.outerHTML,c),fe(a,e.toolbar.range)}window.siyuan.menus.menu.remove()}else if(Rn(d))return})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){Kt(e.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${t.textContent}#`,r:"",page:1})}}).element),window.siyuan.menus.menu.append(new H({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Mr(t.textContent.replace(p.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"turnIntoText",label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){e.toolbar.range.setStart(t.firstChild,0),e.toolbar.range.setEnd(t.lastChild,t.lastChild.textContent.length),e.toolbar.setInlineMark(e,"tag","range")}}).element),window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const l=document.createRange();l.selectNode(t),X(l),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new H({id:"cut",label:window.siyuan.languages.cut,icon:"iconCut",click(){const l=document.createRange();l.selectNode(t),X(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new H({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const l=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,s,a.outerHTML,l),fe(a,e.toolbar.range)}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&tn({plugins:e.app.plugins,type:"open-menu-tag",detail:{protyle:e,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.fullscreen();const o=ue(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},zs=(e,t)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_INLINE_MATH);const n=F(t);if(!n)return;const a=n.getAttribute("data-node-id"),s=n.outerHTML;window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){const o=document.createRange();o.selectNode(t),X(o),document.execCommand("copy")}}).element),e.disabled||(window.siyuan.menus.menu.append(new H({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,click(){const o=document.createRange();o.selectNode(t),X(o),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new H({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,a,n.outerHTML,s),fe(n,e.toolbar.range)}}).element));const i=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.left,y:i.top+26,h:26})},Ua=(e,t,n,a,s,i)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){s.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Ba(t.parentElement.parentElement),t.parentElement.style.width=e===window.siyuan.languages.default?"":`calc(${e} - 8px)`,t.style.height="",Q(n,a,s.outerHTML,i),te(s)}}),Fa=(e,t,n,a,s,i)=>({id:e===window.siyuan.languages.default?"default":"width_"+e,iconHTML:"",label:e,click(){s.setAttribute("updated",G().format("YYYYMMDDHHmmss")),t.style.height=e===window.siyuan.languages.default?"":parseInt(e)+"vh",Ba(t.parentElement.parentElement),t.parentElement.style.width="",Q(n,a,s.outerHTML,i),te(s)}}),Gg=(e,t)=>{const n=t.getAttribute("data-node-id"),a=t.querySelector("iframe");let s=t.outerHTML;const i=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(l){l.style.maxWidth="none",l.querySelector("textarea").addEventListener("change",r=>{const d=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim(),c=d.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(d.indexOf("bilibili.com")>-1&&(d.indexOf("bvid=")>-1||c&&c[1])){const f={bvid:bt("bvid",d)||c&&c[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(d.startsWith("http")?d:"https:"+d).search.split("&").forEach((g,y)=>{if(!g)return;y===0&&(g=g.substr(1));const b=g.split("=");f[b[0]]=b[1]});let m="https://player.bilibili.com/player.html?";const u=Object.keys(f);u.forEach((g,y)=>{m+=`${g}=${f[g]}`,y<u.length-1&&(m+="&")}),a.setAttribute("src",m),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",d);Q(e,n,t.outerHTML,s),s=t.outerHTML,r.stopPropagation()})}}],o=a.getAttribute("src");return o?(i.push({type:"separator"}),i.concat(Xi(e.app,o,!0,!1))):i},zg=(e,t,n)=>{const a=t.getAttribute("data-node-id"),s=t.querySelector(n==="NodeVideo"?"video":"audio");let i=t.outerHTML;const o=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.link}">${s.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",d=>{s.setAttribute("src",d.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"").trim()),Q(e,a,t.outerHTML,i),i=t.outerHTML,d.stopPropagation()})}}],l=s.getAttribute("src");return l&&l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){Bs(l)}})),l&&o.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:Xi(e.app,l,!0,!1)}),l&&l.startsWith("assets/")&&o.push(Ws(l)),o},Kg=(e,t,n,a)=>{var s;const i=[],o=Qn(n);(n.rowSpan>1||n.colSpan>1)&&i.push({id:"cancelMerged",label:window.siyuan.languages.cancelMerged,click:()=>{const I=t.outerHTML;let T=n.rowSpan,q=n.parentElement;const z=n.colSpan;for(;T>0&&q;){let N=q.children[o],R=z;for(;R>0&&N;)N.classList.remove("fn__none"),N.colSpan=1,N.rowSpan=1,N=N.nextElementSibling,R--;q=q.nextElementSibling,T--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let N;if(Array.from(t.querySelectorAll("thead tr")).find(R=>{if(N=R,Array.from(R.children).forEach(V=>{(V.rowSpan!==1||V.classList.contains("fn__none"))&&(N=void 0)}),N)return!0}),N){const R=t.querySelector("tbody"),V=t.querySelector("thead");for(;N!==V.lastElementChild;)R.insertAdjacentElement("afterbegin",V.lastElementChild)}}X(a),Q(e,t.getAttribute("data-node-id"),t.outerHTML,I)}});const l=t.querySelectorAll("col")[o];(l.style.width||l.style.minWidth!=="60px")&&i.push({id:"useDefaultWidth",label:window.siyuan.languages.useDefaultWidth,click:()=>{const I=t.outerHTML;l.style.width="",l.style.minWidth="60px",Q(e,t.getAttribute("data-node-id"),t.outerHTML,I)}});const r=t.getAttribute("custom-pinthead");i.push({id:r?"unpinTableHead":"pinTableHead",icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const I=t.outerHTML;r?t.removeAttribute("custom-pinthead"):t.setAttribute("custom-pinthead","true"),Q(e,t.getAttribute("data-node-id"),t.outerHTML,I)}}),i.push({id:"separator_1",type:"separator"}),i.push({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{qn(e,[n],t,"left",a)}}),i.push({id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{qn(e,[n],t,"center",a)}}),i.push({id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{qn(e,[n],t,"right",a)}}),i.push({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{qn(e,[n],t,"",a)}});const d=[];d.push(...i),d.push({type:"separator"});const c=t.querySelector("table"),f=n.parentElement.querySelector(".fn__none");let m=!1,u=!1;Array.from(n.parentElement.children).forEach(I=>{I.colSpan>1&&(m=!0),I.rowSpan>1&&(u=!0)});let g=!1,y=!1,b=!1,w=n.parentElement.previousElementSibling;!w&&n.parentElement.parentElement.tagName==="TBODY"&&(w=c.querySelector("thead").lastElementChild),w&&(g=w.querySelector(".fn__none"),Array.from(w.children).forEach(I=>{I.colSpan>1&&(y=!0),I.rowSpan>1&&(b=!0)}));let h=!1,S=!1,$=!1,D=n.parentElement.nextElementSibling;!D&&n.parentElement.parentElement.tagName==="THEAD"&&(D=(s=c.querySelector("tbody"))==null?void 0:s.firstElementChild),D&&(h=D.querySelector(".fn__none"),Array.from(D.children).forEach(I=>{I.colSpan>1&&(S=!0),I.rowSpan>1&&($=!0)}));let v=!0;Array.from(c.rows).find(I=>{const T=I.cells[o];if(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1)return v=!1,!0});let k=!0;Array.from(c.rows).find(I=>{const T=I.cells[o+1];if(T&&(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1))return k=!1,!0});let _=!0;Array.from(c.rows).find(I=>{const T=I.cells[o-1];if(T&&(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1))return _=!1,!0});const E=[];E.push({id:"insertRowAbove",icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{cd(e,a,n,t)}}),(!h||h&&!$&&S)&&E.push({id:"insertRowBelow",icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{Xl(e,a,n,t)}}),(v||_)&&E.push({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{Os(e,t,n,"beforebegin",a)}}),(v||k)&&E.push({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{Os(e,t,n,"afterend",a)}}),d.push(...E);const A=[];((!f||f&&!u&&m)&&(!g||g&&!b&&y)||(!f||f&&!u&&m)&&(!h||h&&!$&&S)||v&&_||v&&k)&&A.push({id:"separator_2",type:"separator"}),(!f||f&&!u&&m)&&(!g||g&&!b&&y)&&A.push({id:"moveToUp",icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{gd(e,a,n,t)}}),(!f||f&&!u&&m)&&(!h||h&&!$&&S)&&A.push({id:"moveToDown",icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{pd(e,a,n,t)}}),v&&_&&A.push({id:"moveToLeft",icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{md(e,a,n,t)}}),v&&k&&A.push({id:"moveToRight",icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{bd(e,a,n,t)}}),d.push(...A),(n.parentElement.parentElement.tagName!=="THEAD"&&(!f&&!u||f&&!u&&m)||v)&&d.push({type:"separator"});const x=[];return n.parentElement.parentElement.tagName!=="THEAD"&&(!f&&!u||f&&!u&&m)&&x.push({id:"deleteRow",icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{ud(e,a,n,t)}}),v&&x.push({id:"deleteColumn",icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{fd(e,a,t,n)}}),d.push(...x),{menus:d,removeMenus:x,insertMenus:E,otherMenus:i,other2Menus:A}},Zg=(e,t)=>{Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(n=>{if(!de(n)){const a=at(t,n,!0,!1,!0,!0);return a.doOperations[0].context={focusId:e.currentNodeID},B(t,a.doOperations,a.undoOperations),!0}})},at=(e,t,n,a,s=!0,i=!1)=>{if(t.getAttribute("data-type")==="NodeListItem"&&t.childElementCount<4)return{fold:-1};if(t.getAttribute("data-type")==="NodeThematicBreak")return{fold:-1};const o=t.getAttribute("fold")==="1";if(o){if(typeof n=="boolean"&&!n)return{fold:-1};t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber__rows").forEach(c=>{si(c.parentElement)})}else{if(typeof n=="boolean"&&n)return{fold:-1};if(t.setAttribute("fold","1"),getSelection().rangeCount>0){const c=getSelection().getRangeAt(0),f=F(c.startContainer);f&&f.getBoundingClientRect().width===0&&te(t,void 0,!1)}Et(["img","av"],t),Oe(e,t)}const l=t.getAttribute("data-node-id"),r=[],d=[];return t.getAttribute("data-type")==="NodeHeading"?o?(s&&t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),r.push({action:"unfoldHeading",id:l,data:a?"remove":void 0}),d.push({action:"foldHeading",id:l})):(r.push({action:"foldHeading",id:l}),d.push({action:"unfoldHeading",id:l}),xd(t)):(r.push({action:"setAttrs",id:l,data:JSON.stringify({fold:o?"":"1"})}),d.push({action:"setAttrs",id:l,data:JSON.stringify({fold:o?"1":""})})),i||B(e,r,d),fn(e),{fold:o?0:1,undoOperations:d,doOperations:r}};var Xg=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const bn=(e,t,n,a)=>Xg(void 0,null,function*(){var s,i,o,l,r,d,c,f,m,u,g;(s=e.observerLoad)==null||s.disconnect(),fn(e);const y=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((y==null?void 0:y.length)>0){const x=[],I=[];let T,q=!1;a==="Backspace"?(T=y[0].previousElementSibling,T||(q=!0,T=y[y.length-1].nextElementSibling)):(T=y[y.length-1].nextElementSibling,q=!0,T||(q=!1,T=y[0].previousElementSibling));let z,N;ae(["select"],e);const R={};for(let V=0;V<y.length;V++){const j=y[V],W=Ve(j);N=W.parentElement;const Se=W.getAttribute("data-node-id");if(x.push({action:"delete",id:Se}),a==="Backspace"?(T=We(W),T||(q=!0,T=ht(W))):(T=ht(W),q=!0,T||(q=!1,T=We(W))),!T&&!e.options.backlinkData&&(T=W.parentElement||e.wysiwyg.element.firstElementChild,q=!1),W.getAttribute("data-type")==="NodeHeading"&&W.getAttribute("fold")==="1"){const ce=yield he("/api/block/getHeadingDeleteTransaction",{id:W.getAttribute("data-node-id")});x.push(...ce.data.doOperations.slice(1));const ve=W.previousElementSibling?W.previousElementSibling.getAttribute("data-node-id"):"";ce.data.undoOperations.forEach(($e,Ce)=>{$e.previousID=ve,Ce>0&&($e.context={ignoreProcess:"true"})}),I.push(...ce.data.undoOperations),W.firstElementChild.removeAttribute("contenteditable"),W.remove()}else{let ce=W.outerHTML;(W.classList.contains("render-node")||W.querySelector("div.render-node"))&&(ce=e.lute.SpinBlockDOM(W.outerHTML));let ve=W.previousElementSibling?W.previousElementSibling.getAttribute("data-node-id"):"";if(W.previousElementSibling&&W.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&W.previousElementSibling.getAttribute("fold")==="1"&&(((i=W.nextElementSibling)==null?void 0:i.getAttribute("data-type"))!=="NodeHeading"||((o=W.nextElementSibling)==null?void 0:o.getAttribute("data-type"))==="NodeHeading"&&((l=W.nextElementSibling)==null?void 0:l.getAttribute("data-subtype"))<W.getAttribute("data-subtype"))){const $e=W.previousElementSibling.getAttribute("data-node-id");if(!R[$e]){const Ce=yield he("/api/block/getHeadingDeleteTransaction",{id:$e});R[$e]={element:W.previousElementSibling,previousID:Ce.data.doOperations[Ce.data.doOperations.length-1].id}}ve=R[$e].previousID}I.push({action:"insert",data:ce,id:Se,previousID:ve,parentID:W.parentElement.getAttribute("data-node-id")||e.block.parentID}),W.getAttribute("data-subtype")==="o"&&W.classList.contains("li")?z=W.parentElement:z=void 0,W.remove()}}if(Object.keys(R).forEach(V=>{const j=at(e,R[V].element,!0,!1,!1,!0);x.push(...j.doOperations),I.splice(0,0,...j.undoOperations)}),T)if(e.block.showAll&&T.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0)setTimeout(()=>{Bt({protyle:e,id:e.block.parent2ID,focusId:e.block.parent2ID})},p.TIMEOUT_INPUT*2+100);else{if(T.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0){const V=Lute.NewNodeID(),j=yn(!1,!0,V);T.insertAdjacentElement("afterbegin",j),x.push({action:"insert",data:j.outerHTML,id:V,parentID:T.getAttribute("data-node-id")||e.block.parentID}),I.push({action:"delete",id:V}),T=void 0,fe(j,n)}a!=="Backspace"&&q?te(T):te(T,void 0,!1),Oe(e,T),z&&(I.push({action:"update",id:z.getAttribute("data-node-id"),data:z.outerHTML}),Qe(z,1),x.push({action:"update",id:z.getAttribute("data-node-id"),data:z.outerHTML}))}if(x.length>0)if(N&&N.getAttribute("data-type")==="NodeSuperBlock"&&N.childElementCount===2){const V=yield Ea(e,N,n);B(e,x.concat(V.doOperations),V.undoOperations.concat(I.reverse()))}else B(e,x,I.reverse());ae(["util"],e);return}const b=t.getAttribute("data-type");if(b==="NodeCodeBlock"&&oe(t).textContent.trim()===""){t.classList.add("protyle-wysiwyg--select"),bn(e,t,n,a);return}if(!t.previousElementSibling&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){a!=="Delete"&&n.insertNode(document.createElement("wbr"));const x=t.parentElement;x.insertAdjacentElement("beforebegin",t),x.childElementCount===1?(B(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(r=t.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:x.getAttribute("data-node-id")}],[{action:"insert",id:x.getAttribute("data-node-id"),data:x.outerHTML,previousID:(d=t.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:t.getAttribute("data-node-id"),parentID:x.getAttribute("data-node-id")}]),x.remove()):B(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(c=t.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:t.getAttribute("data-node-id"),parentID:x.getAttribute("data-node-id")}]),a==="Delete"?Ya(t,n,!0):fe(t,n);return}if(t.parentElement.classList.contains("li")&&t.getAttribute("data-type")!=="NodeHeading"&&t.previousElementSibling.classList.contains("protyle-action")){Jg(e,t,n,a==="Delete");return}const w=We(t);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(b)){if(w)if(w.classList.contains("p")&&oe(w).textContent===""){const x=We(w);B(e,[{action:"delete",id:w.getAttribute("data-node-id")}],[{action:"insert",data:w.outerHTML,id:w.getAttribute("data-node-id"),parentID:w.parentElement.getAttribute("data-node-id")||e.block.parentID,previousID:x&&(!w.previousElementSibling||!w.previousElementSibling.classList.contains("protyle-action"))?x.getAttribute("data-node-id"):void 0}]),w.remove()}else te(w,void 0,!1);return}if(b==="NodeHeading"){t.previousElementSibling&&t.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&t.previousElementSibling.getAttribute("fold")==="1"&&at(e,t.previousElementSibling,!0,!1,!1),t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&at(e,t,!0,!1,!1),kn({protyle:e,selectsElement:[t],type:"Blocks2Ps",range:Ya(t,n,a==="Delete")});return}if(t.previousElementSibling&&t.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!w){if(e.wysiwyg.element.childElementCount>1&&oe(t).textContent===""){te(e.wysiwyg.element.firstElementChild.nextElementSibling);const x=Ve(t);B(e,[{action:"delete",id:x.getAttribute("data-node-id")}],[{action:"insert",data:x.outerHTML,id:x.getAttribute("data-node-id"),parentID:e.block.parentID}]),x.remove()}return}const h=t.parentElement,S=oe(t),$=yt(w);if(n.toString()===""&&P()&&$&&$.classList.contains("hr")&&et(S).start===0){B(e,[{action:"delete",id:$.getAttribute("data-node-id")}],[{action:"insert",data:$.outerHTML,id:$.getAttribute("data-node-id"),previousID:(f=$.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:$.parentElement.getAttribute("data-node-id")}]),$.remove();return}const D=$&&($.classList.contains("table")||$.classList.contains("render-node")||$.classList.contains("iframe")||$.classList.contains("hr")||$.classList.contains("av")||$.classList.contains("code-block")),v=$.getAttribute("data-node-id");if(D){if($.classList.contains("code-block")){if(S.textContent.trim()===""){const x=t.getAttribute("data-node-id"),I=[{action:"delete",id:x}],T=[{action:"insert",data:t.outerHTML,id:x,previousID:(m=t.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")}];if(t.remove(),h.getAttribute("data-type")==="NodeSuperBlock"&&h.childElementCount===2){const q=yield Ea(e,h);B(e,I.concat(q.doOperations),q.undoOperations.concat(T))}else B(e,I,T);te(e.wysiwyg.element.querySelector(`[data-node-id="${v}"]`),void 0,!1)}else te($,void 0,!1);return}if(S.textContent!==""||t.classList.contains("av")){te($,void 0,!1);return}}const k=qt(t),_=k.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const E=[{action:"update",data:$.outerHTML,id:v},{action:"insert",data:k.outerHTML,id:_,previousID:(u=t.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:h.getAttribute("data-node-id")}],A=[{action:"delete",id:_}];if(D)k.remove(),te($,void 0,!1),E.splice(0,1);else{const x=oe($);if(S&&(S.textContent!==""||S.querySelector(".emoji"))&&(n.setEndAfter(S.lastChild),(((g=x==null?void 0:x.lastElementChild)==null?void 0:g.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const N=qe(x==null?void 0:x.lastElementChild);N&&N.textContent===`
`&&N.remove()}if(x){let N=x.lastChild;N&&N.nodeType===3&&(N.textContent||(N=st(N)),N&&N.nodeType===3&&N.textContent.endsWith(`
`)&&(N.textContent=N.textContent.slice(0,-1)))}const I=e.contentElement.scrollTop,T=n.extractContents();n.selectNodeContents(x),n.collapse(!1),n.insertNode(T);const q=x.innerHTML.trimStart(),z=x.textContent.trimStart();if((q.startsWith("```")||q.startsWith("\xB7\xB7\xB7")||q.startsWith("~~~")||q.indexOf("\n```")>-1&&z.indexOf("\n```")>-1||q.indexOf(`
~~~`)>-1&&z.indexOf(`
~~~`)>-1||q.indexOf(`
\xB7\xB7\xB7`)>-1&&z.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(q.indexOf(`
`)===-1&&q.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let N=x.innerHTML.replace(/\n(~||`){3,}/g,"\n```").trim().replace(/^(~||`){3,}/g,"```");N.endsWith("\n```")||(N+="\n```"),x.innerHTML=N}$.outerHTML=e.lute.SpinBlockDOM($.outerHTML),jt(We(k)),k.remove(),e.contentElement.scrollTop=I,e.scroll.lastScrollTop=I-1,A.push({action:"update",data:$.outerHTML,id:v})}if(h.getAttribute("data-type")==="NodeSuperBlock"&&h.childElementCount===2){const x=yield Ea(e,h);B(e,A.concat(x.doOperations),x.undoOperations.concat(E))}else B(e,A,E);fe(e.wysiwyg.element,n)}),Ya=(e,t,n)=>{if(n){const a=We(e);if(a){const s=oe(yt(a));if(s)return ct(s,t,!1)}}},vo=(e,t,n,a)=>{const s=t.outerHTML,i=st(e);i&&i.textContent.endsWith(p.ZWSP)&&(i.textContent=i.textContent.substring(0,i.textContent.length-1));const o=qe(e);o&&o.textContent.startsWith(p.ZWSP)&&(o.textContent=o.textContent.replace(p.ZWSP,"")),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),Q(a,t.getAttribute("data-node-id"),t.outerHTML,s),fe(t,n);const l=oe(t);l.innerHTML.trim()===""&&(l.innerHTML="")},Jg=(e,t,n,a=!1)=>{var s;if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr")){di(e,[t.parentElement],n,a,t);return}if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const m=t.parentElement.parentElement,u=m.outerHTML,g=t.parentElement.parentElement.previousElementSibling.lastElementChild,y=g.parentElement.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),g.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),m.getAttribute("data-subtype")==="o"&&Qe(m),B(e,[{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML},{action:"update",data:g.parentElement.outerHTML,id:g.parentElement.getAttribute("data-node-id")}],[{action:"update",data:y,id:g.parentElement.getAttribute("data-node-id")},{action:"update",data:u,id:m.getAttribute("data-node-id")}]),fe(g.parentElement,n);return}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;Ya(t,n,a),n.insertNode(document.createElement("wbr"));const m=t.parentElement.parentElement,u=m.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const g=document.createElement("div");g.innerHTML=t.parentElement.innerHTML;const y=[],b=[];if(Array.from(g.children).forEach((w,h)=>{var S;y.push({action:"insert",id:w.getAttribute("data-node-id"),data:w.outerHTML,previousID:h===0?(S=m.previousElementSibling)==null?void 0:S.getAttribute("data-node-id"):y[h-1].id,parentID:m.parentElement.getAttribute("data-node-id")||e.block.parentID}),b.push({action:"delete",id:w.getAttribute("data-node-id")})}),m.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),m.getAttribute("data-subtype")==="o"&&Qe(m,parseInt(m.firstElementChild.getAttribute("data-marker"))-1),y.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML}),b.push({action:"update",data:u,id:m.getAttribute("data-node-id")}),B(e,y,b),m.parentElement.classList.contains("sb")&&m.parentElement.getAttribute("data-sb-layout")==="col"){const w=[];let h=m;for(;h&&(w.push(h),b[0].id!==h.getAttribute("data-node-id"));)h=h.previousElementSibling;_n({protyle:e,selectsElement:w.reverse(),type:"BlocksMergeSuperBlock",level:"row"})}fe(e.wysiwyg.element,n);return}const i=t.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const o=i.getAttribute("data-node-id"),l=i.parentElement;Ya(t,n,a),n.insertNode(document.createElement("wbr"));const r=l.outerHTML,d=[],c=[{action:"insert",id:o,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],f=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(oe(t).textContent.trim()===""&&t.nextElementSibling.classList.contains("protyle-attr"))d.push({action:"delete",id:o}),c[0].data=i.outerHTML,ct(oe(i.previousElementSibling),n),n.collapse(!0),i.remove();else{ct(oe(i.previousElementSibling),n),n.collapse(!0),X(n),(s=t.querySelector("wbr"))==null||s.remove();return}else{let m=f.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach((u,g)=>{if(u.classList.contains("protyle-action")||u.classList.contains("protyle-attr"))return;const y=u.getAttribute("data-node-id");d.push({action:"move",id:y,previousID:m}),c.push({action:"move",id:y,previousID:g===1?void 0:m,parentID:o}),m=y,f.before(u)}),d.push({action:"delete",id:o}),c[0].data=i.outerHTML,i.remove()}l.classList.contains("protyle-wysiwyg")?B(e,d,c):(l.getAttribute("data-subtype")==="o"&&Qe(l),Q(e,l.getAttribute("data-node-id"),l.outerHTML,r)),fe(f.parentElement,n)},Qe=(e,t)=>{if(e.getAttribute("data-subtype")!=="o")return;let n;Array.from(e.children).forEach((a,s)=>{a.classList.contains("li")&&(s===0?t?(n=t,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."))})},Wa=(e,t=0,n=!1)=>{const a=document.createElement("template"),s=e.getAttribute("data-subtype");if(s==="o"){const i=parseInt(e.getAttribute("data-marker"))+t;a.innerHTML=`<div data-marker="${i+1}." data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${i+1}.</div>${Zs(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else s==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${Zs(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${s}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${Zs(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},Qg=(e,t,n)=>{var a;const s=C(t,"li");if(!s)return;const i=(a=s.querySelector(".list"))==null?void 0:a.lastElementChild.previousElementSibling;if(!i)return;const o=Wa(i,0,!0),l=o.getAttribute("data-node-id");i.after(o),i.parentElement.getAttribute("fold")==="1"&&at(e,i.parentElement,!0),s.getAttribute("fold")==="1"&&at(e,s,!0),B(e,[{action:"insert",id:l,data:o.outerHTML,previousID:i.getAttribute("data-node-id")}],[{action:"delete",id:l}]),fe(o,n)},Ks=(e,t,n)=>{if(t.forEach(i=>{i.removeAttribute("select-start"),i.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const a=t[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr"));const s=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const i=a.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let d=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");t.forEach((c,f)=>{o.push({action:"move",id:c.getAttribute("data-node-id"),previousID:d}),l.push({action:"move",id:c.getAttribute("data-node-id"),previousID:f===0?a.getAttribute("data-node-id"):d}),d=c.getAttribute("data-node-id"),c.setAttribute("data-subtype",r);const m=c.querySelector(".protyle-action");r==="o"?(m.classList.add("protyle-action--order"),m.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):r==="t"?(c.setAttribute("data-marker","*"),m.innerHTML=`<svg><use xlink:href="#icon${c.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,m.classList.remove("protyle-action--order"),m.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):(c.setAttribute("data-marker","*"),m.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',m.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c))}),r==="o"?(Qe(a.lastElementChild.previousElementSibling),Qe(a.parentElement)):a.getAttribute("data-subtype")==="o"&&Qe(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:i,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),B(e,o,l))}else{const i=a.outerHTML,o=t[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const d=[{action:"insert",data:l.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(l);const c=[];let f;t.forEach((m,u)=>{d.push({action:"move",id:m.getAttribute("data-node-id"),parentID:r,previousID:f}),c.push({action:"move",id:m.getAttribute("data-node-id"),previousID:u===0?a.getAttribute("data-node-id"):f}),f=m.getAttribute("data-node-id"),l.lastElementChild.before(m)}),c.push({action:"delete",id:r}),o==="o"&&(Qe(l,1),Qe(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(d.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),c.push({action:"update",data:i,id:a.getAttribute("data-node-id")}),B(e,d,c))}a.parentElement.classList.contains("protyle-wysiwyg")||Q(e,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,s),fe(a,n)},ep=(e,t,n)=>{var a,s;const i=t.parentElement;if(!i.previousElementSibling){bn(e,t,n,"Backspace");return}const o=i.getAttribute("data-node-id"),l=[],r=[];n.insertNode(document.createElement("wbr"));const d=Lute.NewNodeID();let c="",f=0;Array.from(i.parentElement.children).forEach(u=>{!f&&u===i?f=1:f&&!u.classList.contains("protyle-attr")&&(r.push({id:u.getAttribute("data-node-id"),action:"move",previousID:o}),l.push({id:u.getAttribute("data-node-id"),action:"delete"}),u.getAttribute("data-subtype")==="o"&&(r.push({id:u.getAttribute("data-node-id"),action:"update",data:u.outerHTML}),u.setAttribute("data-marker",f+"."),u.firstElementChild.innerHTML=f+"."),c+=u.outerHTML,u.remove(),f++)}),r.reverse(),c=`<div data-subtype="${i.getAttribute("data-subtype")}" data-node-id="${d}" data-type="NodeList" class="list" updated="${G().format("YYYYMMDDHHmmss")}">${c}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,i.parentElement.insertAdjacentHTML("afterend",c),l.push({id:d,action:"insert",previousID:i.parentElement.getAttribute("data-node-id"),data:c}),r.push({id:d,action:"delete"}),Array.from(i.children).reverse().forEach(u=>{!u.classList.contains("protyle-action")&&!u.classList.contains("protyle-attr")&&(l.push({id:u.getAttribute("data-node-id"),action:"move",previousID:i.parentElement.getAttribute("data-node-id")}),r.push({id:u.getAttribute("data-node-id"),action:"move",parentID:o}),i.parentElement.after(u))});const m=i.parentElement.getAttribute("data-node-id");i.parentElement.childElementCount===2?(r.splice(0,0,{id:m,action:"insert",data:i.parentElement.outerHTML,previousID:(a=i.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:i.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),i.parentElement.remove(),l.push({id:m,action:"delete"})):(r.splice(0,0,{id:o,action:"insert",data:i.outerHTML,previousID:(s=i.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:m}),i.remove(),l.push({id:o,action:"delete"})),B(e,l,r),fe(e.wysiwyg.element,n)},di=(e,t,n,a=!1,s)=>{var i,o,l,r,d,c,f,m;if(t.forEach(_=>{_.removeAttribute("select-start"),_.removeAttribute("select-end")}),!t[0].classList.contains("li"))if(t[0].parentElement.childElementCount===t.length+2)t=[t[0].parentElement];else return;const u=t[0].parentElement,g=u.getAttribute("data-node-id");if(!g)return;const y=u.parentElement,b=y.parentElement;if((i=u.previousElementSibling)!=null&&i.classList.contains("protyle-action")&&!b.getAttribute("data-node-id"))return;if(y.classList.contains("protyle-wysiwyg")||y.classList.contains("sb")||y.classList.contains("bq")){const _=[],E=[];n.collapse(!1),Ya(s,n,a),n.insertNode(document.createElement("wbr"));let A;!t[0].previousElementSibling&&u.getAttribute("data-subtype")==="o"&&(A=parseInt(t[0].getAttribute("data-marker")));let x=g,I=u,T=t[t.length-1].nextElementSibling,q=t[t.length-1].lastElementChild.previousElementSibling;if(t.forEach(N=>{Array.from(N.children).forEach((R,V)=>{const j=R.getAttribute("data-node-id");j&&(_.push({action:"move",id:j,previousID:x,parentID:y.getAttribute("data-node-id")||e.block.parentID}),E.push({action:"move",id:j,previousID:V===1?void 0:x,parentID:N.getAttribute("data-node-id"),data:R.contains(n.startContainer)?"focus":""}),x=j,I.after(R),I=R)})}),!window.siyuan.config.editor.listLogicalOutdent&&!T.classList.contains("protyle-attr")){let N;q.getAttribute("data-subtype")!==T.getAttribute("data-subtype")&&(N=Lute.NewNodeID(),q=document.createElement("div"),q.classList.add("list"),q.setAttribute("data-subtype",T.getAttribute("data-subtype")),q.setAttribute("data-node-id",N),q.setAttribute("data-type","NodeList"),q.setAttribute("updated",G().format("YYYYMMDDHHmmss")),q.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,I.after(q),_.push({action:"insert",id:N,data:q.outerHTML,previousID:I.getAttribute("data-node-id")}));let R;for(;T&&!T.classList.contains("protyle-attr");){_.push({action:"move",id:T.getAttribute("data-node-id"),previousID:R||((o=q.lastElementChild.previousElementSibling)==null?void 0:o.getAttribute("data-node-id")),parentID:q.getAttribute("data-node-id")}),E.push({action:"move",id:T.getAttribute("data-node-id"),parentID:q.getAttribute("data-node-id"),previousID:R||((l=T.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"))}),R=T.getAttribute("data-node-id");const V=T;T=T.nextElementSibling,q.lastElementChild.before(V)}q.getAttribute("data-subtype")==="o"&&(Array.from(q.children).forEach(V=>{const j=V.getAttribute("data-node-id");j&&E.push({action:"update",id:j,data:V.outerHTML})}),Qe(q,1),Array.from(q.children).forEach(V=>{const j=V.getAttribute("data-node-id");j&&_.push({action:"update",id:j,data:V.outerHTML})})),N&&E.push({action:"delete",id:N})}const z=u.outerHTML;t.forEach(N=>{N.remove()}),u.childElementCount===1?(_.push({action:"delete",id:g}),g===e.block.id&&(e.block.id=e.block.parentID),E.splice(0,0,{action:"insert",data:z,id:g,previousID:(r=u.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:y.getAttribute("data-node-id")||e.block.parentID}),u.remove()):(u.getAttribute("data-subtype")==="o"&&Qe(u,A),_.push({action:"update",id:g,data:u.outerHTML}),E.splice(0,0,{action:"update",id:g,data:z})),B(e,_,E),u.childElementCount!==1&&y.classList.contains("sb")&&y.getAttribute("data-sb-layout")==="col"&&_n({protyle:e,selectsElement:[u,u.nextElementSibling],type:"BlocksMergeSuperBlock",level:"row"}),fe(y,n);return}if(u.childElementCount===2&&y.childElementCount===3){n.collapse(!1),Ya(s,n,a),n.insertNode(document.createElement("wbr"));const _=y.outerHTML;t[0].firstElementChild.remove(),t[0].lastElementChild.remove(),u.outerHTML=t[0].innerHTML,Q(e,y.getAttribute("data-node-id"),y.outerHTML,_),fe(y,n);return}n.collapse(!1),Ya(s,n,a),n.insertNode(document.createElement("wbr"));const w=[],h=[],S=(d=t[0].previousElementSibling)==null?void 0:d.getAttribute("data-node-id");let $;!t[0].previousElementSibling&&u.getAttribute("data-subtype")==="o"&&($=parseInt(t[0].getAttribute("data-marker")));const D=y.parentElement.outerHTML;let v=t[t.length-1].nextElementSibling,k=t[t.length-1].lastElementChild.previousElementSibling;if(t.reverse().forEach(_=>{const E=_.getAttribute("data-node-id");w.push({action:"move",id:E,previousID:y.getAttribute("data-node-id")}),h.push({action:"move",id:E,previousID:S,parentID:u.getAttribute("data-node-id")}),y.after(_),(_.getAttribute("data-subtype")==="o"||_.getAttribute("data-subtype")==="t")&&y.getAttribute("data-subtype")==="u"?(h.push({action:"update",id:E,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',_.setAttribute("data-subtype","u"),_.setAttribute("data-marker","*"),_.classList.remove("protyle-task--done"),w.push({action:"update",id:E,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="t")&&y.getAttribute("data-subtype")==="o"?(h.push({action:"update",id:E,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',_.setAttribute("data-subtype","o"),_.setAttribute("data-marker","1."),w.push({action:"update",id:E,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="o")&&y.getAttribute("data-subtype")==="t"&&(h.push({action:"update",id:E,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',_.setAttribute("data-subtype","t"),_.setAttribute("data-marker","*"),w.push({action:"update",id:E,data:_.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!v.classList.contains("protyle-attr")){let _;k.classList.contains("list")||(_=Lute.NewNodeID(),k=document.createElement("div"),k.classList.add("list"),k.setAttribute("data-subtype",v.getAttribute("data-subtype")),k.setAttribute("data-node-id",_),k.setAttribute("data-type","NodeList"),k.setAttribute("updated",G().format("YYYYMMDDHHmmss")),k.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,w.push({action:"insert",id:_,data:k.outerHTML,previousID:t[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),t[0].lastElementChild.before(k));let E;for(;v&&!v.classList.contains("protyle-attr");){const A=v.getAttribute("data-node-id");v.getAttribute("data-subtype")!==k.getAttribute("data-subtype")&&(h.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML=k.querySelector(".protyle-action").outerHTML,v.setAttribute("data-subtype",k.getAttribute("data-subtype")),v.setAttribute("data-marker",k.getAttribute("data-marker")),w.push({action:"update",id:A,data:v.outerHTML})),w.push({action:"move",id:A,previousID:E||((c=k.lastElementChild.previousElementSibling)==null?void 0:c.getAttribute("data-node-id")),parentID:k.getAttribute("data-node-id")}),h.push({action:"move",id:A,previousID:E||((f=k.parentElement)==null?void 0:f.getAttribute("data-node-id"))}),E=A;const x=v;v=v.nextElementSibling,k.lastElementChild.before(x)}k.getAttribute("data-subtype")==="o"&&(Array.from(k.children).forEach(A=>{const x=A.getAttribute("data-node-id");x&&h.push({action:"update",id:x,data:A.outerHTML})}),Qe(k,1),Array.from(k.children).forEach(A=>{const x=A.getAttribute("data-node-id");x&&w.push({action:"update",id:x,data:A.outerHTML})})),_&&h.push({action:"delete",id:_})}if(!window.siyuan.config.editor.listLogicalOutdent&&u.nextElementSibling){v=u.nextElementSibling;let _;for(;v&&!v.classList.contains("protyle-attr");){const E=v.getAttribute("data-node-id");w.push({action:"move",id:E,previousID:_||k.getAttribute("data-node-id")}),h.push({action:"move",id:E,previousID:_||u.getAttribute("data-node-id")}),_=E;const A=v;v=v.nextElementSibling,k.after(A),k=A}}u.childElementCount===1&&y.childElementCount===3?(w.push({action:"delete",id:y.getAttribute("data-node-id")}),h.splice(0,0,{action:"insert",id:y.getAttribute("data-node-id"),data:y.outerHTML,previousID:(m=y.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:y.parentElement.getAttribute("data-node-id")}),y.remove()):u.childElementCount===1?(w.push({action:"delete",id:u.getAttribute("data-node-id")}),h.splice(0,0,{action:"insert",id:u.getAttribute("data-node-id"),data:u.outerHTML,previousID:u.previousElementSibling.getAttribute("data-node-id")}),u.remove()):u.getAttribute("data-subtype")==="o"&&(h.splice(0,0,{action:"update",data:u.outerHTML,id:u.getAttribute("data-node-id")}),Qe(u,$),w.push({action:"update",data:u.outerHTML,id:u.getAttribute("data-node-id")})),b.classList.contains("protyle-wysiwyg")?B(e,w,h):(y&&y.getAttribute("data-subtype")==="o"&&Qe(b),Q(e,b.getAttribute("data-node-id"),b.outerHTML,D)),fe(b,n)};var tp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Ea=(e,t,n)=>tp(void 0,null,function*(){var a;const s=[],i=[];let o=t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0;t.classList.remove("protyle-wysiwyg--select"),t.removeAttribute("select-start"),t.removeAttribute("select-end");const l=t.getAttribute("data-node-id"),r=t.cloneNode();r.innerHTML=t.lastElementChild.outerHTML;let d=(a=t.parentElement)==null?void 0:a.getAttribute("data-node-id");if(!o&&!d)if(e.block.showAll||e.options.backlinkData){const c=yield he("/api/block/getBlockSiblingID",{id:l});o=c.data.previous,d=c.data.parent}else d=e.block.rootID;return i.push({action:"insert",id:l,data:r.outerHTML,previousID:o,parentID:d}),Array.from(t.children).forEach((c,f)=>{if(f===t.childElementCount-1){s.push({action:"delete",id:l}),n&&oe(t).insertAdjacentHTML("afterbegin","<wbr>"),t.lastElementChild.remove(),t.replaceWith(...t.children),n&&fe(e.wysiwyg.element,n);return}s.push({action:"move",id:c.getAttribute("data-node-id"),previousID:o,parentID:d}),i.push({action:"move",id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling?c.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:l}),o=c.getAttribute("data-node-id")}),jt(e.wysiwyg.element),s.forEach(c=>{const f=e.wysiwyg.element.querySelector(`[data-node-id="${c.id}"]`);f&&f.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(f.removeAttribute("data-render"),xe(e,f))}),{doOperations:s,undoOperations:i,previousId:o}}),tc=(e,t,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",t||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",e),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,a},ci=(e,t,n)=>{L("/api/block/getBlockSiblingID",{id:t.getAttribute("data-node-id")},a=>{const s=a.data[n];s&&ft(e.app,s,s!==e.block.rootID&&e.block.showAll?[p.CB_GET_ALL,p.CB_GET_FOCUS]:[p.CB_GET_FOCUS])})},an=(e,t,n)=>{var a;const s=ye(e.wysiwyg.element);let i;if(n)i=e.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const c=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(t==="beforebegin"?i=c[0]:i=c[c.length-1],ae(["select"],e)):(i=F(s.startContainer),i=Ve(i),i.classList.contains("list")?i=C(s.startContainer,"li"):i.classList.contains("bq")&&(i=F(s.startContainer)))}if(!i)return;(a=e.observerLoad)==null||a.disconnect();let o=yn(!1,!0),l=1;i.getAttribute("data-type")==="NodeListItem"?(o=Wa(i,0,!0),l=parseInt(i.parentElement.firstElementChild.getAttribute("data-marker"))):t==="beforebegin"&&i.previousElementSibling&&i.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&i.previousElementSibling.getAttribute("fold")==="1"?o=ts(i.previousElementSibling,!1,!0):t==="afterend"&&i&&i.getAttribute("data-type")==="NodeHeading"&&i.getAttribute("fold")==="1"&&(o=ts(i,!1,!0));const r=i.parentElement.outerHTML,d=o.getAttribute("data-node-id");if(i.insertAdjacentElement(t,o),i.getAttribute("data-type")==="NodeListItem"&&i.getAttribute("data-subtype")==="o"&&!o.parentElement.classList.contains("protyle-wysiwyg"))Qe(o.parentElement,l),Q(e,o.parentElement.getAttribute("data-node-id"),o.parentElement.outerHTML,r);else{let c;t==="beforebegin"?c=[{action:"insert",data:o.outerHTML,id:d,nextID:i.getAttribute("data-node-id")}]:c=[{action:"insert",data:o.outerHTML,id:d,previousID:i.getAttribute("data-node-id")}],B(e,c,[{action:"delete",id:d}])}i.parentElement.classList.contains("sb")&&i.parentElement.getAttribute("data-sb-layout")==="col"&&_n({protyle:e,selectsElement:t==="afterend"?[i,i.nextElementSibling]:[i.previousElementSibling,i],type:"BlocksMergeSuperBlock",level:"row"}),fe(e.wysiwyg.element,s),Oe(e)},Zs=(e=!0,t=!0,n)=>{let a="";return e&&(a=p.ZWSP),t&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${p.ZWSP}</div></div>`},yn=(e=!0,t=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${e?p.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,a},ts=(e,t=!1,n=!1)=>{const a=`<div data-subtype="${e.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeHeading" class="${e.className}"><div contenteditable="true" spellcheck="false">${n?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;if(t)return a;{const s=document.createElement("template");return s.innerHTML=a,s.content.firstElementChild}},np=e=>{let t=e;switch(e){case"NodeIFrame":t="IFrame";break;case"NodeAttributeView":t=window.siyuan.languages.database;break;case"NodeThematicBreak":t=window.siyuan.languages.line;break;case"NodeWidget":t=window.siyuan.languages.widget;break;case"NodeVideo":t=window.siyuan.languages.video;break;case"NodeAudio":t=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":t=window.siyuan.languages.blockEmbed;break}return t},ap=(e,t,n,a,s)=>{var i;if(t!=="NodeCodeBlock"&&!((i=n.previousElementSibling)!=null&&i.classList.contains("protyle-action--task"))&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const o=a.innerHTML.indexOf("\u3011")+1;let l=a.innerHTML.indexOf("]")+1;l===0?l=o:l>0&&o>0&&(l=Math.min(l,o)),a.removeAttribute("placeholder");const r=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const d=n.parentElement.parentElement,c=d.outerHTML;return d.setAttribute("data-subtype","t"),d.setAttribute("updated",G().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),r&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(l),Q(e,d.getAttribute("data-node-id"),d.outerHTML,c),fe(e.wysiwyg.element,s),!0}return!1}else{const d=n.getAttribute("data-node-id"),c=Lute.NewNodeID(),f=Lute.NewNodeID(),m=Lute.NewNodeID(),u=n.outerHTML;return a.innerHTML=a.innerHTML.substring(l),B(e,[{action:"update",id:d,data:n.outerHTML},{action:"insert",id:c,data:`<div data-subtype="t" data-node-id="${c}" updated="${c.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${m}" data-type="NodeListItem" class="li${r?" protyle-task--done":""}" updated="${m.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div><div data-node-id="${f}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:d},{action:"move",id:d,previousID:f},{action:"delete",id:f}],[{action:"move",id:d,previousID:c},{action:"delete",id:c},{action:"update",id:d,data:u}]),n.outerHTML=`<div data-subtype="t" data-node-id="${c}" data-type="NodeList" class="list" updated="${c.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${m}" data-type="NodeListItem" class="li${r?" protyle-task--done":""}" updated="${m.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${r?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,fe(e.wysiwyg.element,s),!0}}return!1},ip=(e,t,n,a,s)=>{if(t==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const i=n.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),d=n.outerHTML,c=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),B(e,[{action:"update",id:i,data:n.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${c}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:i},{action:"move",id:i,previousID:l},{action:"delete",id:l}],[{action:"update",id:i,data:d},{action:"move",id:i,previousID:o},{action:"delete",id:o}]),n.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${c}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,fe(e.wysiwyg.element,s),!0}return!1};var sp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Xs=(e,t,n,a=!0,s)=>sp(void 0,null,function*(){var i,o,l,r,d,c;if(!t.parentElement)return;if(t.classList.contains("av")){const v=C(n.startContainer,"av__cursor");v?v.textContent=p.ZWSP:Kl(e,t);return}const f=oe(t),m=t.getAttribute("data-type");if(!f){m==="NodeThematicBreak"?t.innerHTML="<div><wbr></div>":m==="NodeBlockQueryEmbed"?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+p.ZWSP:m==="NodeMathBlock"||m==="NodeHTMLBlock"?(t.firstElementChild.firstChild.nodeType===3&&t.firstElementChild.firstChild.remove(),t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+p.ZWSP):m==="NodeIFrame"||m==="NodeWidget"?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:m==="NodeVideo"?t.firstElementChild.innerHTML="<wbr>"+p.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:m==="NodeAudio"?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+p.ZWSP:m==="NodeCodeBlock"&&(n.startContainer.textContent=p.ZWSP),fe(t,n);return}t.setAttribute("updated",G().format("YYYYMMDDHHmmss"));const u=document.createElement("wbr");if(n.insertNode(u),s){const v=qe(u);if(s.inputType==="deleteContentForward"&&v&&v.nodeType===1&&!v.textContent.startsWith(p.ZWSP)){const k=(v.getAttribute("data-type")||"").split(" ");(k.includes("code")||k.includes("kbd")||k.includes("tag"))&&v.insertAdjacentElement("afterbegin",u)}if((s.inputType==="deleteContentBackward"||s.inputType==="deleteContentForward")&&v&&v.nodeType===1&&v.tagName==="BR"){const k=qe(v);k&&k.nodeType===1&&((i=k.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1&&v.remove(),s.inputType==="deleteContentBackward"&&((o=v.previousSibling.previousSibling)!=null&&o.textContent.endsWith(`
`))&&(v.outerHTML=`
`)}}const g=t.getAttribute("data-node-id");if(m!=="NodeCodeBlock"&&m!=="NodeHeading"&&(f.innerHTML.endsWith(`
<wbr>`)||f.innerHTML.endsWith(`
<wbr>
`))){Q(e,g,t.outerHTML,e.wysiwyg.lastHTMLs[g]||t.outerHTML.replace(`
<wbr>`,"<wbr>")),u.remove();return}if(ap(e,m,t,f,n)||ip(e,m,t,f,n))return;const y=t.querySelector("br");y&&y.parentElement.tagName!=="TD"&&y.parentElement.tagName!=="TH"&&(y.parentElement.textContent.trim()===""||((r=(l=y.previousSibling)==null?void 0:l.previousSibling)==null?void 0:r.textContent)===`
`)&&y.remove(),m!=="NodeHeading"&&(f.innerHTML.startsWith("\u300B<wbr>")||f.innerHTML.startsWith(p.ZWSP+"\u300B<wbr>")||f.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(f.innerHTML=f.innerHTML.replace("\u300B<wbr>","><wbr>"));const b=f.innerHTML.trimStart(),w=f.textContent.trimStart();if(!((b.startsWith("````")||b.startsWith("\xB7\xB7\xB7\xB7")||b.startsWith("~~~~"))&&b.indexOf(`
`)===-1)){if((b.startsWith("```")||b.startsWith("\xB7\xB7\xB7")||b.startsWith("~~~"))&&b.indexOf(`
`)===-1&&b.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){Q(e,g,t.outerHTML,e.wysiwyg.lastHTMLs[g]),u.remove();return}}m==="NodeParagraph"&&(f.innerHTML.startsWith("\xA5\xA5<wbr>")||f.innerHTML.startsWith("\uFFE5\uFFE5<wbr>")||b.indexOf(`
\xA5\xA5<wbr>`)>-1||b.indexOf(`
\uFFE5\uFFE5<wbr>`)>-1)&&(f.innerHTML=f.innerHTML.replace("\xA5\xA5<wbr>","$$$$<wbr>").replace("\uFFE5\uFFE5<wbr>","$$$$<wbr>"));const h=O(n.startContainer,"data-type","block-ref");h&&h.getAttribute("data-subtype")==="d"&&(yield he("/api/block/getRefText",{id:h.getAttribute("data-id")})).data!==h.innerHTML.replace("<wbr>","")&&h.setAttribute("data-subtype","s");let S=t.outerHTML,$=!1;if(["---","___","***"].includes(f.textContent)&&m!=="NodeCodeBlock"){S=`<div data-node-id="${g}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const v=t.nextElementSibling;v&&v.getAttribute("data-node-id")?It(v)?$=!0:te(v):S+=Zs(!1,!0)}else{if(m!=="NodeCodeBlock"&&(b.startsWith("```")||b.startsWith("~~~")||b.startsWith("\xB7\xB7\xB7")||b.indexOf("\n```")>-1&&w.indexOf("\n```")>-1||b.indexOf(`
~~~`)>-1&&w.indexOf(`
~~~`)>-1||b.indexOf(`
\xB7\xB7\xB7`)>-1&&w.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(b.indexOf(`
`)===-1&&b.replace(/|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let v=f.innerHTML.trim().replace(/^(~||`){3,}/g,"```").replace(/\n(~||`){3,}/g,"\n```").trim();v.endsWith("\n```")||(v=v.replace("<wbr>","")+"<wbr>\n```"),f.innerHTML=v,S=t.outerHTML}S=e.lute.SpinBlockDOM(S)}ae(["util"],e,!0),m==="NodeTable"&&t.querySelector(".table__select").removeAttribute("style");const D=document.createElement("template");if(D.innerHTML=S,a&&(((d=oe(D.content.firstElementChild))==null?void 0:d.innerHTML)!==oe(t).innerHTML||D.content.childElementCount===1&&((c=oe(D.content.firstElementChild))==null?void 0:c.innerHTML)==="<wbr>")&&!(D.content.childElementCount===1&&D.content.firstElementChild.classList.contains("code-block")&&m==="NodeCodeBlock")){t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&D.content.firstElementChild.getAttribute("data-subtype")!==t.dataset.subtype&&(at(e,t,void 0,void 0,!1),S=S.replace(' fold="1"',""),e.wysiwyg.lastHTMLs[g]=t.outerHTML);let v;t.classList.contains("table")&&(v=t.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(S)?t.outerHTML=S:t.outerHTML=S.replace("</span><wbr>","</span>"+p.ZWSP+"<wbr>"),e.wysiwyg.element.querySelectorAll(`[data-node-id="${g}"]`).forEach(k=>{de(k)||(t=k)}),S.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(t.querySelectorAll('[data-type="inline-math"]')).find(k=>{if(k.dataset.content.indexOf("<wbr>")>-1)return k.setAttribute("data-content",k.dataset.content.replace("<wbr>","")),e.toolbar.showRender(e,k),!0}),S="",Array.from(D.content.children).forEach((k,_)=>{const E=k.getAttribute("data-node-id");let A;E===g?A=t:A=e.wysiwyg.element.querySelector(`[data-node-id="${E}"]`);const x=A.getAttribute("data-type");if(x==="NodeCodeBlock"){const I=A.querySelector(".protyle-action__language");I?(window.siyuan.storage[p.LOCAL_CODELANG]&&I.textContent===""&&(I.textContent=window.siyuan.storage[p.LOCAL_CODELANG]),Re(A)):D.content.childElementCount===1&&e.toolbar.showRender(e,A)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(x))x==="NodeMathBlock"&&jt(A),e.toolbar.showRender(e,A);else if(x==="NodeBlockQueryEmbed")xe(e,A),A.getAttribute("data-content")||e.toolbar.showRender(e,A),ae(["hint"],e);else if(x==="NodeThematicBreak"&&$)te(t);else if(A.querySelectorAll('[data-type~="block-ref"][data-subtype="d"]').forEach(I=>{I.textContent===""&&L("/api/block/getRefText",{id:I.getAttribute("data-id")},T=>{I.innerHTML=T.data})}),jt(A),_===D.content.childElementCount-1){const I=t.querySelector("wbr");if(I&&I.parentElement.tagName==="SPAN"&&I.parentElement.innerHTML==="<wbr>"){const T=I.parentElement.getAttribute("data-type")||"";(T.includes("sup")||T.includes("u")||T.includes("sub"))&&I.insertAdjacentText("beforebegin",p.ZWSP)}fe(e.wysiwyg.element,n),e.hint.render(e),v>0&&(t.firstElementChild.scrollLeft=v)}S+=A.outerHTML})}else t.getAttribute("data-type")==="NodeCodeBlock"?(f.parentElement.removeAttribute("data-render"),Re(t)):(fe(e.wysiwyg.element,n),e.hint.render(e));ae(["gutter"],e),lp(S,e,g)}),lp=(e,t,n)=>{const a=document.createElement("template");a.innerHTML=e;const s=[],i=[];Array.from(a.content.children).forEach((o,l)=>{var r;o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const d=o.getAttribute("data-node-id");if(d===n)s.push({id:n,data:o.outerHTML,action:"update"}),i.push({id:n,data:t.wysiwyg.lastHTMLs[n],action:"update"}),t.wysiwyg.lastHTMLs[n]=o.outerHTML;else{let c;l===0&&(c=t.wysiwyg.element.querySelector(`[data-node-id="${d}"]`)),s.push({action:"insert",data:o.outerHTML,id:d,previousID:l===0?(r=c==null?void 0:c.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:(c==null?void 0:c.parentElement.getAttribute("data-node-id"))||t.block.parentID}),i.push({id:d,action:"delete"})}}),B(t,s,i)};var op=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const rp=(e,t,n,a)=>{const s=document.createElement("template");s.innerHTML=t;let i=[];if(t.endsWith("]")&&t.startsWith("["))try{i=JSON.parse(t)}catch(l){console.warn("insert cell: JSON.parse error")}else s.content.querySelector("table")&&s.content.querySelectorAll("tr").forEach(l=>{i.push([]),Array.from(l.children).forEach(r=>{i[i.length-1].push(r.textContent)})});const o=a.dataset.avId;L("/api/av/getAttributeViewKeysByAvID",{avID:o},l=>op(void 0,null,function*(){var r,d;const c=l.data,f=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select"))||[];if(i&&Array.isArray(i)&&i.length>0){f.length===0&&a.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(D=>{D.querySelectorAll(".av__cell").forEach(v=>{f.push(v)})}),f.length===0&&f.push(a.querySelector(".av__row:not(.av__row--header) .av__cell"));const b=[],w=[],h=a.dataset.nodeId;let S;const $=f[0].getAttribute("data-col-id");for(let D=0;D<i.length&&(S?S=S.nextElementSibling:S=C(f[0].parentElement,"av__row"),!!S.classList.contains("av__row"));D++){let v;for(let k=0;k<i[D].length;k++){const _=i[D][k];if(v?v.nextElementSibling?v=v.nextElementSibling:v.parentElement.classList.contains("av__colsticky")&&(v=v.parentElement.nextElementSibling):v=S.querySelector(`.av__cell[data-col-id="${$}"]`),!v.classList.contains("av__cell"))break;const E=yield Zt(n,a,_,[v],c,t,!0);E.doOperations.length>0&&(b.push(...E.doOperations),w.push(...E.undoOperations))}}b.length>0&&(b.push({action:"doUpdateUpdated",id:h,data:G().format("YYYYMMDDHHmmss")}),w.push({action:"doUpdateUpdated",id:h,data:a.getAttribute("updated")}),B(n,b,w));return}const m=oe(s.content.firstElementChild);if(m&&m.childNodes.length===1&&((r=m.firstElementChild)==null?void 0:r.getAttribute("data-type"))==="block-ref"){const b=a.querySelector(".av__cell--select");if(b){const w=m.firstElementChild.getAttribute("data-id"),h=Tn(b,a.getAttribute("data-av-type"));B(n,[{action:"replaceAttrViewBlock",avID:o,previousID:h,nextID:w,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:o,previousID:w,nextID:h,isDetached:b.dataset.detached==="true"}]),Gt(b,{type:"block",isDetached:!1,block:{content:m.firstElementChild.textContent,id:w}});return}}const u=n.lute.BlockDOM2Content(t),g=a.querySelectorAll(".av__row--select"),y=[];if(u.split(`
`).forEach(b=>{y.push(b.split("	"))}),g.length>0&&y.length===1&&y[0].length===1){Zt(n,a,u,void 0,c,t);return}if(g.length>0&&g.forEach(b=>{b.querySelectorAll(".av__cell").forEach(w=>{f.push(w)})}),f.length>0){if(y.length===1&&y[0].length===1)Zt(n,a,u,f,c,t);else{let b;const w=[],h=[],S=f[0].getAttribute("data-col-id");for(let $=0;$<y.length&&(b?b=b.nextElementSibling:b=C(f[0].parentElement,"av__row"),!!b.classList.contains("av__row"));$++){let D;for(let v=0;v<y[$].length&&(D?D.nextElementSibling?D=D.nextElementSibling:D.parentElement.classList.contains("av__colsticky")&&(D=D.parentElement.nextElementSibling):D=b.querySelector(`.av__cell[data-col-id="${S}"]`),!!D.classList.contains("av__cell"));v++){const k=y[$][v],_=yield Zt(n,a,k,[D],c,t,!0);_.doOperations.length>0&&(w.push(..._.doOperations),h.push(..._.undoOperations))}}if(w.length>0){const $=a.getAttribute("data-node-id");w.push({action:"doUpdateUpdated",id:$,data:G().format("YYYYMMDDHHmmss")}),h.push({action:"doUpdateUpdated",id:$,data:a.getAttribute("updated")}),B(n,w,h)}}(d=document.querySelector(".av__panel"))==null||d.remove()}else if(C(e.startContainer,"av__title")){const b=document.createTextNode(u);e.insertNode(b),e.setEnd(b,u.length),e.collapse(!1),X(e),Kl(n,a)}}))},dp=(e,t,n,a)=>{const s=document.createElement("template");s.innerHTML=t;const i=s.content.querySelectorAll("th, td");if(i.length===0)return!1;const o=a.firstElementChild.scrollLeft,l=a.querySelector("table").scrollTop,r=a.querySelector(".table__select");let d=0;const c=[];a.querySelectorAll("th, td").forEach(m=>{!m.classList.contains("fn__none")&&i.length>d&&ea({tableSelectElement:r,scrollLeft:o,scrollTop:l,item:m})&&(c.push(m),d++)}),r.removeAttribute("style");const f=a.outerHTML;return a.setAttribute("updated",G().format("YYYYMMDDHHmmss")),c.forEach((m,u)=>{m.innerHTML=i[u].innerHTML,u===c.length-1&&ct(m,e,!1)}),e.collapse(!1),Q(n,a.getAttribute("data-node-id"),a.outerHTML,f),!0},lt=(e,t,n=!1,a=!1,s=!1)=>{var i,o,l,r;if(e==="")return;const d=a?t.toolbar.range:ye(t.wysiwyg.element);Tl(d);let c;O(d.startContainer,"data-type","NodeTable")&&!n&&(U(d.startContainer,"TABLE")?c=t.lute.BlockDOM2InlineBlockDOM(e):n=!0);let f=F(d.startContainer);if(f||(t.toolbar.range?f=F(t.toolbar.range.startContainer):f=t.wysiwyg.element.firstElementChild),!f)return;if(f.classList.contains("av")){d.deleteContents(),rp(d,e,t,f);return}if(f.classList.contains("table")&&f.querySelector(".table__select").clientWidth>0&&dp(d,e,t,f))return;let m=f.getAttribute("data-node-id");d.insertNode(document.createElement("wbr"));let u=f.outerHTML;const g=f.getAttribute("data-type"),y=g==="NodeCodeBlock",b=oe(f);if(!n&&(y||t.toolbar.getCurrentType(d).includes("code"))){d.deleteContents();let x=!1;y&&b.textContent===""&&(x=!0),d.insertNode(document.createTextNode(e.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),d.collapse(!1),d.insertNode(document.createElement("wbr")),x&&(d.collapse(!1),d.insertNode(document.createTextNode(`
`))),y?((i=f.querySelector('[data-render="true"]'))==null||i.removeAttribute("data-render"),Re(f)):fe(f,d),f.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(t,m,f.outerHTML,u),setTimeout(()=>{Oe(t,void 0,"nearest","smooth")},p.TIMEOUT_LOAD);return}const w=[],h=[];if(d.toString()!==""){const x=O(d.commonAncestorContainer,"data-type","inline-math");x?x.remove():d.startContainer.nodeType===3&&((o=d.startContainer.parentElement.getAttribute("data-type"))==null?void 0:o.indexOf("block-ref"))>-1?(d.deleteContents(),d.startContainer.nodeType!==3&&d.startContainer.textContent===""&&d.startContainer.remove()):d.deleteContents(),d.insertNode(document.createElement("wbr")),w.push({action:"update",id:m,data:u}),h.push({action:"update",id:m,data:f.outerHTML})}const S=document.createElement("template");/^\s*&gt;|\*|-|\+|\d*.|\[ \]|[x]/.test(e)&&b.textContent.replace(p.ZWSP,"")!==""&&(c=e);let $=c||e;$=$.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),S.innerHTML=$;let D=!1;if((b.textContent.replace(p.ZWSP,"")!==""||g==="NodeHeading")&&S.content.childElementCount===1&&S.content.firstChild.nodeType!==3&&S.content.firstElementChild.getAttribute("data-type")==="NodeHeading"&&(n=!1,D=!0),!n&&(S.content.firstChild.nodeType===3||D||S.content.firstChild.nodeType!==3&&(S.content.firstElementChild.classList.contains("p")&&S.content.childElementCount===1||S.content.firstElementChild.tagName!=="DIV"))){S.content.firstChild.nodeType!==3&&S.content.firstElementChild.classList.contains("p")&&(S.innerHTML=S.content.firstElementChild.firstElementChild.innerHTML.trim());const x=d.startContainer.nodeType===3?d.startContainer.parentElement:d.startContainer;if(x.tagName==="SPAN"&&x===(d.endContainer.nodeType===3?d.endContainer.parentElement:d.endContainer)&&S.content.querySelector("span, img")){const I=document.createElement("span"),T=x.attributes;for(let q=0;q<T.length;q++)I.setAttribute(T[q].name,T[q].value);d.setEnd(x.lastChild,x.lastChild.textContent.length),I.append(d.extractContents()),x.after(I),d.setStartBefore(I),d.collapse(!0)}d.insertNode(S.content.cloneNode(!0)),d.collapse(!1),(l=f.querySelector("wbr"))==null||l.remove(),t.wysiwyg.lastHTMLs[m]=u,Xs(t,f,d);return}const v=C(f,"li");if(((r=S.content.children[0])==null?void 0:r.getAttribute("data-type"))==="NodeListItem")if(v)f=v,m=f.getAttribute("data-node-id"),u=f.outerHTML;else{const I=S.content.children[0].getAttribute("data-subtype");S.innerHTML=`<div${I==="o"?' data-marker="1."':""} data-subtype="${I}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`}let k,_=!1;!d.toString()&&s&&et(f,t.wysiwyg.element,d).start===0&&b.textContent!==""&&(_=!0),(S.content.firstChild.nodeType===3||S.content.firstChild.nodeType===1&&S.content.firstElementChild.tagName!=="DIV")&&(S.innerHTML=t.lute.SpinBlockDOM(S.innerHTML)),(_?Array.from(S.content.children):Array.from(S.content.children).reverse()).find(x=>{let I=x.getAttribute("data-node-id");const T=x.getAttribute("parent-heading");if(I===m)h.push({action:"update",data:x.outerHTML,id:I}),w.push({action:"update",id:I,data:u});else{if(x.classList.contains("li")&&!f.parentElement.classList.contains("list")){I=Lute.NewNodeID();const q=document.createElement("div");q.setAttribute("data-subtype",x.getAttribute("data-subtype")),q.setAttribute("data-node-id",I),q.setAttribute("data-type","NodeList"),q.setAttribute("updated",G().format("YYYYMMDDHHmmss")),q.classList.add("list"),q.append(x),x=q}x.removeAttribute("parent-heading"),h.push({action:"insert",data:x.outerHTML,id:I,context:{ignoreProcess:T?"true":"false"},nextID:_?m:void 0,previousID:_?void 0:m}),w.push({action:"delete",id:I})}if(!T){const q=[];x.classList.contains("render-node")&&x.getAttribute("data-type")==="NodeCodeBlock"?q.push(x):q.push(...x.querySelectorAll('.render-node[data-type="NodeCodeBlock"]')),q.forEach(z=>{var N;(N=z.querySelector(".protyle-icons"))==null||N.remove();const R=z.querySelector('[spin="1"]');R&&(R.innerHTML=""),z.removeAttribute("data-render")}),un(x),_?f.before(x):f.after(x)}k||(k=x)}),b&&b.textContent===""&&f.classList.contains("p")&&(h.find((x,I)=>{if(x.id===m)return h.splice(I,1),!0}),h.push({action:"delete",id:m}),w.find((x,I)=>{if(x.id===m&&x.action==="update")return w.splice(I,1),!0}),w.push({action:"insert",data:u,id:m,previousID:f.previousElementSibling?f.previousElementSibling.getAttribute("data-node-id"):"",parentID:f.parentElement.getAttribute("data-node-id")||t.block.parentID}),f.remove()),k&&te(k,void 0,!1);const E=t.wysiwyg.element.querySelector("wbr");E&&E.remove();let A;f.getAttribute("data-type")==="NodeHeading"&&f.getAttribute("fold")==="1"&&(A=at(t,f,!0,!1,!1,!0),h.reverse(),A.doOperations[0].context={focusId:k==null?void 0:k.getAttribute("data-node-id")},h.push(...A.doOperations),w.push(...A.undoOperations)),B(t,h,w),t.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(x=>{x.remove()})},Eo=(e,t,n,a)=>{!na()||(!t||t.length===0)&&!n||setTimeout(()=>{e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.rangeIndex=0,e.highlight.ranges=[];let s=!1,i;typeof n=="string"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id='${n}']`)).find(u=>{if(!de(u))return i=u,!0}),!i&&n===e.block.rootID&&e.title&&!e.title.element.classList.contains("fn__none")&&(i=e.title.element);const o=[],l=[];let r=0;const d=document.createTreeWalker(e.contentElement,NodeFilter.SHOW_TEXT);let c=d.nextNode();for(;c;)o.push(c),r+=c.textContent.length,l.push(r),c=d.nextNode();const f=e.contentElement.textContent,m=[];if(t&&t.length>0&&t.forEach(u=>{if(!u)return;let g=0,y=0,b=0;for(;(g=f.indexOf(u,g))!==-1;){const w=new Range;y=g+u.length;try{for(;b<o.length&&l[b]<=g;)b++;let h=o[b];for(w.setStart(h,g-(b?l[b-1]:0));b<o.length&&l[b]<y;)b++;h=o[b],w.setEnd(h,y-(b?l[b-1]:0));let S=!1;!s&&i&&i.contains(h)&&(s=!0,S=!0),m.push({range:w,startIndex:g,isCurrent:S})}catch(h){console.error("searchMarkRender error:",h)}g=y}}),!s&&i){const u=f.indexOf(i.textContent);if(u>-1){const g=new Range;let y=0;for(;o.length&&l[y]<=u;)y++;g.setStart(o[y],0),m.push({range:g,startIndex:u,isCurrent:!0})}}m.sort((u,g)=>g.startIndex>u.startIndex?-1:0).forEach((u,g)=>{typeof n=="string"&&u.isCurrent||typeof n=="number"&&n===g?(e.highlight.rangeIndex=g,e.highlight.markHL.add(u.range)):e.highlight.mark.add(u.range),e.highlight.ranges.push(u.range)}),CSS.highlights.set("search-mark-"+e.highlight.styleElement.dataset.uuid,e.highlight.mark),typeof n!="undefined"&&CSS.highlights.set("search-mark-hl-"+e.highlight.styleElement.dataset.uuid,e.highlight.markHL),a&&a()},e.wysiwyg.element.querySelector(".hljs")?p.TIMEOUT_TRANSITION:0)},na=()=>!!(CSS&&CSS.highlights),nc=e=>{var t,n;if(e){ae(["util"],e),na()&&(e.highlight.markHL.clear(),e.highlight.mark.clear(),e.highlight.ranges=[],e.highlight.rangeIndex=0),(t=e.observer)==null||t.disconnect(),(n=e.observerLoad)==null||n.disconnect(),e.element.classList.remove("protyle"),e.element.removeAttribute("style"),e.wysiwyg&&(e.wysiwyg.lastHTMLs={}),e.undo&&e.undo.clear();try{e.ws.send("closews",{})}catch(a){setTimeout(()=>{e.ws.send("closews",{})},10240)}e.app.plugins.forEach(a=>{a.eventBus.emit("destroy-protyle",{protyle:e})})}};class cp{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const up=(e,t)=>{const n=[];let a="",s="";for(let o=t.length,l=0;l<o;l++){const r=t[l];let d=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,d=!1),r.size>e.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,d=!1);const c=r.name.lastIndexOf("."),f=c===-1?"":r.name.substr(c),m=c===-1?r.name:e.options.upload.filename(r.name.substr(0,c))+f;e.options.upload.accept&&(e.options.upload.accept.split(",").some(g=>{const y=g.trim();if(y.indexOf(".")===0){if(f.toLowerCase()===y.toLowerCase())return!0}else if(r.type.split("/")[0]===y.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,d=!1)),d&&(n.push(r),s+=`<li>${m} ${window.siyuan.languages.uploading}</li>`)}let i;return(a!==""||s!=="")&&(i=se(`<ul>${a}${s}</ul>`,-1)),{files:n,msgId:i}},ac=(e,t)=>{var n,a,s;const i=JSON.parse(e);let o="";i.code===1&&(o=`${i.msg}`),i.data.errFiles&&i.data.errFiles.length>0&&(o=`<ul><li>${o}</li>`,i.data.errFiles.forEach(g=>{const y=g.lastIndexOf("."),b=y===-1?g:t.options.upload.filename(g.substr(0,y))+g.substr(y);o+=`<li>${b} ${window.siyuan.languages.uploadError}</li>`}),o+="</ul>"),o&&se(o);let l=!0;const r=ye(t.wysiwyg.element);r.toString()===""&&r.startContainer.nodeType===3&&t.toolbar.getCurrentType(r).length>0&&(r.setEndAfter(r.startContainer.parentElement),r.collapse(!1));const d=Object.keys(i.data.succMap),c=F(r.startContainer);if(c)if(c.classList.contains("table"))l=!1;else{const g=oe(c);g&&c.classList.contains("p")&&(g.textContent!==""||d.length<2)&&(l=!1)}let f="";d.sort((g,y)=>g.localeCompare(y,void 0,{numeric:!0}));const m=[];let u=!1;if(d.forEach((g,y)=>{const b=i.data.succMap[g],w=_e().extname(g).toLowerCase(),h=t.options.upload.filename(g),S=h.substring(0,h.length-w.length);u=p.SIYUAN_ASSETS_IMAGE.includes(w),m.push({type:p.SIYUAN_ASSETS_IMAGE.includes(w)?"image":"file",content:b,name:S}),f+=Wd(w,b,S,h),!p.SIYUAN_ASSETS_AUDIO.includes(w)&&!p.SIYUAN_ASSETS_VIDEO.includes(w)&&d.length-1!==y&&(c&&c.classList.contains("table")?f+="<br>":l?f+=`

`:f+=`
`)}),document.querySelector(".av__panel")){const g=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(g[0]||(g.splice(0,1),t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(y=>{ln(y)==="mAsset"&&g.push(y)}),g.length===0&&((a=(n=document.querySelector(".av__panel .b3-menu__items"))==null?void 0:n.getAttribute("data-ids"))==null||a.split(",").forEach(y=>{const b=t.wysiwyg.element.querySelector(`.av__gallery-fields [data-dtype="mAsset"][data-id="${y}"]`);b&&g.push(b)}))),g.length>0){const y=F(g[0]);if(y){Zt(t,y,m,g),(s=document.querySelector(".av__panel"))==null||s.remove();return}}else return}else if(c&&c.classList.contains("av")){const g=[];if(c.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(y=>{y.querySelectorAll(".av__cell").forEach(b=>{ln(b)==="mAsset"&&g.push(b)})}),g.length===0&&t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(y=>{ln(y)==="mAsset"&&g.push(y)}),g.length>0){Zt(t,c,m,g);return}else return}lt(f,t,l),setTimeout(()=>{Oe(t,void 0,"nearest","smooth")},u?0:p.TIMEOUT_LOAD)},ko=(e,t,n)=>{const a=se(window.siyuan.languages.uploading,0);L("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:n,id:t.block.rootID},s=>{tt(a);let i="";Object.keys(s.data.succMap).forEach(o=>{s.data.succMap[o].startsWith("file:")&&(i+=o+", ")}),i&&se(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${i.substring(0,i.length-2)}</b>`)),ac(JSON.stringify(s),t)})},aa=(e,t,n,a)=>{if(!e){const c=new FormData;for(let m=0,u=t.length;m<u;m++)c.append("file[]",t[m]);const f=new XMLHttpRequest;f.open("POST",p.UPLOAD_ADDRESS),f.onreadystatechange=()=>{f.readyState===XMLHttpRequest.DONE&&(f.status===200?a(f.responseText):f.status===0?se(window.siyuan.languages.fileTypeError):se(f.responseText),n&&(n.value=""))},f.send(c);return}let s=[];for(let c=0;c<t.length;c++){let f=t[c];f instanceof DataTransferItem&&(f=f.getAsFile()),f.size===0&&f.type===""&&f.name.indexOf(".")===-1?ko([f.path],e,!1):s.push(f)}if(e.options.upload.handler){const c=e.options.upload.handler(s);if(typeof c=="string"){se(c);return}return}if(!e.options.upload.url||!e.upload){n&&(n.value=""),se("please config: options.upload.url");return}if(e.options.upload.file&&(s=e.options.upload.file(s)),e.options.upload.validate){const c=e.options.upload.validate(s);if(typeof c=="string"){se(c);return}}const i=e.wysiwyg.element,o=up(e,s);if(o.files.length===0){n&&(n.value="");return}const l=new FormData,r=e.options.upload.extraData;for(const c of Object.keys(r))l.append(c,r[c]);for(let c=0,f=o.files.length;c<f;c++)l.append(e.options.upload.fieldName,o.files[c]);l.append("id",e.block.rootID);const d=new XMLHttpRequest;d.open("POST",e.options.upload.url),e.options.upload.token&&d.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(d.withCredentials=!0),e.upload.isUploading=!0,d.onreadystatechange=()=>{if(d.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element)){nc(e);return}if(d.status===200)if(tt(o.msgId),e.options.upload.success)e.options.upload.success(i,d.responseText);else if(a)a(d.responseText);else{let c=d.responseText;e.options.upload.format&&(c=e.options.upload.format(t,d.responseText)),ac(c,e)}else d.status===0?se(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(d.responseText):se(d.responseText);n&&(n.value=""),e.upload.element.style.display="none"}},d.upload.onprogress=c=>{if(!c.lengthComputable)return;const f=c.loaded/c.total*100;e.upload.element.style.display="block";const m=e.upload.element;m.style.width=f+"%"},d.send(l)},ns=(e,t,n,a=!1)=>{let s=Lute.UnEscapeHTMLStr(t),i;if(Dr(s)&&!s.startsWith("file://")&&s.indexOf(".pdf")>-1){const o=s.split("/");o.length===3&&o[0]==="assets"&&o[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(o[2])?(s=`assets/${o[1]}`,i=o[2]):(i=parseInt(bt("page",s)),s=s.split("?page")[0])}Nt(s)},ic=e=>{e.menuElement.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&aa(e.protyle,t.target.files,t.target,n=>{const a=JSON.parse(n),s=[];Object.keys(a.data.succMap).forEach(i=>{s.push({name:i,content:a.data.succMap[i],type:p.SIYUAN_ASSETS_IMAGE.includes(_e().extname(a.data.succMap[i]).toLowerCase())?"image":"file"})}),Va({protyle:e.protyle,cellElements:e.cellElements,addValue:s,blockElement:e.blockElement})})})},sc=e=>{let t="";ia("mAsset",e[0]).mAsset.forEach((a,s)=>{let i;a.type==="image"?i=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${a.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${zi(a.content)}"/>
</span>`:i=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${Ue(a.content)}" style="max-width: 360px">${a.name||a.content}</span>`,t+=`<button class="b3-menu__item" draggable="true" data-index="${s}" data-name="${Ue(a.name)}" data-type="${a.type}" data-content="${Ue(a.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${i}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`});const n=[];return e.forEach(a=>{n.push(a.dataset.id)}),`<div class="b3-menu__items" data-ids="${n}">
    ${t}
    <button data-type="addAssetExist" class="b3-menu__item b3-menu__item--current">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},Va=e=>{const t=e.blockElement.getAttribute("data-av-type"),n=rn(e.cellElements[0],t),a=[],s=[];let i;e.cellElements.forEach((l,r)=>{var d,c;const f=Tn(l,t);e.blockElement.contains(l)||(t==="table"?l=e.cellElements[r]=e.blockElement.querySelector(`.av__row[data-id="${f}"] .av__cell[data-col-id="${l.dataset.colId}"]`)||e.blockElement.querySelector(`.fn__flex-1[data-col-id="${l.dataset.colId}"]`):l=e.cellElements[r]=e.blockElement.querySelector(`.av__gallery-item[data-id="${f}"] .av__cell[data-field-id="${l.dataset.fieldId}"]`));const m=ia(ln(l)||l.dataset.type,l),u=JSON.parse(JSON.stringify(m));r===0?(typeof e.removeIndex=="number"?m.mAsset.splice(e.removeIndex,1):((d=e.addValue)==null?void 0:d.length)>0?m.mAsset=m.mAsset.concat(e.addValue):e.updateValue?m.mAsset.find((y,b)=>{if(b===e.updateValue.index)return y.content=e.updateValue.value.content,y.type=e.updateValue.value.type,y.name=e.updateValue.value.name,!0}):((c=e.replaceValue)==null?void 0:c.length)>0&&(m.mAsset=e.replaceValue),i=m.mAsset):m.mAsset=i;const g=e.blockElement.getAttribute("data-av-id");a.push({action:"updateAttrViewCell",id:m.id,keyID:n,rowID:f,avID:g,data:m}),s.push({action:"updateAttrViewCell",id:m.id,keyID:n,rowID:f,avID:g,data:u}),l.classList.contains("custom-attr__avvalue")?l.innerHTML=pa(m):Gt(l,m)}),a.push({action:"doUpdateUpdated",id:e.blockElement.getAttribute("data-node-id"),data:G().format("YYYYMMDDHHmmss")}),B(e.protyle,a,s);const o=document.querySelector(".av__panel > .b3-menu");if(o){o.innerHTML=sc(e.cellElements),ic({protyle:e.protyle,menuElement:o,cellElements:e.cellElements,blockElement:e.blockElement});const l=(e.cellElements[0].classList.contains("custom-attr__avvalue")?e.cellElements[0]:e.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${e.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{Ee(o,l.left,l.bottom,l.height)},p.TIMEOUT_LOAD)}},Js=e=>{const t=zl(e.content),n=e.type,a=new Fe(p.MENU_AV_ASSET_EDIT,()=>{!o[1]&&o[0].value===t||o[1]&&o[0].value===t&&o[1].value===e.name||Va({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,updateValue:{index:e.index,value:{content:o[0].value,name:o[1]?o[1].value:"",type:n}}})});if(a.isOpen)return;n==="file"?(a.addItem({id:"linkAndTitle",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${P()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${P()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let d=r.target;for(;d;){if(d.dataset.action==="copy"){He(d.parentElement.nextElementSibling.value),se(window.siyuan.languages.copied);break}d=d.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){He(`[${o[1].value||o[0].value}](${o[0].value})`)}})):(a.addItem({id:"link",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea rows="1" style="margin:4px 0;width: ${P()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`,bind(l){l.addEventListener("click",r=>{let d=r.target;for(;d;){if(d.dataset.action==="copy"){He(d.parentElement.nextElementSibling.value),se(window.siyuan.languages.copied);break}d=d.parentElement}})}}),a.addSeparator({id:"separator_1"}),a.addItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",click(){He(`![](${t.replace(/%20/g," ")})`)}}),a.addItem({id:"copyAsPNG",label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){Od(t)}})),a.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Va({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,removeIndex:e.index})}}),t!=null&&t.startsWith("assets/")&&a.addItem({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){var l;Bs(t),(l=document.querySelector(".av__panel"))==null||l.remove()}});const s=Xi(e.protyle?e.protyle.app:window.siyuan.ws.app,t,!0,!1);(n!=="file"||s.length>0)&&a.addSeparator({id:"separator_2"}),n!=="file"&&a.addItem({id:"cardPreview",icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){var l;Yl(t,e.blockElement.getAttribute("data-av-id"),e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),((l=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:l.value.trim())||"")}}),s.length>0&&window.siyuan.menus.menu.append(new H({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:s}).element),t!=null&&t.startsWith("assets/")&&window.siyuan.menus.menu.append(new H(Ws(t)).element);const i=e.rect;a.open({x:i.right,y:i.top,w:i.width,h:i.height});const o=a.element.querySelectorAll("textarea");o[0].value=t,o[0].focus(),o[0].select(),o.length>1&&(o[1].value=e.name)},fp=(e,t,n,a)=>{const s=new Fe(p.MENU_AV_ASSET_EDIT,()=>{const o=s.element.querySelectorAll("textarea");!o[0].value&&!o[1].value||Va({protyle:e,cellElements:t,blockElement:a,addValue:[{type:"file",name:o[1].value,content:o[0].value}]})});if(s.isOpen)return;s.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${P()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${P()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const i=n.getBoundingClientRect();s.open({x:i.right,y:i.bottom,w:n.parentElement.clientWidth+8,h:i.height}),s.element.querySelector("textarea").focus()},lc=(e,t,n)=>{const a=se(window.siyuan.languages.uploading,0);L("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:!0,id:t.block.rootID},s=>{const i=F(n);if(i){tt(a);const o=[];Object.keys(s.data.succMap).forEach(l=>{const r=_e().extname(l).toLowerCase(),d=l.substring(0,l.length-r.length);p.SIYUAN_ASSETS_IMAGE.includes(r)?o.push({type:"image",name:d,content:s.data.succMap[l]}):o.push({type:"file",name:d,content:s.data.succMap[l]})}),Va({protyle:t,blockElement:i,cellElements:[n],addValue:o})}})},gp=e=>{var t,n;let a="";const s=e[e.type];switch(e.type){case"block":e!=null&&e.isDetached?a=`<span>${((t=e.block)==null?void 0:t.content)||window.siyuan.languages.untitled}</span>`:a=`<span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext--ref">${((n=e.block)==null?void 0:n.content)||window.siyuan.languages.untitled}</span>`;break;case"text":a=e.text.content;break;case"number":a=e.number.formattedContent||e.number.content.toString();break;case"date":case"updated":case"created":s.formattedContent?a=s.formattedContent:(s&&s.isNotEmpty&&(a=G(s.content).format(s.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),s&&s.hasEndDate&&s.isNotEmpty&&s.isNotEmpty2&&(a=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${G(s.content2).format(s.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),a&&(a=`<span class="av__celltext">${a}</span>`);break;case"url":a=e.url.content?`<a class="fn__a" href="${e.url.content}" target="_blank">${e.url.content}</a>`:"";break;case"phone":a=e.phone.content?`<a class="fn__a" href="tel:${e.phone.content}" target="_blank">${e.phone.content}</a>`:"";break;case"email":a=e.email.content?`<a class="fn__a" href="mailto:${e.email.content}" target="_blank">${e.email.content}</a>`:"";break}return a},pa=e=>{var t,n,a,s,i,o,l,r;let d="";switch(e.type){case"block":d=`<input data-id="${e.block.id}" value="${Ue(e.block.content)}" type="text" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">`;break;case"text":d=`<textarea style="resize: vertical" rows="${(((t=e.text)==null?void 0:t.content)||"").split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">${((n=e.text)==null?void 0:n.content)||""}</textarea>`;break;case"number":d=`<input value="${e.number.isNotEmpty?e.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${e.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":(a=e.mSelect)==null||a.forEach((c,f)=>{e.type==="select"&&f>0||(d+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${c.color});color:var(--b3-font-color${c.color})">${pe(c.content)}</span>`)});break;case"mAsset":(s=e.mAsset)==null||s.forEach(c=>{c.type==="image"?d+=`<img loading="lazy" class="av__cellassetimg ariaLabel" aria-label="${c.content}" src="${zi(c.content)}">`:d+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${Ue(c.content)}" data-name="${Ue(c.name)}" data-url="${Ue(c.content)}">${c.name||c.content}</span>`});break;case"date":d=`<span class="av__celltext" data-value='${JSON.stringify(e[e.type])}' placeholder="${window.siyuan.languages.empty}">`,e[e.type]&&e[e.type].isNotEmpty&&(d+=G(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(d+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${G(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),d+="</span>";break;case"created":case"updated":e[e.type].isNotEmpty&&(d=`<span data-content="${e[e.type].content}">${G(e[e.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":d=`<input value="${e.url.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.url.content?`href="${e.url.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":d=`<input value="${e.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.phone.content?`href="tel:${e.phone.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":d=`<svg class="av__checkbox"><use xlink:href="#icon${e.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":d=`<div class="fn__flex-1" placeholder="${window.siyuan.languages.empty}">${e.template.content}</div>`;break;case"email":d=`<input value="${e.email.content}" class="b3-text-field b3-text-field--text fn__flex-1" placeholder="${window.siyuan.languages.empty}">
<span class="fn__space"></span>
<a ${e.email.content?`href="mailto:${e.email.content}"`:""} target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(o=(i=e==null?void 0:e.relation)==null?void 0:i.contents)==null||o.forEach((c,f)=>{if(c&&c.block){const m=e.relation.blockIDs[f];c!=null&&c.isDetached?d+=`<span data-row-id="${m}" class="av__cell--relation"><span>\u2796<span class="fn__space--5"></span></span><span class="av__celltext">${Lute.EscapeHTMLStr(c.block.content||window.siyuan.languages.untitled)}</span></span>`:d+=`<span data-row-id="${m}" class="av__cell--relation" data-block-id="${c.block.id}"><span class="b3-menu__avemoji" data-unicode="${c.block.icon||""}">${ge(c.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${c.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(c.block.content||window.siyuan.languages.untitled)}</span></span>`}}),d&&d.endsWith(", ")&&(d=d.substring(0,d.length-2));break;case"rollup":(r=(l=e==null?void 0:e.rollup)==null?void 0:l.contents)==null||r.forEach(c=>{const f=["template","select","mSelect","mAsset","checkbox","relation"].includes(c.type)?pa(c):gp(c);f&&(d+=f.replace("fn__flex-1","")+",&nbsp;")}),d&&d.endsWith(",&nbsp;")&&(d=d.substring(0,d.length-7));break}return d},So=(e,t,n,a)=>{L("/api/av/getAttributeViewKeys",{id:t},s=>{let i="";if(s.data.forEach(o=>{var l;let r=`<div class="custom-attr__avheader">
    <div class="block__logo popover__block" style="max-width:calc(100% - 40px)" data-id='${JSON.stringify(o.blockIDs)}'>
        <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__ellipsis">${o.avName||window.siyuan.languages.database}</span>
    </div>
    <div class="fn__flex-1"></div>
    <span data-type="remove" data-row-id="${o.keyValues&&o.keyValues[0].values[0].blockID}" class="block__icon block__icon--warning block__icon--show b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.removeAV}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
</div>`;(l=o.keyValues)==null||l.forEach(d=>{var c;r+=`<div class="block__icons av__row" data-id="${t}" data-col-id="${d.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${Wt(d.key.name)}<div class='ft__on-surface'>${Wt(d.key.desc)}</div>">
        ${d.key.icon?ge(d.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${gt(d.key.type)}"></use></svg>`}
        <span>${pe(d.key.name)}</span>
    </div>
    <div data-av-id="${o.avID}" data-col-id="${d.values[0].keyID}" data-row-id="${d.values[0].blockID}" data-id="${d.values[0].id}" data-type="${d.values[0].type}" 
data-options="${(c=d.key)!=null&&c.options?Ue(JSON.stringify(d.key.options)):"[]"}" 
${["text","number","date","url","phone","template","email"].includes(d.values[0].type)?"":`placeholder="${window.siyuan.languages.empty}"`}  
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(d.values[0].type)?"":" custom-attr__avvalue"}${["created","updated"].includes(d.values[0].type)?" custom-attr__avvalue--readonly":""}">${pa(d.values[0])}</div>
</div>`}),r+=`<div class="fn__hr"></div>
<button data-type="addColumn" class="b3-button b3-button--cancel"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.newCol}</button>
<div class="fn__hr--b"></div><div class="fn__hr--b"></div>`,i+=`<div data-av-id="${o.avID}" data-av-type="table" data-node-id="${t}" data-type="NodeAttributeView">${r}</div>`,e.innerHTML&&(e.querySelector(`[data-node-id="${t}"][data-av-id="${o.avID}"]`).innerHTML=r)}),e.innerHTML===""){let o;e.addEventListener("dragstart",r=>{const d=r.target;window.siyuan.dragElement=d.parentElement,window.siyuan.dragElement.style.opacity=".38",o=F(window.siyuan.dragElement);const c=document.createElement("div");c.className="block__icons",c.innerHTML=d.nextElementSibling.outerHTML,c.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(c),r.dataTransfer.setDragImage(c,0,0),setTimeout(()=>{c.remove()})}),e.addEventListener("drop",r=>{var d,c;if(l=0,n.disabled){r.preventDefault(),r.stopPropagation();return}const f=e.querySelector(".dragover__bottom, .dragover__top");if(f&&o){const m=f.classList.contains("dragover__bottom"),u=m?f.dataset.colId:(d=f.previousElementSibling)==null?void 0:d.getAttribute("data-col-id"),g=(c=window.siyuan.dragElement.previousElementSibling)==null?void 0:c.getAttribute("data-col-id");u!==g&&u!==window.siyuan.dragElement.dataset.colId&&(B(n,[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:u,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:g,id:t}]),m?f.after(window.siyuan.dragElement):f.before(window.siyuan.dragElement)),f.classList.remove("dragover__bottom","dragover__top")}else if(!window.siyuan.dragElement&&r.dataTransfer.types[0]==="Files"){const m=e.querySelector(".custom-attr__avvalue--active");if(m&&r.dataTransfer.types[0]==="Files"&&!Be()){const u=[];for(let g=0;g<r.dataTransfer.files.length;g++)u.push(webUtils.getPathForFile(r.dataTransfer.files[g]));lc(u,n,m)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("dragover",r=>{const d=r.target;let c;if(r.dataTransfer.types.includes("Files")){e.querySelectorAll(".custom-attr__avvalue--active").forEach(u=>{u.classList.remove("custom-attr__avvalue--active")}),c=C(d,"custom-attr__avvalue"),c&&c.getAttribute("data-type")==="mAsset"&&(c.classList.add("custom-attr__avvalue--active"),r.preventDefault());return}if(c=C(d,"av__row"),c||(c=C(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!c||c===window.siyuan.dragElement||!o)return;const f=F(c);if(!f||f!==o)return;r.preventDefault();const m=c.getBoundingClientRect();e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(u=>{u.classList.remove("dragover__bottom","dragover__top")}),r.clientY>m.top+m.height/2?c.classList.add("dragover__bottom"):c.classList.add("dragover__top")});let l=0;e.addEventListener("dragleave",()=>{l--,l===0&&e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragenter",r=>{r.preventDefault(),l++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("paste",r=>{var d;const c=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(c&&c.length>0)aa(n,c);else{const f=r.clipboardData.getData("text/plain"),m=r.target,u=F(m),g=O(m,"data-type","mAsset");u&&g&&f&&(Zt(n,u,f,[g],void 0,n.lute.Md2BlockDOM(f)),(d=document.querySelector(".av__panel"))==null||d.remove())}}),e.addEventListener("click",r=>{const d=O(r.target,"data-type","remove");if(d){const c=F(d);c&&(B(n,[{action:"removeAttrViewBlock",srcIDs:[d.dataset.rowId],avID:c.dataset.avId},{action:"doUpdateUpdated",id:d.dataset.rowId,data:G().format("YYYYMMDDHHmmss")}]),c.remove(),e.innerHTML||window.siyuan.dialogs.find(f=>{if(f.element.getAttribute("data-key")===p.DIALOG_ATTR)return f.destroy(),!0})),r.stopPropagation();return}oc(n,e,r)}),e.addEventListener("contextmenu",r=>{oc(n,e,r)}),e.innerHTML=i}e.querySelectorAll(".b3-text-field--text").forEach(o=>{o.addEventListener("change",()=>{let l;const r=o.parentElement.dataset.type;if(["url","text","email","phone"].includes(r)){if(l={[r]:{content:o.value}},r!=="text"){const d=o.parentElement.querySelector("a");o.value?d.setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+o.value):d.removeAttribute("href")}}else r==="number"?o.value==="undefined"||!o.value?l={number:{content:null,isNotEmpty:!1}}:l={number:{content:parseFloat(o.value)||0,isNotEmpty:!0}}:r==="block"&&(l={block:{content:o.value,id:o.dataset.id},isDetached:!1});L("/api/av/setAttributeViewBlockAttr",{avID:o.parentElement.dataset.avId,keyID:o.parentElement.dataset.colId,itemID:o.parentElement.dataset.rowId,value:l},d=>{r==="number"?o.parentElement.querySelector(".fn__flex-center").textContent=d.data.value.number.formattedContent:r==="block"&&!o.value&&(o.value=d.data.value.block.content)})})}),a&&a(e)})},oc=(e,t,n)=>{let a=n.target;const s=F(a);if(s)for(;a&&t!==a;){const i=a.getAttribute("data-type");if(a.classList.contains("b3-menu__avemoji")){const o=a.getBoundingClientRect();return ha(a.nextElementSibling.getAttribute("data-id"),"doc",{x:o.left,y:o.bottom,h:o.height,w:o.width},l=>{a.innerHTML=ge(l||window.siyuan.storage[p.LOCAL_IMAGES].file)},a.querySelector("img")),n.preventDefault(),n.stopPropagation(),!0}else if(a.classList.contains("av__celltext--url")||a.classList.contains("av__cellassetimg")){if(n.type==="contextmenu"||!a.dataset.url&&a.tagName!=="IMG"){let o=0;Array.from(a.parentElement.children).find((l,r)=>{if(l===a)return o=r,!0}),Js({protyle:e,cellElements:[a.parentElement],blockElement:F(a),content:a.tagName==="IMG"?a.getAttribute("src"):a.getAttribute("data-url"),type:a.tagName==="IMG"?"image":"file",name:a.tagName==="IMG"?"":a.getAttribute("data-name"),index:o,rect:a.getBoundingClientRect()})}else a.tagName==="IMG"?Ns([a.getAttribute("src")]):ns(e,a.dataset.url,n,n.ctrlKey||n.metaKey);n.stopPropagation(),n.preventDefault();break}else if(i==="date"){on(e,[a],"date"),n.stopPropagation(),n.preventDefault();break}else if(i==="select"||i==="mSelect"){on(e,[a],a.getAttribute("data-type")),n.stopPropagation(),n.preventDefault();break}else if(i==="mAsset"){t.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(o=>{o.removeAttribute("data-active")}),a.setAttribute("data-active","true"),a.focus(),on(e,[a],"mAsset"),n.stopPropagation(),n.preventDefault();break}else if(i==="checkbox"){on(e,[a],"checkbox"),n.stopPropagation(),n.preventDefault();break}else if(i==="relation"){on(e,[a],"relation"),n.stopPropagation(),n.preventDefault();break}else if(i==="template"){on(e,[a],"template"),n.stopPropagation(),n.preventDefault();break}else if(i==="rollup"){on(e,[a],"rollup"),n.stopPropagation(),n.preventDefault();break}else if(i==="addColumn"){const o=s.querySelectorAll(".av__row"),l=os(e,s,o[o.length-1].getAttribute("data-col-id")),r=a.getBoundingClientRect();l.open({x:r.left,y:r.bottom,h:r.height}),n.stopPropagation(),n.preventDefault();break}else if(i==="editCol"){Pt({protyle:e,blockElement:s,type:"edit",colId:a.parentElement.dataset.colId}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}},rc=e=>!!e.getAttribute("data-av-id");let sn;const Ao=(e,t,n=[])=>{var a;let s="",i=!1;if(n.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(o=>{n.push(o.dataset.content)}),t){const o=((a=document.querySelector(".av__panel .b3-menu__item--current"))==null?void 0:a.getAttribute("data-name"))||"";t.forEach(l=>{if(!e||e.toLowerCase().indexOf(l.name.toLowerCase())>-1||l.name.toLowerCase().indexOf(e.toLowerCase())>-1){const r=l.desc?`${Wt(l.name)}<div class='ft__on-surface'>${Wt(l.desc||"")}</div>`:"";s+=`<button data-type="addColOptionOrCell" class="b3-menu__item${o===l.name?" b3-menu__item--current":""}" data-name="${Ue(l.name)}" data-desc="${Ue(l.desc||"")}" draggable="true" data-color="${l.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${r}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">
            <span class="fn__ellipsis">${pe(l.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${n.includes(l.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`}e===l.name&&(i=!0)})}if(!i&&e){s=s.replace('class="b3-menu__item b3-menu__item--current"','class="b3-menu__item"');const o=((t==null?void 0:t.length)||0)%14+1;s=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${e}" data-color="${o}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${o});color:var(--b3-font-color${o})">
        <span class="fn__ellipsis">${pe(e)}</span>
    </span>
</div>
<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${window.siyuan.languages.enterKey}</span>
</button>${s}`}else s.indexOf("b3-menu__item--current")===-1&&(s=s.replace('class="b3-menu__item"','class="b3-menu__item b3-menu__item--current"'));return s},Qs=(e,t,n,a)=>{if(!n)return;const s=a.getAttribute("data-av-type"),i=rn(t[0],s),o=[],l=[];let r;const d=a.getAttribute("data-av-id");t.forEach((c,f)=>{var m;const u=Tn(c,s);if(!u)return;a.contains(c)||(s==="table"?c=t[f]=a.querySelector(`.av__row[data-id="${u}"] .av__cell[data-col-id="${c.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${c.dataset.colId}"]`):c=t[f]=a.querySelector(`.av__gallery-item[data-id="${u}"] .av__cell[data-field-id="${c.dataset.fieldId}"]`));const g=sn[f],y=JSON.parse(JSON.stringify(g));f===0?((m=g.mSelect)==null||m.find((b,w)=>{if(b.content===n.dataset.content)return g.mSelect.splice(w,1),!0}),r=g.mSelect):g.mSelect=r,o.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:u,avID:d,data:g}),l.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:u,avID:d,data:y}),c.classList.contains("custom-attr__avvalue")?c.innerHTML=pa(g):Gt(c,g)}),o.push({action:"doUpdateUpdated",id:a.getAttribute("data-node-id"),data:G().format("YYYYMMDDHHmmss")}),B(e,o,l),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(c=>{var f;if(c.dataset.name===n.dataset.content)return(f=c.querySelector(".b3-menu__checked"))==null||f.remove(),!0}),n.remove()},pp=(e,t,n,a,s,i)=>{const o=C(n,"b3-menu");if(!o)return;const l=a.getAttribute("data-node-id"),r=a.getAttribute("data-av-type"),d=i&&i[0]?rn(i[0],r):o.querySelector(".b3-menu__item").getAttribute("data-col-id");let c=n.parentElement.dataset.name,f=n.parentElement.dataset.desc,m=n.parentElement.dataset.color;const u=Ge(t),g=new Fe(p.MENU_AV_COL_OPTION,()=>{if(c===w.value&&f===h.value||!w.value)return;B(e,[{action:"updateAttrViewColOption",id:d,avID:t.id,data:{newColor:m,oldName:c,newName:w.value,newDesc:h.value}},{action:"doUpdateUpdated",id:l,data:G().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOption",id:d,avID:t.id,data:{newColor:m,oldName:w.value,newName:c,newDesc:f}}]),u.find(v=>{if(v.id===d)return v.options.find(_=>{if(_.name===w.value&&_.desc===h.value)return!0})||v.options.find(_=>{if(_.name===c)return _.name=w.value,_.desc=h.value,!0}),!0});const S=o.querySelector(".b3-menu__items").scrollTop,$=o.querySelector(".b3-chips"),D=$?$.clientHeight:0;i?(i.forEach((v,k)=>{const _=Tn(v,r);r==="table"||s?v=i[k]=a.querySelector(`.av__row[data-id="${_}"] .av__cell[data-col-id="${v.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${v.dataset.colId}"]`):v=i[k]=a.querySelector(`.av__gallery-item[data-id="${_}"] .av__cell[data-field-id="${v.dataset.fieldId}"]`),sn[k].mSelect.find(E=>{if(E.content===c)return E.content=w.value,!0}),v.classList.contains("custom-attr__avvalue")?v.innerHTML=pa(sn[k]):Gt(v,sn[k])}),o.innerHTML=fi(u,i,!1,a),ui(e,t,o,i,a)):(o.innerHTML=Yn({protyle:e,data:t,colId:d,isCustomAttr:s}),Wn({protyle:e,data:t,menuElement:o,isCustomAttr:s,blockID:l})),$&&(o.querySelector(".b3-menu__items").scrollTop=S+(o.querySelector(".b3-chips").clientHeight-D))});if(g.isOpen)return;g.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div>
<div class="b3-form__icona fn__block">
    <input class="b3-text-field b3-form__icona-input" type="text" size="16">
    <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${f?Wt(f):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <textarea rows="1" placeholder="${window.siyuan.languages.addDesc}" class="b3-text-field fn__block" type="text" data-value="${Ue(f)}">${f}</textarea>
</div>
<div class="fn__hr--small"></div>`,bind(S){const $=S.querySelector("input");$.addEventListener("keydown",v=>{v.isComposing||v.key==="Enter"&&g.close()}),$.value=c;const D=S.querySelector("textarea");$.nextElementSibling.addEventListener("click",()=>{const v=D.parentElement;v.classList.toggle("fn__none"),v.classList.contains("fn__none")||D.focus()}),D.addEventListener("keydown",v=>{v.isComposing||v.key==="Enter"&&g.close()}),D.addEventListener("input",()=>{$.nextElementSibling.setAttribute("aria-label",D.value?pe(D.value):window.siyuan.languages.addDesc)})}}),g.addItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let S=[];u.find(_=>{if(_.id===d)return S=_.options,!0});const $=n.parentElement.dataset.name;B(e,[{action:"removeAttrViewColOption",id:d,avID:t.id,data:$},{action:"doUpdateUpdated",id:l,data:G().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOptions",id:d,avID:t.id,data:S}]),S.find((_,E)=>{if(_.name===$)return S.splice(E,1),!0});const D=o.querySelector(".b3-menu__items").scrollTop,v=o.querySelector(".b3-chips"),k=v?v.clientHeight:0;i?(i.forEach((_,E)=>{const A=Tn(_,r);r==="table"||s?_=i[E]=a.querySelector(`.av__row[data-id="${A}"] .av__cell[data-col-id="${_.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${_.dataset.colId}"]`):_=i[E]=a.querySelector(`.av__gallery-item[data-id="${A}"] .av__cell[data-field-id="${_.dataset.fieldId}"]`),sn[E].mSelect.find((x,I)=>{if(x.content===$)return sn[E].mSelect.splice(I,1),!0}),_.classList.contains("custom-attr__avvalue")?_.innerHTML=pa(sn[E]):Gt(_,sn[E])}),o.innerHTML=fi(u,i,!1,a),ui(e,t,o,i,a)):(o.innerHTML=Yn({protyle:e,data:t,colId:d,isCustomAttr:s}),Wn({protyle:e,data:t,menuElement:o,isCustomAttr:s,blockID:l})),v&&(o.querySelector(".b3-menu__items").scrollTop=D+(o.querySelector(".b3-chips").clientHeight-k))},void 0,!0)}}),g.addSeparator();let y='<div class="fn__flex fn__flex-wrap" style="width: 238px">';Array.from(Array(14).keys()).forEach(S=>{y+=`<button data-color="${S+1}" class="color__square${parseInt(m)===S+1?" color__square--current":""}" style="color: var(--b3-font-color${S+1});background-color: var(--b3-font-background${S+1});">A</button>`}),g.addItem({type:"empty",iconHTML:"",label:y+"</div>",bind(S){S.addEventListener("click",$=>{var D;const v=$.target;if(v.classList.contains("color__square")&&!v.classList.contains("color__square--current")){(D=S.querySelector(".color__square--current"))==null||D.classList.remove("color__square--current"),v.classList.add("color__square--current");const k=v.getAttribute("data-color");B(e,[{action:"updateAttrViewColOption",id:d,avID:t.id,data:{oldName:c,newName:w.value,oldColor:m,newColor:k,newDesc:h.value}},{action:"doUpdateUpdated",id:l,data:G().format("YYYYMMDDHHmmss")}],[{action:"updateAttrViewColOption",id:d,avID:t.id,data:{oldName:w.value,newName:c,oldColor:k,newColor:m,newDesc:h.value}}]),u.find(E=>{if(E.id===d)return E.options.find(A=>{if(A.name===c)return A.name=w.value,A.color=k,!0}),!0});const _=o.querySelector(".b3-menu__items").scrollTop;i?(i.forEach((E,A)=>{const x=Tn(E,r);r==="table"?E=i[A]=a.querySelector(`.av__row[data-id="${x}"] .av__cell[data-col-id="${E.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${E.dataset.colId}"]`):E=i[A]=a.querySelector(`.av__gallery-item[data-id="${x}"] .av__cell[data-field-id="${E.dataset.fieldId}"]`),sn[A].mSelect.find(I=>{if(I.content===c)return I.content=w.value,I.color=k,!0}),E.classList.contains("custom-attr__avvalue")?E.innerHTML=pa(sn[A]):Gt(E,sn[A])}),o.innerHTML=fi(u,i,!1,a),ui(e,t,o,i,a)):(o.innerHTML=Yn({protyle:e,data:t,colId:d,isCustomAttr:s}),Wn({protyle:e,data:t,menuElement:o,isCustomAttr:s,blockID:l})),o.querySelector(".b3-menu__items").scrollTop=_,c=w.value,f=h.value,m=k}})}});const b=n.getBoundingClientRect();g.open({x:b.right,y:b.bottom,w:b.width,h:b.height});const w=window.siyuan.menus.menu.element.querySelector("input");w.select();const h=window.siyuan.menus.menu.element.querySelector("textarea")},ui=(e,t,n,a,s)=>{const i=n.querySelector("input"),o=rn(a[0],s.getAttribute("data-av-type"));let l;Ge(t).find(d=>{if(d.id===o){l=d;return}}),l.options||(l.options=[]);const r=n.lastElementChild.lastElementChild;i.addEventListener("input",d=>{d.isComposing||(r.innerHTML=Ao(i.value,l.options))}),i.addEventListener("compositionend",()=>{r.innerHTML=Ao(i.value,l.options)}),i.addEventListener("keydown",d=>{if(d.isComposing)return;let c=Vt(r,d,"b3-menu__item--current",r.firstElementChild);d.key==="Enter"?(c||(c=n.querySelector(".b3-menu__item--current")),c.querySelector(".b3-menu__checked")?Qs(e,a,n.querySelector(`.b3-chips .b3-chip[data-content="${Ue(c.dataset.name)}"]`),s):dc(e,t,a,c,n,s)):d.key==="Backspace"&&i.value===""&&Qs(e,a,i.previousElementSibling,s)})},dc=(e,t,n,a,s,i)=>{let o=!1;if(Array.from(s.querySelectorAll(".b3-chips .b3-chip")).find(g=>{if(g.dataset.content===a.dataset.name)return o=!0,!0}),o){s.querySelector("input").focus();return}F(n[0])||n.forEach((g,y)=>{const b=Tn(g,t.viewType);t.viewType==="table"||rc(g)?n[y]=i.querySelector(`.av__row[data-id="${b}"] .av__cell[data-col-id="${g.dataset.colId}"]`)||i.querySelector(`.fn__flex-1[data-col-id="${g.dataset.colId}"]`):n[y]=i.querySelector(`.av__gallery-item[data-id="${b}"] .av__cell[data-field-id="${g.dataset.fieldId}"]`)});const r=rn(n[0],i.getAttribute("data-av-type"));let d;const c=Ge(t);c.find(g=>{if(g.id===r){d=g,d.options||(d.options=[]);return}});const f=[],m=[];let u;if(n.forEach((g,y)=>{const b=Tn(g,t.viewType);if(!b)return;const w=sn[y],h=JSON.parse(JSON.stringify(w));if(y===0){if(d.type==="mSelect"){let S=!1;w.mSelect.find($=>{if($.content===a.dataset.name)return S=!0,!0}),S||w.mSelect.push({color:a.dataset.color,content:a.dataset.name})}else w.mSelect=[{color:a.dataset.color,content:a.dataset.name}];u=w.mSelect}else w.mSelect=u;f.push({action:"updateAttrViewCell",id:w.id,keyID:r,rowID:b,avID:t.id,data:w}),m.push({action:"updateAttrViewCell",id:w.id,keyID:r,rowID:b,avID:t.id,data:h}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=pa(w):Gt(g,w)}),a.querySelector(".b3-menu__accelerator")?(d.options.push({color:a.dataset.color,name:a.dataset.name}),f.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:t.id,data:d.options}),f.push({action:"doUpdateUpdated",id:i.getAttribute("data-node-id"),data:G().format("YYYYMMDDHHmmss")}),B(e,f,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:a.dataset.name}])):(f.push({action:"doUpdateUpdated",id:i.getAttribute("data-node-id"),data:G().format("YYYYMMDDHHmmss")}),B(e,f,m)),d.type==="select")i.setAttribute("data-rendering","true"),s.parentElement.dispatchEvent(new CustomEvent("click",{detail:"close"}));else{const g=s.querySelector(".b3-menu__items").scrollTop,y=s.querySelector(".b3-chips").clientHeight;s.innerHTML=fi(c,n,!1,i),ui(e,t,s,n,i),s.querySelector("input").focus(),s.querySelector(".b3-menu__items").scrollTop=g+(s.querySelector(".b3-chips").clientHeight-y)}},fi=(e,t,n=!1,a)=>{var s;if(n){sn=[];const d=t[0].classList.contains("custom-attr__avvalue");t.forEach(c=>{sn.push(ia(d?c.dataset.type:ln(c),c))})}const i=rn(t[0],a.getAttribute("data-av-type")),o=e.find(d=>{if(d.id===i)return d});let l="";const r=[];return(s=sn[0].mSelect)==null||s.forEach(d=>{r.push(d.content),l+=`<div class="b3-chip b3-chip--middle" data-content="${Ue(d.content)}" style="white-space: nowrap;max-width:100%;background-color:var(--b3-font-background${d.color});color:var(--b3-font-color${d.color})"><span class="fn__ellipsis">${pe(d.content)}</span><svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${l}
    <input>
</div>
<div>${Ao("",o.options,r)}</div>
</div>`},mp=(e,t,n)=>{const a=[],s=[];return t.mSelect.forEach(i=>{var o;if(e.options||(e.options=[]),!e.options.find(r=>{if(r.name===i.content)return i.color=r.color,!0})){const r=((((o=e.options)==null?void 0:o.length)||0)%14+1).toString();e.options.push({name:i.content,color:r}),i.color=r,a.push({action:"updateAttrViewColOptions",id:e.id,avID:n,data:e.options}),s.push({action:"removeAttrViewColOption",id:e.id,avID:n,data:i.content})}}),{doOperations:a,undoOperations:s}},bp=e=>{const t=new Fe(p.MENU_AV_ADD_SORT),n=Ge(e.data);n.forEach(a=>{let s=!1;a.type==="lineNumber"?s=!0:e.data.view.sorts.find(i=>{if(i.column===a.id)return s=!0,!0}),s||t.addItem({label:a.name,iconHTML:a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(a.type)}"></use></svg>`,click:()=>{const i=Object.assign([],e.data.view.sorts);e.data.view.sorts.push({column:a.id,order:"ASC"}),B(e.protyle,[{action:"setAttrViewSorts",avID:e.data.id,data:e.data.view.sorts,blockID:e.blockID}],[{action:"setAttrViewSorts",avID:e.data.id,data:i,blockID:e.blockID}]),e.menuElement.innerHTML=pi(n,e.data.view.sorts),gi(e.protyle,e.menuElement,e.data,e.blockID),Ee(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height)}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},gi=(e,t,n,a)=>{t.querySelectorAll("select").forEach(s=>{s.addEventListener("change",()=>{const i=s.parentElement.getAttribute("data-id"),o=JSON.parse(JSON.stringify(n.view.sorts));s.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(l=>{if(l.column===i)return l.column=s.value,s.parentElement.setAttribute("data-id",s.value),!0}):n.view.sorts.find(l=>l.column===i).order=s.value,B(e,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts,blockID:a}],[{action:"setAttrViewSorts",avID:n.id,data:o,blockID:a}])})})},pi=(e,t)=>{let n="";const a=s=>{let i="";return e.forEach(o=>{i+=`<option value="${o.id}" ${o.id===s?"selected":""}>${o.icon&&ge(o.icon)}${o.name}</option>`}),i};return t.forEach(s=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${s.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select fn__flex-1" style="margin: 4px 0">
        ${a(s.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${s.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${s.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${t.length===e.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addSort}</span>
</button>
<button class="b3-menu__item b3-menu__item--warning${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeSorts}</span>
</button>
</div>`},yp=e=>{const t=ia("date",e[0]).date,n=t.isNotTime;let a="";const s=new Date().getTime();if(t.isNotEmpty){a=G(t.content).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const o=a.split("-")[0];o.length!==4&&(a=new Array(4-o.length).fill(0).join("")+a)}else a=G(s).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let i="";if(t.isNotEmpty2){i=G(t.content2).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");const o=i.split("-")[0];o.length!==4&&(i=new Array(4-o.length).fill(0).join("")+i)}else t.hasEndDate&&(i=G(s).format(n?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));return`<div class="b3-menu__items">
<div>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${a}" data-value="${G(t.content||s).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${n?"date":"datetime-local"}" max="${n?"9999-12-31":"9999-12-31 23:59"}" value="${i}" data-value="${t.isNotEmpty2?G(t.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${t.hasEndDate?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${t.hasEndDate?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${n?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},wp=e=>{const t=e.menuElement.querySelectorAll("input");return t.forEach(n=>{n.addEventListener("keydown",a=>{var s;a.isComposing||a.key==="Enter"&&(Zt(e.protyle,e.blockElement,{content:el(t[0].dataset.value)||0,isNotEmpty:t[0].value!=="",content2:el(t[1].dataset.value)||0,isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements),(s=document.querySelector(".av__panel"))==null||s.dispatchEvent(new CustomEvent("click",{detail:"close"})))})}),t[0].addEventListener("change",()=>{t[0].dataset.value=t[0].value.length>10?t[0].value:t[0].value+" 00:00"}),t[1].addEventListener("change",()=>{t[1].dataset.value=t[1].value.length>10?t[1].value:t[1].value+" 00:00"}),t[2].addEventListener("change",()=>{if(t[2].checked){if(!t[1].dataset.value){const n=new Date().getTime();t[1].dataset.value=G(n).format("YYYY-MM-DD HH:mm"),t[1].value=G(n).format(t[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}t[1].classList.remove("fn__none")}else t[1].classList.add("fn__none")}),t[3].addEventListener("change",()=>{t[0].value="",t[1].value="",t[3].checked?(t[0].setAttribute("type","datetime-local"),t[1].setAttribute("type","datetime-local"),t[0].setAttribute("max","9999-12-31 23:59"),t[1].setAttribute("max","9999-12-31 23:59"),t[0].value=t[0].dataset.value,t[1].value=t[1].dataset.value):(t[0].setAttribute("type","date"),t[1].setAttribute("type","date"),t[0].setAttribute("max","9999-12-31"),t[1].setAttribute("max","9999-12-31"),t[0].value=t[0].dataset.value.substring(0,10),t[1].value=t[1].dataset.value.substring(0,10))}),()=>{Zt(e.protyle,e.blockElement,{content:el(t[0].dataset.value)||0,isNotEmpty:t[0].value!=="",content2:el(t[1].dataset.value)||0,isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}},el=e=>{const t=e.split("-")[0],n=new Date(e);return(t.startsWith("00")||t.startsWith("000")||t.length<3)&&n.setFullYear(parseInt(t)),n.getTime()},Ct=e=>{e.menu.addItem({iconHTML:"",label:cc(e.format),click(){B(e.protyle,[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.oldFormat,type:"number"}]),e.avPanelElement.remove()}})},_p=e=>{const t=new Fe(p.MENU_AV_COL_FORMAT_NUMBER);Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"commas",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"percent",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"USD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"CNY",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"EUR",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"GBP",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"JPY",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"RUB",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"INR",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"KRW",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"CAD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"CHF",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"THB",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"AUD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"HKD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"TWD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"MOP",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"SGD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),Ct({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"NZD",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},cc=e=>e===""?window.siyuan.languages.numberFormatNone:e==="commas"?window.siyuan.languages.numberFormatCommas:e==="percent"?window.siyuan.languages.numberFormatPercent:window.siyuan.languages["numberFormat"+e],uc=(e,t)=>{var n,a;if(t.classList.contains("b3-list--empty"))return;e.target.querySelector(".b3-menu__accelerator").textContent=t.querySelector(".b3-list-item__text").textContent;const s=Ge(e.data).find(o=>{if(o.id===e.colId)return o.rollup||(o.rollup={}),!0});if(e.isRelation){if(t.dataset.colId===((n=s.rollup)==null?void 0:n.relationKeyID))return;s.rollup={relationKeyID:t.dataset.colId};const o=e.target.nextElementSibling;o.querySelector(".b3-menu__accelerator").textContent="",o.setAttribute("data-av-id",t.dataset.targetAvId);const l=o.nextElementSibling;l.removeAttribute("data-col-type"),l.removeAttribute("data-calc"),l.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(t.dataset.colId===((a=s.rollup)==null?void 0:a.keyID))return;s.rollup.keyID=t.dataset.colId,delete s.rollup.calc;const o=e.target.nextElementSibling;o.removeAttribute("data-calc"),o.setAttribute("data-col-type",t.dataset.colType),o.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const i=JSON.parse(JSON.stringify(s.rollup));B(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:s.rollup.relationKeyID,keyID:s.rollup.keyID,data:{calc:s.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:i.relationKeyID,keyID:i.keyID,data:{calc:i.calc}}])},fc=(e,t,n,a,s)=>{if(!a&&!n){se(window.siyuan.languages.selectRelation);return}L(a?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewRollupDestKeys",{avID:n,keyword:t},i=>{let o="";i.data.keys.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${l.id}" ${a?`data-target-av-id="${l.relation.avID}"`:`data-col-type="${l.type}"`}>
        ${l.icon?ge(l.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${gt(l.type)}"></use></svg>`}
        <span class="b3-list-item__text">${pe(l.name||window.siyuan.languages.title)}</span>
</div>`}),e.innerHTML=o||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,s&&s()})},gc=e=>{window.siyuan.menus.menu.remove();const t=new Fe;t.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[e.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const a=n.querySelector(".b3-list"),s=n.querySelector("input");s.addEventListener("keydown",i=>{if(i.isComposing)return;Vt(a,i)&&i.stopPropagation(),i.key==="Enter"&&(i.preventDefault(),i.stopPropagation(),uc(e,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),s.addEventListener("input",i=>{i.stopPropagation(),fc(a,s.value,e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation)}),n.lastElementChild.addEventListener("click",i=>{const o=C(i.target,"b3-list-item");o&&(i.stopPropagation(),uc(e,o),window.siyuan.menus.menu.remove())}),fc(a,"",e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation,()=>{const i=e.target.getBoundingClientRect();t.open({x:i.left,y:i.bottom,h:i.height}),n.querySelector("input").focus()})}}),t.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},pc=e=>{var t,n;let a;return e.colData?a=e.colData:Ge(e.data).find(s=>{if(s.id===rn(e.cellElements[0],e.data.viewType))return a=s,!0}),`<button class="b3-menu__item b3-menu__item--current" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(a.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${Wl((n=(t=a.rollup)==null?void 0:t.calc)==null?void 0:n.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},mc=e=>{const t=e.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(t){const n=JSON.parse(t.dataset.oldValue),a=e.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let s="";n.relationKeyID&&Ge(e.data).find(i=>{if(i.id===n.relationKeyID)return t.querySelector(".b3-menu__accelerator").textContent=i.name,s=i.relation.avID,a.dataset.avId=s,!0}),n.keyID&&s&&L("/api/av/getAttributeView",{id:s},i=>{i.data.av.keyValues.find(o=>{if(o.key.id===n.keyID){a.querySelector(".b3-menu__accelerator").textContent=o.key.name;const l=e.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return l.dataset.colType=o.key.type,n.calc&&(l.dataset.calc=n.calc.operator),!0}})})}};var hp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const bc=e=>{var t;let n="";const a=e.view;if(["gallery","kanban"].includes(e.viewType)){let s="";a.coverFrom===0?s=window.siyuan.languages.calcOperatorNone:a.coverFrom===1?s=window.siyuan.languages.contentImage:a.coverFrom===3?s=window.siyuan.languages.contentBlock:a.fields.find(i=>{if(i.type==="mAsset"&&i.id===a.coverFromAssetKeyID)return s=i.name,!0}),n=`<button class="b3-menu__item" data-type="set-gallery-cover">
    <span class="fn__flex-center">${window.siyuan.languages.cardPreview1}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${s}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-gallery-ratio">
    <span class="fn__flex-center">${window.siyuan.languages.cardAspectRatio}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${Gl(a.cardAspectRatio)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-gallery-size">
    <span class="fn__flex-center">${window.siyuan.languages.cardSize}</span>
    <span class="fn__flex-1"></span>
    <span class="b3-menu__accelerator">${a.cardSize===0?window.siyuan.languages.small:a.cardSize===1?window.siyuan.languages.medium:window.siyuan.languages.large}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fitImage}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-gallery-fit" type="checkbox" class="b3-switch b3-switch--menu" ${a.fitImage?"checked":""}>
</label>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.displayFieldName}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-gallery-name" type="checkbox" class="b3-switch b3-switch--menu" ${a.displayFieldName?"checked":""}>
</label>`}return n=`<div class="b3-menu__items">
    <button class="b3-menu__item" data-type="nobg">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.layout}</span>
    </button>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="nobg">
        <div class="av__layout">
            <div data-type="set-layout" data-view-type="table" class="av__layout-item${e.viewType==="table"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconTable"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.table}</div>
            </div>
            <div data-type="set-layout" data-view-type="kanban" class="av__layout-item${e.viewType==="kanban"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconBoard"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.kanban}</div>
            </div>
            <div data-type="set-layout" data-view-type="gallery" class="av__layout-item${e.viewType==="gallery"?" av__layout-item--select":""}">
                <svg><use xlink:href="#iconGallery"></use></svg>
                <div class="fn__hr"></div>
                <div>${window.siyuan.languages.gallery}</div>
            </div>
        </div>
    </button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${a.hideAttrViewName?"":"checked"}>
    </label>
    ${n}
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.showAllEntriesIcons}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-entries-icons" type="checkbox" class="b3-switch b3-switch--menu" ${a.showIcon?"checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.wrapAllFields}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="toggle-entries-wrap" type="checkbox" class="b3-switch b3-switch--menu" ${a.wrapField?"checked":""}>
    </label>`,e.viewType==="kanban"&&["select","mSelect"].includes((t=e.view.groups[0].groupValue)==null?void 0:t.type)&&(n+=`<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.useBackground}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-kanban-bg" type="checkbox" class="b3-switch b3-switch--menu" ${a.fillColBackgroundColor?"checked":""}>
</label>`),n+`<button class="b3-menu__item" data-type="set-page-size" data-size="${a.pageSize}">
        <span class="fn__flex-center">${window.siyuan.languages.entryNum}</span>
        <span class="fn__flex-1"></span>
        <span class="b3-menu__accelerator">${a.pageSize===p.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:a.pageSize}</span>
        <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
    </button>
</div>`},yc=e=>{const t=e.blockElement.getAttribute("data-av-id"),n=e.blockElement.getAttribute("data-node-id"),a=e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),s=e.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');s.addEventListener("change",()=>{const c=s.checked;B(e.protyle,[{action:"hideAttrViewName",avID:t,blockID:n,data:!c,viewID:a}],[{action:"hideAttrViewName",avID:t,blockID:n,data:c,viewID:a}]),e.data.view.hideAttrViewName=!c});const i=e.menuElement.querySelector('.b3-switch[data-type="toggle-entries-icons"]');i.addEventListener("change",()=>{const c=i.checked;B(e.protyle,[{action:"setAttrViewShowIcon",avID:t,blockID:n,data:c,viewID:a}],[{action:"setAttrViewShowIcon",avID:t,blockID:n,data:!c,viewID:a}]),e.data.view.showIcon=c});const o=e.menuElement.querySelector('.b3-switch[data-type="toggle-entries-wrap"]');if(o.addEventListener("change",()=>{const c=o.checked;B(e.protyle,[{action:"setAttrViewWrapField",avID:t,blockID:n,data:c,viewID:a}],[{action:"setAttrViewWrapField",avID:t,blockID:n,data:!c,viewID:a}]),Ge(e.data).forEach(f=>{f.wrap=c}),e.data.view.wrapField=c}),e.data.viewType==="table")return;const l=e.menuElement.querySelector('.b3-switch[data-type="toggle-gallery-fit"]');l.addEventListener("change",()=>{const c=l.checked;B(e.protyle,[{action:"setAttrViewFitImage",avID:t,blockID:n,data:c,viewID:a}],[{action:"setAttrViewFitImage",avID:t,blockID:n,data:!c,viewID:a}]),e.data.view.fitImage=c});const r=e.menuElement.querySelector('.b3-switch[data-type="toggle-gallery-name"]');if(r.addEventListener("change",()=>{const c=r.checked;B(e.protyle,[{action:"setAttrViewDisplayFieldName",avID:t,blockID:n,data:c}],[{action:"setAttrViewDisplayFieldName",avID:t,blockID:n,data:!c}]),e.data.view.displayFieldName=c}),e.data.viewType==="gallery")return;const d=e.menuElement.querySelector('.b3-switch[data-type="toggle-kanban-bg"]');d.addEventListener("change",()=>{const c=d.checked;B(e.protyle,[{action:"setAttrViewFillColBackgroundColor",avID:t,blockID:n,data:c,viewID:a}],[{action:"setAttrViewFillColBackgroundColor",avID:t,blockID:n,data:!c,viewID:a}]),e.data.view.fillColBackgroundColor=c})},vp=e=>hp(void 0,null,function*(){if(e.target.classList.contains("av__layout-item--select")||e.target.dataset.load==="true")return;e.target.dataset.load="true",e.target.parentElement.querySelector(".av__layout-item--select").classList.remove("av__layout-item--select"),e.target.classList.add("av__layout-item--select");const t=yield he("/api/av/changeAttrViewLayout",{blockID:e.nodeElement.getAttribute("data-node-id"),avID:e.nodeElement.getAttribute("data-av-id"),layoutType:e.target.getAttribute("data-view-type")}),n=document.querySelector(".av__panel").lastElementChild;return n.innerHTML=bc(t.data),yc({protyle:e.protyle,data:t.data,menuElement:n,blockElement:e.nodeElement}),e.target.removeAttribute("data-load"),t.data});var as=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const tl=e=>{const t={};let n;return e.querySelectorAll(".av__body").forEach(a=>{const s=a.dataset.groupId,i=parseInt(a.dataset.pageSize);s?t[s]={pageSize:i}:n||(n=i)}),{groupPageSize:t,unGroupPageSize:n}},Ep=e=>as(void 0,null,function*(){const t=e.blockElement.getAttribute("data-node-id"),n=Ge(e.data).find(o=>o.id===e.fieldId),a=n?{field:e.fieldId,method:n.type==="number"?1:["date","updated","created"].includes(n.type)?2:0,order:0,range:n.type==="number"?{numStart:0,numEnd:1e3,numStep:100}:null,hideEmpty:!0}:{field:null,method:null,order:null,range:null,hideEmpty:null},s=yield he("/api/av/setAttrViewGroup",{blockID:t,avID:e.blockElement.getAttribute("data-av-id"),group:a});e.data.view=s.data.view,e.menuElement.innerHTML=mi(Ge(e.data),e.data.view),ss({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const i=e.blockElement.querySelector(".av__views").getBoundingClientRect();Ee(e.menuElement,i.right-e.menuElement.clientWidth,i.bottom,i.height)}),wc=(e,t,n)=>{const a='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>';let s=n==="kanban"?"":`<button class="b3-menu__item" data-type="setGroupMethod">
    <div class="b3-menu__label">${window.siyuan.languages.calcOperatorNone}</div>
    ${!t||!t.field?a:""}
</button>`;return e.forEach(i=>{["rollup","mAsset","lineNumber"].includes(i.type)||(s+=`<button class="b3-menu__item" data-id="${i.id}" data-type="setGroupMethod">
    <div class="b3-menu__label fn__flex">
        ${i.icon?ge(i.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(i.type)}"></use></svg>`}
        ${pe(i.name)||"&nbsp;"}
    </div>
    ${(t==null?void 0:t.field)===i.id?a:""}
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="${!t||!t.field?"go-config":"goGroups"}">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.groupMethod}</span>
</button>
<button class="b3-menu__separator"></button>
${s}
</div>`},is=(e,t)=>{if(t==="sort")switch(e){case 0:return window.siyuan.languages.asc;case 1:return window.siyuan.languages.desc;case 2:return window.siyuan.languages.customSort;case 3:return window.siyuan.languages.sortBySelectOption;default:return""}else if(t==="date")switch(e){case 2:return window.siyuan.languages.groupMethodDateRelative;case 3:return window.siyuan.languages.groupMethodDateDay;case 4:return window.siyuan.languages.groupMethodDateWeek;case 5:return window.siyuan.languages.groupMethodDateMonth;case 6:return window.siyuan.languages.groupMethodDateYear;default:return""}},kp=e=>{var t,n,a;return`<div class="b3-menu__items">
    <button class="b3-menu__item" data-type="nobg">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goGroups">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.numberFormatNone}</span>
    </button>
    <button class="b3-menu__separator"></button>
    <div class="b3-menu__item" data-type="nobg">
        <div class="fn__block">
            <div class="b3-menu__labels">${window.siyuan.languages.groupRange}</div>
            <div class="fn__flex">
                <input data-type="avGroupRange" class="b3-text-field fn__flex-1" value="${((t=e==null?void 0:e.range)==null?void 0:t.numStart)||0}">
                <span class="fn__space"></span>-<span class="fn__space"></span>
                <input class="b3-text-field fn__flex-1" value="${((n=e==null?void 0:e.range)==null?void 0:n.numEnd)||1e3}">            
            </div>
            <div class="fn__hr"></div>
            <div class="b3-menu__labels">${window.siyuan.languages.groupStep}</div>
            <input class="b3-text-field fn__block" value="${((a=e==null?void 0:e.range)==null?void 0:a.numStep)||100}">
            <div class="fn__hr--small"></div>
        </div>
    </div>
</div>`},Sp=e=>()=>as(void 0,null,function*(){if(!e.menuElement.querySelector('[data-type="avGroupRange"]'))return;const t=e.blockElement.getAttribute("data-node-id"),n=e.menuElement.querySelectorAll("input"),a={numStart:n[0].value?parseFloat(n[0].value):e.data.view.group.range.numStart,numEnd:n[1].value?parseFloat(n[1].value):e.data.view.group.range.numEnd,numStep:n[2].value?parseFloat(n[2].value):e.data.view.group.range.numStep};if(Ht(e.data.view.group.range,a))return;Object.assign(e.data.view.group.range,a);const s=yield he("/api/av/setAttrViewGroup",{blockID:t,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=s.data.view}),mi=(e,t)=>{var n;let a="",s;if(t.group&&t.group.field){let i="";if(s=e.find(o=>o.id===t.group.field),((n=t.groups)==null?void 0:n.length)>0){const o=["created","date","created","updated"].includes(s.type);let l=0;t.groups.forEach(r=>{var d,c,f;r.groupHidden===0&&l++;let m=`<div class="b3-menu__label fn__flex-1 fn__ellipsis">${r.name||""}</div>`;((c=(d=r.groupValue)==null?void 0:d.mSelect)==null?void 0:c.length)>0?m=`<div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${r.groupValue.mSelect[0].color});color:var(--b3-font-color${r.groupValue.mSelect[0].color})">
            <span class="fn__ellipsis">${pe(r.groupValue.mSelect[0].content)}</span>
        </span>
    </div>`:((f=r.groupValue)==null?void 0:f.type)=="checkbox"&&(m=`<div class="b3-menu__label fn__flex">
<svg class="b3-menu__icon"><use xlink:href="#icon${r.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg> ${s.name||""}
</div>`),i+=`<button class="b3-menu__item${r.groupHidden===0?"":" b3-menu__item--hidden"}" draggable="${o?"false":"true"}" data-id="${r.id}">
    ${o?"":'<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>'}
    ${m}
    <svg class="b3-menu__action b3-menu__action--show" data-type="hideGroup" data-id="${r.id}"><use xlink:href="#iconEye${r.groupHidden===0?"":"off"}"></use></svg>
</button>`}),i=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label"></span>
    <span class="block__icon" data-type="hideGroups">
        ${window.siyuan.languages[l===0?"showAll":"hideAll"]}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye${l===0?"":"off"}"></use></svg>
    </span>
</button>`+i}a=`<button class="b3-menu__item${["date","updated","created"].includes(s.type)?"":" fn__none"}" data-type="goGroupsDate">
    <span class="b3-menu__label">${window.siyuan.languages.date}</span>
    <span class="b3-menu__accelerator">${is(t.group.method,"date")}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item${s.type==="number"?"":" fn__none"}" data-type="getGroupsNumber">
    <span class="b3-menu__label">${window.siyuan.languages.numberFormatNone}</span>
    <span class="b3-menu__accelerator">${t.group.range&&typeof t.group.range.numStart=="number"?`${t.group.range.numStart} - ${t.group.range.numEnd}`:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item${["checkbox","rollup","mAsset"].includes(s.type)?" fn__none":""}" data-type="goGroupsSort">
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${is(t.group.order,"sort")}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.hideEmptyGroup}</span>
    <span class="fn__space fn__flex-1"></span>
    <input type="checkbox" class="b3-switch b3-switch--menu"${t.group.hideEmpty?" checked":""}>
</label>
${i}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item b3-menu__item--warning" data-type="removeGroups">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeGroup}</span>
</button>`}return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.group}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="goGroupsMethod">
    <span class="b3-menu__label">${window.siyuan.languages.groupMethod}</span>
    <span class="b3-menu__accelerator">${s?s.name:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
${a}
</div>`},ss=e=>{const t=e.menuElement.querySelector("input");if(!t)return;const n=e.blockElement.getAttribute("data-node-id");t.addEventListener("change",()=>as(void 0,null,function*(){e.data.view.group.hideEmpty=t.checked;const a=yield he("/api/av/setAttrViewGroup",{blockID:n,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=a.data.view,e.menuElement.innerHTML=mi(Ge(e.data),e.data.view),ss({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const s=e.blockElement.querySelector(".av__views").getBoundingClientRect();Ee(e.menuElement,s.right-e.menuElement.clientWidth,s.bottom,s.height)}))},Ap=e=>{const t=new Fe(p.MENU_AV_GROUP_DATE);if(t.isOpen)return;const n=e.blockElement.getAttribute("data-node-id");[2,3,4,5,6].forEach(s=>{const i=is(s,"date");t.addItem({iconHTML:"",checked:e.data.view.group.method===s,label:i,click(){return as(this,null,function*(){e.data.view.group.method=s,e.target.querySelector(".b3-menu__accelerator").textContent=i;const o=yield he("/api/av/setAttrViewGroup",{blockID:n,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=o.data.view,e.menuElement.innerHTML=mi(Ge(e.data),e.data.view),ss({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const l=e.blockElement.querySelector(".av__views").getBoundingClientRect();Ee(e.menuElement,l.right-e.menuElement.clientWidth,l.bottom,l.height)})}})});const a=e.target.getBoundingClientRect();t.open({isLeft:!0,x:a.right,y:a.bottom})},Lp=e=>{const t=new Fe(p.MENU_AV_GROUP_SORT);if(t.isOpen)return;const n=e.blockElement.getAttribute("data-node-id"),a=Ge(e.data).find(i=>i.id===e.data.view.group.field);(["created","date","created","updated"].includes(a.type)?[0,1]:["mSelect","select"].includes(a.type)?[3,2,0,1]:[2,0,1]).forEach(i=>{const o=is(i,"sort");t.addItem({iconHTML:"",checked:e.data.view.group.order===i,label:o,click(){return as(this,null,function*(){e.target.querySelector(".b3-menu__accelerator").textContent=o,e.data.view.group.order=i;const l=yield he("/api/av/setAttrViewGroup",{blockID:n,avID:e.blockElement.getAttribute("data-av-id"),group:e.data.view.group});e.data.view=l.data.view,e.menuElement.innerHTML=mi(Ge(e.data),e.data.view),ss({protyle:e.protyle,menuElement:e.menuElement,blockElement:e.blockElement,data:e.data});const r=e.blockElement.querySelector(".av__views").getBoundingClientRect();Ee(e.menuElement,r.right-e.menuElement.clientWidth,r.bottom,r.height)})}})});const s=e.target.getBoundingClientRect();t.open({isLeft:!0,x:s.right,y:s.bottom})};var xp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Pt=e=>{var t;let n=document.querySelector(".av__panel");if(n){n.remove();return}const a=e.blockElement.getAttribute("data-av-id"),s=tl(e.blockElement);L("/api/av/renderAttributeView",{id:a,query:((t=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:t.value.trim())||"",pageSize:s.unGroupPageSize,groupPaging:s.groupPageSize,viewID:e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW)},i=>{var o;if(n=document.querySelector(".av__panel"),n){n.remove();return}window.siyuan.menus.menu.remove();const l=e.blockElement.getAttribute("data-node-id"),r=!e.blockElement.classList.contains("av");let d=i.data,c,f=Ge(d);if(e.type==="config")c=Qr(d);else if(e.type==="properties")c=ka(f);else if(e.type==="sorts")c=pi(f,d.view.sorts);else if(e.type==="switcher")c=Bf(d.views,d.viewID);else if(e.type==="filters")c=Sa(d);else if(e.type==="select")c=fi(f,e.cellElements,!0,e.blockElement);else if(e.type==="asset")c=sc(e.cellElements);else if(e.type==="edit")e.editData&&(typeof e.editData.colData.wrap=="undefined"&&(e.editData.colData.wrap=d.view.wrapField),e.editData.previousID?f.find((w,h)=>{if(w.id===e.editData.previousID)return f.splice(h+1,0,e.editData.colData),!0}):d.viewType==="table"?f.splice(0,0,e.editData.colData):f.push(e.editData.colData)),c=Yn({protyle:e.protyle,data:d,colId:e.colId,isCustomAttr:r});else if(e.type==="date")c=yp(e.cellElements);else if(e.type==="rollup")c=`<div class="b3-menu__items">${pc({data:d,cellElements:e.cellElements})}</div>`;else if(e.type==="relation"&&(c=jf(d,e.cellElements),!c)){Pt({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:rn(e.cellElements[0],d.viewType)});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex};">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu" ${["select","date","asset","relation","rollup"].includes(e.type)?`style="min-width: 200px;${P()?"max-width: 90vw;":"max-width: 50vw;"}"`:""}>${c}</div>
</div>`),n=document.querySelector(".av__panel");let m;const u=n.lastElementChild;let g=(o=e.blockElement.querySelector(`.av__views, .av__row[data-col-id="${e.colId}"] > .block__logo`))==null?void 0:o.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(e.type)){let w=e.cellElements[e.cellElements.length-1];if(!e.blockElement.contains(w)){const S=Tn(w,d.viewType);d.viewType==="table"?w=e.blockElement.querySelector(`.av__row[data-id="${S}"] .av__cell[data-col-id="${w.dataset.colId}"]`):w=e.blockElement.querySelector(`.av__gallery-item[data-id="${S}"] .av__cell[data-field-id="${w.dataset.fieldId}"]`)}const h=(w||e.cellElements[e.cellElements.length-1]).getBoundingClientRect();if(e.type==="select"?ui(e.protyle,d,u,e.cellElements,e.blockElement):e.type==="date"?m=wp({protyle:e.protyle,data:d,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}):e.type==="asset"?(ic({protyle:e.protyle,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}),setTimeout(()=>{Ee(u,h.left,h.bottom,h.height)},p.TIMEOUT_LOAD)):e.type==="relation"?Vf({menuElement:u,cellElements:e.cellElements,protyle:e.protyle,blockElement:e.blockElement}):e.type==="rollup"&&mc({protyle:e.protyle,data:d,menuElement:u}),["select","date","relation","rollup"].includes(e.type)){const S=u.querySelector("input");S&&(S.select(),S.focus()),Ee(u,h.left,h.bottom,h.height)}}else Ee(u,g.right-u.clientWidth,g.bottom,g.height),e.type==="sorts"?gi(e.protyle,u,d,l):e.type==="edit"?Wn({protyle:e.protyle,data:d,menuElement:u,isCustomAttr:r,blockID:l}):e.type==="config"?Jr({protyle:e.protyle,data:d,menuElement:u,blockElement:e.blockElement}):e.type==="switcher"&&Rf({protyle:e.protyle,menuElement:u,blockElement:e.blockElement});e.cb&&e.cb(n),n.addEventListener("dragstart",w=>{window.siyuan.dragElement=w.target,window.siyuan.dragElement.style.opacity=".38"}),n.addEventListener("drop",w=>{var h,S,$,D,v,k;if(b=0,!window.siyuan.dragElement){w.preventDefault(),w.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const _=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,e.protyle&&e.protyle.disabled){w.preventDefault(),w.stopPropagation();return}if(!e.protyle&&window.siyuan.config.readonly){w.preventDefault(),w.stopPropagation();return}const E=n.querySelector(".dragover__bottom, .dragover__top");if(!E)return;const A=E.classList.contains("dragover__top"),x=_.dataset.id,I=E.dataset.id;if(E.querySelector('[data-type="removeSort"]')){const T=d.view.sorts,q=Object.assign([],T);let z;T.find((N,R)=>{if(N.column===x)return z=T.splice(R,1)[0],!0}),T.find((N,R)=>{if(N.column===I)return A?T.splice(R,0,z):T.splice(R+1,0,z),!0}),B(e.protyle,[{action:"setAttrViewSorts",avID:a,data:T,blockID:l}],[{action:"setAttrViewSorts",avID:a,data:q,blockID:l}]),u.innerHTML=pi(f,d.view.sorts),gi(e.protyle,u,d,l);return}if(E.querySelector('[data-type="removeFilter"]')){const T=d.view.filters,q=Object.assign([],T);let z;T.find((N,R)=>{if(N.column===x)return z=T.splice(R,1)[0],!0}),T.find((N,R)=>{if(N.column===I)return A?T.splice(R,0,z):T.splice(R+1,0,z),!0}),B(e.protyle,[{action:"setAttrViewFilters",avID:a,data:T,blockID:l}],[{action:"setAttrViewFilters",avID:a,data:q,blockID:l}]),u.innerHTML=Sa(d);return}if(E.querySelector('[data-type="av-view-edit"]')){B(e.protyle,[{action:"sortAttrViewView",avID:a,blockID:l,id:x,previousID:A?(h=E.previousElementSibling)==null?void 0:h.getAttribute("data-id"):E.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:a,blockID:l,id:x,previousID:(S=_.previousElementSibling)==null?void 0:S.getAttribute("data-id")}]),A?(E.before(_),E.classList.remove("dragover__top")):(E.after(_),E.classList.remove("dragover__bottom"));return}if(E.querySelector('[data-type="editAssetItem"]')){A?E.before(_):E.after(_);const T=[];Array.from(E.parentElement.children).forEach(q=>{["image","file"].includes(q.dataset.type)&&T.push({content:q.dataset.content,name:q.dataset.name,type:q.dataset.type})}),Va({protyle:e.protyle,cellElements:e.cellElements,replaceValue:T,blockElement:e.blockElement});return}if(E.querySelector('[data-type="setColOption"]')){const T=e.cellElements?rn(e.cellElements[0],d.viewType):u.querySelector(".b3-menu__item").getAttribute("data-col-id"),q=f.find(V=>V.id===T).options,z=Object.assign([],q);let N;q.find((V,j)=>{if(V.name===_.dataset.name)return N=q.splice(j,1)[0],!0}),q.find((V,j)=>{if(V.name===E.dataset.name)return A?q.splice(j,0,N):q.splice(j+1,0,N),!0}),B(e.protyle,[{action:"updateAttrViewColOptions",id:T,avID:a,data:q}],[{action:"updateAttrViewColOptions",id:T,avID:a,data:z}]);const R=u.querySelector(".b3-menu__items").scrollTop;e.cellElements?(u.innerHTML=fi(f,e.cellElements,!1,e.blockElement),ui(e.protyle,d,u,e.cellElements,e.blockElement)):(u.innerHTML=Yn({protyle:e.protyle,data:d,colId:T,isCustomAttr:r}),Wn({protyle:e.protyle,data:d,menuElement:u,isCustomAttr:r,blockID:l})),u.querySelector(".b3-menu__items").scrollTop=R;return}if(E.getAttribute("data-type")==="setRelationCell"){A?E.before(_):E.after(_),E.classList.remove("dragover__bottom","dragover__top");const T=[],q=[];E.parentElement.querySelectorAll(".fn__grab").forEach(z=>{const N=z.nextElementSibling;T.push(N.parentElement.dataset.rowId),q.push({isDetached:!N.style.color,type:"block",block:{content:N.textContent,id:N.dataset.id}})}),Zt(e.protyle,e.blockElement,{blockIDs:T,contents:q},e.cellElements);return}if(E.getAttribute("data-type")==="editCol"){const T=(A?($=E.previousElementSibling)==null?void 0:$.getAttribute("data-id"):E.getAttribute("data-id"))||"",q=((D=_.previousElementSibling)==null?void 0:D.getAttribute("data-id"))||"";if(T!==q&&T!==x){B(e.protyle,[{action:"sortAttrViewCol",avID:a,previousID:T,id:x,blockID:l}],[{action:"sortAttrViewCol",avID:a,previousID:q,id:x,blockID:l}]);let z;f.find((N,R)=>{if(N.id===x)return z=f.splice(R,1)[0],!0}),f.find((N,R)=>{if(N.id===I)return A?f.splice(R,0,z):f.splice(R+1,0,z),!0})}u.innerHTML=ka(f);return}if(E.querySelector('[data-type="hideGroup"]')){const T=(A?(v=E.previousElementSibling)==null?void 0:v.getAttribute("data-id"):E.getAttribute("data-id"))||"",q=((k=_.previousElementSibling)==null?void 0:k.getAttribute("data-id"))||"";T!==q&&T!==x&&(B(e.protyle,[{action:"sortAttrViewGroup",avID:a,blockID:l,previousID:T,id:x}],[{action:"sortAttrViewGroup",avID:a,blockID:l,previousID:q,id:x}]),u.querySelector('[data-type="goGroupsSort"] .b3-menu__accelerator').textContent=is(2,"sort"),d.view.group.order=2,d.view.groups.find((z,N)=>{if(z.id===x){const R=d.view.groups.splice(N,1)[0];return d.view.groups.find((V,j)=>{if(V.id===I)return A?d.view.groups.splice(j,0,R):d.view.groups.splice(j+1,0,R),!0}),!0}}),A?E.before(_):E.after(_)),E.classList.remove("dragover__top","dragover__bottom");return}});let y;n.addEventListener("dragover",w=>{if(w.dataTransfer.types.includes("Files")){w.preventDefault();return}const h=w.target;let S=O(h,"draggable","true");if(S||(S=O(document.elementFromPoint(w.clientX,w.clientY-1),"draggable","true")),!(!S||S===window.siyuan.dragElement)){if(w.preventDefault(),y&&S===y){const $=S.getBoundingClientRect();n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(D=>{D.classList.remove("dragover__bottom","dragover__top")}),w.clientY>$.top+$.height/2?S.classList.add("dragover__bottom"):S.classList.add("dragover__top");return}y=S}});let b=0;n.addEventListener("dragleave",()=>{b--,b===0&&n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(w=>{w.classList.remove("dragover__bottom","dragover__top")})}),n.addEventListener("dragenter",w=>{w.preventDefault(),b++}),n.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),n.addEventListener("mousedown",w=>{w.button===1&&!C(w.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),n.addEventListener("click",w=>xp(void 0,null,function*(){var h,S,$,D,v,k;let _,E=w.target;for(typeof w.detail=="string"?_=w.detail:typeof w.detail=="object"&&(_=w.detail.type,E=w.detail.target);E&&E!==n||_;){if(_=(E==null?void 0:E.dataset.type)||_,_==="close"){e.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")&&(m==null||m(),n.remove(),setTimeout(()=>{te(e.blockElement)},p.TIMEOUT_TRANSITION)):ae(["util"],e.protyle),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="go-config"){u.innerHTML=Qr(d),Ee(u,g.right-u.clientWidth,g.bottom,g.height),Jr({protyle:e.protyle,data:d,menuElement:u,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="go-properties"){g=e.blockElement.querySelector(".av__views").getBoundingClientRect(),u.innerHTML=ka(f),Ee(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="go-layout"){u.innerHTML=bc(d),Ee(u,g.right-u.clientWidth,g.bottom,g.height),yc({protyle:e.protyle,data:d,menuElement:u,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="goSorts"){u.innerHTML=pi(f,d.view.sorts),gi(e.protyle,u,d,l),Ee(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="removeSorts"){B(e.protyle,[{action:"setAttrViewSorts",avID:a,data:[],blockID:l}],[{action:"setAttrViewSorts",avID:a,data:d.view.sorts,blockID:l}]),d.view.sorts=[],u.innerHTML=pi(f,d.view.sorts),gi(e.protyle,u,d,l),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="addSort"){bp({data:d,rect:E.getBoundingClientRect(),menuElement:u,tabRect:g,avId:a,protyle:e.protyle,blockID:l}),w.preventDefault(),w.stopPropagation();break}else if(_==="removeSort"){const A=Object.assign([],d.view.sorts);d.view.sorts.find((x,I)=>{if(x.column===E.parentElement.dataset.id)return d.view.sorts.splice(I,1),!0}),B(e.protyle,[{action:"setAttrViewSorts",avID:a,data:d.view.sorts,blockID:l}],[{action:"setAttrViewSorts",avID:a,data:A,blockID:l}]),u.innerHTML=pi(f,d.view.sorts),gi(e.protyle,u,d,l),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="goFilters"){u.innerHTML=Sa(d),Ee(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="removeFilters"){B(e.protyle,[{action:"setAttrViewFilters",avID:a,data:[],blockID:l}],[{action:"setAttrViewFilters",avID:a,data:d.view.filters,blockID:l}]),d.view.filters=[],u.innerHTML=Sa(d),Ee(u,g.right-u.clientWidth,g.bottom,g.height),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="addFilter"){Hp({data:d,rect:E.getBoundingClientRect(),menuElement:u,tabRect:g,avId:a,protyle:e.protyle,blockElement:e.blockElement}),w.preventDefault(),w.stopPropagation();break}else if(_==="removeFilter"){window.siyuan.menus.menu.remove();const A=Object.assign([],d.view.filters);d.view.filters.find((x,I)=>{if(x.column===E.parentElement.dataset.id&&x.value.type===E.parentElement.dataset.filterType)return d.view.filters.splice(I,1),!0}),B(e.protyle,[{action:"setAttrViewFilters",avID:a,data:d.view.filters,blockID:l}],[{action:"setAttrViewFilters",avID:a,data:A,blockID:l}]),u.innerHTML=Sa(d),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="setFilter"){d.view.filters.find(A=>{if(A.column===E.parentElement.parentElement.dataset.id&&A.value.type===E.parentElement.parentElement.dataset.filterType)return Co({empty:!1,filter:A,protyle:e.protyle,data:d,target:E,blockElement:e.blockElement}),!0}),w.preventDefault(),w.stopPropagation();break}else if(_==="numberFormat"){_p({avPanelElement:n,element:E,protyle:e.protyle,oldFormat:E.dataset.format,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:a}),w.preventDefault(),w.stopPropagation();break}else if(_==="newCol"){n.remove(),os(e.protyle,e.blockElement).open({x:g.right,y:g.bottom,h:g.height,isLeft:!0}),w.preventDefault(),w.stopPropagation();break}else if(_==="update-view-icon"){const A=E.getBoundingClientRect();ha("","av",{x:A.left,y:A.bottom+4,h:A.height,w:A.width},x=>{B(e.protyle,[{action:"setAttrViewViewIcon",avID:a,id:d.viewID,data:x}],[{action:"setAttrViewViewIcon",id:d.viewID,avID:a,data:E.dataset.icon}]),E.innerHTML=x?ge(x):'<svg style="width: 14px;height: 14px;"><use xlink:href="#iconTable"></use></svg>',E.dataset.icon=x},E.querySelector("img")),w.preventDefault(),w.stopPropagation();break}else if(_==="set-page-size"){zc({target:E,protyle:e.protyle,avID:a,nodeElement:e.blockElement}),w.preventDefault(),w.stopPropagation();break}else if(_==="duplicate-view"){const A=Lute.NewNodeID();B(e.protyle,[{action:"duplicateAttrViewView",avID:a,previousID:d.viewID,id:A,blockID:l}],[{action:"removeAttrViewView",avID:a,id:A,blockID:l}]),n.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="delete-view"){B(e.protyle,[{action:"removeAttrViewView",avID:a,id:d.viewID,blockID:l}]),n.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="update-icon"){const A=E.getBoundingClientRect();ha("","av",{x:A.left,y:A.bottom+4,h:A.height,w:A.width},x=>{const I=u.querySelector(".b3-menu__item").getAttribute("data-col-id");if(B(e.protyle,[{action:"setAttrViewColIcon",id:I,avID:a,data:x}],[{action:"setAttrViewColIcon",id:I,avID:a,data:E.dataset.icon}]),E.innerHTML=x?ge(x):`<svg style="height: 14px;width: 14px"><use xlink:href="#${gt(E.dataset.colType)}"></use></svg>`,r){const T=e.blockElement.querySelector(`.av__row[data-col-id="${I}"] .block__logoicon`);T.outerHTML=x?ge(x,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${gt(T.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else Gt(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${I}"]`),void 0,{icon:x});E.dataset.icon=x},E.querySelector("img")),w.preventDefault(),w.stopPropagation();break}else if(_==="showAllCol"){const A=[],x=[];f.forEach(I=>{I.hidden&&(A.push({action:"setAttrViewColHidden",id:I.id,avID:a,data:!1,blockID:l}),x.push({action:"setAttrViewColHidden",id:I.id,avID:a,data:!0,blockID:l}),I.hidden=!1)}),A.length>0&&(B(e.protyle,A,x),u.innerHTML=ka(f),Ee(u,g.right-u.clientWidth,g.bottom,g.height)),w.preventDefault(),w.stopPropagation();break}else if(_==="hideAllCol"){const A=[],x=[];f.forEach(I=>{!I.hidden&&I.type!=="block"&&(A.push({action:"setAttrViewColHidden",id:I.id,avID:a,data:!0,blockID:l}),x.push({action:"setAttrViewColHidden",id:I.id,avID:a,data:!1,blockID:l}),I.hidden=!0)}),A.length>0&&(B(e.protyle,A,x),u.innerHTML=ka(f),Ee(u,g.right-u.clientWidth,g.bottom,g.height)),w.preventDefault(),w.stopPropagation();break}else if(_==="editCol"){u.innerHTML=Yn({protyle:e.protyle,data:d,colId:E.dataset.id,isCustomAttr:r}),Wn({protyle:e.protyle,data:d,menuElement:u,isCustomAttr:r,blockID:l}),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="updateColType"){const A=e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id");if(E.dataset.newType!==E.dataset.oldType){const I=n.querySelector('.b3-text-field[data-type="name"]').value;let T=I;if(f.find(q=>{if(q.id===A)return q.type=E.dataset.newType,sa(E.dataset.oldType)===I&&(T=sa(E.dataset.newType),q.name=T),!0}),B(e.protyle,[{action:"updateAttrViewCol",id:A,avID:a,name:T,type:E.dataset.newType}],[{action:"updateAttrViewCol",id:A,avID:a,name:I,type:E.dataset.oldType}]),E.dataset.newType==="lineNumber"){if(d.view.sorts.find(N=>N.column===A)){const N=Object.assign([],d.view.sorts),R=d.view.sorts.filter(V=>V.column!==A);B(e.protyle,[{action:"setAttrViewSorts",avID:d.id,data:R,blockID:l}],[{action:"setAttrViewSorts",avID:d.id,data:N,blockID:l}])}if(d.view.filters.find(N=>N.column===A)){const N=JSON.parse(JSON.stringify(d.view.filters)),R=d.view.filters.filter(V=>V.column!==A);B(e.protyle,[{action:"setAttrViewFilters",avID:d.id,data:R,blockID:l}],[{action:"setAttrViewFilters",avID:d.id,data:N,blockID:l}])}}}u.innerHTML=Yn({protyle:e.protyle,data:d,colId:A,isCustomAttr:r}),Wn({protyle:e.protyle,data:d,menuElement:u,isCustomAttr:r,blockID:l}),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="goUpdateColType"){const A=C(E,"b3-menu");A&&(A.firstElementChild.classList.add("fn__none"),A.lastElementChild.classList.remove("fn__none")),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="goSearchAV"){ji(a,E,void 0,!1),w.preventDefault(),w.stopPropagation();break}else if(_==="goSearchRollupCol"){gc({target:E,data:d,isRelation:!0,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),w.preventDefault(),w.stopPropagation();break}else if(_==="goSearchRollupTarget"){gc({target:E,data:d,isRelation:!1,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),w.preventDefault(),w.stopPropagation();break}else if(_==="goSearchRollupCalc"){ad(e.protyle,E,{data:d,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:l}),w.preventDefault(),w.stopPropagation();break}else if(_==="updateRelation"){Wf({protyle:e.protyle,avElement:n,avID:a,colsData:f,blockElement:e.blockElement}),w.preventDefault(),w.stopPropagation();break}else if(_==="goEditCol"){const A=C(E,"b3-menu");A&&(A.firstElementChild.classList.remove("fn__none"),A.lastElementChild.classList.add("fn__none")),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="hideCol"){const A=u.querySelector('[data-type="go-properties"]'),x=A?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):E.parentElement.getAttribute("data-id");B(e.protyle,[{action:"setAttrViewColHidden",id:x,avID:a,data:!0,blockID:l}],[{action:"setAttrViewColHidden",id:x,avID:a,data:!1,blockID:l}]),f.find(I=>I.id===x).hidden=!0,A?(u.innerHTML=Yn({protyle:e.protyle,data:d,colId:x,isCustomAttr:r}),Wn({protyle:e.protyle,data:d,menuElement:u,isCustomAttr:r,blockID:l})):u.innerHTML=ka(f),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="showCol"){const A=u.querySelector('[data-type="go-properties"]'),x=A?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):E.parentElement.getAttribute("data-id");B(e.protyle,[{action:"setAttrViewColHidden",id:x,avID:a,data:!1,blockID:l}],[{action:"setAttrViewColHidden",id:x,avID:a,data:!0,blockID:l}]),f.find(I=>I.id===x).hidden=!1,A?(u.innerHTML=Yn({protyle:e.protyle,data:d,colId:x,isCustomAttr:r}),Wn({protyle:e.protyle,data:d,menuElement:u,isCustomAttr:r,blockID:l})):u.innerHTML=ka(f),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="duplicateCol"){kc({blockElement:e.blockElement,protyle:e.protyle,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:d,viewID:d.viewID}),w.preventDefault(),w.stopPropagation();break}else if(_==="removeCol"){r||(g=e.blockElement.querySelector(".av__views").getBoundingClientRect());const A=u.querySelector(".b3-menu__item").getAttribute("data-col-id"),x=f.find(T=>{if(T.id===A)return!0}),I=x.type==="relation"&&((h=x.relation)==null?void 0:h.isTwoWay);if(r||I){const T=new ke({title:I?window.siyuan.languages.removeColConfirm:window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${I?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",u.querySelector("input").value||window.siyuan.languages._kernel[272]).replace("${y}",u.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent).replace("${z}",u.querySelector('input[data-type="colName"]').value||window.siyuan.languages._kernel[272]):window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value||window.siyuan.languages._kernel[272])}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${I?window.siyuan.languages.removeBothRelationField:window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove${I?"":" fn__none"}" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`,width:"520px"});T.element.addEventListener("click",q=>{let z=q.target;const N=typeof q.detail=="string";for(;z&&z!==T.element||N;){const R=z.getAttribute("data-action");if(R==="delete"||N&&q.detail==="Enter"){Io({protyle:e.protyle,fields:f,avID:a,blockID:l,menuElement:u,isCustomAttr:r,blockElement:e.blockElement,avPanelElement:n,tabRect:g,isTwoWay:!0}),T.destroy();break}else if(R==="keep-relation"){Io({protyle:e.protyle,fields:f,avID:a,blockID:l,menuElement:u,isCustomAttr:r,blockElement:e.blockElement,avPanelElement:n,tabRect:g,isTwoWay:!1}),T.destroy();break}else if(z.classList.contains("b3-button--cancel")||N&&q.detail==="Escape"){T.destroy();break}z=z.parentElement}}),T.element.setAttribute("data-key",p.DIALOG_CONFIRM)}else Io({protyle:e.protyle,fields:f,avID:a,blockID:l,menuElement:u,isCustomAttr:r,blockElement:e.blockElement,avPanelElement:n,tabRect:g,isTwoWay:!1});w.preventDefault(),w.stopPropagation();break}else if(_==="setColOption"){pp(e.protyle,d,E,e.blockElement,r,e.cellElements),w.preventDefault(),w.stopPropagation();break}else if(_==="setRelationCell"){(S=u.querySelector(".b3-menu__item--current"))==null||S.classList.remove("b3-menu__item--current"),E.classList.add("b3-menu__item--current"),ld(e.protyle,e.blockElement,E,e.cellElements),w.preventDefault(),w.stopPropagation();break}else if(_==="addColOptionOrCell"){($=u.querySelector(".b3-menu__item--current"))==null||$.classList.remove("b3-menu__item--current"),E.classList.add("b3-menu__item--current"),E.querySelector(".b3-menu__checked")?Qs(e.protyle,e.cellElements,u.querySelector(`.b3-chips .b3-chip[data-content="${Ue(E.dataset.name)}"]`),e.blockElement):dc(e.protyle,d,e.cellElements,E,u,e.blockElement),window.siyuan.menus.menu.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="removeCellOption"){Qs(e.protyle,e.cellElements,E.parentElement,e.blockElement),w.preventDefault(),w.stopPropagation();break}else if(_==="addAssetLink"){fp(e.protyle,e.cellElements,E,e.blockElement),w.preventDefault(),w.stopPropagation();break}else if(_==="addAssetExist"){const A=E.getBoundingClientRect();mo(e.protyle,{x:A.right,y:A.bottom,w:E.parentElement.clientWidth+8,h:A.height},(x,I)=>{let T;p.SIYUAN_ASSETS_IMAGE.includes(_e().extname(x).toLowerCase())?T={type:"image",content:x,name:""}:T={type:"file",content:x,name:I},Va({protyle:e.protyle,cellElements:e.cellElements,addValue:[T],blockElement:e.blockElement}),window.siyuan.menus.menu.remove()}),w.preventDefault(),w.stopPropagation();break}else if(_==="openAssetItem"){const A=E.parentElement.dataset.content,x=_e().extname(A);p.SIYUAN_ASSETS_IMAGE.includes(x)?Yl(A,a,e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),((D=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:D.value.trim())||""):window.open(A),w.preventDefault(),w.stopPropagation();break}else if(_==="editAssetItem"){Js({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,content:E.parentElement.dataset.content,type:E.parentElement.dataset.type,name:E.parentElement.dataset.name,index:parseInt(E.parentElement.dataset.index),rect:E.parentElement.getBoundingClientRect()}),w.preventDefault(),w.stopPropagation();break}else if(_==="clearDate"){const A=f.find(x=>{if(x.id===rn(e.cellElements[0],d.viewType))return!0});Zt(e.protyle,e.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:A.date?!A.date.fillSpecificTime:!0},e.cellElements),n.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="av-add"){window.siyuan.menus.menu.remove(),td(e.protyle,e.blockElement),n.remove(),w.preventDefault(),w.stopPropagation();break}else if(_==="av-view-switch"){E.parentElement.classList.contains("b3-menu__item--current")||((v=n.querySelector(".b3-menu__item--current"))==null||v.classList.remove("b3-menu__item--current"),E.parentElement.classList.add("b3-menu__item--current"),B(e.protyle,[{action:"setAttrViewBlockView",blockID:l,id:E.parentElement.dataset.id,avID:a}],[{action:"setAttrViewBlockView",blockID:l,id:e.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:a}])),w.preventDefault(),w.stopPropagation();break}else if(_==="av-view-edit"){E.parentElement.classList.contains("b3-menu__item--current")?Vi({protyle:e.protyle,blockElement:e.blockElement,element:E.parentElement}):((k=n.querySelector(".b3-menu__item--current"))==null||k.classList.remove("b3-menu__item--current"),E.parentElement.classList.add("b3-menu__item--current"),B(e.protyle,[{action:"setAttrViewBlockView",blockID:l,id:E.parentElement.dataset.id,avID:a}],[{action:"setAttrViewBlockView",blockID:l,id:e.blockElement.querySelector(".av__views .item--focus").getAttribute("data-id"),avID:a}]),window.siyuan.menus.menu.remove(),Vi({protyle:e.protyle,blockElement:e.blockElement,element:E.parentElement})),w.preventDefault(),w.stopPropagation();break}else if(_==="set-gallery-cover"){Gf({target:E,protyle:e.protyle,nodeElement:e.blockElement,view:d.view}),w.preventDefault(),w.stopPropagation();break}else if(_==="set-gallery-size"){zf({target:E,protyle:e.protyle,nodeElement:e.blockElement,view:d.view}),w.preventDefault(),w.stopPropagation();break}else if(_==="set-gallery-ratio"){Kf({target:E,protyle:e.protyle,nodeElement:e.blockElement,view:d.view}),w.preventDefault(),w.stopPropagation();break}else if(_==="set-layout"){d=yield vp({target:E,protyle:e.protyle,nodeElement:e.blockElement,data:d}),f=Ge(d),w.preventDefault(),w.stopPropagation();break}else if(_==="goGroupsDate"){Ap({target:E,menuElement:u,protyle:e.protyle,blockElement:e.blockElement,data:d}),f=Ge(d),w.stopPropagation(),w.preventDefault();break}else if(_==="goGroupsSort"){Lp({target:E,menuElement:u,protyle:e.protyle,blockElement:e.blockElement,data:d}),f=Ge(d),w.stopPropagation(),w.preventDefault();break}else if(_==="setGroupMethod"){Ep({protyle:e.protyle,fieldId:E.getAttribute("data-id"),data:d,menuElement:u,blockElement:e.blockElement}),w.preventDefault(),w.stopPropagation();break}else if(_==="goGroups"){u.querySelector('[data-type="avGroupRange"]')&&m&&(yield m()),m=void 0,d.view.group&&d.view.group.field||E.classList.contains("block__icon")?(u.innerHTML=mi(f,d.view),ss({protyle:e.protyle,menuElement:u,blockElement:e.blockElement,data:d})):u.innerHTML=wc(f,d.view.group,d.viewType),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="goGroupsMethod"){window.siyuan.menus.menu.remove(),u.innerHTML=wc(f,d.view.group,d.viewType),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}else if(_==="getGroupsNumber"){window.siyuan.menus.menu.remove(),u.innerHTML=kp(d.view.group),Ee(u,g.right-u.clientWidth,g.bottom,g.height),m=Sp({protyle:e.protyle,data:d,menuElement:u,blockElement:e.blockElement}),w.preventDefault(),w.stopPropagation();break}else if(_==="hideGroup"){window.siyuan.menus.menu.remove();const A=E.firstElementChild,x=A.getAttribute("xlink:href")!=="#iconEye";A.setAttribute("xlink:href",x?"#iconEye":"#iconEyeoff");let I,T=0;d.view.groups.forEach(q=>{q.id===E.dataset.id&&(I=q.groupHidden,q.groupHidden=x?0:2),q.groupHidden===0&&T++}),E.parentElement.classList[x?"remove":"add"]("b3-menu__item--hidden"),u.querySelector('[data-type="hideGroups"]').innerHTML=`${window.siyuan.languages[T===0?"showAll":"hideAll"]}
<span class="fn__space"></span>
<svg><use xlink:href="#iconEye${T===0?"":"off"}"></use></svg>`,B(e.protyle,[{action:"hideAttrViewGroup",avID:d.id,blockID:l,id:E.dataset.id,data:x?0:2}],[{action:"hideAttrViewGroup",avID:d.id,blockID:l,id:E.dataset.id,data:I}]),w.preventDefault(),w.stopPropagation();break}else if(_==="hideGroups"){window.siyuan.menus.menu.remove();const A=E.querySelector("use").getAttribute("xlink:href")==="#iconEyeoff";E.innerHTML=`${window.siyuan.languages[A?"showAll":"hideAll"]}
<span class="fn__space"></span>
<svg><use xlink:href="#iconEye${A?"":"off"}"></use></svg>`,d.view.groups.forEach(x=>{var I;x.groupHidden=A?2:0;const T=E.parentElement.parentElement.querySelector(`.b3-menu__item[data-id="${x.id}"]`);T.classList[A?"add":"remove"]("b3-menu__item--hidden"),(I=T.querySelector(".b3-menu__action use"))==null||I.setAttribute("xlink:href",`#iconEye${A?"off":""}`)}),B(e.protyle,[{action:"hideAttrViewAllGroups",avID:d.id,blockID:l,data:A}],[{action:"hideAttrViewAllGroups",avID:d.id,blockID:l,data:!A}]),w.preventDefault(),w.stopPropagation();break}else if(_==="removeGroups"){window.siyuan.menus.menu.remove(),B(e.protyle,[{action:"removeAttrViewGroup",avID:d.id,blockID:l}],[{action:"setAttrViewGroup",avID:d.id,blockID:l,data:d.view.group}]),d.view.group=null,delete d.view.groups,u.innerHTML=mi(f,d.view),Ee(u,g.right-u.clientWidth,g.bottom,g.height),w.preventDefault(),w.stopPropagation();break}if(!E||!E.parentElement)break;E=E.parentElement}}))})},ka=e=>{let t="",n="";return e.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(a.type)}"></use></svg>`}
        ${pe(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:t+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?ge(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(a.type)}"></use></svg>`}
        ${pe(a.name)||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.fields}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${t}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`};var Cp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const _c=e=>{let t=e,n="";try{const a=new URL(e);a.protocol.startsWith("http")&&(t=a.host,n=a.href.replace(a.origin,""),n.length>12&&(n=n.substring(0,4)+"..."+n.substring(n.length-6)))}catch(a){t=Lute.EscapeHTMLStr(e)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${Ue(e)}"><span>${t}</span><span class="ft__on-surface">${n}</span></span>`},nl=e=>{if(!e)return"";let t="";const n=e.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return n.length>0?(n.forEach(a=>{a.querySelector(".av__cellicon")?t+=`${a.firstChild.textContent} \u2192 ${a.lastChild.textContent}, `:a.getAttribute("data-type")==="url"?t=a.getAttribute("data-href")+", ":a.getAttribute("data-type")!=="block-more"&&(t+=a.textContent+", ")}),t=t.substring(0,t.length-2)):t=e.textContent,t},ia=(e,t)=>{var n;const a={type:e,id:t.dataset.id};if(e==="number"){const s=t.querySelector(".av__celltext").getAttribute("data-content");a.number={content:parseFloat(s)||0,isNotEmpty:!!s}}else if(["text","block","url","phone","email","template"].includes(e)){const s=t.querySelector(".av__celltext");if(a[e]={content:e==="url"?s.dataset.href:s.textContent},e==="block"&&s.dataset.id&&(a.block.id=s.dataset.id,(n=s.previousElementSibling)!=null&&n.classList.contains("b3-menu__avemoji"))){const i=s.previousElementSibling.getAttribute("data-unicode");i&&(a.block.icon=i)}}else if(e==="mSelect"||e==="select"){const s=[];t.querySelectorAll(".b3-chip").forEach(i=>{s.push({content:i.textContent.trim(),color:i.style.color.replace("var(--b3-font-color","").replace(")","")})}),a.mSelect=s}else if(["date","created","updated"].includes(e))a[e]=JSON.parse(t.querySelector(".av__celltext").getAttribute("data-value"));else if(e==="checkbox")a.checkbox={checked:t.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(e==="relation"){const s=[],i=[];Array.from(t.querySelectorAll(".av__cell--relation")).forEach(o=>{const l=o.querySelector(".av__celltext");s.push(o.dataset.rowId),i.push({isDetached:!l.classList.contains("av__celltext--ref"),block:{content:l.textContent,id:l.dataset.id},type:"block"})}),a.relation={blockIDs:s,contents:i}}else if(e==="mAsset"){const s=[];Array.from(t.children).forEach(i=>{if(!i.classList.contains("av__celltext--url")&&!i.classList.contains("av__cellassetimg"))return;const o=i.classList.contains("av__cellassetimg");s.push({type:o?"image":"file",content:o?zl(i.getAttribute("src")):i.getAttribute("data-url"),name:o?"":i.getAttribute("data-name")})}),a.mAsset=s}return e==="block"&&(a.isDetached=t.dataset.detached==="true"),a},bi=e=>{if(["number","text","block","url","phone","email","template","mAsset"].includes(e.type))return e[e.type].content;if(["mSelect","select"].includes(e.type))return e.mSelect[0].content;if(e.type==="rollup")return bi(e.relation.contents[0]);if(e.type==="checkbox")return e.checkbox.checked?"true":"false";if(e.type==="relation")return bi(e.relation.contents[0]);if(["date","created","updated"].includes(e.type))return G(e[e.type].content).format("YYYY-MM-DD HH:mm");if(e.type==="lineNumber")return""},Tp=(e,t)=>{if(e===t.type)return t;const n={type:e};if(e==="number")["date","created","updated"].includes(e)?n.number={content:t[t.type].content,isNotEmpty:t[t.type].isNotEmpty}:n.number={content:parseFloat(bi(t))||0,isNotEmpty:!0};else if(["text","block","url","phone","email","template"].includes(e))n[e]={content:bi(t).toString()};else if(e==="mSelect"||e==="select")n.mSelect=[{content:bi(t).toString(),color:"1"}],n.mSelect[0].content||(n.mSelect=[]);else if(e==="rollup")n.rollup={contents:[t]};else if(e==="checkbox")n.checkbox={checked:!0};else if(e==="relation")t.type==="block"?n.relation={blockIDs:[t.blockID],contents:[t]}:n.relation={blockIDs:[],contents:[]};else if(e==="mAsset"){const a=bi(t).toString();n.mAsset=[{type:p.SIYUAN_ASSETS_IMAGE.includes(_e().extname(a).toLowerCase())?"image":"file",content:a,name:""}]}else if(["date","created","updated"].includes(e))["date","created","updated"].includes(t.type)?n[e]=JSON.parse(JSON.stringify(t[t.type])):n[e]={content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0};else if(e==="lineNumber")return{type:"lineNumber"};return n},Un=(e,t)=>{let n={type:e,[e==="select"?"mSelect":e]:t};if(typeof t=="string"&&t){if(e==="number")n={type:e,number:{content:parseFloat(t)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(e))n={type:e,[e]:{content:t}};else if(e==="mSelect"||e==="select")n={type:e,mSelect:[{content:t,color:"1"}]};else if(e==="checkbox")n={type:e,checkbox:{checked:!0}};else if(e==="date"){let a=t.split("\u2192");a.length!==2&&(a=t.split("-"),a.length!==2&&(a=t.split("~")));const s=G(a[0]),i=G(a[1]||"");isNaN(s.valueOf())?n={type:e,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:n={type:e,date:{content:s.valueOf(),isNotEmpty:!0,content2:i.valueOf()||0,isNotEmpty2:!isNaN(i.valueOf()),hasEndDate:!isNaN(i.valueOf()),isNotTime:s.hour()===0&&a[0].split(":").length===1,formattedContent:""}}}else if(e==="relation")n={type:e,relation:{blockIDs:[t],contents:[]}};else if(e==="mAsset"){const a=_e().extname(t).toLowerCase();n={type:e,mAsset:[{type:p.SIYUAN_ASSETS_IMAGE.includes(a)?"image":"file",content:t,name:""}]}}}else(typeof t=="undefined"||!t)&&(e==="number"?n={type:e,number:{content:0,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(e)?n={type:e,[e]:{content:""}}:e==="mSelect"||e==="select"||e==="mAsset"?n={type:e,[e==="select"?"mSelect":e]:[]}:["date","created","updated"].includes(e)?n={type:e,[e]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:e==="checkbox"?n={type:e,checkbox:{checked:!1}}:e==="relation"?n={type:e,relation:{blockIDs:[],contents:[]}}:e==="rollup"&&(n={type:e,rollup:{contents:[]}}));return e==="block"&&(typeof t=="object"&&t&&t.id?n.isDetached=!1:n.isDetached=!0),n},ma=(e,t,n=!0)=>{const a=t.getBoundingClientRect();if(!n){const i=e.querySelector(".av__scroll"),o=C(t,"av__row");if(i&&o){const l=o.querySelector(".av__colsticky");if(!l.contains(t)){const r=l.getBoundingClientRect().right,d=i.getBoundingClientRect();r>a.left||d.right<a.left?i.scrollLeft=i.scrollLeft+a.left-r:r<a.left&&d.right<a.right&&(a.width+r>d.right?i.scrollLeft=i.scrollLeft+a.left-r:i.scrollLeft=i.scrollLeft+a.right-d.right)}}}const s=C(e,"protyle-content",!0);if(s&&t.getAttribute("data-dtype")!=="checkbox"){const i=document.getElementById("keyboardToolbar"),o=parseInt(i.getAttribute("data-keyboardheight"))||window.outerHeight/2-42;a.bottom>window.innerHeight-o-42?s.scrollTop+=a.bottom-window.innerHeight+42+o:a.top<110&&(s.scrollTop-=110-a.top)}},ln=e=>{if(e.parentElement.classList.contains("av__gallery-field"))return e.getAttribute("data-dtype");const t=C(e,"av__scroll");if(t)return t.querySelector(".av__row--header").querySelector(`[data-col-id="${e.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},on=(e,t,n)=>{var a;if(t.length===0||t.length===1&&!t[0]||(n||(n=ln(t[0])),n==="updated"||n==="created"||document.querySelector(".av__mask")))return;const s=F(t[0]);if(!s)return;const i=s.getAttribute("data-av-type");let o=t[0].getBoundingClientRect();const l=C(s,"protyle-content",!0);i==="table"&&ma(s,t[0],!1),o=t[0].getBoundingClientRect();let r="",d=o.height;const c=getComputedStyle(t[0]);let f=`font-family:${c.fontFamily};font-size:${c.fontSize};line-height:${c.lineHeight};padding:${c.padding};position:absolute;top: ${o.top}px;`;if(l){const y=l.getBoundingClientRect();o.bottom>y.bottom&&(d=y.bottom-o.top);const b=Math.min(Math.max(o.width,25),y.width);f=`style='height: ${d}px;width:${b}px;left: ${o.left<y.left||o.left+b>y.right?y.left:o.left}px;${f}'`}else f=`style='height: ${d}px;width:${Math.max(o.width,25)}px;left: ${o.left}px;${f}'`;if(["text","email","phone","block","template"].includes(n))r=`<textarea ${f} spellcheck="false" class="b3-text-field"></textarea>`;else if(n==="url")r=`<textarea ${f} spellcheck="false" class="b3-text-field">${t[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(n==="number")r=`<input type="number" spellcheck="false" value="${t[0].firstElementChild.getAttribute("data-content")}" ${f} class="b3-text-field">`;else{if(["select","mSelect"].includes(n)){if(s.getAttribute("data-rendering")==="true")return;Pt({protyle:e,blockElement:s,type:"select",cellElements:t})}else n==="mAsset"?(Pt({protyle:e,blockElement:s,type:"asset",cellElements:t}),te(s)):n==="date"?Pt({protyle:e,blockElement:s,type:"date",cellElements:t}):n==="checkbox"?Lo(e,n,s,t):n==="relation"?Pt({protyle:e,blockElement:s,type:"relation",cellElements:t}):n==="rollup"&&Pt({protyle:e,blockElement:s,type:"rollup",cellElements:t,colId:rn(t[0],i)});i==="table"&&!C(t[0],"custom-attr")&&(t[0].classList.add("av__cell--select"),wn(t[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${r}
</div>`);const m=document.querySelector(".av__mask"),u=m.querySelector(".b3-text-field");u&&(["text","email","phone","block","template"].includes(n)&&(u.value=((a=t[0].querySelector(".av__celltext"))==null?void 0:a.textContent)||""),u.select(),u.focus(),n==="template"&&L("/api/av/renderAttributeView",{id:s.dataset.avId,viewID:s.getAttribute(p.CUSTOM_SY_AV_VIEW)},y=>{Ge(y.data).find(b=>{if(b.id===rn(t[0],i))return u.value=b.template,u.dataset.template=b.template,!0})}),n==="block"&&u.addEventListener("input",y=>{if(p.BLOCK_HINT_KEYS.includes(u.value.substring(0,2))){if(e.toolbar.range=document.createRange(),t[0]&&!s.contains(t[0])){const w=Tn(t[0],i);i==="table"?t[0]=s.querySelector(`.av__row[data-id="${w}"] .av__cell[data-col-id="${t[0].dataset.colId}"]`):t[0]=s.querySelector(`.av__gallery-item[data-id="${w}"] .av__cell[data-field-id="${t[0].dataset.fieldId}"]`)}e.toolbar.range.selectNodeContents(t[0].lastChild),X(e.toolbar.range),i==="table"&&(t[0].classList.add("av__cell--select"),wn(t[0]));let b=u.value;Kn(b)?b=b.substring(2,24):b=b.substring(2),Ia(b,e,"av"),m==null||m.remove(),y.preventDefault(),y.stopPropagation()}}),u.addEventListener("keydown",y=>{y.isComposing||Rn(y)||(y.key==="Escape"||y.key==="Tab"||y.key==="Enter"&&!y.shiftKey&&Ze(y))&&(Lo(e,n,s,t),y.key==="Tab"&&e.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:y.shiftKey,ctrlKey:y.ctrlKey,altKey:y.altKey,metaKey:y.metaKey,key:"Tab",keyCode:9})),y.preventDefault(),y.stopPropagation())}));const g=y=>{y.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(Lo(e,n,s,t),m==null||m.remove())};m.addEventListener("click",y=>{g(y)}),m.addEventListener("contextmenu",y=>{g(y)}),m.addEventListener("mousedown",y=>{y.button===1&&(y.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),g(y))})},Lo=(e,t,n,a)=>{const s=n.getAttribute("data-av-type");if(s==="table"){const l=C(a[0],"av__row");if(!l||a.length===1&&a[0].dataset.detached==="true"&&!l.dataset.id)return}const i=document.querySelector(".av__mask"),o=n.getAttribute("data-av-id");if(t==="template"){const l=rn(a[0],s),r=i.querySelector(".b3-text-field");r.value!==r.dataset.template&&!n.getAttribute("data-loading")&&(B(e,[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.dataset.template,type:"template"}]),n.setAttribute("data-loading","true"))}else Zt(e,n,t==="checkbox"?{checked:a[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:i.querySelector(".b3-text-field").value,a);s==="table"&&a[0]&&!C(a[0],"custom-attr")&&(a[0].classList.add("av__cell--select"),wn(a[0])),document.querySelector(".b3-dialog")||te(n),document.querySelectorAll(".av__mask").forEach(l=>{l.remove()})},Zt=(e,t,n,a,s,i,o=!1)=>Cp(void 0,null,function*(){const l=[],r=[],d=t.dataset.avId,c=t.dataset.nodeId;let f="";const m=[];let u;(a==null?void 0:a.length)>0?u=a:(u=Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select")),u.length===0&&t.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(b=>{b.querySelectorAll(".av__cell").forEach(w=>{u.push(w)})}));const g=C(u[0],"custom-attr"),y=t.getAttribute("data-av-type");for(let b=0;b<u.length;b++){let w=u[b];const h=Tn(w,y);if(!h||(t.contains(w)||(y==="table"?w=u[b]=t.querySelector(`.av__row[data-id="${h}"] .av__cell[data-col-id="${w.dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${w.dataset.colId}"]`):w=u[b]=t.querySelector(`.av__gallery-item[data-id="${h}"] .av__cell[data-field-id="${w.dataset.fieldId}"]`)),!w))break;const S=ln(w)||w.dataset.type;if(["created","updated","template","rollup"].includes(S))break;const $=w.dataset.id,D=rn(w,y);f+=nl(w)+(u[b+1]&&w.nextElementSibling&&w.nextElementSibling===u[b+1]?"	":`

`);const v=ia(S,w);(b===0||u[b-1]!==w.previousElementSibling)&&m.push([]),m[m.length-1].push(v);let k=n;if(S==="mAsset"){if(Array.isArray(n))k=v.mAsset.concat(n);else if(typeof n!="undefined"&&typeof n!="object"){let E=e.lute.GetLinkDest(n),A="",x="";if(!E&&n.startsWith("assets/")&&(E=n,A=ql(n)+_e().extname(n)),i){const I=document.createElement("template");I.innerHTML=i;const T=I.content.querySelector('[data-type~="a"]');if(T)E=T.getAttribute("data-href"),A=T.textContent;else{const q=I.content.querySelector(".img img");q&&(x=q.getAttribute("data-src"))}}if(E||(A=n),!E&&!A&&!x)break;x?k=v.mAsset.concat({type:"image",content:x,name:""}):k=v.mAsset.concat({type:"file",content:E,name:A})}}else if(S==="mSelect"||S==="select"){if(typeof n=="string"){const E=[];let A=v.mSelect.length;[...new Set(n.split(",").map(x=>x.trim().replace(/\n|\r\n|\r|\u2028|\u2029/g,"")))].forEach(x=>{if(!x)return;let I=!1;v.mSelect.find(T=>{if(T.content===x)return I=!0,!0}),!I&&(A++,E.push({content:x,color:A.toString()}))}),k=v.mSelect.concat(E)}}else S==="block"&&typeof n=="string"&&v.block.id&&(k={content:n,id:v.block.id},v.block.icon&&(k.icon=v.block.icon));let _;if(typeof k=="object"&&k.type?_=Tp(S,k):_=Un(S,k),_.id=$,_.type==="date"&&typeof _.date=="string"||_.type==="relation"&&typeof _.relation=="string")break;if(s&&(S==="select"||S==="mSelect")){const E=mp(s.find(A=>A.id===D),_,d);l.push(...E.doOperations),r.push(...E.undoOperations)}if(S==="date"){if(!(n&&typeof n=="object"&&typeof n.isNotTime=="boolean")){const E=yield he("/api/av/getAttributeViewKeysByID",{avID:d,keyIDs:[D]});E.data[0].date&&(_.date.isNotTime=!E.data[0].date.fillSpecificTime)}_.date.formattedContent=v.date.formattedContent}if(Ht(_,v))break;l.push({action:"updateAttrViewCell",id:$,avID:d,keyID:D,rowID:h,data:_}),r.push({action:"updateAttrViewCell",id:$,avID:d,keyID:D,rowID:h,data:v}),g?w.innerHTML=pa(_):Gt(w,_)}return o?{doOperations:l,undoOperations:r}:(l.length>0&&(l.push({action:"doUpdateUpdated",id:c,data:G().format("YYYYMMDDHHmmss")}),r.push({action:"doUpdateUpdated",id:c,data:t.getAttribute("updated")}),B(e,l,r)),{text:f.substring(0,f.length-2),json:m})}),al=(e,t)=>{t.type==="checkbox"?t.checkbox.checked?(e.classList.add("av__cell-check"),e.classList.remove("av__cell-uncheck")):(e.classList.remove("av__cell-check"),e.classList.add("av__cell-uncheck")):t.type==="block"&&(t.isDetached?e.setAttribute("data-detached","true"):(e.querySelector(".av__celltext").setAttribute("data-id",t.block.id),e.removeAttribute("data-detached")))},Fn=(e,t=0,n=!0,a="table")=>{var s,i,o,l,r,d,c,f,m,u,g,y,b;let w="";if(e.type==="template")w=`<span class="av__celltext">${e&&e.template.content||""}</span>`;else if(e.type==="text")w=`<span class="av__celltext">${e?Lute.EscapeHTMLStr(e.text.content||""):""}</span>`;else if(["email","phone"].includes(e.type))w=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${e?Lute.EscapeHTMLStr(e[e.type].content||""):""}</span>`;else if(e.type==="url")w=_c(((s=e==null?void 0:e.url)==null?void 0:s.content)||"");else if(e.type==="block")e!=null&&e.isDetached?w=`<span class="av__celltext">${Lute.EscapeHTMLStr(e.block.content||"")}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:w=`<span class="b3-menu__avemoji${n?"":" fn__none"}" data-unicode="${e.block.icon||""}">${ge(e.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(e.block.content)}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(e.type==="number")w=`<span class="av__celltext" data-content="${e!=null&&e.number.isNotEmpty?e==null?void 0:e.number.content:""}">${(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content)||""}</span>`;else if(e.type==="mSelect"||e.type==="select")(i=e==null?void 0:e.mSelect)==null||i.forEach((h,S)=>{e.type==="select"&&S>0||(w+=`<span class="b3-chip" style="background-color:var(--b3-font-background${h.color});color:var(--b3-font-color${h.color})">${pe(h.content)}</span>`)});else if(e.type==="date"){const h=e?e.date:null;w=`<span class="av__celltext" data-value='${JSON.stringify(h)}'>`,h&&h.isNotEmpty&&(w+=G(h.content).format(h.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),h&&h.hasEndDate&&h.isNotEmpty&&h.isNotEmpty2&&(w+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${G(h.content2).format(h.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),w+="</span>"}else if(["created","updated"].includes(e.type)){const h=e?e[e.type]:null;w=`<span class="av__celltext" data-value='${JSON.stringify(h)}'>`,h&&h.isNotEmpty&&(w+=h.formattedContent),w+="</span>"}else if(["lineNumber"].includes(e.type))w=`<span class="av__celltext" data-value='${t+1}'>${t+1}</span>`;else if(e.type==="mAsset")(o=e==null?void 0:e.mAsset)==null||o.forEach(h=>{h.type==="image"?w+=`<img loading="lazy" class="av__cellassetimg ariaLabel" aria-label="${h.content}" src="${zi(h.content)}">`:w+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${Ue(h.content)}" data-name="${Ue(h.name)}" data-url="${Ue(h.content)}">${h.name||h.content}</span>`});else if(e.type==="checkbox")w+=`<div class="fn__flex"><svg class="av__checkbox"><use xlink:href="#icon${(l=e==null?void 0:e.checkbox)!=null&&l.checked?"Check":"Uncheck"}"></use></svg>`,["gallery","kanban"].includes(a)&&((r=e==null?void 0:e.checkbox)!=null&&r.content)&&(w+=`<span class="fn__space"></span>${(d=e==null?void 0:e.checkbox)==null?void 0:d.content}`),w+="</div>";else if(e.type==="rollup"){let h;(f=(c=e==null?void 0:e.rollup)==null?void 0:c.contents)==null||f.forEach(S=>{const $=["template","select","mSelect","mAsset","relation"].includes(S.type)?Fn(S,t,n,a):Ip(S,n);$&&(w+=$+(S.type==="checkbox"?"":", ")),h=S.type}),w&&(h==="checkbox"?w=`<div class="fn__flex">${w}</div>`:w.endsWith(", ")&&(w=w.substring(0,w.length-2)))}else e.type==="relation"&&((u=(m=e==null?void 0:e.relation)==null?void 0:m.contents)==null||u.forEach((h,S)=>{if(h&&h.block){const $=e.relation.blockIDs[S];h!=null&&h.isDetached?w+=`<span data-row-id="${$}" class="av__cell--relation"><span class="${n?"":" fn__none"}">\u2796<span class="fn__space--5"></span></span><span class="av__celltext">${Lute.EscapeHTMLStr(h.block.content||window.siyuan.languages.untitled)}</span></span>`:w+=`<span data-row-id="${$}" class="av__cell--relation" data-block-id="${h.block.id}"><span class="b3-menu__avemoji${n?"":" fn__none"}" data-unicode="${h.block.icon||""}">${ge(h.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${h.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(h.block.content||window.siyuan.languages.untitled)}</span></span>`}}),w&&w.endsWith(", ")&&(w=w.substring(0,w.length-2)));return(["text","template","url","email","phone","date","created","updated"].includes(e.type)&&((g=e[e.type])!=null&&g.content)||e.type==="lineNumber"||e.type==="number"&&((y=e.number)!=null&&y.isNotEmpty)||e.type==="block"&&((b=e.block)!=null&&b.content))&&(w+=`<span ${e.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),w},Ip=(e,t)=>{var n,a,s,i,o;let l="";if(["text"].includes(e.type))l=e&&e[e.type].content||"";else if(["email","phone"].includes(e.type)){const r=e?e[e.type].content:"";r&&(l=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${r}</span>`)}else if(e.type==="url"){const r=((n=e==null?void 0:e.url)==null?void 0:n.content)||"";r&&(l=_c(r))}else if(e.type==="block")e!=null&&e.isDetached?l=`<span class="av__celltext">${Lute.EscapeHTMLStr(((a=e.block)==null?void 0:a.content)||window.siyuan.languages.untitled)}</span>`:l=`<span class="b3-menu__avemoji${t?"":" fn__none"}" data-unicode="${e.block.icon||""}">${ge(e.block.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span><span data-type="block-ref" data-id="${(s=e.block)==null?void 0:s.id}" data-subtype="s" class="av__celltext av__celltext--ref">${Lute.EscapeHTMLStr(((i=e.block)==null?void 0:i.content)||window.siyuan.languages.untitled)}</span>`;else if(e.type==="number")l=(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content.toString())||"";else if(e.type==="checkbox")l+=`<svg class="av__checkbox"><use xlink:href="#icon${(o=e==null?void 0:e.checkbox)!=null&&o.checked?"Check":"Uncheck"}"></use></svg><span class="fn__space"></span>`;else if(["date","updated","created"].includes(e.type)){const r=e?e[e.type]:null;r.formattedContent?l=r.formattedContent:(r&&r.isNotEmpty&&(l=G(r.content).format(r.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),r&&r.hasEndDate&&r.isNotEmpty&&r.isNotEmpty2&&(l=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${G(r.content2).format(r.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),l&&(l=`<span class="av__celltext">${l}</span>`)}return l},$p=(e,t)=>{var n;if(typeof t.icon!="undefined"&&(e.dataset.icon=t.icon,e.querySelector(".av__cellheadericon").outerHTML=t.icon?ge(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${gt(e.dataset.dtype)}"></use></svg>`),typeof t.name!="undefined"&&(e.querySelector(".av__celltext").textContent=t.name),typeof t.pin!="undefined"){const a=e.querySelector(".av__celltext");t.pin?e.querySelector(".av__cellheadericon--pin")||a.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(n=e.querySelector(".av__cellheadericon--pin"))==null||n.remove()}},ls=e=>{let t=C(e,"av__row");if(!t)return;let n=-1;for(;t;)t=t.previousElementSibling,n++;let a=-2;for(;e;)e=e.previousElementSibling,e&&e.classList.contains("av__colsticky")&&(e=e.lastElementChild),a++;return{rowIndex:n,celIndex:a}},Dp=(e,t,n,a,s)=>{var i;(i=t.querySelector(".av__drag-fill"))==null||i.remove();const o={};t.querySelectorAll(".av__cell--active").forEach(m=>{if(a.includes(m.dataset.id))return;const u=C(m,"av__row");if(!u)return;o[u.dataset.id]||(o[u.dataset.id]=[]);const g=ia(ln(m),m);g.colId=m.dataset.colId,g.element=m,o[u.dataset.id].push(g)});const l=[],r=[],d=t.dataset.avId,c=Object.keys(n),f=!!s.querySelector(".b3-menu__avemoji");Object.keys(o).forEach((m,u)=>{o[m].forEach((g,y)=>{if(["rollup","template","created","updated"].includes(g.type)||g.type==="block"&&g.element.getAttribute("data-detached")!=="true")return;const b=JSON.parse(JSON.stringify(n[c[u%c.length]][y]));b.id=g.id;const w=g.colId;b.type==="block"&&(b.isDetached=!0,delete b.block.id),l.push({action:"updateAttrViewCell",id:g.id,avID:d,keyID:w,rowID:m,data:b}),g.element.innerHTML=Fn(b,0,f),al(g.element,b),delete g.colId,delete g.element,r.push({action:"updateAttrViewCell",id:g.id,avID:d,keyID:w,rowID:m,data:g})})}),te(t),l.length>0&&B(e,l,r)},wn=e=>{if(e&&(e.classList.add("av__cell--active"),!e.querySelector(".av__drag-fill"))){const t=e.getAttribute("data-dtype");if(["template","rollup","lineNumber","created","updated"].includes(t))return;e.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`)}},xo=e=>{var t,n,a,s,i,o;if(e.type==="checkbox")return!1;if(["text","block","url","phone","email","template"].includes(e.type))return!((t=e[e.type])!=null&&t.content);if(e.type==="number")return e.number?!e.number.isNotEmpty:!0;if(["mSelect","mAsset","select"].includes(e.type))return!(((n=e[e.type==="select"?"mSelect":e.type])==null?void 0:n.length)>0);if(["date","created","updated"].includes(e.type))return!((a=e[e.type])!=null&&a.isNotEmpty)&&!((s=e[e.type])!=null&&s.isNotEmpty2);if(e.type==="relation")return!((i=e.relation)!=null&&i.blockIDs&&e.relation.blockIDs.length>0);if(e.type==="rollup")return!((o=e.rollup)!=null&&o.contents&&e.rollup.contents.length>0)};var Mp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const hc=e=>{if(["select","number","date","created","updated"].includes(e))return"=";if(["checkbox"].includes(e))return"Is false";if(["rollup","relation","mAsset","text","mSelect","url","block","email","phone","template"].includes(e))return"Contains"},vc=(e,t,n)=>{const a=C(e,"b3-menu");if(a){if(["date","updated","created"].includes(n)){const s=a.querySelector('.b3-menu__item div[data-type="filter1"]'),i=s.nextElementSibling;t==="Is between"?(i.classList.remove("fn__none"),s.classList.remove("fn__none")):t==="Is empty"||t==="Is not empty"?(i.classList.add("fn__none"),s.classList.add("fn__none")):(s.classList.remove("fn__none"),i.classList.add("fn__none"));return}a.querySelectorAll("input, .b3-chip").forEach(s=>{const i=C(s,"b3-menu__item");i&&(t!=="Is empty"&&t!=="Is not empty"?i.classList.remove("fn__none"):i.classList.add("fn__none"))})}},Ec=e=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(t=>{const n=t.querySelector(".b3-chip.b3-chip--middle");if(n){const a=n.dataset.name.toLowerCase();!e||e.indexOf(a)>-1||a.indexOf(e)>-1?t.classList.remove("fn__none"):t.classList.add("fn__none")}})},Co=e=>Mp(void 0,null,function*(){var t,n,a,s,i,o,l,r,d,c,f,m,u,g,y,b,w,h,S,$,D;let v=e.target.getBoundingClientRect();v.height===0&&(v=e.protyle.wysiwyg.element.querySelector(`[data-col-id="${e.target.dataset.colId}"]`).getBoundingClientRect());const k=e.blockElement.getAttribute("data-node-id");let _;const E=new Fe("set-filter-"+e.filter.column,()=>{const R=JSON.parse(JSON.stringify(e.data.view.filters));if(!_||!_.value)return;const V={column:e.filter.column,value:{type:e.filter.value.type},operator:_.value};let j=!1,W;if(T.type==="select"||T.type==="mSelect"){const ve=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach($e=>{if($e.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const Ce=$e.nextElementSibling.firstElementChild;ve.push({color:Ce.dataset.color,content:Ce.dataset.name})}}),W=Un(T.type,ve)}else if(["date","updated","created"].includes(T.type)){const ve=E.element.querySelector('.b3-select[data-type="dateType"]'),$e=E.element.querySelectorAll('.b3-select[data-type="dataDirection"]');ve.value==="custom"?(V.relativeDate={count:parseInt($e[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt($e[0].parentElement.lastElementChild.value),direction:parseInt($e[0].value)},V.relativeDate2={count:parseInt($e[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt($e[1].parentElement.lastElementChild.value),direction:parseInt($e[1].value)},W={type:T.type}):(W=Un(T.type,{isNotEmpty2:N[2].value!=="",isNotEmpty:N[0].value!=="",content:N[0].value?new Date(N[0].value+" 00:00").getTime():0,content2:N[2].value?new Date(N[2].value+" 00:00").getTime():0,hasEndDate:V.operator==="Is between",isNotTime:!0}),V.relativeDate=null,V.relativeDate2=null)}else["text","mAsset","url","block","email","phone","template","relation","number"].includes(T.type)?W=Un(T.type,N[0].value):T.type==="checkbox"?W=Un(T.type,{checked:V.operator==="Is true"}):W=Un(T.type,void 0);e.filter.value.type==="rollup"?V.value={rollup:{contents:[W]},type:"rollup"}:V.value=W,["rollup","mAsset"].includes(e.filter.value.type)&&(V.quantifier=E.element.querySelector('.b3-select[data-type="quantifier"]').value);let Se=!1;if(e.data.view.filters.find((ve,$e)=>{if(ve.column===e.filter.column&&ve.value.type===e.filter.value.type)return ve.value.type==="checkbox"?(j=!0,e.data.view.filters[$e]=V,!0):Ht(ve,V)?(Se=!0,!0):(e.data.view.filters[$e]=V,j=!0,!0)}),!e.empty&&(Se||!j))return;B(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:k}],[{action:"setAttrViewFilters",avID:e.data.id,data:R,blockID:k}]);const ce=C(e.target,"b3-menu");ce&&(ce.innerHTML=Sa(e.data))});if(E.isOpen)return;let A="",x;const I=Ge(e.data);I.find(R=>{if(R.id===e.filter.column)return x=R,!0});let T=JSON.parse(JSON.stringify(e.filter.value));if(x.type==="rollup"){if(!x.rollup||!x.rollup.relationKeyID||!x.rollup.keyID){se(window.siyuan.languages.plsChoose),(t=document.querySelector(".av__panel"))==null||t.remove(),Pt({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:x.id});return}if((n=x.rollup.calc)!=null&&n.operator&&!["Range","Unique values"].includes(x.rollup.calc.operator))["Count all","Count empty","Count not empty","Count values","Count unique values","Percent empty","Percent not empty","Percent unique values","Percent checked","Percent unchecked","Sum","Average","Median","Min","Max"].includes(x.rollup.calc.operator)?T.type="number":["Checked","Unchecked"].includes(x.rollup.calc.operator)?T.type="checkbox":["Earliest","Latest"].includes(x.rollup.calc.operator)&&(T.type="date");else{let R="";I.find(j=>{if(j.id===x.rollup.relationKeyID)return R=j.relation.avID,!0}),(yield he("/api/av/getAttributeView",{id:R})).data.av.keyValues.find(j=>{if(j.key.id===x.rollup.keyID)return T.type=j.key.type,j.key.type==="select"&&(x.options=j.key.options),!0})}e.data.view.filters.find(R=>{if(R.column===x.id&&R.value.type==="rollup"){if(!R.value.rollup||!R.value.rollup.contents||R.value.rollup.contents.length===0){const V=T.type==="select"?"mSelect":T.type;T={[V]:Un(T.type,T.type==="checkbox"?{checked:void 0}:"")[V],type:T.type}}else T=R.value.rollup.contents[0];return!0}})}let q=!1;switch(T.type==="checkbox"&&(q=typeof T.checkbox=="undefined"||typeof T.checkbox.checked=="undefined"),T.type){case"checkbox":A=`<option ${e.filter.operator==="Is true"&&!q?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${e.filter.operator==="Is false"&&!q?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,q&&(A=`<option selected></option>${A}`);break;case"block":case"mAsset":case"text":case"url":case"phone":case"email":A=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":A=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":A=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${e.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":A=`<option ${e.filter.operator==="="?"selected":""} value="=">=</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":A=`<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":A=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(["rollup","mAsset"].includes(e.filter.value.type)&&E.addItem({iconHTML:"",type:"readonly",label:` <select style="margin: 4px 0" class="b3-select fn__size200" data-type="quantifier">
    <option ${e.filter.quantifier===""||e.filter.quantifier==="Any"?"selected":""} value="Any">${window.siyuan.languages.filterQuantifierAny}</option>
    <option ${e.filter.quantifier==="All"?"selected":""} value="All">${window.siyuan.languages.filterQuantifierAll}</option>
    <option ${e.filter.quantifier==="None"?"selected":""} value="None">${window.siyuan.languages.filterQuantifierNone}</option>
</select>`}),E.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200" data-type="operation">${A}</select>`}),T.type==="select"||T.type==="mSelect")((a=x.options)==null?void 0:a.length)>0&&E.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(R){const V=R.querySelector("input");V.addEventListener("keydown",j=>{if(j.isComposing)return;let W=Vt(E.element.querySelector(".b3-menu__items"),j,"b3-menu__item--current",R.nextElementSibling);j.key==="Enter"&&(W||(W=E.element.querySelector(".b3-menu__item--current")),W.dispatchEvent(new CustomEvent("click")))}),V.addEventListener("input",j=>{j.isComposing||Ec(V.value.toLowerCase())}),V.addEventListener("compositionend",()=>{Ec(V.value.toLowerCase())})}}),(s=x.options)==null||s.forEach(R=>{var V;let j="iconUncheck";(V=T==null?void 0:T.mSelect)==null||V.find(W=>{W.content===R.name&&(j="iconCheck")}),E.addItem({icon:j,label:`<span class="b3-chip b3-chip--middle" data-name="${R.name}" data-color="${R.color}" style="max-width: 178px;margin:3px 0;background-color:var(--b3-font-background${R.color});color:var(--b3-font-color${R.color})">
    <span class="fn__ellipsis">${R.name}</span>
</span>`,bind(W){W.addEventListener("click",()=>{const Se=W.querySelector("use");Se.getAttribute("xlink:href")==="#iconUncheck"?Se.setAttribute("xlink:href","#iconCheck"):Se.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","mAsset","email","phone","template"].includes(T.type)){let R="";T&&(T.type==="mAsset"?T.mAsset&&(R=((i=T.mAsset[0])==null?void 0:i.content)||""):R=T[T.type].content||""),E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${R}" class="b3-text-field fn__size200">`})}else if(T.type==="relation"){let R="";T&&(R=T.relation.blockIDs[0]||""),E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${R}" class="b3-text-field fn__size200"><div style="position:fixed" class="protyle-hint b3-list b3-list--background fn__none"></div>`,bind(V){const j=V.querySelector("input"),W=j.nextElementSibling,Se=()=>{!x.relation||!x.relation.avID||L("/api/av/getAttributeViewPrimaryKeyValues",{id:x.relation.avID,keyword:j.value},ce=>{let ve="";(ce.data.rows.values||[]).forEach((Ce,ze)=>{ve+=`<div class="b3-list-item${ze===0?" b3-list-item--focus":""}">${Ce.block.content||window.siyuan.languages.untitled}</div>`}),W.innerHTML=ve,ve===""?W.classList.add("fn__none"):W.classList.remove("fn__none");const $e=j.getBoundingClientRect();Ee(W,$e.left,$e.bottom+4,$e.height+4)})};j.addEventListener("input",ce=>{ce.isComposing||Se()}),j.addEventListener("compositionend",()=>{Se()}),j.addEventListener("keydown",ce=>{ce.isComposing||(ce.key!=="Enter"&&W.innerHTML!==""&&W.classList.remove("fn__none"),Vt(W,ce),ce.key==="Enter"&&(W.classList.contains("fn__none")?E.close():(j.value=W.querySelector(".b3-list-item--focus").textContent.replace(/\n/g," "),W.classList.add("fn__none")),ce.preventDefault(),ce.stopPropagation()))}),W.addEventListener("click",ce=>{const ve=C(ce.target,"b3-list-item");ve&&(j.value=ve.textContent.replace(/\n/g," "),W.classList.add("fn__none"))})}})}else if(T.type==="number")E.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${T!=null&&T.number.isNotEmpty?T.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(T.type)){const R=T?T[T.type]:null,V=!((o=e.filter.relativeDate)!=null&&o.direction),j=!((l=e.filter.relativeDate2)!=null&&l.direction);E.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${e.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${e.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${e.filter.relativeDate?"fn__none":""}">
        <input value="${R&&(R.isNotEmpty||T.type!=="date")?G(R.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((r=e.filter.relativeDate)==null?void 0:r.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((d=e.filter.relativeDate)==null?void 0:d.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${V?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" oninput="this.value = Math.max(this.value, 1)" step="1" value="${((c=e.filter.relativeDate)==null?void 0:c.count)||1}" class="b3-text-field fn__flex-1${V?" fn__none":""}"/>
        <span class="fn__space${V?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((f=e.filter.relativeDate)==null?void 0:f.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate||((m=e.filter.relativeDate)==null?void 0:m.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((u=e.filter.relativeDate)==null?void 0:u.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((g=e.filter.relativeDate)==null?void 0:g.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${e.filter.relativeDate2?"fn__none":""}">
        <input value="${R&&R.isNotEmpty2?G(R.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((y=e.filter.relativeDate2)==null?void 0:y.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((b=e.filter.relativeDate2)==null?void 0:b.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${j?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" oninput="this.value = Math.max(this.value, 1)" value="${((w=e.filter.relativeDate2)==null?void 0:w.count)||1}" class="b3-text-field fn__flex-1${j?" fn__none":""}"/>
        <span class="fn__space${j?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((h=e.filter.relativeDate2)==null?void 0:h.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate2||((S=e.filter.relativeDate2)==null?void 0:S.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${(($=e.filter.relativeDate2)==null?void 0:$.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((D=e.filter.relativeDate2)==null?void 0:D.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}E.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const R=Object.assign([],e.data.view.filters);e.data.view.filters.find((j,W)=>{if(j.column===e.filter.column&&e.filter.value.type===j.value.type)return e.data.view.filters.splice(W,1),!0}),B(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:k}],[{action:"setAttrViewFilters",avID:e.data.id,data:R,blockID:k}]);const V=C(e.target,"b3-menu");V&&(V.innerHTML=Sa(e.data))}}),_=E.element.querySelector('.b3-select[data-type="operation"]'),_==null||_.addEventListener("change",()=>{vc(_,_.value,T.type)});const z=E.element.querySelector('.b3-select[data-type="dateType"]');z==null||z.addEventListener("change",()=>{const R=E.element.querySelectorAll('[data-type="dataDirection"]'),V=R[0].parentElement,j=R[1].parentElement,W=V.previousElementSibling,Se=j.previousElementSibling;z.value==="custom"?(V.classList.remove("fn__none"),j.classList.remove("fn__none"),W.classList.add("fn__none"),Se.classList.add("fn__none")):(V.classList.add("fn__none"),j.classList.add("fn__none"),W.classList.remove("fn__none"),Se.classList.remove("fn__none"))}),E.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(R=>{R.addEventListener("change",()=>{const V=R.nextElementSibling.nextElementSibling;R.value==="0"?(V.classList.add("fn__none"),V.nextElementSibling.classList.add("fn__none")):(V.classList.remove("fn__none"),V.nextElementSibling.classList.remove("fn__none"))})});const N=E.element.querySelectorAll(".b3-text-field");["relation","select","mSelect"].includes(T.type)||N.forEach(R=>{R.addEventListener("keydown",V=>{if(V.isComposing){V.preventDefault();return}V.key==="Enter"&&(E.close(),V.preventDefault())})}),vc(_,_.value,T.type),E.open({x:v.left,y:v.bottom}),N.length>0&&N[0].select()}),Hp=e=>{const t=new Fe(p.MENU_AV_ADD_FILTER);Ge(e.data).forEach(n=>{let a;e.data.view.filters.find(s=>{if(s.column===n.id&&s.value.type===n.type)return a=s,!0}),!a&&n.type!=="lineNumber"&&t.addItem({label:n.name,iconHTML:n.icon?ge(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${gt(n.type)}"></use></svg>`,click:()=>{const s=Un(n.type,n.type==="checkbox"?{checked:void 0}:"");a={column:n.id,operator:hc(n.type),value:s},e.data.view.filters.push(a),e.menuElement.innerHTML=Sa(e.data),Ee(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height);const i=e.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);Co({empty:!0,filter:a,protyle:e.protyle,data:e.data,target:i,blockElement:e.blockElement})}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},Sa=e=>{let t="";const n=Ge(e),a=s=>{let i="";return n.find(o=>{var l,r,d,c,f,m;if(o.id===s.column&&o.type===s.value.type){let u="";["rollup","mAsset"].includes(o.type)&&(s.quantifier===""||s.quantifier==="Any"?u=window.siyuan.languages.filterQuantifierAny+" ":s.quantifier==="All"?u=window.siyuan.languages.filterQuantifierAll+" ":s.quantifier==="None"&&(u=window.siyuan.languages.filterQuantifierNone+" "));const g=o.type==="rollup"?((r=(l=s.value.rollup)==null?void 0:l.contents)==null?void 0:r.length)>0?s.value.rollup.contents[0]:{type:"rollup"}:s.value;if(s.operator==="Is empty")u=": "+u+window.siyuan.languages.filterOperatorIsEmpty;else if(s.operator==="Is not empty")u=": "+u+window.siyuan.languages.filterOperatorIsNotEmpty;else if(s.operator==="Is false")(g.type!=="checkbox"||typeof g.checkbox.checked=="boolean")&&(u=": "+u+window.siyuan.languages.unchecked);else if(s.operator==="Is true")(g.type!=="checkbox"||typeof g.checkbox.checked=="boolean")&&(u=": "+u+window.siyuan.languages.checked);else if(["created","updated","date"].includes(g.type)){let y="",b="";s.relativeDate?(y=`${window.siyuan.languages[["pastDate","current","nextDate"][s.relativeDate.direction+1]]}
 ${s.relativeDate.direction?s.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][s.relativeDate.unit]]}`,s.relativeDate2&&(b=`${window.siyuan.languages[["pastDate","current","nextDate"][s.relativeDate2.direction+1]]}
 ${s.relativeDate2.direction?s.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][s.relativeDate2.unit]]}`)):g&&((d=g[g.type])!=null&&d.content&&(y=G(g[g.type].content).format("YYYY-MM-DD")),g&&((c=g[g.type])!=null&&c.content2)&&(b=G(g[g.type].content2).format("YYYY-MM-DD"))),y&&(s.operator==="Is between"&&b?u=` ${u}${window.siyuan.languages.filterOperatorIsBetween} ${y} ${b}`:s.operator==="="?u=`: ${u}${y}`:[">","<"].includes(s.operator)?u=` ${u}${s.operator} ${y}`:s.operator===">="?u=` ${u}\u2265 ${y}`:s.operator==="<="&&(u=` ${u}\u2264 ${y}`))}else if(["mSelect","select"].includes(g.type)){let y="";((f=g.mSelect)==null?void 0:f.length)>0&&(g.mSelect.forEach((b,w)=>{y+=b.content,w!==g.mSelect.length-1&&(y+=", ")}),y&&(s.operator==="Contains"?u=`: ${u}${y}`:s.operator==="Does not contains"?u=` ${u}${window.siyuan.languages.filterOperatorDoesNotContain} ${y}`:s.operator==="="?u=`: ${u}${y}`:s.operator==="!="&&(u=` ${u}${window.siyuan.languages.filterOperatorIsNot} ${y}`))),!y&&["rollup","mAsset"].includes(o.type)&&!["Is empty","Is not empty"].includes(s.operator)&&(u="")}else if(g.type==="number"&&g.number&&g.number.isNotEmpty)["=","!=",">","<"].includes(s.operator)?u=` ${u}${s.operator} ${g.number.content}`:s.operator===">="?u=` ${u}\u2265 ${g.number.content}`:s.operator==="<="&&(u=` ${u}\u2264 ${g.number.content}`);else if(["text","block","url","mAsset","phone","email","relation","template"].includes(g.type)){let y;g[g.type]&&(g.type==="relation"?y=g.relation.blockIDs[0]||"":g.type==="mAsset"?y=((m=g.mAsset[0])==null?void 0:m.content)||"":y=g[g.type].content||"",y&&(["=","Contains"].includes(s.operator)?u=`: ${u}${y}`:s.operator==="Does not contains"?u=` ${u}${window.siyuan.languages.filterOperatorDoesNotContain} ${y}`:s.operator==="!="?u=` ${u}${window.siyuan.languages.filterOperatorIsNot} ${y}`:s.operator==="Starts with"?u=` ${u}${window.siyuan.languages.filterOperatorStartsWith} ${y}`:s.operator==="Ends with"?u=` ${u}${window.siyuan.languages.filterOperatorEndsWith} ${y}`:[">","<"].includes(s.operator)?u=` ${u}${s.operator} ${y}`:s.operator===">="?u=` ${u}\u2265 ${y}`:s.operator==="<="&&(u=` ${u}\u2264 ${y}`))),!y&&["rollup","mAsset"].includes(o.type)&&!["Is empty","Is not empty"].includes(s.operator)&&(u="")}return i+=`<span data-type="setFilter" class="b3-chip${u?" b3-chip--primary":""}">
    ${o.icon?ge(o.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${gt(o.type)}"></use></svg>`}
    <span class="fn__ellipsis">${o.name}${u}</span>
</span>`,!0}}),i};return e.view.filters.forEach(s=>{const i=a(s);i&&(t+=`<button class="b3-menu__item" draggable="true" data-id="${s.column}" data-filter-type="${s.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${i}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.view.filters.length===n.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item b3-menu__item--warning${t?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`};var Np=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const rn=(e,t)=>{if(t==="table"||C(e,"custom-attr"))return e.getAttribute("data-col-id");if(["gallery","kanban"].includes(t))return e.getAttribute("data-field-id")},kc=e=>{let t;const n=Ge(e.data);n.find((i,o)=>{if(i.id===e.colId)return t=JSON.parse(JSON.stringify(i)),n.splice(o+1,0,t),!0}),t.name=ti(t.name),t.id=Lute.NewNodeID();const a=G().format("YYYYMMDDHHmmss"),s=e.blockElement.getAttribute("data-node-id");B(e.protyle,[{action:"duplicateAttrViewKey",keyID:e.colId,nextID:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:s,data:a}],[{action:"removeAttrViewCol",id:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:s,data:e.blockElement.getAttribute("updated")}]),Ut({blockElement:e.blockElement,protyle:e.protyle,type:t.type,name:t.name,icon:t.icon,previousID:e.colId,data:e.data,id:t.id}),e.blockElement.setAttribute("updated",a)},Yn=e=>{var t,n,a,s,i;let o;Ge(e.data).find(r=>{if(r.id===e.colId)return o=r,!0});let l=`<button class="b3-menu__item" data-type="nobg" data-col-id="${e.colId}">
    <span class="block__icon${e.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator" data-id="separator_1"></button>
<button class="b3-menu__item" data-type="nobg">
    <div class="fn__block">
        <div class="fn__flex">
            <span class="b3-menu__avemoji" data-col-type="${o.type}" data-icon="${o.icon}" data-type="update-icon">${o.icon?ge(o.icon):`<svg style="width: 14px;height: 14px"><use xlink:href="#${gt(o.type)}"></use></svg>`}</span>
            <div class="b3-form__icona fn__block">
                <input data-type="name" class="b3-text-field b3-form__icona-input" type="text">
                <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${o.desc?Wt(o.desc):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
            </div>
        </div>
        <div class="fn__none">
            <div class="fn__hr"></div>
            <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" data-type="desc" class="b3-text-field fn__block" type="text" data-value="${Ue(o.desc)}">${o.desc}</textarea>
        </div>
        <div class="fn__hr--small"></div>
    </div>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${o.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${gt(o.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${sa(o.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(o.type))l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <input data-type="addOption" class="b3-text-field fn__block" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}" style="margin: 4px 0">
</button>`,o.options||(o.options=[]),o.options.forEach(r=>{const d=r.desc?`${Wt(r.name)}<div class='ft__on-surface'>${Wt(r.desc||"")}</div>`:"";l+=`<button class="b3-menu__item${l?"":" b3-menu__item--current"}" draggable="true" data-name="${Ue(r.name)}" data-desc="${Ue(r.desc||"")}" data-color="${r.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1 ariaLabel" data-position="parentW" aria-label="${d}">
        <span class="b3-chip" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">
            <span class="fn__ellipsis">${pe(r.name)}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(o.type==="number")l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${o.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${cc(o.numberFormat)}</span>
</button>`;else if(o.type==="template")l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(o.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${o.template}</textarea>
</button>`;else if(o.type==="relation"){const r=((t=o.relation)==null?void 0:t.avID)===e.data.id;l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((n=o.relation)==null?void 0:n.avID)||""}" data-old-value='${JSON.stringify(o.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${r?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(a=o.relation)!=null&&a.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${e.data.name} ${o.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else o.type==="rollup"?l+='<button class="b3-menu__separator" data-id="separator_2"></button>'+pc({colData:o}):o.type==="date"?l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${(s=o.date)!=null&&s.autoFillNow?"checked":""}>
</label>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillSpecificTime}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillSpecificTime" type="checkbox" class="b3-switch b3-switch--menu" ${(i=o.date)!=null&&i.fillSpecificTime?"checked":""}>
</label>`:["updated","created"].includes(o.type)&&(l+=`<button class="b3-menu__separator" data-id="separator_2"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="includeTime" type="checkbox" class="b3-switch b3-switch--menu" ${!o[o.type]||o[o.type].includeTime?"checked":""}>
</label>`);return l+=`<button class="b3-menu__separator" data-id="separator_3"></button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconSoftWrap"></use></svg>
    <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
    <span class="fn__space fn__flex-1"></span>
    <input type="checkbox" data-type="wrap" class="b3-switch b3-switch--menu"${o.wrap?" checked":""}>
</label>`,o.type!=="block"&&(l+=`<button class="b3-menu__item${o.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item  b3-menu__item--warning" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${l}
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${o.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${Xt("text",o.type)}
    ${Xt("number",o.type)}
    ${Xt("select",o.type)}
    ${Xt("mSelect",o.type)}
    ${Xt("date",o.type)}
    ${Xt("mAsset",o.type)}
    ${Xt("checkbox",o.type)}
    ${Xt("url",o.type)}
    ${Xt("email",o.type)}
    ${Xt("phone",o.type)}
    ${Xt("template",o.type)}
    ${Xt("relation",o.type)}
    ${Xt("rollup",o.type)}
    ${Xt("lineNumber",o.type)}
    ${Xt("created",o.type)}
    ${Xt("updated",o.type)}
</div>`},Wn=e=>{const t=e.data.id,n=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=Ge(e.data).find(u=>u.id===n),s=e.menuElement.querySelector('[data-type="name"]');s.addEventListener("blur",()=>{const u=s.value;u!==a.name&&(B(e.protyle,[{action:"updateAttrViewCol",id:n,avID:t,name:u,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:t,name:a.name,type:a.type}]),a.name=u,Gt(e.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:u}))}),s.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&(s.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),s.addEventListener("keyup",u=>{if(u.isComposing)return;const g=e.menuElement.querySelector('[data-type="colName"]');g&&g.setAttribute("placeholder",`${e.data.name} ${s.value}`)}),s.select(),s.value=a.name;const i=e.menuElement.querySelector('.b3-text-field[data-type="desc"]');s.nextElementSibling.addEventListener("click",()=>{const u=i.parentElement;u.classList.toggle("fn__none"),u.classList.contains("fn__none")||i.focus()}),i.addEventListener("blur",()=>{const u=i.value;u!==a.desc&&(B(e.protyle,[{action:"setAttrViewColDesc",id:n,avID:t,data:u}],[{action:"setAttrViewColDesc",id:n,avID:t,data:a.desc}]),a.desc=u)}),i.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),i.addEventListener("input",()=>{s.nextElementSibling.setAttribute("aria-label",i.value?pe(i.value):window.siyuan.languages.addDesc)});const o=e.menuElement.querySelector('[data-type="updateTemplate"]');o&&(o.addEventListener("blur",()=>{const u=o.value;u!==a.template&&(B(e.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:t,data:u,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:t,data:a.template,type:a.type}]),a.template=u)}),o.addEventListener("keydown",u=>{u.isComposing||(u.key==="Escape"?e.menuElement.parentElement.remove():u.key==="Enter"&&!u.shiftKey&&(o.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}));const l=e.menuElement.querySelector('.b3-switch[data-type="includeTime"]');l&&l.addEventListener("change",()=>{B(e.protyle,[{action:a.type==="updated"?"setAttrViewUpdatedIncludeTime":"setAttrViewCreatedIncludeTime",id:n,avID:t,data:l.checked}],[{action:a.type==="updated"?"setAttrViewUpdatedIncludeTime":"setAttrViewCreatedIncludeTime",id:n,avID:t,data:!l.checked}]),a[a.type]?a[a.type].includeTime=l.checked:a[a.type]={includeTime:l.checked}});const r=e.menuElement.querySelector('.b3-switch[data-type="wrap"]');r&&r.addEventListener("change",()=>{B(e.protyle,[{action:"setAttrViewColWrap",id:n,avID:t,data:r.checked,blockID:e.blockID,viewID:e.data.viewID}],[{action:"setAttrViewColWrap",id:n,avID:t,data:!r.checked,viewID:e.data.viewID,blockID:e.blockID}]),a.wrap=r.checked,e.data.view.wrapField=e.data.view.wrapField&&r.checked});const d=e.menuElement.querySelector('[data-type="addOption"]');d&&d.addEventListener("keydown",u=>{if(!u.isComposing&&(u.key==="Escape"&&e.menuElement.parentElement.remove(),u.key==="Enter")){let g=!1;if(a.options.find(y=>{if(d.value===y.name)return g=!0,!0}),g||!d.value)return;a.options.push({color:((a.options.length||0)%14+1).toString(),name:d.value}),B(e.protyle,[{action:"updateAttrViewColOptions",id:n,avID:t,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:t,data:d.value}]),e.menuElement.innerHTML=Yn({protyle:e.protyle,colId:n,data:e.data,isCustomAttr:e.isCustomAttr}),Wn({protyle:e.protyle,menuElement:e.menuElement,data:e.data,isCustomAttr:e.isCustomAttr,blockID:e.blockID}),e.menuElement.querySelector('[data-type="addOption"]').focus()}});const c=e.menuElement.querySelector('[data-type="fillCreated"]');c&&c.addEventListener("change",()=>{B(e.protyle,[{avID:t,action:"setAttrViewColDateFillCreated",id:n,data:c.checked}],[{avID:t,action:"setAttrViewColDateFillCreated",id:n,data:!c.checked}])});const f=e.menuElement.querySelector('[data-type="fillSpecificTime"]');f&&f.addEventListener("change",()=>{B(e.protyle,[{avID:t,action:"setAttrViewColDateFillSpecificTime",id:n,data:f.checked}],[{avID:t,action:"setAttrViewColDateFillSpecificTime",id:n,data:!f.checked}])});const m=e.menuElement.querySelector('[data-type="backRelation"]');if(m){m.addEventListener("change",()=>{Gi(e.menuElement,t)});const u=e.menuElement.querySelector('[data-type="goSearchAV"]'),g=JSON.parse(u.getAttribute("data-old-value")),y=e.menuElement.querySelector('[data-type="colName"]');y.addEventListener("input",()=>{Gi(e.menuElement,t)}),g.avID?L("/api/av/getAttributeView",{id:g.avID},b=>{u.querySelector(".b3-menu__accelerator").textContent=g.avID===t?window.siyuan.languages.thisDatabase:b.data.av.name||window.siyuan.languages._kernel[267],b.data.av.keyValues.find(w=>{if(w.key.id===g.backKeyID)return y.setAttribute("data-old-value",w.key.name||window.siyuan.languages._kernel[272]),y.value=w.key.name||window.siyuan.languages._kernel[272],!0}),Gi(e.menuElement,t)}):Gi(e.menuElement,t)}mc(e)},sa=e=>{switch(e){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[e];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},gt=e=>{switch(e){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},Ut=e=>{if(!e.blockElement)return;const t=e.blockElement.getAttribute("data-node-id");e.blockElement.classList.contains("av")?e.blockElement.querySelectorAll(".av__row").forEach(s=>{let i;e.previousID?i=s.querySelector(`[data-col-id="${e.previousID}"]`):i=s.querySelector(".av__cell").previousElementSibling;let o="";s.classList.contains("av__row--header")?o=`<div class="av__cell av__cell--header" draggable="true" data-icon="${e.icon||""}" data-col-id="${e.id}" data-dtype="${e.type}" data-wrap="false" style="width: 200px;">
    ${e.icon?ge(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${gt(e.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${e.name}</span>
    <div class="av__widthdrag"></div>
</div>`:o='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',i.insertAdjacentHTML("afterend",o)}):e.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${t}" data-col-id="${e.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${sa(e.type)}">
        <svg class="block__logoicon"><use xlink:href="#${gt(e.type)}"></use></svg>
        <span>${sa(e.type)}</span>
    </div>
    <div data-col-id="${e.id}" data-block-id="${t}" data-type="${e.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const n=document.querySelector(".av__panel .b3-menu");if(n&&e.data&&e.blockElement.classList.contains("av")){n.innerHTML=Yn({protyle:e.protyle,data:e.data,colId:e.id,isCustomAttr:!1}),Wn({protyle:e.protyle,data:e.data,menuElement:n,isCustomAttr:!1,blockID:t});const s=e.blockElement.querySelector(".av__views").getBoundingClientRect();s&&Ee(n,s.right-n.clientWidth,s.bottom,s.height);return}let a;e.data&&(a=Ge(e.data).find(s=>s.id===e.id)),Pt({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.id,editData:{previousID:e.previousID,colData:a||Pp(e.type,e.id,e.name)}}),window.siyuan.menus.menu.remove()},Sc=(e,t,n)=>{const a=n.getAttribute("data-dtype"),s=n.getAttribute("data-col-id"),i=t.getAttribute("data-av-id"),o=t.getAttribute("data-node-id"),l=t.getAttribute(p.CUSTOM_SY_AV_VIEW),r=n.querySelector(".av__celltext").textContent.trim(),d=n.dataset.desc,c=new Fe(p.MENU_AV_HEADER_CELL,()=>{const g=c.element.querySelector(".b3-text-field").value;g!==r&&(B(e,[{action:"updateAttrViewCol",id:s,avID:i,name:g,type:a}],[{action:"updateAttrViewCol",id:s,avID:i,name:r,type:a}]),Gt(t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{name:g}));const y=c.element.querySelector("textarea").value;y!==d&&B(e,[{action:"setAttrViewColDesc",id:s,avID:i,data:y}],[{action:"setAttrViewColDesc",id:s,avID:i,data:d}]),te(t)});c.addItem({iconHTML:"",type:"empty",label:`<div class="fn__hr"></div><div class="fn__flex">
    <div class="fn__space"></div>
    <span class="b3-menu__avemoji">${n.dataset.icon?ge(n.dataset.icon):`<svg style="height: 14px;width: 14px;"><use xlink:href="#${gt(a)}"></use></svg>`}</span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field b3-form__icona-input" type="text">
        <svg data-position="north" class="b3-form__icona-icon ariaLabel" aria-label="${d?Wt(d):window.siyuan.languages.addDesc}"><use xlink:href="#iconInfo"></use></svg>
    </div>
    <div class="fn__space"></div>
</div>
<div class="fn__none">
    <div class="fn__hr"></div>
    <div class="fn__flex">
        <span class="fn__space"></span>
        <textarea placeholder="${window.siyuan.languages.addDesc}" rows="1" class="b3-text-field fn__block" type="text" data-value="${Ue(d)}">${d}</textarea>
        <span class="fn__space"></span>    
    </div>
</div>
<div class="fn__hr--small"></div>`,bind(g){const y=g.querySelector(".b3-menu__avemoji");y.addEventListener("click",h=>{const S=y.getBoundingClientRect();ha("","av",{x:S.left,y:S.bottom+4,h:S.height,w:S.width},$=>{B(e,[{action:"setAttrViewColIcon",id:s,avID:i,data:$}],[{action:"setAttrViewColIcon",id:s,avID:i,data:n.dataset.icon}]),y.innerHTML=$?ge($):`<svg style="height: 14px;width: 14px"><use xlink:href="#${gt(a)}"></use></svg>`,Gt(t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{icon:$})},y.querySelector("img")),h.preventDefault(),h.stopPropagation()});const b=g.querySelector("input");b.value=r,b.addEventListener("keydown",h=>{h.isComposing||h.key==="Enter"&&(c.close(),h.preventDefault())});const w=g.querySelector("textarea");b.nextElementSibling.addEventListener("click",()=>{const h=w.parentElement.parentElement;h.classList.toggle("fn__none"),h.classList.contains("fn__none")||w.focus()}),w.addEventListener("keydown",h=>{h.isComposing||h.key==="Enter"&&(c.close(),h.preventDefault())}),w.addEventListener("input",()=>{b.nextElementSibling.setAttribute("aria-label",w.value?pe(w.value):window.siyuan.languages.addDesc)})}}),c.addItem({id:"edit",icon:"iconEdit",label:window.siyuan.languages.edit,click(){const g=c.element.querySelector(".b3-text-field").value;Pt({protyle:e,blockElement:t,type:"edit",colId:s,cb(y){const b=y.querySelector('.b3-text-field[data-type="name"]');b.value=g,b.select()}})}}),c.addSeparator({id:"separator_1"}),a!=="lineNumber"&&(c.addItem({id:"filter",icon:"iconFilter",label:window.siyuan.languages.filter,click(){L("/api/av/renderAttributeView",{id:i},g=>{const y=g.data;let b;y.view.filters.find(h=>{if(h.column===s&&h.value.type===a)return b=h,!0});let w=!1;b||(w=!0,b={column:s,operator:hc(a),value:Un(a,"")},y.view.filters.push(b)),Co({empty:w,filter:b,protyle:e,data:y,blockElement:t,target:t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`)})})}}),c.addItem({id:"asc",icon:"iconUp",label:window.siyuan.languages.asc,click(){L("/api/av/renderAttributeView",{id:i},g=>{B(e,[{action:"setAttrViewSorts",avID:g.data.id,data:[{column:s,order:"ASC"}],blockID:o}],[{action:"setAttrViewSorts",avID:g.data.id,data:g.data.view.sorts,blockID:o}])})}}),c.addItem({id:"desc",icon:"iconDown",label:window.siyuan.languages.desc,click(){L("/api/av/renderAttributeView",{id:i},g=>{B(e,[{action:"setAttrViewSorts",avID:g.data.id,data:[{column:s,order:"DESC"}],blockID:o}],[{action:"setAttrViewSorts",avID:g.data.id,data:g.data.view.sorts,blockID:o}])})}}));const f=n.dataset.pin==="true";if(c.addItem({id:f?"unfreezeCol":"freezeCol",icon:f?"iconUnpin":"iconPin",label:f?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){B(e,[{action:"setAttrViewColPin",id:s,avID:i,data:!f,blockID:o}],[{action:"setAttrViewColPin",id:s,avID:i,data:f,blockID:o}]),Gt(t.querySelector(`.av__row--header .av__cell[data-col-id="${s}"]`),void 0,{pin:!f})}}),a!=="block"&&c.addItem({id:"hide",icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){B(e,[{action:"setAttrViewColHidden",id:s,avID:i,data:!0,blockID:o}],[{action:"setAttrViewColHidden",id:s,avID:i,data:!1,blockID:o}])}}),c.addItem({icon:"iconRefresh",label:window.siyuan.languages.syncColWidth,click(){B(e,[{action:"syncAttrViewTableColWidth",keyID:s,avID:i,id:l}])}}),c.addItem({icon:"iconSoftWrap",label:`<label class="fn__flex fn__pointer"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(g){const y=g.querySelector(".b3-switch");y.addEventListener("change",()=>{n.dataset.wrap=y.checked.toString(),B(e,[{action:"setAttrViewColWrap",id:s,avID:i,data:y.checked,blockID:o,viewID:l}],[{action:"setAttrViewColWrap",id:s,avID:i,data:!y.checked,blockID:o,viewID:l}]),c.close()})}}),c.addSeparator({id:"separator_2"}),c.addItem({id:"insertColumnLeft",icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var g;const y=os(e,t,((g=n.previousElementSibling)==null?void 0:g.getAttribute("data-col-id"))||"");t.contains(n)||(n=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${s}"]`));const b=n.getBoundingClientRect();y.open({x:b.left,y:b.bottom,h:b.height})}}),c.addItem({id:"insertColumnRight",icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const g=os(e,t,s);t.contains(n)||(n=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${s}"]`));const y=n.getBoundingClientRect();g.open({x:y.left,y:y.bottom,h:y.height})}}),a!=="block"){let g;a!=="relation"&&c.addItem({id:"duplicate",icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){L("/api/av/renderAttributeView",{id:i},y=>{kc({blockElement:t,viewID:l,protyle:e,colId:s,data:y.data})})}}),c.addItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){return Np(this,null,function*(){var y;if(a==="relation"){const w=(yield he("/api/av/getAttributeView",{id:i})).data.av.keyValues.find(h=>h.key.id===s);if((y=w.key.relation)!=null&&y.isTwoWay){const h=yield he("/api/av/getAttributeView",{id:w.key.relation.avID}),S=new ke({title:window.siyuan.languages.removeColConfirm,content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",w.key.name||window.siyuan.languages._kernel[272]).replace("${y}",h.data.av.name||window.siyuan.languages._kernel[267]).replace("${z}",h.data.av.keyValues.find($=>$.key.id===w.key.relation.backKeyID).key.name||window.siyuan.languages._kernel[272])}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="delete">${window.siyuan.languages.removeBothRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--remove" data-action="keep-relation">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
</div>`,width:"520px"});S.element.addEventListener("click",$=>{let D=$.target;const v=typeof $.detail=="string";for(;D&&D!==S.element||v;){const k=D.getAttribute("data-action");if(k==="delete"||v&&$.detail==="Enter"){To({protyle:e,colId:s,avID:i,blockID:o,oldValue:r,type:a,cellElement:n,blockElement:t,removeDest:!0}),S.destroy();break}else if(k==="keep-relation"){To({protyle:e,colId:s,avID:i,blockID:o,oldValue:r,type:a,cellElement:n,blockElement:t,removeDest:!1}),S.destroy();break}else if(D.classList.contains("b3-button--cancel")||v&&$.detail==="Escape"){S.destroy();break}D=D.parentElement}}),S.element.querySelector("button").focus(),S.element.setAttribute("data-key",p.DIALOG_CONFIRM);return}}To({protyle:e,colId:s,avID:i,blockID:o,oldValue:r,type:a,cellElement:n,blockElement:t,removeDest:!1})})}})}const m=n.getBoundingClientRect();c.open({x:m.left,y:m.bottom,h:m.height});const u=window.siyuan.menus.menu.element.querySelector(".b3-text-field");u&&(u.select(),u.focus())},To=e=>{var t;const n=G().format("YYYYMMDDHHmmss");B(e.protyle,[{action:"removeAttrViewCol",id:e.colId,avID:e.avID,removeDest:e.removeDest},{action:"doUpdateUpdated",id:e.blockID,data:n}],[{action:"addAttrViewCol",name:e.oldValue,avID:e.avID,type:e.type,id:e.colId,previousID:((t=e.cellElement.previousElementSibling)==null?void 0:t.getAttribute("data-col-id"))||""},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),rd(e.blockElement,e.colId),e.blockElement.setAttribute("updated",n)},Io=e=>{const t=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let n="";const a=e.fields.find((i,o)=>{var l;if(i.id===t)return n=(l=e.fields[o-1])==null?void 0:l.id,e.fields.splice(o,1),!0}),s=G().format("YYYYMMDDHHmmss");B(e.protyle,[{action:"removeAttrViewCol",id:t,avID:e.avID,removeDest:e.isTwoWay},{action:"doUpdateUpdated",id:e.blockID,data:s}],[{action:"addAttrViewCol",name:a.name,avID:e.avID,type:a.type,id:t,previousID:n},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),rd(e.blockElement,t),e.blockElement.setAttribute("updated",s),e.isCustomAttr?e.avPanelElement.remove():(e.menuElement.innerHTML=ka(e.fields),Ee(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height))},Xt=(e,t)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${t}" data-new-type="${e}">
    <svg class="b3-menu__icon"><use xlink:href="#${gt(e)}"></use></svg>
    <span class="b3-menu__label">${sa(e)}</span>
    ${e===t?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,os=(e,t,n)=>{const a=new Fe(p.MENU_AV_HEADER_ADD),s=t.getAttribute("data-av-id");typeof n=="undefined"&&t.getAttribute("data-av-type")==="table"&&(n=Array.from(t.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const i=t.getAttribute("data-node-id");return a.addItem({id:"text",icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:s,type:"text",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"text",name:window.siyuan.languages.text,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"number",icon:"iconNumber",label:window.siyuan.languages.number,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:s,type:"number",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"number",name:window.siyuan.languages.number,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"select",icon:"iconListItem",label:window.siyuan.languages.select,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:s,type:"select",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"select",name:window.siyuan.languages.select,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"multiSelect",icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:s,type:"mSelect",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"mSelect",name:window.siyuan.languages.multiSelect,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"date",icon:"iconCalendar",label:window.siyuan.languages.date,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:s,type:"date",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"date",name:window.siyuan.languages.date,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"assets",icon:"iconImage",label:window.siyuan.languages.assets,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:s,type:"mAsset",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"mAsset",name:window.siyuan.languages.assets,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"checkbox",icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:s,type:"checkbox",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"checkbox",name:window.siyuan.languages.checkbox,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"link",icon:"iconLink",label:window.siyuan.languages.link,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:s,type:"url",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"url",name:window.siyuan.languages.link,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"email",icon:"iconEmail",label:window.siyuan.languages.email,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:s,type:"email",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"email",name:window.siyuan.languages.email,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"phone",icon:"iconPhone",label:window.siyuan.languages.phone,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:s,type:"phone",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"phone",name:window.siyuan.languages.phone,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"template",icon:"iconMath",label:window.siyuan.languages.template,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:s,type:"template",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"template",name:window.siyuan.languages.template,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"relation",icon:"iconOpen",label:window.siyuan.languages.relation,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:s,type:"relation",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"relation",name:window.siyuan.languages.relation,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"rollup",icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:s,type:"rollup",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"rollup",name:window.siyuan.languages.rollup,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"lineNumber",icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:s,type:"lineNumber",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"createdTime",icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:s,type:"created",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"created",name:window.siyuan.languages.createdTime,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({id:"updatedTime",icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const o=Lute.NewNodeID(),l=G().format("YYYYMMDDHHmmss");B(e,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:s,type:"updated",id:o,previousID:n},{action:"doUpdateUpdated",id:i,data:l}],[{action:"removeAttrViewCol",id:o,avID:s},{action:"doUpdateUpdated",id:i,data:t.getAttribute("updated")}]),Ut({blockElement:t,protyle:e,type:"updated",name:window.siyuan.languages.updatedTime,id:o,previousID:n}),t.setAttribute("updated",l)}}),a},Pp=(e,t,n)=>({hidden:!1,icon:"",id:t,name:n,desc:"",numberFormat:"",pin:!1,template:"",type:e,width:"",wrap:void 0,calc:null});var Op=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const qp=(e,t)=>{let n="";return["mSelect","select"].includes(e.groupValue.type)?e.groupValue.mSelect.forEach(a=>{n+=`<span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">${pe(a.content)}</span>`}):e.groupValue.type==="checkbox"?n=`<svg style="width:calc(1.625em - 12px);height:calc(1.625em - 12px);margin: 4px 0;float: left;"><use xlink:href="#icon${e.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg>`:n=e.name,`<div class="av__group-title">
    <span class="av__group-name fn__ellipsis" style="white-space: nowrap;">${n}</span>
    ${t===0?'<span class="fn__space"></span>':`<span aria-label="${window.siyuan.languages.entryNum}" data-position="north" class="av__group-counter ariaLabel">${t}</span>`}
    <span class="fn__flex-1"></span>
    <span class="av__group-icon av__group-icon--hover ariaLabel" data-type="av-add-top" data-position="north" aria-label="${window.siyuan.languages.newRow}"><svg><use xlink:href="#iconAdd"></use></svg></span>
</div>`},Rp=e=>{let t="";return e.cards.forEach((n,a)=>{if(t+=`<div data-id="${n.id}" draggable="true" class="av__gallery-item">`,e.coverFrom!==0){const s="av__gallery-cover av__gallery-cover--"+e.cardAspectRatio;n.coverURL?n.coverURL.startsWith("background")?t+=`<div class="${s}"><img class="av__gallery-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" style="${n.coverURL}"></div>`:t+=`<div class="${s}"><img loading="lazy" class="av__gallery-img${e.fitImage?" av__gallery-img--fit":""}" src="${zi(n.coverURL)}"></div>`:n.coverContent.trim()&&(t+=`<div class="${s}"><div class="av__gallery-content">${n.coverContent}</div><div></div></div>`)}t+='<div class="av__gallery-fields">',n.values.forEach((s,i)=>{var o,l,r;if(e.fields[i].hidden)return;let d="";s.valueType==="checkbox"&&(d=(l=(o=s.value)==null?void 0:o.checkbox)!=null&&l.checked?" av__cell-check":" av__cell-uncheck");const c=xo(s.value);let f=Ue(e.fields[i].name)||sa(e.fields[i].type);e.fields[i].desc&&(f+=Ue(`<div class="ft__on-surface">${e.fields[i].desc}</div>`)),s.valueType==="checkbox"&&!e.displayFieldName&&(s.value.checkbox.content=e.fields[i].name||sa(e.fields[i].type));const m=`<div class="av__cell${d}${e.displayFieldName?"":" ariaLabel"}" 
data-wrap="${e.fields[i].wrap}" 
aria-label="${f}" 
data-position="5west"
data-id="${s.id}" 
data-field-id="${e.fields[i].id}" 
data-dtype="${s.valueType}" 
${(r=s.value)!=null&&r.isDetached?' data-detached="true"':""} 
style="${s.bgColor?`background-color:${s.bgColor};`:""}
${s.color?`color:${s.color};`:""}">${Fn(s.value,a,e.showIcon,"kanban")}</div>`;e.displayFieldName?t+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${c}">
    <div class="av__gallery-name">
        ${e.fields[i].icon?ge(e.fields[i].icon,void 0,!0):`<svg><use xlink:href="#${gt(e.fields[i].type)}"></use></svg>`}${Lute.EscapeHTMLStr(e.fields[i].name)}
        ${e.fields[i].desc?`<svg aria-label="${e.fields[i].desc}" data-position="north" class="ariaLabel"><use xlink:href="#iconInfo"></use></svg>`:""}
    </div>
    ${m}
</div>`:t+=`<div class="av__gallery-field" data-empty="${c}">
    <div class="av__gallery-tip">
        ${e.fields[i].icon?ge(e.fields[i].icon,void 0,!0):`<svg><use xlink:href="#${gt(e.fields[i].type)}"></use></svg>`}${window.siyuan.languages.edit} ${Lute.EscapeHTMLStr(e.fields[i].name)}
    </div>
    ${m}
</div>`}),t+=`</div>
    <div class="av__gallery-actions">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.displayEmptyFields}" data-type="av-gallery-edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.more}" data-type="av-gallery-more"><svg><use xlink:href="#iconMore"></use></svg></span>
    </div>
</div>`}),t+=`<div class="av__gallery-add" data-type="av-add-bottom"><svg class="svg"><use xlink:href="#iconAdd"></use></svg><span class="fn__space"></span>${window.siyuan.languages.newRow}</div>`,`<div class="av__gallery av__gallery--small">
    ${t}
</div>
<div class="av__gallery-load${e.cardCount>e.cards.length?"":" fn__none"}">
    <button class="b3-button av__button" data-type="av-load-more">
        <svg><use xlink:href="#iconArrowDown"></use></svg>
        <span>${window.siyuan.languages.loadMore}</span>
        <svg data-type="set-page-size" data-size="${e.pageSize}"><use xlink:href="#iconMore"></use></svg>
    </button>
</div>`},$o=e=>Op(void 0,null,function*(){var t,n,a;const s=e.blockElement.querySelector('[data-type="av-search"]'),i=[];e.blockElement.querySelectorAll(".av__gallery-fields--edit").forEach(y=>{i.push({groupId:C(y,"av__body").dataset.groupId||"",fieldId:y.parentElement.getAttribute("data-id")})});const o=[];e.blockElement.querySelectorAll(".av__gallery-item--select").forEach(y=>{const b=y.getAttribute("data-id");b&&o.push({groupId:C(y,"av__body").dataset.groupId||"",fieldId:b})});const l={};e.blockElement.querySelectorAll(".av__body").forEach(y=>{l[y.dataset.groupId||"unGroup"]=y.dataset.pageSize});const r={isSearching:s&&document.activeElement===s,query:(s==null?void 0:s.value)||"",alignSelf:e.blockElement.style.alignSelf,oldOffset:e.protyle.contentElement.scrollTop,editIds:i,selectItemIds:o,pageSizes:l,left:(t=e.blockElement.querySelector(".av__kanban"))==null?void 0:t.scrollLeft};e.blockElement.firstElementChild.innerHTML===""&&(e.blockElement.style.alignSelf="",e.blockElement.firstElementChild.outerHTML=`<div class="av__kanban fn__flex">
    <span style="width: 260px;height: 178px;" class="av__pulse"></span>
    <span style="width: 260px;height: 178px;" class="av__pulse"></span>
    <span style="width: 260px;height: 178px;" class="av__pulse"></span>
</div>`);const d=(n=e.protyle.options.history)==null?void 0:n.created,c=(a=e.protyle.options.history)==null?void 0:a.snapshot;let f=e.data;if(!f){const y=tl(e.blockElement);f=(yield he(d?"/api/av/renderHistoryAttributeView":c?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:e.blockElement.getAttribute("data-av-id"),created:d,snapshot:c,pageSize:y.unGroupPageSize,groupPaging:y.groupPageSize,viewID:e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW)||"",query:r.query.trim()})).data}if(f.viewType==="table"){e.blockElement.setAttribute("data-av-type","table"),ot(e.blockElement,e.protyle,e.cb,e.renderAll,f);return}if(f.viewType==="gallery"){e.blockElement.setAttribute("data-av-type",f.viewType),Mo({blockElement:e.blockElement,protyle:e.protyle,cb:e.cb,renderAll:e.renderAll,data:f});return}const m=f.view;let u="",g=!1;if(m.groups.forEach(y=>{var b;if(y.groupHidden===0){let w="";y.fillColBackgroundColor&&(["mSelect","select"].includes(y.groupValue.type)&&(g=!0),g&&(y.groupValue.mSelect&&y.groupValue.mSelect.length>0?w=`style="--b3-av-kanban-background: var(--b3-font-background${y.groupValue.mSelect[0].color});"`:w='style="--b3-av-kanban-background: var(--b3-border-color);"')),u+=`<div class="av__kanban-group${y.cardSize===0?" av__kanban-group--small":y.cardSize===2?" av__kanban-group--big":""}"${w}>
    ${qp(y,y.cardCount)}
    <div data-group-id="${y.id}" data-page-size="${y.pageSize}" data-dtype="${y.groupKey.type}" data-content="${Lute.EscapeHTMLStr(((b=y.groupValue.text)==null?void 0:b.content)||"")}" class="av__body">${Rp(y)}</div>
</div>`}}),e.renderAll)e.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${rs(f,r.isSearching||!!r.query,!e.protyle.disabled&&!O(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__kanban${g?" av__kanban--bg":""}">
        ${u}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`;else{const y=e.blockElement.querySelector(".av__kanban");y.innerHTML=u,g?y.classList.add("av__kanban--bg"):y.classList.remove("av__kanban--bg")}Do({resetData:r,renderAll:e.renderAll,data:f,cb:e.cb,protyle:e.protyle,blockElement:e.blockElement}),m.hideAttrViewName&&e.blockElement.querySelector(".av__gallery").classList.add("av__gallery--top")});var Bp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Ac=e=>{let t="";return e.cards.forEach((n,a)=>{if(t+=`<div data-id="${n.id}" draggable="true" class="av__gallery-item">`,e.coverFrom!==0){const s="av__gallery-cover av__gallery-cover--"+e.cardAspectRatio;n.coverURL?n.coverURL.startsWith("background")?t+=`<div class="${s}"><img class="av__gallery-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" style="${n.coverURL}"></div>`:t+=`<div class="${s}"><img loading="lazy" class="av__gallery-img${e.fitImage?" av__gallery-img--fit":""}" src="${zi(n.coverURL)}"></div>`:n.coverContent?t+=`<div class="${s}"><div class="av__gallery-content">${n.coverContent}</div><div></div></div>`:t+=`<div class="${s}"></div>`}t+='<div class="av__gallery-fields">',n.values.forEach((s,i)=>{var o,l,r;if(e.fields[i].hidden)return;let d="";s.valueType==="checkbox"&&(d=(l=(o=s.value)==null?void 0:o.checkbox)!=null&&l.checked?" av__cell-check":" av__cell-uncheck");const c=xo(s.value);let f=Ue(e.fields[i].name)||sa(e.fields[i].type);e.fields[i].desc&&(f+=Ue(`<div class="ft__on-surface">${e.fields[i].desc}</div>`)),s.valueType==="checkbox"&&!e.displayFieldName&&(s.value.checkbox.content=e.fields[i].name||sa(e.fields[i].type));const m=`<div class="av__cell${d}${e.displayFieldName?"":" ariaLabel"}" 
data-wrap="${e.fields[i].wrap}" 
aria-label="${f}" 
data-position="5west"
data-id="${s.id}" 
data-field-id="${e.fields[i].id}" 
data-dtype="${s.valueType}" 
${(r=s.value)!=null&&r.isDetached?' data-detached="true"':""} 
style="${s.bgColor?`background-color:${s.bgColor};`:""}
${s.color?`color:${s.color};`:""}">${Fn(s.value,a,e.showIcon,"gallery")}</div>`;e.displayFieldName?t+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${c}">
    <div class="av__gallery-name">
        ${e.fields[i].icon?ge(e.fields[i].icon,void 0,!0):`<svg><use xlink:href="#${gt(e.fields[i].type)}"></use></svg>`}${Lute.EscapeHTMLStr(e.fields[i].name)}
        ${e.fields[i].desc?`<svg aria-label="${e.fields[i].desc}" data-position="north" class="ariaLabel"><use xlink:href="#iconInfo"></use></svg>`:""}
    </div>
    ${m}
</div>`:t+=`<div class="av__gallery-field" data-empty="${c}">
    <div class="av__gallery-tip">
        ${e.fields[i].icon?ge(e.fields[i].icon,void 0,!0):`<svg><use xlink:href="#${gt(e.fields[i].type)}"></use></svg>`}${window.siyuan.languages.edit} ${Lute.EscapeHTMLStr(e.fields[i].name)}
    </div>
    ${m}
</div>`}),t+=`</div>
    <div class="av__gallery-actions">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.displayEmptyFields}" data-type="av-gallery-edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.more}" data-type="av-gallery-more"><svg><use xlink:href="#iconMore"></use></svg></span>
    </div>
</div>`}),t+=`<div class="av__gallery-add" data-type="av-add-bottom"><svg class="svg"><use xlink:href="#iconAdd"></use></svg><span class="fn__space"></span>${window.siyuan.languages.newRow}</div>`,`<div class="av__gallery${e.cardSize===0?" av__gallery--small":e.cardSize===2?" av__gallery--big":""}">
    ${t}
</div>
<div class="av__gallery-load${e.cardCount>e.cards.length?"":" fn__none"}">
    <button class="b3-button av__button" data-type="av-load-more">
        <svg><use xlink:href="#iconArrowDown"></use></svg>
        <span>${window.siyuan.languages.loadMore}</span>
        <svg data-type="set-page-size" data-size="${e.pageSize}"><use xlink:href="#iconMore"></use></svg>
    </button>
</div>`},Up=e=>{const t=e.blockElement.querySelector('[data-type="av-search"]'),n=t&&document.activeElement===t,a=(t==null?void 0:t.value)||"";let s="";e.data.view.groups.forEach(i=>{var o;i.groupHidden===0&&(s+=`${xc(i,i.cardCount)}
<div data-group-id="${i.id}" data-page-size="${i.pageSize}" data-dtype="${i.groupKey.type}" data-content="${Lute.EscapeHTMLStr(((o=i.groupValue.text)==null?void 0:o.content)||"")}" class="av__body${i.groupFolded?" fn__none":""}">${Ac(i)}</div>`)}),e.renderAll?e.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${rs(e.data,n||!!a,!e.protyle.disabled&&!O(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div>
        ${s}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`:e.blockElement.querySelector(".av__header").nextElementSibling.innerHTML=s,Do(e)},Do=e=>{const t=e.data.view;if((t.coverFrom===1||t.coverFrom===3)&&Xe(e.blockElement),typeof e.resetData.oldOffset=="number"&&(e.protyle.contentElement.scrollTop=e.resetData.oldOffset),e.blockElement.getAttribute("data-need-focus")==="true"&&(te(e.blockElement),e.blockElement.removeAttribute("data-need-focus")),e.blockElement.setAttribute("data-render","true"),e.resetData.alignSelf&&(e.blockElement.style.alignSelf=e.resetData.alignSelf),e.resetData.left&&(e.blockElement.querySelector(".av__kanban").scrollLeft=e.resetData.left),e.resetData.selectItemIds.find(s=>{let i=e.blockElement.querySelector(`.av__body[data-group-id="${s.groupId}"] .av__gallery-item[data-id="${s.fieldId}"]`);i||(i=e.blockElement.querySelector(`.av__gallery-item[data-id="${s.fieldId}"]`)),i&&i.classList.add("av__gallery-item--select")}),e.resetData.editIds.find(s=>{let i=e.blockElement.querySelector(`.av__body[data-group-id="${s.groupId}"] .av__gallery-item[data-id="${s.fieldId}"]`);i||(i=e.blockElement.querySelector(`.av__gallery-item[data-id="${s.fieldId}"]`)),i&&(i.querySelector(".av__gallery-fields").classList.add("av__gallery-fields--edit"),i.querySelector('.protyle-icon[data-type="av-gallery-edit"]').setAttribute("aria-label",window.siyuan.languages.hideEmptyFields))}),Object.keys(e.resetData.pageSizes).forEach(s=>{const i=e.blockElement.querySelector(`.av__body[data-group-id="${s==="unGroup"?"":s}"]`);i&&(i.dataset.pageSize=e.resetData.pageSizes[s])}),getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(!C(s.startContainer,"av__title")){const i=F(s.startContainer);i&&e.blockElement===i&&!e.resetData.isSearching&&te(e.blockElement)}}if(e.blockElement.querySelector(".layout-tab-bar").scrollLeft=e.blockElement.querySelector(".layout-tab-bar .item--focus").offsetLeft-30,e.cb&&e.cb(e.data),!e.renderAll)return;const n=e.blockElement.querySelector(".av__views"),a=e.blockElement.querySelector('[data-type="av-search"]');a.value=e.resetData.query||"",e.resetData.isSearching&&a.focus(),a.addEventListener("compositionstart",s=>{s.stopPropagation()}),a.addEventListener("keydown",s=>{s.isComposing||Rn(s)}),a.addEventListener("input",s=>{s.stopPropagation(),!s.isComposing&&(a.value||document.activeElement===a?n.classList.add("av__views--show"):n.classList.remove("av__views--show"),yi(e.blockElement,e.protyle))}),a.addEventListener("compositionend",()=>{yi(e.blockElement,e.protyle)}),a.addEventListener("blur",s=>{s.isComposing||a.value||(n.classList.remove("av__views--show"),a.style.width="0",a.style.paddingLeft="0",a.style.paddingRight="0")}),es({inputElement:a,right:0,width:"1em",height:a.clientHeight,clearCB(){n.classList.remove("av__views--show"),a.style.width="0",a.style.paddingLeft="0",a.style.paddingRight="0",te(e.blockElement),yi(e.blockElement,e.protyle)}})},Mo=e=>Bp(void 0,null,function*(){var t,n,a;const s=e.blockElement.querySelector('[data-type="av-search"]'),i=[];e.blockElement.querySelectorAll(".av__gallery-fields--edit").forEach(g=>{i.push({groupId:C(g,"av__body").dataset.groupId||"",fieldId:g.parentElement.getAttribute("data-id")})});const o=[];e.blockElement.querySelectorAll(".av__gallery-item--select").forEach(g=>{const y=g.getAttribute("data-id");y&&o.push({groupId:C(g,"av__body").dataset.groupId||"",fieldId:y})});const l={};e.blockElement.querySelectorAll(".av__body").forEach(g=>{l[g.dataset.groupId||"unGroup"]=g.dataset.pageSize});const r={isSearching:s&&document.activeElement===s,query:(s==null?void 0:s.value)||"",alignSelf:e.blockElement.style.alignSelf,oldOffset:e.protyle.contentElement.scrollTop,editIds:i,selectItemIds:o,pageSizes:l};e.blockElement.firstElementChild.innerHTML===""&&(e.blockElement.style.alignSelf="",e.blockElement.firstElementChild.outerHTML=`<div class="av__gallery">
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
    <span style="width: 100%;height: 178px;" class="av__pulse"></span>
</div>`);const d=(t=e.protyle.options.history)==null?void 0:t.created,c=(n=e.protyle.options.history)==null?void 0:n.snapshot;let f=e.data;if(!f){const g=tl(e.blockElement);f=(yield he(d?"/api/av/renderHistoryAttributeView":c?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:e.blockElement.getAttribute("data-av-id"),created:d,snapshot:c,pageSize:g.unGroupPageSize,groupPaging:g.groupPageSize,viewID:e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW)||"",query:r.query.trim()})).data}if(f.viewType==="table"){e.blockElement.setAttribute("data-av-type",f.viewType),ot(e.blockElement,e.protyle,e.cb,e.renderAll,f);return}if(f.viewType==="kanban"){e.blockElement.setAttribute("data-av-type",f.viewType),$o({blockElement:e.blockElement,protyle:e.protyle,cb:e.cb,renderAll:e.renderAll,data:f});return}const m=f.view;if(((a=m.groups)==null?void 0:a.length)>0){Up({blockElement:e.blockElement,protyle:e.protyle,cb:e.cb,renderAll:e.renderAll,data:f,resetData:r});return}const u=Ac(m);if(e.renderAll)e.blockElement.firstElementChild.outerHTML=`<div class="av__container fn__block">
    ${rs(f,r.isSearching||!!r.query,!e.protyle.disabled&&!O(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div>
        <div class="av__body" data-group-id="" data-page-size="${m.pageSize}">
            ${u}
        </div>
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`;else{const g=e.blockElement.querySelector(".av__body");g.innerHTML=u,g.dataset.pageSize=m.pageSize.toString()}Do({resetData:r,renderAll:e.renderAll,data:f,cb:e.cb,protyle:e.protyle,blockElement:e.blockElement}),m.hideAttrViewName&&e.blockElement.querySelector(".av__gallery").classList.add("av__gallery--top")});var Fp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const rs=(e,t,n)=>{let a="",s,i=!1;return Ge(e).forEach(o=>{i||e.view.filters.find(l=>{if(l.value.type===o.type&&o.id===l.column)return i=!0,!0})}),e.views.forEach(o=>{a+=`<div draggable="true" data-position="north" data-av-type="${o.type}" data-id="${o.id}" data-page="${o.pageSize}" data-desc="${Wt(o.desc||"")}" class="ariaLabel item${o.id===e.viewID?" item--focus":""}">
    ${o.icon?ge(o.icon,"item__graphic",!0):`<svg class="item__graphic"><use xlink:href="#${Ps(o.type)}"></use></svg>`}
    <span class="item__text">${pe(o.name)}</span>
</div>`,o.id===e.viewID&&(s=o)}),`<div class="av__header">
        <div class="fn__flex av__views${t?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${a}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" aria-label="${window.siyuan.languages.allViews}" data-position="8south" class="ariaLabel block__icon${e.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${e.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" aria-label="${window.siyuan.languages.filter}" data-position="8south" class="ariaLabel block__icon${i?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" aria-label="${window.siyuan.languages.sort}" data-position="8south" class="ariaLabel block__icon${e.view.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <button data-type="av-search-icon" aria-label="${window.siyuan.languages.search}" data-position="8south" class="ariaLabel block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </button>
            <div style="position: relative" class="fn__flex">
                <input style="${t?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" aria-label="${window.siyuan.languages.config}" data-position="8south" class="ariaLabel block__icon">
                <svg><use xlink:href="#iconSettings"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${e.isMirror?` <span data-av-id="${e.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8south" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${n}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${s.hideAttrViewName?" fn__none":""}" data-title="${e.name||""}" data-tip="${window.siyuan.languages._kernel[267]}">${e.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>`},Lc=(e,t)=>{let n="",a='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',s=-1,i=-1,o=0;const l=t.clientWidth;e.columns.forEach((d,c)=>{d.hidden||(d.pin&&(s=c),o<l-200&&(o+=parseInt(d.width)||200,i=c))}),l===0&&(i=s),s=Math.min(s,i),s>-1&&(a='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',n='<div class="av__colsticky">');let r=!1;return e.columns.forEach((d,c)=>{var f;d.hidden||(a+=`<div class="av__cell av__cell--header" data-col-id="${d.id}"  draggable="true" 
data-icon="${d.icon}" data-dtype="${d.type}" data-wrap="${d.wrap}" data-pin="${d.pin}" 
data-desc="${Ue(d.desc)}" data-position="north" 
style="width: ${d.width||"200px"};">
    ${d.icon?ge(d.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${gt(d.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${pe(d.name)}</span>
    ${d.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,s===c&&(a+="</div>"),d.type==="lineNumber"?n+=`<div data-col-id="${d.id}" data-dtype="${d.type}" class="av__calc" style="width: ${d.width||"200px"}">&nbsp;</div>`:n+=`<div class="av__calc${d.calc&&d.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${d.id}" data-dtype="${d.type}" data-operator="${((f=d.calc)==null?void 0:f.operator)||""}" 
style="width: ${d.width||"200px"}">${Yf(d)||`<svg><use xlink:href="#iconDown"></use></svg><small>${window.siyuan.languages.calc}</small>`}</div>`,d.calc&&d.calc.operator!==""&&(r=!0),s===c&&(n+="</div>"))}),a+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4south"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,e.rows.forEach((d,c)=>{a+=`<div class="av__row" data-id="${d.id}">`,s>-1?a+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':a+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>',d.cells.forEach((f,m)=>{var u,g,y;if(e.columns[m].hidden)return;let b="";f.valueType==="checkbox"&&(b=(g=(u=f.value)==null?void 0:u.checkbox)!=null&&g.checked?" av__cell-check":" av__cell-uncheck"),a+=`<div class="av__cell${b}" data-id="${f.id}" data-col-id="${e.columns[m].id}" 
data-wrap="${e.columns[m].wrap}" 
data-dtype="${e.columns[m].type}" 
${(y=f.value)!=null&&y.isDetached?' data-detached="true"':""} 
style="width: ${e.columns[m].width||"200px"};
${f.valueType==="number"?"text-align: right;":""}
${f.bgColor?`background-color:${f.bgColor};`:""}
${f.color?`color:${f.color};`:""}">${Fn(f.value,c,e.showIcon)}</div>`,s===m&&(a+="</div>")}),a+="<div></div></div>"}),`${a}<div class="av__row--util${e.rowCount>e.rows.length?" av__readonly--show":""}">
    <div class="av__colsticky">
        <button class="b3-button av__button" data-type="av-add-bottom">
            <svg><use xlink:href="#iconAdd"></use></svg>
            <span>${window.siyuan.languages.newRow}</span>
        </button>
        <span class="fn__space"></span>
        <button class="b3-button av__button${e.rowCount>e.rows.length?"":" fn__none"}" data-type="av-load-more">
            <svg><use xlink:href="#iconArrowDown"></use></svg>
            <span>${window.siyuan.languages.loadMore}</span>
            <svg data-type="set-page-size" data-size="${e.pageSize}"><use xlink:href="#iconMore"></use></svg>
        </button>
    </div>
</div>
<div class="av__row--footer${r?" av__readonly--show":""}">${n}</div>`},xc=(e,t)=>{let n="";return["mSelect","select"].includes(e.groupValue.type)?e.groupValue.mSelect.forEach(a=>{n+=`<span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">${pe(a.content)}</span>`}):e.groupValue.type==="checkbox"?n=`<svg style="width:calc(1.625em - 12px);height:calc(1.625em - 12px)"><use xlink:href="#icon${e.groupValue.checkbox.checked?"Check":"Uncheck"}"></use></svg>`:n=e.name,`<div class="av__group-title">
    <div class="av__group-icon" data-type="av-group-fold" data-id="${e.id}">
        <svg class="${e.groupFolded?"":"av__group-arrow--open"}"><use xlink:href="#iconRight"></use></svg>
    </div>
    <span class="fn__space"></span>
    <span class="av__group-name">${n}</span>
    ${t===0?'<span class="fn__space"></span>':`<span aria-label="${window.siyuan.languages.entryNum}" data-position="north" class="av__group-counter ariaLabel">${t}</span>`}
    <span class="av__group-icon av__group-icon--hover ariaLabel" data-type="av-add-top" data-position="north" aria-label="${window.siyuan.languages.newRow}"><svg><use xlink:href="#iconAdd"></use></svg></span>
</div>`},Yp=e=>{const t=e.blockElement.querySelector('[data-type="av-search"]'),n=t&&document.activeElement===t,a=(t==null?void 0:t.value)||"";let s="";e.data.view.groups.forEach(i=>{var o;i.groupHidden===0&&(s+=`${xc(i,i.rowCount)}
<div data-group-id="${i.id}" data-page-size="${i.pageSize}" data-dtype="${i.groupKey.type}" data-content="${Lute.EscapeHTMLStr(((o=i.groupValue.text)==null?void 0:o.content)||"")}" style="float: left" class="av__body${i.groupFolded?" fn__none":""}">${Lc(i,e.blockElement)}</div>`)}),e.renderAll?e.blockElement.firstElementChild.outerHTML=`<div class="av__container">
    ${rs(e.data,n||!!a,!e.protyle.disabled&&!O(e.blockElement,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__scroll">
        ${s}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`:e.blockElement.firstElementChild.querySelector(".av__scroll").innerHTML=s,Cc(e)},Cc=e=>{var t;e.blockElement.getAttribute("data-need-focus")==="true"&&(te(e.blockElement),e.blockElement.removeAttribute("data-need-focus")),e.blockElement.setAttribute("data-render","true"),e.blockElement.querySelector(".av__scroll").scrollLeft=e.resetData.left,e.blockElement.style.alignSelf=e.resetData.alignSelf;const n=e.protyle.contentElement.getBoundingClientRect();if(e.resetData.headerTransform){const i=e.blockElement.querySelector(`.av__body[data-group-id="${e.resetData.headerTransform.groupId}"] .av__row--header`);i&&(i.style.transform=e.resetData.headerTransform.transform)}else setTimeout(()=>{xa(e.blockElement,n,"top")},p.TIMEOUT_LOAD);if(e.resetData.footerTransform){const i=e.blockElement.querySelector(`.av__body[data-group-id="${e.resetData.footerTransform.groupId}"] .av__row--footer`);i&&(i.style.transform=e.resetData.footerTransform.transform)}else setTimeout(()=>{xa(e.blockElement,n,"bottom")},p.TIMEOUT_LOAD);if(e.resetData.selectCellId){let i=e.blockElement.querySelector(`.av__body[data-group-id="${e.resetData.selectCellId.groupId}"] .av__row[data-id="${e.resetData.selectCellId.rowId}"] .av__cell[data-col-id="${e.resetData.selectCellId.colId}"]`);i||(i=e.blockElement.querySelector(`.av__row[data-id="${e.resetData.selectCellId.rowId}"] .av__cell[data-col-id="${e.resetData.selectCellId.colId}"]`)),i&&(i.classList.add("av__cell--select"),ma(e.blockElement,i));const o=document.querySelector(".av__mask"),l=document.querySelector(".av__panel");if(o)(t=o.querySelector("textarea, input"))==null||t.focus();else if(!l&&!e.resetData.isSearching&&getSelection().rangeCount>0){const r=getSelection().getRangeAt(0),d=F(r.startContainer);d&&e.blockElement===d&&te(e.blockElement)}else l&&!i&&l.remove()}if(e.resetData.selectRowIds.forEach((i,o)=>{let l=e.blockElement.querySelector(`.av__body[data-group-id="${i.groupId}"] .av__row[data-id="${i.rowId}"]`);l||(l=e.blockElement.querySelector(`.av__row[data-id="${i.rowId}"]`)),l&&(l.classList.add("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),o===e.resetData.selectRowIds.length-1&&l&&La(l)}),Object.keys(e.resetData.pageSizes).forEach(i=>{const o=e.blockElement.querySelector(`.av__body[data-group-id="${i==="unGroup"?"":i}"]`);o&&(o.dataset.pageSize=e.resetData.pageSizes[i])}),e.resetData.dragFillId){let i=e.blockElement.querySelector(`.av__body[data-group-id="${e.resetData.dragFillId.groupId}"] .av__row[data-id="${e.resetData.dragFillId.rowId}"] .av__cell[data-col-id="${e.resetData.dragFillId.colId}"]`);i||(i=e.blockElement.querySelector(`.av__row[data-id="${e.resetData.dragFillId.rowId}"] .av__cell[data-col-id="${e.resetData.dragFillId.colId}"]`)),wn(i)}if(e.resetData.activeIds.forEach(i=>{let o=e.blockElement.querySelector(`.av__body[data-group-id="${i.groupId}"] .av__row[data-id="${i.rowId}"] .av__cell[data-col-id="${i.colId}"]`);o||(o=e.blockElement.querySelector(`.av__row[data-id="${i.rowId}"] .av__cell[data-col-id="${i.colId}"]`)),o==null||o.classList.add("av__cell--active")}),getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);if(!C(i.startContainer,"av__title")){const o=F(i.startContainer);o&&e.blockElement===o&&!e.resetData.isSearching&&te(e.blockElement)}}if(e.blockElement.querySelector(".layout-tab-bar").scrollLeft=e.blockElement.querySelector(".layout-tab-bar .item--focus").offsetLeft-30,e.cb&&e.cb(e.data),!e.renderAll)return;const a=e.blockElement.querySelector(".av__views"),s=e.blockElement.querySelector('[data-type="av-search"]');s.value=e.resetData.query||"",e.resetData.isSearching&&s.focus(),s.addEventListener("compositionstart",i=>{i.stopPropagation()}),s.addEventListener("keydown",i=>{i.isComposing||Rn(i)}),s.addEventListener("input",i=>{i.stopPropagation(),!i.isComposing&&(s.value||document.activeElement===s?a.classList.add("av__views--show"):a.classList.remove("av__views--show"),yi(e.blockElement,e.protyle))}),s.addEventListener("compositionend",()=>{yi(e.blockElement,e.protyle)}),s.addEventListener("blur",i=>{i.isComposing||s.value||(a.classList.remove("av__views--show"),s.style.width="0",s.style.paddingLeft="0",s.style.paddingRight="0")}),es({inputElement:s,right:0,width:"1em",height:s.clientHeight,clearCB(){a.classList.remove("av__views--show"),s.style.width="0",s.style.paddingLeft="0",s.style.paddingRight="0",te(e.blockElement),yi(e.blockElement,e.protyle)}})},ot=(e,t,n,a=!0,s)=>Fp(void 0,null,function*(){var i,o,l,r;let d=[];if(e.getAttribute("data-type")==="NodeAttributeView"?d=[e]:d=Array.from(e.querySelectorAll('[data-type="NodeAttributeView"]')),d.length!==0)for(let c=0;c<d.length;c++){const f=d[c];if(f.removeAttribute("data-rendering"),f.getAttribute("data-render")==="true"||C(f,"av__gallery-content"))continue;if((P()||Rt()||Je()||ut())&&f.classList.add("av--touch"),f.getAttribute("data-av-type")==="gallery"){yield Mo({blockElement:f,protyle:t,cb:n,renderAll:a});continue}if(f.getAttribute("data-av-type")==="kanban"){yield $o({blockElement:f,protyle:t,cb:n,renderAll:a});continue}let m;const u=f.querySelector(".av__cell--select");u&&(m={groupId:C(u,"av__body").dataset.groupId||"",rowId:C(u,"av__row").dataset.id,colId:u.getAttribute("data-col-id")});const g=[];f.querySelectorAll(".av__row--select").forEach(T=>{const q=T.getAttribute("data-id");q&&g.push({groupId:C(T,"av__body").dataset.groupId||"",rowId:q})});let y;const b=f.querySelector(".av__drag-fill");b&&(y={groupId:C(b,"av__body").dataset.groupId||"",rowId:C(b,"av__row").dataset.id,colId:b.parentElement.getAttribute("data-col-id")});const w=[];f.querySelectorAll(".av__cell--active").forEach(T=>{w.push({groupId:C(T,"av__body").dataset.groupId||"",rowId:C(T,"av__row").dataset.id,colId:T.getAttribute("data-col-id")})});const h=f.querySelector('[data-type="av-search"]'),S={};f.querySelectorAll(".av__body").forEach(T=>{S[T.dataset.groupId||"unGroup"]=T.dataset.pageSize});const $=f.querySelector('.av__row--header[style^="transform"]'),D=f.querySelector('.av__row--footer[style^="transform"]'),v={selectCellId:m,alignSelf:f.style.alignSelf,left:((i=f.querySelector(".av__scroll"))==null?void 0:i.scrollLeft)||0,headerTransform:$?{groupId:$.parentElement.getAttribute("data-group-id"),transform:$.style.transform}:null,footerTransform:D?{groupId:D.parentElement.getAttribute("data-group-id"),transform:D.style.transform}:null,isSearching:h&&document.activeElement===h,selectRowIds:g,dragFillId:y,activeIds:w,query:(h==null?void 0:h.value)||"",pageSizes:S};if(f.firstElementChild.innerHTML===""){f.style.alignSelf="";let T="";[1,2,3].forEach(()=>{T+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),f.firstElementChild.innerHTML=T}const k=(o=t.options.history)==null?void 0:o.created,_=(l=t.options.history)==null?void 0:l.snapshot,E=tl(f);let A;if(s?A=s:A=(yield he(k?"/api/av/renderHistoryAttributeView":_?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:f.getAttribute("data-av-id"),created:k,snapshot:_,pageSize:E.unGroupPageSize,groupPaging:E.groupPageSize,viewID:f.getAttribute(p.CUSTOM_SY_AV_VIEW)||"",query:v.query.trim(),blockID:f.getAttribute("data-node-id")})).data,A.viewType==="gallery"){f.setAttribute("data-av-type",A.viewType),yield Mo({blockElement:f,protyle:t,cb:n,renderAll:a,data:A});continue}if(A.viewType==="kanban"){f.setAttribute("data-av-type",A.viewType),yield $o({blockElement:f,protyle:t,cb:n,renderAll:a,data:A});continue}const x=A.view;if(((r=x.groups)==null?void 0:r.length)>0){Yp({blockElement:f,protyle:t,cb:n,renderAll:a,data:A,resetData:v});continue}const I=`<div class="av__body" data-group-id="" data-page-size="${x.pageSize}" style="float: left">
    ${Lc(x,f)}
</div>`;a?f.firstElementChild.outerHTML=`<div class="av__container">
    ${rs(A,v.isSearching||!!v.query,!t.disabled&&!O(f,"data-type","NodeBlockQueryEmbed"))}
    <div class="av__scroll">
        ${I}
    </div>
    <div class="av__cursor" contenteditable="true">${p.ZWSP}</div>
</div>`:f.firstElementChild.querySelector(".av__scroll").innerHTML=I,Cc({renderAll:a,data:A,cb:n,protyle:t,blockElement:f,resetData:v}),f.style.margin=""}});let Tc;const yi=(e,t)=>{clearTimeout(Tc),Tc=window.setTimeout(()=>{e.removeAttribute("data-render"),ot(e,t,void 0,!1)},p.TIMEOUT_INPUT)},Ic={},Cn=(e,t,n)=>{const a=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t}"]`));return n?a.filter(s=>$c(s)===n):a},$c=e=>{var t;return e.getAttribute(p.CUSTOM_SY_AV_VIEW)||((t=e.querySelector(".layout-tab-bar .item--focus"))==null?void 0:t.getAttribute("data-id"))||null},Wp=(e,t)=>{if(t.action==="setAttrViewName"){Cn(e,t.id).forEach(n=>{const a=n.querySelector(".av__title");a&&(a.textContent=t.data,a.dataset.title=t.data)});return}if(t.action==="setAttrViewColWidth"){Cn(e,t.avID,t.viewID).forEach(n=>{const a=n.querySelector(`.av__cell[data-col-id="${t.id}"]`);!a||a.style.width===t.data||n.querySelectorAll(".av__row").forEach(s=>{s.querySelector(`[data-col-id="${t.id}"]`).style.width=t.data})});return}if(t.action==="setAttrViewCardSize"){Cn(e,t.avID,t.viewID).forEach(n=>{n.getAttribute("data-av-type")==="kanban"?n.querySelectorAll(".av__kanban-group").forEach(a=>{a.classList.remove("av__kanban-group--small","av__kanban-group--big"),t.data===0?a.classList.add("av__kanban-group--small"):t.data===2&&a.classList.add("av__kanban-group--big")}):n.querySelectorAll(".av__gallery").forEach(a=>{a.classList.remove("av__gallery--small","av__gallery--big"),t.data===0?a.classList.add("av__gallery--small"):t.data===2&&a.classList.add("av__gallery--big")})});return}if(t.action==="setAttrViewCardAspectRatio"){Cn(e,t.avID,t.viewID).forEach(n=>{n.querySelectorAll(".av__gallery-cover").forEach(a=>{a.className="av__gallery-cover av__gallery-cover--"+t.data})});return}if(t.action==="hideAttrViewName"){Cn(e,t.avID,t.viewID).forEach(n=>{const a=n.querySelector(".av__title");if(a&&(t.data?a.classList.add("fn__none"):a.classList.remove("fn__none"),n.getAttribute("data-av-type")==="gallery"&&!n.querySelector(".av__group-title"))){const s=n.querySelector(".av__gallery");t.data?s.classList.add("av__gallery--top"):s.classList.remove("av__gallery--top")}});return}if(t.action==="setAttrViewWrapField"){Cn(e,t.avID,t.viewID).forEach(n=>{n.querySelectorAll(".av__cell").forEach(a=>{a.setAttribute("data-wrap",t.data.toString())})});return}if(t.action==="setAttrViewFillColBackgroundColor"){Cn(e,t.avID,t.viewID).forEach(n=>{const a=n.querySelector(".av__group-title .b3-chip"),s=n.querySelector(".av__kanban");t.data&&a?s.classList.add("av__kanban--bg"):s.classList.remove("av__kanban--bg"),n.querySelectorAll(".av__kanban-group").forEach(i=>{if(t.data&&a){const o=i.querySelector(".av__group-title .b3-chip");o?i.setAttribute("style",`--b3-av-kanban-background:var(--b3-font-background${o.style.backgroundColor.slice(-2,-1)})`):i.setAttribute("style","--b3-av-kanban-background: var(--b3-border-color)")}else i.removeAttribute("style")})});return}if(t.action==="setAttrViewFitImage"){Cn(e,t.avID,t.viewID).forEach(n=>{const a=n.querySelector(".av__gallery-img");t.data?a.classList.add("av__gallery-img--fit"):a.classList.remove("av__gallery-img--fit")});return}if(t.action==="setAttrViewShowIcon"){Cn(e,t.avID,t.viewID).forEach(n=>{n.querySelectorAll('.av__cell[data-dtype="block"] .b3-menu__avemoji, .av__cell[data-dtype="relation"] .b3-menu__avemoji').forEach(a=>{t.data?a.classList.remove("fn__none"):a.classList.add("fn__none")})});return}if(t.action==="setAttrViewColWrap"){Cn(e,t.avID,t.viewID).forEach(n=>{n.querySelectorAll(`.av__cell[data-col-id="${t.id}"],.av__cell[data-field-id="${t.id}"]`).forEach(a=>{a.setAttribute("data-wrap",t.data.toString())})});return}if(t.action==="foldAttrViewGroup"){Cn(e,t.avID).forEach(n=>{const a=n.querySelector(`[data-type="av-group-fold"][data-id="${t.id}"]`);a&&(t.data?(a.firstElementChild.classList.remove("av__group-arrow--open"),a.parentElement.nextElementSibling.classList.add("fn__none")):(a.firstElementChild.classList.add("av__group-arrow--open"),a.parentElement.nextElementSibling.classList.remove("fn__none")),a.removeAttribute("data-folding"))});return}clearTimeout(Ic[e.id]),Ic[e.id]=window.setTimeout(()=>{const n=t.action==="setAttrViewName"?t.id:t.avID,a=document.querySelector(`.b3-dialog--open[data-key="${p.DIALOG_ATTR}"] .custom-attr > [data-av-id="${n}"]`);a&&(a.removeAttribute("data-rendering"),So(a.parentElement,a.dataset.nodeId,e)),Cn(e,n).forEach(s=>{var i;if(s.removeAttribute("data-render"),t.action==="sortAttrViewRow")Et(["cell"],s);else if(t.action==="sortAttrViewCol")s.querySelectorAll(".av__cell--active").forEach(l=>{var r;l.classList.remove("av__cell--active"),(r=l.querySelector(".av__drag-fill"))==null||r.remove()}),wn(s.querySelector(".av__cell--select"));else if(t.action==="setAttrViewBlockView"){const l=s.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${t.id}"]`);l&&s.querySelectorAll(".av__body").forEach(r=>{r.dataset.pageSize=l.dataset.page})}else if(t.action==="addAttrViewView")s.querySelectorAll(".av__body").forEach(l=>{l.dataset.pageSize="50"});else if(t.action==="removeAttrViewView")s.querySelectorAll(".av__body").forEach(l=>{var r;l.dataset.pageSize=(r=s.querySelector(`.av__views > .layout-tab-bar .item[data-id="${$c(s)}"]`))==null?void 0:r.getAttribute("data-page")});else if(t.action==="sortAttrViewView"&&t.data==="unRefresh"){const l=s.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${t.id}"]`);if(l&&!t.previousID&&!l.previousElementSibling)return;if(l&&t.previousID&&((i=l.previousElementSibling)==null?void 0:i.getAttribute("data-id"))===t.previousID)return}const o=s.querySelector('[data-type="ghost"]');ot(s,e,()=>{var l,r;if(t.action==="insertAttrViewBlock"&&((l=t.context)==null?void 0:l.ignoreTip)!=="true")if((r=t.context)!=null&&r.message)se(t.context.message);else{const d=t.groupID?`[data-group-id="${t.groupID}"]`:"";if(["gallery","kanban"].includes(s.getAttribute("data-av-type"))&&t.srcs.forEach(c=>{var f,m;const u=(f=s.querySelector(`.av__body${d} .av__gallery-item[data-id="${c.itemID}"]`))==null?void 0:f.querySelector(".av__gallery-fields");u&&((m=u.querySelector('[data-dtype="block"]'))==null?void 0:m.parentElement.getAttribute("data-empty"))==="true"&&u.classList.add("av__gallery-fields--edit")}),t.srcs.length===1){let c=s.querySelector(`.av__body${d} [data-id="${t.srcs[0].itemID}"] .av__cell[data-dtype="block"]`);if(!c){const f=s.querySelectorAll(`.av__body [data-id="${t.srcs[0].itemID}"] .av__cell[data-dtype="block"]`);f.length===1&&(c=f[0])}c&&c.getAttribute("data-detached")==="true"&&c.querySelector(".av__celltext").textContent===""&&c.getBoundingClientRect().height!==0&&o&&on(e,[c],"block")}t.srcs.find(c=>{if(!s.querySelector(`.av__body [data-id="${c.itemID}"]`)&&!s.querySelector(`.av__body [data-dtype="block"] .av__celltext--ref[data-id="${c.id}"]`))return se(window.siyuan.languages.insertRowTip),!0})}else t.action==="addAttrViewView"&&s.getAttribute("data-node-id")===t.blockID&&Pt({protyle:e,blockElement:s,type:"config"});s.removeAttribute("data-loading")})})},["insertAttrViewBlock"].includes(t.action)?2:100)},rt=e=>{if(e.action||(e.action=[]),e.protyle.wysiwyg.element.removeAttribute("data-top"),e.data.code===1){e.action.includes(p.CB_GET_APPEND)||(e.protyle.model?e.protyle.model.parent.parent.removeTab(e.protyle.model.parent.id,!1):e.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(e.data.code!==3&&(e.protyle.notebookId=e.data.data.box,e.protyle.path=e.data.data.path,!(e.data.data.eof&&!e.scrollAttr&&(e.action.includes(p.CB_GET_BEFORE)?e.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):e.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),e.data.data.mode!==4)))){if(ae(["gutterOnly"],e.protyle),e.protyle.block.parentID=e.data.data.parentID,e.protyle.block.parent2ID=e.data.data.parent2ID,e.protyle.block.rootID=e.data.data.rootID,e.protyle.block.showAll=e.action.includes(p.CB_GET_ALL),e.protyle.block.mode=e.data.data.mode,e.protyle.block.blockCount=e.data.data.blockCount,e.protyle.block.scroll=e.data.data.scroll,e.protyle.block.action=e.action,e.action.includes(p.CB_GET_UNCHANGEID)||(e.protyle.block.id=e.data.data.id,e.protyle.scroll.lastScrollTop=0,e.protyle.contentElement.scrollTop=0,e.protyle.wysiwyg.element.setAttribute("data-doc-type",e.data.data.type)),!(e.protyle.options.render.title&&e.protyle.title.element.getAttribute("data-render")!=="true")){if(e.action.includes(p.CB_GET_APPEND)||e.action.includes(p.CB_GET_BEFORE)||e.action.includes(p.CB_GET_HTML)){e.protyle.options.render.title&&e.protyle.options.render.hideTitleOnZoom&&(e.protyle.block.showAll?e.protyle.title.element.classList.add("fn__none"):e.protyle.title.element.classList.remove("fn__none")),Dc({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),fs(e.protyle);return}}L("/api/block/getDocInfo",{id:e.protyle.block.rootID},t=>{e.protyle.options.render.title?e.protyle.title.render(e.protyle,t):(e.protyle.options.render.background&&e.protyle.background.render(t.data.ial,e.protyle.block.rootID),e.protyle.wysiwyg.renderCustom(t.data.ial)),Dc({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),fs(e.protyle)})}},Dc=(e,t)=>{var n;if(t.contentElement.classList.contains("fn__none")&&t.wysiwyg.element.innerHTML!=="")return;const s=new DOMParser().parseFromString(e.content,"text/html");s.querySelectorAll("[data-inline-memo-content]").forEach(l=>{const r=l.getAttribute("data-inline-memo-content");r&&l.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(r))}),e.content=s.body.innerHTML;const i=t.contentElement.clientHeight*8,o=typeof e.updateReadonly=="undefined"?t.wysiwyg.element.innerHTML==="":e.updateReadonly;if(e.action.includes(p.CB_GET_APPEND)){if(!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad&&t.contentElement.scrollHeight>i){let l=t.wysiwyg.element.firstElementChild;const r=[];for(;t.wysiwyg.element.childElementCount>2&&r&&t.wysiwyg.element.lastElementChild!==l&&t.contentElement.scrollHeight-l.offsetTop>i;){r.push(l);l=l.nextElementSibling}const d=l.getBoundingClientRect().top;r.forEach(c=>{c.remove()}),t.contentElement.scrollTop=t.contentElement.scrollTop+(l.getBoundingClientRect().top-d)-1,t.scroll.lastScrollTop=t.contentElement.scrollTop,ae(["toolbar"],t)}t.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(p.CB_GET_BEFORE)){const l=t.wysiwyg.element.firstElementChild,r=l.getBoundingClientRect().top;if(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),t.contentElement.scrollTop=t.contentElement.scrollTop+(l.getBoundingClientRect().top-r),t.scroll.lastScrollTop=t.contentElement.scrollTop,!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad){const d=[];let c=t.wysiwyg.element.childElementCount,f=t.contentElement.scrollHeight,m=t.wysiwyg.element.lastElementChild;for(;c>2&&f>i&&m.getBoundingClientRect().top>window.innerHeight;)d.push(m),m=m.previousElementSibling,c--,f-=m.clientHeight+8;d.forEach(u=>{u.remove()}),ae(["toolbar"],t)}}else t.wysiwyg.element.innerHTML=e.content;if(t.wysiwyg.element.querySelectorAll("video, audio").forEach(l=>{l.addEventListener("playing",()=>{mn(),console.log("playing")})}),!t.block.showAll&&t.wysiwyg.element.childElementCount===1&&t.wysiwyg.element.firstElementChild.classList.contains("p")){const l=oe(t.wysiwyg.element.firstElementChild);l&&l.textContent===""&&(l.classList.add("protyle-wysiwyg--empty"),l.setAttribute("placeholder",window.siyuan.languages.emptyMobilePlaceholder))}if(e.action.includes(p.CB_GET_BACKLINK)&&Hc(e.expand,t.wysiwyg.element),Xe(t.wysiwyg.element),Re(t.wysiwyg.element),ot(t.wysiwyg.element,t),xe(t,t.wysiwyg.element),!e.action.includes(p.CB_GET_HISTORY)){if(t.options.render.scroll&&t.scroll.update(t),e.action.includes(p.CB_GET_FOCUSFIRST)){const l=t.wysiwyg.element.offsetTop-16;fn(t,l,p.TIMEOUT_INPUT),t.contentElement.scrollTop=l}if(e.isSyncing?Ho(t):(t.breadcrumb&&(t.breadcrumb.element.nextElementSibling.textContent=""),t.element.removeAttribute("disabled-forever"),e.action.includes(p.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly?ds(t):No(t,o)),Vp(t,e.action,e.scrollAttr),e.action.includes(p.CB_GET_SETID)&&(t.block.id=t.block.rootID,t.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),(n=t.options.defIds)==null||n.forEach(l=>{t.wysiwyg.element.querySelectorAll(`[data-id="${l}"]`).forEach(r=>{r.classList.add("def--mark")})}),t.options.defIds=[],e.action.includes(p.CB_GET_APPEND)||e.action.includes(p.CB_GET_BEFORE)){t.app.plugins.forEach(l=>{l.eventBus.emit("loaded-protyle-dynamic",{protyle:t,position:e.action.includes(p.CB_GET_APPEND)?"afterend":"beforebegin"})});return}!t.disabled&&!e.action.includes(p.CB_GET_ALL)&&t.background&&t.background.element.classList.add("protyle-background--mobileshow"),t.options.render.breadcrumb&&(t.breadcrumb.toggleExit(!e.action.includes(p.CB_GET_ALL)),t.breadcrumb.render(t)),e.afterCB&&e.afterCB(),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("block__edit")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&t.contentElement.scrollHeight>0&&!e.action.includes(p.CB_GET_FOCUSFIRST)&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&L("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{rt({data:l,protyle:t,action:[p.CB_GET_APPEND,p.CB_GET_UNCHANGEID]})}),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("fn__none")&&t.scroll.updateIndex(t,e.scrollAttr.startId,l=>{l>1&&t.block.blockCount>1&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&se(window.siyuan.languages.scrollGetMore)}),t.app.plugins.forEach(l=>{l.eventBus.emit("loaded-protyle-static",{protyle:t})})}},Ho=e=>{En(e),e.breadcrumb&&!P()?e.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:se(window.siyuan.languages._kernel[81]),e.element.setAttribute("disabled-forever","true")},En=e=>{if(window.siyuan.menus.menu.remove(),ae(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","false"),e.title.editElement.style.userSelect="text"),document.getElementById("toolbarName").setAttribute("readonly","readonly"),e.background&&(e.background.element.classList.remove("protyle-background--enable"),e.background.element.classList.remove("protyle-background--mobileshow")),e.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(t=>{t.classList.remove("protyle-icons--show")}),e.wysiwyg.element.querySelectorAll(".av__gallery-fields--edit").forEach(t=>{t.classList.remove("av__gallery-fields--edit")}),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(t=>{var n;t.classList.add("fn__none"),t.classList.contains("protyle-icon--first")&&((n=t.nextElementSibling)==null||n.classList.add("protyle-icon--first"))}),e.wysiwyg.element.style.userSelect="text",e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.setAttribute("data-readonly","true"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(t=>{t.setAttribute("contenteditable","false")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(t=>{t.setAttribute("draggable","false")}),e.breadcrumb){const t=e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]');t.querySelector("use").setAttribute("xlink:href","#iconLock"),t.setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit),t.setAttribute("data-subtype","lock");const n=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&!n.classList.contains("fn__none")&&(n.classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}xn()},ds=e=>{if(e.element.getAttribute("disabled-forever")==="true")return;e.disabled=!1,P()?document.getElementById("toolbarName").removeAttribute("readonly"):(e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.style.userSelect=""),e.wysiwyg.element.setAttribute("data-readonly","false"),e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","true"),e.title.editElement.style.userSelect=""),e.background&&e.background.element.classList.add("protyle-background--enable"),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(n=>{var a;n.classList.remove("fn__none"),n.classList.contains("protyle-icon--first")&&((a=n.nextElementSibling)==null||a.classList.remove("protyle-icon--first"))}),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{C(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const t=e.contentElement.getBoundingClientRect();if(e.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__scroll")&&xa(n,t,"all")}),e.breadcrumb){const n=e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]');n.querySelector("use").setAttribute("xlink:href","#iconUnlock"),n.setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit),n.setAttribute("data-subtype","unlock");const a=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&a.classList.contains("fn__none")&&(a.classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}xn()},Vp=(e,t,n)=>{var a;let s;if(n&&n.focusId?s=e.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${e.block.id}"]`)).find(o=>{if(!O(o,"data-type","block-render",!0))return s=o,!0}),e.block.mode===4?(fn(e),s=e.wysiwyg.element.lastElementChild):(!s||t.includes(p.CB_GET_FOCUSFIRST))&&(s=e.wysiwyg.element.firstElementChild),t.includes(p.CB_GET_HL)&&(fn(e),Hs(s)),t.includes(p.CB_GET_FOCUS)||t.includes(p.CB_GET_FOCUSFIRST)){let o;n&&n.focusId?o=Ni(s,n.focusStart,n.focusEnd):te(s,void 0,!t.includes(p.CB_GET_OUTLINE))}const i=n&&typeof n.scrollTop=="number";if(i&&(e.contentElement.scrollTop=n.scrollTop),(a=e.observerLoad)==null||a.disconnect(),t.includes(p.CB_GET_FOCUS)||t.includes(p.CB_GET_SCROLL)||t.includes(p.CB_GET_HL)||t.includes(p.CB_GET_FOCUSFIRST))i||Oe(e,s);else return;e.observerLoad=new ResizeObserver(()=>{i&&(e.contentElement.scrollTop=n.scrollTop),(t.includes(p.CB_GET_FOCUS)||t.includes(p.CB_GET_HL)||t.includes(p.CB_GET_FOCUSFIRST))&&(i||Oe(e,s))}),e.observerLoad.observe(e.wysiwyg.element),e.observer.unobserve(e.wysiwyg.element),setTimeout(()=>{e.observerLoad.disconnect(),e.observer.observe(e.wysiwyg.element)},1e3*3),s===e.wysiwyg.element.firstElementChild&&!i&&e.observerLoad.disconnect()},No=(e,t)=>{let n=window.siyuan.config.readonly?"true":"false";t?n==="false"&&(n=window.siyuan.config.editor.readOnly?"true":"false",n==="false"&&(n=e.wysiwyg.element.getAttribute(p.CUSTOM_SY_READONLY))):n=e.disabled?"true":"false",n==="true"?En(e):ds(e)},Mc=(e,t)=>{e.block.showAll=!0;let n="";t.forEach((a,s)=>{n+=Pc(a.blockPaths,!1,s)+Nc(a.dom,a.expand)}),e.wysiwyg.element.innerHTML=n,Oc(e.wysiwyg.element),Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e),xe(e,e.wysiwyg.element),fs(e),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&En(e)},Hc=(e,t)=>{t.firstElementChild.classList.contains("li")?e?t.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):t.firstElementChild.setAttribute("fold","1"):t.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(t.children).forEach((n,a)=>{(e&&a>2||!e&&a>1)&&((e&&a===3||!e&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg style="transform: rotate(90deg);"><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},Nc=(e,t)=>{const n=document.createElement("template");return n.innerHTML=e,Hc(t,n.content),n.innerHTML},jp=(e,t)=>{L("/api/filetree/getDoc",{id:t.getAttribute("data-id"),size:p.SIZE_GET_MAX},n=>{t.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),t.classList.add("protyle-breadcrumb__item--active");let a=t.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const s=a;a=a.nextElementSibling,s.remove()}t.parentElement.insertAdjacentHTML("afterend",Nc(n.data.content,!0)),Xe(t.parentElement.parentElement),ot(t.parentElement.parentElement,e),xe(e,t.parentElement.parentElement),n.data.isSyncing?Ho(e):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?En(e):t.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&t.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(s=>{s.setAttribute("contenteditable","false")})})},oy=e=>{let t=e.nextElementSibling;for(;t&&!t.classList.contains("protyle-breadcrumb__bar");)t.classList.remove("fn__none"),t=t.nextElementSibling;e.remove()},Pc=(e,t,n)=>{if(1>e.length)return`<div contenteditable="false" style="border-top: ${n===0?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let a="";return e.forEach((s,i)=>{i===0&&!t||(a+=`<span class="protyle-breadcrumb__item${i===e.length-1?" protyle-breadcrumb__item--active":""}" data-id="${s.id}">
    <svg class="popover__block" data-id="${s.id}"><use xlink:href="#${Ln(s.type,s.subType)}"></use></svg>
    ${s.name?`<span class="protyle-breadcrumb__text" title="${s.name}">${s.name}</span>`:""}
</span>`,i!==e.length-1&&(a+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${a}</div>`},Oc=e=>{e.querySelectorAll(".protyle-breadcrumb__bar").forEach(t=>{t.classList.remove("protyle-breadcrumb__bar--nowrap");const n=Array.from(t.querySelectorAll(".protyle-breadcrumb__text"));if(n.length===0)return;let a=!1;const s=O(t,"data-type","NodeBlockQueryEmbed");for(;t.scrollHeight>30&&!a&&n.length>1;)n.find((i,o)=>{if(o>(s?0:-1)){if(!i.classList.contains("protyle-breadcrumb__text--ellipsis"))return i.classList.add("protyle-breadcrumb__text--ellipsis"),!0;o===n.length-1&&i.classList.contains("protyle-breadcrumb__text--ellipsis")&&(a=!0)}});t.classList.add("protyle-breadcrumb__bar--nowrap"),t.lastElementChild&&(t.scrollLeft=t.lastElementChild.offsetLeft-t.clientWidth+14)})},xe=(e,t,n)=>{let a=[];t.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[t]:a=Array.from(t.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(s=>{if(s.getAttribute("data-render")==="true")return;if(s.setAttribute("data-render","true"),Hi(s),s.childElementCount>3){s.style.height=s.clientHeight-4+"px";for(let l=1;l<s.children.length-1;l++)s.children[l].classList.contains("protyle-cursor")||(s.children[l].remove(),l--)}const i=Lute.UnEscapeHTMLStr(s.getAttribute("data-content"));let o=s.getAttribute("breadcrumb");if(o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,i.startsWith("//!js"))try{const l=new Function("fetchSyncPost","item","protyle","top",i)(he,s,e,n);if(l instanceof Promise)l.then(r=>{if(Array.isArray(r))L("/api/search/getEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),includeIDs:r,headingMode:["0","1","2"].includes(s.getAttribute("custom-heading-mode"))?parseInt(s.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,breadcrumb:o},d=>{cs(d.data.blocks||[],e,s,n)});else return}).catch(r=>{cs([],e,s,n,r)});else if(Array.isArray(l))L("/api/search/getEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),includeIDs:l,headingMode:["0","1","2"].includes(s.getAttribute("custom-heading-mode"))?parseInt(s.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,breadcrumb:o},r=>{cs(r.data.blocks||[],e,s,n)});else return}catch(l){cs([],e,s,n,l)}else L("/api/search/searchEmbedBlock",{embedBlockID:s.getAttribute("data-node-id"),stmt:i,headingMode:["0","1","2"].includes(s.getAttribute("custom-heading-mode"))?parseInt(s.getAttribute("custom-heading-mode")):window.siyuan.config.editor.headingEmbedMode,excludeIDs:[s.getAttribute("data-node-id"),e.block.rootID],breadcrumb:o},l=>{cs(l.data.blocks,e,s,n)})})},cs=(e,t,n,a,s)=>{const i=n.querySelector(".fn__rotate");i&&i.classList.remove("fn__rotate");let o="";e.forEach(d=>{let c="";d.blockPaths.length!==0&&(c=Pc(d.blockPaths,!0)),o+=`<div class="protyle-wysiwyg__embed" data-id="${d.block.id}">${c}${d.block.content}</div>`}),e.length>0?(n.firstElementChild.insertAdjacentHTML("afterend",o),Oc(n.querySelector(".protyle-wysiwyg__embed"))):n.firstElementChild.insertAdjacentHTML("afterend",`<div class="protyle-wysiwyg__embed ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${s||window.siyuan.languages.refExpired}</div>`),Xe(n),Re(n),ot(n,t),a&&(t.contentElement.scrollTop=a);let l=0,r=n;for(;l<4&&r;)r=O(r.parentElement,"data-type","NodeBlockQueryEmbed"),l++;l<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(d=>{xe(t,d)}),n.style.height=""};var qc=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),Gp=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())}),zp=(e,t,n)=>(t=e[qc("asyncIterator")])?t.call(e):(e=e[qc("iterator")](),t={},n=(a,s)=>(s=e[a])&&(t[a]=i=>new Promise((o,l,r)=>(i=s.call(e,i),r=i.done,Promise.resolve(i.value).then(d=>o({value:d,done:r}),l)))),n("next"),n("return"),t);const Rc=(e,t)=>{const n=Ve(e),a=[];if(n!==e&&(e.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),t.wysiwyg.element.childElementCount===0)if(t.block.rootID===t.block.id){const s=Lute.NewNodeID(),i=yn(!1,!1,s);a.push({action:"insert",data:i.outerHTML,id:s,parentID:t.block.parentID}),t.wysiwyg.element.innerHTML=i.outerHTML}else Bt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:t.block.id});a.length>0&&B(t,a,[])},Bc=()=>{if(window.siyuan.transactions.length===0)return;const e=window.siyuan.transactions[0].protyle,t=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),L("/api/transactions",{session:e.id,app:p.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},a=>{window.siyuan.transactions.length===0?Yt([],e.block.rootID,!0):Bc(),(window.siyuan.config.sync.provider!==0&&Fi()||window.siyuan.config.sync.provider===0&&!fa(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none");let s;if(getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(i=>{if(i.action==="unfoldHeading"||i.action==="foldHeading"){Vc(i,e);return}if(i.action==="update"){e.options.backlinkData&&(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(o=>{de(o)||s&&(o===s.startContainer||o.contains(s.startContainer))||(o.outerHTML=i.data.replace("<wbr>",""))}),Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e),xe(e,e.wysiwyg.element)),Po(e,i);return}if(i.action==="delete"||i.action==="append"){e.options.backlinkData&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(o=>{!de(o)&&!o.contains(s.startContainer)&&o.remove()}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${i.id}"]`)&&(o.removeAttribute("data-render"),xe(e,o))}),ae(["gutter"],e);return}if(i.action==="move"){if(e.options.backlinkData){const o=[];Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`)).forEach(r=>{if(!de(r)){const d=Y(r,"data-node-id",null);d&&!d.contains(s.startContainer)&&o.push(r)}});let l=!1;i.previousID&&o.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(r=>{!de(r)&&!r.nextElementSibling.contains(s.startContainer)&&(r.after(un(o[0].cloneNode(!0))),l=!0)}):o.length>0&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(r=>{var d;!de(r)&&!At(r).contains(s.startContainer)&&((d=r.firstElementChild)!=null&&d.classList.contains("protyle-action")?r.firstElementChild.after(un(o[0].cloneNode(!0))):r.prepend(un(o[0].cloneNode(!0))),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&Rc(r,e)})}e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${i.id}"],[data-node-id="${i.parentID}"],[data-node-id="${i.previousID}"]`)&&(o.removeAttribute("data-render"),xe(e,o))});return}if(i.action==="insert"){if(e.options.backlinkData){const o=[];i.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.previousID}"]`)).forEach(l=>{var r;((r=l.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==i.id&&!l.contains(s.startContainer)&&!O(l,"data-node-id",i.id)&&!de(l)&&(l.insertAdjacentHTML("afterend",i.data),o.push(l.nextElementSibling))}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i.parentID}"]`)).forEach(l=>{!de(l)&&!l.contains(s.startContainer)&&(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==i.id?(l.firstElementChild.insertAdjacentHTML("afterend",i.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==i.id&&(l.insertAdjacentHTML("afterbegin",i.data),o.push(l.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{Xe(l),Re(l),ot(l,e),xe(e,l);const r=l.querySelector("wbr");r&&r.remove()})}e.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(o=>{o.remove()})}}),e.wysiwyg.element.childElementCount===0&&!e.block.showAll){const i=Lute.NewNodeID(),o=yn(!1,!0,i);e.wysiwyg.element.insertAdjacentElement("afterbegin",o),B(e,[{action:"insert",data:o.outerHTML,id:i,parentID:e.block.parentID}]),fe(o,s)}})},Po=(e,t)=>{let n=!1;const a=(i,o)=>{const l=document.createElement("template");l.innerHTML=e.lute.SpinBlockDOM(o),l.content.querySelectorAll('[contenteditable="true"]').forEach(d=>{d.setAttribute("contenteditable","false")}),l.content.querySelectorAll(".protyle-wysiwyg--select").forEach(d=>{d.classList.remove("protyle-wysiwyg--select")});const r=l.content.querySelector("wbr");r&&r.remove(),i.outerHTML=l.innerHTML,n=!0},s=document.createElement("template");s.innerHTML=t.data,e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{const o=i.querySelectorAll(`[data-node-id="${t.id}"]`);o.length>0?o.forEach(l=>{a(l,t.data)}):i.querySelectorAll(".protyle-wysiwyg__embed").forEach(l=>{const r=s.content.querySelector(`[data-node-id="${l.getAttribute("data-id")}"]`);r&&!de(r)&&a(l.querySelector("[data-node-id]"),r.outerHTML)})}),n&&(Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e))},Uc=(e,t,n,a)=>{a&&Dl(e[0]),e.forEach(s=>{if(a)s.remove();else{const i=Ve(s);i&&i.remove()}}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(s=>{s.querySelector(`[data-node-id="${t}"]`)&&(s.removeAttribute("data-render"),xe(n,s))})},Fc=(e,t,n,a)=>{e.forEach(i=>{i.getAttribute("data-subtype")==="echarts"?i.outerHTML=t.lute.SpinBlockDOM(n.data):i.outerHTML=n.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(i=>{if(!de(i))return e[0]=i,!0});const s=e[0].querySelector("wbr");if(a){const i=ye(e[0]);s?fe(e[0],i):te(e[0])}else s&&s.remove();Xe(e.length===1?e[0]:t.wysiwyg.element),Re(e.length===1?e[0]:t.wysiwyg.element),ot(e.length===1?e[0]:t.wysiwyg.element,t),xe(t,e.length===1?e[0]:t.wysiwyg.element),Po(t,n)},il=(e,t,n)=>{var a,s,i,o;const l=[];if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(r=>{de(r)||l.push(r)}),t.action==="setAttrs"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(r=>{JSON.parse(t.data).fold==="1"?r.setAttribute("fold","1"):r.removeAttribute("fold")});return}if(t.action==="unfoldHeading"){const r=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(d=>{if(d.removeAttribute("fold"),n)return;const c=de(d);if(c){c.removeAttribute("data-render"),xe(e,c);return}t.retData&&(Yc(t.retData,e),d.insertAdjacentHTML("afterend",t.retData)),t.data==="remove"&&d.remove()}),t.retData&&(e.disabled&&En(e),Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e),xe(e,e.wysiwyg.element),e.contentElement.scrollTop=r,e.scroll.lastScrollTop=r);return}if(t.action==="foldHeading"){if(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(r=>{r.setAttribute("fold","1"),t.retData||xd(r)}),n)return;t.retData&&(t.retData.forEach(r=>{let d;Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r}"]`)).find(c=>{if(d=de(c),d)return!0;c.remove()}),d&&(d.removeAttribute("data-render"),xe(e,d))}),e.wysiwyg.element.childElementCount===0&&Bt({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id}));return}if(t.action==="delete"){l.length>0||!n?Uc(l,t.id,e,n):n&&Bt({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(r=>{de(r)||l.push(r)}),Uc(l,t.id,e,n)}});return}if(t.action==="update"){if(l.length===0){const r=e.wysiwyg.element.querySelector("[data-node-id]");if(r){const d=r.getAttribute("data-node-id"),c=document.createElement("template");c.innerHTML=t.data;const f=c.content.querySelector(`[data-node-id="${d}"]`);if(f){l.push(r),t.data=f.outerHTML,t.id=d;for(let m=1;m<e.wysiwyg.element.childElementCount;m++)e.wysiwyg.element.childNodes[m].remove(),m--}}}l.length>0?Fc(l,e,t,n):n?Bt({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(r=>{de(r)||l.push(r)}),Fc(l,e,t,n)}}):Po(e,t);return}if(t.action==="updateAttrs"){const r=t.data,d={};let c="",f="",m="",u="",g="";Object.keys(r.new).forEach(b=>{d[b]=r.new[b];const w=Lute.EscapeHTMLStr(r.new[b]);b==="bookmark"?c=`<div class="protyle-attr--bookmark">${w}</div>`:b==="name"?f=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${w}</div>`:b==="alias"?m=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${w}</div>`:b==="memo"?u=`<div class="protyle-attr--memo ariaLabel" aria-label="${w}" data-position="north"><svg><use xlink:href="#iconM"></use></svg></div>`:b==="custom-avs"&&r.new["av-names"]&&(g=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${r.new["av-names"]}</div>`)});let y=c+f+m+u+g;if(e.block.rootID===t.id){if(e.title){r.new["custom-avs"]&&!r.new["av-names"]&&(y+=((a=e.title.element.querySelector(".protyle-attr--av"))==null?void 0:a.outerHTML)||"");const b=e.title.element.querySelector(".protyle-attr--refcount");b&&(y+=b.outerHTML),r.new[p.CUSTOM_RIFF_DECKS]&&r.new[p.CUSTOM_RIFF_DECKS]!==r.old[p.CUSTOM_RIFF_DECKS]?(e.title.element.style.animation="addCard 450ms linear",e.title.element.setAttribute(p.CUSTOM_RIFF_DECKS,r.new[p.CUSTOM_RIFF_DECKS]),setTimeout(()=>{e.title.element.style.animation=""},450)):r.new[p.CUSTOM_RIFF_DECKS]||e.title.element.removeAttribute(p.CUSTOM_RIFF_DECKS),e.title.element.querySelector(".protyle-attr").innerHTML=y}if(e.wysiwyg.renderCustom(d),r.new[p.CUSTOM_SY_FULLWIDTH]!==r.old[p.CUSTOM_SY_FULLWIDTH]&&hi(e),r.new[p.CUSTOM_SY_READONLY]!==r.old[p.CUSTOM_SY_READONLY]){let b=r.new[p.CUSTOM_SY_READONLY];b||(b=window.siyuan.config.editor.readOnly?"true":"false"),b==="true"?En(e):ds(e)}(r.new.icon!==r.old.icon||r.new["title-img"]!==r.old["title-img"]||r.new.tags!==r.old.tags&&e.background)&&(e=window.siyuan.mobile.editor.protyle,e.background.ial.icon=r.new.icon,e.background.ial.tags=r.new.tags,e.background.ial["title-img"]=r.new["title-img"],e.background.render(e.background.ial,e.block.rootID),(s=e.model)==null||s.parent.setDocIcon(r.new.icon));return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(b=>{var w;if(b.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(r.old).forEach(D=>{b.removeAttribute(D)}),r.new.style&&r.new[p.CUSTOM_RIFF_DECKS]&&r.new[p.CUSTOM_RIFF_DECKS]!==r.old[p.CUSTOM_RIFF_DECKS]&&(r.new.style+=";animation:addCard 450ms linear"),Object.keys(r.new).forEach(D=>{D!=="id"&&(b.setAttribute(D,r.new[D]),D===p.CUSTOM_RIFF_DECKS&&r.new[p.CUSTOM_RIFF_DECKS]!==r.old[p.CUSTOM_RIFF_DECKS]&&(b.style.animation="addCard 450ms linear",setTimeout(()=>{b.parentElement?b.style.animation="":e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(v=>{v.style.animation=""})},450)))}),r["data-av-type"]&&b.setAttribute("data-av-type",r["data-av-type"]);const h=b.querySelectorAll(".protyle-attr"),S=h[h.length-1];r.new["custom-avs"]&&!r.new["av-names"]&&(y+=((w=S.querySelector(".protyle-attr--av"))==null?void 0:w.outerHTML)||"");const $=S.querySelector(".protyle-attr--refcount");$&&(y+=$.outerHTML),S.innerHTML=y+p.ZWSP});return}if(t.action==="move"){if(((i=t.context)==null?void 0:i.ignoreProcess)==="true")return;let r;if(n&&getSelection().rangeCount>0){r=getSelection().getRangeAt(0);const c=F(r.startContainer);c&&(oe(c)?r.insertNode(document.createElement("wbr")):oe(l[0]).insertAdjacentHTML("afterbegin","<wbr>"))}let d=!1;if(t.previousID&&l.length>0){const c=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`);if(c.length===0&&e.options.backlinkData&&n&&getSelection().rangeCount>0){const f=Y(r.startContainer,"data-node-id",null);f&&(f.before(un(l[0].cloneNode(!0))),d=!0)}else c.forEach(f=>{de(f)||(f.after(un(l[0].cloneNode(!0))),d=!0)})}else if(l.length>0){const c=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`);if(!e.options.backlinkData&&t.parentID===e.block.parentID&&!e.block.showAll)e.wysiwyg.element.prepend(un(l[0].cloneNode(!0))),d=!0;else if(c.length===0&&e.options.backlinkData&&n&&getSelection().rangeCount>0){const f=Y(getSelection().getRangeAt(0).startContainer,"data-node-id",null);f&&(f.before(un(l[0].cloneNode(!0))),d=!0)}else c.forEach(f=>{var m;de(f)||((m=f.firstElementChild)!=null&&m.classList.contains("protyle-action")?f.firstElementChild.after(un(l[0].cloneNode(!0))):f.prepend(un(l[0].cloneNode(!0))),d=!0)})}l.forEach(c=>{d?c.remove():!d&&c.parentElement&&Rc(c,e)}),n&&r&&(t.data==="focus"?(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(c=>{if(!de(c))return te(c),!0}),document.querySelectorAll("wbr").forEach(c=>{c.remove()})):fe(e.wysiwyg.element,r)),n||e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(c=>{c.querySelector(`[data-node-id="${t.id}"],[data-node-id="${t.parentID}"],[data-node-id="${t.previousID}"]`)&&(c.removeAttribute("data-render"),xe(e,c))});return}if(t.action==="insert"){if(((o=t.context)==null?void 0:o.ignoreProcess)==="true")return;const r=[];if(t.previousID){const d=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`);if(d.length===0&&n&&e.wysiwyg.element.childElementCount===0)e.wysiwyg.element.innerHTML=t.data;else if(d.length===0&&e.options.backlinkData&&n&&getSelection().rangeCount>0){const c=F(getSelection().getRangeAt(0).startContainer);c&&(c.insertAdjacentHTML("beforebegin",t.data),r.push(c.previousElementSibling))}else d.forEach(c=>{const f=de(c);f?(f.removeAttribute("data-render"),xe(e,f)):(c.insertAdjacentHTML("afterend",t.data),r.push(c.nextElementSibling))})}else if(t.nextID)Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.nextID}"]`)).forEach(d=>{const c=de(d);c?(c.removeAttribute("data-render"),xe(e,c)):(d.insertAdjacentHTML("beforebegin",t.data),r.push(d.previousElementSibling))});else{const d=e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`);if(!e.options.backlinkData&&t.parentID===e.block.parentID&&!e.block.showAll)e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),r.push(e.wysiwyg.element.firstElementChild);else if(d.length===0&&e.options.backlinkData&&n&&getSelection().rangeCount>0){const c=F(getSelection().getRangeAt(0).startContainer);c&&(c.insertAdjacentHTML("beforebegin",t.data),r.push(c.previousElementSibling))}else d.forEach(c=>{var f;de(c)||((f=c.firstElementChild)!=null&&f.classList.contains("protyle-action")?(c.firstElementChild.insertAdjacentHTML("afterend",t.data),r.push(c.firstElementChild.nextElementSibling)):(c.insertAdjacentHTML("afterbegin",t.data),r.push(c.firstElementChild)))})}if(e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(d=>{d.lastElementChild.getAttribute("spin")==="1"&&d.lastElementChild.remove()}),r.length===0)return;r.forEach(d=>{Xe(d),Re(d),ot(d,e),xe(e,d);const c=d.querySelector("wbr");if(n){const f=ye(d);c?fe(d,f):te(d)}else c&&c.remove()}),e.wysiwyg.element.querySelectorAll("[parent-heading]").forEach(d=>{d.remove()});return}if(t.action==="append"){e.options.backlinkData||la(e,!1);return}if(["addAttrViewCol","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","setAttrViewColDesc","duplicateAttrViewKey","setAttrViewViewDesc","setAttrViewCoverFrom","setAttrViewCoverFromAssetKeyID","setAttrViewBlockView","setAttrViewCardSize","setAttrViewCardAspectRatio","hideAttrViewName","setAttrViewShowIcon","setAttrViewWrapField","setAttrViewGroup","removeAttrViewGroup","hideAttrViewGroup","sortAttrViewGroup","foldAttrViewGroup","hideAttrViewAllGroups","setAttrViewFitImage","setAttrViewDisplayFieldName","insertAttrViewBlock","setAttrViewColDateFillSpecificTime","setAttrViewFillColBackgroundColor","setAttrViewUpdatedIncludeTime","setAttrViewCreatedIncludeTime"].includes(t.action)){n?t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-av-id="${t.id}"]`)).forEach(r=>{const d=r.querySelector(".av__title");d&&(d.textContent=t.data,d.dataset.title=t.data)}):Wp(e,t);return}if(t.action==="doUpdateUpdated"){l.forEach(r=>{r.setAttribute("updated",t.data)});return}},_n=e=>{let t;const n=Lute.NewNodeID();if(e.type==="BlocksMergeSuperBlock")t=tc(e.level,n);else if(e.type==="Blocks2Blockquote")t=document.createElement("div"),t.classList.add("bq"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeBlockquote"),t.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){t=document.createElement("div"),t.classList.add("list"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeList"),e.type==="Blocks2ULs"?t.setAttribute("data-subtype","u"):e.type==="Blocks2OLs"?t.setAttribute("data-subtype","o"):t.setAttribute("data-subtype","t");let r="";e.selectsElement.forEach((d,c)=>{e.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:e.type==="Blocks2OLs"?r+=`<div data-marker="${c+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${c+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),t.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=e.selectsElement[0].getAttribute("data-node-id"),s=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,i=[{action:"insert",id:n,data:t.outerHTML,nextID:a,parentID:s}],o=[];e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(t):e.selectsElement[0].parentElement.prepend(t);let l;e.selectsElement.forEach((r,d)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const c=r.getAttribute("data-node-id");o.push({action:"move",id:c,previousID:l||n,parentID:s}),e.type.endsWith("Ls")?(i.push({action:"move",id:c,parentID:t.children[d].getAttribute("data-node-id")}),t.children[d].firstElementChild.after(r)):(i.push({action:"move",id:c,previousID:l,parentID:n}),t.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),d===e.selectsElement.length-1&&o.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),xe(e.protyle,r))}),B(e.protyle,i,o),te(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),ae(["gutter"],e.protyle)},Yc=(e,t)=>{const n=document.createElement("template");n.innerHTML=e,Array.from(n.content.children).forEach(a=>{var s;(s=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||s.remove()})},kn=e=>{var t;(t=e.protyle.observerLoad)==null||t.disconnect();let n=e.selectsElement,a;if(e.nodeElement){a=getSelection().getRangeAt(0),a.insertNode(document.createElement("wbr")),n=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),n.length===0&&(n=[e.nodeElement]);let r=!1,d=!1;if(n.find((c,f)=>{if(c.classList.contains("li"))return d=!0,!0;if(c.nextElementSibling&&n[f+1]&&c.nextElementSibling===n[f+1])r=!0;else if(f!==n.length-1)return r=!1,!0}),d)return;n.length===1&&e.type==="Blocks2Hs"&&n[0].getAttribute("data-type")==="NodeHeading"&&e.level===parseInt(n[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=r}let s="";const i=[],o=[];let l;n.forEach((r,d)=>{var c,f,m,u,g,y,b,w;r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end"),s+=r.outerHTML;const h=r.getAttribute("data-node-id"),S=document.createElement("template");if(e.isContinue)if(o.push({action:"insert",id:h,previousID:((y=i[i.length-1])==null?void 0:y.id)||((b=r.previousElementSibling)==null?void 0:b.getAttribute("data-node-id")),data:r.outerHTML,parentID:((w=r.parentElement)==null?void 0:w.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),i.push({action:"delete",id:h}),d===n.length-1){const $=e.protyle.lute[e.type](s,e.level);S.innerHTML=$,Array.from(S.content.children).forEach(D=>{var v,k,_;const E=D.getAttribute("data-node-id");i.push({action:"insert",id:E,previousID:((v=D.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"))||((k=r.previousElementSibling)==null?void 0:k.getAttribute("data-node-id")),data:D.outerHTML,parentID:((_=r.parentElement)==null?void 0:_.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),o.splice(0,0,{action:"delete",id:E})}),r.outerHTML=$}else r.remove();else{let $=e.protyle.lute[e.type](r.outerHTML,e.level);if(S.innerHTML=$,!S.content.querySelector(`[data-node-id="${h}"]`))o.push({action:"insert",id:h,previousID:l||((c=r.previousElementSibling)==null?void 0:c.getAttribute("data-node-id")),data:r.outerHTML,parentID:((f=r.parentElement)==null?void 0:f.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),Array.from(S.content.children).forEach(D=>{var v,k,_;const E=D.getAttribute("data-node-id");i.push({action:"insert",id:E,previousID:((v=D.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"))||((k=r.previousElementSibling)==null?void 0:k.getAttribute("data-node-id")),data:D.outerHTML,parentID:((_=r.parentElement)==null?void 0:_.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),o.splice(0,0,{action:"delete",id:E})}),i.push({action:"delete",id:h}),r===((m=n[d+1])==null?void 0:m.previousElementSibling)?l=h:l=void 0;else{let D;r.getAttribute("data-type")==="NodeHeading"&&r.getAttribute("fold")==="1"&&S.content.firstElementChild.getAttribute("data-subtype")!==r.dataset.subtype&&(D=at(e.protyle,r,void 0,void 0,!1,!0),$=$.replace(' fold="1"',"")),D&&((u=D.doOperations)==null?void 0:u.length)>0&&i.push(...D.doOperations),o.push({action:"update",id:h,data:r.outerHTML}),i.push({action:"update",id:h,data:$}),D&&((g=D.undoOperations)==null?void 0:g.length)>0&&o.push(...D.undoOperations)}r.outerHTML=$}}),B(e.protyle,i,o),Xe(e.protyle.wysiwyg.element),Re(e.protyle.wysiwyg.element),ot(e.protyle.wysiwyg.element,e.protyle),xe(e.protyle,e.protyle.wysiwyg.element),a||e.range?fe(e.protyle.wysiwyg.element,a||e.range):te(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${n[0].getAttribute("data-node-id")}"]`)),ae(["gutter"],e.protyle)},wi=e=>Gp(void 0,null,function*(){var t,n;if(e.nodeElement.querySelector("wbr")||(t=oe(e.nodeElement))==null||t.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var a=zp(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),s,i,o;s=!(i=yield a.next()).done;s=!1){const f=i.value,m=f.getAttribute("data-node-id");f.removeAttribute("fold");const u=yield he("/api/transactions",{session:e.protyle.id,app:p.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:m}],undoOperations:[{action:"foldHeading",id:m}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:m}],[{action:"foldHeading",id:m}],e.protyle),f.insertAdjacentHTML("afterend",u.data[0].doOperations[0].retData)}}catch(f){o=[f]}finally{try{s&&(i=a.return)&&(yield i.call(a))}finally{if(o)throw o[0]}}const l=e.nodeElement.outerHTML;let r=(n=e.nodeElement.previousElementSibling)==null?void 0:n.getAttribute("data-node-id");!e.nodeElement.previousElementSibling&&e.protyle.block.showAll&&(r=(yield he("/api/block/getBlockRelevantIDs",{id:e.id})).data.previousID);const d=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,c=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=c,e.type==="CancelList"||e.type==="CancelBlockquote"){const f=document.createElement("template");f.innerHTML=c;const m=[{action:"delete",id:e.id}],u=[];let g=r;Array.from(f.content.children).forEach(y=>{const b=y.getAttribute("data-node-id");m.push({action:"insert",data:y.outerHTML,id:b,previousID:g,parentID:d}),u.push({action:"delete",id:b}),g=b}),u.push({action:"insert",data:l,id:e.id,previousID:r,parentID:d}),B(e.protyle,m,u)}else Q(e.protyle,e.id,c,l);fe(e.protyle.wysiwyg.element,ye(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(f=>{f.textContent===""&&L("/api/block/getRefText",{id:f.getAttribute("data-id")},m=>{f.innerHTML=m.data})}),xe(e.protyle,e.protyle.wysiwyg.element),Xe(e.protyle.wysiwyg.element),Re(e.protyle.wysiwyg.element),ot(e.protyle.wysiwyg.element,e.protyle)});let Wc;const B=(e,t,n)=>{if(t.length===0)return;if(!e){L("/api/transactions",{session:p.SIYUAN_APPID,app:p.SIYUAN_APPID,transactions:[{doOperations:t}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let s=!1;const i=new Date().getTime();if(a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&t.length===1&&t[0].action==="update"&&a.doOperations[0].id===t[0].id&&e.transactionTime-i<p.TIMEOUT_INPUT&&(s=!0),n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,s?e.undo.replace(t,e):e.undo.add(t,n,e)),t.length===1&&(t[0].action==="unfoldHeading"||t[0].action==="setAttrViewBlockView"||t[0].action==="setAttrs"&&t[0].data.startsWith('{"fold":'))||t.length===2&&t[0].action==="insertAttrViewBlock"){e.transactionTime=i+p.TIMEOUT_INPUT*2,L("/api/transactions",{session:e.id,app:p.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},o=>{o.data[0].doOperations.forEach(l=>{if(l.action==="unfoldHeading"||l.action==="foldHeading")Vc(l,e);else if(l.action==="setAttrs"){const r=e.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(d=>{d.querySelector(`[data-node-id="${l.id}"]`)&&(d.removeAttribute("data-render"),xe(e,d))})}})});return}window.clearTimeout(Wc),s?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:n}),e.transactionTime=i,Wc=window.setTimeout(()=>{Bc()},p.TIMEOUT_INPUT*2),t.find(o=>{var l;if(o.action==="insert")return(l=e.observerLoad)==null||l.disconnect(),!0})},Vc=(e,t)=>{var n;if(e.action==="unfoldHeading"||e.action==="foldHeading"){const a=t.gutter.element.querySelector('[data-type="fold"]');if(a&&a.removeAttribute("disabled"),e.action==="unfoldHeading"){const s=t.contentElement.scrollTop;if(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{const o=de(i);if(o){o.removeAttribute("data-render"),xe(t,o);return}if(i.lastElementChild.classList.contains("protyle-attr")||i.lastElementChild.remove(),Yc(e.retData,t),i.insertAdjacentHTML("afterend",e.retData),e.data==="remove"){const l=getSelection();l.rangeCount>0&&i.contains(l.getRangeAt(0).startContainer)&&te(i.nextElementSibling,void 0,!0),i.remove()}}),t.disabled&&En(t),Xe(t.wysiwyg.element),Re(t.wysiwyg.element),ot(t.wysiwyg.element,t),xe(t,t.wysiwyg.element),(n=e.context)!=null&&n.focusId){const i=t.wysiwyg.element.querySelector(`[data-node-id="${e.context.focusId}"]`);te(i),Oe(t,i)}else t.contentElement.scrollTop=s,t.scroll.lastScrollTop=s;return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{const i=de(s);i&&(i.removeAttribute("data-render"),xe(t,i))}),t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&L("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},s=>{rt({data:s,protyle:t,action:[p.CB_GET_APPEND,p.CB_GET_UNCHANGEID]})});return}},Q=(e,t,n,a)=>{n!==a&&B(e,[{id:t,data:n,action:"update"}],[{id:t,data:a,action:"update"}])},Aa=(e,t,n)=>{const a=[],s=[];e.forEach(i=>{const o=i.getAttribute("data-node-id");i.classList.remove("protyle-wysiwyg--select"),i.removeAttribute("select-start"),i.removeAttribute("select-end"),s.push({action:"update",id:o,data:i.outerHTML}),n(i),a.push({action:"update",id:o,data:i.outerHTML})}),B(t,a,s)},jc=e=>{var t,n,a;const s=e.blockElement.getAttribute("data-av-type");e.blockElement.querySelector('[data-type="av-search"]').value="";const i=e.groupID?`.av__body[data-group-id="${e.groupID}"] `:"";let o=e.previousId?e.blockElement.querySelector(i+`.av__gallery-item[data-id="${e.previousId}"]`):e.blockElement.querySelector(i+".av__gallery-item");e.blockElement.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(o=e.blockElement.querySelector(i+".av__gallery-add").previousElementSibling);const r=e.blockElement.querySelector(`.av__body[data-group-id="${e.groupID}"] `);if(r&&["updated","created"].includes(r.getAttribute("data-dtype"))&&r.getAttribute("data-content")!=="_@today@_"&&(o=(t=e.blockElement.querySelector('.av__body[data-content="_@today@_"] .av__gallery-add'))==null?void 0:t.previousElementSibling,!o))return;let d="";o==null||o.querySelectorAll(".av__cell").forEach(m=>{var u;let g=1;const y=ln(m);if(y==="lineNumber"){const w=(u=m.querySelector(".av__celltext"))==null?void 0:u.getAttribute("data-value");w&&(g=parseInt(w))}const b=`<div class="av__cell${y==="checkbox"?" av__cell-uncheck":""}" 
data-field-id="${m.dataset.fieldId}" 
data-wrap="${m.dataset.wrap}" 
data-dtype="${m.dataset.dtype}" 
${y==="block"?' data-detached="true"':""}>${Fn(Un(y,null),g,!1,s)}</div>`;m.previousElementSibling.classList.contains("av__gallery-name")?d+=`<div class="av__gallery-field av__gallery-field--name" data-empty="${m.parentElement.dataset.empty}">
    ${m.previousElementSibling.outerHTML}
    ${b}
</div>`:d+=`<div class="av__gallery-field" data-empty="${m.parentElement.dataset.empty}">
    ${m.previousElementSibling.outerHTML}
    ${b}
</div>`}),Et(["galleryItem"],e.blockElement);let c="";const f=((n=o==null?void 0:o.querySelector(".av__gallery-cover"))==null?void 0:n.className)||"fn__none";e.srcIDs.forEach(()=>{c+=`<div class="av__gallery-item" data-type="ghost">
    <div class="${f}"><span style="width: 100%;height: 100%;border-radius: var(--b3-border-radius) var(--b3-border-radius) 0 0;" class="av__pulse"></span></div>
    <div class="av__gallery-fields">${d}</div>
</div>`}),o?o.insertAdjacentHTML("afterend",c):(a=e.blockElement.querySelector(i+".av__gallery"))==null||a.insertAdjacentHTML("afterbegin",c),L("/api/av/getAttributeViewAddingBlockDefaultValues",{avID:e.blockElement.getAttribute("data-av-id"),viewID:e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),groupID:e.groupID,previousID:e.previousId},m=>{if(m.data.values){let u;const g=Object.keys(m.data.values);e.blockElement.querySelectorAll('[data-type="ghost"]').forEach(y=>{y.querySelectorAll(".av__cell").forEach(b=>{if(!u&&b.getAttribute("data-detached")==="true"&&(u=b),g.includes(b.dataset.fieldId)){const w=m.data.values[b.dataset.fieldId];w.type==="checkbox"&&b.parentElement.querySelector(".av__gallery-tip")&&(w.checkbox.content=b.getAttribute("aria-label").split('<div class="ft__on-surface">')[0]),b.innerHTML=Fn(w,void 0,!1,s),al(b,w)}})})}Gc(e.blockElement)})},Tn=(e,t)=>rc(e)?e.getAttribute("data-row-id"):C(e,t==="table"?"av__row":"av__gallery-item").dataset.id,Vn=(e,t)=>{const n=C(e,"av__row");if(!n)return;const a=e.querySelector("use");n.classList.contains("av__row--header")||t==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"||t==="unselectAll"?n.parentElement.querySelectorAll(".av__firstcol").forEach(s=>{s.querySelector("use").setAttribute("xlink:href","#iconUncheck");const i=C(s,"av__row");i&&i.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(s=>{s.querySelector("use").setAttribute("xlink:href","#iconCheck");const i=C(s,"av__row");i&&i.classList.add("av__row--select")}):t==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&t==="toggle"?(n.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(t==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&t==="toggle")&&(n.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),te(F(n)),La(n)},La=e=>{const t=F(e);if(!t)return;const n=e.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=e.parentElement.querySelectorAll(".av__row:not(.av__row--header)").length,s=e.parentElement.firstElementChild,i=s.querySelector("use");a===n&&a!==0?(s.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconCheck")):n===0?(s.classList.remove("av__row--select"),i.setAttribute("xlink:href","#iconUncheck")):n>0&&(s.classList.add("av__row--select"),i.setAttribute("xlink:href","#iconIndeterminateCheck"));const o=t.querySelector(".av__counter"),l=t.querySelectorAll(".av__row--select:not(.av__row--header)").length;if(l===0){o.classList.add("fn__none");return}o.classList.remove("fn__none"),o.innerHTML=`${l} ${window.siyuan.languages.selected}`},Gc=e=>{const t=e.getAttribute("data-av-type");e.querySelectorAll(".av__body").forEach(n=>{const a=n.dataset.pageSize;if(a){const s=n.querySelectorAll(t==="table"?".av__row:not(.av__row--header)":".av__gallery-item").length;parseInt(a)<s&&(n.dataset.pageSize=s.toString())}})},sl=e=>{var t;e.blockElement.querySelector('[data-type="av-search"]').value="";const n=e.groupID?`.av__body[data-group-id="${e.groupID}"] `:"";let a=e.blockElement.querySelector(n+`.av__row[data-id="${e.previousId}"]`)||e.blockElement.querySelector(n+".av__row--header");e.blockElement.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(a=e.blockElement.querySelector(n+".av__row--util").previousElementSibling);const i=e.blockElement.querySelector(`.av__body[data-group-id="${e.groupID}"] `);if(i&&["updated","created"].includes(i.getAttribute("data-dtype"))&&i.getAttribute("data-content")!=="_@today@_"&&(a=(t=e.blockElement.querySelector('.av__body[data-content="_@today@_"] .av__row--util'))==null?void 0:t.previousElementSibling),!a)return;let o='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div></div>';const l=a.querySelectorAll(".av__colsticky .av__cell").length-1;l>-1&&(o='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),a.querySelectorAll(".av__cell").forEach((d,c)=>{var f;let m=1;const u=ln(d);if(u==="lineNumber"){const g=(f=d.querySelector(".av__celltext"))==null?void 0:f.getAttribute("data-value");g&&(m=parseInt(g))}o+=`<div class="av__cell${u==="checkbox"?" av__cell-uncheck":""}" data-col-id="${d.dataset.colId}" 
data-wrap="${d.dataset.wrap}" 
data-dtype="${d.dataset.dtype}" 
style="width: ${d.style.width};${d.dataset.dtype==="number"?"text-align: right;":""}" 
${u==="block"?' data-detached="true"':""}>${Fn(Un(u,null),m)}</div>`,l===c&&(o+="</div>")});let r="";Et(["cell","row"],e.blockElement),e.srcIDs.forEach(()=>{r+=`<div class="av__row" data-type="ghost">
    ${o}
</div>`}),a.insertAdjacentHTML("afterend",r),L("/api/av/getAttributeViewAddingBlockDefaultValues",{avID:e.blockElement.getAttribute("data-av-id"),viewID:e.blockElement.getAttribute(p.CUSTOM_SY_AV_VIEW),groupID:e.groupID,previousID:e.previousId},d=>{if(d.data.values){let c;const f=Object.keys(d.data.values);e.blockElement.querySelectorAll('[data-type="ghost"]').forEach(m=>{m.querySelectorAll(".av__cell").forEach(u=>{if(!c&&u.getAttribute("data-detached")==="true"&&(c=u),f.includes(u.dataset.colId)){const g=d.data.values[u.dataset.colId];u.innerHTML=Fn(g),al(u,g)}})})}Gc(e.blockElement)})},xa=(e,t,n)=>{if(e.dataset.avType!=="table")return;const a=e.querySelectorAll(".av__row--header");a.length>0&&(n==="top"||n==="all")&&a.forEach(i=>{const o=i.parentElement.getBoundingClientRect(),l=Math.floor(t.top-o.top);l>0&&l<o.height-i.clientHeight?i.style.transform=`translateY(${l}px)`:i.style.transform=""});const s=e.querySelectorAll(".av__row--footer");s.length>0&&(n==="bottom"||n==="all")&&s.forEach(i=>{if(i.querySelector(".av__calc--ashow")){const o=i.parentElement.getBoundingClientRect(),l=Math.ceil(t.bottom-o.bottom);l<0&&-l<o.height-i.clientHeight?i.style.transform=`translateY(${l}px)`:i.style.transform=""}else i.style.transform=""})},_i=e=>{var t;if(e.currentPageSize===e.newPageSize)return;e.nodeElement.querySelectorAll(".av__body").forEach(a=>{a.dataset.pageSize=e.newPageSize});const n=e.nodeElement.getAttribute("data-node-id");B(e.protyle,[{action:"setAttrViewPageSize",avID:e.avID,data:parseInt(e.newPageSize),blockID:n}],[{action:"setAttrViewPageSize",data:parseInt(e.currentPageSize),avID:e.avID,blockID:n}]),(t=document.querySelector(".av__panel"))==null||t.remove()},zc=e=>{const t=new Fe(p.MENU_AV_PAGE_SIZE);if(t.isOpen)return;const n=e.target.dataset.size;t.addItem({iconHTML:"",label:"5",checked:n==="5",click(){_i({currentPageSize:n,newPageSize:"5",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",label:"10",checked:n==="10",click(){_i({currentPageSize:n,newPageSize:"10",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="25",label:"25",click(){_i({currentPageSize:n,newPageSize:"25",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="50",label:"50",click(){_i({currentPageSize:n,newPageSize:"50",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="100",label:"100",click(){_i({currentPageSize:n,newPageSize:"100",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n===p.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){_i({currentPageSize:n,newPageSize:p.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}});const a=e.target.getBoundingClientRect();t.open({x:a.left,y:a.bottom})},Kc=(e,t)=>{const n=e.querySelectorAll(".av__row--select:not(.av__row--header), .av__gallery-item--select");if(n.length===0)return;const a=e.getAttribute("data-av-id"),s=[],i=[];n.forEach(l=>{i.push(l.getAttribute("data-id"))}),n.forEach(l=>{var r;const d=ia("block",l.querySelector('.av__cell[data-dtype="block"]'));s.push({action:"insertAttrViewBlock",avID:a,previousID:((r=l.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcs:[{itemID:Lute.NewNodeID(),id:l.getAttribute("data-id"),isDetached:d.isDetached,content:d.block.content}],blockID:e.dataset.nodeId,groupID:l.parentElement.getAttribute("data-group-id")})});const o=G().format("YYYYMMDDHHmmss");s.push({action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}),B(t,[{action:"removeAttrViewBlock",srcIDs:i,avID:a},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:o}],s),n.forEach(l=>{l.remove()}),xa(e,t.contentElement.getBoundingClientRect(),"all"),La(e.querySelector(".av__row")),e.setAttribute("updated",o)},Ca=e=>{const t=e.blockElement.getAttribute("data-av-id"),n=[],a=[];new Array(e.count).fill(0).forEach(()=>{const i=Lute.NewNodeID();n.push(i),a.push({itemID:Lute.NewNodeID(),id:i,isDetached:!0,content:""})});const s=G().format("YYYYMMDDHHmmss");B(e.protyle,[{action:"insertAttrViewBlock",avID:t,previousID:e.previousID,srcs:a,blockID:e.blockElement.dataset.nodeId,groupID:e.groupID},{action:"doUpdateUpdated",id:e.blockElement.dataset.nodeId,data:s}],[{action:"removeAttrViewBlock",srcIDs:n,avID:t},{action:"doUpdateUpdated",id:e.blockElement.dataset.nodeId,data:e.blockElement.getAttribute("updated")}]),["gallery","kanban"].includes(e.blockElement.getAttribute("data-av-type"))?jc({blockElement:e.blockElement,protyle:e.protyle,srcIDs:n,previousId:e.previousID,groupID:e.groupID}):sl({protyle:e.protyle,blockElement:e.blockElement,srcIDs:n,previousId:e.previousID,groupID:e.groupID}),e.blockElement.setAttribute("updated",s)},ry=()=>{},dy=()=>{},hi=e=>{ae(["gutterOnly"],e);const t=Xc(e),n=4;setTimeout(()=>{if(e.scroll&&e.scroll.element.parentElement.getAttribute("style")&&e.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(e.contentElement.clientHeight-49,200)}px`),!e.disabled){const s=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(i=>{i.querySelector(".av__scroll")&&xa(i,s,"all")})}(t.width>n||isNaN(t.width))&&typeof window.echarts!="undefined"&&e.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(s=>{const i=window.echarts.getInstanceById(s.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(s=>{s.nextElementSibling.style.wordBreak==="break-word"&&si(s.parentElement)});const a=e.wysiwyg.element.querySelector("[data-resize-top]");a&&(a.scrollIntoView(),e.contentElement.scrollTop+=parseInt(a.getAttribute("data-resize-top")),a.removeAttribute("data-resize-top"))},p.TIMEOUT_TRANSITION+100)},us=(e,t)=>{var n,a,s,i;if(t==="preview"){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),(n=e.scroll)==null||n.element.classList.add("fn__none"),e.options.render.breadcrumb&&((a=e.breadcrumb)==null||a.element.classList.add("fn__none"),e.breadcrumb.toggleExit(!0)),e.preview.render(e)}else if(t==="wysiwyg"){if(!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&((s=e.scroll)==null||s.element.classList.remove("fn__none")),e.options.render.breadcrumb&&((i=e.breadcrumb)==null||i.element.classList.remove("fn__none"),e.breadcrumb.toggleExit(!e.block.showAll)),hi(e)}ae(["gutterOnly","toolbar","select","hint","util"],e),e.app.plugins.forEach(o=>{o.eventBus.emit("switch-protyle-mode",{protyle:e})})};let Zc;const Kp=(e,t)=>{t.addEventListener("scroll",()=>{const n=t.getBoundingClientRect();if(!e.toolbar.element.classList.contains("fn__none")){const a=e.toolbar.element.getAttribute("data-inity").split(p.ZWSP),s=parseInt(a[0])+(parseInt(a[1])-t.scrollTop);s<n.top-e.toolbar.toolbarHeight||s>n.bottom-e.toolbar.toolbarHeight?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=s+"px",e.toolbar.element.style.display="")}if(e.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.dataset.render==="true"&&xa(a,n,"all")}),!e.element.classList.contains("block__edit")&&!P()&&e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||ae(["gutterOnly"],e),e.scroll&&!e.scroll.element.classList.contains("fn__none")&&(clearTimeout(Zc),Zc=window.setTimeout(()=>{let a=document.elementFromPoint(n.left+n.width/2,n.top+10);a.classList.contains("protyle-wysiwyg")&&(a=document.elementFromPoint(n.left+n.width/2,n.top+20));const s=F(a);if(!s){if((e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(C(a,"protyle-background")||C(a,"protyle-title"))){const i=e.scroll.element.querySelector(".b3-slider");i.value="1",e.scroll.element.setAttribute("aria-label",`Blocks 1/${e.block.blockCount}`)}return}e.scroll.updateIndex(e,s.getAttribute("data-node-id"))},p.TIMEOUT_LOAD)),!(e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll&&e.scroll.element.classList.contains("fn__none")||!e.scroll||e.scroll.lastScrollTop===t.scrollTop||e.scroll.lastScrollTop===-1||!e.wysiwyg.element.firstElementChild)){if(e.scroll.lastScrollTop>t.scrollTop){if(t.scrollTop===0)return;t.scrollTop<t.clientHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(e.contentElement.style.width=e.contentElement.offsetWidth+"px",e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),L("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{e.contentElement.style.overflow="",e.contentElement.style.width="",rt({data:a,protyle:e,action:[p.CB_GET_BEFORE,p.CB_GET_UNCHANGEID]})}))}else if(t.scrollTop>t.scrollHeight-t.clientHeight*1.8&&e.wysiwyg.element.lastElementChild&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"){if(e.scroll.lastScrollTop>768&&t.scrollTop>e.scroll.lastScrollTop*2){t.scrollTop=e.scroll.lastScrollTop;return}e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),L("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{rt({data:a,protyle:e,action:[p.CB_GET_APPEND,p.CB_GET_UNCHANGEID]})})}e.scroll.lastScrollTop=Math.max(t.scrollTop,0)}},{capture:!1,passive:!0,once:!1})},Zp=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",(e.options.render.background||e.options.render.title)&&(e.contentElement.innerHTML='<div class="protyle-top"></div>',e.options.render.background&&e.contentElement.firstElementChild.appendChild(e.background.element),e.options.render.title&&e.contentElement.firstElementChild.appendChild(e.title.element)),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(p.CB_GET_HISTORY)||Kp(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.options.render.scroll&&e.element.appendChild(e.scroll.element.parentElement),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),e.element.append(e.highlight.styleElement),vi(e),us(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let t;const n=Zn(),a=$t();e.contentElement.addEventListener("mousewheel",i=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||a&&!i.metaKey||!a&&!i.ctrlKey||i.deltaX!==0)){if(i.stopPropagation(),i.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(i.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;Wi(),clearTimeout(t),se(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,n),t=window.setTimeout(()=>{var o;L("/api/setting/setEditor",window.siyuan.config.editor),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(l=>{si(l.parentElement)}),(o=document.querySelector(`#message [data-id="${n}"] button`))==null||o.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,Wi(),L("/api/setting/setEditor",window.siyuan.config.editor),tt(n),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(l=>{si(l.parentElement)})})},p.TIMEOUT_LOAD)}},{passive:!0}),e.contentElement.addEventListener("click",i=>{e.disabled||e.contentElement.querySelector(".protyle-wysiwyg--select")||!i.target.classList.contains("protyle-content")&&!i.target.classList.contains("protyle-wysiwyg")||setTimeout(()=>{if(window.getSelection().rangeCount>0){const d=window.getSelection().getRangeAt(0);if(d.toString()!==""&&e.wysiwyg.element.contains(d.startContainer))return}const o=e.wysiwyg.element.lastElementChild,l=o.getBoundingClientRect(),r=document.createRange();if(i.y>l.bottom){const d=oe(yt(o));if(!e.options.click.preventInsetEmptyBlock&&(!d||o.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||o.getAttribute("data-type")==="NodeParagraph"&&oe(d).innerHTML!=="")){let c;o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"?c=ts(o):c=yn(!1,!1),e.wysiwyg.element.insertAdjacentElement("beforeend",c),B(e,[{action:"insert",data:c.outerHTML,id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:c.getAttribute("data-node-id")}]);const f=oe(c);r.selectNodeContents(f),r.collapse(!0),X(r),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},p.TIMEOUT_TRANSITION)}else d&&(r.selectNodeContents(d),r.collapse(!1),X(r));e.toolbar.range=r}})});let s=!1;e.element.addEventListener("mouseover",i=>{const o=C(i.target,"protyle-attr");if(o&&!o.parentElement.classList.contains("protyle-title")){const d=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");d&&d.classList.remove("protyle-wysiwyg--hl"),s=!0,o.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(s){const d=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");d&&d.classList.remove("protyle-wysiwyg--hl"),s=!1}const l=F(i.target);if(e.options.render.gutter&&l){if(l&&(l.classList.contains("list")||l.classList.contains("li")))return;const d=de(l);if(d){e.gutter.render(e,d,e.wysiwyg.element);return}e.gutter.render(e,l,e.wysiwyg.element,i.target);return}const r=U(i.target,"BUTTON");if(r&&r.parentElement.classList.contains("protyle-gutters")){const d=r.getAttribute("data-type");if(d==="fold"||d==="NodeAttributeViewRow"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(c=>{c.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${r.getAttribute("data-node-id")}"]`)).find(c=>{if(!de(c)&&e.gutter.isMatchNode(c)){const f=r.dataset.groupId&&r.dataset.groupId!=="undefined"?`.av__body[data-group-id="${r.dataset.groupId}"] `:"",m=c.querySelector(f+`.av__row[data-id="${r.dataset.rowId}"]`);return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(u=>{c!==u&&u.classList.remove("protyle-wysiwyg--hl"),m&&m!==u&&m.classList.remove("av__row--hl")}),d==="NodeAttributeViewRowMenu"?m.classList.add("av__row--hl"):c.classList.add("protyle-wysiwyg--hl"),!0}}),i.preventDefault();return}})},vi=(e,t)=>{e.element.removeAttribute("data-loading"),setTimeout(()=>{e.element.getAttribute("data-loading")!=="finished"&&e.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${t||""}</div>
</div>`)},p.TIMEOUT_LOAD)},fs=e=>{e.element.setAttribute("data-loading","finished"),e.element.querySelectorAll(".wysiwygLoading").forEach(t=>{t.remove()})},Xc=e=>{if(e.options.action.includes(p.CB_GET_HISTORY))return{width:0,padding:0};const t=Jc(e),n=t.left,a=t.right;e.options.backlinkData?e.wysiwyg.element.style.padding=`4px ${a}px 4px ${n}px`:e.wysiwyg.element.style.padding=`${t.top}px ${a}px ${t.bottom}px ${n}px`,e.options.render.background&&e.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${n}px;margin-right:${a}px`),e.options.render.title&&(e.title.element.style.margin=`16px ${a}px 0 ${n}px`),e.element.style.setProperty("--b3-width-protyle",e.element.clientWidth+"px"),e.element.style.setProperty("--b3-width-protyle-content",e.contentElement.clientWidth+"px");const s=e.wysiwyg.element.getAttribute("data-realwidth"),i=e.wysiwyg.element.clientWidth-n-a;return e.wysiwyg.element.setAttribute("data-realwidth",i.toString()),e.element.style.setProperty("--b3-width-protyle-wysiwyg",i.toString()+"px"),{width:s?Math.abs(parseFloat(s)-i):0}},Jc=e=>{let t=16,n=24,a=16;if(e.options.typewriterMode&&(P()?a=window.innerHeight/5:a=e.element.clientHeight/2),!P()){let s=e.wysiwyg.element.getAttribute(p.CUSTOM_SY_FULLWIDTH);s||(s=window.siyuan.config.editor.fullWidth?"true":"false");let i=(e.element.clientWidth-p.SIZE_EDITOR_WIDTH)/2;s==="false"&&i>96?(i>p.SIZE_EDITOR_WIDTH&&(i=e.element.clientWidth*.382/1.382),i=Math.ceil(i),n=i,t=i):e.element.clientWidth>p.SIZE_EDITOR_WIDTH&&(n=96,t=96)}return{left:n,right:t,bottom:a,top:16}},Ei=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:e.block.rootID,startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!e.wysiwyg.element.contains(a.startContainer))&&(a=e.toolbar.range),a&&e.wysiwyg.element.contains(a.startContainer)){const s=F(a.startContainer);if(s){const i=et(s,void 0,a);n.focusId=s.getAttribute("data-node-id"),n.focusStart=i.start,n.focusEnd=i.end}}return e.block.showAll&&(n.zoomInId=e.block.id),t?n:(window.siyuan.storage[p.LOCAL_FILEPOSITION][e.block.rootID]=n,new Promise(s=>{Te(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION],()=>{s(!0)})}))},Oo=e=>{var t,n,a,s,i,o,l,r,d,c,f,m,u,g;let y=[];if(e.mergedOptions?y=e.mergedOptions.action:e.focus?y=[p.CB_GET_UNUNDO,p.CB_GET_FOCUS]:y=[p.CB_GET_UNUNDO],(t=e.scrollAttr)!=null&&t.zoomInId&&((n=e.scrollAttr)!=null&&n.rootId)&&e.scrollAttr.zoomInId!==e.scrollAttr.rootId){L("/api/filetree/getDoc",{id:e.scrollAttr.zoomInId,size:p.SIZE_GET_MAX,query:(a=e.protyle.query)==null?void 0:a.key,queryMethod:(s=e.protyle.query)==null?void 0:s.method,queryTypes:(i=e.protyle.query)==null?void 0:i.types,highlight:!na()},b=>{var w,h,S,$,D;b.code===1?L("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((w=e.mergedOptions)==null?void 0:w.blockId)||((h=e.protyle.block)==null?void 0:h.rootID)||e.scrollAttr.startId,query:(S=e.protyle.query)==null?void 0:S.key,queryMethod:($=e.protyle.query)==null?void 0:$.method,queryTypes:(D=e.protyle.query)==null?void 0:D.types,highlight:!na()},v=>{rt({data:v,protyle:e.protyle,action:y,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(v.data.keywords)}:void 0,updateReadonly:e.updateReadonly})}):(y.push(p.CB_GET_ALL),rt({data:b,protyle:e.protyle,action:y,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(b.data.keywords)}:void 0,updateReadonly:e.updateReadonly}))});return}L("/api/filetree/getDoc",{id:((o=e.scrollAttr)==null?void 0:o.rootId)||((l=e.mergedOptions)==null?void 0:l.blockId)||((r=e.protyle.block)==null?void 0:r.rootID)||((d=e.scrollAttr)==null?void 0:d.startId),startID:(c=e.scrollAttr)==null?void 0:c.startId,endID:(f=e.scrollAttr)==null?void 0:f.endId,query:(m=e.protyle.query)==null?void 0:m.key,queryMethod:(u=e.protyle.query)==null?void 0:u.method,queryTypes:(g=e.protyle.query)==null?void 0:g.types,highlight:!na()},b=>{rt({data:b,protyle:e.protyle,action:y,scrollAttr:e.scrollAttr,afterCB:e.cb?()=>{e.cb(b.data.keywords)}:void 0,updateReadonly:e.updateReadonly})})};var ll=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Qc=e=>{const t=e.dataset.type;let n="";if(["NodeHeading","NodeParagraph"].includes(t))n=oe(e).innerHTML;else if(t==="NodeHTMLBlock")n="HTML";else if(t==="NodeAttributeView")n=e.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(t==="NodeThematicBreak")n=window.siyuan.languages.line;else if(t==="NodeIFrame")n="IFrame";else if(t==="NodeWidget")n=window.siyuan.languages.widget;else if(t==="NodeVideo")n=window.siyuan.languages.video;else if(t==="NodeAudio")n=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(t))n=ol(e);else if(e.classList.contains("render-node"))n+=e.dataset.subtype||Lute.UnEscapeHTMLStr(e.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(t)&&(Array.from(e.querySelectorAll("[data-node-id]")).find(a=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a.getAttribute("data-type")))return n=Qc(e.querySelector("[data-node-id]")),!0}),n))return n;return n+` <span data-type="block-ref" data-subtype="s" data-id="${e.getAttribute("data-node-id")}">*</span>`},ol=(e,t=!1)=>{let n="";const a=e.dataset.type;return a==="NodeHTMLBlock"?n+=Lute.UnEscapeHTMLStr(e.querySelector("protyle-html").getAttribute("data-content")):a==="NodeAttributeView"?(e.querySelectorAll(".av__row").forEach(s=>{s.querySelectorAll(".av__cell").forEach(i=>{n+=nl(i)+" "}),n+=`
`}),n=n.trimEnd()):a==="NodeThematicBreak"?n+="---":a==="NodeIFrame"||a==="NodeWidget"?n+=e.querySelector("iframe").getAttribute("src"):a==="NodeVideo"?n+=e.querySelector("video").getAttribute("src"):a==="NodeAudio"?n+=e.querySelector("audio").getAttribute("src"):e.classList.contains("render-node")?n+=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock"].includes(a)?n+=e.querySelector("[spellcheck]").textContent:a==="NodeTable"?(e.querySelectorAll("th, td").forEach(s=>{n+=s.textContent.trim()+"	",s.nextElementSibling||(n=n.slice(0,-1)+`
`)}),n=n.slice(0,-1)):!t&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a)&&e.querySelectorAll("[data-node-id]").forEach(s=>{const i=ol(s,!0);n+=i?i+`
`:""}),n},Xp=(e,t)=>ll(void 0,null,function*(){try{let n=(yield ni())||"";n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),ps(e,{textPlain:n,textHTML:"",target:t})}catch(n){console.log(n)}}),eu=e=>ll(void 0,null,function*(){if([].length===0){let n=(yield ni())||"";if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(O(s.startContainer,"data-type","code")||C(s.startContainer,"hljs")){lt(n.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}}n=n.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),n=n.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),n=n.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),n=n.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),n=n.replace(/<span data-type="text".*?>(.*?)<\/span>/g,"$1"),n=n.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),n=n.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),n=n.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),n=n.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),n=n.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u>"),gs(e);const a=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(n));ki(e),lt(a,e,!1,!1,!0)}}),gs=e=>{e.lute.SetInlineAsterisk(!0),e.lute.SetGFMStrikethrough(!0),e.lute.SetInlineMath(!0),e.lute.SetSub(!0),e.lute.SetSup(!0),e.lute.SetTag(!0),e.lute.SetInlineUnderscore(!0)},ki=e=>{e.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.lute.SetMark(window.siyuan.config.editor.markdown.inlineMark)},Jp=(e,t)=>ll(void 0,null,function*(){if(e&&e.app&&e.app.plugins)for(let n=0;n<e.app.plugins.length;n++){const a=yield new Promise(s=>{e.app.plugins[n].eventBus.emit("paste",{protyle:e,resolve:s,textHTML:"",textPlain:"",siyuanHTML:"",files:t})&&s(void 0)});a!=null&&a.files&&(t=a.files)}ko(t,e,!0)}),ps=(e,t)=>ll(void 0,null,function*(){var n;("clipboardData"in t||"dataTransfer"in t)&&(t.stopPropagation(),t.preventDefault());let a,s,i,o;if("clipboardData"in t)a=t.clipboardData.getData("text/html"),s=t.clipboardData.getData("text/plain"),i=t.clipboardData.getData("text/siyuan"),o=t.clipboardData.files;else if("dataTransfer"in t)a=t.dataTransfer.getData("text/html"),s=t.dataTransfer.getData("text/plain"),i=t.dataTransfer.getData("text/siyuan"),t.dataTransfer.types[0]==="Files"&&(o=t.dataTransfer.items);else{if(((n=t.localFiles)==null?void 0:n.length)>0){Jp(e,t.localFiles);return}a=t.textHTML,s=t.textPlain,i=t.siyuanHTML,o=t.files}if(s=s.replace(/\r\n|\r|\u2028|\u2029/g,`
`),(a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${s}">${s}</a>`||a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${s}">${s}</a><!--EndFragment-->`)&&(a=""),s.endsWith(p.ZWSP)&&!a&&!i&&(i=s.substr(0,s.length-1)),a&&s&&!i){const f=Oi(a);i=f.textSiyuan,a=f.textHtml}if(!i){const f=new DOMParser().parseFromString(a,"text/html");f.body&&f.body.innerHTML&&(a=f.body.innerHTML),a.startsWith(`
<!--StartFragment-->`)&&a.endsWith(`<!--EndFragment-->

`)&&(a=f.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),a=Lute.Sanitize(a)}if(e&&e.app&&e.app.plugins)for(let f=0;f<e.app.plugins.length;f++){const m=yield new Promise(u=>{e.app.plugins[f].eventBus.emit("paste",{protyle:e,resolve:u,textHTML:a,textPlain:s,siyuanHTML:i,files:o})&&u(void 0)});m!=null&&m.textHTML&&(a=m.textHTML),m!=null&&m.textPlain&&(s=m.textPlain),m!=null&&m.siyuanHTML&&(i=m.siyuanHTML),m!=null&&m.files&&(o=m.files)}const l=F(t.target);if(!l){o&&o.length>0&&aa(e,o);return}e.hint.enableExtend=p.BLOCK_HINT_KEYS.includes(e.hint.splitChar),ae(e.hint.enableExtend?["select"]:["select","hint"],e),e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(f=>{f.classList.remove("protyle-wysiwyg--hl")});const r=Hf(a,s,e),d=ye(e.wysiwyg.element);if(l.getAttribute("data-type")==="NodeCodeBlock"||e.toolbar.getCurrentType(d).includes("code")){lt(s.replace(/\u200D```/g,"```").replace(/```/g,"\u200D```"),e);return}else if(i){const f=document.createElement("div");if(f.innerHTML=i,d.toString()){let g=[],y;if(f.childNodes.length===1&&f.childElementCount===1&&(g=(f.firstElementChild.getAttribute("data-type")||"").split(" "),(g.includes("block-ref")||g.includes("a"))&&(y=f.firstElementChild)),!y){const b=document.createElement("template");b.innerHTML=e.lute.SpinBlockDOM(i),b.content.firstChild.nodeType!==3&&b.content.firstElementChild.classList.contains("p")&&(b.innerHTML=b.content.firstElementChild.firstElementChild.innerHTML.trim()),b.content.childNodes.length===1&&b.content.childElementCount===1&&(g=(b.content.firstElementChild.getAttribute("data-type")||"").split(" "),(g.includes("block-ref")||g.includes("a"))&&(y=b.content.firstElementChild))}if(g.includes("block-ref")){const b=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${y.dataset.id}${p.ZWSP}s${p.ZWSP}${d.toString()}`});b[0]&&e.toolbar.range.selectNodeContents(b[0]);return}if(g.includes("a")){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:`${y.dataset.href}${p.ZWSP}${d.toString()}`});return}}let m=!1;f.querySelectorAll("[data-node-id]").forEach(g=>{const y=Lute.NewNodeID();g.setAttribute("data-node-id",y),g.removeAttribute(p.CUSTOM_RIFF_DECKS),g.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),g.setAttribute("updated",y.split("-")[0]),g.removeAttribute("refcount"),m=!0}),l.classList.contains("table")&&(m=!1),f.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(g=>{g.setAttribute("contenteditable","true")});let u=f.innerHTML;if(!l.classList.contains("av")&&u.startsWith("[[{")&&u.endsWith("}]]"))try{const g=JSON.parse(u);g.length>0&&g[0].length>0&&g[0][0].id&&g[0][0].type?lt(s,e,m):lt(u,e,m)}catch(g){lt(u,e,m)}else-1<u.indexOf("NodeHTMLBlock")&&(u=Lute.UnEscapeHTMLStr(u)),u=u.replace(/\u200D```/g,"```"),lt(u,e,m,!1,!0);xe(e,e.wysiwyg.element),Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e)}else if(r)r.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(lt(r,e,!0,!1,!0),Re(e.wysiwyg.element)):lt(r,e),ae(["hint"],e);else{let f=!1;if(a.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""){a=a.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),o&&o.length===1&&(a.startsWith("<img")||a.startsWith("<table")&&a.indexOf("<img")>-1)?f=!1:f=!0;let m=!1;const u=document.createElement("div");u.innerHTML=a;const g=document.createTreeWalker(u,NodeFilter.SHOW_TEXT,null);let y=null;for(;y=g.nextNode();)if(y.nodeValue&&(y.nodeValue.match(/\n/g)||[]).length>=2){m=!0;break}const b=a.toLowerCase();s&&s.trim()!==""&&(a.startsWith("<span")||a.startsWith("<br"))&&m&&0>b.indexOf('class="katex')&&0>b.indexOf('class="math')&&0>b.indexOf("</a>")&&0>b.indexOf("</img>")&&0>b.indexOf("</code>")&&0>b.indexOf("</b>")&&0>b.indexOf("</strong>")&&0>b.indexOf("</i>")&&0>b.indexOf("</em>")&&0>b.indexOf("</ol>")&&0>b.indexOf("</ul>")&&0>b.indexOf("</table>")&&0>b.indexOf("</blockquote>")&&0>b.indexOf("</h1>")&&0>b.indexOf("</h2>")&&0>b.indexOf("</h3>")&&0>b.indexOf("</h4>")&&0>b.indexOf("</h5>")&&0>b.indexOf("</h6>")&&(f=!1)}if(f){const m=document.createElement("div");m.innerHTML=a,m.querySelectorAll("a").forEach(g=>{g.innerHTML.trim()===""&&g.remove()});let u;if(m.childElementCount===1&&m.childNodes.length===1&&(m.firstElementChild.tagName==="A"?u=m.firstElementChild:m.firstElementChild.tagName==="P"&&m.firstElementChild.childElementCount===1&&m.firstElementChild.childNodes.length===1&&m.firstElementChild.firstElementChild.tagName==="A"&&(u=m.firstElementChild.firstElementChild)),u){const g=d.toString(),y=e.toolbar.setInlineMark(e,"a","range",{type:"a",color:`${u.getAttribute("href")}${p.ZWSP}${g||u.textContent}`});g||(y[0].lastChild&&d.setEnd(y[0].lastChild,y[0].lastChild.textContent.length),d.collapse(!1));return}L("/api/lute/html2BlockDOM",{dom:m.innerHTML},g=>{lt(g.data,e,!1,!1,!0),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(y=>{y.textContent===""&&L("/api/block/getRefText",{id:y.getAttribute("data-id")},b=>{y.innerHTML=b.data})}),xe(e,e.wysiwyg.element),Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e),Oe(e,void 0,"nearest","smooth")});return}else if(o&&o.length>0){aa(e,o);return}else if(s.trim()!==""&&(o&&o.length===0||!o)){if(d.toString()!==""){const u=s.split(`
`)[0];if(Kn(s)){const g=e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${s.substring(2,24)}${p.ZWSP}s${p.ZWSP}${d.toString()}`});g[0]&&e.toolbar.range.selectNodeContents(g[0]);return}else if(Mn(u)){e.toolbar.setInlineMark(e,"file-annotation-ref","range",{type:"file-annotation-ref",color:u.substring(2).replace(/ ".+">>$/,"")});return}else{const g=s.startsWith("assets/")?s:e.lute.GetLinkDest(s);if(g){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:g});return}}}s=s.replace(/\u200D```/g,"```");const m=e.lute.Md2BlockDOM(s);lt(m,e,!1,!1,!0)}xe(e,e.wysiwyg.element),Xe(e.wysiwyg.element),Re(e.wysiwyg.element),ot(e.wysiwyg.element,e)}const c=l.querySelector(".av__cell--select");l.classList.contains("av")&&c?ma(l,c):Oe(e,void 0,"nearest","smooth")}),la=(e,t,n)=>{if(!e.preview.element.classList.contains("fn__none")){e.preview.render(e),fs(e);return}if(window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.title&&(e.title.element.removeAttribute("data-render"),e.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?e.title.element.classList.add("protyle-wysiwyg--attr"):e.title.element.classList.remove("protyle-wysiwyg--attr")),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),ki(e),e.lute.SetGFMStrikethrough1(!1),vi(e),e.options.backlinkData){const a=e.element.getAttribute("data-ismention")==="true",s=C(e.element,"sy__backlink");if(s){const i=s.querySelectorAll(".b3-text-field"),o=a?i[1].value:i[0].value;L(a?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:e.element.getAttribute("data-defid"),refTreeID:e.block.rootID,highlight:!na(),keyword:o},l=>{e.options.backlinkData=a?l.data.backmentions:l.data.backlinks,Mc(e,e.options.backlinkData),Eo(e,l.data.keywords)})}}else fn(e),Oo({protyle:e,focus:t,scrollAttr:Ei(e,!0),updateReadonly:n,cb(a){var s;(s=e.query)!=null&&s.key&&Eo(e,a,e.highlight.rangeIndex)}})},qo=(e,t)=>{L("/api/filetree/createDailyNote",{notebook:t,app:p.SIYUAN_APPID},n=>{ft(e,n.data.id)})},tu=e=>{if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===p.DIALOG_DIALYNOTE)return i.destroy(),!0}))return;const n=Ms();if(n===0){se(window.siyuan.languages.newFileTip);return}if(n===1){let i="";window.siyuan.notebooks.find(o=>{o.closed||(i=o.id)}),qo(e,i);return}const a=window.siyuan.storage[p.LOCAL_DAILYNOTEID],s=window.siyuan.notebooks.find(i=>{if(i.id===a&&!i.closed)return!0});if(a&&s&&!P())qo(e,a);else{let i="";window.siyuan.notebooks.forEach(d=>{d.closed||(i+=`<option value="${d.id}">${d.name}</option>`)});const o=new ke({positionId:p.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${i}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});o.element.setAttribute("data-key",p.DIALOG_DIALYNOTE);const l=o.element.querySelectorAll(".b3-button"),r=o.element.querySelector(".b3-select");r.value=a,l[0].addEventListener("click",()=>{o.destroy()}),l[1].addEventListener("click",()=>{const d=r.value;window.siyuan.storage[p.LOCAL_DAILYNOTEID]=d,Te(p.LOCAL_DAILYNOTEID,window.siyuan.storage[p.LOCAL_DAILYNOTEID]),qo(e,d),o.destroy()})}},Ro=()=>{const e=p.HELP_PATH[window.siyuan.config.appearance.lang];L("/api/notebook/removeNotebook",{notebook:e,callback:p.CB_MOUNT_REMOVE},()=>{L("/api/notebook/openNotebook",{notebook:e,app:p.SIYUAN_APPID})})},Bo=()=>{const e=new ke({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_CREATENOTEBOOK);const t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),()=>{t[1].dispatchEvent(new CustomEvent("click"))}),t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const n=e.element.querySelector("input").value;if(!Zi(n))return!1;L("/api/notebook/createNotebook",{name:n}),e.destroy()})},Uo=e=>{L("/api/storage/getRecentDocs",{sortBy:"viewedAt"},t=>{let n="";t.data.forEach((a,s)=>{n+=`<li data-index="${s}" data-node-id="${a.rootID}" class="b3-list-item${s===0?" b3-list-item--focus":""}">
${ge(a.icon||window.siyuan.storage[p.LOCAL_IMAGES].file,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${pe(a.title)}</span>
</li>`}),nn({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",s=>{const i=C(s.target,"b3-list-item");i&&ft(e,i.dataset.nodeId,[p.CB_GET_SCROLL])})}})})},rl=(e,t,n)=>{e.addEventListener("mousedown",a=>{const s=C(t,"b3-dialog__body")||C(t,"protyle-util");if(!s)return;s.style.userSelect="none",s.style.pointerEvents="none";const i=document;i.ondragstart=()=>!1;const o=a.clientX,l=t.clientWidth,r=s.clientWidth-256;i.onmousemove=d=>{const c=l+(d.clientX-o);c<256||c>r||(t.style.width=c+"px")},i.onmouseup=()=>{s.style.userSelect="auto",s.style.pointerEvents="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,n&&(window.siyuan.storage[p.LOCAL_HISTORY][n]=t.clientWidth+"px",Te(p.LOCAL_HISTORY,window.siyuan.storage[p.LOCAL_HISTORY]))}})},Fo=(e,t)=>{if(!e||e.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return e.forEach((a,s)=>{let i="";t&&(i=`data-id2="${t[s].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${i} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${Ue(a.path)} ${a.hSize}">${pe(a.title)}</span>
</li>`}),n};let ja,Si;const nu=(e,t)=>{if(!C(t,"history__side"))return;const a=C(t,"b3-dialog__container");if(!a)return;const s=a.querySelector('[data-type="editors"]'),i=s.firstElementChild,o=s.lastElementChild;ja||(ja=new Gn(e,i.lastElementChild,{blockId:"",history:{snapshot:""},action:[p.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),En(ja.protyle),Si=new Gn(e,o.lastElementChild,{blockId:"",action:[p.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),En(Si.protyle)),L("/api/repo/openRepoSnapshotDoc",{id:t.getAttribute("data-id")},r=>{i.classList.remove("fn__none");const d=i.querySelector("textarea"),c=_e().extname(r.data.content).toLowerCase(),f=i.querySelector(".protyle-title__input");p.SIYUAN_ASSETS_IMAGE.concat(p.SIYUAN_ASSETS_AUDIO).concat(p.SIYUAN_ASSETS_VIDEO).includes(c)?(d.previousElementSibling.innerHTML=Ra(r.data.content),d.previousElementSibling.classList.remove("fn__none"),d.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):r.data.displayInText?(d.value=r.data.content,d.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),d.previousElementSibling.classList.add("fn__none")):(d.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),d.previousElementSibling.classList.add("fn__none"),ja.protyle.options.history.snapshot=a.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),rt({data:r,protyle:ja.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]})),f.textContent=r.data.title,i.querySelector(".history__date").textContent=G(r.data.updated).format("YYYY-MM-DD HH:mm")});const l=t.getAttribute("data-id2");l?(o.classList.remove("fn__none"),L("/api/repo/openRepoSnapshotDoc",{id:l},r=>{const d=o.querySelector("textarea"),c=_e().extname(r.data.content).toLowerCase(),f=o.querySelector(".protyle-title__input");p.SIYUAN_ASSETS_IMAGE.concat(p.SIYUAN_ASSETS_AUDIO).concat(p.SIYUAN_ASSETS_VIDEO).includes(c)?(d.previousElementSibling.innerHTML=Ra(r.data.content),d.previousElementSibling.classList.remove("fn__none"),d.classList.add("fn__none"),o.lastElementChild.classList.add("fn__none")):r.data.displayInText?(d.value=r.data.content,d.classList.remove("fn__none"),o.lastElementChild.classList.add("fn__none"),d.previousElementSibling.classList.add("fn__none")):(d.classList.add("fn__none"),o.lastElementChild.classList.remove("fn__none"),d.previousElementSibling.classList.add("fn__none"),Si.protyle.options.history.snapshot=a.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),rt({data:r,protyle:Si.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]})),f.textContent=r.data.title,o.querySelector(".history__date").textContent=G(r.data.updated).format("YYYY-MM-DD HH:mm")})):o.classList.add("fn__none")},Qp=(e,t)=>{if(t.length!==2)return;let n,a;t[0].time>t[1].time?(n=t[1].id,a=t[0].id):(n=t[0].id,a=t[1].id);const s=new ke({title:window.siyuan.languages.compare,content:"",width:P()?"92vw":"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){ja=void 0,Si=void 0}});s.element.setAttribute("data-key",p.DIALOG_HISTORYCOMPARE),s.element.addEventListener("click",i=>{var o;if(typeof i.detail=="string"){nu(e,s.element.querySelector(".history__side .b3-list-item--focus")),i.stopPropagation(),i.preventDefault();return}let l=i.target;for(;l&&l!==s.element;){if(l.classList.contains("b3-list-item")&&!l.dataset.id){l.nextElementSibling.classList.toggle("fn__none"),l.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),i.preventDefault(),i.stopPropagation();break}else if(l.classList.contains("b3-list-item")&&l.dataset.id){if(l.classList.contains("b3-list-item--focus"))return;(o=s.element.querySelector(".history__side .b3-list-item--focus"))==null||o.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus"),nu(e,l),i.preventDefault(),i.stopPropagation();break}else if(l.classList.contains("block__icon")){l.getAttribute("data-direct")==="left"?(l.setAttribute("data-direct","right"),Yo(a,n,s,"right")):(l.setAttribute("data-direct","left"),Yo(n,a,s,"left")),i.preventDefault(),i.stopPropagation();break}l=l.parentElement}}),Yo(n,a,s,"left")},Yo=(e,t,n,a)=>{ja=void 0,Si=void 0;const s=P();L("/api/repo/diffRepoSnapshots",{left:e,right:t},i=>{const o=n.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${s?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${s?"":'<span class="fn__space"></span>'}
    ${G(i.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${s?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${s?"":'<span class="fn__space"></span>'}
    ${G(i.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__side" ${P()?"":`style="width: ${window.siyuan.storage[p.LOCAL_HISTORY].sideDiffWidth}"`}>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${i.data.updatesLeft.length===0?" fn__none":""}">${i.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${Fo(i.data.updatesLeft,i.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${i.data.addsLeft.length===0?" fn__none":""}">${i.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${Fo(i.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${i.data.removesRight.length===0?" fn__none":""}">${i.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${Fo(i.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex" data-type="editors">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${G(i.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${i.data.left.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${i.data.right.title} ${G(i.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="protyle-title__input ft__center ft__breakword">${i.data.right.title}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`,rl(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDiffWidth")})};let Ga;const Ai=(e,t)=>{const n=e.querySelector('[data-type="docprevious"]'),a=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const s=e.querySelector('button[data-type="jumpHistoryPage"]');s.textContent=`${t}`;const i=e.querySelector(".b3-text-field"),o=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector('.b3-select[data-type="typeselect"]'),r=e.querySelector('.b3-select[data-type="notebookselect"]'),d=e.querySelector('.history__text[data-type="docPanel"]'),c=e.querySelector('.history__text[data-type="assetPanel"]'),f=e.querySelector('.history__text[data-type="mdPanel"]'),m=e.querySelector(".b3-list");e.querySelector(".protyle-title__input").classList.add("fn__none"),c.classList.add("fn__none"),f.classList.add("fn__none"),d.classList.add("fn__none"),l.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[p.LOCAL_HISTORY].type!==2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.remove("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.add("fn__none"),o.querySelector('option[value="format"]').classList.add("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.add("fn__none"),o.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[p.LOCAL_HISTORY].type===2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.add("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.remove("fn__none"),o.querySelector('option[value="format"]').classList.remove("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.remove("fn__none"),o.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[p.LOCAL_HISTORY].notebookId=r.value,window.siyuan.storage[p.LOCAL_HISTORY].type=parseInt(l.value),window.siyuan.storage[p.LOCAL_HISTORY].operation=o.value,Te(p.LOCAL_HISTORY,window.siyuan.storage[p.LOCAL_HISTORY]),L("/api/history/searchHistory",{notebook:r.value,query:i.value,page:t,op:o.value,type:parseInt(l.value)},u=>{t<u.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),s.setAttribute("data-totalpage",(u.data.pageCount||1).toString());const g=a.nextElementSibling.nextElementSibling;if(g.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",u.data.pageCount).replace("${y}",u.data.totalCount||1)}`,g.classList.remove("fn__none"),u.data.histories.length===0){m.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let y="";u.data.histories.forEach(b=>{y+=`<li class="b3-list-item" data-type="toggle" data-created="${b}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${G(parseInt(b)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),m.innerHTML=y})},au=(e,t,n)=>{if(e.data.snapshots.length===0){t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getCloudRepoSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoSnapshots"&&(a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let s="";const i=P();e.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${i?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(d=>{l+=`${d.type} ${d.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${i?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${i?" fn__none":""}">
    ${pe(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;s+=`<li class="b3-list-item" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${o.id}" data-tag="${o.tag}">
        ${a}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),t.lastElementChild.innerHTML=`${s}`},Ta=(e,t)=>{const n=e.querySelector(".b3-select");n.disabled=!0;const a=n.value;e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const s=e.querySelector('button[data-type="jumpRepoPage"]');s.textContent=`${t}`;const i=e.querySelector('[data-type="previous"]'),o=e.querySelector('[data-type="next"]'),l=o.nextElementSibling.nextElementSibling;e.setAttribute("data-init","true"),a==="getRepoTagSnapshots"||a==="getCloudRepoTagSnapshots"?(L(`/api/repo/${a}`,{},r=>{au(r,e,a),n.disabled=!1}),i.classList.add("fn__none"),o.classList.add("fn__none"),l.classList.add("fn__none"),s.classList.add("fn__none")):(i.classList.remove("fn__none"),o.classList.remove("fn__none"),s.classList.remove("fn__none"),e.setAttribute("data-page",t.toString()),t>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),L(`/api/repo/${a}`,{page:t},r=>{n.disabled=!1,t<r.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),s.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),l.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,l.classList.remove("fn__none"),au(r,e,a)}))},em=e=>{e.setAttribute("data-init","true"),L("/api/history/getNotebookHistory",{},t=>{if(t.data.histories.length===0){e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";t.data.histories.forEach((a,s)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${s===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${s===0?"":"fn__none"}">`,a.items.forEach(i=>{n+=`<li data-type="notebook" data-path="${i.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${pe(i.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),e.innerHTML=n})},Wo=e=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(i=>{if(i.element.querySelector("#historyContainer"))return i.destroy(),!0}))return;const n=window.siyuan.storage[p.LOCAL_HISTORY];let a=`<option value='%' ${n.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(i=>{i.closed||(a+=` <option value="${i.id}"${i.id===n.notebookId?" selected":""}>${pe(i.name)}</option>`)});const s=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" ${P()?"":'style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0"'}>
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${P()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${P()?"fn__size96":"fn__size200"}">
                        <option value="0" ${n.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${n.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${n.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${P()?" fn__size96":""}">
                        <option value="all" ${n.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${n.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${n.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${n.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${n.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${n.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${n.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${n.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${P()?"fn__size96":"fn__size200"}">
                        ${a}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background history__side" ${P()?"":`style="width: ${n.sideWidth}"`}>
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="history__resize"></div>
                <div class="fn__flex-column fn__flex-1">
                    <div class="protyle-title__input ft__center ft__breakword fn__none"></div>
                    <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                    <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                    <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
                </div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div class="history__action">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${P()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(P())nn({html:s,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(i){i.firstElementChild.setAttribute("style","background-color:var(--b3-theme-background);height:100%"),iu(e,i.firstElementChild)}});else{const i=new ke({content:s,width:"90vw",height:"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){Ga=void 0}});i.element.setAttribute("data-key",p.DIALOG_HISTORY),i.element.querySelector("input").focus(),iu(e,i.element,i),rl(i.element.querySelector(".history__resize"),i.element.querySelector(".history__side"),"sideWidth")}},iu=(e,t,n)=>{const a=t.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(f=>{f.addEventListener("change",()=>{Ai(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",f=>{f.isComposing||Ai(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{Ai(a,1)});const s=a.querySelector('.history__text[data-type="docPanel"]'),i=a.querySelector('.history__text[data-type="assetPanel"]'),o=a.querySelector('.history__text[data-type="mdPanel"]'),l=a.querySelector(".protyle-title__input");Ai(a,1),Ga=new Gn(e,s,{blockId:"",history:{created:""},action:[p.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),En(Ga.protyle);const r=t.querySelector('#historyContainer [data-type="repo"]'),d=t.querySelector('#historyContainer [data-type="doc"]'),c=r.querySelector(".b3-select");c.addEventListener("change",()=>{Ta(r,1);const f=t.querySelector(".b3-button[data-type='compare']");f.setAttribute("disabled","disabled"),f.removeAttribute("data-ids")}),t.addEventListener("click",f=>{var m;let u=f.target;for(;u&&!u.isEqualNode(t);){const g=u.getAttribute("data-type");if(u.classList.contains("item")){u.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(t.querySelector("#historyContainer").children).forEach(y=>{y.getAttribute("data-type")===g?(y.classList.remove("fn__none"),y.classList.add("fn__block"),u.classList.add("item--focus"),y.getAttribute("data-init")!=="true"&&(g==="notebook"?em(y):g==="repo"&&Ta(y,1))):(y.classList.add("fn__none"),y.classList.remove("fn__block"))}),f.stopPropagation(),f.preventDefault();break}else if(u.classList.contains("b3-list-item__action")&&g==="rollback"&&!window.siyuan.config.readonly){const y=u.parentElement.getAttribute("data-type");let b=u.previousElementSibling.previousElementSibling.textContent.trim(),w=G(parseInt(u.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");y==="notebook"?w=u.parentElement.parentElement.previousElementSibling.textContent.trim():y==="repoitem"&&(b=window.siyuan.languages.workspaceData,w=u.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const h=window.siyuan.languages.rollbackConfirm.replace("${name}",b).replace("${time}",w);Ne("\u26A0\uFE0F "+window.siyuan.languages.rollback,h,()=>{y==="assets"?L("/api/history/rollbackAssetsHistory",{historyPath:u.parentElement.getAttribute("data-path")}):y==="doc"?L("/api/history/rollbackDocHistory",{notebook:u.parentElement.getAttribute("data-notebook-id"),historyPath:u.parentElement.getAttribute("data-path")}):y==="notebook"?L("/api/history/rollbackNotebookHistory",{historyPath:u.parentElement.getAttribute("data-path")}):L("/api/repo/checkoutRepo",{id:u.parentElement.getAttribute("data-id")})}),f.stopPropagation(),f.preventDefault();break}else if(g==="more"){u.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(y=>{y.classList.toggle("fn__none")}),f.stopPropagation(),f.preventDefault();break}else if(g==="toggle"){const y=u.firstElementChild.firstElementChild;if(y.classList.contains("b3-list-item__arrow--open"))u.nextElementSibling.classList.add("fn__none"),y.classList.remove("b3-list-item__arrow--open");else if(u.nextElementSibling&&u.nextElementSibling.tagName==="UL")u.nextElementSibling.classList.remove("fn__none"),y.classList.add("b3-list-item__arrow--open");else{const b=a.querySelector(".b3-text-field"),w=a.querySelector('.b3-select[data-type="opselect"]'),h=a.querySelector('.b3-select[data-type="typeselect"]'),S=a.querySelector('.b3-select[data-type="notebookselect"]'),$=u.getAttribute("data-created");L("/api/history/getHistoryItems",{notebook:S.value,query:b.value,op:w.value,type:parseInt(h.value),created:$},D=>{y.classList.add("b3-list-item__arrow--open");let v="",k="";D.data.items.forEach(_=>{let E=" b3-chip b3-chip--list ";_.op==="clean"?(E+="b3-chip--primary ",k=window.siyuan.languages.historyClean):_.op==="update"?(E+="b3-chip--info ",k=window.siyuan.languages.historyUpdate):_.op==="delete"?(E+="b3-chip--error ",k=window.siyuan.languages.historyDelete):_.op==="format"?(E+="b3-chip--pink ",k=window.siyuan.languages.historyFormat):_.op==="sync"?(E+="b3-chip--success ",k=window.siyuan.languages.historySync):_.op==="replace"?(E+="b3-chip--secondary ",k=window.siyuan.languages.historyReplace):_.op==="outline"&&(E+="b3-chip--warning ",k=window.siyuan.languages.historyOutline),v+=`<li data-notebook-id="${_.notebook}" data-created="${$}" data-type="${h.value==="2"?"assets":"doc"}" data-path="${_.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${w.value==="all"?"":"fn__none"}${E}ariaLabel" data-position="6south" aria-label="${k}">${_.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${Ue(_.title)}">${pe(_.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6south" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),u.insertAdjacentHTML("afterend",`<ul>${v}</ul>`)})}f.stopPropagation(),f.preventDefault();break}else if(g==="rmtoggle"){u.nextElementSibling.classList.toggle("fn__none"),u.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),f.stopPropagation(),f.preventDefault();break}else if(u.classList.contains("b3-list-item")&&g==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(c.value)){const y=t.querySelector(".b3-button[data-type='compare']"),b=JSON.parse(y.getAttribute("data-ids")||"[]"),w=u.getAttribute("data-id");if(u.classList.contains("b3-list-item--focus"))u.classList.remove("b3-list-item--focus"),b.forEach((h,S)=>{w===h.id&&b.splice(S,1)});else{for(u.classList.add("b3-list-item--focus");b.length>1;)b[0].id!==w&&((m=u.parentElement.querySelector(`.b3-list-item[data-id="${b.splice(0,1)[0].id}"]`))==null||m.classList.remove("b3-list-item--focus"));b.push({id:w,time:u.querySelector('[data-type="hCreated"]').textContent})}b.length===2?y.removeAttribute("disabled"):y.setAttribute("disabled","disabled"),y.setAttribute("data-ids",JSON.stringify(b)),f.stopPropagation(),f.preventDefault();break}else if(u.classList.contains("b3-list-item")&&(g==="assets"||g==="doc")){const y=u.getAttribute("data-path");if(g==="assets")i.classList.remove("fn__none"),i.innerHTML=Ra(y);else if(g==="doc"){const w=a.querySelector(".b3-text-field").value;L("/api/history/getDocHistoryContent",{historyPath:y,highlight:!na(),k:w},h=>{h.data.isLargeDoc?(o.value=h.data.content,o.classList.remove("fn__none"),s.classList.add("fn__none")):(o.classList.add("fn__none"),s.classList.remove("fn__none"),Ga.protyle.options.history.created=u.dataset.created,rt({data:h,protyle:Ga.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]}),Eo(Ga.protyle,w.split(" ")))})}l.classList.remove("fn__none"),l.textContent=u.querySelector(".b3-list-item__text").textContent;let b=C(u,"b3-list");b&&(b=b.querySelector(".b3-list-item--focus"),b&&b.classList.remove("b3-list-item--focus")),u.classList.add("b3-list-item--focus"),f.stopPropagation(),f.preventDefault();break}else if(g==="genRepo"){const y=new ke({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});y.element.setAttribute("data-key",p.DIALOG_SNAPSHOTMEMO);const b=y.element.querySelector("textarea");b.focus();const w=y.element.querySelectorAll(".b3-button");y.bindInput(b,()=>{w[1].click()}),w[0].addEventListener("click",()=>{y.destroy()}),w[1].addEventListener("click",()=>{L("/api/repo/createSnapshot",{memo:b.value},()=>{Ta(r,1)}),y.destroy()}),f.stopPropagation(),f.preventDefault();break}else if(g==="removeRepoTagSnapshot"||g==="removeCloudRepoTagSnapshot"){const y=u.parentElement.getAttribute("data-tag");Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${y}</i>?`,()=>{L("/api/repo/"+g,{tag:y},()=>{Ta(r,1)})},void 0,!0),f.stopPropagation(),f.preventDefault();break}else if(g==="uploadSnapshot"){L("/api/repo/uploadCloudSnapshot",{tag:u.parentElement.getAttribute("data-tag"),id:u.parentElement.getAttribute("data-id")}),f.stopPropagation(),f.preventDefault();break}else if(g==="downloadSnapshot"){L("/api/repo/downloadCloudSnapshot",{tag:u.parentElement.getAttribute("data-tag"),id:u.parentElement.getAttribute("data-id")}),f.stopPropagation(),f.preventDefault();break}else if(g==="genTag"){const y=new ke({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${G().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:P()?"92vw":"520px"});y.element.setAttribute("data-key",p.DIALOG_SNAPSHOTTAG);const b=y.element.querySelector(".b3-text-field");b.select();const w=y.element.querySelectorAll(".b3-button");w[0].addEventListener("click",()=>{y.destroy()}),w[2].addEventListener("click",()=>{L("/api/repo/tagSnapshot",{id:u.parentElement.getAttribute("data-id"),name:b.value},()=>{L("/api/repo/uploadCloudSnapshot",{tag:b.value,id:u.parentElement.getAttribute("data-id")},()=>{Ta(r,1)})}),y.destroy()}),w[1].addEventListener("click",()=>{L("/api/repo/tagSnapshot",{id:u.parentElement.getAttribute("data-id"),name:b.value},()=>{Ta(r,1)}),y.destroy()}),f.stopPropagation(),f.preventDefault();break}else if((g==="previous"||g==="next")&&u.getAttribute("disabled")!=="disabled"){const y=parseInt(r.getAttribute("data-page"));Ta(r,g==="previous"?y-1:y+1),f.stopPropagation(),f.preventDefault();break}else if(g==="jumpRepoPage"){const y=parseInt(r.getAttribute("data-page")),b=parseInt(u.getAttribute("data-totalpage")||"1");b>1&&Ne(window.siyuan.languages.jumpToPage.replace("${x}",b),`<input class="b3-text-field fn__block" type="number" min="1" max="${b}" value="${y}">`,w=>{const h=w.element.querySelector(".b3-text-field");if(h.value==="")return;let S=parseInt(h.value);S=Math.max(1,Math.min(S,b)),Ta(r,S)})}else if(g==="jumpHistoryPage"){const y=parseInt(d.getAttribute("data-page")),b=parseInt(u.getAttribute("data-totalpage")||"1");b>1&&Ne(window.siyuan.languages.jumpToPage.replace("${x}",b),`<input class="b3-text-field fn__block" type="number" min="1" max="${b}" value="${y}">`,w=>{const h=w.element.querySelector(".b3-text-field");if(h.value==="")return;let S=parseInt(h.value);S=Math.max(1,Math.min(S,b)),Ai(a,S)})}else if((g==="docprevious"||g==="docnext")&&u.getAttribute("disabled")!=="disabled"){const y=parseInt(a.getAttribute("data-page"));Ai(a,g==="docprevious"?y-1:y+1),f.stopPropagation(),f.preventDefault();break}else if(g==="rebuildIndex"){L("/api/history/reindexHistory"),n?n.destroy():(so(),Ga=void 0),f.stopPropagation(),f.preventDefault();break}else if(g==="compare"&&!u.getAttribute("disabled")){Qp(e,JSON.parse(u.getAttribute("data-ids")||"[]")),f.stopPropagation(),f.preventDefault();break}u=u.parentElement}})},Li=e=>{xi(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const t=document.getElementById("empty");t.classList.remove("fn__none"),t.innerHTML===""&&(t.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${Ms()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${_a()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){if(a.id==="emptySearch"){Kt(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){Uo(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){Wo(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){ga({app:e,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){Bo(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){Ro(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},tm=()=>{const e=document.getElementById("toolbarName");xi(e.value),e.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")};var nm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const cy=(e,t,n)=>{fetchPost("/api/block/getDocInfo",{id:e},a=>{t.updateTitle(a.data.name),n&&n.title&&n.title.setTitle(a.data.name)})},Vo=(e,t,n=!0,a=!0,s=!1)=>{n&&tt(),window.siyuan.mobile.popEditor&&(t.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?ae(["dialog"]):la(window.siyuan.mobile.popEditor.protyle,!1,a)),window.siyuan.mobile.editor&&(t.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?Li(e):(la(window.siyuan.mobile.editor.protyle,!1,a),L("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},i=>{xi(i.data.name),window.siyuan.mobile.editor.protyle.title.setTitle(i.data.name)}))),ua(()=>{window.siyuan.mobile.docks.file.init(!1)})},am=e=>{wa().forEach(t=>{t.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"] span[data-type~="block-ref"][data-subtype="d"][data-id="${e.defBlockID}"]`).forEach(n=>{n.innerHTML=e.refText})})},im=e=>{wa().forEach(n=>{if(n.protyle.block.rootID===e.rootID&&n.protyle.title){const a=n.protyle.title.element.querySelector(".protyle-attr"),s=a.querySelector(".protyle-attr--refcount");s?e.rootRefCount===0?s.remove():s.textContent=e.rootRefCount.toString():e.rootRefCount>0&&a.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${e.rootRefCount}</div>`)}e.rootID!==e.blockID&&n.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"]`).forEach(a=>{const s=a.lastElementChild.querySelector(".protyle-attr--refcount");if(s)e.refCount===0?s.remove():s.textContent=e.refCount.toString();else if(e.refCount>0){const i=a.lastElementChild;i.childElementCount>0?i.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>`):i.innerHTML=`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>${p.ZWSP}`}e.refCount===0?a.removeAttribute("refcount"):a.setAttribute("refcount",e.refCount.toString())})});let t;if(t=window.siyuan.mobile.docks.file.element.querySelector(`li[data-node-id="${e.rootID}"]`),t){const n=t.querySelector(".counter");n?e.rootRefCount===0?n.remove():n.textContent=e.rootRefCount.toString():e.rootRefCount>0&&t.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.rootRefCount}</span>`)}},jo=e=>{window.siyuan.config.readonly||(e.plugins.forEach(t=>{t.eventBus.emit("lock-screen")}),L("/api/system/logoutAuth",{},()=>{Ef()}))},su=()=>{if(document.querySelector("#errorLog"))return;let e=`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${p.SIYUAN_VERSION}</small>`,t=`<div>${window.siyuan.languages.kernelFault1}</div><div class="fn__hr"></div><div>${window.siyuan.languages.kernelFault2}</div>`;Rt()&&(e=`\u{1F375} ${window.siyuan.languages.pleaseWait} <small>v${p.SIYUAN_VERSION}</small>`,t=`<div>${window.siyuan.languages.reconnectPrompt}</div><div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const n=new ke({disableClose:!0,title:e,width:P()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    ${t}
</div>
</div>`});n.element.id="errorLog",n.element.setAttribute("data-key",p.DIALOG_KERNELFAULT);const a=n.element.querySelector(".b3-button");a&&a.addEventListener("click",()=>{n.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},sm=()=>{},za=()=>nm(void 0,null,function*(){_r(["util"]),window.siyuan.mobile.editor&&(yield Ei(window.siyuan.mobile.editor.protyle)),L("/api/system/exit",{force:!1},e=>{if(e.code===1){const t=se(e.msg,e.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${t}"] button`);n&&n.addEventListener("click",()=>{L("/api/system/exit",{force:!0},()=>{(Rt()||Je()||ut())&&(window.location.href="siyuan://api/system/exit")})})}else e.code===2?(tt(),window.siyuan.config.system.container==="std"&&ipcRenderer.send(p.SIYUAN_SHOW_WINDOW),Ne(window.siyuan.languages.tip,e.msg,()=>{L("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{L("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(Rt()||Je()||ut())&&(window.location.href="siyuan://api/system/exit")})}),lm=()=>{if(document.getElementById("transactionError"))return;const e=new ke({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${p.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:P()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_STATEEXCEPTED);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{za()}),t[1].addEventListener("click",()=>{lu(),e.destroy()})},lu=e=>{window.siyuan.storage[p.LOCAL_FILEPOSITION]={},Te(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION]),L("/api/system/rebuildDataIndex",{},()=>{e&&e()})};let dl;const om=e=>{const t=document.querySelector("#status");if(t)if(P()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout(dl),t.innerHTML=e.msg,t.style.bottom="0",dl=window.setTimeout(()=>{t.style.bottom=""},12e3)}else{const n=t.querySelector(".status__msg");n&&(clearTimeout(dl),n.innerHTML=e.msg,dl=window.setTimeout(()=>{n.innerHTML=""},12e3))}},Go=e=>{let t=document.getElementById("progress");if(t||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),t=document.getElementById("progress")),e.code===2){t.remove();return}e.code===0?t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${e.data.current}/${e.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div class="ft__breakword">${pe(e.msg)}</div>
</div>`:e.code===1&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=pe(e.msg):t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div class="ft__breakword">${pe(e.msg)}</div>
</div>`)},uy=e=>{const t=document.querySelector(".status__backgroundtask");t&&(e.length===0?(t.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===Constants.MENU_STATUS_BACKGROUND_TASK&&window.siyuan.menus.menu.remove()):(t.classList.remove("fn__none"),t.setAttribute("data-tasks",JSON.stringify(e)),t.innerHTML=e[0].action+"<div><div></div></div>"))},rm=()=>{L("/api/sync/getBootSync",{},e=>{if(e.code===1){const t=new ke({width:P()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});t.element.setAttribute("data-key",p.DIALOG_BOOTSYNCFAILED);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),L("/api/sync/performBootSync",{},a=>{a.code===0&&t.destroy(),n[1].removeAttribute("disabled")}))})}})},xi=e=>{const t=document.getElementById("drag"),n=xf();if(e===window.siyuan.languages.siyuanNote){const a=`${n} - ${window.siyuan.languages.siyuanNote} v${p.SIYUAN_VERSION}`;document.title=a,t&&(t.textContent=a,t.setAttribute("title",a))}else{if(e=e||window.siyuan.languages.untitled,document.title=`${e} - ${n} - ${window.siyuan.languages.siyuanNote} v${p.SIYUAN_VERSION}`,!t)return;t.setAttribute("title",e),t.innerHTML=pe(e)}},fy=e=>{const t=document.querySelector("#configBazaarReadme .item__side");if(!t||e.id!==JSON.parse(t.getAttribute("data-obj")).repoURL)return;const n=t.querySelector('[data-type="install"]');n&&(e.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${e.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${e.percent*100}%"></span>`))},jn=(e,t)=>{const n=document.querySelector("#menuSyncNow use"),a=document.querySelector("#toolbarSync use");if(!e){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&fa("")?(n==null||n.setAttribute("xlink:href","#iconCloudOff"),a.setAttribute("xlink:href","#iconCloudOff")):(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),a.setAttribute("xlink:href","#iconCloudSucc"));return}n==null||n.parentElement.classList.remove("fn__rotate"),a.parentElement.classList.remove("fn__rotate"),e.code===0?(n==null||n.parentElement.classList.add("fn__rotate"),a.parentElement.classList.add("fn__rotate"),n==null||n.setAttribute("xlink:href","#iconRefresh"),a.setAttribute("xlink:href","#iconRefresh")):e.code===2?(n==null||n.setAttribute("xlink:href","#iconCloudError"),a.setAttribute("xlink:href","#iconCloudError")):e.code===1&&(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),a.setAttribute("xlink:href","#iconCloudSucc")),t.forEach(s=>{e.code===0?s.eventBus.emit("sync-start",e):e.code===1?s.eventBus.emit("sync-end",e):e.code===2&&s.eventBus.emit("sync-fail",e)})};var dm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const L=(e,t,n,a)=>{const s={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&(window.siyuan.reqIds[e]=new Date().getTime(),t.type==="local"&&e==="/api/graph/getLocalGraph"||(t.reqId=window.siyuan.reqIds[e])),e==="/api/transactions"&&(t.reqId=new Date().getTime()),t instanceof FormData?s.body=t:s.body=JSON.stringify(t)),a&&(s.headers=a),fetch(e,s).then(i=>{var o;switch(i.status){case 403:case 404:return{data:null,msg:i.statusText,code:-i.status};default:return i.status==401&&setTimeout(()=>{window.location.reload()},3e3),((o=i.headers.get("content-type"))==null?void 0:o.indexOf("application/json"))>-1?i.json():i.text()}}).then(i=>{if(typeof i=="string"){n&&n(i);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph","/api/block/getRecentUpdatedBlocks","/api/search/fullTextSearchBlock"].includes(e)&&i.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>i.data.reqId||(typeof i=="object"&&typeof i.msg=="string"&&typeof i.code=="number"?Nl(i)&&n&&n(i):n&&n(i))}).catch(i=>{if(console.warn("fetch post failed ["+i+"], url ["+e+"]"),e==="/api/transactions"&&(i.message==="Failed to fetch"||i.message==="Unexpected end of JSON input")){su();return}})},he=(e,t)=>dm(void 0,null,function*(){const n={method:"POST"};t&&(t instanceof FormData?n.body=t:n.body=JSON.stringify(t));const s=yield(yield fetch(e,n)).json();return Nl(s),s}),ou=(e,t)=>{fetch(e).then(n=>{var a;return((a=n.headers.get("content-type"))==null?void 0:a.indexOf("application/json"))>-1?n.json():n.text()}).then(n=>{t(n)})},In=(e,t)=>e?`<span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(e)}</span>`:t?`<span class="b3-list-item__meta">${t}</span>`:"",zo=(e,t)=>{const n=[{filter:[window.siyuan.languages.template,"template","\u6A21\u677F","moban","muban","mb"],id:"template",value:p.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:[window.siyuan.languages.widget,"widget","\u6302\u4EF6","guajian","gj"],id:"widget",value:p.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:[window.siyuan.languages.assets,"assets","\u8D44\u6E90","ziyuan","zy"],id:"assets",value:p.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:[window.siyuan.languages.ref,"block reference","\u5757\u5F15\u7528","kuaiyinyong","kyy"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:[window.siyuan.languages.blockEmbed,"embed block","\u5D4C\u5165\u5757","qianrukuai","qrk"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:[window.siyuan.languages.aiWriting,"ai writing","ai\u7F16\u5199","aibianxie","aibx","\u4EBA\u5DE5\u667A\u80FD","rengongzhineng","rgzn"],id:"aiWriting",value:p.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span>${In(window.siyuan.config.keymap.editor.general.aiWriting.custom,"")}</div>`},{filter:[window.siyuan.languages.database,"database","db","\u6570\u636E\u5E93","shujuku","sjk","\u89C6\u56FE","view"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:[window.siyuan.languages.newFileRef,"create new doc with reference","\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy"],id:"newFileRef",value:p.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:[window.siyuan.languages.newSubDocRef,"create sub doc with reference","\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy"],id:"newSubDocRef",value:p.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:[window.siyuan.languages.heading1,"heading1","h1","\u4E00\u7EA7\u6807\u9898","yijibiaoti","yjbt"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${In(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:[window.siyuan.languages.heading2,"heading2","h2","\u4E8C\u7EA7\u6807\u9898","erjibiaoti","ejbt"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${In(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:[window.siyuan.languages.heading3,"heading3","h3","\u4E09\u7EA7\u6807\u9898","sanjibiaoti","sjbt"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${In(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:[window.siyuan.languages.heading4,"heading4","h4","\u56DB\u7EA7\u6807\u9898","sijibiaoti","sjbt"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${In(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:[window.siyuan.languages.heading5,"heading5","h5","\u4E94\u7EA7\u6807\u9898","wujibiaoti","wjbt"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${In(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:[window.siyuan.languages.heading6,"heading6","h6","\u516D\u7EA7\u6807\u9898","liujibiaoti","ljbt"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${In(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:[window.siyuan.languages.list,"unordered list","\u65E0\u5E8F\u5217\u8868","wuxvliebiao","wuxuliebiao","wxlb"],id:"list",value:"- "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${In(window.siyuan.config.keymap.editor.insert.list.custom,"- ")}</div>`},{filter:[window.siyuan.languages["ordered-list"],"order list","ordered list","\u6709\u5E8F\u5217\u8868","youxvliebiao","youxuliebiao","yxlb"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${In(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:[window.siyuan.languages.check,"task list","todo list","\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb"],id:"check",value:"- [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${In(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:[window.siyuan.languages.quote,"blockquote","bq","\u5F15\u8FF0","yinshu","ys"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${In(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:[window.siyuan.languages.code,"code block","\u4EE3\u7801\u5757","daimakuai","dmk"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${In(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:[window.siyuan.languages.table,"table","\u8868\u683C","biaoge","bg"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:[window.siyuan.languages.line,"thematic break","divider","\u5206\u9694\u7EBF","\u5206\u5272\u7EBF","fengexian","fgx"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:[window.siyuan.languages.math,"formulas block","math block","\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:[window.siyuan.languages.emoji,"emoji","\u8868\u60C5","biaoqing","bq"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:[window.siyuan.languages.link,"link","a","\u94FE\u63A5","lianjie","lj"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:[window.siyuan.languages.bold,"bold","strong","\u7C97\u4F53","cuti","ct","\u52A0\u7C97","jiacu","jc"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:[window.siyuan.languages.italic,"italic","em","\u659C\u4F53","xieti","xt"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:[window.siyuan.languages.underline,"underline","\u4E0B\u5212\u7EBF","xiahuaxian","xhx"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:[window.siyuan.languages.strike,"strike","delete","\u5220\u9664\u7EBF","shanchuxian","scx"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:[window.siyuan.languages.mark,"mark","\u6807\u8BB0","biaoji","bj","\u9AD8\u4EAE","gaoliang","gl"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:[window.siyuan.languages.sup,"superscript","\u4E0A\u6807","shangbiao","sb"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:[window.siyuan.languages.sub,"subscript","\u4E0B\u6807","xiaobiao","xb"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-code"],"inline code","\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:[window.siyuan.languages.kbd,"kbd","\u952E\u76D8","jianpan","jp"],id:"kbd",value:"kbd",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.kbd}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.kbd.custom)}</span></div>`},{filter:[window.siyuan.languages.tag,"tags","\u6807\u7B7E","biaoqian","bq"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:[window.siyuan.languages["inline-math"],"inline formulas","inline math","\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxvegongshi","hangjishuxuegongshi","hjsxgs"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator b3-menu__accelerator--hotkey">${je(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:[window.siyuan.languages.insertAsset,"insert image or file","upload","\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","charutupianhuowenjian","crtphwj","\u4E0A\u4F20","sc"],id:"insertAsset",value:p.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:[window.siyuan.languages.insertIframeURL,"insert iframe link","\u63D2\u5165 iframe \u94FE\u63A5","charuiframelianjie","criframelj"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:[window.siyuan.languages.insertImgURL,"insert image link","image","img","\u63D2\u5165\u56FE\u7247\u94FE\u63A5","charutupianlianjie","crtplj"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:[window.siyuan.languages.insertVideoURL,"insert video link","\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:[window.siyuan.languages.insertAudioURL,"insert audio link","\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:[window.siyuan.languages.staff,"staff","\u4E94\u7EBF\u8C31","wuxianpu","wxp"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:[window.siyuan.languages.chart,"chart","\u56FE\u8868","tubiao","tb"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["flowchart","flow chart","\u6D41\u7A0B\u56FE","liuchengtu","lct"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["graphviz","\u72B6\u6001\u56FE","zhuangtaitu","ztt"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["mermaid","diagram","\u56FE\u8868","tubiao","tb"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:[window.siyuan.languages.mindmap,"mindmap","\u8111\u56FE","naotu","nt"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["plantuml","\u5EFA\u6A21\u8BED\u8A00","jianmoyuyan","jmyy"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:[window.siyuan.languages.infoStyle,"info style","\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys"],id:"infoStyle",value:`style${p.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:[window.siyuan.languages.successStyle,"success style","\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys"],id:"successStyle",value:`style${p.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:[window.siyuan.languages.warningStyle,"warning style","\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys"],id:"warningStyle",value:`style${p.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:[window.siyuan.languages.errorStyle,"error style","\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys"],id:"errorStyle",value:`style${p.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:[window.siyuan.languages.clearFontStyle,"clear style","\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys"],id:"clearFontStyle",value:`style${p.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square color__square--list">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let a=!1;return t.app.plugins.forEach(s=>{s.protyleSlash.forEach(i=>{n.push({filter:i.filter,id:i.id,value:`plugin${p.ZWSP}${s.name}${p.ZWSP}${i.id}`,html:i.html}),a=!0})}),a||n.pop(),e===""?n:n.filter(s=>s.filter?!!s.filter.find(o=>{if(o.toLowerCase().indexOf(e.toLowerCase())>-1)return!0}):!1)},cm=(e,t)=>(t.hint.genLoading(t),L("/api/search/searchTag",{k:e},n=>{const a=[];let s=!1;n.data.tags.forEach(i=>{const o=i.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`<span data-type="tag">${o}</span>`,html:`<div class="b3-list-item__text">${i}</div>`}),o===n.data.k&&(s=!0)}),n.data.k&&!s&&(a.splice(0,0,{value:`<span data-type="tag">${n.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.newTag} <mark>${pe(n.data.k)}</mark></div>`}),a.length>1&&(a[1].focus=!0)),t.hint.genHTML(a,t,!0,"hint")}),[]),Ko=e=>{let t;e.type==="NodeDocument"&&e.ial.icon?(t=ge(e.ial.icon,"b3-list-item__graphic popover__block",!0),t=t.replace('popover__block"',`popover__block" data-id="${e.id}"`)):t=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${Ln(e.type)}"></use></svg>`;let n="";e.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${e.name}</span></span><span class="fn__space"></span>`),e.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${e.alias}</span></span><span class="fn__space"></span>`),e.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${e.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`);let a="";return e.refCount&&(a=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${e.refCount}</span>`),`${n}<div class="b3-list-item__first" data-node-id="${e.id}">
    ${t}
    <span class="b3-list-item__text">${e.content}</span>${a}
</div>
<div class="b3-list-item__meta b3-list-item__showall">${e.hPath}</div>`},Ia=(e,t,n)=>{const a=F(ye(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),L("/api/search/searchRefBlock",{k:e,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:n==="av"?"":t.block.rootID,isDatabase:n==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(t.hint.splitChar)},s=>{const i=[];if(s.data.newDoc){const o=Lute.UnEscapeHTMLStr(gn(s.data.k));i.push({value:`((newFile "${o}"${p.ZWSP}'${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div>`})}s.data.blocks.forEach(o=>{let l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText.replace(new RegExp(p.ZWSP,"g"),"")}</span>`;if(n==="search")l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${e}${p.ZWSP}${o.name||o.refText.replace(new RegExp(p.ZWSP,"g"),"")}</span>`;else if(n==="av"){let r=o.name||o.refText.replace(new RegExp(p.ZWSP,"g"),"");a&&(r=o.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||r),l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${r}</span>`}i.push({value:l,html:Ko(o)})}),n==="search"&&(t.hint.splitChar="((",t.hint.lastIndex=-1),i.length===0?i.push({value:"",html:window.siyuan.languages.emptyContent}):s.data.newDoc&&i.length>1&&(i[1].focus=!0),t.hint.genHTML(i,t,!0,n)}),[]},Ci=(e,t)=>{if(e.endsWith("}}")||e.endsWith("\u300D\u300D"))return[];t.hint.genLoading(t);const n=F(ye(t.wysiwyg.element).startContainer);return L("/api/search/searchRefBlock",{k:e,isDatabase:!1,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},a=>{const s=[];a.data.blocks.forEach(i=>{s.push({value:`{{select * from blocks where id='${i.id}'}}`,html:Ko(i)})}),s.length===0&&s.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(s,t,!0,"hint")}),[]},ru=(e,t,n)=>{L("/api/template/render",{id:t.block.parentID,path:e},a=>{X(t.toolbar.range);const s=oe(n);s&&s.textContent.trim()===""?lt(a.data.content,t,!0):lt(a.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(i=>{i.remove()}),xe(t,t.wysiwyg.element),Xe(t.wysiwyg.element),Re(t.wysiwyg.element),ot(t.wysiwyg.element,t),ae(["util"],t)})},du=(e,t)=>{X(t.toolbar.range),lt(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),ae(["util"],t)},cu=(e,t)=>{X(t.toolbar.range);const n=_e().extname(e).toLowerCase(),a=e.startsWith("assets/")?ql(e):e;lt(Wd(n,e,a,e.startsWith("assets/")?a+n:e),t),ae(["util"],t)},Zo=(e,t,n)=>{if(e==="/")return;const a=vt(e,!0,!0);if(n.block.rootID===a)return;const s=[];let i;const o=t[0].parentElement;let l;if(t.forEach((r,d)=>{d===t.length-1&&r.parentElement&&(i=Ve(r),l=i.nextElementSibling||i.previousElementSibling,i===r&&(i=void 0)),s.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),i)s.push({action:"delete",id:i.getAttribute("data-node-id")}),i.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)Qe(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||s.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{Bt({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},p.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!C(o,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),d=yn(!1,!1,r);s.splice(0,0,{action:"insert",id:r,data:d.outerHTML,parentID:n.block.parentID}),o.innerHTML=d.outerHTML,te(d)}else l&&te(l);B(n,s)},cl=(e,t,n)=>{t&&(ct(oe(n[n.length-1]),e.toolbar.range),e.toolbar.range.collapse(!0),lt(e.lute.SpinBlockDOM(t),e,!0,!0),xe(e,e.wysiwyg.element),Xe(e.wysiwyg.element),Re(e.wysiwyg.element))},um=(e,t)=>{const n=new ke({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--remove">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});n.element.setAttribute("data-key",p.DIALOG_AIUPDATECUSTOMACTION);const a=n.element.querySelector("input");a.value=e;const s=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(s,()=>{i[2].click()}),s.value=t,i[1].addEventListener("click",()=>{n.destroy()}),i[2].addEventListener("click",()=>{window.siyuan.storage[p.LOCAL_AI].find(o=>{if(e===o.name&&t===o.memo)return o.name=a.value,o.memo=s.value,Te(p.LOCAL_AI,window.siyuan.storage[p.LOCAL_AI]),!0}),n.destroy()}),i[0].addEventListener("click",()=>{window.siyuan.storage[p.LOCAL_AI].find((o,l)=>{if(e===o.name&&t===o.memo)return window.siyuan.storage[p.LOCAL_AI].splice(l,1),Te(p.LOCAL_AI,window.siyuan.storage[p.LOCAL_AI]),!0}),n.destroy()}),a.focus()},uu=(e,t,n)=>{const a=new ke({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:P()?"92vw":"520px"});a.element.setAttribute("data-key",p.DIALOG_AICUSTOMACTION);const s=a.element.querySelector("input"),i=a.element.querySelector("textarea"),o=a.element.querySelectorAll(".b3-button");a.bindInput(i,()=>{o[1].click()}),o[0].addEventListener("click",()=>{a.destroy()}),o[1].addEventListener("click",()=>{if(!i.value){se(window.siyuan.languages._kernel[142]);return}L("/api/ai/chatGPTWithAction",{ids:t,action:i.value},l=>{a.destroy(),cl(e,l.data,n)})}),o[2].addEventListener("click",()=>{if(!s.value&&!i.value){se(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[p.LOCAL_AI].push({name:s.value,memo:i.value}),Te(p.LOCAL_AI,window.siyuan.storage[p.LOCAL_AI]),a.destroy()}),s.focus()},fu=(e,t)=>{e.querySelectorAll(".b3-list-item").forEach(n=>{n.textContent.indexOf(t.value)>-1?n.classList.remove("fn__none"):n.classList.add("fn__none")}),e.querySelectorAll(".b3-menu__separator").forEach(n=>{t.value?n.classList.add("fn__none"):n.classList.remove("fn__none")}),e.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),e.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},Xo=(e,t)=>{window.siyuan.menus.menu.remove();const n=[];e.forEach(o=>{n.push(o.getAttribute("data-node-id"))});const a=new Fe(p.MENU_AI,()=>{X(t.toolbar.range)});let s="";window.siyuan.storage[p.LOCAL_AI].forEach((o,l)=>{s+=`<div data-action="${Ue(o.memo||o.name)}" data-index="${l}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${Wt(o.memo)}">
    <span class="b3-list-item__text">${pe(o.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),s&&(s=`<div class="b3-menu__separator"></div>${s}`);const i="Clear context";a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${i}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${s}
    </div>
</div>`,bind(o){o.setAttribute("style","height: 100%;padding: 0 16px;"),o.querySelectorAll(".b3-menu__separator").forEach(d=>{d.remove()});const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;if(Vt(l,d)&&d.stopPropagation(),d.key==="Enter"){d.preventDefault(),d.stopPropagation();const f=l.querySelector(".b3-list-item--focus");f.dataset.type==="custom"?(uu(t,n,e),a.close()):(L("/api/ai/chatGPTWithAction",{ids:n,action:f.dataset.action},m=>{cl(t,m.data,e)}),f.dataset.action===i?se(window.siyuan.languages.clearContextSucc):a.close())}}),r.addEventListener("compositionend",()=>{fu(o,r)}),r.addEventListener("input",d=>{d.isComposing||fu(o,r)}),o.addEventListener("click",d=>{let c=d.target;for(;c&&c!==o;){if(c.classList.contains("b3-list-item__action")){const f=window.siyuan.storage[p.LOCAL_AI][c.parentElement.dataset.index];um(f.name,f.memo),a.close(),d.stopPropagation(),d.preventDefault();break}else if(c.classList.contains("b3-list-item")){c.dataset.type==="custom"?(uu(t,n,e),a.close()):(L("/api/ai/chatGPTWithAction",{ids:n,action:c.dataset.action},f=>{cl(t,f.data,e)}),c.dataset.action===i?se(window.siyuan.languages.clearContextSucc):a.close()),d.stopPropagation(),d.preventDefault();break}c=c.parentElement}})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial"),a.fullscreen()},gu=(e,t)=>{const n=new ke({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"}),a=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{s[1].click()}),a.focus(),s[0].addEventListener("click",()=>{n.destroy()}),s[1].addEventListener("click",()=>{let i=a.value;L("/api/ai/chatGPT",{msg:i},o=>{n.destroy();let l="";o.data&&o.data!==""&&(l=`

`+o.data),i==="Clear context"&&(i=""),cl(e,`${i}${l}`,[t])})})};class fm{constructor(t){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var a;const s=n.target;if(s.tagName==="INPUT"){n.stopPropagation();return}const i=U(s,"BUTTON");if(i&&!i.classList.contains("emojis__item")&&!i.classList.contains("emojis__type")){this.fill(decodeURIComponent(i.getAttribute("data-value")),t,!1,this.source==="search"?Ze(n):Lt(n)),n.preventDefault(),n.stopPropagation();return}const o=this.element.querySelector(".emojis__panel"),l=C(s,"emojis__type");if(l){const d=o.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(d){const c=d.nextElementSibling.getAttribute("data-index");if(c){let f="";window.siyuan.emojis[parseInt(c)].items.forEach(m=>{f+=`<button data-unicode="${m.unicode}" class="emojis__item ariaLabel" aria-label="${Oa(m)}">
${ge(m.unicode)}</button>`}),d.nextElementSibling.innerHTML=f,d.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:d.offsetTop})}return}const r=C(s,"emojis__item");if(r){const d=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3?(a=c.endContainer.childNodes[c.endOffset-1])==null||a.remove():c.endContainer.textContent===":"&&(c.endContainer.textContent=""),Na(d);let f;d.indexOf(".")>-1?f=`:${d.split(".")[0]}: `:f=ge(d)+" ",lt(t.lute.SpinBlockDOM(f),t,!1,!0),this.element.classList.add("fn__none")}else this.fill(d,t)}})}render(t){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(t.toolbar.range=getSelection().getRangeAt(0),t.toolbar.range.startContainer.nodeType===3&&t.toolbar.range.startContainer.textContent===""){const i=st(t.toolbar.range.startContainer);if(i&&i.nodeType===3){if(i.wholeText!==i.textContent){let o=i.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{i.textContent=o.textContent+i.textContent,o.remove();break}}t.toolbar.range.setStart(i,i.textContent.length),t.toolbar.range.collapse(!0)}}const n=et(t.toolbar.range.startContainer,t.wysiwyg.element).start,a=t.toolbar.range.startContainer.textContent.substring(0,n)||"",s=this.getKey(a,t.options.hint.extend);if(typeof s=="undefined"||O(t.toolbar.range.startContainer,"data-type","code")||O(t.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const i=F(t.toolbar.range.startContainer);if(i&&i.getAttribute("data-type")==="NodeHeading"){const o=et(t.toolbar.range.startContainer,i).start;if(i.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),s?this.genEmojiHTML(t,s):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!P()&&this.genHTML(zo(s,t),t,!1,"hint");return}t.options.hint.extend.forEach(i=>{i.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(i.hint(s,t,"hint"),t,!1,"hint")},t.options.hint.delay))})}genLoading(t){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=Pn(t.wysiwyg.element);Ee(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(t,n){n.querySelectorAll('input[type="file"]').forEach(a=>{a.addEventListener("change",s=>{if(s.target.files.length===0)return;const i=ye(t.wysiwyg.element);this.lastIndex>-1&&i.setStart(i.startContainer,this.lastIndex),i.deleteContents(),aa(t,s.target.files,s.target),ae(["hint","toolbar"],t)})})}getHTMLByData(t){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),t.forEach((a,s)=>{let i="";(s===1&&t[s].focus||s===0&&(t.length===1||!t[1].focus))&&(i=" b3-list-item--focus"),a.html==="separator"?n+=`<button data-id="${a.id||""}" class="b3-menu__separator"></button>`:n+=`<button data-id="${a.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${i}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(t,n,a=!1,s){var i;if(this.source=s,t.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(t),this.element.classList.remove("fn__none"),t[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.source==="av"){const l=C(n.toolbar.range.startContainer,"av__cell");if(l){const r=l.getBoundingClientRect();Ee(this.element,0,0)}}else{const l=Pn(n.wysiwyg.element);Ee(this.element,0,0)}this.element.scrollTop=0;let o=this.element.querySelector(".b3-list-item--focus");for(;ii(o,"b3-list-item");)o.classList.remove("b3-list-item--focus"),o=o.nextElementSibling,o==null||o.classList.add("b3-list-item--focus");if(this.bindUploadEvent(n,this.element),this.source!=="hint"){const l=this.element.querySelector("input.b3-text-field"),r=((i=this.element.querySelector("mark"))==null?void 0:i.textContent)||"";l.value=r,l.select(),l.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(Vt(this.element.lastElementChild,c),c.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!1,Ze(c)),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),X(n.toolbar.range)))});const d=n.toolbar.range?F(n.toolbar.range.startContainer):!1;l.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(n,l,d,r,s))}),l.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(n,l,d,r,s)})}}genSearchHTML(t,n,a,s,i){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',L("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:i==="av"?"":t.block.rootID,isDatabase:i==="av"},o=>{let l="";if(o.data.newDoc){const r=`((newFile "${s}"${p.ZWSP}'${o.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${o.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${o.data.k}</mark></span></div></button>`}o.data.blocks.forEach((r,d)=>{let c;if(i==="av"){let f=r.name||r.refText.replace(new RegExp(p.ZWSP,"g"),"");a&&(f=r.ial["custom-sy-av-s-text-"+a.getAttribute("data-av-id")]||f),c=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${f}</span>`}else c=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${s}</span>`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${d===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${Ko(r)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l,Ee(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(t,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=Ui(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),Bi(a)):(this.element.innerHTML=`<div style="padding:0;max-height:min(402px,40vh);width:366px" class="emojis">
<div class="emojis__panel">${Ui(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",Dt(0)],["1f60d",Dt(1)],["1f433",Dt(2)],["1f96a",Dt(3)],["1f3a8",Dt(4)],["1f3dd-fe0f",Dt(5)],["1f52e",Dt(6)],["267e-fe0f",Dt(7)],["1f6a9",Dt(8)]].map(([i,o],l)=>`<button data-type="${l}" class="emojis__type ariaLabel" aria-label="${o}">${ge(i)}</button>`).join("")}
</div>
</div>`,Ts(this.element),Bi(this.element));const s=this.element.querySelector(".emojis__item");if(s){s.classList.add("emojis__item--current"),this.element.classList.remove("fn__none");const i=Pn(t.wysiwyg.element);Ee(this.element,i.left,i.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(t,n,a=!0,s=!1){var i;ae(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=ye(n.wysiwyg.element));const o=n.toolbar.range;let l=F(n.toolbar.range.startContainer);if(!l)return;if(this.source==="av"){let f=C(n.toolbar.range.startContainer,"av__cell");if(f||(f=l.querySelector(".av__cell--select")),!f)return;const m=C(f,l.getAttribute("data-av-type")==="table"?"av__row":"av__gallery-item");if(!m)return;const u=m.dataset.id,g=l.getAttribute("data-av-id");let y=document.createElement("div");if(y.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),y=y.firstElementChild,t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const b=t.substring(11,t.length-4).split(`"${p.ZWSP}'`),w=b.length===1?b[0]:b[1],h=Lute.NewNodeID();m.dataset.id=h,uo(n.path,n.notebookId,(S,$)=>{L("/api/filetree/createDocWithMd",{notebook:$,path:_e().join(S,w),parentID:n.notebookId===$?n.block.rootID:"",markdown:"",id:h},()=>{B(n,[{action:"replaceAttrViewBlock",avID:g,previousID:u,nextID:h,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:h,nextID:u,isDetached:!0}])})}),Gt(f,{type:"block",isDetached:!1,block:{content:w,id:h}})}else{const b=y.getAttribute("data-id");m.dataset.id=b,B(n,[{action:"replaceAttrViewBlock",avID:g,previousID:u,nextID:b,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:b,nextID:u,isDetached:!0}]),Gt(f,{type:"block",isDetached:!1,block:{content:y.textContent,id:b}})}return}this.enableExtend=!1;let r="";l&&(r=l.getAttribute("data-node-id"));const d=l.outerHTML,c=p.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(p.BLOCK_HINT_KEYS.includes(this.splitChar)&&c&&o.startContainer.nodeType===3&&o.startContainer.wholeText.indexOf(c)>-1&&o.startContainer.wholeText.indexOf(this.splitChar)>-1){let f=0,m=o.startContainer;for(;m&&f<2;){const u=m.textContent.indexOf(c),g=m.textContent.indexOf(this.splitChar);if(u>-1&&(u<g||g<0)){f=2,o.setEnd(m,u+2);break}const y=m.textContent.indexOf(c.substr(1));if(y>-1&&(f+=1),f===2){o.setEnd(m,y+1);break}m=m.nextSibling}}if(this.lastIndex>-1&&(o.setStart(o.startContainer,this.lastIndex),X(o)),p.BLOCK_HINT_KEYS.includes(this.splitChar)&&t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const f=t.substring(11,t.length-4).split(`"${p.ZWSP}'`),m=f.length===1?f[0]:f[1];uo(n.path,n.notebookId,(u,g)=>{L("/api/filetree/createDocWithMd",{notebook:g,path:_e().join(u,m),parentID:n.notebookId===g?n.block.rootID:"",markdown:""},y=>{n.toolbar.range=o;const b=n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${y.data}${p.ZWSP}${s?"s":"d"}${p.ZWSP}${(s?f[0]:m).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`});b[0]&&n.toolbar.range.setEnd(b[0].lastChild,b[0].lastChild.textContent.length),n.toolbar.range.collapse(!1)})});return}if(p.BLOCK_HINT_KEYS.includes(this.splitChar)){if(t===""){const u=oe(l);u.textContent===""&&(u.innerHTML="<wbr>",fe(u,o));return}let f=document.createElement("div");if(f.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),f=f.firstElementChild,s){const u=o.toString().replace(this.splitChar,"");u&&(f.setAttribute("data-subtype","s"),f.innerText=u)}else{f.setAttribute("data-subtype","d");const u=f.innerText.split(p.ZWSP);u.length===2&&(f.innerText=u[1])}const m=n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${f.getAttribute("data-id")}${p.ZWSP}${f.getAttribute("data-subtype")}${p.ZWSP}${f.textContent}`});m[0]&&n.toolbar.range.setEnd(m[0].lastChild,m[0].lastChild.textContent.length),n.toolbar.range.collapse(!1);return}else if(this.splitChar===":"){Na(t);let f;t.indexOf(".")>-1?f=`:${t.split(".")[0]}: `:f=ge(t)+" ",lt(n.lute.SpinBlockDOM(f),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(t===""){const f=oe(l);f.textContent===""&&(f.innerHTML="<wbr>",fe(f,o));return}lt(n.lute.SpinBlockDOM(t),n,!1,P()),xe(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,t==="(("||t==="{{"){t==="(("?Ia("",n,"hint"):Ci("",n),this.splitChar=t,this.lastIndex=0,o.deleteContents();const f=document.createTextNode(t);o.insertNode(f),o.setEnd(f,t.length),o.collapse(!1),X(o);return}else if(t===p.ZWSP){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showTpl(n,l,o),Q(n,r,l.outerHTML,d);return}else if(t===p.ZWSP+1){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showWidget(n,l,o),Q(n,r,l.outerHTML,d);return}else if(t===p.ZWSP+2){o.deleteContents(),this.fixImageCursor(o),n.toolbar.range=o;const f=Pn(l,o);mo(n,{x:f.left,y:f.top+26,w:0,h:26}),Q(n,r,l.outerHTML,d);return}else if(t===p.ZWSP+3){o.deleteContents();return}else if(t===p.ZWSP+4){ga({app:n.app,notebookId:n.notebookId,useSavePath:!0,currentPath:n.path,afterCB:(f,m)=>{lt(`<span data-type="block-ref" data-id="${f}" data-subtype="d">${m}</span>`,n)}});return}else if(t===p.ZWSP+6){const f=Lute.NewNodeID();L("/api/filetree/createDoc",{notebook:n.notebookId,path:_e().join(vt(n.path,!1,!0),f+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{lt(`<span data-type="block-ref" data-id="${f}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,n),ft(n.app,f,[p.CB_GET_CONTEXT,p.CB_GET_OPENNEW])});return}else if(t===p.ZWSP+5){o.deleteContents(),gu(n,l);return}else if(p.INLINE_TYPE.includes(t)){if(o.deleteContents(),X(o),["a","block-ref","inline-math","inline-memo","text"].includes(t)){n.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,t,"range");return}else if(t==="emoji"){o.deleteContents(),o.insertNode(document.createTextNode(":")),o.collapse(!1),X(o),this.genEmojiHTML(n);return}else if(t.startsWith("style")){o.deleteContents(),this.fixImageCursor(o),l.setAttribute("style",t.split(p.ZWSP)[1]||""),Q(n,r,l.outerHTML,d);return}else if(t.startsWith("plugin")){n.app.plugins.find(f=>{const m=t.split(p.ZWSP);if(m[1]===f.name)return f.protyleSlash.find(u=>{if(u.id===m[2])return u.callback(n.getInstance(),l),!0}),!0});return}else{o.deleteContents(),t!=="![]()"&&this.fixImageCursor(o);let f=t;t==="```"&&(f=t+(p.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[p.LOCAL_CODELANG])?"":window.siyuan.storage[p.LOCAL_CODELANG])+Lute.Caret+"\n```");const m=oe(l);if(t==="![]()"){let u="";o.insertNode(document.createElement("wbr")),o.insertNode(document.createTextNode(t)),u=n.lute.SpinBlockDOM(l.outerHTML),l.outerHTML=u,l=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),fe(l,o),Q(n,r,l.outerHTML,d);let g=o.startContainer.childNodes[o.startOffset-1]||o.startContainer;g&&g.nodeType!==3&&g.classList.contains("img")||(((i=g.previousSibling)==null?void 0:i.nodeType)!==3&&g.previousSibling.classList.contains("img")?g=g.previousSibling:Array.from(l.querySelectorAll(".img")).find(b=>{if(b.querySelector("img").getAttribute("data-src")==="")return g=b,!0}));const y=g.getBoundingClientRect();_o(n,o,g,{clientX:y.left,clientY:y.top});return}else if(m.textContent===""&&l.getAttribute("data-type")==="NodeParagraph"){let u="";t==="<div>"?u=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${da()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(m.textContent=f,u=n.lute.SpinBlockDOM(l.outerHTML)),l.outerHTML=u,l=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),l.getAttribute("data-type")==="NodeTable"&&(l.querySelectorAll("colgroup col").forEach(g=>{g.style.minWidth="60px"}),u=l.outerHTML),Q(n,r,u,d)}else{let u=n.lute.SpinBlockDOM(f);t==="<div>"&&(u=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${da()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`);const g=l.outerHTML;let y;l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&(y=at(n,l,!0,!1,!1,!0)),l.insertAdjacentHTML("afterend",u);const b=u.substr(u.indexOf('data-node-id="')+14,22);l=n.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),l.getAttribute("data-type")==="NodeTable"&&l.querySelectorAll("colgroup col").forEach(S=>{S.style.minWidth="60px"});const w=[{data:g,id:r,action:"update"},{data:l.outerHTML,id:b,previousID:r,action:"insert"}],h=[{id:b,action:"delete"},{data:d,id:r,action:"update"}];y&&(w.push(...y.doOperations),h.push(...y.undoOperations)),B(n,w,h)}if(t==="<div>"||t==="$$"||t.indexOf("```")>-1&&(t.length>3||l.classList.contains("render-node")))n.toolbar.showRender(n,l),Xe(l);else if(t.startsWith("```"))Re(l);else if(t.startsWith("<iframe")||t.startsWith("<video")||t.startsWith("<audio")){n.gutter.renderMenu(n,l);const u=l.getBoundingClientRect();window.siyuan.menus.menu.popup({x:u.left,y:u.top,isLeft:!0});const g=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');g.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(g.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else t==="---"?te(l):l.classList.contains("av")?ot(l,n,()=>{const u=l.querySelector(".av__title");u.focus(),o.setStart(u,0),o.collapse(!0),X(o)}):fe(l,o)}}select(t,n){var a,s,i,o,l;const r=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!r)return!1;if(t.key==="Enter"){if(r){const d=this.element.querySelector(".emojis__item--current");if(!d)return!1;const c=d.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const f=getSelection().getRangeAt(0);f.endContainer.nodeType!==3&&((a=f.endContainer.childNodes[f.endOffset-1])==null||a.remove()),Na(c);let m;c.indexOf(".")>-1?m=`:${c.split(".")[0]}: `:m=ge(c)+" ",lt(n.lute.SpinBlockDOM(m),n),this.element.classList.add("fn__none")}else this.fill(c,n)}else{const d=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));d===p.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(d,n,!0,Lt(t))}return t.preventDefault(),t.stopPropagation(),!0}if(r){const d=this.element.querySelector(".emojis__item--current");if(!d)return!1;let c;if(t.key==="ArrowLeft")d.previousElementSibling?(d.classList.remove("emojis__item--current"),c=d.previousElementSibling):(s=d.parentElement.previousElementSibling)!=null&&s.previousElementSibling&&(d.classList.remove("emojis__item--current"),c=d.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(t.key==="ArrowRight")d.nextElementSibling?(d.classList.remove("emojis__item--current"),c=d.nextElementSibling):(i=d.parentElement.nextElementSibling)!=null&&i.nextElementSibling&&(d.classList.remove("emojis__item--current"),c=d.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(t.key==="ArrowDown"){if(d.nextElementSibling){d.classList.remove("emojis__item--current");let f=Math.floor(d.parentElement.clientWidth/(d.clientWidth+2));for(c=d;c.nextElementSibling&&f>0;)c=c.nextElementSibling,f--}else{const f=(o=d.parentElement.nextElementSibling)==null?void 0:o.nextElementSibling;f&&(c=f.firstElementChild,d.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}else if(t.key==="ArrowUp"){if(d.previousElementSibling){d.classList.remove("emojis__item--current");let f=Math.floor(d.parentElement.clientWidth/(d.clientWidth+2));for(c=d;c.previousElementSibling&&f>0;)c=c.previousElementSibling,f--}else{const f=(l=d.parentElement.previousElementSibling)==null?void 0:l.previousElementSibling;f&&(c=f.lastElementChild,d.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}if(c){c.classList.add("emojis__item--current");const f=this.element.querySelector(".emojis__panel");if(c.offsetTop-8<f.scrollTop)f.scrollTop=c.offsetTop-8;else{const m=f.nextElementSibling.classList.contains("fn__none")?8:36;c.offsetTop+m-this.element.clientHeight+c.clientHeight>f.scrollTop&&(f.scrollTop=c.offsetTop+m-this.element.clientHeight+c.clientHeight)}}return t.preventDefault(),t.stopPropagation(),!0}else if(t.key==="ArrowDown"||t.key==="ArrowUp")return Vt(this.element.firstElementChild,t),t.preventDefault(),t.stopPropagation(),!0;return t.key==="ArrowLeft"||t.key==="ArrowRight"?(ae(["hint"],n),!0):!1}fixImageCursor(t){const n=st(t.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(qe(n)||(t.insertNode(document.createTextNode(p.ZWSP)),t.collapse(!1)))}getKey(t,n){const a=this.splitChar,s=this.lastIndex;if(this.lastIndex=-1,this.splitChar="",n.forEach(l=>{let r=t.lastIndexOf(l.key);p.BLOCK_HINT_KEYS.includes(l.key)&&r>-1&&t.lastIndexOf(l.key+l.key.substring(0,1))>-1&&(r=Math.min(r,t.lastIndexOf(l.key+l.key.substring(0,1)))),this.lastIndex<r&&(this.splitChar=l.key,this.lastIndex=r)}),this.lastIndex===-1)return;!this.element.classList.contains("fn__none")&&a&&a!==this.splitChar&&(this.splitChar=a,this.lastIndex=s),this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(t.substr(this.lastIndex-1,1))||t.substr(this.lastIndex-1,2)==="::"));const i=t.split(this.splitChar),o=i[i.length-1];if(i.length>1&&o.trimStart()===o&&o.length<p.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&t.endsWith("\u3010\u3010\u3011")?"":o}}const gm=e=>{const t=Lute.New();if(t.SetSpellcheck(window.siyuan.config.editor.spellcheck),t.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.SetFileAnnotationRef(!0),t.SetHTMLTag2TextMark(!0),t.SetTextMark(!0),t.SetHeadingID(!1),t.SetYamlFrontMatter(!1),t.PutEmojis(e.emojis),t.SetEmojiSite(e.emojiSite),t.SetHeadingAnchor(e.headingAnchor),t.SetInlineMathAllowDigitAfterOpenMarker(!0),t.SetToC(!1),t.SetIndentCodeBlock(!1),t.SetParagraphBeginningSpace(!0),t.SetSetext(!1),t.SetFootnotes(!1),t.SetLinkRef(!1),t.SetSanitize(e.sanitize),t.SetChineseParagraphBeginningSpace(e.paragraphBeginningSpace),t.SetRenderListStyle(e.listStyle),t.SetImgPathAllowSpace(!0),t.SetKramdownIAL(!0),t.SetTag(!0),t.SetSuperBlock(!0),t.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),t.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),t.SetSup(window.siyuan.config.editor.markdown.inlineSup),t.SetSub(window.siyuan.config.editor.markdown.inlineSub),t.SetTag(window.siyuan.config.editor.markdown.inlineTag),t.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),t.SetGFMStrikethrough1(!1),t.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),t.SetMark(window.siyuan.config.editor.markdown.inlineMark),t.SetSpin(!0),t.SetProtyleWYSIWYG(!0),e.lazyLoadImage&&t.SetImageLazyLoading(e.lazyLoadImage),t.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach(a=>{n[a.keywords]=e.emojiSite+"/"+a.unicode}),t.PutEmojis(n)}return t.SetUnorderedListMarker("-"),t},pm=(e,t)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let s=document.querySelector(".protyle-speech");if(!s){s=document.createElement("div"),s.className="protyle-speech",document.body.insertAdjacentElement("beforeend",s);const i=()=>{const l=speechSynthesis.getVoices();let r,d;return l.forEach(c=>{c.lang===t.replace("_","-")&&(r=c),c.default&&(d=c)}),r||(r=d),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=i);const o=i();s.onclick=()=>{if(s.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(s.getAttribute("data-text"));l.voice=o,l.onend=()=>{s.className="protyle-speech",speechSynthesis.cancel(),s.innerHTML=n},speechSynthesis.speak(l),s.className="protyle-speech protyle-speech--current",s.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),s.innerHTML=a):(speechSynthesis.pause(),s.innerHTML=n));X(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&s.style.display==="block"&&(s.className="protyle-speech",speechSynthesis.cancel(),s.style.display="none")})}e.addEventListener("mouseup",i=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){s.style.display==="block"&&(s.className="protyle-speech",s.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();s.innerHTML=n,s.style.display="block",s.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",s.style.left=i.screenX+2+"px",s.setAttribute("data-text",o)})};var mm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class bm{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",t.options.classes.preview&&n.classList.add(t.options.classes.preview);const a=t.options.preview.actions,s=document.createElement("div");s.className="protyle-preview__action";const i=[];for(let o=0;o<a.length;o++){const l=a[o];if(typeof l=="object"){i.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":i.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":i.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":i.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":i.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":i.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":i.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}s.innerHTML=i.join(""),this.element.appendChild(s),this.element.appendChild(n),this.element.addEventListener("click",o=>{var l;let r=o.target;for(;r&&!r.isEqualNode(this.element);){if(r.tagName==="A"){const c=r.getAttribute("href");if(c.startsWith("#")){const f=c.substring(1);n.querySelector('[data-node-id="'+f+'"], [id="'+f+'"]').scrollIntoView(),o.stopPropagation(),o.preventDefault();break}if(P()){Nt(c),o.stopPropagation(),o.preventDefault();break}o.stopPropagation(),o.preventDefault(),Dr(c)||window.open(c);break}else if(r.tagName==="IMG"){Xr(o.target.getAttribute("src"),t.block.rootID),o.stopPropagation(),o.preventDefault();break}else if(r.tagName==="BUTTON"){const c=r.getAttribute("data-type"),f=a.find(m=>(m==null?void 0:m.key)===c);f?f.click(c):c==="mp-wechat"||c==="zhihu"||c==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),t,c):c==="desktop"?(n.style.width="",n.style.padding=t.wysiwyg.element.style.padding):c==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),c!=="mp-wechat"&&c!=="zhihu"&&c!=="yuque"&&(s.querySelectorAll("button").forEach(m=>{m.classList.remove("protyle-preview__action--current")}),r.classList.add("protyle-preview__action--current"))}r=r.parentElement}const d=O(o.target,"id",void 0);d&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(c=>{c.classList.remove("selected")}),d.classList.add("selected"),(l=window.siyuan.mobile.docks.outline)==null||l.setCurrentByPreview(d))}),this.previewElement=n}render(t){var n;if(this.element.style.display==="none")return;if((n=this.element.querySelector('.protyle-preview__action [data-type="desktop"]'))!=null&&n.classList.contains("protyle-preview__action--current")){const s=Jc(t);this.previewElement.style.padding=`${s.top}px ${s.left}px ${s.bottom}px ${s.right}px`}let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{L("/api/export/preview",{id:t.block.id||t.options.blockId||t.block.parentID},s=>{const i=t.preview.previewElement.scrollTop;t.preview.previewElement.innerHTML=s.data.html,Xe(t.preview.previewElement),Re(t.preview.previewElement),ot(t.preview.previewElement,t),pm(t.preview.previewElement,t.options.lang),t.preview.previewElement.scrollTop=i,a.remove()})},t.options.preview.delay)}link2online(t){fa("")||t.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const s=p.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",s):n.setAttribute("src",s)}})}copyToX(t,n,a){return mm(this,null,function*(){if(a==="mp-wechat")this.link2online(t),t.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),t.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")}),t.querySelectorAll("ul, ol").forEach(o=>{Array.from(o.children).forEach(l=>{const r=l.querySelector("ul, ol");r&&l.parentNode.insertBefore(r,l.nextSibling)})}),t.querySelectorAll("li.protyle-task").forEach(o=>{const l=o.querySelector('input[type="checkbox"]');l&&(l.style.opacity="0",l.checked?o.style.setProperty("list-style-type","'\u2705'","important"):o.style.setProperty("list-style-type","'\u25A2'","important"))}),typeof window.MathJax=="undefined"&&(window.MathJax={svg:{fontCache:"none"}}),yield mt(`${p.PROTYLE_CDN}/js/mathjax/tex-svg-full.js`,"protyleMathJaxScript"),yield window.MathJax.startup.promise,t.querySelectorAll('[data-subtype="math"]').forEach(o=>{const l=window.MathJax.tex2svg(Lute.UnEscapeHTMLStr(o.getAttribute("data-content")).trim(),{display:o.tagName==="DIV"});l.querySelector("mjx-assistive-mml").remove(),o.innerHTML=l.outerHTML});else if(a==="zhihu")this.link2online(t),t.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}" style="${o.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),t.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(t);else if(a==="yuque"){L("/api/lute/copyStdMarkdown",{id:n.block.id||n.options.blockId||n.block.parentID,assetsDestSpace2Underscore:!0,fillCSSVar:!0,adjustHeadingLevel:!0},o=>{He(o.data),se(`${window.siyuan.languages.pasteToYuque}`)});return}t.style.backgroundColor="#fff",t.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(t),t.insertAdjacentHTML("beforeend","<p>&zwj;</p>");let s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0).cloneRange());const i=t.ownerDocument.createRange();i.selectNodeContents(t),X(i),document.execCommand("copy"),this.element.lastElementChild.remove(),X(s),a&&se(`${a==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)})}processZHBlockquote(t,n){Array.from(t.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const s=n[n.length-1];(!s||s&&s.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(t){t.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const s=n.querySelector("tbody");s?s.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const Jo=(...e)=>{const t={},n=a=>{for(const s in a)a.hasOwnProperty(s)&&(Object.prototype.toString.call(a[s])==="[object Object]"?t[s]=Jo(t[s],a[s]):t[s]=a[s])};for(let a=0;a<e.length;a++)n(e[a]);return t};class ym{constructor(t){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,titleShowTop:!1,hideTitleOnZoom:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},click:{preventInsetEmptyBlock:!1},hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:Ia},{key:"\u3010\u3010",hint:Ia},{key:"\uFF08\uFF08",hint:Ia},{key:"[[",hint:Ia},{key:"{{",hint:Ci},{key:"\u300C\u300C",hint:Ci},{key:"\u300C\u300E",hint:Ci},{key:"\u300E\u300C",hint:Ci},{key:"\u300E\u300E",hint:Ci},{key:"#",hint:cm},{key:"/",hint:zo},{key:"\u3001",hint:zo},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:p.PROTYLE_TOOLBAR,typewriterMode:!1,upload:{max:1024*1024*1024*8,url:p.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=t}merge(){var t;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(t=this.options.hint)!=null&&t.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),Jo(this.defaultOptions,this.options)}mergeToolbar(t){return Us(t)}}class wm{constructor(t){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="north" aria-label="${je("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="2west" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" aria-label="${je("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,t.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`),Rs(this.element.getAttribute("aria-label"),this.element)}),this.inputElement.addEventListener("change",()=>{this.setIndex(t)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(t)}),this.parentElement.addEventListener("click",n=>{const a=n.target;C(a,"protyle-scroll__up")?kg(t):C(a,"protyle-scroll__down")?Sg(t):a.classList.contains("b3-slider")&&this.setIndex(t)}),this.parentElement.addEventListener("mousewheel",n=>{n.deltaY!==0&&t.scroll.lastScrollTop!==-1&&(t.contentElement.scrollTop+=n.deltaY)},{passive:!0})}setIndex(t){t.wysiwyg.element.getAttribute("data-top")||(t.wysiwyg.element.setAttribute("data-top",t.wysiwyg.element.scrollTop.toString()),t.contentElement.style.overflow="hidden",L("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:t.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{rt({data:n,protyle:t,action:[p.CB_GET_FOCUSFIRST,p.CB_GET_UNCHANGEID],afterCB:()=>{setTimeout(()=>{t.contentElement.style.overflow=""},p.TIMEOUT_INPUT),Rs(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(t,n,a){L("/api/block/getBlockIndex",{id:n},s=>{if(!s.data)return;const i=t.scroll.element.querySelector(".b3-slider");i.value=s.data,t.scroll.element.setAttribute("aria-label",`Blocks ${s.data}/${t.block.blockCount}`),a&&a(s.data)})}update(t){typeof t.block.blockCount=="number"&&(this.inputElement.setAttribute("max",t.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)),t.block.showAll?this.element.classList.add("fn__none"):t.block.scroll&&!t.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class Ti{constructor(t){this.app=t.app,t.msgCallback&&this.connect(t)}connect(t){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${p.SIYUAN_APPID}&id=${t.id}${t.type?"&type="+t.type:""}`);a.onopen=()=>{t.callback&&t.callback.call(this),document.getElementById("errorLog")&&(Vo(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(i=>{if(i.element.id==="errorLog")return i.destroy(),!0}))},a.onmessage=s=>{if(t.msgCallback){const i=Nl(JSON.parse(s.data));t.msgCallback.call(this,i)}},a.onclose=s=>{0<=s.reason.indexOf("unauthenticated")||0>s.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",s),setTimeout(()=>{this.connect({id:t.id,type:t.type,msgCallback:t.msgCallback})},3e3))},a.onerror=s=>{s.target.url.endsWith("&type=main")&&s.target.readyState===3&&su()},this.ws=a}send(t,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:t,reqId:this.reqId,param:n})))}}var ul=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const pu=(e,t,n,a,s,i)=>ul(void 0,null,function*(){var o,l,r,d,c,f,m,u,g;const y=[],b=[],w=[],h=n.getAttribute("data-node-id"),S=[];let $=n,D=!0;t.find(E=>{if(!E.classList.contains("li")||!n.classList.contains("li")||n.getAttribute("data-subtype")!==E.getAttribute("data-subtype"))return D=!1,!0});let v,k;const _={};for(let E=t.length-1;E>=0;E--){const A=t[E],x=A.getAttribute("data-node-id"),I=A.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID;A.getAttribute("data-type")==="NodeListItem"&&!k&&!D&&(k=Lute.NewNodeID(),v=document.createElement("div"),v.innerHTML=`<div data-subtype="${A.getAttribute("data-subtype")}" data-node-id="${k}" data-type="NodeList" class="list"><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,v=v.firstElementChild,y.push({action:"insert",data:v.outerHTML,id:k,previousID:s==="afterbegin"?null:s==="afterend"?h:(o=$.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:s==="afterbegin"?h:((l=$.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),b.push({action:"delete",id:k}),$.insertAdjacentElement(s,v),S.push(v));const T=Lute.NewNodeID();i&&A.getAttribute("data-type")==="NodeHeading"&&A.getAttribute("fold")==="1"&&w.push({newId:T,oldId:x});let q;if(i?b.push({action:"delete",id:T}):b.push({action:"move",id:x,previousID:(r=A.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:I}),!a&&!i){const z=e.wysiwyg.element.querySelector(`[data-node-id="${x}"]`);z&&z.remove()}if(i)q=A.cloneNode(!0),q.setAttribute("data-node-id",T),q.querySelectorAll("[data-node-id]").forEach(z=>{const N=Lute.NewNodeID();z.setAttribute("data-node-id",N),z.setAttribute("updated",N.split("-")[0])}),k?(v.insertAdjacentElement("afterbegin",q),y.push({action:"insert",id:T,data:q.outerHTML,parentID:k})):($.insertAdjacentElement(s,q),y.push({action:"insert",id:T,data:q.outerHTML,previousID:s==="afterbegin"?null:s==="afterend"?h:(d=q.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:s==="afterbegin"?h:((c=q.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),S.push(q));else{const z=Ve(A),N=A.parentElement;if(A.classList.contains("li")&&A.getAttribute("data-subtype")==="o"&&(_[A.parentElement.getAttribute("data-node-id")]=A.parentElement),k?(v.insertAdjacentElement("afterbegin",A),y.push({action:"move",id:x,parentID:k})):($.insertAdjacentElement(s,A),y.push({action:"move",id:x,previousID:s==="afterbegin"?null:s==="afterend"?h:(f=A.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:s==="afterbegin"?h:((m=A.parentElement)==null?void 0:m.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),S.push(A)),z!==A){y.push({action:"delete",id:z.getAttribute("data-node-id")}),b.push({action:"insert",data:z.outerHTML,id:z.getAttribute("data-node-id"),previousID:(u=z.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:((g=z.parentElement)==null?void 0:g.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID});const R=z.parentElement;if(z.remove(),!a){const V=e.wysiwyg.element.querySelector(`[data-node-id="${z.getAttribute("data-node-id")}"]`);V&&V.remove()}if(R.classList.contains("sb")&&R.childElementCount===2&&a){const V=yield Ea(e,R);y.push(V.doOperations[0],V.doOperations[1]),b.push(V.undoOperations[1],V.undoOperations[0])}}else if(N.classList.contains("sb")&&N.childElementCount===2){if(a){const R=yield Ea(e,N);y.push(R.doOperations[0],R.doOperations[1]),b.push(R.undoOperations[1],R.undoOperations[0])}}else N.classList.contains("protyle-wysiwyg")&&N.childElementCount}k&&(E===0||t[E-1].getAttribute("data-type")!=="NodeListItem"||t[E-1].getAttribute("data-subtype")!==A.getAttribute("data-subtype"))?(s==="beforebegin"&&($=v),k=null,v.getAttribute("data-subtype")==="o"&&v.firstElementChild.getAttribute("data-marker")!=="1."&&(Array.from(v.children).forEach(z=>{z.classList.contains("protyle-attr")||b.push({action:"update",id:z.getAttribute("data-node-id"),data:z.outerHTML})}),Qe(v,1),Array.from(v.children).forEach(z=>{z.classList.contains("protyle-attr")||y.push({action:"update",id:z.getAttribute("data-node-id"),data:z.outerHTML})}),Qe(v,1))):s==="beforebegin"&&($=i?q:A)}Object.keys(_).forEach(E=>{Array.from(_[E].children).forEach(A=>{A.classList.contains("protyle-attr")||b.push({action:"update",id:A.getAttribute("data-node-id"),data:A.outerHTML})}),Qe(_[E],1),Array.from(_[E].children).forEach(A=>{A.classList.contains("protyle-attr")||y.push({action:"update",id:A.getAttribute("data-node-id"),data:A.outerHTML})})}),b.reverse();for(let E=0;E<w.length;E++){const A=w[E],x=yield he("/api/block/getHeadingInsertTransaction",{id:A.oldId});x.data.doOperations.splice(0,1),x.data.doOperations[0].previousID=A.newId,x.data.undoOperations.splice(0,1),y.push(...x.data.doOperations),b.push(...x.data.undoOperations)}return{doOperations:y,undoOperations:b,newSourceElements:S}}),mu=(e,t,n,a,s,i)=>ul(void 0,null,function*(){var o,l,r,d;const c=e.element.contains(t[0]);if(c&&t[0].classList.contains("li")&&n===t[0].parentElement&&n.childElementCount===t.length+1&&!t.find($=>{if(!n.contains($))return!0}))return;const f=[],m={action:"move",id:n.getAttribute("data-node-id"),previousID:(o=n.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:((l=n.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID},u=tc(s);n.parentElement.replaceChild(u,n);const g=[{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),nextID:(r=u.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(d=u.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID}];u.lastElementChild.before(n);const y=yield pu(e,t,u,c,"afterbegin",i);g.push(...y.doOperations),f.push(...y.undoOperations);const b=y.newSourceElements;let w=g.length;g.find((S,$)=>{S.action==="delete"&&S.id===m.parentID&&(w=$),S.action==="delete"&&S.id===n.getAttribute("data-node-id")&&(n=u.querySelector(`[data-node-id="${g[$-1].id}"]`))}),a?(u.insertAdjacentElement("afterbegin",n),g.splice(w,0,{action:"move",id:n.getAttribute("data-node-id"),parentID:u.getAttribute("data-node-id")})):(u.lastElementChild.insertAdjacentElement("beforebegin",n),g.splice(w,0,{action:"move",id:n.getAttribute("data-node-id"),previousID:b[0].getAttribute("data-node-id")})),f.push(m),f.push({action:"delete",id:u.getAttribute("data-node-id")});let h=!1;b.forEach(S=>{if(S.getAttribute("data-type")==="NodeHeading"&&S.getAttribute("fold")==="1"){if(h=!0,S.nextElementSibling&&(S.nextElementSibling.getAttribute("data-type")!=="NodeHeading"||S.nextElementSibling.getAttribute("data-subtype")>S.getAttribute("data-subtype"))){const $=at(e,S,!0,!1,!1,!0);g.push(...$.doOperations)}return!0}}),c||i?B(e,g,f):B(e,g),(b.length>1||h)&&s==="col"&&_n({protyle:e,selectsElement:b.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),document.contains(t[0])?te(t[0]):te(n)}),bu=(e,t,n,a,s)=>ul(void 0,null,function*(){const i=e.element.contains(t[0]),o=[],l=[],r=yield pu(e,t,n,i,a?"afterend":"beforebegin",s);o.push(...r.doOperations),l.push(...r.undoOperations);const d=r.newSourceElements;let c;a&&n.getAttribute("data-type")==="NodeHeading"&&n.getAttribute("fold")==="1"?c=at(e,n,!0,!1,!1,!0):!a&&n.previousElementSibling&&n.previousElementSibling.getAttribute("data-type")==="NodeHeading"&&n.previousElementSibling.getAttribute("fold")==="1"&&(c=at(e,n.previousElementSibling,!0,!1,!1,!0)),c&&(c.doOperations[0].context={focusId:t[0].getAttribute("data-node-id")},o.push(...c.doOperations),l.push(...c.undoOperations)),n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||l.splice(0,0,{action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}),Qe(n.parentElement,1),Array.from(n.parentElement.children).forEach(m=>{m.classList.contains("protyle-attr")||o.push({action:"update",id:m.getAttribute("data-node-id"),data:m.outerHTML})}));let f=!1;d.forEach(m=>{if(m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"){if(f=!0,m.nextElementSibling&&(m.nextElementSibling.getAttribute("data-type")!=="NodeHeading"||m.nextElementSibling.getAttribute("data-subtype")>m.getAttribute("data-subtype"))){const u=at(e,m,!0,!1,!1,!0);o.push(...u.doOperations)}return!0}}),i||s?B(e,o,l):B(e,o),(d.length>1||f)&&d[0].parentElement.classList.contains("sb")&&d[0].parentElement.getAttribute("data-sb-layout")==="col"&&_n({protyle:e,selectsElement:d.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),document.contains(t[0])?te(t[0]):te(n)}),_m=(e,t)=>{t.addEventListener("dragstart",i=>{var o,l,r;if(e.disabled){i.preventDefault(),i.stopPropagation();return}let d=i.target;if((o=d.classList)!=null&&o.contains("av__gallery-img")&&(d=C(d,"av__gallery-item")),!!d){if(d.tagName==="IMG"){window.siyuan.dragElement=void 0,i.preventDefault();return}if(d.classList){if(C(d,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,i.preventDefault();else if(d.parentElement.parentElement.classList.contains("av__views")){window.siyuan.dragElement=d,d.style.width=d.clientWidth+"px",d.style.opacity=".36",i.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}ViewTab${p.ZWSP}${[(l=d.previousElementSibling)==null?void 0:l.getAttribute("data-id")]}`,d.outerHTML);return}else if(d.classList.contains("protyle-action")){d.parentElement.classList.add("protyle-wysiwyg--select");const c=document.createElement("div");c.className=e.wysiwyg.element.className,c.append(un(d.parentElement.cloneNode(!0))),c.setAttribute("style",`position:fixed;opacity:.1;width:${d.parentElement.clientWidth}px;padding:0;`),document.body.append(c),i.dataTransfer.setDragImage(c,0,0),setTimeout(()=>{c.remove()}),window.siyuan.dragElement=e.wysiwyg.element,i.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeListItem${p.ZWSP}${d.parentElement.getAttribute("data-subtype")}${p.ZWSP}${[d.parentElement.getAttribute("data-node-id")]}`,e.wysiwyg.element.innerHTML);return}else if(d.classList.contains("av__cell--header")){window.siyuan.dragElement=d,i.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}Col${p.ZWSP}${[d.getAttribute("data-col-id")]}`,d.outerHTML);return}else if(d.classList.contains("av__gallery-item")){const c=F(d);if(c){if((r=c.querySelector('.block__icon[data-type="av-sort"]'))!=null&&r.classList.contains("block__icon--active")){const w=c.querySelectorAll(".av__body");if(w.length===1){i.preventDefault(),i.stopPropagation();return}else if(["template","created","updated"].includes(w[0].getAttribute("data-dtype"))){i.preventDefault(),i.stopPropagation();return}}d.classList.contains("av__gallery-item--select")||(c.querySelectorAll(".av__gallery-item--select").forEach(w=>{w.classList.remove("av__gallery-item--select")}),d.classList.add("av__gallery-item--select"));const f=document.createElement("div");f.className="protyle-wysiwyg protyle-wysiwyg--attr";const m=c.getAttribute("data-av-type")==="kanban";m&&(f.innerHTML=`<div class="${c.querySelector(".av__kanban").className}"></div>`);let u,g=document.createElement("div");const y=c.querySelectorAll(".av__gallery-item--select");y.forEach(w=>{(!u||!u.contains(w))&&(u=w.parentElement,g=document.createElement("div"),m?(g.className="av__kanban-group",g.setAttribute("style",w.parentElement.parentElement.parentElement.getAttribute("style")),g.innerHTML='<div class="av__gallery"></div>',f.firstElementChild.appendChild(g)):(g.classList.add("av__gallery"),g.setAttribute("style",`width: 100vw;margin-bottom: 16px;grid-template-columns: repeat(auto-fill, ${y[0].clientWidth}px);`),f.appendChild(g)));const h=un(w.cloneNode(!0));h.setAttribute("style",`height:${w.clientHeight}px;`),h.classList.remove("av__gallery-item--select"),m?g.firstElementChild.appendChild(h):g.appendChild(h)}),f.setAttribute("style","left: 1px;top:100vh;position:fixed;opacity:.1;padding:0;z-index: 8"),document.body.append(f),i.dataTransfer.setDragImage(f,-10,-10),setTimeout(()=>{f.remove()}),window.siyuan.dragElement=d;const b=[];c.querySelectorAll(".av__gallery-item--select").forEach(w=>{const S=C(w,"av__body").getAttribute("data-group-id");b.push(w.getAttribute("data-id")+(S?`@${S}`:""))}),i.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}GalleryItem${p.ZWSP}${b}`,f.outerHTML)}return}}i.dataTransfer.setData(p.SIYUAN_DROP_EDITOR,p.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}}),t.addEventListener("drop",i=>ul(void 0,null,function*(){var o,l,r,d,c,f;if(s=0,e.disabled||i.dataTransfer.getData(p.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation();return}let m="";for(const g of i.dataTransfer.items)g.type.startsWith(p.SIYUAN_DROP_GUTTER)&&(m=g.type);if(m.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}ViewTab${p.ZWSP}`.toLowerCase())){const g=F(window.siyuan.dragElement);if(g){const y=g.getAttribute("data-av-id"),b=g.getAttribute("data-node-id"),w=window.siyuan.dragElement.getAttribute("data-id");B(e,[{action:"sortAttrViewView",avID:y,blockID:b,id:w,previousID:(o=window.siyuan.dragElement.previousElementSibling)==null?void 0:o.getAttribute("data-id"),data:"unRefresh"}],[{action:"sortAttrViewView",avID:y,blockID:b,id:w,previousID:m.split(p.ZWSP).pop()}])}return}const u=t.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(u&&(u.classList.remove("dragover"),u.removeAttribute("select-start"),u.removeAttribute("select-end")),m){const g=[],y=m.replace(p.SIYUAN_DROP_GUTTER,"").split(p.ZWSP),b=y[2].split(",");if(i.altKey||i.shiftKey)if(i.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)an(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const w=$l(i.clientX,i.clientY);if(O(w.startContainer,"data-type","NodeBlockQueryEmbed"))return;X(w)}if(i.altKey){let w="";for(let h=0;h<b.length;h++){const S=yield he("/api/block/getRefText",{id:b[h]});w+=e.lute.Md2BlockDOM(`((${b[h]} '${S.data}'))`)}lt(w,e)}else if(i.shiftKey){let w="";b.forEach(h=>{w+=`{{select * from blocks where id='${h}'}}
`}),lt(e.lute.SpinBlockDOM(w),e,!0),xe(e,e.wysiwyg.element)}else if(u&&u.className.indexOf("dragover__")>-1){let w="";if(b.forEach(D=>{w+=`[data-node-id="${D}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(w.substring(0,w.length-1)).forEach(D=>{de(D)||g.push(D)});else if(window.siyuan.config.system.workspaceDir.toLowerCase()===y[3]){const D=document.createElement("template");D.innerHTML=`<div>${i.dataTransfer.getData(m)}</div>`,D.content.querySelectorAll(w.substring(0,w.length-1)).forEach(v=>{de(v)||g.push(v)})}const h=[],S=[];g.forEach(D=>{D.classList.remove("protyle-wysiwyg--hl"),D.removeAttribute("select-start"),D.removeAttribute("select-end"),D.querySelectorAll('[data-type="search-mark"]').forEach(k=>{k.outerHTML=k.innerHTML});const v=D.getAttribute("data-node-id");h.push(v),S.push({itemID:Lute.NewNodeID(),id:v,isDetached:!1})}),ae(["gutter"],e);const $=u.className.split(" ");if(u.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),u.classList.contains("av__cell")){const D=F(u);if(D){const v=D.getAttribute("data-av-id");let k="";$.includes("dragover__left")?u.previousElementSibling&&(u.previousElementSibling.classList.contains("av__colsticky")?k=u.previousElementSibling.lastElementChild.getAttribute("data-col-id"):k=u.previousElementSibling.getAttribute("data-col-id")):k=u.getAttribute("data-col-id");let _="";const E=C(u,"av__row");if(E){const A=(l=E.querySelector(`[data-col-id="${y[2]}"`))==null?void 0:l.previousElementSibling;A&&(A.classList.contains("av__colsticky")?_=A.lastElementChild.getAttribute("data-col-id"):_=A.getAttribute("data-col-id"))}k!==_&&k!==y[2]&&B(e,[{action:"sortAttrViewCol",avID:v,previousID:k,id:y[2],blockID:D.dataset.nodeId}],[{action:"sortAttrViewCol",avID:v,previousID:_,id:y[2],blockID:D.dataset.nodeId}])}}else if(u.classList.contains("av__row")){const D=F(u);if(D){let v="";$.includes("dragover__bottom")?v=u.getAttribute("data-id")||"":v=((r=u.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"";const k=D.getAttribute("data-av-id");if(y[0]==="nodeattributeviewrowmenu"){const _=[],E=[],A=u.parentElement.getAttribute("data-group-id");b.reverse().forEach(x=>{var I;const T=x.split("@"),q=T[0],z=T[1]||"",N=((I=D.querySelector(`.av__body${z?`[data-group-id="${z}"]`:""} .av__row[data-id="${q}"]`).previousElementSibling)==null?void 0:I.getAttribute("data-id"))||"";(v!==q&&N!==v||N===""&&v===""&&A!==z)&&(_.push({action:"sortAttrViewRow",avID:k,previousID:v,id:q,blockID:D.dataset.nodeId,groupID:z,targetGroupID:A}),E.push({action:"sortAttrViewRow",avID:k,previousID:N,id:q,blockID:D.dataset.nodeId,groupID:A,targetGroupID:z}))}),B(e,_,E)}else{const _=G().format("YYYYMMDDHHmmss"),E=C(u,"av__body"),A=E&&E.getAttribute("data-group-id");B(e,[{action:"insertAttrViewBlock",avID:k,previousID:v,srcs:S,blockID:D.dataset.nodeId,groupID:A},{action:"doUpdateUpdated",id:D.dataset.nodeId,data:_}],[{action:"removeAttrViewBlock",srcIDs:h,avID:k},{action:"doUpdateUpdated",id:D.dataset.nodeId,data:D.getAttribute("updated")}]),D.setAttribute("updated",_),sl({protyle:e,blockElement:D,srcIDs:h,previousId:v,groupID:A})}}}else if(u.classList.contains("av__gallery-item")||u.classList.contains("av__gallery-add")){const D=F(u);if(D){let v="";$.includes("dragover__right")||$.includes("dragover__bottom")?v=u.getAttribute("data-id")||"":($.includes("dragover__top")||$.includes("dragover__left"))&&(v=((d=u.previousElementSibling)==null?void 0:d.getAttribute("data-id"))||"");const k=D.getAttribute("data-av-id");if(y[1]==="galleryitem"&&y[0]==="nodeattributeview"){const _=[],E=[],A=u.parentElement.parentElement.getAttribute("data-group-id");b.reverse().forEach(x=>{var I;const T=x.split("@"),q=T[0],z=T[1]||"",N=((I=D.querySelector(`.av__body[data-group-id="${z}"] .av__gallery-item[data-id="${q}"]`).previousElementSibling)==null?void 0:I.getAttribute("data-id"))||"";(v!==x&&N!==v||N===""&&v===""&&A!==z)&&(_.push({action:"sortAttrViewRow",avID:k,previousID:v,id:q,blockID:D.dataset.nodeId,groupID:z,targetGroupID:A}),E.push({action:"sortAttrViewRow",avID:k,previousID:N,id:q,blockID:D.dataset.nodeId,groupID:A,targetGroupID:z}))}),B(e,_,E)}else{const _=G().format("YYYYMMDDHHmmss"),E=C(u,"av__body");B(e,[{action:"insertAttrViewBlock",avID:k,previousID:v,srcs:S,blockID:D.dataset.nodeId,groupID:E&&E.getAttribute("data-group-id")},{action:"doUpdateUpdated",id:D.dataset.nodeId,data:_}],[{action:"removeAttrViewBlock",srcIDs:h,avID:k},{action:"doUpdateUpdated",id:D.dataset.nodeId,data:D.getAttribute("updated")}]),D.setAttribute("updated",_),jc({protyle:e,blockElement:D,srcIDs:h,previousId:v,groupID:u.parentElement.getAttribute("data-group-id")})}}}else g.length>0&&(u.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&u.parentElement.getAttribute("data-sb-layout")==="col"?$.includes("dragover__left")||$.includes("dragover__right")?bu(e,g,u,$.includes("dragover__right"),i.ctrlKey):mu(e,g,u,$.includes("dragover__bottom"),"row",i.ctrlKey):$.includes("dragover__left")||$.includes("dragover__right")?mu(e,g,u,$.includes("dragover__right"),"col",i.ctrlKey):bu(e,g,u,$.includes("dragover__bottom"),i.ctrlKey),t.querySelectorAll(".protyle-wysiwyg--empty").forEach(D=>{D.classList.remove("protyle-wysiwyg--empty")}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(D=>{D.removeAttribute("data-render"),xe(e,D)}));n=void 0}}else if(((c=i.dataTransfer.getData(p.SIYUAN_DROP_FILE))==null?void 0:c.split("-").length)>1){const g=i.dataTransfer.getData(p.SIYUAN_DROP_FILE).split(",");if(!i.altKey&&(!u||!u.classList.contains("av__row")&&!u.classList.contains("av__gallery-item")&&!u.classList.contains("av__gallery-add"))){if(i.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)an(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const b=$l(i.clientX,i.clientY);if(O(b.startContainer,"data-type","NodeBlockQueryEmbed"))return;X(b)}let y="";for(let b=0;b<g.length;b++){g.length>1&&(y+="- ");const w=yield he("/api/block/getRefText",{id:g[b]});y+=`((${g[b]} '${w.data}'))`,g.length>1&&b!==g.length-1&&(y+=`
`)}lt(e.lute.Md2BlockDOM(y),e)}else if(u&&!e.options.backlinkData&&u.className.indexOf("dragover__")>-1){const y=e.contentElement.scrollTop;if(u.classList.contains("av__row")||u.classList.contains("av__gallery-item")||u.classList.contains("av__gallery-add")){const b=F(u);if(b){let w="";u.classList.contains("dragover__bottom")||u.classList.contains("dragover__right")?w=u.getAttribute("data-id")||"":(u.classList.contains("dragover__top")||u.classList.contains("dragover__left"))&&(w=((f=u.previousElementSibling)==null?void 0:f.getAttribute("data-id"))||"");const h=b.getAttribute("data-av-id"),S=G().format("YYYYMMDDHHmmss"),$=[],D=C(u,"av__body"),v=D&&D.getAttribute("data-group-id");g.forEach(k=>{$.push({itemID:Lute.NewNodeID(),id:k,isDetached:!1})}),B(e,[{action:"insertAttrViewBlock",avID:h,previousID:w,srcs:$,blockID:b.dataset.nodeId,groupID:v},{action:"doUpdateUpdated",id:b.dataset.nodeId,data:S}],[{action:"removeAttrViewBlock",srcIDs:g,avID:h},{action:"doUpdateUpdated",id:b.dataset.nodeId,data:b.getAttribute("updated")}]),sl({protyle:e,blockElement:b,srcIDs:g,previousId:w,groupID:v}),b.setAttribute("updated",S)}}else{if(u.classList.contains("dragover__bottom"))for(let b=g.length-1;b>-1;b--)g[b]&&(yield he("/api/filetree/doc2Heading",{srcID:g[b],after:!0,targetID:u.getAttribute("data-node-id")}));else for(let b=0;b<g.length;b++)g[b]&&(yield he("/api/filetree/doc2Heading",{srcID:g[b],after:!1,targetID:u.getAttribute("data-node-id")}));L("/api/filetree/getDoc",{id:e.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},b=>{rt({data:b,protyle:e}),setTimeout(()=>{e.contentElement.scrollTop=y,e.scroll.lastScrollTop=y-1},p.TIMEOUT_LOAD)})}u.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(i.dataTransfer.types[0]==="Files"||i.dataTransfer.types.includes("text/html"))){i.preventDefault();const g=C(i.target,"av");if(g){const y=C(i.target,"av__cell");if(y&&ln(y)==="mAsset"&&i.dataTransfer.types[0]==="Files"&&!Be()){const b=[];for(let w=0;w<i.dataTransfer.files.length;w++)b.push(webUtils.getPathForFile(i.dataTransfer.files[w]));lc(b,e,y),Et(["cell"],g)}}else{if(X($l(i.clientX,i.clientY)),i.dataTransfer.types[0]==="Files"&&!Be()){const y=[];for(let b=0;b<i.dataTransfer.files.length;b++)y.push(webUtils.getPathForFile(i.dataTransfer.files[b]));ko(y,e,!i.altKey)}else ps(e,i);Et(["av","img"],e.wysiwyg.element)}}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,a;t.addEventListener("dragover",i=>{var o,l,r,d,c;if(e.disabled||i.dataTransfer.types.includes(p.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation(),i.dataTransfer.dropEffect="none";return}let f="";for(const h of i.dataTransfer.items)h.type.startsWith(p.SIYUAN_DROP_GUTTER)&&(f=h.type);if(f.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}ViewTab${p.ZWSP}`.toLowerCase())){Uf(i),i.preventDefault();return}const m=e.contentElement.getBoundingClientRect();!C(i.target,"av__cell")&&(i.clientY<m.top+p.SIZE_SCROLL_TB||i.clientY>m.bottom-p.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(i.clientY<m.top+p.SIZE_SCROLL_TB?-p.SIZE_SCROLL_STEP:p.SIZE_SCROLL_STEP),behavior:"smooth"});let u;if(i.dataTransfer.types.includes("Files")){if(u=C(i.target,"av__cell"),u&&u.getAttribute("data-dtype")==="mAsset"&&!u.classList.contains("av__cell--header")){if(i.preventDefault(),n&&u===n)return;const h=F(u);h&&(Et(["cell","row"],e.wysiwyg.element),u.classList.add("av__cell--select"),h.getAttribute("data-av-type")!=="gallery"&&wn(u),n=u)}return}if(!f&&!window.siyuan.dragElement){i.preventDefault();return}const g=f?f.replace(p.SIYUAN_DROP_GUTTER,"").split(p.ZWSP):[],y=i.dataTransfer.types.includes(p.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(i.shiftKey||i.altKey&&y.indexOf("-")===-1){const h=F(i.target);h?(h.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),h.removeAttribute("select-start"),h.removeAttribute("select-end")):t.querySelectorAll(".dragover__top, .protyle-wysiwyg--select, .dragover__bottom, .dragover__left, .dragover__right").forEach(S=>{S.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),S.removeAttribute("select-start"),S.removeAttribute("select-end")}),i.preventDefault();return}if(i.preventDefault(),u=C(i.target,"av__gallery-item")||C(i.target,"av__gallery-add")||C(i.target,"av__row")||C(i.target,"av__row--util")||F(i.target),u&&["gallery","kanban"].includes(u.getAttribute("data-av-type"))&&i.target.classList.contains("av__gallery"))return;const b={x:i.clientX,y:i.clientY,className:""};if(u&&(u.classList.contains("bq")||u.classList.contains("sb")||u.classList.contains("list")||u.classList.contains("li"))){let h=F(document.elementFromPoint(b.x,b.y-6));for(;h&&u.contains(h);)(o=h.nextElementSibling)!=null&&o.getAttribute("data-node-id")&&(u=h),h=h.parentElement}if(u)u&&u.classList.contains("list")&&(g[0]!=="nodelistitem"?u=F(document.elementFromPoint(i.clientX,i.clientY-6)):u=C(document.elementFromPoint(i.clientX,i.clientY-6),"li"));else if(i.clientY>t.lastElementChild.getBoundingClientRect().bottom)u=t.lastElementChild,b.className="dragover__bottom";else if(i.clientY<t.firstElementChild.getBoundingClientRect().top)u=t.firstElementChild,b.className="dragover__top";else if(m){const h={left:m.left+parseInt(t.style.paddingLeft),right:m.left+e.contentElement.clientWidth-parseInt(t.style.paddingRight)};i.clientX<h.left?(b.x=h.left,b.className="dragover__left"):i.clientX>=h.right&&(b.x=h.right-6,b.className="dragover__right"),u=document.elementFromPoint(b.x,b.y),u.classList.contains("protyle-wysiwyg")&&(u=document.elementFromPoint(b.x,b.y-6)),u=Y(u,"data-node-id",null)}if(f&&f.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}Col${p.ZWSP}`.toLowerCase())){if(u=C(i.target,"av__cell"),u){const h=C(u,"av__row--header"),S=C(window.siyuan.dragElement,"av__row--header");(u===window.siyuan.dragElement||!h||!S||h&&S&&h!==S)&&(u=!1)}}else if(u&&f&&f.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${p.ZWSP}`.toLowerCase()))if(!u.classList.contains("av__row")&&!u.classList.contains("av__row--util")||window.siyuan.dragElement&&!window.siyuan.dragElement.contains(u))u=!1;else{const h=C(u,"av__body");if(h){const S=F(h),$=h.getAttribute("data-group-id"),D=["template","created","updated"].includes(h.getAttribute("data-dtype")),v=(l=S.querySelector('.block__icon[data-type="av-sort"]'))==null?void 0:l.classList.contains("block__icon--active");g[2].split(",").find(k=>{const _=k?k.split("@")[1]:"";if(_!==$&&D||_===$&&v)return u=!1,!0})}}else if(u&&f&&f.startsWith(`${p.SIYUAN_DROP_GUTTER}NodeAttributeView${p.ZWSP}GalleryItem${p.ZWSP}`.toLowerCase())){const h=C(i.target,"av__container");if(u.classList.contains("av")||!h||!h.contains(window.siyuan.dragElement)||u===window.siyuan.dragElement)u=!1;else{const S=C(u,"av__body");if(S){const $=F(S),D=S.getAttribute("data-group-id"),v=["template","created","updated"].includes(S.getAttribute("data-dtype")),k=(r=$.querySelector('.block__icon[data-type="av-sort"]'))==null?void 0:r.classList.contains("block__icon--active");g[2].split(",").find(_=>{const E=_?_.split("@")[1]:"";if(E!==D&&v||E===D&&k)return u=!1,!0})}}}if(!u){t.querySelectorAll(".dragover__bottom, .dragover__top, .dragover, .dragover__left, .dragover__right").forEach(h=>{h.classList.remove("dragover__top","dragover__bottom","dragover","dragover__left","dragover__right")});return}const w=!u.classList.contains("av__row")&&!u.classList.contains("av__row--util")&&!u.classList.contains("av__gallery-item")&&!u.classList.contains("av__gallery-add");if(u&&n&&u===n){const h=u.getBoundingClientRect();if(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(S=>{S.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),S.removeAttribute("select-start"),S.removeAttribute("select-end")}),y.indexOf("-")>-1&&w)if(i.altKey){if(y.split(",").includes(e.block.rootID)&&i.altKey)return}else return;if(u.getAttribute("data-type")==="NodeAttributeView"&&U(i.target,"TD"))return;if(b.className){u.classList.add(b.className),Ka(u);return}if(u.getAttribute("data-type")==="NodeListItem"){i.clientY>h.top+h.height/2?(u.classList.add("dragover__bottom"),Ka(u)):u.classList.contains("av__row--header")||(u.classList.add("dragover__top"),Ka(u));return}if(u.classList.contains("av__cell")){i.clientX<h.left+h.width/2&&i.clientX>h.left&&!u.classList.contains("av__row")&&u.previousElementSibling!==window.siyuan.dragElement?u.classList.add("dragover__left"):i.clientX>h.right-h.width/2&&i.clientX<=h.right+1&&!u.classList.contains("av__row")&&u!==window.siyuan.dragElement.previousElementSibling&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&u===window.siyuan.dragElement.previousElementSibling.lastElementChild||u.classList.add("dragover__right"));return}if(u.classList.contains("av__gallery-item")){if(C(u,"av__kanban-group")){const S=h.top+h.height/2;i.clientY<S&&i.clientY>h.top-13?u.classList.add("dragover__top"):i.clientY>S&&i.clientY<=h.bottom+13&&u.classList.add("dragover__bottom")}else{const S=h.left+h.width/2;i.clientX<S&&i.clientX>h.left-13?u.classList.add("dragover__left"):i.clientX>S&&i.clientX<=h.right+13&&u.classList.add("dragover__right")}return}if(u.classList.contains("av__gallery-add")){C(u,"av__kanban-group")?u.classList.add("dragover__top"):u.classList.add("dragover__left");return}i.clientX<h.left+32&&i.clientX>=h.left-1&&!u.classList.contains("av__row")?(u.classList.add("dragover__left"),Ka(u)):i.clientX>h.right-32&&i.clientX<h.right&&!u.classList.contains("av__row")?(u.classList.add("dragover__right"),Ka(u)):u.classList.contains("av__row--header")?u.classList.add("dragover__bottom"):u.classList.contains("av__row--util")?u.previousElementSibling.classList.add("dragover__bottom"):i.clientY>h.top+h.height/2&&a!=="bottom"?(u.classList.add("dragover__bottom"),Ka(u)):a!=="top"&&(u.classList.add("dragover__top"),Ka(u));return}if(y.indexOf("-")>-1){y.split(",").includes(e.block.rootID)&&w&&i.altKey?(n=void 0,t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(h=>{h.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),h.removeAttribute("select-start"),h.removeAttribute("select-end")})):n=u;return}if(f){if(a="",g[0]==="nodeattributeview"&&g[1]==="col"&&u.getAttribute("data-id")===g[2]){Za(n);return}if(g[0]==="nodeattributeviewrowmenu"&&g[2].split("@")[0]===u.getAttribute("data-id")){Za(n);return}if(g[2].split(",").find(S=>{if(S&&O(u,"data-node-id",S))return!0})&&g[0]!=="nodeattributeviewrowmenu"){Za(n);return}if(de(u)){Za(n);return}if(g[0]==="nodelistitem"&&u.getAttribute("data-type")==="NodeListItem"){if(g[1]!==u.getAttribute("data-subtype")){Za(n);return}if(Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")).find($=>{if(!$.classList.contains("li"))return!0})){Za(n);return}}if(g[0]!=="nodelistitem"&&u.getAttribute("data-type")==="NodeListItem"){Za(n);return}g[0]==="nodelistitem"&&u.parentElement.classList.contains("li")&&((d=u.previousElementSibling)!=null&&d.classList.contains("protyle-action"))&&(a="top"),g[0]==="nodelistitem"&&((c=u.nextElementSibling)!=null&&c.classList.contains("list"))&&(a="bottom"),u&&u.classList.contains("av__row--header")&&(a="top"),n=u}});let s=0;t.addEventListener("dragleave",i=>{if(e.disabled){i.preventDefault(),i.stopPropagation();return}s--,s===0&&(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(o=>{o.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),n=void 0)}),t.addEventListener("dragenter",i=>{i.preventDefault(),s++}),t.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0,document.onmousemove=null)})},Ka=e=>{(e.classList.contains("sb")||e.classList.contains("li")||e.classList.contains("list")||e.classList.contains("bq"))&&e.classList.add("dragover")},Za=e=>{e&&(e.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),e=void 0)},hm=(e,t,n)=>{if(!t.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.isComposing)return!0;if(ne("\u2318B",e)||ne("\u2318I",e)||ne("\u2318U",e))return e.preventDefault(),!0;const a=t.querySelector(".av__cell--select");if(a){const i=C(a,"av__row");if(!i||i.dataset.type==="ghost")return!1;const o=document.querySelector(".av__panel");if(o&&(e.key==="Backspace"||e.key==="Delete"||e.key==="Escape"||e.key.startsWith("ArrowLeft")||e.key==="Enter"||ne("\u21E5",e)||ne("\u21E7\u21E5",e)))return o.remove(),e.preventDefault(),e.stopPropagation(),!0;if(e.key==="Backspace"||e.key==="Delete")return Zt(n,t,void 0,Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select"))),e.preventDefault(),!0;if(e.key==="Escape")return Et(["cell"],t),Vn(i.querySelector(".av__firstcol"),"select"),e.preventDefault(),!0;if(e.key==="Enter")return on(n,[a]),e.preventDefault(),!0;let l;if(e.key==="ArrowLeft"||ne("\u21E7\u21E5",e)){const r=i.previousElementSibling;if(a.previousElementSibling&&!a.previousElementSibling.classList.contains("av__firstcol")&&(a.previousElementSibling.classList.contains("av__colsticky")?(l=a.previousElementSibling.lastElementChild,l.classList.contains("av__firstcol")&&(l=void 0)):a.previousElementSibling.classList.contains("av__cell")&&(l=a.previousElementSibling)),!l&&r&&!r.classList.contains("av__row--header")){const d=r.querySelectorAll(".av__cell");l=d[d.length-1]}return l&&(Et(["cell"],t),l.classList.add("av__cell--select"),wn(l),ma(t,l,!1)),e.preventDefault(),!0}if(e.key==="ArrowRight"||ne("\u21E5",e)){const r=i.nextElementSibling;return a.nextElementSibling&&a.nextElementSibling.classList.contains("av__cell")?l=a.nextElementSibling:!a.nextElementSibling&&a.parentElement.nextElementSibling?l=a.parentElement.nextElementSibling:r&&!r.classList.contains("av__row--footer")&&(l=r.querySelector(".av__cell")),l?(Et(["cell"],t),l.classList.add("av__cell--select"),wn(l),ma(t,l,!1)):e.key!=="ArrowRight"&&(Et(["cell"],t),Ca({blockElement:t,protyle:n,count:1,previousID:i.getAttribute("data-id"),groupID:i.parentElement.getAttribute("data-group-id")})),e.preventDefault(),!0}if(e.key==="ArrowUp"){const r=i.previousElementSibling;return r&&!r.classList.contains("av__row--header")&&(l=r.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),l&&(Et(["cell"],t),l.classList.add("av__cell--select"),wn(l),ma(t,l)),e.preventDefault(),!0}if(e.key==="ArrowDown"){const r=i.nextElementSibling;return r&&!r.classList.contains("av__row--footer")&&(l=r.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),l&&(Et(["cell"],t),l.classList.add("av__cell--select"),wn(l),ma(t,l)),e.preventDefault(),!0}if(!p.KEYCODELIST[e.keyCode]||p.KEYCODELIST[e.keyCode].length===1&&!e.metaKey&&!e.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(p.KEYCODELIST[e.keyCode]))return a.style.backgroundColor?e.preventDefault():on(n,[a]),!0}const s=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(s.length>0){if(ne("\u2318/",e))return e.stopPropagation(),e.preventDefault(),Ki(n,s[0],{x:t.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:s[0].getBoundingClientRect().bottom}),!0;if(e.key==="Escape")return e.preventDefault(),Vn(s[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(e.key==="Backspace")return e.preventDefault(),Kc(t,n),!0;if(e.key==="Enter")return Vn(s[0].querySelector(".av__firstcol"),"unselectAll"),on(n,[s[0].querySelector(".av__cell")]),e.preventDefault(),!0;if(e.key==="ArrowUp"){const i=s[0].previousElementSibling;return Vn(s[0].querySelector(".av__firstcol"),"unselectAll"),i&&!i.classList.contains("av__row--header")?(Vn(i.querySelector(".av__firstcol"),"select"),ma(t,i)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}if(e.key==="ArrowDown"){const i=s[s.length-1].nextElementSibling;return Vn(s[0].querySelector(".av__firstcol"),"unselectAll"),i&&!i.classList.contains("av__row--util")?(Vn(i.querySelector(".av__firstcol"),"select"),ma(t,i)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}}return!1},gy=e=>{const t=document.querySelector(".av__panel");if(t&&window.siyuan.menus.menu.element.classList.contains("fn__none")&&(t.querySelector('[data-type="goSearchRollupCol"]')&&!t.querySelector(".b3-text-field")||t.querySelector('[data-type="addAssetExist"]'))){const n=t.querySelector(".b3-menu__items");if(e.key==="Enter"){const a=n.querySelector(".b3-menu__item--current");if(a){const s=a.querySelector('[data-type="editAssetItem"]'),i=a.querySelector(".b3-form__upload");return s?t.dispatchEvent(new CustomEvent("click",{detail:{type:s.getAttribute("data-type"),target:s}})):i?i.dispatchEvent(new MouseEvent("click",{bubbles:!0})):t.dispatchEvent(new CustomEvent("click",{detail:{type:a.getAttribute("data-type"),target:a}})),!0}}else{if(e.key==="Escape")return t.dispatchEvent(new CustomEvent("click",{detail:"close"})),!0;if(upDownHint(n,e,"b3-menu__item--current",n.firstElementChild))return!0}}return!1},Qo=e=>{var t;if(e.command==="switchReadonly")return qd(e.protyle.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),e.protyle),!0;if(e.command==="switchAdjust"){let a;const s=e.protyle.wysiwyg.element.getAttribute(p.CUSTOM_SY_FULLWIDTH);return s?a=s==="true"?"false":"true":a=window.siyuan.config.editor.fullWidth?"false":"true",L("/api/attr/setBlockAttrs",{id:e.protyle.block.rootID,attrs:{[p.CUSTOM_SY_FULLWIDTH]:a}}),!0}const n=F(e.previousRange.startContainer);if(!n)return!1;if(e.command==="enter"){let a=Ve(n);a.parentElement.classList.contains("li")&&a.parentElement.parentElement.classList.contains("list")&&((t=a.nextElementSibling)!=null&&t.classList.contains("list"))&&a.previousElementSibling.classList.contains("protyle-action")&&(a=a.parentElement);const s=a.getAttribute("data-node-id");return e.protyle.options.backlinkData||Bt({protyle:e.protyle,id:s}),!0}return e.command==="enterBack"?(wo(e.protyle,n.getAttribute("data-node-id")),!0):!1};var vm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const yu=(e,t)=>{let n="";Array.from(e.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),L("/api/block/getDOMText",{dom:n},a=>{t(a.data)})},Em=(e,t)=>{t.addEventListener("keydown",n=>vm(void 0,null,function*(){var a,s,i,o,l,r,d,c,f,m;if(n.target.localName==="protyle-html"||n.target.localName==="input"){n.stopPropagation();return}if(e.disabled||!e.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}e.wysiwyg.preventKeyup=!1,ae(["util"],e),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&ae(["toolbar"],e);const u=ye(e.wysiwyg.element),g=F(u.startContainer);if(!g)return;const y=F(u.endContainer);if(!ne("\u2318C",n)&&y&&g!==y){n.stopPropagation(),n.preventDefault();return}if(document.querySelector(".av__panel")||hm(n,g,e))return;if(g.classList.contains("protyle-wysiwyg--select")&&Ze(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{an(e,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{an(e,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(p.KEYCODELIST[n.keyCode])||(p.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?e.hint.enableSlash=!0:(p.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.key===","&&n.keyCode===229||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(e.hint.enableSlash=!1,ae(["hint"],e))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!It(g)&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Process"&&(Pi(g,u,e),e.wysiwyg.preventKeyup=!0),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(p.KEYCODELIST[n.keyCode])||p.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&Ze(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&e.options.render.breadcrumb&&e.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&Ze(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(v.length>0){if(n.preventDefault(),n.stopPropagation(),ae(["select"],e),n.key==="ArrowDown"){const k=v[v.length-1];let _=ht(k);if(_)if(_.getBoundingClientRect().width===0){const A=Y(_,"fold","1");A?(_=ht(A),_?_=At(_):_=k):_=k}else _.getAttribute("fold")==="1"&&(_.classList.contains("sb")||_.classList.contains("bq"))||(_=At(_));else _=k;_.classList.add("protyle-wysiwyg--select"),Yt([_.getAttribute("data-node-id")]);const E=_.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),te(_)}else if(n.key==="ArrowUp"){let k=We(v[0]);if(k){if(k=yt(k),k.getBoundingClientRect().width===0){const _=Y(k,"fold","1");_?k=At(_):k=v[0]}else if(k){const _=Y(k,"fold","1");_&&(_.classList.contains("sb")||_.classList.contains("bq"))&&(k=_)}}else if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const _=ct(e.title.editElement,u,!1);_.collapse(!1),X(_),n.stopPropagation(),n.preventDefault()}else e.contentElement.scrollTop!==0?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):k=v[0];if(k){k.classList.add("protyle-wysiwyg--select"),Yt([k.getAttribute("data-node-id")]);const _=k.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;_<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+_,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),te(k)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&Ze(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),ae(["select"],e),g&&oe(g)&&u.endContainer.nodeType===1&&u.endContainer.classList.contains("protyle-attr")&&u.collapse(!0),!1;if(ne(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return v.length>0?at(e,v[0]):g.parentElement.getAttribute("data-type")==="NodeListItem"?g.parentElement.childElementCount>3?at(e,g.parentElement):at(e,g):g.getAttribute("data-type")==="NodeHeading"?at(e,g):at(e,Ve(g)),n.stopPropagation(),n.preventDefault(),!1}if(ne(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");v.length>0?at(e,v[0],!0):g.parentElement.getAttribute("data-type")==="NodeListItem"?g.parentElement.childElementCount>3?at(e,g.parentElement,!0):at(e,g,!0):g.getAttribute("data-type")==="NodeHeading"?at(e,g,!0):at(e,Ve(g),!0),n.stopPropagation(),n.preventDefault();return}if(ne(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){Rd({protyle:e,event:n,nodeElement:g,editorElement:t,range:u,cb(v){const k=v[0].previousElementSibling;if(k&&k.getAttribute("data-node-id")){k.classList.add("protyle-wysiwyg--select"),v.forEach(E=>{E.removeAttribute("select-end")}),k.setAttribute("select-end","true");const _=k.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;_<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+_,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else v[0].parentElement.classList.contains("protyle-wysiwyg")||(ae(["select"],e),v[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(ne(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){Bd({protyle:e,event:n,nodeElement:g,editorElement:t,range:u,cb(v){const k=v[v.length-1],_=k.nextElementSibling;if(_&&_.getAttribute("data-node-id")){_.classList.add("protyle-wysiwyg--select"),v.forEach(A=>{A.removeAttribute("select-end")}),_.setAttribute("select-end","true");const E=_.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else k.parentElement.classList.contains("protyle-wysiwyg")||(ae(["select"],e),k.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(ne("\u21E7\u2191",n)){Rd({protyle:e,event:n,nodeElement:g,editorElement:t,range:u,cb(v){const k=Ud(v);if(k.startElement.getBoundingClientRect().top>=k.endElement.getBoundingClientRect().top){const _=k.endElement.previousElementSibling;if(_&&_.getAttribute("data-node-id")){_.classList.add("protyle-wysiwyg--select"),_.setAttribute("select-end","true"),k.endElement.removeAttribute("select-end");const E=_.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;E<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else k.endElement.parentElement.classList.contains("protyle-wysiwyg")||(ae(["select"],e),k.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{k.endElement.classList.remove("protyle-wysiwyg--select"),k.endElement.removeAttribute("select-end");const _=We(k.endElement);_&&(_.setAttribute("select-end","true"),_.getBoundingClientRect().top<=e.contentElement.getBoundingClientRect().top&&(fn(e),_.scrollIntoView(!0)))}}});return}if(ne("\u21E7\u2193",n)){Bd({protyle:e,event:n,nodeElement:g,editorElement:t,range:u,cb(v){const k=Ud(v);if(k.startElement.getBoundingClientRect().top<=k.endElement.getBoundingClientRect().top){const _=k.endElement.nextElementSibling;if(_&&_.getAttribute("data-node-id"))if(_.getBoundingClientRect().width===0)ae(["select"],e),k.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{_.classList.add("protyle-wysiwyg--select"),_.setAttribute("select-end","true"),k.endElement.removeAttribute("select-end");const E=_.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;E>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+E,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else k.endElement.parentElement.classList.contains("protyle-wysiwyg")||(ae(["select"],e),k.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{k.endElement.classList.remove("protyle-wysiwyg--select"),k.endElement.removeAttribute("select-end");const _=ht(k.endElement);_&&(_.setAttribute("select-end","true"),_.getBoundingClientRect().bottom>=e.contentElement.getBoundingClientRect().bottom&&(fn(e),_.scrollIntoView(!1)))}}});return}if(ne(window.siyuan.config.keymap.general.enter.custom,n)){Qo({protyle:e,command:"enter",previousRange:u}),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.general.enterBack.custom,n)){Qo({protyle:e,command:"enterBack",previousRange:u}),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&Ze(n)&&(n.key==="Home"||n.key==="End")&&$t()||n.shiftKey&&!n.altKey&&Lt(n)&&(n.key==="Home"||n.key==="End")&&!$t()){const v=Y(g,"data-node-id",null);if(v){v.querySelectorAll(".protyle-wysiwyg--select").forEach(_=>{_.classList.remove("protyle-wysiwyg--select")}),v.classList.add("protyle-wysiwyg--select");let k=n.key==="Home"?v.previousElementSibling:v.nextElementSibling;for(;k;)k.classList.add("protyle-wysiwyg--select"),k=n.key==="Home"?k.previousElementSibling:k.nextElementSibling;n.key==="Home"?e.wysiwyg.element.firstElementChild.scrollIntoView():e.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if((n.key==="Home"||n.key==="End")&&!n.shiftKey&&!n.altKey&&Ze(n)&&ae(["hint"],e),!n.altKey&&!n.shiftKey&&Ze(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight+60,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight-60,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const v=e.contentElement.getBoundingClientRect();let k=document.elementFromPoint(v.x+v.width/2,v.y+v.height/2);k.classList.contains("protyle-wysiwyg")&&(k=document.elementFromPoint(v.x+v.width/2,v.y+v.height/2+p.SIZE_TOOLBAR_HEIGHT));const _=F(k);_&&_!==g&&te(_,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&Ze(n)||n.key==="Enter")&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(n,e))return;if(ne("\u2318/",n)){n.stopPropagation(),n.preventDefault();const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(v.length===0){const _=O(u.startContainer,"data-type",null);if(_&&_.tagName==="SPAN"){const E=_.getAttribute("data-type").split(" ");if(E.length>0&&(e.toolbar.range=u,kd(_)),E.includes("block-ref")){yo(e,_);return}else if(E.includes("inline-memo")){e.toolbar.showRender(e,_);return}else if(E.includes("file-annotation-ref")){bo(e,_);return}else if(E.includes("a")){ri(e,_);return}else if(E.includes("tag")){ho(e,_);return}}if(u.startOffset===0&&u.startContainer.nodeType===3){const E=st(u.startContainer);if(E&&E.nodeType!==3&&((a=E.getAttribute("data-type"))==null?void 0:a.indexOf("inline-math"))>-1){zs(e,E);return}else if(!E&&u.startContainer.parentElement.previousSibling&&u.startContainer.parentElement.previousSibling===u.startContainer.parentElement.previousElementSibling&&((s=u.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1){zs(e,u.startContainer.parentElement.previousElementSibling);return}}v.push(g)}v.length===1?e.gutter.renderMenu(e,v[0]):e.gutter.renderMultipleMenu(e,v);const k=g.getBoundingClientRect();window.siyuan.menus.menu.popup({x:k.left,y:k.top,isLeft:!0});return}if(eg(e,n,u)){n.preventDefault();return}const b=u.toString();if(!n.altKey&&!n.shiftKey&&Ze(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const v=U(u.startContainer,"TD")||U(u.startContainer,"TH"),k=v||oe(g)||g,_=et(k,e.wysiwyg.element,u);if(g.classList.contains("code-block")&&_.end===k.innerText.length&&(_.end-=1),n.key==="ArrowDown"&&(k==null?void 0:k.innerText.trimRight().substr(_.start).indexOf(`
`))===-1&&(v&&!v.parentElement.nextElementSibling&&g.getAttribute("data-type")==="NodeTable"&&!ht(g)||g.getAttribute("data-type")==="NodeCodeBlock"&&!ht(g)||g.parentElement.getAttribute("data-type")==="NodeBlockquote"&&g.nextElementSibling.classList.contains("protyle-attr")&&!ht(g.parentElement)))g.parentElement.getAttribute("data-type")==="NodeBlockquote"?an(e,"afterend",g.parentElement.getAttribute("data-node-id")):an(e,"afterend",g.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const E=oe(e.wysiwyg.element.firstElementChild);if(!We(g)&&g.contains(E)||!E&&g===e.wysiwyg.element.firstElementChild){if(Pn(k,u).top-k.getBoundingClientRect().top<20||g.classList.contains("av"))if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const A=ct(e.title.editElement,u,!1);A.collapse(!1),X(A),n.stopPropagation(),n.preventDefault()}else e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8}else if(((k==null?void 0:k.innerText.substr(0,_.end).indexOf(`
`))===-1||_.start===0)&&Pn(k,u).top-k.getBoundingClientRect().top<20){let A=We(g);if(A&&(A=yt(A),A)){const x=Y(A,"fold","1");if(!x&&A.classList.contains("code-block"))te(A,void 0,!1),Oe(e,A),n.stopPropagation(),n.preventDefault();else if(x)x.scrollTop=0,te(x,void 0,!0),Oe(e,x),n.stopPropagation(),n.preventDefault();else{const I=oe(A);if(I&&((i=I.lastChild)==null?void 0:i.nodeType)===3&&((o=I.lastChild)!=null&&o.textContent.endsWith(`
`))){te(A,void 0,!1),n.preventDefault(),n.stopPropagation();return}}}}}else if(b===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&g===yt(e.wysiwyg.element.lastElementChild)&&!U(u.startContainer,"TD")&&!U(u.startContainer,"TH")){const E=oe(g);E&&!E.querySelector(".emoji")&&E.textContent.replace(/\n$/,"").length<=et(E,void 0,u).end&&(n.stopPropagation(),n.preventDefault(),X(u))}else if(b===""&&n.key==="ArrowLeft"&&g===At(e.wysiwyg.element.firstElementChild)){const E=oe(g);E&&et(E,void 0,u).start===0&&(n.stopPropagation(),n.preventDefault(),X(u))}if(n.key==="ArrowDown"){if((k==null?void 0:k.innerText.trimRight().substr(_.start).indexOf(`
`))===-1&&g===e.wysiwyg.element.lastElementChild){ct(oe(k),u,!1),u.collapse(!1),n.stopPropagation(),n.preventDefault();return}const E=O(u.startContainer,"fold","1");if(E){let A=ht(E);A&&(A.getAttribute("fold")==="1"&&(A.classList.contains("sb")||A.classList.contains("bq"))||(A=At(A)),te(A),Oe(e,A)),n.stopPropagation(),n.preventDefault()}else if((k==null?void 0:k.innerText.substr(_.end).indexOf(`
`))===-1||_.end>=k.innerText.trimEnd().length){u.collapse(!1);const A=ht(g);A&&(A.getAttribute("fold")==="1"||A.classList.contains("code-block"))&&k.getBoundingClientRect().bottom-Pn(g,u).top<40&&(te(A),Oe(e,A),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||ne("\u2303D",n)){if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){bn(e,g,u,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}if(b===""&&n.key==="Backspace"&&u.startOffset===u.startContainer.textContent.length&&u.startContainer.textContent.endsWith(`
`+p.ZWSP)){u.setStart(u.startContainer,u.startOffset-1),u.collapse(!0),n.stopPropagation(),n.preventDefault();return}const v=st(u.startContainer);if(u.startOffset===1&&u.startContainer.textContent===p.ZWSP&&v&&v.nodeType!==3&&n.key==="Backspace"){if(v.classList.contains("img"))v.classList.add("img--select");else if(((l=v.getAttribute("data-type"))==null?void 0:l.indexOf("inline-math"))>-1){v.after(document.createElement("wbr"));const E=g.outerHTML;u.startContainer.textContent="",v.remove(),Q(e,g.getAttribute("data-node-id"),g.outerHTML,E),fe(g,u),n.stopPropagation(),n.preventDefault();return}}const k=oe(g),_=e.wysiwyg.element.querySelector(".img--select");if(_){if(_.classList.remove("img--select"),g.contains(_)){vo(_,g,u,e),n.stopPropagation(),n.preventDefault();return}}else if(b===""){if(g.classList.contains("table")&&g.querySelector(".table__select").clientHeight>0){yd(e,g),n.stopPropagation(),n.preventDefault();return}if(!k){g.classList.add("protyle-wysiwyg--select"),bn(e,g,u,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}const E=et(k,e.wysiwyg.element,u);if(n.key==="Delete"||ne("\u2303D",n)){if(u.startOffset===0&&u.startContainer.textContent.length===1){const A=st(u.startContainer),x=qe(u.startContainer);if(A&&A.nodeType===1&&A.classList.contains("img")&&x&&x.nodeType===1&&x.classList.contains("img")){const I=document.createElement("wbr");u.insertNode(I);const T=g.outerHTML;I.nextSibling.textContent=p.ZWSP,Q(e,g.getAttribute("data-node-id"),g.outerHTML,T),fe(g,u),n.preventDefault();return}if(E.start===0&&u.startContainer.textContent!==p.ZWSP&&!A&&x&&x.nodeType===1&&x.classList.contains("img")){const I=document.createElement("wbr");u.insertNode(I);const T=g.outerHTML;I.nextSibling.textContent=p.ZWSP,Q(e,g.getAttribute("data-node-id"),g.outerHTML,T),fe(g,u),n.preventDefault();return}}if(ya(u)||k.textContent.substring(E.start)===`
`){const A=u.cloneRange(),x=ht(Ve(g));if(x){const I=te(x);if(I){const T=F(I.startContainer);T&&(!T.classList.contains("code-block")||T.classList.contains("code-block")&&oe(T).textContent==`
`||T.parentElement.classList.contains("li"))&&(A.insertNode(document.createElement("wbr")),bn(e,T,I,"Delete"))}n.stopPropagation(),n.preventDefault();return}}else if(E.end===k.innerText.length-1&&g.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}else{let A=qe(u.startContainer);if(A){if(A.nodeType===3&&A.textContent===p.ZWSP){if(!A.nextSibling){const x=ht(g);x&&bn(e,x,u,"remove"),n.stopPropagation(),n.preventDefault();return}A=A.nextSibling}if(A.nodeType===1&&A.classList.contains("img")&&et(u.startContainer,e.wysiwyg.element,u).start===u.startContainer.textContent.length){vo(A,g,u,e),n.stopPropagation(),n.preventDefault();return}}}}else{const A=u.startContainer.childNodes[u.startOffset-1];if(E.start===0&&(u.startOffset===0||A&&A.nodeType===3&&!st(A)&&A.textContent==="")){(!g.classList.contains("code-block")||g.classList.contains("code-block")&&(k.textContent==`
`||g.parentElement.classList.contains("li")))&&bn(e,g,u,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(u.startContainer.nodeType!==3&&g.getAttribute("data-type")==="NodeTable"&&((r=u.startContainer.children[u.startOffset-1])==null?void 0:r.tagName)==="TABLE"){g.classList.add("protyle-wysiwyg--select"),bn(e,g,u,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(A&&A.nodeType!==3&&A.classList.contains("img")){vo(A,g,u,e),n.stopPropagation(),n.preventDefault();return}const x=qe(u.startContainer);if(x&&x.nodeType===1&&["code","tag","kbd"].includes(x.dataset.type)&&(E.start===1||u.startContainer.textContent.slice(-2,-1)===`
`)&&(u.insertNode(document.createTextNode(p.ZWSP)),u.collapse(!0)),u.startOffset===1&&u.startContainer.textContent.length===1){const T=st(u.startContainer);if(T&&T.nodeType===1&&T.classList.contains("img")&&x&&x.nodeType===1&&x.classList.contains("img")){const q=document.createElement("wbr");u.insertNode(q);const z=g.outerHTML;q.previousSibling.textContent=p.ZWSP,Q(e,g.getAttribute("data-node-id"),g.outerHTML,z),fe(g,u),n.preventDefault();return}if(E.start===1&&u.startContainer.textContent!==p.ZWSP&&!T&&x&&x.nodeType===1&&x.classList.contains("img")){const q=document.createElement("wbr");u.insertNode(q);const z=g.outerHTML;q.previousSibling.textContent=p.ZWSP,Q(e,g.getAttribute("data-node-id"),g.outerHTML,z),fe(g,u),n.preventDefault();return}}if(g.classList.contains("code-block")&&Lt(n)&&u.startContainer.nodeType===3&&u.startContainer.textContent.substring(u.startOffset-1,u.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const I=U(u.startContainer,"SPAN");if(E.start===2&&I&&et(I,e.wysiwyg.element,u).start===1&&I.innerText.startsWith(p.ZWSP)&&I.innerText!==p.ZWSP&&k.innerText.startsWith(p.ZWSP)){te(g),n.stopPropagation(),n.preventDefault();return}if(E.start===1&&!I&&k.innerText.startsWith(p.ZWSP)&&k.innerText.length>1){Ha(k,u),bn(e,g,u,"Backspace"),n.stopPropagation(),n.preventDefault();return}}}else if(g.classList.contains("code-block")&&k.textContent===`
`){u.collapse(!0),n.stopPropagation(),n.preventDefault();return}else if(b!==""){const E=et(k,e.wysiwyg.element,u);if(u.startOffset===0&&u.endContainer.textContent.length===u.endOffset){const A=st(u.startContainer),x=qe(u.endContainer);if(A&&A.nodeType===1&&A.classList.contains("img")&&x&&x.nodeType===1&&x.classList.contains("img")||E.start===0&&u.startContainer.textContent!==p.ZWSP&&!A&&x&&x.nodeType===1&&x.classList.contains("img")){u.insertNode(document.createElement("wbr"));const I=g.outerHTML;u.deleteContents(),u.insertNode(document.createTextNode(p.ZWSP)),u.insertNode(document.createElement("wbr")),Q(e,g.getAttribute("data-node-id"),g.outerHTML,I),fe(g,u),n.preventDefault();return}}}}if(ne("\u21E7\u21A9",n)&&b===""&&$d(u,g,e)){n.stopPropagation(),n.preventDefault();return}if(ne("\u2325\u21A9",n)&&b===""){const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(v.length===0&&v.push(g),v.length>0&&!Ol("\u2325\u21A9")){if(v.find(_=>!_.classList.contains("code-block")))Qg(e,g,u);else{const _=[];v.forEach(E=>{_.push(E.querySelector(".protyle-action__language"))}),e.toolbar.showCodeLanguage(e,_)}n.stopPropagation(),n.preventDefault();return}}if(ne("\u21A9",n)){gg(g,u,e),n.stopPropagation(),n.preventDefault();return}if(ne("\u2318A",n))return n.preventDefault(),Il(e,g,u),!0;if(ne(window.siyuan.config.keymap.editor.general.undo.custom,n)){e.undo.undo(e),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.general.redo.custom,n)){e.undo.redo(e),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.general.copyText.custom,n)){if(b!=="")yu(u,v=>{He(`${v.trim()} ((${g.getAttribute("data-node-id")} "*"))`)});else{const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");v.length>0?(v[0].setAttribute("data-reftext","true"),X(ye(g)),document.execCommand("copy")):He(`((${g.getAttribute("data-node-id")} "*"))`)}return n.preventDefault(),n.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.general.attr.custom,n)){const v=Ve(g);if(b===""){const k=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let _;k.length===1?_=k[0]:_=v,ta(_,"bookmark",e)}else yu(u,k=>{const _=v.outerHTML,E=v.lastElementChild.querySelector(".protyle-attr--name");E?E.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${k.trim()}`:v.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${k.trim()}</div>`),v.setAttribute("name",k.trim()),Q(e,v.getAttribute("data-node-id"),v.outerHTML,_)});return n.preventDefault(),n.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!e.disabled){b===""?L("/api/block/getDocInfo",{id:e.block.rootID},v=>{hd({notebookId:e.notebookId,path:e.path,name:v.data.ial.title,range:u,type:"file"})}):L("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:gn(b)}),n.preventDefault(),n.stopPropagation();return}const w=ne(window.siyuan.config.keymap.editor.general.newNameFile.custom,n);if(w||ne(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!b.trim()&&(g.querySelector("tr")||g.querySelector("span"))||(!b.trim()&&oe(g).textContent&&Il(e,g,u),w?L("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.path},v=>{Gd(e,b,g,v.data,e.notebookId)}):uo(e.path,e.notebookId,(v,k)=>{Gd(e,b,g,v,k)})),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){sg(e),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const v=g.querySelectorAll(".img--select");if(v.length>0)Yd(e,g,Array.from(v),g.getAttribute("data-node-id"),g.outerHTML);else{let k=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));k.length===0&&(k=[g]),Aa(k,e,_=>{_.classList.contains("av")?_.style.justifyContent="":_.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(ne(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const v=g.querySelectorAll(".img--select");if(v.length>0)Fd(e,g,Array.from(v),g.getAttribute("data-node-id"),g.outerHTML);else{let k=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));k.length===0&&(k=[g]),Aa(k,e,_=>{_.classList.contains("av")?_.style.justifyContent="center":_.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(ne(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[g]),Aa(v,e,k=>{k.classList.contains("av")?k.style.justifyContent="flex-end":k.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(ne(window.siyuan.config.keymap.editor.general.rtl.custom,n)){let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[g]),Aa(v,e,k=>{k.style.direction="rtl"}),n.stopPropagation(),n.preventDefault();return}if(ne(window.siyuan.config.keymap.editor.general.ltr.custom,n)){let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[g]),Aa(v,e,k=>{k.style.direction="ltr"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){if(n.repeat){const v=C(u.startContainer,"card__main",!0);v&&document.activeElement&&document.activeElement.classList.contains("protyle-wysiwyg")&&(v.querySelector(".card__action:not(.fn__none) button:not([disabled])").focus(),ae(["select"],e))}else!e.toolbar.element.classList.contains("fn__none")||!e.hint.element.classList.contains("fn__none")||!e.toolbar.subElement.classList.contains("fn__none")?(ae(["toolbar","hint","util"],e),e.hint.enableExtend=!1):window.siyuan.menus.menu.element.classList.contains("fn__none")?g.classList.contains("protyle-wysiwyg--select")?(ae(["select"],e),Yt([],e.block.rootID)):(ae(["select"],e),u.collapse(!1),g.classList.add("protyle-wysiwyg--select"),Yt([g.getAttribute("data-node-id")],e.block.rootID)):window.siyuan.menus.menu.remove(!0);n.stopPropagation(),n.preventDefault();return}if(ne(window.siyuan.config.keymap.editor.heading.paragraph.custom,n)){const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(v.length===0&&v.push(g),v.length>1)kn({protyle:e,nodeElement:v[0],type:"Blocks2Ps"});else{const k=v[0].getAttribute("data-type");k==="NodeHeading"?kn({protyle:e,nodeElement:v[0],type:"Blocks2Ps"}):k==="NodeList"?wi({protyle:e,nodeElement:v[0],id:v[0].getAttribute("data-node-id"),type:"CancelList"}):k==="NodeBlockquote"&&wi({protyle:e,nodeElement:v[0],id:v[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return n.preventDefault(),n.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return kn({protyle:e,nodeElement:g,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return kn({protyle:e,nodeElement:g,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return kn({protyle:e,nodeElement:g,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return kn({protyle:e,nodeElement:g,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return kn({protyle:e,nodeElement:g,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return kn({protyle:e,nodeElement:g,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading","NodeTable"].includes(g.getAttribute("data-type"))){const v=oe(g);if(v){const k=g.getAttribute("data-node-id"),_=g.outerHTML;v.innerHTML="```"+window.siyuan.storage[p.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(v.textContent)+"<wbr>\n```";const E=e.lute.SpinBlockDOM(g.outerHTML);g.outerHTML=E;const A=e.wysiwyg.element.querySelector(`[data-node-id="${k}"]`);return Q(e,k,E,_),Re(A),n.preventDefault(),n.stopPropagation(),!0}}if(ne(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){e.toolbar.range=u;const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b===""&&v.length===0&&v.push(g),zt(e,v),n.stopPropagation(),n.preventDefault();return}if(!g.classList.contains("code-block")&&!n.repeat&&!de(g)){let v=!1;if(e.options.toolbar.find(k=>{if(!k.hotkey)return!1;if(ne(k.hotkey,n))return e.toolbar.range=u,["block-ref"].includes(k.name)&&e.toolbar.range.toString()===""||(v=!0,["a","block-ref","inline-math","inline-memo","text"].includes(k.name)?e.toolbar.element.querySelector(`[data-type="${k.name}"]`).dispatchEvent(new CustomEvent("click")):p.INLINE_TYPE.includes(k.name)?e.toolbar.setInlineMark(e,k.name,"range"):k.click&&k.click(e.getInstance())),!0}),v)return n.preventDefault(),n.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if(ne(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(v.length>0){let k=!0;return v.forEach((_,E)=>{_.nextElementSibling&&v[E+1]&&v[E+1]!==_.nextElementSibling&&(k=!1)}),k&&(v[0].classList.contains("li")||v[0].parentElement.classList.contains("li"))&&di(e,Array.from(v),u),n.preventDefault(),n.stopPropagation(),!0}else if(g.parentElement.classList.contains("li")&&g.getAttribute("data-type")!=="NodeCodeBlock")return di(e,[g.parentElement],u),n.preventDefault(),n.stopPropagation(),!0}if(ne(window.siyuan.config.keymap.editor.list.indent.custom,n)){const v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(v.length>0){let k=!0;return v.forEach((_,E)=>{_.nextElementSibling&&v[E+1]&&v[E+1]!==_.nextElementSibling&&(k=!1)}),k&&(v[0].classList.contains("li")||v[0].parentElement.classList.contains("li"))&&Ks(e,Array.from(v),u),n.preventDefault(),n.stopPropagation(),!0}else if(g.parentElement.classList.contains("li")&&g.getAttribute("data-type")!=="NodeCodeBlock")return Ks(e,[g.parentElement],u),n.preventDefault(),n.stopPropagation(),!0}const h=ne(window.siyuan.config.keymap.editor.insert.list.custom,n),S=ne(window.siyuan.config.keymap.editor.insert.check.custom,n),$=ne(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,n),D=ne(window.siyuan.config.keymap.editor.insert.quote.custom,n);if(h||$||S||D){const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(v.length===0&&v.push(g),v.length===1){const k=v[0].dataset.subtype,_=v[0].dataset.type;if(D)["NodeHeading","NodeParagraph","NodeList"].includes(_)?_n({protyle:e,selectsElement:v,type:"Blocks2Blockquote"}):(e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(">"+Lute.Caret,e));else if(_==="NodeParagraph")_n({protyle:e,selectsElement:v,type:S?"Blocks2TLs":h?"Blocks2ULs":"Blocks2OLs"});else if(_==="NodeList"){const E=v[0].dataset.nodeId;k==="o"&&(h||S)?wi({protyle:e,nodeElement:v[0],id:E,type:S?"UL2TL":"OL2UL"}):k==="t"&&(h||$)?wi({protyle:e,nodeElement:v[0],id:E,type:h?"TL2UL":"TL2OL"}):k==="u"&&(S||$)&&wi({protyle:e,nodeElement:v[0],id:E,type:S?"OL2TL":"UL2OL"})}else e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill((S?"- [ ] ":h?"- ":"1. ")+Lute.Caret,e)}else{let k=!1,_=!1;v.find((E,A)=>{if(E.classList.contains("li"))return k=!0,!0;if(E.nextElementSibling&&v[A+1]&&E.nextElementSibling===v[A+1])_=!0;else if(A!==v.length-1)return _=!1,!0}),!k&&_&&_n({protyle:e,selectsElement:v,type:D?"Blocks2Blockquote":S?"Blocks2TLs":h?"Blocks2ULs":"Blocks2OLs"})}n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.insert.table.custom,n)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,e),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const v=O(u.startContainer,"data-subtype","t");if(!v)return;const k=v.outerHTML;v.classList.contains("protyle-task--done")?(v.querySelector("use").setAttribute("xlink:href","#iconUncheck"),v.classList.remove("protyle-task--done")):(v.querySelector("use").setAttribute("xlink:href","#iconCheck"),v.classList.add("protyle-task--done")),v.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,v.getAttribute("data-node-id"),v.outerHTML,k),n.preventDefault(),n.stopPropagation();return}if(ne(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return(d=g.querySelector(".img--select"))==null||d.classList.remove("img--select"),an(e,"beforebegin"),n.preventDefault(),!0;if(ne(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return(c=g.querySelector(".img--select"))==null||c.classList.remove("img--select"),an(e,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return ci(e,g,"next"),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.jumpToParent.custom,n))return ci(e,g,"parent"),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,n))return ci(e,g,"previous"),n.preventDefault(),n.stopPropagation(),!0;if(ne(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),Cd(e,g,u);return}if(ne(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),Td(e,g,u);return}if(ne(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(v.length===1&&v[0].getAttribute("data-type")==="NodeSuperBlock"){if(v[0].getAttribute("data-sb-layout")==="col"){const k=v[0].outerHTML;v[0].setAttribute("data-sb-layout","row"),v[0].setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,v[0].getAttribute("data-node-id"),v[0].outerHTML,k)}else{u.insertNode(document.createElement("wbr"));const k=yield Ea(e,v[0]);B(e,k.doOperations,k.undoOperations),fe(e.wysiwyg.element,u)}return}if(v.length<2||(f=v[0])!=null&&f.classList.contains("li"))return;_n({protyle:e,selectsElement:v,type:"BlocksMergeSuperBlock",level:"row"});return}if(ne(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(v.length===1&&v[0].getAttribute("data-type")==="NodeSuperBlock"){if(v[0].getAttribute("data-sb-layout")==="row"){const k=v[0].outerHTML;v[0].setAttribute("data-sb-layout","col"),v[0].setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(e,v[0].getAttribute("data-node-id"),v[0].outerHTML,k)}else{u.insertNode(document.createElement("wbr"));const k=yield Ea(e,v[0]);B(e,k.doOperations,k.undoOperations),fe(e.wysiwyg.element,u)}return}if(v.length<2||(m=v[0])!=null&&m.classList.contains("li"))return;_n({protyle:e,selectsElement:v,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&ne(window.siyuan.config.keymap.editor.general.ai.custom,n)){n.preventDefault(),n.stopPropagation();let v=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));v.length===0&&(v=[g]),Xo(v,e);return}if(!n.repeat&&ne(window.siyuan.config.keymap.editor.general.aiWriting.custom,n)){n.preventDefault(),n.stopPropagation(),gu(e,g);return}if(!n.repeat&&ne(window.siyuan.config.keymap.editor.general.openInNewTab.custom,n)){n.preventDefault(),n.stopPropagation();const v=window.siyuan.blockPanels.find(_=>{if(_.element.contains(g))return!0}),k=g.getAttribute("data-node-id");Jn(k,(_,E)=>{openFileById({app:e.app,id:k,action:E,zoomIn:_,openNewTab:!0}),v.destroy()});return}if(n.key==="Tab"&&Ze(n)&&!n.altKey){n.preventDefault();const v=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(g.getAttribute("data-type")==="NodeCodeBlock"&&b!==""){!qe(u.endContainer)&&u.endContainer.textContent.endsWith(`
`)&&u.endOffset>0&&u.setEnd(u.endContainer,u.endOffset-1);const k=document.createElement("wbr");u.insertNode(k),u.setStartAfter(k);const _=g.outerHTML;let E="";n.shiftKey?u.extractContents().textContent.split(`
`).forEach(I=>{I.startsWith(v)?E+=I.replace(v,"")+`
`:E+=I+`
`}):u.extractContents().textContent.split(`
`).forEach(I=>{E+=v+I+`
`});let A=g.querySelector(".protyle-action__language").textContent;if(u.commonAncestorContainer.nodeType===1){const I=u.commonAncestorContainer.className;I.startsWith("language-")&&(A=I.replace("language-",""),k.parentElement!==u.commonAncestorContainer&&(k.parentElement.after(k),k.previousElementSibling.remove()))}window.hljs.getLanguage(A)||(A="plaintext"),k.insertAdjacentHTML("afterend",window.hljs.highlight(E.substr(0,E.length-1),{language:A,ignoreIllegals:!0}).value+"<br>"),u.setStart(k.nextSibling,0);const x=k.parentElement.querySelector("br");ct(x.previousSibling,u,!1),x.remove(),Q(e,g.getAttribute("data-node-id"),g.outerHTML,_),k.remove();return}if(!n.shiftKey){const k=u.startContainer.parentElement,_=e.toolbar.getCurrentType(u);_.length>0&&u.toString()===""&&u.startOffset===0&&k.tagName==="SPAN"&&!st(u.startContainer)&&!st(k)?(u.setStartBefore(k),u.collapse(!0)):k.tagName==="SPAN"&&!_.includes("search-mark")&&!_.includes("code")&&!_.includes("kbd")&&!_.includes("tag")&&u.toString()===""&&u.startContainer.nodeType===3&&(_.includes("inline-memo")||_.includes("block-ref")||_.includes("file-annotation-ref")||_.includes("a"))&&!qe(u.startContainer)&&u.startContainer.textContent.length===u.startOffset&&(u.setEndAfter(k),u.collapse(!1));const E=document.createElement("wbr");u.insertNode(E);const A=g.outerHTML;return u.extractContents(),u.insertNode(document.createTextNode(v)),u.collapse(!1),X(u),E.remove(),Q(e,g.getAttribute("data-node-id"),g.outerHTML,A),!0}}if(n.key==="ContextMenu"){const v=Pn(g,u);e.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:g,y:v.top+8,x:v.left}})),n.preventDefault(),n.stopPropagation();return}if(ne("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),eu(e);return}if(ne(window.siyuan.config.keymap.editor.general.openBy.custom,n)){const v=O(u.startContainer,"data-type","a");if(v){ns(e,v.getAttribute("data-href"),void 0,!1),n.preventDefault(),n.stopPropagation();return}const k=O(u.startContainer,"data-type","file-annotation-ref");if(k){const E=`assets/${k.getAttribute("data-id").split("/")[1]}`;ns(e,E,void 0,!1),n.preventDefault(),n.stopPropagation();return}return}if(n.shiftKey&&(n.key==="ArrowLeft"||n.key==="ArrowRight")){if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(!u.toString()){if(n.key==="ArrowRight"&&ya(u)&&!Ol("\u2325\u21E7\u2192")){n.preventDefault(),n.stopPropagation();return}const k=oe(g);if(et(k,e.wysiwyg.element,u).start===0&&n.key==="ArrowLeft"&&!Ol("\u2325\u21E7\u2190")){n.preventDefault(),n.stopPropagation();return}}}if(Ze(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&ae(["select"],e),ne("\u2318B",n)||ne("\u2318I",n)||ne("\u2318U",n)){n.preventDefault(),n.stopPropagation();return}}))},wu=(e,t,n)=>{const a=P(),s=C(e.target,"protyle-attr--bookmark");if(s)return!a&&Lt(e)||(n?vn(n,"bookmark",t):ta(s.parentElement.parentElement,"bookmark",t)),e.stopPropagation(),!0;const i=C(e.target,"protyle-attr--name");if(i)return!a&&Lt(e)||(n?vn(n,"name",t):ta(i.parentElement.parentElement,"name",t)),e.stopPropagation(),!0;const o=C(e.target,"protyle-attr--av");if(o)return n?vn(n,"av",t):ta(o.parentElement.parentElement,"av",t),e.stopPropagation(),!0;const l=C(e.target,"protyle-attr--alias");if(l)return!a&&Lt(e)||(n?vn(n,"alias",t):ta(l.parentElement.parentElement,"alias",t)),e.stopPropagation(),!0;const r=C(e.target,"protyle-attr--memo");if(r)return!a&&Lt(e)||(n?vn(n,"memo",t):ta(r.parentElement.parentElement,"memo",t)),e.stopPropagation(),!0},py=()=>{var e;const t=document.getElementById("dragGhost");if(t){if(t.dataset.ghostType==="dock")t.parentElement.querySelectorAll(".dock__item").forEach(n=>{n.style.opacity=""}),(e=document.querySelector("#dockMoveItem"))==null||e.remove();else{const n=t.parentElement.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);n&&(n.style.opacity=""),t.parentElement.querySelectorAll(".dragover__top, .dragover__bottom, .dragover, .dragover__current").forEach(a=>{a.classList.remove("dragover__top","dragover__bottom","dragover","dragover__current"),a.style.opacity=""})}t.remove(),document.onmousemove=null,_u()}},Ot={},_u=()=>{Ot.animationId&&(cancelAnimationFrame(Ot.animationId),Ot.animationId=null,Ot.element=null,Ot.space=null,Ot.lastTime=null)},hu=e=>{Ot.lastTime||(Ot.lastTime=e-8),Ot.element.scroll({top:Ot.element.scrollTop+(e-Ot.lastTime)*Ot.space/64}),Ot.animationId=requestAnimationFrame(hu),Ot.lastTime=e},my=(e,t,n)=>{const a=e.clientY<t.top+Constants.SIZE_SCROLL_TB;a||e.clientY>t.bottom-Constants.SIZE_SCROLL_TB?(Ot.space=a?e.clientY-t.top-Constants.SIZE_SCROLL_TB:e.clientY-t.bottom+Constants.SIZE_SCROLL_TB,Ot.animationId||(Ot.element=n,Ot.animationId=requestAnimationFrame(hu))):_u()},vu=e=>{!window.siyuan.menus.menu.element.contains(e)&&!O(e,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove())},by=e=>{cancelDrag(),vu(e.target);const t=hasClosestByClassName(e.target,"protyle",!0);if(t){const a=t.querySelector(".protyle-wysiwyg");(a.getAttribute("data-readonly")==="true"||!a.contains(e.target))&&a.dispatchEvent(new Event("focusin"))}!hasTopClosestByClassName(e.target,"protyle-util")&&!hasTopClosestByClassName(e.target,"protyle-toolbar")&&document.querySelectorAll(".protyle-font").forEach(a=>{a.parentElement.classList.add("fn__none")});const n=hasTopClosestByClassName(e.target,"protyle-action__copy");if(n){let a=n.parentElement.nextElementSibling.textContent.replace(/\n$/,"");a=a.replace(/\u00A0/g," "),writeText(a),showMessage(window.siyuan.languages.copied,2e3),e.preventDefault();return}};var er=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class km{constructor(t){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),P()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(t),!t.options.action.includes(p.CB_GET_HISTORY)&&(this.bindEvent(t),Em(t,this.element),_m(t,this.element))}renderCustom(t){let n=t[p.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(t);for(let s=0;s<this.element.attributes.length;s++){const i=this.element.attributes[s].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)&&!a.includes(i)&&(this.element.removeAttribute(i),s--)}a.forEach(s=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(s)||this.element.setAttribute(s,t[s])})}escapeInline(t,n,a){if(!a.data&&a.inputType!=="insertLineBreak")return;const s=a.data;t.toolbar.range=n;const i=n.startContainer.parentElement,o=t.toolbar.getCurrentType();if(a.inputType==="insertLineBreak"){o.length>0&&n.toString()===""&&i.tagName==="SPAN"&&i.textContent.startsWith(`
`)&&n.startContainer.previousSibling&&n.startContainer.previousSibling.textContent===`
`&&i.before(n.startContainer.previousSibling);return}let l=s.length;if(s==="<"||s===">"?l=4:s==="&"&&(l=5),o.length>0&&n.toString()===""&&n.startOffset===s.length&&i.tagName==="SPAN"&&i.textContent.replace(p.ZWSP,"")!==s&&i.textContent.replace(p.ZWSP,"").length>=s.length&&!st(n.startContainer)&&!st(i)){const r=i.innerHTML.replace(p.ZWSP,"");i.innerHTML=r.substr(l);const d=document.createTextNode(s);i.before(d),n.selectNodeContents(d),n.collapse(!1);return}if(i.tagName==="SPAN"&&i.textContent!==s&&!o.includes("search-mark")&&!o.includes("code")&&!o.includes("kbd")&&!o.includes("tag")&&n.toString()===""&&n.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!qe(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&i.textContent.length>s.length){const r=et(i,t.wysiwyg.element,n),d=i.innerHTML;if(r.start===i.textContent.length){i.innerHTML=d.substr(0,d.length-l);const c=document.createTextNode(s);i.after(c),n.selectNodeContents(c),n.collapse(!1)}}}setEmptyOutline(t,n){let a=n;if(!n.getAttribute("data-node-id")){const s=F(n);if(!s)return;a=s}t.disabled&&(t.toolbar.range=ye(a))}emojiToMd(t){t.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(t){this.element.addEventListener("copy",n=>er(this,null,function*(){var a;if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"||n.target.localName==="input"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const s=ye(t.wysiwyg.element),i=F(s.startContainer);if(!i)return;const o=i.querySelector(".img--select"),l=i.querySelector(".av__row--select, .av__cell--select"),r=((a=i.querySelector(".table__select"))==null?void 0:a.clientWidth)>0;let d=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));d.length===0&&s.toString()===""&&!s.cloneContents().querySelector("img")&&!o&&!l&&!r&&(i.classList.add("protyle-wysiwyg--select"),Yt([i.getAttribute("data-node-id")]),d=[i]);let c="",f="",m=!1,u=!1;if(d.length>0){const g=d[0].getAttribute("data-reftext")==="true";d[0].getAttribute("data-type")==="NodeListItem"&&d[0].parentElement.classList.contains("list")&&d[0].parentElement.childElementCount-1===d.length&&(d.find(w=>{if(!d[0].parentElement.contains(w))return!0})||(d=[d[0].parentElement]));let y="";for(let b=0;b<d.length;b++){const w=d[b];if(g)c+=Qc(w)+`

`;else{let h="";w.getAttribute("data-type")==="NodeHeading"&&w.getAttribute("fold")==="1"?(u=!0,h=(yield he("/api/block/getHeadingChildrenDOM",{id:w.getAttribute("data-node-id"),removeFoldAttr:!1})).data):w.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&w.querySelector('[data-type="NodeHeading"][fold="1"]')?(u=!0,h=(yield he("/api/block/getBlockDOM",{id:w.getAttribute("data-node-id")})).data.dom):h=qs(w),w.getAttribute("data-type")==="NodeListItem"?(y||(y=`<div data-subtype="${w.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">`),y+=h,(b===d.length-1||d[b+1].getAttribute("data-type")!=="NodeListItem"||d[b+1].getAttribute("data-subtype")!==w.getAttribute("data-subtype"))&&(c+=`${y}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,y="")):c+=h}}g&&(c=c.slice(0,-2),d[0].removeAttribute("data-reftext"))}else if(l){const g=Array.from(i.querySelectorAll(".av__cell--active, .av__cell--select"))||[];g.length===0&&i.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(y=>{y.querySelectorAll(".av__cell").forEach(b=>{g.push(b)})}),g.length>0&&(c="[",g.forEach((y,b)=>{var w;const h=nl(y);(b===0||g[b-1]!==y.previousElementSibling&&!((w=y.previousElementSibling)!=null&&w.classList.contains("av__colsticky")&&!g[b-1].nextElementSibling&&g[b-1].parentElement===y.previousElementSibling))&&(c+="["),c+=JSON.stringify(ia(ln(y),y))+",",b===g.length-1||g[b+1]!==y.nextElementSibling&&!(!y.nextElementSibling&&y.parentElement.nextElementSibling===g[b+1])?(c=c.substring(0,c.length-1)+"],",f+=h+`
`):f+=h+"	"}),f=f.substring(0,f.length-1),c=c.substring(0,c.length-1)+"]")}else if(r){const g=[],y=i.firstElementChild.scrollLeft,b=i.querySelector("table").scrollTop,w=i.querySelector(".table__select");c="<table>",i.querySelectorAll("th, td").forEach(h=>{!h.classList.contains("fn__none")&&ea({tableSelectElement:w,scrollLeft:y,scrollTop:b,item:h})&&g.push(h)}),g.forEach((h,S)=>{(S===0||!h.previousElementSibling||h.previousElementSibling!==g[S-1])&&(c+="<tr>"),c+=h.outerHTML,(!h.nextElementSibling||!g[S+1]||h.nextElementSibling!==g[S+1])&&(c+="</tr>")}),c+="</table>",f=t.lute.HTML2Md(c)}else{const g=document.createElement("div"),y=t.toolbar.getCurrentType(s),b=U(s.startContainer,"SPAN"),w=O(s.startContainer,"data-type","NodeHeading"),h=w&&w.textContent.replace(p.ZWSP,"")===s.toString();if(y.length>0&&b&&b.textContent.replace(p.ZWSP,"")===s.toString()||h)h?(g.append(w.cloneNode(!0)),w.removeAttribute("fold")):["DIV","TD","TH","TR"].includes(s.startContainer.parentElement.tagName)?(g.append(s.cloneContents()),this.emojiToMd(g)):(g.append(s.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(g)),c=g.innerHTML,f=s.toString();else if(o)c=o.outerHTML,f=o.querySelector("img").getAttribute("data-src");else if(y.length>0&&s.startContainer.nodeType===3&&s.startContainer.parentElement.tagName==="SPAN"&&s.startContainer.parentElement===s.endContainer.parentElement){const S=s.startContainer.parentElement.attributes,$=document.createElement("span");for(let D=0;D<S.length;D++)$.setAttribute(S[D].name,S[D].value);$.getAttribute("data-type").indexOf("block-ref")>-1&&$.getAttribute("data-subtype")==="d"&&$.setAttribute("data-subtype","s"),$.textContent=s.toString(),c=$.outerHTML,f=s.toString()}else{g.append(s.cloneContents()),this.emojiToMd(g);const S=O(s.commonAncestorContainer,"data-type","inline-math");S?c=S.outerHTML:c=g.innerHTML,f=g.textContent,O(s.startContainer,"data-type","NodeCodeBlock")?(ya(s)&&(f=f.replace(/\n$/,"")),m=!0):U(s.startContainer,"TD")||U(s.startContainer,"TH")?(g.innerHTML=g.innerHTML.replace(/<br>/g,`
`).replace(/<br\/>/g,`
`),f=g.textContent.endsWith(`
`)?g.textContent.replace(/\n$/,""):g.textContent):U(s.startContainer,"CODE")||(f=s.toString())}}if(t.disabled&&(c=ig(c)),f=f||t.lute.BlockDOM2StdMd(c).trimEnd(),f=f.replace(/\u00A0/g," ").replace(new RegExp(p.ZWSP,"g"),""),n.clipboardData.setData("text/plain",f),!m){gs(t);const g=r?t.lute.HTML2BlockDOM(c):c;n.clipboardData.setData("text/siyuan",g),ki(t);const y=`<!--data-siyuan='${Hl(g)}'-->`+(r?c:t.lute.BlockDOM2HTML(l?f:c));if(n.clipboardData.setData("text/html",y),u)try{yield navigator.clipboard.write([new ClipboardItem({"text/plain":f,"text/html":y})])}catch(b){console.log("Copy write clipboard error:",b)}}})),this.element.addEventListener("mousedown",n=>{var a;if(t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),n.button===2)return;const s=document;s.onmouseup=null;let i=n.target,o=F(i);const l=this.element.querySelector(".protyle-wysiwyg--select"),r=C(i,"av__gallery-item");if(n.shiftKey){let I,T=o;if(getSelection().rangeCount>0&&(I=F(getSelection().getRangeAt(0).startContainer)),!l&&r){r.classList.add("av__gallery-item--select");let q=r.previousElementSibling,z=[];for(;q&&!q.classList.contains("av__gallery-item--select");)if(z.push(q),q=q.previousElementSibling,!q){z=[];break}q=r.nextElementSibling;let N=[];for(;q&&!q.classList.contains("av__gallery-item--select");)if(N.push(q),q=q.nextElementSibling,!q||q.classList.contains("av__gallery-add")){N=[];break}z.concat(N).forEach(R=>{R.classList.add("av__gallery-item--select")}),n.preventDefault()}else if(I&&T&&I!==T){let q=!0;const z=I.getBoundingClientRect(),N=T.getBoundingClientRect();let R=z.top,V=N.top;if(R===V&&(R=z.left,V=N.left),R>V){const ce=T;T=I,I=ce;const ve=V;V=R,R=ve,q=!1}let j=[],W=I,Se=!1;for(;W;)if(W&&!W.classList.contains("protyle-attr")){const ce=W.getBoundingClientRect();if(z.top===N.top?ce.left<=V:ce.top<=V)if(Se)if(W.nextElementSibling&&!W.nextElementSibling.classList.contains("protyle-attr")){const ve=W.nextElementSibling.getBoundingClientRect();if(z.top===N.top?ve.left<=V&&ve.bottom<=N.bottom:ve.top<=V)j=[W],W=W.nextElementSibling,Se=!1;else if(W.parentElement.classList.contains("sb"))W=F(W.parentElement),Se=!0;else break}else W=F(W.parentElement),Se=!0;else j.push(W),W=W.nextElementSibling;else if(W.parentElement.classList.contains("sb"))W=F(W.parentElement),Se=!0;else break}else W=F(W.parentElement),Se=!0;if(!(j.length===1&&!j[0].classList.contains("list")&&!j[0].classList.contains("bq")&&!j[0].classList.contains("sb"))){const ce=[];!l&&t.scroll&&!t.scroll.element.classList.contains("fn__none")&&!t.scroll.keepLazyLoad&&(I.getBoundingClientRect().top<-t.contentElement.clientHeight*2||T.getBoundingClientRect().bottom>t.contentElement.clientHeight*2)&&se(window.siyuan.languages.crossKeepLazyLoad),j.forEach(ve=>{C(W,"protyle-wysiwyg--select")||(ve.classList.add("protyle-wysiwyg--select"),ce.push(ve.getAttribute("data-node-id")),ve.querySelectorAll(".protyle-wysiwyg--select").forEach($e=>{$e.classList.remove("protyle-wysiwyg--select")}))}),Yt(ce),te(q?j[j.length-1]:j[0],t.wysiwyg.element,!1)}n.preventDefault()}return}if(Lt(n)&&!n.shiftKey&&!n.altKey){let I=o;if(!l&&r)r.classList.toggle("av__gallery-item--select");else if(I){const T=de(I);T&&(I=T),I=Ve(I),I.classList.contains("protyle-wysiwyg--select")?(I.classList.remove("protyle-wysiwyg--select"),I.removeAttribute("select-start"),I.removeAttribute("select-end")):I.classList.add("protyle-wysiwyg--select"),I.querySelectorAll(".protyle-wysiwyg--select").forEach(N=>{N.classList.remove("protyle-wysiwyg--select"),N.removeAttribute("select-start"),N.removeAttribute("select-end")});const q=C(I.parentElement,"protyle-wysiwyg--select");q&&(q.classList.remove("protyle-wysiwyg--select"),q.removeAttribute("select-start"),q.removeAttribute("select-end"));const z=[];t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(N=>{z.push(N.getAttribute("data-node-id"))}),Yt(z)}return}if(r&&!O(i,"data-type","av-gallery-more")){s.onmouseup=()=>(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,Et(["galleryItem"],t.wysiwyg.element),!1);return}const d=C(i,"av__drag-fill");if(ae(["select"],t),O(i,"data-type","av-gallery-more")?Et(["img","row","cell"],t.wysiwyg.element):!C(i,"av__firstcol")&&!d&&Et(["img","av"],t.wysiwyg.element),C(i,"protyle-action")&&!C(i,"code-block")||C(i,"av__cell--header")&&!C(i,"av__widthdrag"))return;const c=t.wysiwyg.element.getBoundingClientRect(),f=window.getComputedStyle(t.wysiwyg.element),m=c.left+(parseInt(f.paddingLeft)||24)+1,u=c.right-(parseInt(f.paddingRight)||16)-2,g=t.element.getBoundingClientRect(),y=g.bottom,b=n.clientY,w=t.contentElement.getBoundingClientRect();if(!t.disabled&&i.classList.contains("av__widthdrag")){if(!o)return;const I=o.getAttribute("data-av-id"),T=o.dataset.nodeId,q=i.parentElement,z=q.clientWidth,N=q.getAttribute("data-col-id");let R;const V=o.querySelector(".av__scroll");s.onmousemove=j=>{R=Math.max(z+(j.clientX-n.clientX),25),V.querySelectorAll(".av__row, .av__row--footer").forEach(W=>{W.querySelector(`[data-col-id="${N}"]`).style.width=R+"px"}),xa(o,w,"bottom")},s.onmouseup=()=>{if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,!R||R===z)return;const j=o.getAttribute(p.CUSTOM_SY_AV_VIEW);B(t,[{action:"setAttrViewColWidth",id:N,avID:I,data:R+"px",blockID:T,viewID:j}],[{action:"setAttrViewColWidth",id:N,avID:I,data:z+"px",blockID:T,viewID:j}])},this.preventClick=!0,n.preventDefault();return}if(!t.disabled&&d){if(!o)return;const I={};let T;const q=[];o.querySelectorAll(".av__cell--active").forEach(j=>{const W=C(j,"av__row");W&&(I[W.dataset.id]||(I[W.dataset.id]=[]),I[W.dataset.id].push(ia(ln(j),j)),T=j,q.push(j.dataset.id))});const z=ls(T),N=ls(o.querySelector(".av__cell--active"));let R,V;return s.onmousemove=j=>{const W=C(j.target,"av__cell");if(!(R&&W&&W===R)&&(R=W,R&&R.dataset.id)){const Se=ls(R);if(o.querySelectorAll(".av__cell--active").forEach(ce=>{q.includes(ce.dataset.id)||ce.classList.remove("av__cell--active")}),Se.celIndex!==z.celIndex){V=void 0;return}o.querySelectorAll(".av__row").forEach((ce,ve)=>{(Se.rowIndex<N.rowIndex&&ve>=Se.rowIndex&&ve<N.rowIndex||Se.rowIndex>z.rowIndex&&ve<=Se.rowIndex&&ve>z.rowIndex)&&ce.querySelectorAll(".av__cell").forEach(($e,Ce)=>{Ce>=N.celIndex&&Ce<=Se.celIndex&&($e.classList.add("av__cell--active"),V=$e)})})}},s.onmouseup=()=>{if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,V){Dp(t,o,I,q,T);const j=o.querySelectorAll(".av__cell--active");wn(j[j.length-1])}return!1},this.preventClick=!0,!1}const h=C(i,"av__cell");if(!t.disabled&&h&&h.dataset.id&&!de(h)){if(!o||o.dataset.avType!=="table")return;o.querySelectorAll(".av__cell--select").forEach(V=>{V.classList.remove("av__cell--select")}),o.querySelectorAll(".av__drag-fill").forEach(V=>{V.remove()}),h.classList.add("av__cell--select");const I=ls(h);let T,q;const z=o.getBoundingClientRect(),N=o.querySelector(".av__scroll"),R=C(h,"av__body");return s.onmousemove=V=>{const j=C(V.target,"av__cell");if(N.scrollWidth>N.clientWidth+2&&(V.clientX>z.right-10?N.scrollLeft+=10:V.clientX<z.left+34&&(N.scrollLeft-=10),V.clientY<w.top+48?t.contentElement.scrollTop-=5:V.clientY>w.bottom-48&&(t.contentElement.scrollTop+=5)),!(R!==C(j,"av__body")||T&&j&&j===T)&&j&&j.dataset.id&&(n.clientX!==V.clientX||n.clientY!==V.clientY)){const W=ls(j);o.querySelectorAll(".av__cell--active").forEach(Se=>{Se.classList.remove("av__cell--active")}),R.querySelectorAll(".av__row").forEach((Se,ce)=>{ce>=Math.min(I.rowIndex,W.rowIndex)&&ce<=Math.max(I.rowIndex,W.rowIndex)&&Se.querySelectorAll(".av__cell").forEach((ve,$e)=>{$e>=Math.min(I.celIndex,W.celIndex)&&$e<=Math.max(I.celIndex,W.celIndex)&&(ve.classList.add("av__cell--active"),q=ve)})}),T=j}},s.onmouseup=()=>(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,q&&(Vn(o.querySelector(".av__firstcol"),"unselectAll"),te(o),wn(q),this.preventClick=!0),!1),!1}if(!t.disabled&&i.classList.contains("protyle-action__drag")){if(!o)return;let I=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(o.getAttribute("data-type"))?(o.classList.add("iframe--drag"),(o.style.textAlign==="left"||o.style.textAlign==="right")&&(I=!1)):i.parentElement.parentElement.getAttribute("data-type")==="img"&&i.parentElement.parentElement.classList.add("img--drag");const T=o.getAttribute("data-node-id"),q=o.outerHTML,z=n.clientX,N=i.previousElementSibling,R=N.clientWidth,V=N.clientHeight,j=N.parentElement.parentElement;N.tagName==="IMG"&&Ba(j),s.onmousemove=W=>{if(N.tagName==="IMG"&&(N.style.height=""),W.clientX>z-R+8&&W.clientX<u){const Se=N.tagName==="IMG"&&!j.style.minWidth&&o.style.textAlign!=="center"||!I?1:2;N.tagName==="IMG"?N.parentElement.style.width=Math.max(17,R+(W.clientX-z)*Se)+"px":N.style.width=Math.max(17,R+(W.clientX-z)*Se)+"px"}N.tagName!=="IMG"&&W.clientY>b-V+8&&W.clientY<y&&(N.style.height=V+(W.clientY-b)+"px")},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,i.classList.contains("protyle-action__drag")&&o&&Q(t,T,o.outerHTML,q),o.classList.remove("iframe--drag"),i.parentElement.parentElement.classList.remove("img--drag")};return}let S;const $=U(i,"TH")||U(i,"TD");if($&&(i=$),(i.tagName==="TH"||i.tagName==="TD"||((a=i.firstElementChild)==null?void 0:a.tagName)==="TABLE"||i.classList.contains("table__resize")||i.classList.contains("table__select"))&&(S=o,S&&(S.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),ae(["toolbar"],t),i.classList.contains("table__select")&&(i=document.elementFromPoint(n.clientX,n.clientY),o=F(i)),n.stopPropagation())),!t.disabled&&i.classList.contains("table__resize")){if(!o)return;const I=o.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),o.firstElementChild.style.webkitUserModify="read-only",o.style.cursor="col-resize",i.removeAttribute("style");const T=o.getAttribute("data-node-id"),q=n.clientX,z=parseInt(i.getAttribute("data-col-index")),N=o.querySelectorAll("table col")[z];N.style.minWidth&&(N.style.width=o.querySelectorAll("table td, table th")[z].offsetWidth+"px",N.style.minWidth=""),o.querySelectorAll("tr").forEach(j=>{j.cells[z].style.width=""});const R=N.clientWidth,V=o.firstElementChild.clientWidth<o.firstElementChild.scrollWidth;s.onmousemove=j=>{o.style.textAlign==="center"&&!V?N.style.width=R+(j.clientX-q)*2+"px":N.style.width=R+(j.clientX-q)+"px"},s.onmouseup=()=>{o.firstElementChild.style.webkitUserModify="",o.style.cursor="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,o&&Q(t,T,o.outerHTML,I)};return}let D=n.clientX;n.clientX>u?D=u:n.clientX<m&&(D=m);const v=g.top+(t.options.render.breadcrumb?t.breadcrumb.element.parentElement.clientHeight:0);let k,_,E,A;this.element.querySelectorAll("iframe").forEach(I=>{I.style.pointerEvents="none"});const x=["IMG","VIDEO","AUDIO"].includes(i.tagName)||i.classList.contains("img");s.onmousemove=I=>{let T=I.target;if(S&&S.contains(T)&&!C(S,"protyle-wysiwyg__embed")){if(T.classList.contains("table__select")){T.classList.add("fn__none");const Ce=document.elementFromPoint(I.clientX,I.clientY);T.classList.remove("fn__none"),T=U(Ce,"TH")||U(Ce,"TD")}if(T&&T===i)return S.querySelector(".table__select").removeAttribute("style"),t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),_=T,!1;if(T&&(T.tagName==="TH"||T.tagName==="TD")&&(!_||_!==T)){S.firstElementChild.style.webkitUserModify="read-only";let Ce=i.offsetLeft+i.clientWidth-T.offsetLeft,ze=T.offsetLeft;i.offsetLeft===T.offsetLeft?Ce=Math.max(i.clientWidth,T.clientWidth):i.offsetLeft<T.offsetLeft&&(Ce=T.offsetLeft+T.clientWidth-i.offsetLeft,ze=i.offsetLeft);let Sn=i.offsetTop+i.clientHeight-T.offsetTop,Jt=T.offsetTop;i.offsetTop===T.offsetTop?Sn=Math.max(i.clientHeight,T.clientHeight):i.offsetTop<T.offsetTop&&(Sn=T.offsetTop+T.clientHeight-i.offsetTop,Jt=i.offsetTop),Array.from(S.querySelectorAll("th, td")).find(De=>{const Qt=De.offsetLeft<ze+Ce&&De.offsetLeft+De.clientWidth>ze+Ce,Da=De.offsetLeft<ze&&De.offsetLeft+De.clientWidth>ze;De.offsetTop<Jt&&De.offsetTop+De.clientHeight>Jt?((De.offsetLeft+6>ze&&De.offsetLeft+De.clientWidth-6<ze+Ce||Qt||Da)&&(Sn=Jt+Sn-De.offsetTop,Jt=De.offsetTop),Qt&&(Ce=De.offsetLeft+De.clientWidth-ze),Da&&(Ce=ze+Ce-De.offsetLeft,ze=De.offsetLeft)):De.offsetTop<Jt+Sn&&De.offsetTop+De.clientHeight>Jt+Sn?((De.offsetLeft+6>ze&&De.offsetLeft+De.clientWidth-6<ze+Ce||Qt||Da)&&(Sn=De.clientHeight+De.offsetTop-Jt),Qt&&(Ce=De.offsetLeft+De.clientWidth-ze),Da&&(Ce=ze+Ce-De.offsetLeft,ze=De.offsetLeft)):Da&&De.offsetTop+6>Jt&&De.offsetTop+De.clientHeight-6<Jt+Sn?(Ce=ze+Ce-De.offsetLeft,ze=De.offsetLeft):Qt&&De.offsetTop+6>Jt&&De.offsetTop+De.clientHeight-6<Jt+Sn&&(Ce=De.offsetLeft+De.clientWidth-ze)}),t.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),S.querySelector(".table__select").setAttribute("style",`left:${ze-S.firstElementChild.scrollLeft}px;top:${Jt-S.querySelector("table").scrollTop}px;height:${Sn}px;width:${Ce+1}px;`),_=T}return}x&&(I.clientY<w.top+p.SIZE_SCROLL_TB||I.clientY>w.bottom-p.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(I.clientY<w.top+p.SIZE_SCROLL_TB?-p.SIZE_SCROLL_STEP:p.SIZE_SCROLL_STEP),behavior:"smooth"}),t.selectElement.classList.remove("fn__none"),ae(["gutter"],t);let q=0,z=0,N=0,R=0;if(I.clientX<D?(I.clientX<m?z=m:z=I.clientX,N=D-z):I.clientX>u?(z=D,N=u-z):(z=D,N=I.clientX-D),I.clientY>b?I.clientY>y?(q=b,R=y-b):(q=b,R=I.clientY-b):(I.clientY<v?q=v:q=I.clientY,R=b-q),R<4)return;t.selectElement.setAttribute("style",`background-color: ${t.selectElement.style.backgroundColor};top:${q}px;height:${R}px;left:${z+2}px;width:${N-2}px;`);const V=document.elementFromPoint(I.clientX,I.clientY);if(k&&k===V&&!k.classList.contains("protyle-wysiwyg")&&!k.classList.contains("list")&&!k.classList.contains("bq")&&!k.classList.contains("sb"))return;k=V,ae(["select"],t);let j;if(I.clientY>b?(j=E||document.elementFromPoint(z,q),A=void 0):(j=document.elementFromPoint(z,q),E=void 0),!j||((j.classList.contains("protyle-wysiwyg")||j.classList.contains("list")||j.classList.contains("li")||j.classList.contains("sb")||j.classList.contains("bq"))&&(j=document.elementFromPoint(z,q+16)),!j))return;let W=F(j);!W&&j.classList.contains("protyle-breadcrumb__bar")&&(W=j.nextElementSibling),I.clientY>b?E||(W||(W=t.wysiwyg.element.firstElementChild,W.classList.contains("protyle-breadcrumb__bar")&&(W=W.nextElementSibling)),E=W):!W&&I.clientY<t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(W=t.wysiwyg.element.firstElementChild,W.classList.contains("protyle-breadcrumb__bar")&&(W=W.nextElementSibling));let Se=[],ce=W;if(ce){const Ce=de(ce);Ce&&(ce=Ce)}let ve=!1;const $e=A?A.getBoundingClientRect().bottom:q+R;for(;ce;)if(ce&&!ce.classList.contains("protyle-attr")){const Ce=ce.getBoundingClientRect();if(Ce.height>0&&Ce.top<$e&&Ce.left<z+N)if(ve)if(ce.nextElementSibling&&!ce.nextElementSibling.classList.contains("protyle-attr")){const ze=ce.nextElementSibling.getBoundingClientRect();if(ze.top<$e&&ze.left<z+N)Se=[ce],ce=ce.nextElementSibling,ve=!1;else if(ce.parentElement.classList.contains("sb"))ce=F(ce.parentElement),ve=!0;else break}else ce=F(ce.parentElement),ve=!0;else!ce.classList.contains("protyle-breadcrumb__bar")&&!ce.classList.contains("protyle-breadcrumb__item")&&Se.push(ce),ce=ce.nextElementSibling;else if(ce.parentElement.classList.contains("sb"))ce=F(ce.parentElement),ve=!0;else if(Ce.height===0&&Ce.width===0&&ce.parentElement.getAttribute("fold")==="1")ce=ce.parentElement,Se=[];else break}else ce=F(ce.parentElement),ve=!0;I.clientY<=b&&!A&&(A=Se[Se.length-1]),Se.length===1&&!Se[0].classList.contains("list")&&!Se[0].classList.contains("bq")&&!Se[0].classList.contains("sb")?(t.selectElement.style.backgroundColor="transparent",t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange")):(t.wysiwyg.element.classList.add("protyle-wysiwyg--hiderange"),Se.forEach(Ce=>{C(Ce,"protyle-wysiwyg__embed")||Ce.classList.add("protyle-wysiwyg--select")}),t.selectElement.style.backgroundColor="")},s.onmouseup=I=>{var T;if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,E=void 0,A=void 0,t.wysiwyg.element.classList.remove("protyle-wysiwyg--hiderange"),this.element.querySelectorAll("iframe").forEach(N=>{N.style.pointerEvents=""}),t.selectElement.classList.add("fn__none"),t.selectElement.removeAttribute("style"),S){S.firstElementChild.style.webkitUserModify="";const N=S.querySelector(".table__select");if(N.getAttribute("style")){if(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new H({id:"mergeCell",label:window.siyuan.languages.mergeCell,click:()=>{if(S){const R=[],V=[],j=S.querySelectorAll("th").length;let W=0;const Se=S.firstElementChild.scrollLeft,ce=S.querySelector("table").scrollTop;let ve=!1,$e=!1;S.querySelectorAll("th, td").forEach((dt,ra)=>{dt.classList.contains("fn__none")?(dt.previousElementSibling&&dt.previousElementSibling===R[R.length-1]||ra<W&&V.includes((ra+1)%j))&&(R.push(dt),!ve&&dt.parentElement.parentElement.tagName==="THEAD"?ve=!0:!$e&&dt.parentElement.parentElement.tagName==="TBODY"&&($e=!0)):ea({tableSelectElement:N,scrollLeft:Se,scrollTop:ce,item:dt})&&(R.push(dt),!ve&&dt.parentElement.parentElement.tagName==="THEAD"?ve=!0:!$e&&dt.parentElement.parentElement.tagName==="TBODY"&&($e=!0),V.push((ra+1)%j),W=Math.max((dt.rowSpan-1)*j+ra+1,W))}),N.removeAttribute("style");const Ce=S.outerHTML;let ze=R[0],Sn=ze.colSpan,Jt=1;for(;ze.nextElementSibling&&ze.nextElementSibling===R[Jt];)ze=ze.nextElementSibling,ze.classList.contains("fn__none")||(Sn+=ze.colSpan),Jt++;let De="",Qt=R[0].parentElement,Da=R[0].rowSpan;if(R.forEach((dt,ra)=>{let ba=dt.innerHTML.trim();ba.endsWith("<br>")&&(ba=ba.substr(0,ba.length-4)),De+=ba+(!ba||ra===R.length-1?"":"<br>"),ra!==0&&(Qt!==dt.parentElement&&(dt.classList.contains("fn__none")||(Da+=dt.rowSpan),Qt=dt.parentElement,R[0].parentElement.parentElement.tagName==="THEAD"&&dt.parentElement.parentElement.tagName!=="THEAD"&&R[0].parentElement.parentElement.insertAdjacentElement("beforeend",dt.parentElement)),dt.classList.add("fn__none"),dt.innerHTML="")}),ve&&$e)for(Qt=Qt.parentElement.nextElementSibling.firstElementChild;Qt&&Qt.parentElement.tagName!=="THEAD";){let dt=0,ra=0;if(Array.from(Qt.children).forEach(ba=>{dt+=ba.colSpan-1,ba.classList.contains("fn__none")&&ra++}),dt!==ra)R[0].parentElement.parentElement.insertAdjacentElement("beforeend",Qt),Qt=Qt.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{S&&(R[0].innerHTML=De+"<wbr>",R[0].colSpan=Sn,R[0].rowSpan=Da,fe(R[0],document.createRange()),Q(t,S.getAttribute("data-node-id"),S.outerHTML,Ce))})}}}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"alignLeft",icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(S){const R=[],V=S.firstElementChild.scrollLeft,j=S.querySelector("table").scrollTop;S.querySelectorAll("th, td").forEach(W=>{!W.classList.contains("fn__none")&&ea({tableSelectElement:N,scrollLeft:V,scrollTop:j,item:W})&&(R.length===0||R.length>0&&W.offsetTop===R[0].offsetTop)&&R.push(W)}),N.removeAttribute("style"),qn(t,R,S,"left",ye(S))}}}).element),window.siyuan.menus.menu.append(new H({id:"alignCenter",icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(S){const R=[],V=S.firstElementChild.scrollLeft,j=S.querySelector("table").scrollTop;S.querySelectorAll("th, td").forEach(W=>{!W.classList.contains("fn__none")&&ea({tableSelectElement:N,scrollLeft:V,scrollTop:j,item:W})&&(R.length===0||R.length>0&&W.offsetTop===R[0].offsetTop)&&R.push(W)}),N.removeAttribute("style"),qn(t,R,S,"center",ye(S))}}}).element),window.siyuan.menus.menu.append(new H({id:"alignRight",icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(S){const R=[],V=S.firstElementChild.scrollLeft,j=S.querySelector("table").scrollTop;S.querySelectorAll("th, td").forEach(W=>{!W.classList.contains("fn__none")&&ea({tableSelectElement:N,scrollLeft:V,scrollTop:j,item:W})&&(R.length===0||R.length>0&&W.offsetTop===R[0].offsetTop)&&R.push(W)}),N.removeAttribute("style"),qn(t,R,S,"right",ye(S))}}}).element),window.siyuan.menus.menu.append(new H({id:"useDefaultAlign",icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(S){const R=[],V=S.firstElementChild.scrollLeft,j=S.querySelector("table").scrollTop;S.querySelectorAll("th, td").forEach(W=>{!W.classList.contains("fn__none")&&ea({tableSelectElement:N,scrollLeft:V,scrollTop:j,item:W})&&(R.length===0||R.length>0&&W.offsetTop===R[0].offsetTop)&&R.push(W)}),N.removeAttribute("style"),qn(t,R,S,"",ye(S))}}}).element),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element)),window.siyuan.menus.menu.append(new H({id:"copyPlainText",label:window.siyuan.languages.copyPlainText,click(){if(S){const R=[],V=S.firstElementChild.scrollLeft,j=S.querySelector("table").scrollTop,W=S.querySelector(".table__select");S.querySelectorAll("th, td").forEach(ce=>{!ce.classList.contains("fn__none")&&ea({tableSelectElement:W,scrollLeft:V,scrollTop:j,item:ce})&&R.push(ce)});let Se="";R.forEach((ce,ve)=>{Se+=ce.textContent.trim()+"	",(!ce.nextElementSibling||!R[ve+1]||ce.nextElementSibling!==R[ve+1])&&(Se=Se.slice(0,-1)+`
`)}),qi(Se.slice(0,-1)),te(S)}}}).element),window.siyuan.menus.menu.append(new H({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){S&&(X(ye(S)),document.execCommand("copy"))}}).element),!t.disabled){let R;window.siyuan.menus.menu.append(new H({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){S&&(X(ye(S)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new H({id:"clear",label:window.siyuan.languages.clear,icon:"iconTrashcan",accelerator:"\u2326",click(){yd(t,S)}}).element),window.siyuan.menus.menu.append(new H({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return er(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else if(S)try{const V=yield Ls();ps(t,Object.assign(V,{target:S}))}catch(V){console.log(V)}})}}).element)}window.siyuan.menus.menu.popup({x:I.clientX-8,y:I.clientY-16})}}const q=[],z=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(z.forEach(N=>{q.push(N.getAttribute("data-node-id"))}),Yt(q),getSelection().rangeCount>0){const N=getSelection().getRangeAt(0);if((N.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let j=F(N.startContainer);if(j){if((T=j.nextElementSibling)!=null&&T.classList.contains("table"))ct(oe(j),N,!1);else if(j.classList.contains("table")){const W=j.querySelectorAll("th, td");j=W[W.length-1],j.contains(N.startContainer)&&ct(j,N,!1)}}return}if(z.length>0){N.collapse(!0),N.commonAncestorContainer.nodeType===1&&N.startContainer.childNodes[N.startOffset]&&N.startContainer.childNodes[N.startOffset].nodeType===1&&N.commonAncestorContainer.classList.contains("protyle-wysiwyg")&&te(N.startContainer.childNodes[N.startOffset]);return}const R=F(N.startContainer);let V;if(I.detail>2&&N.endContainer.nodeType!==3&&["DIV","TD","TH"].includes(N.endContainer.tagName)&&N.endOffset===0){if(N.endContainer.classList.contains("protyle-attr")&&R)ct(oe(R),N,!1);else if(["TD","TH"].includes(N.endContainer.tagName)){const j=U(N.startContainer,"TH")||U(N.startContainer,"TD");j&&ct(j,N,!1)}}else V=F(N.endContainer);R&&V&&V!==R&&(N.startContainer.nodeType===1&&N.startContainer.tagName==="DIV"&&N.startContainer.classList.contains("protyle-attr")||n.clientY>I.clientY?Ha(oe(V),N):N.endOffset===0&&N.endContainer.nodeType===1&&N.endContainer.tagName==="DIV"?ct(oe(R),N,!1):N.collapse(!0))}}})}bindEvent(t){t.observer=new ResizeObserver(()=>{const l=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(r=>{r.querySelector(".av__scroll")&&xa(r,l,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const l=getSelection().getRangeAt(0);(this.element===l.startContainer||this.element.contains(l.startContainer))&&(t.toolbar.range=l.cloneRange())}),this.element.addEventListener("cut",l=>er(this,null,function*(){var r,d,c;if(window.siyuan.ctrlIsPressed=!1,t.disabled)return;if(l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}t.options.render.breadcrumb&&t.breadcrumb.hide();const f=ye(t.wysiwyg.element);let m=F(f.startContainer);if(!m){l.stopPropagation(),l.preventDefault();return}const u=de(m);u&&(m=u),l.stopPropagation(),l.preventDefault();const g=m.querySelector(".img--select"),y=m.querySelector(".av__row--select, .av__cell--select"),b=((r=m.querySelector(".table__select"))==null?void 0:r.clientWidth)>0;let w=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&f.toString()===""&&!f.cloneContents().querySelector("img")&&!g&&!y&&!b&&(m.classList.add("protyle-wysiwyg--select"),w=[m]);let h="",S="",$=!1,D=!1;if(w.length>0){w[0].getAttribute("data-type")==="NodeListItem"&&w[0].parentElement.classList.contains("list")&&w[0].parentElement.childElementCount-1===w.length&&(w.find(E=>{if(!w[0].parentElement.contains(E))return!0})||(w=[w[0].parentElement]));let v="";for(let _=0;_<w.length;_++){const E=Ve(w[_]);let A="";E.getAttribute("data-type")==="NodeHeading"&&E.getAttribute("fold")==="1"?(D=!0,A=(yield he("/api/block/getHeadingChildrenDOM",{id:E.getAttribute("data-node-id"),removeFoldAttr:!1})).data):E.getAttribute("data-type")!=="NodeBlockQueryEmbed"&&E.querySelector('[data-type="NodeHeading"][fold="1"]')?(D=!0,A=(yield he("/api/block/getBlockDOM",{id:E.getAttribute("data-node-id")})).data.dom):A=qs(E),E.getAttribute("data-type")==="NodeListItem"?(v||(v=`<div data-subtype="${E.getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">`),v+=A,(_===w.length-1||w[_+1].getAttribute("data-type")!=="NodeListItem"||w[_+1].getAttribute("data-subtype")!==E.getAttribute("data-subtype"))&&(h+=`${v}<div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`,v="")):h+=A}const k=ht(w[w.length-1]);bn(t,m,f,"remove"),k&&te(k)}else if(y){D=!0;const v=yield Zt(t,m);h=JSON.stringify(v.json),S=v.text}else if(b){const v=[],k=m.firstElementChild.scrollLeft,_=m.querySelector("table").scrollTop,E=m.querySelector(".table__select");if(h="<table>",m.querySelectorAll("th, td").forEach(x=>{!x.classList.contains("fn__none")&&ea({tableSelectElement:E,scrollLeft:k,scrollTop:_,item:x})&&v.push(x)}),E.removeAttribute("style"),getSelection().rangeCount>0){const x=getSelection().getRangeAt(0);m.contains(x.startContainer)&&x.insertNode(document.createElement("wbr"))}const A=m.outerHTML;(d=m.querySelector("wbr"))==null||d.remove(),m.setAttribute("updated",G().format("YYYYMMDDHHmmss")),v.forEach((x,I)=>{(I===0||!x.previousElementSibling||x.previousElementSibling!==v[I-1])&&(h+="<tr>"),h+=x.outerHTML,(!x.nextElementSibling||!v[I+1]||x.nextElementSibling!==v[I+1])&&(h+="</tr>"),x.innerHTML=""}),h+="</table>",S=t.lute.HTML2Md(h),Q(t,m.getAttribute("data-node-id"),m.outerHTML,A)}else{const v=m.getAttribute("data-node-id");Pi(m,f,t);const k=t.wysiwyg.lastHTMLs[v]||m.outerHTML,_=document.createElement("div");let E=f.startContainer;if(E.nodeType===3&&E.textContent===""){const x=qe(f.startContainer);x&&(E=x)}const A=O(E,"data-type","NodeHeading");if(A&&f.toString()===A.firstElementChild.textContent)_.insertAdjacentHTML("afterbegin",A.firstElementChild.innerHTML),A.firstElementChild.innerHTML="";else if(f.toString()!==""&&E===f.endContainer&&f.startContainer.nodeType===3&&f.endOffset===f.endContainer.wholeText.length&&f.startOffset===0&&!["DIV","TD","TH","TR"].includes(f.startContainer.parentElement.tagName))_.append(f.startContainer.parentElement);else if(g)_.append(g);else if(f.startContainer.nodeType===3&&f.startContainer.parentElement.tagName==="SPAN"&&f.startContainer.parentElement.getAttribute("data-type")&&f.startContainer.parentElement===f.endContainer.parentElement){const x=f.startContainer.parentElement,I=x.attributes,T=document.createElement("span");for(let q=0;q<I.length;q++)T.setAttribute(I[q].name,I[q].value);x.getAttribute("data-type").indexOf("block-ref")>-1&&x.getAttribute("data-subtype")==="d"&&(T.setAttribute("data-subtype","s"),x.setAttribute("data-subtype","s")),T.textContent=f.toString(),f.deleteContents(),_.append(T)}else if(f.cloneContents().querySelectorAll("td, th").length>0){const x=document.createElement("wbr");f.insertNode(x),f.setStartAfter(x),_.append(f.extractContents()),m.outerHTML=t.lute.SpinBlockDOM(m.outerHTML),m=t.wysiwyg.element.querySelector(`[data-node-id="${v}"]`),jt(m),fe(m,f)}else{const x=O(f.commonAncestorContainer,"data-type","inline-math");if(x)_.append(x);else{_.append(f.extractContents());let I;m.classList.contains("av")?Kl(t,m):m.classList.contains("table")?I=U(f.startContainer,"TD")||U(f.startContainer,"TH"):I=oe(m),I&&Array.from(I.children).forEach(T=>{T.textContent===""&&T.nodeType===1&&!["BR","IMG"].includes(T.tagName)&&T.remove()})}}if(this.emojiToMd(_),h=_.innerHTML,(O(f.startContainer,"data-type","NodeCodeBlock")||U(f.startContainer,"CODE"))&&(S=_.textContent.replace(p.ZWSP,""),$=!0),!m.classList.contains("table")){const x=oe(m);x&&x.textContent===""&&(x.innerHTML="")}m.setAttribute("updated",G().format("YYYYMMDDHHmmss")),m.getAttribute("data-type")==="NodeCodeBlock"&&(f.insertNode(document.createElement("wbr")),(c=m.querySelector('[data-render="true"]'))==null||c.removeAttribute("data-render"),Re(m)),m.parentElement.parentElement&&!m.classList.contains("av")&&(Pi(m,f,t),Q(t,v,t.wysiwyg.lastHTMLs[v]||m.outerHTML,k))}if(t.hint.render(t),y||(S=S||t.lute.BlockDOM2StdMd(h).trimEnd(),m.classList.contains("table")&&(S=S.replace(/<br>/g,`
`).replace(/<br\/>/g,`
`),S=S.endsWith(`
`)?S.replace(/\n$/,""):S)),S=S.replace(/\u00A0/g," "),l.clipboardData.setData("text/plain",S),!$){gs(t);const v=b?t.lute.HTML2BlockDOM(h):h;ki(t),l.clipboardData.setData("text/siyuan",v);const k=`<!--data-siyuan='${Hl(v)}'-->`+(b?h:t.lute.BlockDOM2HTML(y?S:h));if(l.clipboardData.setData("text/html",k),D)try{yield navigator.clipboard.write([new ClipboardItem({"text/plain":S,"text/html":k})])}catch(_){console.log("Cut write clipboard error:",_)}}}));let n;this.element.addEventListener("contextmenu",l=>{var r,d,c,f,m;if(l.shiftKey)return;l.stopPropagation(),l.preventDefault();const u=l.clientX||l.detail.x,g=l.clientY||l.detail.y,y=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(y.length>1){ae(["util"],t),t.gutter.renderMenu(t,y[0]),window.siyuan.menus.menu.popup({x:u,y:g});return}const b=l.detail.target||l.target,w=de(b);if(w)return getSelection().rangeCount===0&&Dl(w),t.gutter.renderMenu(t,w),window.siyuan.menus.menu.fullscreen(),!1;const h=F(b);if(!h)return!1;const S=C(b,"av__gallery-item");if(S)return od({target:S.querySelector(".protyle-icon--last"),protyle:t,position:{x:l.clientX,y:l.clientY}}),l.stopPropagation(),l.preventDefault(),!1;const $=C(b,"av__cell");if($){if($.classList.contains("av__cell--header")){t.disabled||Sc(t,h,$),l.stopPropagation(),l.preventDefault();return}if(ln($)==="mAsset"){const _=C(b,"av__cellassetimg")||C(b,"av__celltext--url");if(_){let E=0;Array.from($.children).find((A,x)=>{if(A===_)return E=x,!0}),Js({protyle:t,cellElements:[$],blockElement:F(_),content:b.tagName==="IMG"?b.getAttribute("src"):b.getAttribute("data-url"),type:b.tagName==="IMG"?"image":"file",name:b.tagName==="IMG"?"":b.getAttribute("data-name"),index:E,rect:b.getBoundingClientRect()}),l.stopPropagation(),l.preventDefault();return}}}const D=C(b,"av__row");if(D&&Ki(t,D,{x:l.clientX,y:D.getBoundingClientRect().bottom,h:D.clientHeight})){l.stopPropagation(),l.preventDefault();return}const v=C(b,"item");if(h.classList.contains("av")&&v){v.classList.contains("item--focus")?Vi({protyle:t,blockElement:h,element:v}):(B(t,[{action:"setAttrViewBlockView",blockID:h.getAttribute("data-node-id"),id:v.dataset.id,avID:h.getAttribute("data-av-id")}],[{action:"setAttrViewBlockView",blockID:h.getAttribute("data-node-id"),id:v.parentElement.querySelector(".item--focus").getAttribute("data-id"),avID:h.getAttribute("data-av-id")}]),window.siyuan.menus.menu.remove(),Vi({protyle:t,blockElement:h,element:v})),l.stopPropagation(),l.preventDefault();return}if(t.toolbar.range=ye(t.element),b.tagName==="SPAN"&&!It(h)){let _=((r=b.getAttribute("data-type"))==null?void 0:r.split(" "))||[];if(_.length===0&&(_=(b.dataset.type||"").split(" ")),_.length>0&&kd(b),_.includes("block-ref"))return yo(t,b),b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620),!1;if(_.includes("file-annotation-ref")&&!t.disabled)return bo(t,b),!1;if(_.includes("tag")&&!t.disabled)return ho(t,b),!1;if(_.includes("inline-memo"))return t.toolbar.showRender(t,b),!1;if(_.includes("a"))return ri(t,b),window.siyuan.config.editor.floatWindowMode===0&&((d=b.getAttribute("data-href"))!=null&&d.startsWith("siyuan://blocks"))&&(b.setAttribute("prevent-popover","true"),setTimeout(()=>{b.removeAttribute("prevent-popover")},620)),!1}const k=O(b,"data-type","inline-math");if(k)return zs(t,k),!1;if(b.tagName==="IMG"&&C(b,"img"))return _o(t,t.toolbar.range,b.parentElement.parentElement,{clientX:u+4,clientY:g}),!1;!It(h)&&!h.classList.contains("protyle-wysiwyg--select")&&!C(b,"protyle-action")&&(P()||l.detail.target||n&&h.contains(n.startContainer))?(!P()||(c=t.toolbar)!=null&&c.element.classList.contains("fn__none"))&&!h.classList.contains("av")&&(jg(t,h),window.siyuan.menus.menu.popup({x:u,y:g+13,h:26}),(f=t.toolbar)==null||f.element.classList.add("fn__none"),h.classList.contains("table")&&h.querySelector(".table__select").removeAttribute("style")):t.toolbar.range.toString()===""&&(ae(["util"],t),t.gutter&&t.gutter.renderMenu(t,h),window.siyuan.menus.menu.fullscreen(),(m=t.toolbar)==null||m.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",l=>{if(xn(),!a&&l.deltaY<0&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.clientHeight===t.contentElement.scrollHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(L("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{a=!1,rt({data:d,protyle:t,action:[p.CB_GET_BEFORE,p.CB_GET_UNCHANGEID]})}),a=!0),l.deltaX===0)return;const r=C(l.target,"table");if(r){const d=r.querySelector(".table__select");d!=null&&d.style.width&&(d.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0}),this.element.addEventListener("paste",l=>{if(l.target.localName==="input"&&l.target.getAttribute("data-type")==="av-search")return;if(t.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}if(!O(l.target,"contenteditable","true")){l.stopPropagation(),l.preventDefault();return}const r=F(l.target);if(r&&!oe(r)){l.stopPropagation(),l.preventDefault();return}if(!r)return;const d=getSelection().getRangeAt(0);t.toolbar.range=d;const c=d.startContainer.parentElement;if(d.toString()===""&&c.tagName==="SPAN"){const f=(c.getAttribute("data-type")||"").split(" ");if(f.includes("inline-memo")||f.includes("text")||f.includes("block-ref")||f.includes("file-annotation-ref")||f.includes("a")){const m=et(c,r,d);m.start===0?(d.setStartBefore(c),d.collapse(!0)):m.start===c.textContent.length&&(d.setEndAfter(c),d.collapse(!1))}}ps(t,l)});let s=!1;this.element.addEventListener("compositionstart",l=>{s=!0;const r=ye(t.wysiwyg.element),d=F(r.startContainer);!$t()&&d&&Pi(d,r,t),l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),s=!1;const r=ye(this.element),d=F(r.startContainer);if(d)if(l.data!=="")this.escapeInline(t,r,l),Xs(t,d,r,!0);else{const c=d.getAttribute("data-node-id");t.wysiwyg.lastHTMLs[c]&&Q(t,c,d.outerHTML,t.wysiwyg.lastHTMLs[c])}});let i;this.element.addEventListener("input",l=>{const r=l.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const d=ye(this.element),c=F(d.startContainer);c&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(l.data)&&(t.hint.enableExtend=!0),!(l.isComposing||s||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(t,d,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"||l.data==="\u201D"||l.data==="\u300C"?(clearTimeout(i),i=window.setTimeout(()=>{Xs(t,c,d,!0)})):Xs(t,c,d,!0,l),l.stopPropagation()))}),this.element.addEventListener("keyup",l=>{const r=ye(this.element).cloneRange(),d=F(r.startContainer);if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Escape"&&l.key!=="Shift"&&l.key!=="Meta"&&l.key!=="Alt"&&l.key!=="Control"&&l.key!=="CapsLock"&&!l.ctrlKey&&!l.shiftKey&&!l.metaKey&&!l.altKey&&!/^F\d{1,2}$/.test(l.key)){!$t()&&d&&!s&&(typeof t.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=="undefined"||r.toString()!==""||!this.preventKeyup)&&Pi(d,r,t),this.preventKeyup=!1;return}if(this.preventKeyup){this.preventKeyup=!1;return}if((l.shiftKey||Lt(l))&&!l.isComposing&&r.toString()!==""&&(t.toolbar.render(t,r,l),Mi(r)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing){if(d&&(Et(["img","av"],t.wysiwyg.element),this.setEmptyOutline(t,d),r.toString()===""&&!d.classList.contains("protyle-wysiwyg--select")&&Mi(r,t.block.rootID),t.breadcrumb)){const c=t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(c){const f=t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');d.parentElement.classList.contains("li")?(c.removeAttribute("disabled"),f.removeAttribute("disabled")):(c.setAttribute("disabled","true"),f.setAttribute("disabled","true"))}}l.stopPropagation()}if((l.key==="ArrowLeft"||l.key==="ArrowRight")&&d&&!d.classList.contains("protyle-wysiwyg--select")){const c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let f=!1;c.find(m=>{if(m.contains(r.startContainer))return f=!0,!0}),!f&&c.length>0&&(c.forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),d.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){Xr(l.target.getAttribute("src"),t.block.rootID);return}});let o=!1;this.element.addEventListener("click",l=>{if(this.preventClick){this.preventClick=!1;return}t.app.plugins.forEach(I=>{I.eventBus.emit("click-editorcontent",{protyle:t,event:l})}),ae(["hint","util"],t);const r=Lt(l),d=C(l.target,"protyle-breadcrumb__item");if(d){d.getAttribute("data-id")&&jp(t,d),l.stopPropagation();return}this.setEmptyOutline(t,l.target);const c=C(l.target,"table");this.element.querySelectorAll(".table").forEach(I=>{I.tagName==="DIV"&&((!c||I!==c)&&I.querySelector(".table__select").removeAttribute("style"),c&&c===I&&I.querySelector(".table__select").getAttribute("style")&&l.stopPropagation())}),t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,F(l.target));const f=ye(this.element);f.startContainer.nodeType!==3&&f.startContainer.classList.contains("protyle-action")&&f.startContainer.parentElement.classList.contains("code-block")&&Ha(f.startContainer.parentElement.querySelector(".hljs").lastElementChild,f);const m=O(l.target,"data-type","a")||C(l.target,"av__celltext--url");let u=m&&m.getAttribute("data-href")||"";m&&!u&&m.classList.contains("av__celltext--url")&&(u=m.textContent.trim(),m.dataset.type==="phone"?u="tel:"+u:m.dataset.type==="email"?u="mailto:"+u:m.classList.contains("b3-chip")&&(u=m.dataset.url));const g=O(l.target,"data-type","block-ref");if((g||u.startsWith("siyuan://blocks/"))&&(l.stopPropagation(),l.preventDefault(),ae(["dialog","toolbar"],t),f.toString()===""||l.shiftKey)){let I;g?I=g.getAttribute("data-id"):m&&(I=u.substring(16,38)),Jn(I,(T,q,z)=>{z||q.push(p.CB_GET_HL),o=!0,mn(),ft(t.app,I,T?[p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL])});return}const y=O(l.target,"data-type","virtual-block-ref");if(y&&f.toString()===""){l.stopPropagation(),l.preventDefault();const I=F(y);I&&L("/api/block/getBlockDefIDsByRefText",{anchor:y.textContent,excludeIDs:[I.getAttribute("data-node-id")]},T=>{Jn(T.data.refDefs[0].refID,q=>{o=!0,mn(),ft(t.app,T.data.refDefs[0].refID,q?[p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL])})});return}const b=O(l.target,"data-type","file-annotation-ref");if(b&&f.toString()===""){l.stopPropagation(),l.preventDefault(),ns(t,b.getAttribute("data-id"),l,r);return}if(m&&(l.shiftKey||f.toString()==="")&&u){l.stopPropagation(),l.preventDefault(),ns(t,u,l,r);return}if(m&&m.classList.contains("av__celltext--url")&&!u){let I=0;Array.from(m.parentElement.children).find((T,q)=>{if(T===m)return I=q,!0}),Js({protyle:t,cellElements:[m.parentElement],blockElement:F(m),content:m.getAttribute("data-url"),type:"file",name:m.getAttribute("data-name"),index:I,rect:m.getBoundingClientRect()});return}const w=O(l.target,"data-type","tag");if(w&&!l.altKey&&!l.shiftKey&&f.toString()===""){Kt(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${w.textContent}#`,r:"",page:1});return}const h=C(l.target,"protyle-wysiwyg__embed");if(h){const I=h.getAttribute("data-id");if(Jn(I,(T,q)=>{o=!0,mn(),ft(t.app,I,T?[p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL])}),!r){l.stopPropagation();return}}if(wu(l,t)||ue(l.target,"protyle-action__copy"))return;const S=C(l.target,"protyle-action__edit");if(S&&!t.disabled){t.toolbar.showRender(t,S.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const $=C(l.target,"protyle-action__menu");if($){t.gutter.renderMenu(t,$.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();return}const D=C(l.target,"protyle-action__reload");if(D){const I=de(D);if(I)I.removeAttribute("data-render"),xe(t,I);else{const T=F(D);T&&T.getAttribute("data-subtype")==="echarts"&&(T.removeAttribute("data-render"),Fl(T))}l.stopPropagation(),l.preventDefault();return}const v=C(l.target,"protyle-action__language");if(v&&!t.disabled&&!r){t.toolbar.showCodeLanguage(t,[v]),l.stopPropagation(),l.preventDefault();return}const k=O(l.target,"data-subtype","math");if(!l.shiftKey&&!r&&k&&!t.disabled){t.toolbar.showRender(t,k),l.stopPropagation();return}const _=C(l.target,"protyle-action");if(_){if(_.parentElement.parentElement.getAttribute("data-type")==="img"&&!t.disabled){_o(t,f,_.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY}),l.stopPropagation();return}else if(_.parentElement.classList.contains("li")){const T=_.parentElement.getAttribute("data-node-id");if(l.altKey&&!t.disabled){if(_.parentElement.parentElement.classList.contains("protyle-wysiwyg"))at(t,_.parentElement);else{let q=!0;const z=_.parentElement.parentElement.outerHTML;Array.from(_.parentElement.parentElement.children).find(N=>{if(N.classList.contains("li")&&N.getAttribute("fold")!=="1"&&N.childElementCount>3)return q=!1,!0}),Array.from(_.parentElement.parentElement.children).find(N=>{N.classList.contains("li")&&(q?N.removeAttribute("fold"):N.childElementCount>3&&N.setAttribute("fold","1"))}),Q(t,_.parentElement.parentElement.getAttribute("data-node-id"),_.parentElement.parentElement.outerHTML,z)}ae(["gutter"],t)}else if(l.shiftKey&&!t.disabled)ta(_.parentElement,"bookmark",t);else if(r)Bt({protyle:t,id:T});else if(_.classList.contains("protyle-action--task")){if(!t.disabled){const q=_.parentElement.outerHTML;_.parentElement.classList.contains("protyle-task--done")?(_.querySelector("use").setAttribute("xlink:href","#iconUncheck"),_.parentElement.classList.remove("protyle-task--done")):(_.querySelector("use").setAttribute("xlink:href","#iconCheck"),_.parentElement.classList.add("protyle-task--done")),_.parentElement.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(t,T,_.parentElement.outerHTML,q)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(t.block.showAll&&t.block.id===T?wo(t,T):Bt({protyle:t,id:T}));l.stopPropagation();return}}const E=C(l.target,"hr")||C(l.target,"iframe");if(!l.shiftKey&&!r&&E){E.classList.add("protyle-wysiwyg--select"),vu(l.target),l.stopPropagation();return}const A=ue(l.target,"img");if(!l.shiftKey&&!r&&A){A.classList.add("img--select");const I=qe(A);I&&(I.textContent.startsWith(p.ZWSP)?f.setStart(I,1):f.setStart(I,0),f.collapse(!0),X(f),t.options.render.breadcrumb&&t.breadcrumb.render(t));return}const x=ue(l.target,"emoji");if(!t.disabled&&!l.shiftKey&&!r&&x){const I=F(x);if(I){const T=x.getBoundingClientRect();ha("","av",{x:T.left,y:T.bottom,h:T.height,w:T.width},q=>{x.insertAdjacentHTML("afterend","<wbr>");const z=I.outerHTML;let N;if(q.startsWith("api/icon/getDynamicIcon"))N=`<img class="emoji" src="${q}"/>`;else if(q.indexOf(".")>-1){const R=q.split(".");N=`<img alt="${R[0]}" class="emoji" src="/emojis/${q}" title="${R[0]}">`}else N=ge(q);x.outerHTML=N,ae(["dialog"]),Q(t,I.getAttribute("data-node-id"),I.outerHTML,z),fe(I,f)},x)}return}Jf(t,l)||(setTimeout(()=>{var I;let T=ye(this.element);if(F(l.target)!==F(T.startContainer)&&((I=this.element.querySelector("[data-node-id]"))!=null&&I.contains(T.startContainer))){const N=this.element.getBoundingClientRect();let R=document.elementFromPoint(N.left+N.width/2,l.clientY);R===this.element&&(R=document.elementFromPoint(N.left+N.width/2,l.clientY+8));let V=F(R);if(V){const j=de(V);j&&(V=j),T=te(V,void 0,l.clientX<N.left+parseInt(this.element.style.paddingLeft))||T,t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,V)}}const q=C(T.endContainer,"protyle-attr");q&&(T=ct(q.previousElementSibling,T,!1));const z=O(T.startContainer,"data-type","inline-math");z&&(T.setEndAfter(z),T.collapse(!1),X(T)),t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||Mi(T,t.block.rootID),getSelection().rangeCount===0&&!o&&X(T),o=!1},P()||Rt()?520:0),t.hint.enableExtend=!1,this.element.querySelector(".protyle-wysiwyg--select")&&f.toString()!==""&&(f.collapse(!1),X(f)))})}}class Sm{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}var Am=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Lm extends qa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>Am(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=t.toolbar.range;if(!F(s.startContainer))return;const o=O(s.startContainer,"data-type","a");if(o){ri(t,o);return}let l="",r=s.toString().trim().replace(p.ZWSP,""),d=!1;try{if(l=t.lute.GetLinkDest(r),!l){const f=yield Ls(),m=f.textHTML||t.lute.Md2BlockDOM(f.textPlain);if(m){const u=document.createElement("template");u.innerHTML=m;const g=u.content.querySelector('span[data-type~="a"], a');g&&(r=r||g.textContent,l=g.getAttribute("data-href")||g.getAttribute("href"))}if(l||(l=t.lute.GetLinkDest(f.textPlain)),!l){const u=f.textPlain.lastIndexOf(" ");u>-1&&(l=t.lute.GetLinkDest(f.textPlain.substring(u)),l&&!r&&(r=f.textPlain.substring(0,u)))}!l&&f.textPlain.startsWith("assets/")&&(l=f.textPlain),l&&!r&&(r=decodeURIComponent(l.replace("https://","").replace("http://","")),l.length>p.SIZE_LINK_TEXT_MAX&&(r=l.substring(0,p.SIZE_LINK_TEXT_MAX)+"..."),d=!0)}}catch(f){console.log(f)}const c=t.toolbar.setInlineMark(t,"a","range",{type:"a",color:l+(r?p.ZWSP+r:"")});d&&ri(t,c[0],!0)}))}}class xm extends qa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>{t.toolbar.range.toString()!==""&&(Tl(t.toolbar.range),Ia(t.toolbar.range.toString(),t,"search"),t.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var Cm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Tm extends qa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>Cm(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=t.toolbar.range;if(!F(s.startContainer))return;let o=O(s.startContainer,"data-type","inline-math");if(!o&&s.startContainer.nodeType!==3&&s.startContainer.childNodes[s.startOffset]){const l=st(s.startContainer.childNodes[s.startOffset]);l&&l.nodeType!==3&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&s.startOffset===s.startContainer.textContent.length&&s.startContainer.nodeType===3){let l=!0,r=!1;if(s.cloneContents().childNodes.forEach(d=>{d.nodeType!==3&&(d.getAttribute("data-type")||"").indexOf("inline-math")>-1||d.nodeType==3&&d.textContent===""?r=!0:l=!1}),l&&r){const d=qe(s.startContainer);if(d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1)o=d;else{const c=st(s.startContainer);s.startOffset===0&&c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1&&(o=c)}}}if(o){t.toolbar.showRender(t,o);return}t.toolbar.setInlineMark(t,"inline-math","range",{type:"inline-math"})}))}}var Im=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class $m extends qa{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>Im(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const s=t.toolbar.range;if(!F(s.startContainer))return;const o=O(s.startContainer,"data-type","inline-memo");if(o&&o.textContent===s.toString()){t.toolbar.showRender(t,o);return}s.toString()!==""&&t.toolbar.setInlineMark(t,"inline-memo","range",{type:"inline-memo"})}))}}var Dm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Mm{constructor(t){const n=t.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,t.app.plugins.forEach(s=>{const i=s.updateProtyleToolbar(n.toolbar);i.forEach(o=>{typeof o=="string"||p.INLINE_TYPE.concat("|").includes(o.name)||!o.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[s.name]&&window.siyuan.config.keymap.plugin[s.name][o.name]&&(o.hotkey=window.siyuan.config.keymap.plugin[s.name][o.name].custom)}),n.toolbar=Us(i)}),n.toolbar.forEach(s=>{const i=this.genItem(t,s);this.element.appendChild(i)})}update(t){this.element.innerHTML="",t.options.toolbar=Us(p.PROTYLE_TOOLBAR),t.app.plugins.forEach(n=>{const a=n.updateProtyleToolbar(t.options.toolbar);a.forEach(s=>{typeof s=="string"||p.INLINE_TYPE.concat("|").includes(s.name)||!s.hotkey||window.siyuan.config.keymap.plugin&&window.siyuan.config.keymap.plugin[n.name]&&window.siyuan.config.keymap.plugin[n.name][s.name]&&(s.hotkey=window.siyuan.config.keymap.plugin[n.name][s.name].custom)}),t.options.toolbar=Us(a)}),t.options.toolbar.forEach(n=>{const a=this.genItem(t,n);this.element.appendChild(a)})}render(t,n,a){this.range=n;let s=F(n.startContainer);if(P()||!s||t.disabled||s.classList.contains("av")){this.element.classList.add("fn__none");return}let i=!1;if(Array.from(n.cloneContents().childNodes).find(f=>{if(f.textContent.length>0&&f.textContent!==p.ZWSP&&!(f.nodeType===1&&f.classList.contains("img")))return i=!0,!0}),!i||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const o=F(n.startContainer),l=F(n.endContainer);if(o&&l&&o!==l){if(a)if(a.key==="ArrowLeft")this.range=ct(oe(o),n,!1);else if(a.key==="ArrowRight")this.range=Ha(oe(l),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=Ha(oe(l),n),s=F(l),!s)return}else a.key==="ArrowDown"&&(this.range=ct(oe(o),n,!1));else this.range=ct(oe(s),n,!1);if(X(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(s.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=Pn(s,n,!0);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const d=r.isBottom?Math.min(r.top+4,t.element.getBoundingClientRect().bottom-this.toolbarHeight):Math.max(r.top-this.toolbarHeight-4,t.element.getBoundingClientRect().top+30);this.element.setAttribute("data-inity",d+p.ZWSP+t.contentElement.scrollTop.toString()),Ee(this.element,r.left-this.element.clientWidth/4,d),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(f=>{f.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(f=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(f))return;const m=this.element.querySelector(`[data-type="${f}"]`);m&&m.classList.add("protyle-toolbar__item--current")})}getCurrentType(t=this.range){var n,a;let s=[],i=t.startContainer;if(i.nodeType===3?i=i.parentElement:i.childElementCount>0&&((n=i.childNodes[t.startOffset])==null?void 0:n.nodeType)!==3&&(i=i.childNodes[t.startOffset],(i==null?void 0:i.tagName)==="WBR"&&(i=i.parentElement)),!i||i.nodeType===3)return[];["DIV","TD","TH","TR"].includes(i.tagName)||(s=(i.getAttribute("data-type")||"").split(" "));let o=t.endContainer;return o.nodeType===3?o=o.parentElement:o.childElementCount>0&&((a=o.childNodes[t.endOffset])==null?void 0:a.nodeType)!==3&&(o=o.childNodes[t.endOffset]),s.length===0&&(!o||o.nodeType===3)?[]:(o&&!["DIV","TD","TH","TR"].includes(o.tagName)&&i!==o&&(s=s.concat((o.getAttribute("data-type")||"").split(" "))),t.cloneContents().childNodes.forEach(l=>{l.nodeType!==3&&(s=s.concat((l.getAttribute("data-type")||"").split(" ")))}),s=[...new Set(s)],s.find((l,r)=>{if(l==="")return s.splice(r,1),!0}),s)}setInlineMark(t,n,a,s){const i=F(this.range.startContainer);if(!i||i.getAttribute("data-type")==="NodeCodeBlock")return;const o=F(this.range.endContainer);if(!o)return;i!==o&&(this.range=ct(oe(i),this.range,!1));let l=[];this.range.cloneContents().childNodes.forEach(_=>{_.nodeType!==3&&(l=l.concat((_.getAttribute("data-type")||"").split(" ")))});let r=qe(this.range.startContainer);for(;r&&r.nodeType===1&&r.tagName==="BR";)r=qe(r);const d=this.range.startContainer===this.range.endContainer||r&&r===this.range.endContainer&&this.range.startContainer.parentElement===this.range.endContainer.parentElement;this.range.startContainer.nodeType===3&&this.range.startContainer.parentElement.tagName==="SPAN"&&d&&this.range.startOffset>-1&&this.range.endOffset<=this.range.endContainer.textContent.length&&(l=l.concat((this.range.startContainer.parentElement.getAttribute("data-type")||"").split(" ")));const c=this.range.toString();let f=!1;if(!c&&this.range.startOffset===1&&this.range.startContainer.textContent===p.ZWSP){let _;this.range.startContainer.nodeType===1?_=this.range.startContainer:_=this.range.startContainer.parentElement,_.tagName==="SPAN"&&(l=l.concat((_.getAttribute("data-type")||"").split(" ")),this.range.setStart(_.firstChild,0),this.range.setEnd(_.lastChild,_.lastChild.textContent.length||0),f=!0)}if(l.length===1&&["block-ref","virtual-block-ref","file-annotation-ref","a","inline-memo","inline-math","tag"].includes(l[0])&&n==="clear")return;if(l.includes("text")&&n==="text"&&s&&this.range.startContainer.nodeType===3&&this.range.startContainer===this.range.endContainer){const _=this.range.startContainer.parentElement;if(_&&Id(null,_,s))return}Tl(this.range);let m,u,g;if(this.range.startContainer.nodeType===3&&this.range.startContainer.parentElement.tagName==="SPAN"&&d){this.range.startOffset>-1&&this.range.endOffset<=this.range.endContainer.textContent.length&&(g=this.range.startContainer.parentElement);const _=st(this.range.startContainer),E=qe(this.range.endContainer);if((this.range.startOffset!==0||this.range.startOffset===0&&_&&(_.nodeType===3||_.tagName==="BR")&&this.range.startContainer.previousSibling.parentElement===this.range.startContainer.parentElement)&&(this.range.endOffset!==this.range.endContainer.textContent.length||this.range.endOffset===this.range.endContainer.textContent.length&&E&&(E.nodeType===3||E.tagName==="BR")&&this.range.endContainer.nextSibling.parentElement===this.range.endContainer.parentElement)&&!(this.range.startOffset===1&&this.range.startContainer.textContent.startsWith(p.ZWSP))){const A=this.range.startContainer.parentElement,x=document.createElement("span"),I=A.attributes;for(let T=0;T<I.length;T++)x.setAttribute(I[T].name,I[T].value);this.range.insertNode(document.createElement("wbr")),u=i.outerHTML,m=this.range.extractContents(),this.range.setEnd(A.lastChild,A.lastChild.textContent.length),x.append(this.range.extractContents()),A.after(x),this.range.setStartBefore(x),this.range.collapse(!0)}}let y=!1;if(this.range.endOffset===this.range.startContainer.textContent.length&&!["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)&&!qe(this.range.endContainer)&&(this.range.setEndAfter(this.range.endContainer.parentElement),y=!0),this.range.startOffset===0&&!["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)&&!st(this.range.startContainer)&&this.range.setStartBefore(this.range.startContainer.parentElement),u||(this.range.insertNode(document.createElement("wbr")),u=i.outerHTML,m=this.range.extractContents()),this.mergeNode(m.childNodes),m.childNodes.forEach(_=>{_.nodeType===3&&_.textContent===p.ZWSP&&_.remove(),_.nodeType===1&&_.textContent===""&&_.tagName==="SPAN"&&_.remove()}),c&&this.range.startContainer.nodeType!==3){let _=this.range.startContainer.childNodes[this.range.startOffset];_||(_=this.range.startContainer.childNodes[this.range.startOffset-1]),_&&_.nodeType===3&&(this.range.startContainer.tagName==="DIV"?_=_.previousSibling:_=this.range.startContainer),_&&_.nodeType!==3&&_.textContent.replace(p.ZWSP,"")===""&&!["TD","TH","BR"].includes(_.tagName)&&_.remove()}if(g){const _=g.attributes;m.childNodes.forEach(E=>{if(E.nodeType===3){const A=document.createElement("span");for(let x=0;x<_.length;x++)A.setAttribute(_[x].name,_[x].value);A.innerHTML=E.textContent,E.replaceWith(A)}})}const b=P()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,w=a==="toolbar"?b.querySelector(`[data-type="${n}"]`):void 0,h=[];let S,$,D,v;if(n==="clear"||w!=null&&w.classList.contains("protyle-toolbar__item--current")||a==="range"&&l.length>0&&l.includes(n)&&!s){if(n==="clear"?b.querySelectorAll('[data-type="strong"],[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="kbd"],[data-type="mark"],[data-type="code"]').forEach(_=>{_.classList.remove("protyle-toolbar__item--current")}):w&&w.classList.remove("protyle-toolbar__item--current"),m.childNodes.length===0){if(l.find((_,E)=>{if(n===_)return l.splice(E,1),!0}),l.length===0||n==="clear")h.push(document.createTextNode(p.ZWSP)),S=h[0];else{let _=0;for(;_<l.length;)["inline-memo","text","block-ref","virtual-block-ref","file-annotation-ref","a"].includes(l[_])?l.splice(_,1):++_;const E=document.createElement("span");E.setAttribute("data-type",l.join(" ")),E.textContent=p.ZWSP,h.push(E),S=h[0].firstChild}f=!0,D=1}m.childNodes.forEach(_=>{if(_.nodeType!==3&&_.tagName!=="BR"&&_.tagName!=="IMG"&&!_.classList.contains("img")){const E=(_.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let A=0;A<E.length;A++)s&&s.type==="text"?E[A]==="text"&&(E.splice(A,1),A--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(E[A])&&(E.splice(A,1),A--);else E.find((A,x)=>{if(n===A)return E.splice(x,1),!0});E.length===0?h.push(document.createTextNode(_.textContent)):(n==="clear"&&(_.style.color="",_.style.webkitTextFillColor="",_.style.webkitTextStroke="",_.style.textShadow="",_.style.backgroundColor="",_.style.fontSize=""),_.setAttribute("data-type",E.join(" ")),h.push(_))}else h.push(_)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&w&&w.classList.add("protyle-toolbar__item--current"),c===""){const _=document.createElement("span");if(l.push(n),y){let E=0;for(;E<l.length;)["inline-memo","text","block-ref","virtual-block-ref","file-annotation-ref","a"].includes(l[E])?l.splice(E,1):++E;l.length===0&&l.push(n)}_.setAttribute("data-type",[...new Set(l)].join(" ")),_.textContent=p.ZWSP,no(_,s),h.push(_),f=!0}else{if(n==="block-ref")for(;m.childNodes.length>1;)m.childNodes[0].remove();m.childNodes.forEach(_=>{let E="";if(_.nodeType===3&&_.textContent){for(;_.textContent.endsWith(`
`);)_.textContent=_.textContent.substring(0,_.textContent.length-1),E+=`
`;if(_.textContent){const A=document.createElement("span");A.setAttribute("data-type",n),A.textContent=_.textContent,n==="a"&&(A.textContent||(A.textContent="*"),s.color=s.color.split(p.ZWSP)[0]),no(A,s),n==="text"&&!A.getAttribute("style")?h.push(_):h.push(A)}}else if(_.nodeType===1){let A=(_.getAttribute("data-type")||"").split(" ");for(let x=0;x<A.length;x++)["backslash","virtual-block-ref","search-mark"].includes(A[x])&&(A.splice(x,1),x--);if(A.includes("img")||A.push(n),n==="sub"&&A.includes("sup")?A.find((x,I)=>{if(x==="sup")return A.splice(I,1),b.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&A.includes("sub")?A.find((x,I)=>{if(x==="sub")return A.splice(I,1),b.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(A.includes("a")||A.includes("file-annotation-ref"))?A.find((x,I)=>{if(x==="a"||x==="file-annotation-ref")return A.splice(I,1),!0}):n==="a"&&(A.includes("block-ref")||A.includes("file-annotation-ref"))?A.find((x,I)=>{if(x==="block-ref"||x==="file-annotation-ref")return A.splice(I,1),!0}):n==="file-annotation-ref"&&(A.includes("block-ref")||A.includes("a"))?A.find((x,I)=>{if(x==="block-ref"||x==="a")return A.splice(I,1),!0}):n==="inline-memo"&&A.includes("inline-math")?(A.find((x,I)=>{if(x==="inline-math")return A.splice(I,1),!0}),_.querySelector(".katex")&&(_.textContent=_.getAttribute("data-content"))):n==="inline-math"&&A.includes("inline-memo")&&A.find((x,I)=>{if(x==="inline-memo")return A.splice(I,1),!0}),A=[...new Set(A)],_.tagName!=="BR"&&_.tagName!=="IMG"&&!A.includes("img"))if(_.setAttribute("data-type",A.join(" ")),n==="a"&&(_.textContent||(_.textContent="*"),s.color=s.color.split(p.ZWSP)[0]),no(_,s),A.includes("text")&&!_.getAttribute("style"))if(A.length===1){const x=document.createTextNode(_.textContent);h.push(x)}else A.splice(A.indexOf("text"),1),_.setAttribute("data-type",A.join(" ")),h.push(_);else h.push(_);else h.push(_)}E&&h.push(document.createTextNode(E))})}for(let _=h.length-1;_>-1;_--)this.range.insertNode(h[_]);if(h.length===1&&h[0].textContent===p.ZWSP&&(this.range.setStart(h[0],1),this.range.collapse(!0),h[0].nodeType!==3)){const _=(h[0].getAttribute("data-type")||"").split(" ");(_.includes("code")||_.includes("tag")||_.includes("kbd"))&&(f=!1)}if(!f){for(let _=0;_<=h.length;_++){let E=_===h.length?h[_-1]:st(h[_]);E.nodeType===3&&E.textContent===p.ZWSP&&(E=st(E),E&&E.nextSibling.remove());let A=h[_];if(A||(A=qe(h[_-1]),A&&A.nodeType===3&&A.textContent===p.ZWSP&&(A=qe(A),A&&A.previousSibling.remove())),A&&A.nodeType!==3){const x=(A.getAttribute("data-type")||"").split(" ");if(A.tagName!=="BR"&&E&&E.nodeType!==3&&A.nodeType!==3&&Pe(x,(E.getAttribute("data-type")||"").split(" "))&&Id(A,E)&&((x.includes("code")||x.includes("tag")||x.includes("kbd"))&&A.textContent.startsWith(p.ZWSP)&&(A.textContent=A.textContent.substring(1)),x.includes("inline-math")?A.setAttribute("data-content",E.getAttribute("data-content")+A.getAttribute("data-content")):x.includes("block-ref")&&E.getAttribute("data-id")===A.getAttribute("data-id")?(E.dataset.subtype!=="d"||E.dataset.subtype!=="d")&&(A.setAttribute("data-subtype","s"),A.textContent=E.textContent+A.textContent):(A.textContent=E.innerText+A.innerText,x.includes("inline-memo")&&A.setAttribute("data-inline-memo-content",(E.getAttribute("data-inline-memo-content")||"")+(A.getAttribute("data-inline-memo-content")||""))),x.includes("inline-math")||(_===0?(S=A,D=E.textContent.length):_===h.length&&($=A,v=E.textContent.length,S?S===E&&(S=A):S=A)),E.remove(),_>0&&(h.splice(_-1,1),_--),h.length===0)){h.push(A);break}}}for(let _=0;_<=h.length;_++){const E=_===h.length?h[_-1]:st(h[_]);let A=h[_];if(A||(A=qe(h[_-1])),!A){if(E.nodeType!==3){const x=(E.getAttribute("data-type")||"").split(" ");(x.includes("code")||x.includes("tag")||x.includes("kbd"))&&E.insertAdjacentText("afterend",p.ZWSP)}break}if(A.nodeType===3)if(E&&E.nodeType===3)A.textContent.startsWith(p.ZWSP)&&(A.textContent=A.textContent.substring(1)),E.textContent.endsWith(p.ZWSP)&&(E.textContent=E.textContent.substring(0,E.textContent.length-2));else{const x=E?(E.getAttribute("data-type")||"").split(" "):[];x.includes("code")||x.includes("tag")||x.includes("kbd")?A.textContent.startsWith(p.ZWSP)||(A.textContent=p.ZWSP+A.textContent):A.textContent.startsWith(p.ZWSP)&&(A.textContent=A.textContent.substring(1))}else{const x=A.nodeType===3?[]:(A.getAttribute("data-type")||"").split(" ");if(x.includes("code")||x.includes("tag")||x.includes("kbd")?(A.textContent.startsWith(p.ZWSP)||A.insertAdjacentText("afterbegin",p.ZWSP),(!E||E.nodeType===3&&E.textContent.endsWith(`
`))&&A.insertAdjacentText("beforebegin",p.ZWSP)):A.textContent.startsWith(p.ZWSP)&&(A.textContent=A.textContent.substring(1)),E&&E.nodeType!==3){const I=(E.getAttribute("data-type")||"").split(" ");(I.includes("code")||I.includes("tag")||I.includes("kbd"))&&A.insertAdjacentText("beforebegin",p.ZWSP)}}}}i.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(t,i.getAttribute("data-node-id"),i.outerHTML,u),i.querySelectorAll("wbr").forEach(_=>{_.remove()}),S&&typeof D=="number"&&(S.nodeType===3?this.range.setStart(S,D):this.range.setStart(S.firstChild,D)),$&&typeof v=="number"&&($.nodeType===3?this.range.setEnd($,v):this.range.setEnd($.firstChild,v)),X(this.range);const k=h[0];if(k.nodeType!==3){const _=(k.getAttribute("data-type")||"").split(" ");n==="inline-math"?(jt(i),c===""&&_.includes("inline-math")&&t.toolbar.showRender(t,k,void 0,u)):n==="inline-memo"?!k.getAttribute("data-inline-memo-content")&&_.includes("inline-memo")&&t.toolbar.showRender(t,k,h,u):n==="a"&&_.includes("a")&&(k.textContent.replace(p.ZWSP,"")===""||!k.getAttribute("data-href"))&&ri(t,k,!!k.getAttribute("data-href"))}return h}showRender(t,n,a,s){var i;const o=F(n);if(!o)return;ae(["hint"],t),window.siyuan.menus.menu.remove();const l=o.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),d=s||o.outerHTML;let c="HTML",f="";const m=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":c=window.siyuan.languages.staff;break;case"echarts":c=window.siyuan.languages.chart;break;case"flowchart":c="Flow Chart";break;case"graphviz":c="Graphviz";break;case"mermaid":c="Mermaid";break;case"mindmap":f=`- foo
  - bar
- baz`,c=window.siyuan.languages.mindmap;break;case"plantuml":c="UML";break;case"math":r.includes("NodeMathBlock")?c=window.siyuan.languages.math:c=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?c=window.siyuan.languages.blockEmbed:m&&(c=window.siyuan.languages.memo);const u=((i=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:i.getAttribute("aria-label"))===window.siyuan.languages.unpin,g={};if(u){const D=this.subElement.querySelector(".b3-text-field");g.styleH=D.style.height,g.styleW=D.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${u&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move" style="line-height: 24px;">
        ${c}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${u&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages.insertBefore}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages.insertAfter}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${u?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${u?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px;margin: 0 2px;"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${t.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${f}" style="${P()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const y=()=>{if(h.style.height=h.scrollHeight+"px",P()){Ee(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){h.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const D=$.bottom===$.top?$.bottom+26:$.bottom;this.subElement.clientHeight<=window.innerHeight-D||this.subElement.clientHeight<=$.top?r.includes("inline-math")||m?Ee(this.subElement,$.left,D,$.height||26):Ee(this.subElement,$.left+($.width-this.subElement.clientWidth)/2,D,$.height||26):Ee(this.subElement,$.right,D)},b=this.subElement.querySelector(".block__icons");b.addEventListener("click",D=>{const v=D.target,k=C(v,"b3-tooltips");if(!k){if(D.detail===2){const _=b.querySelector('[data-type="pin"]');_.getAttribute("aria-label")===window.siyuan.languages.unpin?(_.querySelector("svg use").setAttribute("xlink:href","#iconPin"),_.setAttribute("aria-label",window.siyuan.languages.pin)):(_.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),_.setAttribute("aria-label",window.siyuan.languages.unpin)),D.preventDefault(),D.stopPropagation()}return}switch(D.stopPropagation(),k.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),ae(["util"],t);break;case"pin":k.getAttribute("aria-label")===window.siyuan.languages.unpin?(k.querySelector("svg use").setAttribute("xlink:href","#iconPin"),k.setAttribute("aria-label",window.siyuan.languages.pin)):(k.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),k.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":k.classList.toggle("block__icon--active");break;case"before":an(t,"beforebegin",l),ae(["util"],t);break;case"after":an(t,"afterend",l),ae(["util"],t);break;case"export":w();break}});const w=()=>{const D=se(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("object").getAttribute("data")).then(function(v){return v.blob()}).then(function(v){const k=new FormData;k.append("file",v),k.append("type","image/svg+xml"),L("/api/export/exportAsFile",k,_=>{Nt(_.data.file),tt(D)})});return}setTimeout(()=>{Ke("/stage/protyle/js/html-to-image.min.js?v=1.11.13","protyleHtml2image").then(()=>{n.style.display="inline-block",window.htmlToImage.toBlob(n).then(v=>{n.style.display="";const k=new FormData;k.append("file",v),k.append("type","image/png"),L("/api/export/exportAsFile",k,_=>{Nt(_.data.file),tt(D)})})})},p.TIMEOUT_LOAD)},h=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?h.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):m?h.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):h.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||"");const S=h.value;h.addEventListener("input",D=>{if(n.parentElement&&(h.clientHeight!==h.scrollHeight&&y(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(h.value));else if(m){let v;a?v=a:v=[n],v.forEach(k=>{k.nodeType!==3&&k.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(h.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(h.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!m)&&Xe(n),D.stopPropagation()}}),h.addEventListener("keydown",D=>{if(D.stopPropagation(),ne(window.siyuan.config.keymap.editor.insert["inline-math"].custom,D)){D.preventDefault();return}if(!D.isComposing){if(D.key==="Escape"||ne("\u2318\u21A9",D))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),ae(["util"],t);else if(D.key==="Tab")document.execCommand("insertText",!1,"	"),D.preventDefault();else if(Rn(D))return}}),this.subElementCloseCB=()=>{var D;if(!n.parentElement||t.disabled||S===h.value&&h.value)return;let v;if(r.includes("NodeHTMLBlock")){let k=h.value;k&&(k=k.trim().replace(/\n+/g,`
`),k.startsWith("<div>")&&k.endsWith("</div>")||(k=`<div>
${k}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(k))}else if(m){let k;a?k=a:k=[n],k.forEach((_,E)=>{if(h.value)_.nodeType!==3&&_.setAttribute("data-inline-memo-content",window.DOMPurify.sanitize(h.value));else{const A=_.getAttribute("data-type").split(" ");A.length===1&&A[0]==="inline-memo"?_.outerHTML=_.innerHTML+(E===k.length-1?"<wbr>":""):(A.find((x,I)=>{if(x==="inline-memo")return A.splice(I,1),!0}),_.setAttribute("data-type",A.join(" ")),_.removeAttribute("data-inline-memo-content")),E===k.length-1&&(v=_)}})}else r.includes("inline-math")?h.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(h.value)),n.removeAttribute("data-render"),Xe(n)):(v=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(h.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?(xe(t,n),n.style.height=""):Xe(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&C(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?v?v.parentElement?(this.range.setStartAfter(v),this.range.collapse(!0),X(this.range)):fe(o,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),X(this.range)):(te(n),n.classList.add("protyle-wysiwyg--select")):(D=o.querySelector("wbr"))==null||D.remove(),o.setAttribute("updated",G().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const k=document.createElement("template");k.innerHTML=t.lute.SpinBlockDOM(o.outerHTML),k.content.childElementCount>1&&se(window.siyuan.languages.htmlBlockTip)}Q(t,l,o.outerHTML,d)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const $=n.getBoundingClientRect();this.element.classList.add("fn__none"),u?(h.style.width=g.styleW,h.style.height=g.styleH):y(),t.disabled||h.select(),t.app.plugins.forEach(D=>{D.eventBus.emit("open-noneditableblock",{protyle:t,toolbar:this,blockElement:o,renderElement:n})})}showCodeLanguage(t,n){var a,s;const i=F(n[0]);if(!i)return;ae(["hint"],t),window.siyuan.menus.menu.remove(),this.range=ye(i),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div data-id="codeLanguage" class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"></div>
</div>`;const o=this.subElement.lastElementChild.lastElementChild;let l=`<div data-id="clearLanguage" class="b3-list-item">${window.siyuan.languages.clear}</div>`,r=p.ALIAS_CODE_LANGUAGES.concat((s=(a=window.hljs)==null?void 0:a.listLanguages())!=null?s:[]).sort();const d={languages:r,type:"init",listElement:o};t.app&&t.app.plugins&&t.app.plugins.forEach(m=>{m.eventBus.emit("code-language-update",d)}),r=d.languages,r.forEach(m=>{l+=`<div data-id="${m}" class="b3-list-item">${m}</div>`}),o.innerHTML=l,o.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus");const c=this.subElement.querySelector("input");c.addEventListener("keydown",m=>{if(m.stopPropagation(),!m.isComposing){if(Vt(o,m),m.key==="Enter"){this.updateLanguage(n,t,this.subElement.querySelector(".b3-list-item--focus").textContent),m.preventDefault();return}m.key==="Escape"&&(this.subElement.classList.add("fn__none"),X(this.range))}});const f=(m,u)=>{const g=u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),y=new RegExp(g,"gi");return m.replace(y,b=>`<b>${b}</b>`)};c.addEventListener("input",m=>{var u;const g=c.value.trim();let y,b=`<div data-id="clearLanguage" class="b3-list-item">${window.siyuan.languages.clear}</div>`,w=!1;if(g){const S=g.toLowerCase();y=r.filter($=>$.toLowerCase().includes(S)).sort(($,D)=>{const v=$.toLowerCase().startsWith(S),k=D.toLowerCase().startsWith(S);return v&&k?$.length-D.length:v?-1:k?1:0}),(u=window.hljs)!=null&&u.getLanguage(g)&&(y=[g].concat(y.filter($=>$!==g)))}const h={languages:g?y:r,type:"match",value:g,listElement:o};t.app&&t.app.plugins&&t.app.plugins.forEach(S=>{S.eventBus.emit("code-language-update",h)}),y=h.languages,g?y.forEach(S=>{g===S?(w=!0,b+=`<div data-id="${S}" class="b3-list-item"><b>${S}</b></div>`):b+=`<div data-id="${S}" class="b3-list-item">${f(S,g)}</div>`}):y.forEach(S=>{b+=`<div data-id="${S}" class="b3-list-item">${S}</div>`}),g&&!w&&(b+=`<div data-id="customLanguage" class="b3-list-item"><b>${pe(g.replace(/`| /g,"_"))}</b></div>`),o.innerHTML=b,o.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"),m.stopPropagation()}),o.addEventListener("click",m=>{const u=m.target,g=C(u,"b3-list-item");g&&this.updateLanguage(n,t,g.textContent)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,Ee(this.subElement,0,0),this.element.classList.add("fn__none"),c.select()}showTpl(t,n,a){this.range=a,ae(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${P()?"width: 100%":"width: 256px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="toolbarResize" style="    cursor: col-resize;
    box-shadow: 2px 0 0 0 var(--b3-theme-surface) inset, 3px 0 0 0 var(--b3-border-color) inset;
    width: 5px;
    margin-left: -2px;"></div>
<div style="width: 520px;${P()||window.outerWidth<window.outerWidth/2+520?"display:none;":""}overflow: auto;"></div>
</div>`;const s=this.subElement.querySelector(".b3-list");rl(this.subElement.querySelector(".toolbarResize"),s.parentElement);const i=this.subElement.firstElementChild.lastElementChild;let o;s.addEventListener("mouseover",r=>{const d=r.target,c=C(d,"b3-list-item");if(!c)return;const f=c.getAttribute("data-value");o!==f&&(o=f,li(o,i,t.block.parentID),r.stopPropagation())});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const d=!this.subElement.querySelector(".b3-list-item");if(!d){const c=Vt(s,r);if(c){const f=c.getAttribute("data-value");if(o===f)return;o=f,li(o,i,t.block.parentID)}}r.key==="Enter"?(d?X(this.range):ru(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),t,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),X(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),L("/api/search/searchTemplate",{k:l.value},d=>{var c;let f="";d.data.blocks.forEach((u,g)=>{f+=`<div data-value="${u.path}" class="b3-list-item--hide-action b3-list-item${g===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${u.content}</span>`,f+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),s.innerHTML=f||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const m=(c=d.data.blocks[0])==null?void 0:c.path;o!==m&&(o=m,li(o,i,t.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const d=r.target;if(d.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),X(this.range),r.stopPropagation();return}const c=C(d,"b3-list-item__action");if(c&&c.getAttribute("data-type")==="remove"){Ne(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{L("/api/search/removeTemplate",{path:c.parentElement.getAttribute("data-value")},()=>{if(c.parentElement.parentElement.childElementCount===1)c.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,li("",i,t.block.parentID);else{if(c.parentElement.classList.contains("b3-list-item--focus")){const g=c.parentElement.previousElementSibling||c.parentElement.nextElementSibling;g.classList.add("b3-list-item--focus");const y=g.getAttribute("data-value");if(o===y)return;o=y,li(o,i,t.block.parentID)}c.parentElement.remove()}})}),r.stopPropagation();return}if(O(d,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(O(d,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const u=C(d,"b3-list-item");u&&(ru(decodeURIComponent(u.getAttribute("data-value")),t,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),L("/api/search/searchTemplate",{k:""},r=>{let d="";r.data.blocks.forEach((c,f)=>{d+=`<div data-value="${c.path}" class="b3-list-item--hide-action b3-list-item${f===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${c.content}</span>`,d+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Ee(this.subElement,0,0),o=s.firstElementChild.getAttribute("data-value"),li(o,i,t.block.parentID)})}showWidget(t,n,a){this.range=a,ae(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const s=this.subElement.lastElementChild.lastElementChild,i=this.subElement.querySelector("input");i.addEventListener("keydown",o=>{o.stopPropagation(),!o.isComposing&&(Vt(s,o),o.key==="Enter"?(du(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),t),this.subElement.classList.add("fn__none"),o.preventDefault()):o.key==="Escape"&&(this.subElement.classList.add("fn__none"),X(this.range)))}),i.addEventListener("input",o=>{o.stopPropagation(),L("/api/search/searchWidget",{k:i.value},l=>{let r="";l.data.blocks.forEach((d,c)=>{r+=`<div data-value="${d.path}" data-content="${d.content}" class="b3-list-item${c===0?" b3-list-item--focus":""}">
    ${d.name}
    <span class="b3-list-item__meta">${d.content}</span>
</div>`}),s.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",o=>{const l=o.target,r=C(l,"b3-list-item");r&&du(r.dataset.content,t)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),i.select(),L("/api/search/searchWidget",{k:""},o=>{let l="";o.data.blocks.forEach((r,d)=>{l+=`<div class="b3-list-item${d===0?" b3-list-item--focus":""}" data-content="${r.content}">
${r.name}
<span class="b3-list-item__meta">${r.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l,Ee(this.subElement,0,0)})}showContent(t,n,a){var s,i;this.range=n,ae(["hint"],t),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let o="";const l=n.toString()!==""||((i=(s=n.cloneContents().childNodes[0])==null?void 0:s.classList)==null?void 0:i.contains("emoji"));l&&(o+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',t.disabled||(o+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),t.disabled||(o+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(l||!t.disabled)&&(o+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${o}</div>`,this.subElement.lastElementChild.addEventListener("click",d=>Dm(this,null,function*(){const c=C(d.target,"keyboard__action");if(!c)return;const f=c.getAttribute("data-action");if(f==="copy")X(ye(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(f==="cut")X(ye(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(f==="delete"){const m=ye(a);m.insertNode(document.createElement("wbr"));const u=a.outerHTML;m.extractContents(),fe(a,m),X(m),Q(t,a.getAttribute("data-node-id"),a.outerHTML,u),this.subElement.classList.add("fn__none")}else if(f==="paste"){if(X(ye(a)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const m=yield Ls();ps(t,Object.assign(m,{target:a}))}catch(m){console.log(m)}this.subElement.classList.add("fn__none")}else f==="select"?(Il(t,a,n),this.subElement.classList.add("fn__none")):f==="copyPlainText"?(X(ye(a)),qi(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):f==="pasteAsPlainText"?(X(ye(a)),eu(t),this.subElement.classList.add("fn__none")):f==="pasteEscaped"?(X(ye(a)),Xp(t,a),this.subElement.classList.add("fn__none")):f==="back"?this.subElement.lastElementChild.innerHTML=o:f==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${l?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${l?"":" fn__none"}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,Ee(this.subElement,r.left,r.top+28,p.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=Pn(a,n);Ee(this.subElement,r.left,r.top-48,p.SIZE_TOOLBAR_HEIGHT)}genItem(t,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new qa(t,n);break;case"block-ref":a=new xm(t,n);break;case"inline-math":a=new Tm(t,n);break;case"inline-memo":a=new $m(t,n);break;case"|":a=new Sm;break;case"text":a=new ug(t,n);break;case"a":a=new Lm(t,n);break;default:a=new qa(t,n);break}if(a)return a.element}mergeNode(t){for(let n=0;n<t.length;n++)t[n].nodeType!==3&&t[n].tagName==="WBR"&&(t[n].remove(),n--);for(let n=0;n<t.length;n++)t[n].nodeType===3&&(t[n].textContent===""?(t[n].remove(),n--):t[n+1]&&t[n+1].nodeType===3&&(t[n].textContent=t[n].textContent+t[n+1].textContent,t[n+1].remove(),n--))}updateLanguage(t,n,a){const s=a===window.siyuan.languages.clear?"":a;n.app&&n.app.plugins&&n.app.plugins.forEach(l=>{l.eventBus.emit("code-language-change",{language:s,languageElements:t,protyle:n})}),p.SIYUAN_RENDER_CODE_LANGUAGES.includes(s)||(window.siyuan.storage[p.LOCAL_CODELANG]=s,Te(p.LOCAL_CODELANG,window.siyuan.storage[p.LOCAL_CODELANG]));const i=[],o=[];t.forEach(l=>{const r=F(l);if(r){const d=r.getAttribute("data-node-id");o.push({id:d,data:r.outerHTML,action:"update"}),l.textContent=a===window.siyuan.languages.clear?"":a;const c=oe(r);p.SIYUAN_RENDER_CODE_LANGUAGES.includes(s)?(r.dataset.content=c.textContent.trim(),r.dataset.subtype=s,r.className="render-node",r.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div>`,Xe(r)):(c.textContent=c.textContent,c.parentElement.removeAttribute("data-render"),Re(r)),r.setAttribute("updated",G().format("YYYYMMDDHHmmss")),i.push({id:d,data:r.outerHTML,action:"update"})}}),B(n,i,o),this.subElement.classList.add("fn__none"),X(this.range)}}const ms=(e,t,n,a,s)=>{let i=1,o;L(`/api/riff/get${a}RiffCards`,{id:t,page:i},l=>{var r;const d=new ke({positionId:p.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${pe(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${a===""&&t===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${i}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${P()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${P()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${tr(l.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:P()?"100vw":"80vw",height:P()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(u){u!=="d"&&u!=="t"&&o&&o.resize()}});l.data.blocks.length>0&&(o=new Gn(e,d.element.querySelector("#cardPreview"),{blockId:"",action:[p.CB_GET_ALL],render:{gutter:!0,breadcrumbDocName:!0,title:!0,hideTitleOnZoom:!0},typewriterMode:!1}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),d.editors={card:o},o.resize(),Xa(o,(r=d.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const c=d.element.querySelector('[data-type="previous"]'),f=d.element.querySelector('[data-type="next"]'),m=d.element.querySelector(".b3-list--background");l.data.pageCount>1&&f.removeAttribute("disabled"),d.element.setAttribute("data-key",p.DIALOG_VIEWCARDS),d.element.addEventListener("click",u=>{var g;if(typeof u.detail=="string"){let b=m.querySelector(".b3-list-item--focus");if(b){b.classList.remove("b3-list-item--focus"),u.detail==="arrowup"?b=b.previousElementSibling||b.parentElement.lastElementChild:u.detail==="arrowdown"?b=b.nextElementSibling||b.parentElement.firstElementChild:u.detail==="home"?b=b.parentElement.firstElementChild:u.detail==="end"&&(b=b.parentElement.lastElementChild);const w=b.getBoundingClientRect(),h=b.parentElement.getBoundingClientRect();(w.top<h.top||w.bottom>h.bottom)&&b.scrollIntoView(w.top<h.top),Xa(o,b.getAttribute("data-id")),b.classList.add("b3-list-item--focus")}u.stopPropagation(),u.preventDefault();return}let y=u.target;for(;y&&d.element!==y;){const b=y.getAttribute("data-type");if(b==="close"){d.destroy(),u.stopPropagation(),u.preventDefault();break}else if(b==="previous"){if(i<=1)return;i--,i<=1&&c.setAttribute("disabled","disabled"),L(`/api/riff/get${a}RiffCards`,{id:t,page:i},w=>{var h;i===w.data.pageCount?f.setAttribute("disabled","disabled"):w.data.pageCount>1&&f.removeAttribute("disabled"),f.nextElementSibling.nextElementSibling.textContent=`${i}/${w.data.pageCount||1}`,m.innerHTML=tr(w.data.blocks,n,a),m.scrollTop=0,Xa(o,(h=d.element.querySelector(".b3-list-item--focus"))==null?void 0:h.getAttribute("data-id"))}),u.stopPropagation(),u.preventDefault();break}else if(b==="next"){if(i>=l.data.pageCount)return;i++,c.removeAttribute("disabled"),L(`/api/riff/get${a}RiffCards`,{id:t,page:i},w=>{var h;i===w.data.pageCount?f.setAttribute("disabled","disabled"):w.data.pageCount>1&&f.removeAttribute("disabled"),f.nextElementSibling.nextElementSibling.textContent=`${i}/${w.data.pageCount||1}`,m.innerHTML=tr(w.data.blocks,n,a),m.scrollTop=0,Xa(o,(h=d.element.querySelector(".b3-list-item--focus"))==null?void 0:h.getAttribute("data-id"))}),u.stopPropagation(),u.preventDefault();break}else if(b==="reset"){L("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?t:p.QUICK_DECK_ID,id:t,blockIDs:[y.getAttribute("data-id")]},()=>{y.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=G().format("YYYY-MM-DD")}),u.stopPropagation(),u.preventDefault();break}else if(b==="resetAll"){Ne(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",d.element.querySelector(".counter").textContent),()=>{L("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?t:p.QUICK_DECK_ID,id:t},()=>{d.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(w=>{w.textContent=G().format("YYYY-MM-DD")})})}),u.stopPropagation(),u.preventDefault();break}else if(b==="card-item"){Xa(o,y.getAttribute("data-id")),(g=m.querySelector(".b3-list-item--focus"))==null||g.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus"),u.stopPropagation(),u.preventDefault();break}else if(b==="remove"){L("/api/riff/removeRiffCards",{deckID:a===""?t:p.QUICK_DECK_ID,blockIDs:[y.getAttribute("data-id")]},w=>{var h;let S=y.parentElement.nextElementSibling;S||(S=y.parentElement.previousElementSibling),!S&&y.parentElement.parentElement.childElementCount>1&&(S=y.parentElement.parentElement.firstElementChild),S?(Xa(o,S.getAttribute("data-id")),(h=m.querySelector(".b3-list-item--focus"))==null||h.classList.remove("b3-list-item--focus"),S.classList.add("b3-list-item--focus"),y.parentElement.remove()):(Xa(o,""),m.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),d.element.querySelector(".counter").textContent=(parseInt(d.element.querySelector(".counter").textContent)-1).toString(),s&&s(w)}),u.stopPropagation(),u.preventDefault();break}y=y.parentElement}})})},tr=(e,t,n)=>{let a="",s=!0;const i=t.split("/");return i.splice(0,1),e.forEach(o=>{var l,r,d,c;if(o.type){let f;n===""?f=en(o.box)+vt(Lute.UnEscapeHTMLStr(o.hPath),!1):(f=vt(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+i.join("/"),""),f.startsWith("/")&&(f=f.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${s?" b3-list-item--focus":""}${P()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${Ln(o.type)}"></use></svg>
${ge(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||p.ZWSP}</span>
<span class="${P()||!f?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${Ue(f)}">${pe(f)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((l=o.riffCard)==null?void 0:l.reps)===0?" fn__none":""}">${(r=o.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(d=o.riffCard)!=null&&d.due?"":" fn__none"}">${G((c=o.riffCard)==null?void 0:c.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,s=!1}else a+=`<div data-type="card-item" class="b3-list-item${P()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-list-item__action--warning ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),e.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},Xa=(e,t)=>{if(!t){e.protyle.element.classList.add("fn__none"),e.protyle.element.nextElementSibling.classList.remove("fn__none");return}e.protyle.element.classList.remove("fn__none"),e.protyle.element.nextElementSibling.classList.add("fn__none"),e.protyle.scroll.lastScrollTop=0,vi(e.protyle),L("/api/block/getDocInfo",{id:t},n=>{e.protyle.wysiwyg.renderCustom(n.data.ial),L("/api/filetree/getDoc",{id:t,mode:0,size:p.SIZE_GET_MAX},a=>{rt({updateReadonly:!0,data:a,protyle:e.protyle,action:a.data.rootID===a.data.id?[]:[p.CB_GET_ALL]})})})},bs=e=>`<li data-id="${e.id}" data-name="${Ue(e.name)}" class="b3-list-item b3-list-item--narrow${P()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${pe(e.name)}</span>
    <span class="b3-list-item__meta">${e.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-list-item__action--warning b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${P()?" fn__none":""}">${e.updated}</span>
</li>`,ys=(e,t)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===p.DIALOG_MAKECARD)return ae(["dialog"]),!0}),L("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(i=>{a+=bs(i)});const s=new ke({positionId:p.DIALOG_MAKECARD,width:P()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});s.element.setAttribute("data-key",p.DIALOG_MAKECARD),s.element.addEventListener("click",i=>{let o=i.target;for(;o&&o!==s.element;){const l=o.getAttribute("data-type");if(l==="create"){let r="";const d=s.element.querySelector(".b3-text-field");d.value?(r&&tt(r),L("/api/riff/createRiffDeck",{name:d.value},c=>{s.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",bs(c.data)),d.value=""})):(r=se(window.siyuan.languages._kernel[142]),d.focus()),i.stopPropagation(),i.preventDefault();break}else if(l==="add"){L("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:t},r=>{o.parentElement.outerHTML=bs(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="remove"){L("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:t},r=>{o.parentElement.outerHTML=bs(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="delete"){Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{L("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})},void 0,!0),i.stopPropagation(),i.preventDefault();break}else if(l==="view"){ms(e,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=bs(r.data)}),i.stopPropagation(),i.preventDefault();break}else if(l==="viewall"){ms(e,"",window.siyuan.languages.all,""),i.stopPropagation(),i.preventDefault();break}else if(l==="rename"){const r=new ke({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"}),d=r.element.querySelector("input"),c=r.element.querySelectorAll(".b3-button");r.bindInput(d,()=>{c[1].click()}),d.value=o.parentElement.getAttribute("data-name"),d.focus(),d.select(),c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{L("/api/riff/renameRiffDeck",{name:d.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=d.value,o.parentElement.setAttribute("data-name",d.value)}),r.destroy()}),i.stopPropagation(),i.preventDefault();break}o=o.parentElement}})})},nr=(e,t)=>{let n=!0;const a=[];t.forEach(s=>{s.getAttribute("data-type")!=="NodeThematicBreak"&&(s.classList.remove("protyle-wysiwyg--select"),a.push(s.getAttribute("data-node-id")),(s.getAttribute(p.CUSTOM_RIFF_DECKS)||"").indexOf(p.QUICK_DECK_ID)===-1&&(n=!1))}),n?B(e,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}]):B(e,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}])},Eu=e=>{window.siyuan.menus.menu.append(new H({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const t=new ke({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});t.element.setAttribute("data-key",p.DIALOG_TRANSFERBLOCKREF);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{L("/api/block/transferBlockRef",{fromID:e,toID:n.value}),t.destroy()})}}).element)},ar=e=>{const t=[];e.forEach(n=>{const a=n.getAttribute("data-node-id");a&&t.push({itemID:Lute.NewNodeID(),id:a,isDetached:!1})}),t.length>0&&ji("",e[0],n=>{const a=n.dataset.avId,s=n.dataset.viewId;B(void 0,[{action:"insertAttrViewBlock",ignoreDefaultFill:!s,viewID:s,avID:a,srcs:t,blockID:n.dataset.blockId},{action:"doUpdateUpdated",id:n.dataset.blockId,data:G().format("YYYYMMDDHHmmss")}])})},fl=(e,t,n)=>{var a,s;if(t&&((s=(a=e.title)==null?void 0:a.editElement)!=null&&s.contains(t.startContainer))||n==="title")ji("",e.breadcrumb.element,i=>{const o=i.dataset.avId,l=i.dataset.viewId;B(e,[{action:"insertAttrViewBlock",ignoreDefaultFill:!l,viewID:l,avID:o,srcs:[{itemID:Lute.NewNodeID(),id:e.block.rootID,isDetached:!1}],blockID:i.dataset.blockId},{action:"doUpdateUpdated",id:i.dataset.blockId,data:G().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[e.block.rootID],avID:o}]),X(t)});else{let i;const o=[];if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(l=>{i||(i=l),o.push(l.getAttribute("data-node-id"))}),!i){const l=F(t.startContainer);l&&(i=l,o.push(l.getAttribute("data-node-id")))}i||(i=e.wysiwyg.element,o.push(e.block.rootID)),ji("",i,l=>{const r=[],d=[];o.forEach(m=>{r.push(m),d.push({itemID:Lute.NewNodeID(),id:m,isDetached:!1})});const c=l.dataset.avId,f=l.dataset.viewId;B(e,[{action:"insertAttrViewBlock",ignoreDefaultFill:!f,viewID:f,avID:c,srcs:d,blockID:l.dataset.blockId},{action:"doUpdateUpdated",id:l.dataset.blockId,data:G().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:r,avID:c}]),X(t)})}};var Hm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Nm{constructor(t){$t()?this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",Xn(window.siyuan.config.keymap.general.enter.custom,"/")).replace("\u2318\u2191",Xn(window.siyuan.config.keymap.editor.general.collapse.custom,"/")).replace("\u2325\u2318A",Xn(window.siyuan.config.keymap.editor.general.attr.custom,"/")):this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",Xn(window.siyuan.config.keymap.general.enter.custom,"/")).replace("\u2318\u2191",Xn(window.siyuan.config.keymap.editor.general.collapse.custom,"/")).replace("\u2325\u2318A",Xn(window.siyuan.config.keymap.editor.general.attr.custom,"/")).replace(//g,"Ctrl+").replace(//g,"Alt+").replace(//g,"Shift+").replace(//g,"Ctrl+"),t.options.backlinkData&&(this.gutterTip=this.gutterTip.replace(window.siyuan.languages.enter,window.siyuan.languages.openBy)),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{var a;xn(),window.siyuan.menus.menu.remove();const s=n.target.parentElement;let i=[],o=[],l;if(s.dataset.rowId){if(l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${s.dataset.nodeId}"]`)).find(c=>{if(!de(c)&&!pt(c))return!0}),(a=l.querySelector('.block__icon[data-type="av-sort"]'))!=null&&a.classList.contains("block__icon--active")){const c=l.querySelectorAll(".av__body");if(c.length===1){n.preventDefault(),n.stopPropagation();return}else if(["template","created","updated"].includes(c[0].getAttribute("data-dtype"))){n.preventDefault(),n.stopPropagation();return}}const d=l.querySelector(`.av__body${s.dataset.groupId?`[data-group-id="${s.dataset.groupId}"]`:""} .av__row[data-id="${s.dataset.rowId}"]`);d.classList.contains("av__row--select")||l.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(c=>{c.classList.remove("av__row--select"),c.querySelector("use").setAttribute("xlink:href","#iconUncheck")}),d.classList.add("av__row--select"),d.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck"),La(d),l.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(c=>{var f;const m=((f=C(c,"av__body"))==null?void 0:f.dataset.groupId)||"";i.push(c.getAttribute("data-id")+(m?"@"+m:"")),o.push(c)})}else{const d=s.getAttribute("data-node-id");o=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let c=!1;if(o.forEach(f=>{const m=f.getAttribute("data-node-id");m===d&&(c=!0),i.push(m)}),!c){let f;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${d}"]`)).find(m=>{if(!de(m)&&this.isMatchNode(m))return f=m,!0}),f&&(o.forEach(m=>{m.classList.remove("protyle-wysiwyg--select")}),f.classList.add("protyle-wysiwyg--select"),o=[f],i=[d])}}const r=document.createElement("div");r.className=t.wysiwyg.element.className,o.forEach(d=>{if(d.querySelector("iframe")){const c=d.getAttribute("data-type"),f=yn();f.classList.add("protyle-wysiwyg--select"),oe(f).innerHTML=`<svg class="svg"><use xlink:href="${s.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${np(c)}`,r.append(f)}else r.append(un(d.cloneNode(!0)))}),r.setAttribute("style",`position:fixed;opacity:.1;width:${o[0].clientWidth}px;padding:0;`),document.body.append(r),n.dataTransfer.setDragImage(r,0,0),setTimeout(()=>{r.remove()}),s.style.opacity="0.38",window.siyuan.dragElement=l||t.wysiwyg.element,n.dataTransfer.setData(`${p.SIYUAN_DROP_GUTTER}${s.getAttribute("data-type")}${p.ZWSP}${s.getAttribute("data-subtype")}${p.ZWSP}${i}${p.ZWSP}${window.siyuan.config.system.workspaceDir}`,t.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{var a;const s=U(n.target,"BUTTON");if(!s)return;n.preventDefault(),n.stopPropagation(),xn(),Et(["av","img"],t.wysiwyg.element);const i=s.getAttribute("data-node-id");if(!i){if(s.getAttribute("disabled"))return;s.setAttribute("disabled","disabled");let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${(s.previousElementSibling||s.nextElementSibling).getAttribute("data-node-id")}"]`)).find(r=>{if(!de(r)&&this.isMatchNode(r))return l=r,!0}),!l)return;if(n.altKey){let r=!0;Array.from(l.children).find(f=>{if(f.classList.contains("list")&&Array.from(f.children).find(u=>{if(u.classList.contains("li")&&u.getAttribute("fold")!=="1"&&u.childElementCount>3)return r=!1,!0}))return!0});const d=[],c=[];Array.from(l.children).forEach(f=>{f.classList.contains("list")&&Array.from(f.children).forEach(m=>{if(m.classList.contains("li")){r?m.removeAttribute("fold"):m.childElementCount>3&&m.setAttribute("fold","1");const u=m.getAttribute("data-node-id");d.push({action:"setAttrs",id:u,data:JSON.stringify({fold:r?"":"1"})}),c.push({action:"setAttrs",id:u,data:JSON.stringify({fold:r?"1":""})})}})}),B(t,d,c),s.removeAttribute("disabled")}else{const r=at(t,l).fold;r===1?s.firstElementChild.style.transform="":r===0&&(s.firstElementChild.style.transform="rotate(90deg)")}ae(["select"],t),window.siyuan.menus.menu.remove();return}const o=s.getBoundingClientRect();if(s.dataset.type==="NodeAttributeViewRowMenu"||s.dataset.type==="NodeAttributeViewRow"){const l=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${s.dataset.nodeId}"] .av__row[data-id="${s.dataset.rowId}"]`)).find(d=>{if(!de(d))return!0});if(!l)return;const r=F(l);if(!r)return;if(s.dataset.type==="NodeAttributeViewRow"){const d=r.getAttribute("data-av-id"),c=[Lute.NewNodeID()],f=n.altKey?l.previousElementSibling.getAttribute("data-id")||"":s.dataset.rowId,m=G().format("YYYYMMDDHHmmss"),u=l.parentElement.getAttribute("data-group-id");B(t,[{action:"insertAttrViewBlock",avID:d,previousID:f,srcs:[{itemID:Lute.NewNodeID(),id:c[0],isDetached:!0,content:""}],blockID:i,groupID:u},{action:"doUpdateUpdated",id:i,data:m}],[{action:"removeAttrViewBlock",srcIDs:c,avID:d},{action:"doUpdateUpdated",id:i,data:r.getAttribute("updated")}]),sl({protyle:t,blockElement:r,srcIDs:c,previousId:f,groupID:u}),n.altKey&&this.element.querySelectorAll("button").forEach(g=>{g.dataset.rowId=c[0]}),r.setAttribute("updated",m)}else{if(!t.disabled&&n.shiftKey){const d=(a=l.querySelector('[data-dtype="block"] .av__celltext--ref'))==null?void 0:a.getAttribute("data-id");if(d){L("/api/attr/getBlockAttrs",{id:d},c=>{vn(c.data,"av",t)});return}}Ki(t,l,{x:o.left,y:o.bottom,w:o.width,h:o.height,isLeft:!0})}return}if(Lt(n))t.options.backlinkData?Jn(i,(l,r)=>{openFileById({app:t.app,id:i,action:r,zoomIn:l})}):Bt({protyle:t,id:i});else if(n.altKey){let l;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(r=>{if(!de(r)&&this.isMatchNode(r))return l=r,!0}),!l)return;if(s.getAttribute("data-type")==="NodeListItem"&&l.parentElement.getAttribute("data-node-id")){let r=!0;Array.from(l.parentElement.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return r=!1,!0}),s.parentElement.querySelector("[data-type='fold'] > svg").style.transform=r?"rotate(90deg)":"";const d=[],c=[];Array.from(l.parentElement.children).find(f=>{if(f.classList.contains("li")){r?f.removeAttribute("fold"):f.childElementCount>3&&f.setAttribute("fold","1");const m=f.getAttribute("data-node-id");d.push({action:"setAttrs",id:m,data:JSON.stringify({fold:r?"":"1"})}),c.push({action:"setAttrs",id:m,data:JSON.stringify({fold:r?"1":""})})}}),B(t,d,c)}else{const r=at(t,l).fold,d=s.parentElement.querySelector("[data-type='fold'] > svg");r!==-1&&d&&(d.style.transform=r===0?"rotate(90deg)":"")}l.classList.remove("protyle-wysiwyg--hl")}else n.shiftKey&&!t.disabled?ta(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",t):!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(t,s),t.toolbar.range||(t.toolbar.range=ye(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}),this.element.addEventListener("contextmenu",n=>{const a=U(n.target,"BUTTON");if(!(!a||a.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){xn(),Et(["av","img"],t.wysiwyg.element);const s=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"){const i=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(o=>{if(!de(o))return!0});i&&Ki(t,i,{x:s.left,y:s.bottom,w:s.width,h:s.height,isLeft:!0})}else a.dataset.type!=="NodeAttributeViewRow"&&(this.renderMenu(t,a),t.toolbar.range||(t.toolbar.range=ye(t.wysiwyg.element.querySelector(`[data-node-id="${a.getAttribute("data-node-id")}"]`)||t.wysiwyg.element.firstElementChild)),window.siyuan.menus.menu.fullscreen())}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseleave",n=>{Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()}),this.element.addEventListener("mousewheel",n=>{ae(["gutter"],t),n.stopPropagation()},{passive:!0})}isMatchNode(t){const n=t.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+6;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){wi(t)}}}turnsIntoOne(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){_n(t)}}}turnsInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){kn(t)}}}showMobileAppearance(t){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const s=t.contentElement.scrollTop+333.5;Hd(t,n),io(s)}renderMultipleMenu(t,n){var a;let s=!1,i=!1;if(n.find((r,d)=>{if(r.classList.contains("li"))return s=!0,!0;if(r.nextElementSibling&&n[d+1]&&r.nextElementSibling===n[d+1])i=!0;else if(d!==n.length-1)return i=!1,!0}),!s&&!t.disabled){const r=[];i&&(r.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:t,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:n,type:"Blocks2ULs"})),r.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:n,type:"Blocks2OLs"})),r.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:n,type:"Blocks2TLs"})),r.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:n,type:"Blocks2Blockquote"}))),r.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:n,type:"Blocks2Ps",isContinue:i})),r.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:i})),r.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:i})),r.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:i})),r.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:i})),r.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:i})),r.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new H({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:r}).element),i&&!(n[0].parentElement.classList.contains("sb")&&n.length+1===n[0].parentElement.childElementCount)&&window.siyuan.menus.menu.append(new H({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}t.disabled||window.siyuan.menus.menu.append(new H({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){Xo(n,t)}}).element);const o=oi(Array.from(n).map(r=>r.getAttribute("data-node-id")),!0,n[0]).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let r="";n.forEach(d=>{r+=ol(d)+`
`}),qi(r.trimEnd()),te(n[0])}},{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){It(n[0])?te(n[0]):X(ye(n[0])),document.execCommand("copy")}}]),l=this.genCopyTextRef(n);if(l&&o.splice(7,0,l),t.disabled||o.push({id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){co(n,t)}}),window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),!t.disabled){window.siyuan.menus.menu.append(new H({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{te(n[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new H({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{ca(d=>{Zo(d[0],n,t)})}}).element),window.siyuan.menus.menu.append(new H({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{fl(t,ye(n[0]))}}).element),window.siyuan.menus.menu.append(new H({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var d;(d=t.breadcrumb)==null||d.hide(),bn(t,n[0],ye(n[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new H({id:"separator_appearance",type:"separator"}).element);const r=new H({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(r),P()||r.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,t),this.genWidths(n,t)}if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(new H({id:"separator_quickMakeCard",type:"separator"}).element);const r=!n.some(d=>!d.hasAttribute(p.CUSTOM_RIFF_DECKS)&&d.getAttribute("data-type")!=="NodeThematicBreak");window.siyuan.menus.menu.append(new H({id:r?"removeCard":"quickMakeCard",label:r?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,icon:"iconRiffCard",click(){nr(t,n)}}).element),window.siyuan.menus.menu.append(new H({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const d=[];n.forEach(c=>{c.getAttribute("data-type")!=="NodeThematicBreak"&&d.push(c.getAttribute("data-node-id"))}),ys(t.app,d)}}).element)}return(a=t==null?void 0:t.app)!=null&&a.plugins&&tn({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(t,n){var a,s;if(!n)return;ae(["util","toolbar","hint"],t),window.siyuan.menus.menu.remove(),P()&&mn();const i=n.getAttribute("data-node-id"),o=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(o.length>1){if(window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BLOCK_MULTI),Array.from(o).find(y=>{if(i===y.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(t,Array.from(o))}else window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BLOCK_SINGLE);let l;if(n.tagName==="BUTTON"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(g=>{if(!de(g)&&this.isMatchNode(g))return l=g,!0}):l=n,!l)return;const r=l.getAttribute("data-type"),d=l.getAttribute("data-subtype"),c=[];ae(["select"],t),l.classList.add("protyle-wysiwyg--select"),Yt([i],t.block.rootID),r==="NodeParagraph"&&!t.disabled?(c.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,selectsElement:[l],type:"Blocks2ULs"})),c.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:[l],type:"Blocks2OLs"})),c.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:[l],type:"Blocks2TLs"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),c.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!t.disabled?(c.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:[l],type:"Blocks2Ps"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),d!=="h1"&&c.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),d!=="h2"&&c.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),d!=="h3"&&c.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),d!=="h4"&&c.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),d!=="h5"&&c.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),d!=="h6"&&c.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!t.disabled?(c.push(this.turnsOneInto({menuId:"paragraph",id:i,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelList"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),l.getAttribute("data-subtype")==="o"?(c.push(this.turnsOneInto({menuId:"list",id:i,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"OL2UL"})),c.push(this.turnsOneInto({menuId:"check",id:i,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"UL2TL"}))):l.getAttribute("data-subtype")==="t"?(c.push(this.turnsOneInto({menuId:"list",id:i,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"TL2UL"})),c.push(this.turnsOneInto({menuId:"orderedList",id:i,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"TL2OL"}))):(c.push(this.turnsOneInto({menuId:"orderedList",id:i,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"UL2OL"})),c.push(this.turnsOneInto({menuId:"check",id:i,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"OL2TL"})))):r==="NodeBlockquote"&&!t.disabled&&c.push(this.turnsOneInto({menuId:"paragraph",id:i,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelBlockquote"})),c.length>0&&!t.disabled&&window.siyuan.menus.menu.append(new H({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:c}).element),!t.disabled&&!l.classList.contains("hr")&&window.siyuan.menus.menu.append(new H({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){Xo([l],t)}}).element);const f=oi([i],!0,l).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){qi(ol(l).trimEnd()),te(l)}},{id:r==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){It(l)?te(l):X(ye(l)),document.execCommand("copy")}}]),m=this.genCopyTextRef([l]);if(m&&f.splice(7,0,m),r==="NodeAttributeView"?(f.splice(6,0,{iconHTML:"",label:window.siyuan.languages.copyAVID,click(){He(l.getAttribute("data-av-id"))}}),t.disabled||(f.push({id:"duplicateMirror",iconHTML:"",label:window.siyuan.languages.duplicateMirror,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){co([l],t)}}),f.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,click(){Qf(t,l)}}))):t.disabled||f.push({id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){co([l],t)}}),window.siyuan.menus.menu.append(new H({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:f}).element),t.disabled||(window.siyuan.menus.menu.append(new H({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{te(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new H({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{ca(g=>{Zo(g[0],[l],t)})}}).element),window.siyuan.menus.menu.append(new H({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{fl(t,ye(l))}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{var g;(g=t.breadcrumb)==null||g.hide(),bn(t,l,ye(l),"Backspace")}}).element)),r==="NodeSuperBlock"&&!t.disabled){let g;window.siyuan.menus.menu.append(new H({id:"separator_cancelSuperBlock",type:"separator"}).element);const y=l.getAttribute("data-sb-layout")==="col";window.siyuan.menus.menu.append(new H({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,accelerator:window.siyuan.config.keymap.editor.general[y?"hLayout":"vLayout"].custom,click(){return Hm(this,null,function*(){const b=yield Ea(t,l);B(t,b.doOperations,b.undoOperations),te(t.wysiwyg.element.querySelector(`[data-node-id="${b.previousId}"]`)),ae(["gutter"],t)})}}).element),window.siyuan.menus.menu.append(new H({id:"turnInto"+(y?"VLayout":"HLayout"),accelerator:window.siyuan.config.keymap.editor.general[y?"vLayout":"hLayout"].custom,label:window.siyuan.languages.turnInto+" "+window.siyuan.languages[y?"vLayout":"hLayout"],click(){const b=l.outerHTML;y?l.setAttribute("data-sb-layout","row"):l.setAttribute("data-sb-layout","col"),l.setAttribute("updated",G().format("YYYYMMDDHHmmss")),Q(t,i,l.outerHTML,b),X(t.toolbar.range),ae(["gutter"],t)}}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&!l.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new H({id:"separator_code",type:"separator"}).element);const g=l.getAttribute("linewrap"),y=l.getAttribute("ligatures"),b=l.getAttribute("linenumber");window.siyuan.menus.menu.append(new H({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.codeLineWrap&&g!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",h=>{const S=w.querySelector("input");h.target.tagName!=="INPUT"&&(S.checked=!S.checked),l.setAttribute("linewrap",S.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),Re(l),L("/api/attr/setBlockAttrs",{id:i,attrs:{linewrap:S.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${y==="true"||window.siyuan.config.editor.codeLigatures&&y!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",h=>{const S=w.querySelector("input");h.target.tagName!=="INPUT"&&(S.checked=!S.checked),l.setAttribute("ligatures",S.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),Re(l),L("/api/attr/setBlockAttrs",{id:i,attrs:{ligatures:S.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&b!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",h=>{const S=w.querySelector("input");h.target.tagName!=="INPUT"&&(S.checked=!S.checked),l.setAttribute("linenumber",S.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),Re(l),L("/api/attr/setBlockAttrs",{id:i,attrs:{linenumber:S.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&["echarts","mindmap"].includes(l.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new H({id:"separator_chart",type:"separator"}).element);const g=l.style.height;let y=l.outerHTML;window.siyuan.menus.menu.append(new H({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${g?parseInt(g):"420"}" step="1" min="148" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind:b=>{b.querySelector("input").addEventListener("change",w=>{const h=(w.target.value||"420")+"px";l.style.height=h,Q(t,i,l.outerHTML,y),y=l.outerHTML,w.stopPropagation();const S=l.querySelector('[contenteditable="false"]');if(S){S.style.height=h;const $=window.echarts.getInstanceById(S.getAttribute("_echarts_instance_"));$&&$.resize()}})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){t.toolbar.showRender(t,l)}}]}).element)}else if(r==="NodeTable"&&!t.disabled){let g=ye(l);const y=l.querySelector("table");y.contains(g.startContainer)||(g=ye(y.querySelector("th")));const b=U(g.startContainer,"TD")||U(g.startContainer,"TH");b&&(window.siyuan.menus.menu.append(new H({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:Kg(t,l,b,g).menus}).element))}else if(r==="NodeAttributeView")window.siyuan.menus.menu.append(new H({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){L("/api/export/exportAttributeView",{id:l.getAttribute("data-av-id"),blockID:i},g=>{Nt(g.data.zip)})}}).element),window.siyuan.menus.menu.append(new H({id:"showDatabaseInFolder",icon:"iconFolder",label:window.siyuan.languages.showInFolder,click(){_f("showItemInFolder",path.join(window.siyuan.config.system.dataDir,"storage","av",l.getAttribute("data-av-id"))+".json")}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!t.disabled)window.siyuan.menus.menu.append(new H({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:r==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:zg(t,l,r)}).element);else if(r==="NodeIFrame"&&!t.disabled)window.siyuan.menus.menu.append(new H({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:Gg(t,l)}).element);else if(r==="NodeHTMLBlock"&&!t.disabled)window.siyuan.menus.menu.append(new H({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"html",icon:"iconHTML5",label:"HTML",click(){t.toolbar.showRender(t,l)}}).element);else if(r==="NodeBlockQueryEmbed"&&!t.disabled){window.siyuan.menus.menu.append(new H({id:"separator_blockEmbed",type:"separator"}).element);const g=l.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new H({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){l.removeAttribute("data-render"),xe(t,l)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){t.toolbar.showRender(t,l)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&g!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",b=>{const w=y.querySelector("input");b.target.tagName!=="INPUT"&&(w.checked=!w.checked),l.setAttribute("breadcrumb",w.checked.toString()),L("/api/attr/setBlockAttrs",{id:i,attrs:{breadcrumb:w.checked.toString()}}),l.removeAttribute("data-render"),xe(t,l),window.siyuan.menus.menu.remove()})}},{id:"headingEmbedMode",label:window.siyuan.languages.headingEmbedMode,type:"submenu",submenu:[{id:"showHeadingWithBlocks",label:window.siyuan.languages.showHeadingWithBlocks,iconHTML:"",checked:l.getAttribute("custom-heading-mode")==="0",click(){l.setAttribute("custom-heading-mode","0"),L("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":"0"}}),l.removeAttribute("data-render"),xe(t,l)}},{id:"showHeadingOnlyTitle",label:window.siyuan.languages.showHeadingOnlyTitle,iconHTML:"",checked:l.getAttribute("custom-heading-mode")==="1",click(){l.setAttribute("custom-heading-mode","1"),L("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":"1"}}),l.removeAttribute("data-render"),xe(t,l)}},{id:"showHeadingOnlyBlocks",label:window.siyuan.languages.showHeadingOnlyBlocks,iconHTML:"",checked:l.getAttribute("custom-heading-mode")==="2",click(){l.setAttribute("custom-heading-mode","2"),L("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":"2"}}),l.removeAttribute("data-render"),xe(t,l)}},{id:"default",label:window.siyuan.languages.default,iconHTML:"",checked:!l.getAttribute("custom-heading-mode"),click(){l.removeAttribute("custom-heading-mode"),L("/api/attr/setBlockAttrs",{id:i,attrs:{"custom-heading-mode":""}}),l.removeAttribute("data-render"),xe(t,l)}}]}]}).element)}else if(r==="NodeHeading"&&!t.disabled){window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element);const g=[];d!=="h1"&&g.push(this.genHeadingTransform(t,i,1)),d!=="h2"&&g.push(this.genHeadingTransform(t,i,2)),d!=="h3"&&g.push(this.genHeadingTransform(t,i,3)),d!=="h4"&&g.push(this.genHeadingTransform(t,i,4)),d!=="h5"&&g.push(this.genHeadingTransform(t,i,5)),d!=="h6"&&g.push(this.genHeadingTransform(t,i,6)),window.siyuan.menus.menu.append(new H({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:g}).element),window.siyuan.menus.menu.append(new H({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){L("/api/block/getHeadingChildrenDOM",{id:i,removeFoldAttr:l.getAttribute("fold")!=="1"},y=>{Je()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(y.data).trimEnd(),y.data+p.ZWSP):ut()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(y.data).trimEnd(),y.data+p.ZWSP):He(y.data+p.ZWSP)})}}).element),window.siyuan.menus.menu.append(new H({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){L("/api/block/getHeadingChildrenDOM",{id:i,removeFoldAttr:l.getAttribute("fold")!=="1"},y=>{Je()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(y.data).trimEnd(),y.data+p.ZWSP):ut()?window.JSHarmony.writeHTMLClipboard(t.lute.BlockDOM2StdMd(y.data).trimEnd(),y.data+p.ZWSP):He(y.data+p.ZWSP),L("/api/block/getHeadingDeleteTransaction",{id:i},b=>{if(b.data.doOperations.forEach(w=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${w.id}"]`).forEach(h=>{h.remove()})}),t.wysiwyg.element.childElementCount===0){const w=Lute.NewNodeID(),h=yn(!1,!1,w);t.wysiwyg.element.insertAdjacentElement("afterbegin",h),b.data.doOperations.push({action:"insert",data:h.outerHTML,id:w,parentID:t.block.parentID}),b.data.undoOperations.push({action:"delete",id:w}),te(h)}B(t,b.data.doOperations,b.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new H({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){L("/api/block/getHeadingDeleteTransaction",{id:i},y=>{if(y.data.doOperations.forEach(b=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${b.id}"]`).forEach(w=>{w.remove()})}),t.wysiwyg.element.childElementCount===0){const b=Lute.NewNodeID(),w=yn(!1,!1,b);t.wysiwyg.element.insertAdjacentElement("afterbegin",w),y.data.doOperations.push({action:"insert",data:w.outerHTML,id:b,parentID:t.block.parentID}),y.data.undoOperations.push({action:"delete",id:b}),te(w)}B(t,y.data.doOperations,y.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),t.options.backlinkData||(window.siyuan.menus.menu.append(new H({id:"enter",accelerator:`${window.siyuan.config.keymap.general.enter.custom?je(window.siyuan.config.keymap.general.enter.custom)+"/":""}${Xn("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{Bt({protyle:t,id:i})}}).element),window.siyuan.menus.menu.append(new H({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{wo(t,i)}}).element)),!t.disabled){window.siyuan.menus.menu.append(new H({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages.insertBefore,accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){ae(["select"],t),Yt([],t.block.rootID),an(t,"beforebegin",i)}}).element),window.siyuan.menus.menu.append(new H({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages.insertAfter,accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){ae(["select"],t),Yt([],t.block.rootID),an(t,"afterend",i)}}).element);const g=l.lastElementChild.querySelector(".protyle-attr--refcount");g&&g.textContent&&Eu(i)}if(window.siyuan.menus.menu.append(new H({id:"jumpTo",type:"submenu",label:window.siyuan.languages.jumpTo,submenu:[{id:"jumpToParentPrev",iconHTML:"",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){ae(["select"],t),ci(t,l,"previous")}},{iconHTML:"",id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){ae(["select"],t),ci(t,l,"next")}},{iconHTML:"",id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){ae(["select"],t),ci(t,l,"parent")}}]}).element),window.siyuan.menus.menu.append(new H({id:"separator_3",type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new H({id:"fold",label:window.siyuan.languages.fold,accelerator:`${je(window.siyuan.config.keymap.editor.general.collapse.custom)}/${je("\u2325"+window.siyuan.languages.click)}`,click(){at(t,l),te(l)}}).element),t.disabled||window.siyuan.menus.menu.append(new H({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+je("\u21E7"+window.siyuan.languages.click),click(){ta(l,"bookmark",t)}}).element)),!t.disabled){const g=new H({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(g),P()||g.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([l],t),this.genWidths([l],t)}if(window.siyuan.menus.menu.append(new H({id:"separator_4",type:"separator"}).element),window.siyuan.config.cloudRegion===0&&!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((a=oe(l))==null?void 0:a.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!l.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new H({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){rg(l)}}).element),r!=="NodeThematicBreak"&&!window.siyuan.config.readonly){const g=l.hasAttribute(p.CUSTOM_RIFF_DECKS);window.siyuan.menus.menu.append(new H({id:g?"removeCard":"quickMakeCard",icon:"iconRiffCard",label:g?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click(){nr(t,[l])}}).element),window.siyuan.menus.menu.append(new H({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){ys(t.app,[i])}}).element),window.siyuan.menus.menu.append(new H({id:"separator_5",type:"separator"}).element)}(s=t==null?void 0:t.app)!=null&&s.plugins&&tn({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:[l]},separatorPosition:"bottom"});let u=l.getAttribute("updated")||"";return u&&(u=`${window.siyuan.languages.modifiedAt} ${G(u).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new H({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${u}${window.siyuan.languages.createdAt} ${G(i.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(t,n,a){return{id:"heading"+a,iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){L("/api/block/getHeadingLevelTransaction",{id:n,level:a},s=>{s.data.doOperations.forEach((i,o)=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(l=>{l.outerHTML=i.data}),t.wysiwyg.element.querySelectorAll(`[data-node-id="${i.id}"]`).forEach(l=>{jt(l)}),o===0&&te(t.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),t.wysiwyg.element,!0)}),B(t,s.data.doOperations,s.data.undoOperations)})}}}genClick(t,n,a){Aa(t,n,a),te(t[0])}genAlign(t,n){window.siyuan.menus.menu.append(new H({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="":a.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="center":a.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="flex-end":a.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(t,n,a=>{a.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,accelerator:window.siyuan.config.keymap.editor.general.ltr.custom,click:()=>{this.genClick(t,n,a=>{a.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,accelerator:window.siyuan.config.keymap.editor.general.rtl.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="":(a.style.textAlign="",a.style.direction="")})}}]}).element)}updateNodeElements(t,n,a){const s=[],i=[];t.forEach(o=>{s.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),a.addEventListener(a.type==="number"?"blur":"change",()=>{t.forEach(o=>{i.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),B(n,i,s),window.siyuan.menus.menu.remove(),te(t[0])})}genWidths(t,n){let a;const s=t[0],i=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${s.style.width.endsWith("px")?parseInt(s.style.width):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.width}"><span class="fn__flex-center">px</span></div>`,bind:l=>{const r=l.querySelector("input");r.addEventListener("input",()=>{t.forEach(d=>{d.style.width=r.value+"px",d.style.flex="none"}),a.value="0",a.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(t,n,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(l=>{i.push({id:"width_"+l,iconHTML:"",label:l,click:()=>{this.genClick(t,n,r=>{r.style.width=l,r.style.flex="none"})}})}),i.push({id:"separator_1",type:"separator"});const o=s.style.width.endsWith("%")?parseInt(s.style.width):0;window.siyuan.menus.menu.append(new H({id:"width",label:window.siyuan.languages.width,submenu:i.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${s.style.width.endsWith("px")?s.style.width:s.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${o}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind:l=>{a=l.querySelector("input"),a.addEventListener("input",()=>{t.forEach(r=>{r.style.width=a.value+"%",r.style.flex="none"}),a.parentElement.setAttribute("aria-label",`${a.value}%`)}),this.updateNodeElements(t,n,a)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,n,l=>{l.style.width&&(l.style.width="",l.style.flex="")})}}])}).element)}genHeights(t,n){if(t.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let s;const i=t[0],o=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex"><input class="b3-text-field fn__flex-1" value="${i.style.height.endsWith("px")?parseInt(i.style.height):""}" type="number" style="margin: 4px 8px 4px 0" placeholder="${window.siyuan.languages.height}"><span class="fn__flex-center">px</span></div>`,bind:r=>{const d=r.querySelector("input");d.addEventListener("input",()=>{t.forEach(c=>{c.style.height=d.value+"px",c.style.flex="none"}),s.value="0",s.parentElement.setAttribute("aria-label",d.value+"px")}),this.updateNodeElements(t,n,d)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{o.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(t,n,d=>{d.style.height=r,d.style.flex="none"})}})}),o.push({type:"separator"});const l=i.style.height.endsWith("%")?parseInt(i.style.height):0;window.siyuan.menus.menu.append(new H({id:"heightDrag",label:window.siyuan.languages.height,submenu:o.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${i.style.height.endsWith("px")?i.style.height:i.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n"><input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range"></div>`,bind:r=>{s=r.querySelector("input"),s.addEventListener("input",()=>{t.forEach(d=>{d.style.height=s.value+"%",d.style.flex="none"}),s.parentElement.setAttribute("aria-label",`${s.value}%`)}),this.updateNodeElements(t,n,s)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,n,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(t){return It(t[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){t[0].setAttribute("data-reftext","true"),X(ye(t[0])),document.execCommand("copy")}}}render(t,n,a,s){var i;if(t.title&&t.title.element.getAttribute("data-render")!=="true")return;const o=a.parentElement.parentElement.querySelector(".protyle-select");if(o&&!o.classList.contains("fn__none"))return;let l="",r=n,d=0,c=0,f,m=!1;for(;r;){let S=F(r.parentElement);if(!de(r)){let $;m||($=r.getAttribute("data-type"));let D=r.getAttribute("data-node-id");if($==="NodeAttributeView"&&s){const A=C(s,"av__row");if(A&&!A.classList.contains("av__row--header")&&A.dataset.id){n=A;const x=C(A,"av__body");let I=$t()?window.siyuan.languages.rowTip:window.siyuan.languages.rowTip.replace("\u21E7","Shift+");t.disabled?I=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.indexOf("<br")):((i=A.querySelector('[data-dtype="block"]'))==null?void 0:i.getAttribute("data-detached"))==="true"&&(I=window.siyuan.languages.rowTip.substring(0,window.siyuan.languages.rowTip.lastIndexOf("<br"))),l=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${D}" data-row-id="${A.dataset.id}" data-group-id="${x.dataset.groupId||""}" class="ariaLabel" data-position="parentW" aria-label="${I}"><svg><use xlink:href="#iconDrag"></use></svg><span ${t.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,t.disabled||(l=`<button data-type="NodeAttributeViewRow" data-node-id="${D}" data-row-id="${A.dataset.id}" data-group-id="${x.dataset.groupId||""}" class="ariaLabel" data-position="parentW" aria-label="${$t()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${l}`);break}}if(c===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes($))return;const A=Ve(r);f=A.querySelector(".li")||A.querySelector(".list"),(de(f)||pt(f))&&(f=void 0),A!==r&&$!=="NodeHeading"&&(r=A,S=F(r.parentElement),$=r.getAttribute("data-type"),D=r.getAttribute("data-node-id"))}$==="NodeListItem"&&c===1&&(l=""),c+=1;let v=this.gutterTip;t.disabled&&(v=this.gutterTip.split("<br>").splice(0,2).join("<br>"));let k="";t.options.backlinkData&&(k=`class="popover__block" data-id="${D}"`);const _=`<button class="ariaLabel" data-position="parentW" aria-label="${v}" 
data-type="${$}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${D}">
    <svg><use xlink:href="#${Ln($,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${k} ${t.disabled?"":'draggable="true"'}></span>
</button>`;m||(l=_+l);let E="";if($==="NodeListItem"&&r.childElementCount>3||$==="NodeHeading"){const A=r.getAttribute("fold");E=`<button class="ariaLabel" data-position="parentW" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width: 10px${A&&A==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}if(($==="NodeListItem"||$==="NodeList")&&(f=r,$==="NodeListItem"&&r.childElementCount>3&&(l=_+E)),$==="NodeHeading"&&(l=l+E),$==="NodeBlockquote"&&(d+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")){if(m=!0,S&&S.getAttribute("fold")==="1")return;S&&S.getAttribute("data-type")==="NodeBlockquote"&&(d+=8)}}if(S)r=S;else break}let u=!0;const g=this.element.querySelectorAll("button");if(g.length!==l.split("</button>").length-1?u=!1:Array.from(g).find(S=>{const $=S.getAttribute("data-node-id");if($&&l.indexOf($)===-1)return u=!1,!0;const D=S.getAttribute("data-row-id");if(D&&l.indexOf(D)===-1||!D&&l.indexOf("NodeAttributeViewRowMenu")>-1)return u=!1,!0}),u&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";const y=a.parentElement.getBoundingClientRect().top;let b=n.getBoundingClientRect(),w=0;f&&!window.siyuan.config.editor.rtl&&getComputedStyle(n).direction!=="rtl"?(b=f.firstElementChild.getBoundingClientRect(),d=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(b=r.getBoundingClientRect(),d=0):n.classList.contains("av__row")||(b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||b.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?w=(b.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&y<b.top&&(w=8)),this.element.style.top=`${Math.max(b.top,y)+w}px`;let h=b.left-this.element.clientWidth-d;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?h=r.getBoundingClientRect().left-this.element.clientWidth-d:n.classList.contains("av__row")&&(h=r.getBoundingClientRect().left-this.element.clientWidth-d+parseInt(getComputedStyle(r).paddingLeft)),this.element.style.left=`${h}px`,h<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${b.left-this.element.clientWidth-d/2+3}px`,l="",Array.from(this.element.children).reverse().forEach((S,$)=>{$!==0&&(S.firstElementChild.style.height="14px"),l+=S.outerHTML}),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach(S=>{S.style.height=""})}}class Pm{constructor(t){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let n;if(typeof AudioContext!="undefined")n=new AudioContext;else if(webkitAudioContext)n=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=n.sampleRate;const a=n.createGain();n.createMediaStreamSource(t).connect(a),this.recorder=n.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(n.destination),this.readyFlag=!0}cloneChannelData(t,n){this.leftChannel.push(new Float32Array(t)),this.rightChannel.push(new Float32Array(n)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const t=this.mergeBuffers(this.leftChannel),n=this.mergeBuffers(this.rightChannel);let a=new Float32Array(t.length);for(let f=0;f<t.length;++f)a[f]=.5*(t[f]+n[f]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const s=44+a.length*2,i=new ArrayBuffer(s),o=new DataView(i);this.writeUTFBytes(o,0,"RIFF"),o.setUint32(4,s,!0),this.writeUTFBytes(o,8,"WAVE"),this.writeUTFBytes(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,this.SAMPLE_RATE,!0),o.setUint32(28,this.SAMPLE_RATE*2,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0);const l=a.length*2;this.writeUTFBytes(o,36,"data"),o.setUint32(40,l,!0);const r=a.length;let d=44;const c=1;for(let f=0;f<r;f++)o.setInt16(d,a[f]*(32767*c),!0),d+=2;return new Blob([o],{type:"audio/wav"})}downSampleBuffer(t,n){if(n===this.DEFAULT_SAMPLE_RATE||n>this.DEFAULT_SAMPLE_RATE)return t;const a=this.DEFAULT_SAMPLE_RATE/n,s=Math.round(t.length/a),i=new Float32Array(s);let o=0,l=0;for(;o<i.length;){const r=Math.round((o+1)*a);let d=0,c=0;for(let f=l;f<r&&f<t.length;f++)d+=t[f],c++;i[o]=d/c,o++,l=r}return i}mergeBuffers(t){const n=new Float32Array(this.recordingLength);let a=0;const s=t.length;for(let i=0;i<s;++i){const o=t[i];n.set(o,a),a+=o.length}return n}writeUTFBytes(t,n,a){const s=a.length;for(let i=0;i<s;i++)t.setUint8(n+i,a.charCodeAt(i))}}const ku=(e,t)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){L("/api/filetree/removeDoc",{notebook:e,path:t});return}L("/api/block/getDocInfo",{id:vt(t,!0,!0)},n=>{const a=pe(n.data.name);let s=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",a)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;n.data.subFileCount>0&&(s=`${window.siyuan.languages.andSubFile.replace("${x}",a).replace("${y}",n.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),Ne(window.siyuan.languages.deleteOpConfirm,s,()=>{L("/api/filetree/removeDoc",{notebook:e,path:t})},void 0,!0)})},ir=e=>{if(e.length===1){const t=le(e[0],"UL");if(t){const n=t.getAttribute("data-url");e[0].getAttribute("data-type")==="navigation-file"?ku(n,e[0].getAttribute("data-path")):Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr(en(n)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{L("/api/notebook/removeNotebook",{notebook:n,callback:p.CB_MOUNT_REMOVE})},void 0,!0)}}else{const t=[];if(e.forEach(n=>{n.getAttribute("data-path")!=="/"&&t.push(n.getAttribute("data-path"))}),t.length===0){se(window.siyuan.languages.notBatchRemove);return}Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",t.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{L("/api/filetree/removeDocs",{paths:t})},void 0,!0)}},Su=()=>{window.matchMedia("(orientation:portrait)").matches?document.querySelectorAll(".card__action .card__icon").forEach(e=>{e.classList.remove("fn__none")}):document.querySelectorAll(".card__action .card__icon").forEach(e=>{e.classList.add("fn__none")})};var gl=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const pl=(e,t=0)=>{let n=0,a=0;return e.cards.forEach((s,i)=>{i>t||(s.state===0?n++:a++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${e.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ft__success">${e.unreviewedOldCardCount}</span>
</span>`},Om=e=>{let t;return t=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${e.cardsData.cards.length===0?"fn__none":"fn__flex"}">${pl(e.cardsData)}</span></div>
    <svg class="toolbar__icon" data-id="${e.id||""}" data-cardtype="${e.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="more"><use xlink:href="#iconMore"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${t}
    <div class="card__block fn__flex-1 ${e.cardsData.cards.length===0?"fn__none":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${e.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action fn__none">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            ${P()?"":"(p / q)"}
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer}${P()?"":" ("+window.siyuan.languages.space+" / "+window.siyuan.languages.enterKey+")"}</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <button class="b3-button b3-button--cancel" disabled="disabled" style="display: flex;margin-bottom: 8px;height: 28px;padding: 0;" data-type="-2"><svg><use xlink:href="#iconLeft"></use></svg>${P()?"":"(p / q)"}</button>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip}${P()?"":" (0)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain}${P()?"":" (1)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard}${P()?"":" (2)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood}${P()?"":" (3)"}
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy}${P()?"":" (4)"}
            </button>
        </div>
    </div>
</div>`},Au=(e,t,n,a)=>{L("/api/block/getDocInfo",{id:e},s=>{t.wysiwyg.renderCustom(s.data.ial),L("/api/filetree/getDoc",{id:e,mode:0,size:p.SIZE_GET_MAX},i=>{rt({updateReadonly:!0,data:i,protyle:t,action:i.data.rootID===i.data.id?[]:[p.CB_GET_ALL],afterCB:()=>{if(t.element.classList.contains("fn__none"))return;let o=!1;!window.siyuan.config.flashcard.superBlock&&!window.siyuan.config.flashcard.heading&&!window.siyuan.config.flashcard.list&&!window.siyuan.config.flashcard.mark?o=!1:(window.siyuan.config.flashcard.superBlock&&t.wysiwyg.element.querySelector(":scope > .sb")&&(o=!0),window.siyuan.config.flashcard.heading&&t.wysiwyg.element.querySelector(':scope > [data-type="NodeHeading"]')&&(o=!0),window.siyuan.config.flashcard.list&&t.wysiwyg.element.querySelector(".list, .li")&&(o=!0),window.siyuan.config.flashcard.mark&&t.wysiwyg.element.querySelector('span[data-type~="mark"]')&&(o=!0));const l=n.querySelectorAll(".card__action");o?(window.siyuan.config.flashcard.superBlock&&t.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&t.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&t.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&t.element.classList.add("card__block--hidemark"),l[0].classList.remove("fn__none"),l[1].classList.add("fn__none")):(t.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),l[0].classList.add("fn__none"),l[1].querySelectorAll("button.b3-button").forEach((r,d)=>{d<2||(r.previousElementSibling.textContent=a.nextDues[d-1])}),l[1].classList.remove("fn__none"))}})})})},qm=e=>gl(void 0,null,function*(){window.siyuan.storage[p.LOCAL_FLASHCARD].fullscreen&&ro(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]'));let t=0;typeof e.index=="number"&&(t=e.index);const n=new Gn(e.app,e.element.querySelector("[data-type='render']"),{blockId:"",action:[p.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0,title:!0,hideTitleOnZoom:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),e.cardsData.cards.length>0&&Au(e.cardsData.cards[t].blockID,n.protyle,e.element,e.cardsData.cards[t]),e.element.setAttribute("data-key",p.DIALOG_OPENCARD);const a=e.element.querySelectorAll(".card__action");e.index===0||typeof e.index=="undefined"?(a[0].firstElementChild.setAttribute("disabled","disabled"),a[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(a[0].firstElementChild.removeAttribute("disabled"),a[1].querySelector(".b3-button").removeAttribute("disabled"));const s=e.element.querySelector('[data-type="count"]'),i=e.element.querySelector('[data-type="filter"]'),o=()=>{const l=i.getAttribute("data-cardtype"),r=i.getAttribute("data-id");L(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},d=>gl(void 0,null,function*(){t=0,e.cardsData=d.data;for(let c=0;c<e.app.plugins.length;c++)e.cardsData=yield e.app.plugins[c].updateCards(e.cardsData);e.cardsData.cards.length>0?yl({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData}):xu(s,n,a)}))};return s.innerHTML=pl(e.cardsData,t),e.element.firstChild.addEventListener("click",l=>{const r=l.target;let d="";const c=e.cardsData.cards[t],f=i.getAttribute("data-id");if(typeof l.detail=="string")["1","j","a"].includes(l.detail)?d="1":["2","k","s"].includes(l.detail)?d="2":["3","l","d"].includes(l.detail)?d="3":["4",";","f"].includes(l.detail)?d="4":[" ","enter"].includes(l.detail)?d="-1":["p","q"].includes(l.detail)?d="-2":["0","x"].includes(l.detail)&&(d="-3");else{if(O(r,"data-type","fullscreen")){ro(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]')),hi(n.protyle),window.siyuan.storage[p.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[p.LOCAL_FLASHCARD].fullscreen,Te(p.LOCAL_FLASHCARD,window.siyuan.storage[p.LOCAL_FLASHCARD]),l.stopPropagation(),l.preventDefault();return}if(O(r,"data-type","more")&&c){if(l.stopPropagation(),l.preventDefault(),i.getAttribute("data-cardtype")==="all"&&i.getAttribute("data-id")){se(window.siyuan.languages.noSupportTip);return}const w=new Fe;w.addItem({id:"setDueTime",icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const h=new ke({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"}),S=h.element.querySelector("input"),$=h.element.querySelectorAll(".b3-button");h.bindInput(S,()=>{$[1].click()}),S.focus(),S.select(),$[0].addEventListener("click",()=>{h.destroy()}),$[1].addEventListener("click",()=>{L("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:c.cardID,due:G().add(parseInt(S.value),"day").format("YYYYMMDDHHmmss")}]},()=>{a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),c.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.firstElementChild.dispatchEvent(new CustomEvent("click",{detail:"0"})),e.cardsData.cards.splice(t,1),t--,h.destroy()})})}}),c.state!==0&&w.addItem({id:"reset",icon:"iconRefresh",label:window.siyuan.languages.reset,click(){L("/api/riff/resetRiffCards",{type:i.getAttribute("data-cardtype"),id:f,deckID:p.QUICK_DECK_ID,blockIDs:[c.blockID]},()=>{const h=window.siyuan.languages._time["1m"].replace("%s","");c.lapses=0,c.lastReview=-621355968e5,c.reps=0,c.state=0,c.nextDues={1:h,2:h.replace("1","5"),3:h.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},a[1].querySelectorAll("button.b3-button").forEach((S,$)=>{$<2||(S.previousElementSibling.textContent=c.nextDues[$-1])}),e.cardsData.unreviewedOldCardCount--,e.cardsData.unreviewedNewCardCount++,s.innerHTML=pl(e.cardsData,t)})}}),w.addItem({id:"removeRiffCard",icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),c.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.firstElementChild.dispatchEvent(new CustomEvent("click",{detail:"0"})),B(void 0,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[c.blockID]}]),e.cardsData.cards.splice(t,1),t--}}),w.addSeparator(),w.addItem({id:"forgetCountAndRevisionCountAndCardStatusAndLastReviewTime",iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${c.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${c.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${c.state===0?"ft__primary":"ft__success"}">${c.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${c.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${G(c.lastReview).format("YYYY-MM-DD")}</div>
</div>`}),w.fullscreen();return}if(O(r,"data-type","close")){e.dialog&&e.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const y=O(r,"data-type","filter");if(y){L("/api/riff/getRiffDecks",{},w=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new H({id:"all",iconHTML:"",label:window.siyuan.languages.all,click(){i.setAttribute("data-id",""),i.setAttribute("data-cardtype","all"),o()}}).element),window.siyuan.menus.menu.append(new H({id:"fileTree",iconHTML:"",label:window.siyuan.languages.fileTree,click(){ca((S,$)=>{i.setAttribute("data-id",S[0]==="/"?$[0]:vt(S[0],!0,!0)),i.setAttribute("data-cardtype",S[0]==="/"?"notebook":"doc"),o()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(e.title||w.data.length>0)&&window.siyuan.menus.menu.append(new H({type:"separator"}).element),e.title&&(window.siyuan.menus.menu.append(new H({iconHTML:"",label:pe(e.title),click(){i.setAttribute("data-id",e.id),i.setAttribute("data-cardtype",e.cardType),o()}}).element),w.data.length>0&&window.siyuan.menus.menu.append(new H({type:"separator"}).element)),w.data.forEach(S=>{window.siyuan.menus.menu.append(new H({iconHTML:"",label:pe(S.name),click(){i.setAttribute("data-id",S.id),i.setAttribute("data-cardtype","all"),o()}}).element)});const h=y.getBoundingClientRect();window.siyuan.menus.menu.popup({x:h.left,y:h.bottom})}),l.stopPropagation(),l.preventDefault();return}if(O(r,"data-type","newround")){o(),l.stopPropagation(),l.preventDefault();return}}if(!d){const m=C(r,"b3-button");m&&(d=m.getAttribute("data-type"))}if(!(!d||!c)){if(l.preventDefault(),l.stopPropagation(),ae(["toolbar","hint","util","gutter"],n.protyle),d==="-1")if(a[0].classList.contains("fn__none"))d="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),a[0].classList.add("fn__none"),a[1].querySelectorAll("button.b3-button").forEach((m,u)=>{u<2||(m.previousElementSibling.textContent=c.nextDues[u-1])}),a[1].classList.remove("fn__none"),ml(e.app,c,d);return}else if(d==="-2"){t>0&&(t--,yl({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData}),ml(e.app,e.cardsData.cards[t+1],d));return}["1","2","3","4","-3"].includes(d)&&a[0].classList.contains("fn__none")&&L(d==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:c.deckID,cardID:c.cardID,rating:parseInt(d),reviewedCards:e.cardsData.cards},()=>{if(d!=="-3"&&(window.siyuan.config.sync.provider!==0&&Fi()||window.siyuan.config.sync.provider===0&&!fa(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),t++,t>e.cardsData.cards.length-1){const m=i.getAttribute("data-cardtype");L(m==="all"?"/api/riff/getRiffDueCards":m==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:f,deckID:f,notebook:f,reviewedCards:e.cardsData.cards},u=>gl(void 0,null,function*(){ml(e.app,e.cardsData.cards[t-1],d),t=0,e.cardsData=u.data;for(let g=0;g<e.app.plugins.length;g++)e.cardsData=yield e.app.plugins[g].updateCards(e.cardsData);e.cardsData.cards.length===0?e.cardsData.unreviewedCount>0?Rm(s,n,a,u.data.unreviewedCount):xu(s,n,a):yl({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData})}));return}yl({countElement:s,editor:n,actionElements:a,index:t,cardsData:e.cardsData}),ml(e.app,e.cardsData.cards[t-1],d)})}}),n}),ml=(e,t,n)=>{e.plugins.forEach(a=>{a.eventBus.emit("click-flashcard-action",{type:n,card:t})})},Lu=e=>{window.siyuan.config.readonly||L("/api/riff/getRiffDueCards",{deckID:""},t=>{bl(e,t.data,"all")})},bl=(e,t,n,a,s)=>gl(void 0,null,function*(){if(window.siyuan.dialogs.find(d=>{if(d.element.getAttribute("data-key")===p.DIALOG_OPENCARD)return d.destroy(),!0}))return;let o;getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0));for(let d=0;d<e.plugins.length;d++)t=yield e.plugins[d].updateCards(t);const l=new ke({positionId:p.DIALOG_OPENCARD,content:Om({id:a,cardType:n,cardsData:t,isTab:!1}),width:P()?"100vw":"80vw",height:P()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),o&&X(o)},resizeCallback(d){d!=="d"&&d!=="t"&&r&&r.resize()}});l.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-surface)",l.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield qm({app:e,element:l.element,cardsData:t,title:s,id:a,cardType:n,dialog:l});r.resize(),l.editors={card:r},Su()}),yl=e=>{e.editor.protyle.element.classList.remove("fn__none"),e.editor.protyle.element.nextElementSibling.classList.add("fn__none"),e.countElement.innerHTML=pl(e.cardsData,e.index),e.countElement.classList.remove("fn__none"),e.index===0?(e.actionElements[0].firstElementChild.setAttribute("disabled","disabled"),e.actionElements[1].querySelector(".b3-button").setAttribute("disabled","disabled")):(e.actionElements[0].firstElementChild.removeAttribute("disabled"),e.actionElements[1].querySelector(".b3-button").removeAttribute("disabled")),Au(e.cardsData.cards[e.index].blockID,e.editor.protyle,O(e.countElement,"data-key",p.DIALOG_OPENCARD),e.cardsData.cards[e.index])},xu=(e,t,n)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const a=t.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none");const s=e.parentElement.querySelector('[data-type="more"]');s.classList.add("fn__none"),s.previousElementSibling.classList.add("fn__none")},Rm=(e,t,n,a)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const s=t.protyle.element.nextElementSibling;s.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,s.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")};let ws,_s=!1;const wl=(e,t,n)=>{const a=e.querySelector('[data-type="docprevious"]'),s=e.querySelector('[data-type="docnext"]');t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=e.querySelector('.b3-select[data-type="opselect"]'),o=e.querySelector(".b3-list--background");e.querySelector(".protyle-title__input").classList.add("fn__none"),e.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),e.querySelector('.history__text[data-type="mdPanel"]').classList.add("fn__none"),L("/api/history/searchHistory",{query:n,page:t,op:i.value,type:3},l=>{t<l.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");const r=e.querySelector('[data-type="jumpRepoPage"]');l.data.pageCount>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),r.setAttribute("data-totalpage",l.data.pageCount.toString()),r.textContent=t.toString();const d=s.nextElementSibling.nextElementSibling;if(d.classList.remove("fn__none"),d.textContent=window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",l.data.pageCount).replace("${y}",l.data.totalCount),l.data.histories.length===0){o.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let c="";l.data.histories.forEach(f=>{c+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${f}">
    <span class="b3-list-item__text">${G(parseInt(f)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),o.innerHTML=c})},Cu=e=>{const t=`<div class="history__action">
    <div class="block__icons">
        <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" disabled>1</button>
        <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
        <span class="fn__space"></span>
        <div class="fn__flex-1"></div>
        <select data-type="opselect" class="b3-select">
            <option value="all" selected>${window.siyuan.languages.allOp}</option>
            <option value="update">${window.siyuan.languages.historyUpdate}</option>
            <option value="format">${window.siyuan.languages.historyFormat}</option>
            <option value="sync">${window.siyuan.languages.historySync}</option>
            <option value="replace">${window.siyuan.languages.historyReplace}</option>
            <option value="outline">${window.siyuan.languages.historyOutline}</option>
        </select>
    </div>
</div>
<div class="fn__flex fn__flex-1 history__panel">
    <ul class="b3-list b3-list--background history__side" ${P()?"":`style="width: ${window.siyuan.storage[p.LOCAL_HISTORY].sideDocWidth}"`}>
        <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
    </ul>
    <div class="history__resize"></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="protyle-title__input fn__none ft__center ft__breakword"></div>
        <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
        <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
    </div>
</div>`,n=new ke({title:e.pathString,content:t,width:P()?"100vw":"90vw",height:P()?"100vh":"80vh",containerClassName:"b3-dialog__container--theme",destroyCallback(){ws=void 0}});n.element.setAttribute("data-key",p.DIALOG_HISTORYDOC);const a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{wl(n.element,1,e.id)});const s=n.element.querySelector('.history__text[data-type="docPanel"]'),i=n.element.querySelector('.history__text[data-type="mdPanel"]');wl(n.element,1,e.id),ws=new Gn(e.app,s,{blockId:"",history:{created:""},action:[p.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),En(ws.protyle);const o=n.element.querySelector('[data-type="jumpRepoPage"]'),l=n.element.querySelector(".protyle-title__input");n.element.addEventListener("click",r=>{let d=r.target;for(;d&&!d.isEqualNode(n.element);){const c=d.getAttribute("data-type");if(c==="rollback"&&!_s){Tu(d.parentElement,a.value,e.id,f=>{const m=f.path;_s=!1;const u=window.siyuan.languages.rollbackConfirm.replace("${name}",pe(f.title)).replace("${time}",d.previousElementSibling.previousElementSibling.textContent.trim());Ne("\u26A0\uFE0F "+window.siyuan.languages.rollback,u,()=>{L("/api/history/rollbackDocHistory",{notebook:e.notebookId,historyPath:m})})}),r.stopPropagation(),r.preventDefault();break}else if(d.classList.contains("b3-list-item")&&!_s){Tu(d,a.value,e.id,f=>{var m;const u=f.path;L("/api/history/getDocHistoryContent",{historyPath:u},g=>{g.data.isLargeDoc?(i.value=g.data.content,i.classList.remove("fn__none"),s.classList.add("fn__none")):(i.classList.add("fn__none"),s.classList.remove("fn__none"),rt({data:g,protyle:ws.protyle,action:[p.CB_GET_HISTORY,p.CB_GET_HTML]})),l.textContent=f.title,l.classList.remove("fn__none"),_s=!1}),(m=d.parentElement.querySelector(".b3-list-item--focus"))==null||m.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus")}),r.stopPropagation(),r.preventDefault();break}else if((c==="docprevious"||c==="docnext")&&d.getAttribute("disabled")!=="disabled"){const f=parseInt(o.textContent);wl(n.element,c==="docprevious"?f-1:f+1,e.id),r.stopPropagation(),r.preventDefault();break}else if(c==="jumpRepoPage"){const f=parseInt(d.getAttribute("data-totalpage")||"1");Ne(window.siyuan.languages.jumpToPage.replace("${x}",f),`<input class="b3-text-field fn__block" type="number" min="1" max="${f}" value="${o.textContent}">`,m=>{const u=m.element.querySelector(".b3-text-field");u.value!==""&&wl(n.element,Math.max(1,Math.min(parseInt(u.value),f)),e.id)})}d=d.parentElement}}),rl(n.element.querySelector(".history__resize"),n.element.querySelector(".history__side"),"sideDocWidth")},Tu=(e,t,n,a)=>{_s=!0;const s=e.getAttribute("data-path");s&&a(s);const i=e.getAttribute("data-created");ws.protyle.options.history.created=i,L("/api/history/getHistoryItems",{query:n,op:t,type:3,created:i},o=>{a(o.data.items[0])})};var Bm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const sr=(e,t,n)=>{if(xn(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TITLE){window.siyuan.menus.menu.remove();return}L("/api/block/getDocInfo",{id:e.block.rootID},a=>{var s;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_TITLE);const i=ue(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",i?i.dataset.level+"popover-"+n:"app-"+n),window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:oi([e.block.rootID],!0,void 0,e.block.showAll?e.block.id:e.block.rootID)}).element),!e.disabled){window.siyuan.menus.menu.append(to([e.path]));const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new H({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{fl(e,o,"title")}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{ku(e.notebookId,e.path)}}).element)}if(window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+je("\u21E7"+window.siyuan.languages.click),click(){vn(a.data.ial,"bookmark",e)}}).element),!window.siyuan.config.readonly){window.siyuan.config.cloudRegion===0&&window.siyuan.menus.menu.append(new H({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){dg(e)}}).element);const o=!!a.data.ial[p.CUSTOM_RIFF_DECKS],l=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{L("/api/riff/getTreeRiffDueCards",{rootID:e.block.rootID},r=>{bl(e.app,r.data,"doc",e.block.rootID,r.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{L("/api/filetree/getHPathByID",{id:e.block.rootID},r=>{ms(e.app,e.block.rootID,_e().join(en(e.notebookId),r.data),"Tree")})}},{id:o?"removeCard":"quickMakeCard",iconHTML:"",label:o?window.siyuan.languages.removeCard:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var r;let d=(r=e.title)==null?void 0:r.element;d||(d=document.createElement("div"),d.setAttribute("data-node-id",e.block.rootID),d.setAttribute(p.CUSTOM_RIFF_DECKS,a.data.ial[p.CUSTOM_RIFF_DECKS])),nr(e,[d])}}];window.siyuan.config.flashcard.deck&&l.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{ys(e.app,[e.block.rootID])}}),window.siyuan.menus.menu.append(new H({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:l}).element)}window.siyuan.menus.menu.append(new H({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Bm(this,null,function*(){const o=vt(e.path,!1,!0),l=yield he("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:o+".sy"});Kt(e.app,{hasReplace:!1,hPath:_e().join(en(e.notebookId),l.data),idPath:[_e().join(e.notebookId,o)],page:1})})}}).element),e.disabled||Eu(e.block.rootID),window.siyuan.menus.menu.append(new H({id:"separator_3",type:"separator"}).element),e.model||window.siyuan.menus.menu.append(new H({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",click(){ft(e.app,e.block.id,e.block.rootID!==e.block.id?[p.CB_GET_ALL]:[p.CB_GET_CONTEXT])}}).element),e.disabled||window.siyuan.menus.menu.append(new H({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Cu({app:e.app,id:e.block.rootID,notebookId:e.notebookId,pathString:a.data.name})}}).element),window.siyuan.menus.menu.append(Ad(e.block.showAll?e.block.id:e.block.rootID)),window.siyuan.menus.menu.append(new H({id:"separator_4",type:"separator"}).element),(s=e==null?void 0:e.app)!=null&&s.plugins&&tn({plugins:e.app.plugins,type:"click-editortitleicon",detail:{protyle:e,data:a.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new H({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${G(a.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${G(a.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen()})};var Um=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Fm{constructor(t){const n=document.createElement("div");n.className="protyle-breadcrumb";let a="";n.innerHTML=`${P()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${je(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${a}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly" data-subtype="unlock"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${$t()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",s=>{let i=s.target;for(;i&&!i.isEqualNode(n);){const o=i.getAttribute("data-node-id"),l=i.getAttribute("data-type");if(o){s.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(t),s.preventDefault(),s.stopPropagation();break}else if(l==="doc"){if(s.shiftKey)L("/api/block/getDocInfo",{id:t.block.rootID},r=>{vn(r.data.ial,"bookmark",t)});else{const r=i.getBoundingClientRect();sr(t,{x:r.right,y:r.bottom,isLeft:!0},p.MENU_FROM_TITLE_BREADCRUMB)}s.stopPropagation(),s.preventDefault();break}else if(l==="more"){const r=i.getBoundingClientRect();this.showMenu(t,{x:r.right,y:r.bottom,isLeft:!0}),s.stopPropagation(),s.preventDefault();break}else if(l==="readonly"){qd(i,t),s.stopPropagation(),s.preventDefault();break}else if(l==="exit-focus"){Bt({protyle:t,id:t.block.rootID,focusId:t.block.id}),s.stopPropagation(),s.preventDefault();break}else if(l==="context"){s.stopPropagation(),s.preventDefault(),i.classList.contains("block__icon--active")?(Bt({protyle:t,id:t.options.blockId}),i.classList.remove("block__icon--active")):(L("/api/filetree/getDoc",{id:t.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{rt({data:r,protyle:t,action:[p.CB_GET_HL]})}),i.classList.add("block__icon--active"));break}else if(l==="undo"){t.undo.undo(t),s.preventDefault(),s.stopPropagation();break}else if(l==="redo"){t.undo.redo(t),s.preventDefault(),s.stopPropagation();break}else if(l==="outdent"){if(t.toolbar.range){const r=F(t.toolbar.range.startContainer);r&&di(t,[r.parentElement],t.toolbar.range)}s.preventDefault(),s.stopPropagation();break}else if(l==="indent"){if(t.toolbar.range){const r=F(t.toolbar.range.startContainer);r&&Ks(t,[r.parentElement],t.toolbar.range)}s.preventDefault(),s.stopPropagation();break}i=i.parentElement}})}startRecord(t){this.messageId=se(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),tt(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});aa(t,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(t){const n=new Fe(p.MENU_BREADCRUMB_MOBILE_PATH);let a;if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0);!t.wysiwyg.element.isEqualNode(i.startContainer)&&!t.wysiwyg.element.contains(i.startContainer)?a=Nn(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:a=F(i.startContainer)}a||(a=Nn(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const s=a.getAttribute("data-node-id");L("/api/block/getBlockBreadcrumb",{id:s,excludeTypes:[]},i=>{i.data.forEach(o=>{let l=!1;(!t.block.showAll&&o.id===t.block.parentID||t.block.showAll&&o.id===t.block.id)&&(l=!0),n.addItem({current:l,icon:Ln(o.type,o.subType),label:o.name,click(){Bt({protyle:t,id:o.id})}})}),n.fullscreen()})}toggleExit(t){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');t?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(t,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BREADCRUMB_MORE){window.siyuan.menus.menu.remove();return}let a;const s=F(ye(t.element).startContainer);s&&(a=s.getAttribute("data-node-id")),L("/api/block/getTreeStat",{id:a||(t.block.showAll?t.block.id:t.block.rootID)},i=>{var o,l,r,d;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BREADCRUMB_MORE),!t.contentElement.classList.contains("fn__none")&&!t.disabled){let f="";f='<input class="b3-form__upload" type="file" multiple="multiple"',t.options.upload.accept?f+=` accept="${t.options.upload.accept}">`:f+=">";const m=new H({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${f}`}).element;m.querySelector("input").addEventListener("change",u=>{u.target.files.length!==0&&(aa(t,u.target.files,u.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(m),!Je()&&!ut()&&window.siyuan.menus.menu.append(new H({id:(o=this.mediaRecorder)!=null&&o.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(l=this.mediaRecorder)!=null&&l.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Um(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(u=>{this.mediaRecorder=new Pm(u),this.mediaRecorder.recorder.onaudioprocess=g=>{if(!this.mediaRecorder.isRecording)return;const y=g.inputBuffer.getChannelData(0),b=g.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(y,b)},this.startRecord(t)}).catch(()=>{se(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),tt(this.messageId);const u=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});aa(t,[u])}else tt(this.messageId),this.startRecord(t)})}).element)}if(t.disabled||(window.siyuan.menus.menu.append(new H({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){Vs(t,"Img")}}).element),window.siyuan.menus.menu.append(new H({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){Vs(t,"Assets")}}).element),window.siyuan.menus.menu.append(new H({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){fa()||Ne("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{L("/api/asset/uploadCloud",{id:t.block.id})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new H({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){Ne("\u{1F929} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip.replace("${accountServer}",Mt("")),()=>{L("/api/export/export2Liandi",{id:t.block.parentID})})}}).element)),(r=t.scroll)!=null&&r.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new H({id:"keepLazyLoad",current:t.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{t.scroll.keepLazyLoad=!t.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{la(t,!P())}}).element),t.disabled||window.siyuan.menus.menu.append(new H({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{ae(["toolbar"],t),L("/api/format/autoSpace",{id:t.block.rootID})}}).element),window.siyuan.menus.menu.append(new H({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!t.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{us(t,"wysiwyg"),t.scroll.lastScrollTop=0,L("/api/filetree/getDoc",{id:t.block.id,size:t.block.id===t.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.SIZE_GET_MAX},f=>{rt({data:f,protyle:t,action:t.block.id===t.block.rootID?[p.CB_GET_FOCUS,p.CB_GET_HTML,p.CB_GET_UNUNDO]:[p.CB_GET_ALL,p.CB_GET_FOCUS,p.CB_GET_UNUNDO,p.CB_GET_HTML]})})}},{id:"preview",current:!t.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{us(t,"preview"),window.siyuan.menus.menu.remove()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const f=t.wysiwyg.element.getAttribute(p.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new H({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:f==="true",label:window.siyuan.languages.enable,click(){L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[p.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!f||f==="false",label:window.siyuan.languages.disable,click(){L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[p.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}(d=t==null?void 0:t.app)!=null&&d.plugins&&tn({plugins:t.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:t,data:i.data.stat},separatorPosition:"top"}),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.refCount}</div><div class="fn__flex">${window.siyuan.languages.blockCount}<span class="fn__space fn__flex-1"></span>${i.data.stat.blockCount}</div>`}).element),window.siyuan.menus.menu.fullscreen();const c=ue(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",c?c.dataset.level+"popover":"app")})}render(t,n=!1,a){}hide(){P()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}const _l=e=>e.replace(/\u00a0/g," ");var lr=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Ym{constructor(t){var n;if(this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),(n=t.options.render)!=null&&n.titleShowTop)this.element.innerHTML='<div class="protyle-attr"></div>';else{this.element.innerHTML=`<span aria-label="${$t()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}" data-position="west" class="protyle-title__icon ariaLabel"><svg><use xlink:href="#iconFile"></use></svg></span>
<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}" class="protyle-title__input" data-tip="${window.siyuan.languages._kernel[16]}"> </div><div class="protyle-attr"></div>`,this.editElement=this.element.querySelector(".protyle-title__input"),this.editElement.addEventListener("paste",s=>{s.stopPropagation(),s.preventDefault();let i=s.clipboardData.getData("text/siyuan");if(i){try{JSON.parse(i),i=s.clipboardData.getData("text/plain")}catch(o){}i=t.lute.BlockDOM2Content(i)}else i=s.clipboardData.getData("text/plain");setTimeout(function(){document.execCommand("insertText",!1,gn(i))},0),this.rename(t)}),this.editElement.addEventListener("click",()=>{var s;(s=t.toolbar)==null||s.element.classList.add("fn__none")}),this.editElement.addEventListener("input",s=>{s.isComposing||(this.editElement.textContent===""&&this.editElement.querySelectorAll("br").forEach(i=>{i.remove()}),this.rename(t))}),this.editElement.addEventListener("compositionend",()=>{this.rename(t)}),this.editElement.addEventListener("drop",s=>{s.stopPropagation(),s.preventDefault()}),this.editElement.addEventListener("keydown",s=>lr(this,null,function*(){if(!s.isComposing){if(Eg(t,s))return!0;if(ne("\u21E7\u2318V",s)){s.preventDefault(),s.stopPropagation();let i=(yield ni())||"";if(i){i=i.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),gs(t);let o=t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(i));ki(t),o=o.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,gn(o)),this.rename(t)}return}if(ne(window.siyuan.config.keymap.general.enterBack.custom,s)){t.path.split("/").length>2,s.preventDefault(),s.stopPropagation();return}if(!Rn(s))if(s.key==="ArrowDown"){const i=getSelection().getRangeAt(0).getClientRects();if(i.length===0||this.editElement.getBoundingClientRect().bottom-i[i.length-1].bottom<25){const o=Nn(t.wysiwyg.element.firstElementChild);o&&te(o,t.wysiwyg.element),s.preventDefault(),s.stopPropagation()}}else if(s.key==="Enter"){const i=oe(t.wysiwyg.element.firstElementChild);if(i&&i.textContent===""&&i.getAttribute("placeholder"))te(t.wysiwyg.element.firstElementChild,t.wysiwyg.element);else{const o=Lute.NewNodeID(),l=yn(!1,!0,o);t.wysiwyg.element.insertAdjacentElement("afterbegin",l),fe(l,t.toolbar.range||ye(l)),B(t,[{action:"insert",data:l.outerHTML,id:o,parentID:t.block.parentID}],[{action:"delete",id:o}])}s.preventDefault(),s.stopPropagation()}else ne(window.siyuan.config.keymap.editor.general.attr.custom,s)?(L("/api/block/getDocInfo",{id:t.block.rootID},i=>{vn(i.data.ial,"bookmark",t)}),s.preventDefault(),s.stopPropagation()):ne("\u2318A",s)&&(ye(this.editElement).selectNodeContents(this.editElement),s.preventDefault(),s.stopPropagation())}}));const a=this.element.querySelector(".protyle-title__icon");a.addEventListener("click",s=>{if(s.shiftKey)L("/api/block/getDocInfo",{id:t.block.rootID},i=>{vn(i.data.ial,"bookmark",t)});else{const i=a.getBoundingClientRect();sr(t,{x:i.left,y:i.bottom},p.MENU_FROM_TITLE_PROTYLE)}}),this.element.addEventListener("contextmenu",s=>{var i;if(s.shiftKey)return;if(getSelection().rangeCount===0||a.contains(s.target)){sr(t,{x:s.clientX,y:s.clientY},p.MENU_FROM_TITLE_PROTYLE);return}(i=t.toolbar)==null||i.element.classList.add("fn__none"),window.siyuan.menus.menu.remove();const o=ye(this.editElement);o.toString()!==""&&(window.siyuan.menus.menu.append(new H({id:"copy",icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click:()=>{X(ye(this.editElement)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new H({id:"cut",icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click:()=>{X(ye(this.editElement)),document.execCommand("cut"),setTimeout(()=>{this.rename(t)},p.TIMEOUT_INPUT)}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:()=>{const l=ye(this.editElement);l.extractContents(),X(l),setTimeout(()=>{this.rename(t)},p.TIMEOUT_INPUT)}}).element)),window.siyuan.menus.menu.append(new H({id:"paste",label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click:()=>lr(this,null,function*(){if(X(ye(this.editElement)),document.queryCommandSupported("paste"))document.execCommand("paste");else try{const l=(yield ni())||"";document.execCommand("insertText",!1,gn(l)),this.rename(t)}catch(l){console.log(l)}})}).element),window.siyuan.menus.menu.append(new H({id:"pasteAsPlainText",label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click:()=>lr(this,null,function*(){let l=(yield ni())||"";l=l.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),gs(t);let r=t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(l));ki(t),r=r.replace(/;;;lt;;;[^;]+;;;gt;;;/g,""),document.execCommand("insertText",!1,gn(r)),this.rename(t)})}).element),window.siyuan.menus.menu.append(new H({id:"selectAll",label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click:()=>{o.selectNodeContents(this.editElement),X(o)}}).element),window.siyuan.menus.menu.popup({x:s.clientX,y:s.clientY})})}this.element.querySelector(".protyle-attr").addEventListener("click",a=>{L("/api/block/getDocInfo",{id:t.block.rootID},s=>{wu(a,t,s.data.ial)})})}rename(t){if(clearTimeout(this.timeout),!Zi(this.editElement.textContent,this.editElement)){const n=et(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,p.SIZE_TITLE)),Ni(this.editElement,n.start,n.end),!1}xn(),this.timeout=window.setTimeout(()=>{const n=gn(this.editElement.textContent);if(L("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n}),n!==this.editElement.textContent){const a=et(this.editElement);this.setTitle(n),Ni(this.editElement,a.start,a.end)}xi(n)},p.TIMEOUT_INPUT)}setTitle(t){if(this.editElement)_l(t)!==_l(this.editElement.textContent)&&(this.editElement.textContent=t===window.siyuan.languages.untitled?"":t);else{const n=document.getElementById("toolbarName");_l(t)!==_l(n.value)&&(n.value=t===window.siyuan.languages.untitled?"":t)}}render(t,n){var a;if(t.options.render.hideTitleOnZoom&&(t.block.showAll?this.element.classList.add("fn__none"):this.element.classList.remove("fn__none")),this.element.getAttribute("data-render")==="true"&&this.element.dataset.nodeId===t.block.rootID)return!1;this.element.setAttribute("data-node-id",t.block.rootID),n.data.ial[p.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(p.CUSTOM_RIFF_DECKS,n.data.ial[p.CUSTOM_RIFF_DECKS]),(a=t.background)==null||a.render(n.data.ial,t.block.rootID),t.wysiwyg.renderCustom(n.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(n.data.ial.title);let s="";if(n.data.ial.bookmark&&(s+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(n.data.ial.bookmark)}</div>`),n.data.ial.name&&(s+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.name)}</div>`),n.data.ial.alias&&(s+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.alias)}</div>`),n.data.ial.memo&&(s+=`<div class="protyle-attr--memo ariaLabel" aria-label="${Lute.EscapeHTMLStr(n.data.ial.memo)}" data-position="north"><svg><use xlink:href="#iconM"></use></svg></div>`),n.data.ial["custom-avs"]){let i="";n.data.attrViews.forEach(o=>{i+=`<span data-av-id="${o.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${o.name}</span>&nbsp;`}),i&&(i=i.substring(0,i.length-6)),s+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${i}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=s,n.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block">${n.data.refCount}</div>`),this.editElement&&new Date().getTime()-G(n.data.id.split("-")[0]).toDate().getTime()<2e3){const i=this.editElement.ownerDocument.createRange();i.selectNodeContents(this.editElement),X(i)}}}var Iu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const hl=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"];class Wm{constructor(t){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel b3-form__upload" type="file"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips b3-chips__doctag fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",n=>Iu(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>Iu(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&aa(t,[n.dataTransfer.files[0]],void 0,a=>{const s=JSON.parse(a),i=`background-image:url("${s.data.succMap[Object.keys(s.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,s=document,i=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/i*100),s.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.clientY)/i*100+o).toFixed(2)}%`,n.preventDefault()},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&aa(t,n.target.files,n.target,a=>{const s=JSON.parse(a),i=`background-image:url("${s.data.succMap[Object.keys(s.data.succMap)[0]]}")`;this.ial["title-img"]=i,this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":i}})})}),this.element.addEventListener(xs(),n=>{let a=n.target;for(ae(["gutter"],t);a&&!a.isEqualNode(this.element);){const s=a.getAttribute("data-type");if(a.tagName==="IMG"&&a.parentElement.classList.contains("protyle-background__img")){const i=a.getAttribute("src");n.detail>1&&!i.startsWith("data:image/png;base64")&&(Ns([i]),n.preventDefault(),n.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(s==="position"&&!t.disabled){const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");i[0].classList.add("fn__none"),i[1].classList.remove("fn__none"),i[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(s==="cancel"||s==="confirm"){this.imgElement.style.cursor="";const i=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(i[0].classList.remove("fn__none"),i[1].classList.add("fn__none"),i[2].classList.add("fn__none"),s==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,t.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(s==="open-emoji"&&!t.disabled){const i=this.iconElement.getBoundingClientRect();ha(t.block.rootID,"doc",{x:i.left,y:i.bottom,h:i.height,w:i.width},void 0,a.querySelector("img")),n.preventDefault(),n.stopPropagation();break}else if(s==="show-random"&&!t.disabled){let i="";hl.forEach((l,r)=>{i+=`<div data-index="${r}" style="height: 128px;${l}" class="b3-card b3-card--wrap"></div>`});const o=new ke({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${i}</div>`,width:P()?"92vw":"912px",height:P()?"80vh":"70vh"});o.element.setAttribute("data-key",p.DIALOG_BACKGROUNDRANDOM),o.element.addEventListener("click",l=>{const r=l.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=hl[parseInt(r.getAttribute("data-index"))],this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),o.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(s==="random"&&!t.disabled){this.ial["title-img"]=hl[_t(0,hl.length-1)],this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(s==="asset"&&!t.disabled){const i=a.getBoundingClientRect();mo(t,{x:a.parentElement.getBoundingClientRect().right,y:i.bottom+8,isLeft:!0},o=>{this.ial["title-img"]=`background-image:url("${o}")`,this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),window.siyuan.menus.menu.remove()},p.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(s==="remove"&&!t.disabled){delete this.ial["title-img"],this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(s==="icon"&&!t.disabled){const i=Cr();if(i){Pa(i,t.block.rootID),Is(i,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{icon:i}}),t.model&&t.model.parent.setDocIcon(i),this.iconElement.classList.remove("fn__none");const o=this.iconElement.getBoundingClientRect();ha(t.block.rootID,"doc",{x:o.left,y:o.bottom,h:o.height,w:o.width})}n.preventDefault(),n.stopPropagation();break}else if(s==="tag"&&!t.disabled){this.openTag(t,a),n.preventDefault(),n.stopPropagation();break}else if(s==="link"&&!t.disabled){const i=new ke({title:window.siyuan.languages.link,width:P()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",p.DIALOG_BACKGROUNDLINK);const o=i.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${i.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,t.block.rootID),L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),i.destroy()}),i.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(s==="open-search"){Kt(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${a.textContent}#`,r:"",page:1}),n.preventDefault(),n.stopPropagation();break}else if(s==="remove-tag"&&!t.disabled){a.parentElement.remove(),this.removeTag(t),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}removeTag(t,n){const a=this.getTags();L("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:a.toString()}},()=>{n&&n()}),a.length===0?delete this.ial.tags:this.ial.tags=a.toString(),this.render(this.ial,t.block.rootID)}render(t,n){var a;const s=t["title-img"],i=t.icon,o=t.tags;if(this.ial=t,this.element.setAttribute("data-node-id",n),o){let l="";const r=["secondary","primary","info","success","warning","error","pink"];Array.from(new Set(o.split(",").map(d=>d.trim()))).forEach((d,c)=>{d.replace(/ /g,"")&&(l+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[c%7]}" data-type="open-search">${pe(d)}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`)}),this.tagsElement.innerHTML=`${l}
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-bottom: 8px" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=ge(i),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),s){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(s)),s.indexOf("url(")>-1){const l=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=l,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop="",this.imgElement.style.height="200px"}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px";s||i?this.iconElement.parentElement.style.marginTop="":this.iconElement.parentElement.style.marginTop="8px"}openTag(t,n){window.siyuan.menus.menu.remove();const a=new Fe;a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:i=>{const o=i.querySelector(".b3-list--background");L("/api/search/searchTag",{k:""},r=>{let d="";const c=this.getTags();r.data.tags.forEach((f,m)=>{d+=`<div class="b3-list-item b3-list-item--narrow${m===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${f}</div>
    ${c.includes(Lute.UnEscapeHTMLStr(f))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`}),o.innerHTML=d});const l=i.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),!r.isComposing)if(Vt(o,r),r.key==="Enter"){const d=o.querySelector(".b3-list-item--focus");this.addTags(d?d.dataset.type==="new"?d.querySelector("mark").textContent.trim():d.textContent.trim():l.value.trim(),t,()=>{l.value="",l.dispatchEvent(new CustomEvent("input"))})}else r.key==="Escape"&&window.siyuan.menus.menu.remove()}),l.addEventListener("input",r=>{r.stopPropagation(),L("/api/search/searchTag",{k:l.value.trim()},d=>{let c="",f=!1;const m=this.getTags();d.data.tags.forEach((u,g)=>{c+=`<div class="b3-list-item b3-list-item--narrow${g===0?" b3-list-item--focus":""}">
    <div class="fn__flex-1">${u}</div>
    ${m.includes(Lute.UnEscapeHTMLStr(u.replace(/<mark>/g,"").replace(/<\/mark>/g,"")))?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg>':""}
</div>`,u===`<mark>${d.data.k}</mark>`&&(f=!0)}),!f&&d.data.k&&(c=`<div data-type="new" class="b3-list-item b3-list-item--narrow${c?"":" b3-list-item--focus"}"><div class="fn__flex-1">${window.siyuan.languages.new} <mark>${pe(d.data.k)}</mark></div></div>`+c),o.innerHTML=c})}),o.addEventListener("click",r=>{const d=r.target,c=C(d,"b3-list-item");c&&this.addTags(c.dataset.type==="new"?c.querySelector("mark").textContent.trim():c.textContent.trim(),t,()=>{l.value="",l.dispatchEvent(new CustomEvent("input")),l.focus()})})}});const s=a.element.querySelector(".b3-menu__items");s.setAttribute("style","overflow: initial"),a.fullscreen(),s.firstElementChild.setAttribute("style","padding: 0 8px;height: 100%;")}getTags(t){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(a=>{const s=a.textContent.trim();t&&s===t&&a.remove(),n.push(s)}),n}addTags(t,n,a){const s=this.getTags(t);if(s.includes(t)){this.removeTag(n,a);return}s.push(t),L("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:s.toString()}},()=>{a()}),this.ial.tags=s.toString(),this.render(this.ial,n.block.rootID)}}class Gn{constructor(t,n,a){this.version=p.SIYUAN_VERSION;let s=a;t.plugins.forEach(l=>{l.protyleOptions&&(s=Jo(s,l.protyleOptions))});const o=new ym(s).merge();if(this.protyle={getInstance:()=>this,app:t,transactionTime:new Date().getTime(),id:Zn(),disabled:!1,updated:!1,element:n,options:o,block:{},highlight:{mark:na()?new Highlight:void 0,markHL:na()?new Highlight:void 0,ranges:[],rangeIndex:0,styleElement:document.createElement("style")}},na()){const l=Zn();this.protyle.highlight.styleElement.dataset.uuid=l,this.protyle.highlight.styleElement.textContent=`.protyle-content::highlight(search-mark-${l}) {background-color: var(--b3-highlight-background);color: var(--b3-highlight-color);}
  .protyle-content::highlight(search-mark-hl-${l}) {color: var(--b3-highlight-color);background-color: var(--b3-highlight-current-background)}`}if(this.protyle.hint=new fm(this.protyle),o.render.breadcrumb&&(this.protyle.breadcrumb=new Fm(this.protyle)),o.render.title&&(this.protyle.title=new Ym(this.protyle)),o.render.background&&(this.protyle.background=new Wm(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),o.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new cg,this.protyle.wysiwyg=new km(this.protyle),this.protyle.toolbar=new Mm(this.protyle),this.protyle.scroll=new wm(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Nm(this.protyle)),(o.upload.url||o.upload.handler)&&(this.protyle.upload=new cp),this.init(),o.action.includes(p.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Ti({app:t,id:this.protyle.id,type:"protyle",msgCallback:l=>{var r;switch(l.cmd){case"reload":l.data===this.protyle.block.rootID&&la(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`.av[data-av-id="${l.data.id}"]`)).forEach(d=>{d.removeAttribute("data-render"),ot(d,this.protyle)});break;case"addLoading":l.data===this.protyle.block.rootID&&vi(this.protyle,l.msg);break;case"unfoldHeading":Zg(l.data,this.protyle);break;case"transactions":this.onTransaction(l);break;case"readonly":window.siyuan.config.editor.readOnly=l.data,No(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===l.data.srcRootBlockID&&(this.protyle.block.showAll&&l.cmd==="heading2doc"&&!this.protyle.options.backlinkData?L("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{rt({data:d,protyle:this.protyle})}):la(this.protyle,!1));break;case"rename":this.protyle.path===l.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(l.data.title),this.protyle.background&&(this.protyle.background.ial.title=l.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===l.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&((r=this.protyle.title.editElement)!=null&&r.contains(getSelection().getRangeAt(0).startContainer))||this.protyle.title.setTitle(l.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${l.data.id}"]`).forEach(d=>{d.getAttribute("data-subtype")==="d"&&(d.innerHTML=l.data.refText)});break;case"moveDoc":this.protyle.path===l.data.fromPath&&(this.protyle.path=l.data.newPath,this.protyle.notebookId=l.data.toNotebook);break;case"unmount":this.protyle.notebookId===l.data.box&&Li(t);break;case"removeDoc":l.data.ids.includes(this.protyle.block.rootID)&&(Li(t),delete window.siyuan.storage[p.LOCAL_FILEPOSITION][this.protyle.block.rootID],Te(p.LOCAL_FILEPOSITION,window.siyuan.storage[p.LOCAL_FILEPOSITION]));break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,Mc(this.protyle,a.backlinkData),this.protyle.wysiwyg.element.style.padding="4px 16px 4px 24px";return}if(!a.blockId){fs(this.protyle);return}this.protyle.options.mode!=="preview"&&a.rootId&&window.siyuan.storage[p.LOCAL_FILEPOSITION][a.rootId]&&(o.action.includes(p.CB_GET_SCROLL)||o.action.includes(p.CB_GET_ROOTSCROLL)&&a.rootId===a.blockId)?Oo({protyle:this.protyle,scrollAttr:window.siyuan.storage[p.LOCAL_FILEPOSITION][a.rootId],mergedOptions:o,cb:()=>{this.afterOnGet(o)}}):this.getDoc(o)}}onTransaction(t){let n="";t.data[0].doOperations.find(a=>{var s;if(!this.protyle.preview.element.classList.contains("fn__none"))this.protyle.preview.render(this.protyle),a.action==="updateAttrs"&&il(this.protyle,a,!1);else{if(this.protyle.options.backlinkData&&["delete","move"].includes(a.action))return!0;il(this.protyle,a,!1),a.action==="delete"&&typeof((s=a.data)==null?void 0:s.createEmptyParagraph)=="boolean"&&!a.data.createEmptyParagraph||(n=a.action)}}),this.protyle.wysiwyg.element.childElementCount===0&&this.protyle.block.parentID&&n&&(n==="delete"&&this.protyle.block.showAll?this.protyle.options.handleEmptyContent?this.protyle.options.handleEmptyContent():Bt({protyle:this.protyle,id:this.protyle.block.rootID,focusId:this.protyle.block.id}):(this.protyle.undo.clear(),this.reload(!1)))}getDoc(t){var n;L("/api/filetree/getDoc",{id:t.blockId,isBacklink:t.action.includes(p.CB_GET_BACKLINK),originalRefBlockIDs:t.originalRefBlockIDs,mode:t.action&&t.action.includes(p.CB_GET_CONTEXT)?3:0,size:(n=t.action)!=null&&n.includes(p.CB_GET_ALL)?p.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{rt({data:a,protyle:this.protyle,action:t.action,afterCB:()=>{this.afterOnGet(t)}})})}afterOnGet(t){this.protyle.model,hi(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),t.after&&t.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=gm({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new bm(this.protyle),Zp(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){nc(this.protyle)}resize(){hi(this.protyle)}reload(t){la(this.protyle,t)}insert(t,n=!1,a=!1){lt(t,this.protyle,n,a)}transaction(t,n){B(this.protyle,t,n)}turnIntoOneTransaction(t,n,a){_n({protyle:this.protyle,selectsElement:t,type:n,level:a})}turnIntoTransaction(t,n,a){kn({protyle:this.protyle,nodeElement:t,type:n,level:a})}updateTransaction(t,n,a){Q(this.protyle,t,n,a)}updateBatchTransaction(t,n){Aa(t,this.protyle,n)}getRange(t){return ye(t)}hasClosestBlock(t){return F(t)}focusBlock(t,n=!0){return te(t,void 0,n)}disable(){En(this.protyle)}enable(){ds(this.protyle)}renderAVAttribute(t,n,a){So(t,n,this.protyle,a)}}const Ft=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,ft=(e,t,n=[p.CB_GET_HL])=>{window.siyuan.storage[p.LOCAL_DOCINFO]={id:t},Te(p.LOCAL_DOCINFO,window.siyuan.storage[p.LOCAL_DOCINFO]);const a=document.querySelector(".av__panel");if(a&&!a.classList.contains("fn__none")&&a.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){Ei(window.siyuan.mobile.editor.protyle),ae(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&us(window.siyuan.mobile.editor.protyle,"wysiwyg");let s;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`)).find(i=>{if(!de(i))return s=i,!0}),s){oo(),n.includes(p.CB_GET_HL)?Nf(window.siyuan.mobile.editor.protyle,t):Oe(window.siyuan.mobile.editor.protyle,s),nt(),L("/api/storage/updateRecentDocViewTime",{rootID:window.siyuan.mobile.editor.protyle.block.rootID});return}}L("/api/block/getBlockInfo",{id:t},s=>{if(s.code===3){se(s.msg);return}const i={blockId:t,rootId:s.data.rootID,action:n,render:{scroll:!0,title:!0,titleShowTop:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu","yuque"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),oo(),vi(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==s.data.rootID?(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML="",L("/api/storage/updateRecentDocOpenTime",{rootID:s.data.rootID})):L("/api/storage/updateRecentDocViewTime",{rootID:s.data.rootID}),n.includes(p.CB_GET_SCROLL)&&window.siyuan.storage[p.LOCAL_FILEPOSITION][s.data.rootID]?Oo({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[p.LOCAL_FILEPOSITION][s.data.rootID],mergedOptions:i,cb(){e.plugins.forEach(o=>{o.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):L("/api/filetree/getDoc",{id:t,size:n.includes(p.CB_GET_ALL)?p.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(p.CB_GET_CONTEXT)?3:0},o=>{rt({data:o,protyle:window.siyuan.mobile.editor.protyle,action:n,afterCB(){e.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):(L("/api/storage/updateRecentDocOpenTime",{rootID:s.data.rootID}),window.siyuan.mobile.editor=new Gn(e,document.getElementById("editor"),i)),tm(),nt()})};class Vm{constructor(t){this.element=t.element,this.data=t.data,this.type=t.type,this.init=t.init,this.destroy=t.destroy,this.update=t.update,this.init(this)}}class $u{constructor(t){this.editors=[],this.id=Zn(),this.targetElement=t.targetElement,this.refDefs=t.refDefs,this.app=t.app,this.x=t.x,this.y=t.y,this.isBacklink=t.isBacklink,this.originalRefBlockIDs=t.originalRefBlockIDs,this.element=document.createElement("div"),this.element.classList.add("block__popover");const n=C(this.targetElement,"block__popover",!0);let a=1;n?(this.element.setAttribute("data-oid",n.getAttribute("data-oid")),a=parseInt(n.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.refDefs[0].refID),this.element.setAttribute("data-level",a.toString());for(let s=0;s<window.siyuan.blockPanels.length;s++){const i=window.siyuan.blockPanels[s];i.element.getAttribute("data-pin")==="false"&&i.targetElement&&parseInt(i.element.getAttribute("data-level"))>=a&&(i.destroy(),s--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",s=>{const i=s.target,o=C(i,"block__icons");if(o){const l=o.querySelector('[data-type="pin"]');this.element.getAttribute("data-pin")==="true"?(l.setAttribute("aria-label",window.siyuan.languages.pin),l.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(l.setAttribute("aria-label",window.siyuan.languages.unpin),l.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")),s.preventDefault(),s.stopPropagation()}}),this.element.addEventListener("click",s=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let i=s.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon")||i.classList.contains("block__logo")){const o=i.getAttribute("data-type");o==="close"?this.destroy():o==="pin"?this.element.getAttribute("data-pin")==="true"?(i.setAttribute("aria-label",window.siyuan.languages.pin),i.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(i.setAttribute("aria-label",window.siyuan.languages.unpin),i.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")):o==="open"||o==="stickTab"&&(Jn(this.refDefs[0].refID,(l,r)=>{openFileById({app:t.app,id:this.refDefs[0].refID,action:r,zoomIn:l,openNewTab:!0})}),this.destroy()),s.preventDefault(),s.stopPropagation();break}i=i.parentElement}}),this.render()}initProtyle(t,n){const a=parseInt(t.getAttribute("data-index"));L("/api/block/getBlockInfo",{id:this.refDefs[a].refID},s=>{if(s.code===3){se(s.msg);return}if(!this.targetElement&&typeof this.x=="undefined"&&typeof this.y=="undefined")return;const i=[];s.data.rootID!==this.refDefs[a].refID?i.push(p.CB_GET_ALL):i.push(p.CB_GET_CONTEXT),this.isBacklink&&i.push(p.CB_GET_BACKLINK);const o=new Gn(this.app,t,{blockId:this.refDefs[a].refID,defIds:this.refDefs[a].defIDs||[],originalRefBlockIDs:this.isBacklink?this.originalRefBlockIDs:void 0,action:i,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0,title:s.data.rootID===this.refDefs[a].refID},typewriterMode:!1,after:l=>{s.data.rootID!==this.refDefs[a].refID&&l.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),n&&n(),(l.protyle.element.nextElementSibling||l.protyle.element.previousElementSibling)&&(l.protyle.element.style.minHeight=Math.min(30+l.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),l.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(l.protyle.contentElement.clientHeight-49,200)}px;`)}});this.editors.push(o)})}destroy(){var t,n,a;(t=this.observerResize)==null||t.disconnect(),(n=this.observerLoad)==null||n.disconnect(),window.siyuan.blockPanels.find((o,l)=>{if(o.id===this.id)return window.siyuan.blockPanels.splice(l,1),!0}),this.editors.length>0&&(this.editors.forEach(o=>{ae(["util"],o.protyle),o.destroy()}),this.editors=[]);const s=parseInt(this.element.dataset.level);this.element.remove(),this.element=void 0,this.targetElement=void 0;const i=parseInt(window.siyuan.menus.menu.element.dataset.from);i&&i>=s&&((a=window.siyuan.menus.menu.element.dataset.from)!=null&&a.includes("popover"))&&window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let t="";this.refDefs.length===1&&(t=`<span data-type="stickTab" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.openInNewTab}${Xn(window.siyuan.config.keymap.editor.general.openInNewTab.custom)}"><svg><use xlink:href="#iconOpen"></use></svg></span>
<span class="fn__space"></span>`);let n=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>${t}
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}${Xn(window.siyuan.config.keymap.general.closeTab.custom)}"><svg style="width: 12px;margin: 0 1px;"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.refDefs.length===0?n+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.refDefs.forEach((s,i)=>{n+=`<div class="block__edit fn__flex-1 protyle" data-index="${i}"></div>`}),n&&(n+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=n;let a;this.observerResize=new ResizeObserver(()=>{clearTimeout(a),a=window.setTimeout(()=>{this.editors.forEach(s=>{hi(s.protyle)})},p.TIMEOUT_TRANSITION)}),this.observerResize.observe(this.element),this.observerLoad=new IntersectionObserver(s=>{s.forEach(i=>{i.isIntersecting&&i.target.innerHTML===""&&this.initProtyle(i.target)})},{threshold:0}),this.element.querySelectorAll(".block__edit").forEach((s,i)=>{i<5?this.initProtyle(s,i===0?()=>{if(!document.contains(this.element))return;let o;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){o=this.targetElement.getBoundingClientRect();let r=o.top;const d=C(this.targetElement,"protyle-content",!0);if(d){const c=d.getBoundingClientRect().top;o.top<c&&(r=c)}this.element.style.height=Math.min(window.innerHeight-p.SIZE_TOOLBAR_HEIGHT,o.height+42)+"px",Ee(this.element,o.left,Math.max(r-42,p.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?o=this.targetElement.firstElementChild.getBoundingClientRect():o=this.targetElement.getBoundingClientRect(),window.innerHeight-o.bottom-4>o.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-o.bottom-12)+"px"),Ee(this.element,o.left,o.bottom+4,o.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(Ee(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,p.SIZE_TOOLBAR_HEIGHT)-12)+"px");const l=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(l.top<o.top?this.element.style.maxHeight=Math.floor(o.top-l.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-l.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):this.observerLoad.observe(s)}),this.targetElement&&(this.targetElement.style.cursor=""),this.element.querySelector(".block__content").addEventListener("scroll",()=>{this.editors.forEach(s=>{ae(["gutter"],s.protyle)})})}}var jm=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Du{constructor(t){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=n=>{window.siyuan.blockPanels.push(new $u({app:this.app,originalRefBlockIDs:n.originalRefBlockIDs,targetElement:n.targetElement,isBacklink:n.isBacklink,x:n.x,y:n.y,refDefs:n.refDefs}))},this.app=t.app,this.i18n=t.i18n,this.displayName=t.displayName,this.eventBus=new qf(t.name),Object.defineProperty(this,"name",{value:t.name,writable:!1}),this.updateProtyleToolbar([]).forEach(n=>{typeof n=="string"||p.INLINE_TYPE.concat("|").includes(n.name)||!n.hotkey||(window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[t.name]||(window.siyuan.config.keymap.plugin[t.name]={[n.name]:{default:n.hotkey,custom:n.hotkey}}),window.siyuan.config.keymap.plugin[t.name][n.name]||(window.siyuan.config.keymap.plugin[t.name][n.name]={default:n.hotkey,custom:n.hotkey}))})}onload(){}onunload(){}uninstall(){}updateCards(t){return jm(this,null,function*(){return t})}onLayoutReady(){}addCommand(t){window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][t.langKey]?window.siyuan.config.keymap.plugin[this.name][t.langKey]&&(typeof window.siyuan.config.keymap.plugin[this.name][t.langKey].custom=="string"?t.customHotkey=window.siyuan.config.keymap.plugin[this.name][t.langKey].custom:t.customHotkey=t.hotkey,window.siyuan.config.keymap.plugin[this.name][t.langKey].default=t.hotkey):(t.customHotkey=t.hotkey,window.siyuan.config.keymap.plugin[this.name][t.langKey]={default:t.hotkey,custom:t.hotkey}):(t.customHotkey=t.hotkey,window.siyuan.config.keymap.plugin[this.name]={[t.langKey]:{default:t.hotkey,custom:t.hotkey}}),typeof t.customHotkey!="string"?console.error(`${this.name} - commands data is error and has been removed.`):this.commands.push(t)}addIcons(t){const n=document.querySelector(`svg[data-name="${this.name}"] defs`);if(n)n.insertAdjacentHTML("afterbegin",t);else{const a=document.querySelector("body > svg:last-of-type");a?a.insertAdjacentHTML("afterend",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${t}</defs></svg>`):document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${t}</defs></svg>`)}}addTopBar(t){var n,a;if(!t.icon.startsWith("icon")&&!t.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const s=document.createElement("div");return s.setAttribute("data-menu","true"),s.addEventListener("click",t.callback),s.id=`plugin_${this.name}_${this.topBarIcons.length}`,P()?(s.className="b3-menu__item",s.innerHTML=(t.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${t.icon}"></use></svg>`:t.icon)+`<span class="b3-menu__label">${t.title}</span>`):re()||(s.className="toolbar__item ariaLabel",s.setAttribute("aria-label",t.title),s.innerHTML=t.icon.startsWith("icon")?`<svg><use xlink:href="#${t.icon}"></use></svg>`:t.icon,s.addEventListener("click",t.callback),s.setAttribute("data-location",t.position||"right"),resizeTopBar()),P()&&window.siyuan.storage?window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(s.id)||(n=document.querySelector("#menuAbout"))==null||n.after(s):!re()&&window.siyuan.storage&&(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(s.id)&&s.classList.add("fn__none"),(a=document.querySelector("#"+(s.getAttribute("data-location")==="right"?"barPlugins":"drag")))==null||a.before(s)),this.topBarIcons.push(s),s}addStatusBar(t){}openSetting(){this.setting&&this.setting.open(this.displayName||this.name)}loadData(t){return typeof this.data[t]=="undefined"&&(this.data[t]=""),new Promise(n=>{L("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${t}`},a=>{a.code!==404&&(this.data[t]=a),n(this.data[t])})})}saveData(t,n){if(!(window.siyuan.config.readonly||window.siyuan.isPublish))return new Promise(a=>{const s=`/data/storage/petal/${this.name}/${t}`;let i;typeof n=="object"?i=new File([new Blob([JSON.stringify(n)],{type:"application/json"})],s.split("/").pop()):i=new File([new Blob([n])],s.split("/").pop());const o=new FormData;o.append("path",s),o.append("file",i),o.append("isDir","false"),L("/api/file/putFile",o,l=>{this.data[t]=n,a(l)})})}removeData(t){if(!(window.siyuan.config.readonly||window.siyuan.isPublish))return new Promise(n=>{this.data||(this.data={}),L("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${t}`},a=>{delete this.data[t],n(a)})})}getOpenedTab(){const t={};return Object.keys(this.models).forEach(a=>{t[a.replace(this.name,"")]=[]}),t}addTab(t){}addDock(t){const n=this.name+t.type;return typeof t.config.index=="undefined"&&(t.config.index=1e3),this.docks[n]={config:t.config,mobileModel:a=>new Vm({element:a,type:n,data:t.data,init:t.init,update:t.update,destroy:t.destroy})},window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),t.config.hotkey&&(window.siyuan.config.keymap.plugin[this.name]?window.siyuan.config.keymap.plugin[this.name][n]?window.siyuan.config.keymap.plugin[this.name][n]&&(typeof window.siyuan.config.keymap.plugin[this.name][n].custom!="string"&&(window.siyuan.config.keymap.plugin[this.name][n].custom=t.config.hotkey),window.siyuan.config.keymap.plugin[this.name][n].default=t.config.hotkey):window.siyuan.config.keymap.plugin[this.name][n]={default:t.config.hotkey,custom:t.config.hotkey}:window.siyuan.config.keymap.plugin[this.name]={[n]:{default:t.config.hotkey,custom:t.config.hotkey}}),this.docks[n]}updateProtyleToolbar(t){return t}set protyleOptions(t){this.protyleOptionsValue=t}get protyleOptions(){return this.protyleOptionsValue}}class Gm{constructor(t){this.items=[],this.confirmCallback=t.confirmCallback,this.destroyCallback=t.destroyCallback,this.width=t.width||(P()?"92vw":"768px"),this.height=t.height||"80vh"}addItem(t){this.items.push(t)}open(t){var n;const a=new ke({title:t,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),s=a.element.querySelector(".b3-dialog__content");this.items.forEach(o=>{let l="",r=o.actionElement;!o.actionElement&&o.createActionElement&&(r=o.createActionElement());const d=r!=null&&r.classList.contains("b3-switch")?"label":"div";typeof o.direction=="undefined"&&(o.direction=!r||r.tagName==="TEXTAREA"?"row":"column"),o.direction==="row"?l=`<${d} class="b3-label">
    <div class="fn__block">
        ${o.title}
        ${o.description?`<div class="b3-label__text">${o.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</${d}>`:l=`<${d} class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${o.title}
        ${o.description?`<div class="b3-label__text">${o.description}</div>`:""}
    </div>
    <span class="fn__space${r?"":" fn__none"}"></span>
</${d}>`,s.insertAdjacentHTML("beforeend",l),r&&(["INPUT","TEXTAREA"].includes(r.tagName)&&a.bindInput(r,()=>{i[1].dispatchEvent(new CustomEvent("click"))},r.tagName==="INPUT"),o.direction==="row"?(s.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",r),r.classList.add("fn__block")):(r.classList.remove("fn__block"),r.classList.add("fn__flex-center","fn__size200"),s.lastElementChild.insertAdjacentElement("beforeend",r)))}),(n=s.querySelector("input, textarea"))==null||n.focus();const i=a.element.querySelectorAll(".b3-dialog__action .b3-button");i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),a.destroy()}),this.dialog=a}}const or=(e,t)=>{let n="";return e.forEach(a=>{typeof a=="string"?n+=`<option value="${a}" ${t===a?"selected":""}>${a}</option>`:n+=`<option value="${a.name}" ${t===a.name?"selected":""}>${a.label}</option>`}),n},zm=(e,t)=>{let n="";return e.forEach(a=>{n+=`<option value="${a.name}" ${t===a.name?"selected":""}>${a.label} (${a.name})</option>`}),n},Km=()=>{nn({title:window.siyuan.languages.appearance,icon:"iconTheme",html:`<div class="b3-label">
    ${window.siyuan.languages.appearance4}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
    <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.theme}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="themeLight">
      ${or(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme11}</div>
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="themeDark">
       ${or(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme12}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.icon}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="icon">
        ${or(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme2}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.language}
    <div class="fn__hr"></div>
    <select id="lang" class="b3-select fn__block">${zm(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
    <div class="b3-label__text">${window.siyuan.languages.language1}</div>
</div>`,bindEvent(e){e.querySelectorAll("select").forEach(t=>{t.addEventListener("change",()=>{const n=parseInt(e.querySelector("#mode").value);L("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:e.querySelector("#icon").value,mode:n===2?window.siyuan.config.appearance.mode:n,modeOS:n===2,themeDark:e.querySelector("#themeDark").value,themeLight:e.querySelector("#themeLight").value,lang:e.querySelector("#lang").value}),()=>{sm(),window.location.reload()})})})}})},$n={element:void 0,genHTML:()=>{const e=P();return`<div class="fn__flex-column" style="height: 100%">
    <div class="layout-tab-bar fn__flex">
        <div class="item item--full item--focus" data-type="remove">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.unreferencedAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="missing">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.missingAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="config-assets${e?" b3-list--mobile":""}" data-type="remove" data-init="true">
            <div class="fn__hr--b"></div>
            <div class="fn__flex">
                <div class="fn__space"></div>
                <button id="removeAll" class="b3-button b3-button--outline fn__flex-center fn__size200">
                    <svg class="svg"><use xlink:href="#iconTrashcan"></use></svg>
                    ${window.siyuan.languages.delete}
                </button>
            </div>
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="config-assets__preview"></div>
        </div>
        <div class="fn__none config-assets${e?" b3-list--mobile":""}" data-type="missing">
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="fn__hr"></div>
        </div>
    </div>
</div>`},bindEvent:()=>{const e=$n.element.querySelector(".config-assets__list");$n.element.addEventListener("click",t=>{let n=t.target;for(;n&&!n.isEqualNode($n.element);){const a=n.getAttribute("data-type");if(n.id==="removeAll")Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.clearAll}`,()=>{L("/api/asset/removeUnusedAssets",{},s=>{e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,$n.element.querySelector(".config-assets__preview").innerHTML=""})},void 0,!0);else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){$n.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),$n.element.querySelectorAll(".config-assets").forEach(s=>{a===s.getAttribute("data-type")?(s.classList.remove("fn__none"),s.getAttribute("data-init")||(L("/api/asset/getMissingAssets",{},i=>{$n._renderList(i.data.missingAssets,s.querySelector(".config-assets__list"),!1)}),s.setAttribute("data-init","true"))):s.classList.add("fn__none")}),t.preventDefault(),t.stopPropagation();break}else if(a==="copy")He(n.parentElement.querySelector(".b3-list-item__text").textContent.trim().replace("assets/",""));else if(a!=="open"){if(a==="clear"){const s=n.parentElement.getAttribute("data-path");Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.delete} <b>${_e().basename(s)}</b>`,()=>{L("/api/asset/removeUnusedAsset",{path:s},i=>{const o=n.parentElement;o.parentElement.querySelectorAll("li").length===1?o.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`:o.remove(),$n.element.querySelector(".config-assets__preview").innerHTML=""})},void 0,!0),t.preventDefault(),t.stopPropagation();break}}n=n.parentElement}}),e.addEventListener("mouseover",t=>{const n=C(t.target,"b3-list-item");if(n&&n.getAttribute("data-path")!==e.nextElementSibling.getAttribute("data-path")){const a=n.getAttribute("data-path");e.nextElementSibling.setAttribute("data-path",a),e.nextElementSibling.innerHTML=Ra(a)}}),L("/api/asset/getUnusedAssets",{},t=>{$n._renderList(t.data.unusedAssets,e)})},_renderList:(e,t,n=!0)=>{let a="",s="";!Be()&&n&&(s=`<span data-type="open" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`);let i="";n&&(i=`<span data-type="clear" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`);const o=P();e.forEach(l=>{const r=l.indexOf("assets/"),d=l.substr(r);a+=`<li data-path="${d}"  class="b3-list-item${o?"":" b3-list-item--hide-action"}">
    <span class="b3-list-item__text">${pe(l)}</span>
    <span data-type="copy" class="ariaLabel b3-list-item__action" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>
    ${s}
    ${i}
</li>`}),t.innerHTML=a||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`}},Zm=()=>{nn({title:window.siyuan.languages.assets,icon:"iconImage",html:$n.genHTML(),bindEvent(e){$n.element=e,$n.bindEvent()}})},Xm=e=>{const t=new ke({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});t.element.setAttribute("data-key",p.DIALOG_SYNCADDCLOUDDIR);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',L("/api/sync/createCloudSyncDir",{name:n.value},()=>{t.destroy(),hs(e,!0)})})},Mu=(e,t)=>{e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){const s=a.getAttribute("data-type");if(s){switch(s){case"addCloud":Xm(e);break;case"removeCloud":Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',L("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},i=>{window.siyuan.config.sync.cloudName=i.data,hs(e,!0,t)})},void 0,!0);break;case"selectCloud":e.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',L("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),hs(e,!0,t)});break}n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})},hs=(e,t=!1,n)=>{!t&&e.firstElementChild.tagName!=="IMG"||L("/api/sync/listCloudSyncDir",{},a=>{let s=`<ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?s=`<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(s='<ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(i=>{s+=`<li data-type="selectCloud" data-name="${i.cloudName}" class="b3-list-item b3-list-item--two">
    <div class="b3-list-item__first" data-name="${i.cloudName}">
        <input type="radio" name="cloudName"${i.cloudName===a.data.checkedSyncDir?" checked":""}/>
        <span class="fn__space"></span>
        <span>${i.cloudName}</span>
        <span class="fn__flex-1 fn__space"></span>
        <span data-type="removeCloud" class="b3-list-item__action">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
    </div>
    <div class="b3-list-item__meta fn__flex">
        <span>${i.hSize}</span>
        <span class="fn__flex-1 fn__space"></span>
        <span>${i.updated}</span>
    </div>
</li>`}),s+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline${window.siyuan.config.sync.provider===2||window.siyuan.config.sync.provider===3?" fn__none":""}" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),e.innerHTML=s,n&&n()})},rr=e=>{if(!window.siyuan.config.readonly){if(window.siyuan.config.sync.provider===0){if(fa())return}else if(!Fi()){se(window.siyuan.languages._kernel[214].replaceAll("${accountServer}",Mt("")));return}if(!window.siyuan.config.repo.key){Nu(!0);return}if(!window.siyuan.config.sync.enabled){Hu();return}dr()}},dr=()=>{if(window.siyuan.config.sync.mode!==3){L("/api/sync/performSync",{});return}const e=new ke({title:window.siyuan.languages.chooseSyncDirection,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="true">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.uploadData2Cloud}
            <div class="b3-label__text">${window.siyuan.languages.uploadData2CloudTip}</div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="false">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.downloadDataFromCloud}
            <div class="b3-label__text">${window.siyuan.languages.downloadDataFromCloudTip}</div>
        </div>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});e.element.setAttribute("data-key",p.DIALOG_SYNCCHOOSEDIRECTION);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const n=e.element.querySelector("input[name=upload]:checked");if(!n){se(window.siyuan.languages.plsChoose);return}L("/api/sync/performSync",{upload:n.value==="true"}),e.destroy()})},Hu=(e,t)=>{if(e&&(window.siyuan.config.repo.key=e),window.siyuan.config.sync.enabled)t&&t.destroy(),Ne("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{dr()});else{const n=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div class="fn__hr--b"></div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;t?(t.element.querySelector(".b3-dialog__header").innerHTML="\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,t.element.querySelector(".b3-dialog__body").innerHTML=n):t=new ke({title:"\u{1F5C2}\uFE0F "+window.siyuan.languages.cloudSyncDir,content:n,width:P()?"92vw":"520px"}),t.element.setAttribute("data-key",p.DIALOG_SYNCCHOOSEDIR);const a=t.element.querySelector(".b3-dialog__content").lastElementChild,s=t.element.querySelector(".b3-button");Mu(a,()=>{a.querySelector("input[checked]")?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}),hs(a,!1,()=>{a.querySelector("input[checked]")?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}),s.addEventListener("click",()=>{t.destroy(),L("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,jn(),Ne("\u{1F504} "+window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{dr()})})})}},Nu=(e,t)=>{const n=new ke({title:"\u{1F511} "+window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">
    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>
    <div class="fn__hr--b"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.reEnterPassphrase}">
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        <input type="checkbox" class="b3-switch fn__flex-center">
        <span class="fn__space"></span>
        ${window.siyuan.languages.confirmPassword}
    </label>
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--text" id="initKeyByPW" disabled>
        ${window.siyuan.languages.confirm}
    </button>
</div>`,width:P()?"92vw":"520px"});n.element.setAttribute("data-key",p.DIALOG_SETPASSWORD),n.element.querySelector(".b3-button--cancel").addEventListener("click",()=>{n.destroy()});const a=n.element.querySelector("#initKeyByPW");n.element.querySelector(".b3-switch").addEventListener("change",function(){this.checked?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});const s=n.element.querySelectorAll(".b3-text-field");a.addEventListener("click",()=>{if(!s[0].value||!s[1].value){se(window.siyuan.languages._kernel[142]);return}if(s[0].value!==s[1].value){se(window.siyuan.languages.passwordNoMatch);return}Ne("\u{1F511} "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,()=>{e||n.destroy(),L("/api/repo/initRepoKeyFromPassphrase",{pass:s[0].value},i=>{window.siyuan.config.repo.key=i.data.key,t&&t(),e&&Hu(i.data.key,n)})})}),s[0].focus()},cr=e=>e===0?fa("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replaceAll("${accountServer}",Mt(""))}</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:Fi()?e===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Region ID</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="s3ConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.s3.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="s3">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="s3">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:e===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="webdavConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="16" value="${window.siyuan.config.sync.webdav.concurrentReqs}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="purgeData">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="webdav">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="webdav">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:e===4?`<div class="b3-label b3-label--inner">
    <div class="ft__error">
        ${window.siyuan.languages.mobileNotSupport}
    </div>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderLocalIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.proFeature}</em>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.local.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.local.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Concurrent Reqs</div>
    <div class="fn__space"></div>
    <input id="localConcurrentReqs" class="b3-text-field fn__block" type="number" min="1" max="1024" value="${window.siyuan.config.sync.local.concurrentReqs}">
</div>`:"":`<div>
    ${window.siyuan.languages._kernel[214].replaceAll("${accountServer}",Mt(""))}
</div>
<div class="ft__error${e==4?"":" fn__none"}">
    <div class="fn__hr--b"></div>
    ${window.siyuan.languages.mobileNotSupport}
</div>`,ur=()=>{const e=St.element.querySelector("#importData");e&&e.addEventListener("change",()=>{const i=new FormData;i.append("file",e.files[0]);const o=e.getAttribute("data-type")==="s3";L(o?"/api/sync/importSyncProviderS3":"/api/sync/importSyncProviderWebDAV",i,l=>{o?window.siyuan.config.sync.s3=l.data.s3:window.siyuan.config.sync.webdav=l.data.webdav,St.element.querySelector("#syncProviderPanel").innerHTML=cr(window.siyuan.config.sync.provider),ur(),se(window.siyuan.languages.imported),e.value=""})});const t=St.element.querySelector("#reposData"),n=St.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(fa("")){n.classList.add("fn__none");let i=t;for(;i;)i.classList.add("fn__none"),i=i.nextElementSibling;return}L("/api/cloud/getCloudSpace",{},i=>{if(n.classList.add("fn__none"),i.code===1){t.innerHTML=i.msg;return}else t.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${i.data.sync?i.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${i.data.backup?i.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Mt("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${i.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${i.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${i.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Mt("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${i.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),t.classList.remove("fn__none");return}n.classList.add("fn__none");let a=t.nextElementSibling;for(;a;)Fi()?a.classList.remove("fn__none"):a.classList.add("fn__none"),a=a.nextElementSibling;t.classList.add("fn__none");const s=St.element.querySelector("#syncProviderPanel");s.querySelectorAll(".b3-text-field, .b3-select").forEach(i=>{i.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let o=parseInt(s.querySelector("#timeout").value,10);7>o&&(1>o?o=30:o=7),300<o&&(o=300);let l=parseInt(s.querySelector("#s3ConcurrentReqs").value,10);1>l&&(l=1),16<l&&(l=16),s.querySelector("#timeout").value=o.toString();let r=s.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const d={endpoint:r,accessKey:s.querySelector("#accessKey").value.trim(),secretKey:s.querySelector("#secretKey").value.trim(),bucket:s.querySelector("#bucket").value.trim(),pathStyle:s.querySelector("#pathStyle").value==="true",region:s.querySelector("#region").value.trim(),skipTlsVerify:s.querySelector("#s3SkipTlsVerify").value==="true",timeout:o,concurrentReqs:l};L("/api/sync/setSyncProviderS3",{s3:d},()=>{window.siyuan.config.sync.s3=d})}else if(window.siyuan.config.sync.provider===3){let o=parseInt(s.querySelector("#timeout").value,10);7>o&&(o=7),300<o&&(o=300);let l=parseInt(s.querySelector("#webdavConcurrentReqs").value,10);1>l&&(l=1),16<l&&(l=16),s.querySelector("#timeout").value=o.toString();let r=s.querySelector("#endpoint").value;r=r.trim().replace("http://http(s)://","https://"),r=r.replace("http(s)://","https://"),r.startsWith("http")||(r="http://"+r);const d={endpoint:r,username:s.querySelector("#username").value.trim(),password:s.querySelector("#password").value.trim(),skipTlsVerify:s.querySelector("#webdavSkipTlsVerify").value==="true",timeout:o,concurrentReqs:l};L("/api/sync/setSyncProviderWebDAV",{webdav:d},()=>{window.siyuan.config.sync.webdav=d})}else if(window.siyuan.config.sync.provider===4){let o=parseInt(s.querySelector("#timeout").value,10);7>o&&(o=7),300<o&&(o=300);let l=parseInt(s.querySelector("#localConcurrentReqs").value,10);1>l&&(l=1),1024<l&&(l=1024),s.querySelector("#timeout").value=o.toString();const r={endpoint:s.querySelector("#endpoint").value,timeout:o,concurrentReqs:l};L("/api/sync/setSyncProviderLocal",{local:r},d=>{if(d.code===0){window.siyuan.config.sync.local=d.data.local;const c=s.querySelector("#endpoint");c&&(c.value=d.data.local.endpoint)}else window.siyuan.config.sync.local=r})}})})},St={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.sync.provider===0?"selected":""}>SiYuan</option>
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
        <option value="4" ${window.siyuan.config.sync.provider===4?"selected":""}>${window.siyuan.languages.localFileSystem}</option>
    </select>
</div>
<div id="syncProviderPanel" class="b3-label">
    ${cr(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </div>
    <div class="fn__flex b3-label${window.siyuan.config.sync.mode!==1?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncInterval}
            <div class="b3-label__text">${window.siyuan.languages.syncIntervalTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="number" min="30" max="43200" id="syncInterval" class="b3-text-field fn__flex-center" value="${window.siyuan.config.sync.interval}" >
        <span class="fn__space"></span>        
        <span class="fn__flex-center ft__on-surface">${window.siyuan.languages.second}</span> 
    </div>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudSyncDir}
            <div class="b3-label__text">${window.siyuan.languages.cloudSyncDirTip}</div>
        </div>
        <div class="fn__space"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-action="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{ur();const e=St.element.querySelector("#reposCloudSyncSwitch");e.addEventListener("change",()=>{if(e.checked&&window.siyuan.config.sync.cloudName===""){e.checked=!1,se(window.siyuan.languages._kernel[123]);return}L("/api/sync/setSyncEnable",{enabled:e.checked},()=>{window.siyuan.config.sync.enabled=e.checked,jn()})});const t=St.element.querySelector("#syncInterval");t.addEventListener("change",()=>{let r=parseInt(t.value);30>r&&(r=30),43200<r&&(r=43200),t.value=r.toString(),L("/api/sync/setSyncInterval",{interval:r},()=>{window.siyuan.config.sync.interval=r,jn()})});const n=St.element.querySelector("#syncPerception");n.addEventListener("change",()=>{L("/api/sync/setSyncPerception",{enabled:n.checked},()=>{window.siyuan.config.sync.perception=n.checked,jn()})});const a=St.element.querySelector("#generateConflictDoc");a.addEventListener("change",()=>{L("/api/sync/setSyncGenerateConflictDoc",{enabled:a.checked},()=>{window.siyuan.config.sync.generateConflictDoc=a.checked})});const s=St.element.querySelector("#syncMode");s.addEventListener("change",()=>{L("/api/sync/setSyncMode",{mode:parseInt(s.value,10)},()=>{s.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?n.parentElement.classList.remove("fn__none"):n.parentElement.classList.add("fn__none"),s.value==="1"?t.parentElement.classList.remove("fn__none"):t.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(s.value,10)})});const i=St.element.querySelector("#reposCloudSyncList"),o=St.element.querySelector("#syncProvider");o.addEventListener("change",()=>{L("/api/sync/setSyncProvider",{provider:parseInt(o.value,10)},r=>{r.code===1?(se(r.msg),o.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(o.value,10),St.element.querySelector("#syncProviderPanel").innerHTML=cr(window.siyuan.config.sync.provider),ur(),i.innerHTML="",i.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?n.parentElement.classList.add("fn__none"):n.parentElement.classList.remove("fn__none"),window.siyuan.config.sync.mode!==1?t.parentElement.classList.add("fn__none"):t.parentElement.classList.remove("fn__none")})});const l=St.element.querySelector("#reposLoading");l.style.width=St.element.clientWidth+"px",l.style.height=St.element.clientHeight+"px",Mu(i),St.element.firstElementChild.addEventListener("click",r=>{let d=r.target;for(;d&&d!==St.element;){const c=d.getAttribute("data-action");if(c==="config"){i.classList.contains("fn__none")?(hs(i,!0),i.classList.remove("fn__none")):i.classList.add("fn__none");break}else if(c==="togglePassword"){const f=d.firstElementChild.getAttribute("xlink:href")==="#iconEye";d.firstElementChild.setAttribute("xlink:href",f?"#iconEyeoff":"#iconEye"),d.previousElementSibling.setAttribute("type",f?"text":"password");break}else if(c==="exportData"){L(d.getAttribute("data-type")==="s3"?"/api/sync/exportSyncProviderS3":"/api/sync/exportSyncProviderWebDAV",{},f=>{Nt(f.data.zip)});break}else if(c==="purgeData"){Ne("\u267B\uFE0F "+window.siyuan.languages.cloudStoragePurge,`<div class="b3-typography">${window.siyuan.languages.cloudStoragePurgeConfirm}</div>`,()=>{L("/api/repo/purgeCloudRepo")});break}d=d.parentElement}})}},kt={element:void 0,genHTML:()=>{const e=P();return`
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishService}
        <div class="b3-label__text">${window.siyuan.languages.publishServiceTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="publishEnable" type="checkbox"${window.siyuan.config.publish.enable?" checked":""}/>
</label>
<div class="b3-label">
    ${e?`
${window.siyuan.languages.publishServicePort}
<span class="fn__hr"></span>
<input class="b3-text-field fn__block" id="publishPort" type="number" min="0" max="65535" value="${window.siyuan.config.publish.port}">
<div class="b3-label__text">${window.siyuan.languages.publishServicePortTip}</div>`:`
<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishServicePort}
        <div class="b3-label__text">${window.siyuan.languages.publishServicePortTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="publishPort" type="number" min="0" max="65535" value="${window.siyuan.config.publish.port}">
</div>`}
</div>
<div class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.publishServiceAddresses}
            <div class="b3-label__text">${window.siyuan.languages.publishServiceAddressesTip}</div>
        </div>
        <div class="fn__space"></div>
    </div>
    <div class="fn__hr"></div>
    <div id="publishAddresses">
    </div>
</div>
<div class="b3-label">
    <label class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.publishServiceAuth}
            <div class="b3-label__text">${window.siyuan.languages.publishServiceAuthTip}</div>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" id="publishAuthEnable" type="checkbox"${window.siyuan.config.publish.auth.enable?" checked":""}/>
    </label>
</div>
<div class="b3-label">
    ${e?`
${window.siyuan.languages.publishServiceAuthAccounts}
<div class="b3-label__text">${window.siyuan.languages.publishServiceAuthAccountsTip}</div>
<div class="b3-label b3-label--inner fn__flex">
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--outline fn__size200 fn__flex-center" id="publishAuthAccountAdd">
        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.publishServiceAuthAccountAdd}
    </button>
</div>`:`
<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.publishServiceAuthAccounts}
        <div class="b3-label__text">${window.siyuan.languages.publishServiceAuthAccountsTip}</div>
    </div>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200 fn__flex-center" id="publishAuthAccountAdd">
        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.publishServiceAuthAccountAdd}
    </button>
</div>`}
    <div class="fn__flex-1" id="publishAuthAccounts">
    </div>
</div>
`},bindEvent:()=>{kt.element.querySelector("#publishAuthAccountAdd").addEventListener("click",()=>{window.siyuan.config.publish.auth.accounts.push({username:"",password:"",memo:""}),kt._renderPublishAuthAccounts(kt.element)}),kt.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{kt._savePublish()})}),kt._refreshPublish()},_refreshPublish:()=>{L("/api/setting/getPublish",{},kt._updatePublishConfig.bind(null,!0))},_savePublish:(e=!0)=>{const t=kt.element.querySelector("#publishEnable"),n=kt.element.querySelector("#publishPort"),a=kt.element.querySelector("#publishAuthEnable");L("/api/setting/setPublish",{enable:t.checked,port:n.valueAsNumber,auth:{enable:a.checked,accounts:window.siyuan.config.publish.auth.accounts}},kt._updatePublishConfig.bind(null,e))},_updatePublishConfig:(e,t)=>{t.code===0?(window.siyuan.config.publish=t.data.publish,e&&kt._renderPublishAuthAccounts(kt.element),kt._renderPublishAddressList(kt.element,t.data.port)):kt._renderPublishAddressList(kt.element,0)},_renderPublishAuthAccounts:(e,t=window.siyuan.config.publish.auth.accounts)=>{const n=P(),a=e.querySelector("#publishAuthAccounts");a.innerHTML=`<div class="fn__hr"></div><ul class="fn__flex-1">${t.map((s,i)=>`
<li class="b3-label b3-label--inner fn__flex" data-index="${i}">
    <input class="b3-text-field fn__block" data-name="username" value="${s.username}" placeholder="${window.siyuan.languages.userName}">
    <span class="fn__space"></span>
    <div class="b3-form__icona fn__block">
        <input class="b3-text-field fn__block b3-form__icona-input" type="password" data-name="password" value="${s.password}" placeholder="${window.siyuan.languages.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__block" data-name="memo" value="${s.memo}" placeholder="${window.siyuan.languages.memo}">
    <span class="fn__space"></span>
    ${n?`
<button class="b3-button b3-button--outline fn__block" data-action="remove">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.delete}
</button>`:`
<span data-action="remove" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`}
</li>
`).join("")}</ul>`,a.querySelectorAll("input").forEach(s=>{s.addEventListener("change",()=>{const i=U(s,"LI");if(i){const o=parseInt(i.dataset.index),l=s.dataset.name;l in window.siyuan.config.publish.auth.accounts[o]&&(window.siyuan.config.publish.auth.accounts[o][l]=s.value,kt._savePublish(!1))}})}),a.querySelectorAll('[data-action="remove"]').forEach(s=>{s.addEventListener("click",()=>{const i=U(s,"LI");if(i){const o=parseInt(i.dataset.index);window.siyuan.config.publish.auth.accounts.splice(o,1),kt._savePublish()}})}),a.querySelectorAll('.b3-form__icona-icon[data-action="togglePassword"]').forEach(s=>{s.addEventListener("click",()=>{const i=s.firstElementChild.getAttribute("xlink:href")==="#iconEye";s.firstElementChild.setAttribute("xlink:href",i?"#iconEyeoff":"#iconEye"),s.previousElementSibling.setAttribute("type",i?"text":"password")})})},_renderPublishAddressList:(e,t)=>{const n=e.querySelector("#publishAddresses");t===0?n.innerText=window.siyuan.languages.publishServiceNotStarted:n.innerHTML=`<ul class="b3-list fn__flex-1" style="padding: 2px 0;">${window.siyuan.config.localIPs.filter(a=>!(a.startsWith("[")&&a.endsWith("]"))).map(a=>`<li><code class="fn__code">${a}:${t}</code></li>`).join("")}${window.siyuan.config.localIPs.filter(a=>a.startsWith("[")&&a.endsWith("]")).map(a=>`<li><code class="fn__code">${a}:${t}</code></li>`).join("")}</ul>`}},we={element:void 0,genHTML:()=>{let e="";return e=`<div class="b3-label">
    ${window.siyuan.languages.apiProvider}
    <div class="b3-label__text">
        ${window.siyuan.languages.apiProviderTip}
    </div>
    <div class="b3-label__text fn__flex config__item">
        <select id="apiProvider" class="b3-select">
            <option value="OpenAI" ${window.siyuan.config.ai.openAI.apiProvider==="OpenAI"?"selected":""}>OpenAI</option>
            <option value="Azure" ${window.siyuan.config.ai.openAI.apiProvider==="Azure"?"selected":""}>Azure</option>
        </select>
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiTimeout}
    <div class="fn__hr"></div>
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-center">s</span>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiMaxTokens}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiTemperature}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="0.1" min="0" max="2" id="apiTemperature" value="${window.siyuan.config.ai.openAI.apiTemperature}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiTemperatureTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiMaxContexts}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="1" max="64" id="apiMaxContexts" value="${window.siyuan.config.ai.openAI.apiMaxContexts}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiMaxContextsTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiModel}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiModel" value="${window.siyuan.config.ai.openAI.apiModel}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiModelTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiKey}
    <div class="fn__hr"></div>
    <div class="b3-form__icona fn__block">
        <input id="apiKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.ai.openAI.apiKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.apiKeyTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiProxy}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiBaseURL}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiVersion}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiVersion" value="${window.siyuan.config.ai.openAI.apiVersion}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiVersionTip}</div>
</div>
<div class="b3-label">
    User-Agent
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiUserAgent" value="${window.siyuan.config.ai.openAI.apiUserAgent}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiUserAgentTip}</div>
</div>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">AI\u5BF9\u8BDD</span><span class="fn__flex-1"></span></div>
    <div data-type="embedding" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">\u5411\u91CF\u5316</span><span class="fn__flex-1"></span></div>
    <div data-type="ai-features" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">AI\u529F\u80FD</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${e}
    </div>
    <div data-type="embedding" style="display: none;">
        ${we.genEmbeddingHTML()}
    </div>
    <div data-type="ai-features" style="display: none;">
        ${we.genAIFeaturesHTML()}
    </div>
</div>
</div>`},genEmbeddingHTML:()=>{var e;const t=((e=window.siyuan.config.ai)==null?void 0:e.embedding)||{provider:"siliconflow",apiKey:"",model:"BAAI/bge-large-zh-v1.5",apiBaseUrl:"https://api.siliconflow.cn/v1/embeddings",encodingFormat:"float",timeout:30,enabled:!1};return`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        \u5411\u91CF\u5316\u63D0\u4F9B\u5546
        <div class="b3-label__text">\u9009\u62E9\u5411\u91CF\u5316\u670D\u52A1\u63D0\u4F9B\u5546\uFF0C\u652F\u6301\u591A\u79CDAI\u6A21\u578B</div>
    </div>
    <span class="fn__space"></span>
    <select id="embeddingProvider" class="b3-select fn__flex-center fn__size200">
        <option value="siliconflow" ${t.provider==="siliconflow"?"selected":""}>SiliconFlow</option>
        <option value="openai" ${t.provider==="openai"?"selected":""}>OpenAI</option>
    </select>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        \u542F\u7528\u5411\u91CF\u5316\u529F\u80FD
        <div class="b3-label__text">\u5F00\u542F\u540E\u53EF\u4F7F\u7528\u8BED\u4E49\u641C\u7D22\u548CAI\u5206\u6790\u529F\u80FD</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="embeddingEnabled" class="b3-switch" ${t.enabled?"checked":""}/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        API\u5BC6\u94A5
        <div class="b3-label__text">\u5411\u91CF\u5316\u670D\u52A1\u7684API\u5BC6\u94A5</div>
        <div class="fn__hr"></div>
        <div class="b3-form__icona fn__block">
            <input id="embeddingApiKey" type="password" class="b3-text-field b3-form__icona-input" value="${t.apiKey}" placeholder="sk-xxx">
            <svg class="b3-form__icona-icon" data-action="toggleEmbeddingPassword"><use xlink:href="#iconEye"></use></svg>
        </div>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        \u5411\u91CF\u5316\u6A21\u578B
        <div class="b3-label__text">\u9009\u62E9\u7528\u4E8E\u5411\u91CF\u5316\u7684AI\u6A21\u578B</div>
        <div class="fn__hr"></div>
        <select id="embeddingModel" class="b3-text-field fn__block">
            <option value="BAAI/bge-large-zh-v1.5" ${t.model==="BAAI/bge-large-zh-v1.5"?"selected":""}>BAAI/bge-large-zh-v1.5 (\u4E2D\u6587\u5927\u578B)</option>
            <option value="BAAI/bge-m3" ${t.model==="BAAI/bge-m3"?"selected":""}>BAAI/bge-m3 (\u591A\u8BED\u8A00)</option>
            <option value="netease-youdao/bce-embedding-base_v1" ${t.model==="netease-youdao/bce-embedding-base_v1"?"selected":""}>BCE-Embedding-Base</option>
            <option value="text-embedding-3-small" ${t.model==="text-embedding-3-small"?"selected":""}>text-embedding-3-small (OpenAI)</option>
            <option value="text-embedding-3-large" ${t.model==="text-embedding-3-large"?"selected":""}>text-embedding-3-large (OpenAI)</option>
            <option value="text-embedding-ada-002" ${t.model==="text-embedding-ada-002"?"selected":""}>text-embedding-ada-002 (OpenAI)</option>
        </select>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        API\u5730\u5740
        <div class="b3-label__text">\u5411\u91CF\u5316\u670D\u52A1\u7684API\u7AEF\u70B9\u5730\u5740</div>
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" id="embeddingApiBaseUrl" value="${t.apiBaseUrl}" placeholder="https://api.siliconflow.cn/v1/embeddings"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        \u7F16\u7801\u683C\u5F0F
        <div class="b3-label__text">\u5411\u91CF\u6570\u636E\u7684\u7F16\u7801\u683C\u5F0F</div>
    </div>
    <span class="fn__space"></span>
    <select id="embeddingEncodingFormat" class="b3-select fn__flex-center fn__size200">
        <option value="float" ${t.encodingFormat==="float"?"selected":""}>float</option>
        <option value="base64" ${t.encodingFormat==="base64"?"selected":""}>base64</option>
    </select>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        \u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4
        <div class="b3-label__text">\u5411\u91CF\u5316\u8BF7\u6C42\u7684\u6700\u5927\u7B49\u5F85\u65F6\u95F4</div>
    </div>
    <span class="fn__space"></span>
    <div class="fn__size200 fn__flex-center fn__flex">
        <input class="b3-text-field fn__flex-1" type="number" step="1" min="5" max="300" id="embeddingTimeout" value="${t.timeout}"/>
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-center">\u79D2</span>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        <button id="testEmbeddingConnection" class="b3-button b3-button--outline">\u6D4B\u8BD5\u8FDE\u63A5</button>
        <span class="fn__space"></span>
        <button id="getEmbeddingModels" class="b3-button b3-button--outline">\u83B7\u53D6\u53EF\u7528\u6A21\u578B</button>
    </div>
</div>`},genAIFeaturesHTML:()=>`<div class="b3-label">
    <h3>AI\u529F\u80FD\u6D4B\u8BD5</h3>
    <div class="b3-label__text">\u6D4B\u8BD5\u65B0\u589E\u7684AI\u5411\u91CF\u5316\u548C\u5206\u6790\u529F\u80FD</div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <button id="semanticSearchTest" class="b3-button b3-button--outline">\u8BED\u4E49\u641C\u7D22\u6D4B\u8BD5</button>
        <span class="fn__space"></span>
        <input id="semanticSearchQuery" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u641C\u7D22\u5173\u952E\u8BCD..." value="\u4EBA\u5DE5\u667A\u80FD">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <button id="notebookSummaryTest" class="b3-button b3-button--outline">\u7B14\u8BB0\u672C\u6458\u8981\u751F\u6210\u6D4B\u8BD5</button>
        <span class="fn__space"></span>
        <input id="notebookSummaryId" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u7B14\u8BB0\u672CID...">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <button id="batchVectorizeTest" class="b3-button b3-button--outline">\u6279\u91CF\u5411\u91CF\u5316\u6D4B\u8BD5</button>
        <span class="fn__space"></span>
        <input id="batchVectorizeNotebook" class="b3-text-field fn__flex-1" placeholder="\u8F93\u5165\u7B14\u8BB0\u672CID...">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        <div id="aiTestResults" class="b3-form__space-small" style="background: var(--b3-theme-background-contrast); padding: 12px; border-radius: 4px; min-height: 60px; font-family: monospace; white-space: pre-wrap;">\u6D4B\u8BD5\u7ED3\u679C\u5C06\u5728\u8FD9\u91CC\u663E\u793A...</div>
    </div>
</div>`,bindEvent:()=>{we.element.querySelectorAll(".layout-tab-bar .item").forEach(l=>{l.addEventListener("click",()=>{const r=l.getAttribute("data-type");we.element.querySelectorAll(".layout-tab-bar .item").forEach(d=>{d.classList.remove("item--focus")}),l.classList.add("item--focus"),we.element.querySelectorAll(".fn__flex-1 > div").forEach(d=>{d.getAttribute("data-type")===r?d.style.display="block":d.style.display="none"})})});const e=we.element.querySelector('.b3-form__icona-icon[data-action="togglePassword"]');e&&e.addEventListener("click",()=>{const l=e.firstElementChild.getAttribute("xlink:href")==="#iconEye";e.firstElementChild.setAttribute("xlink:href",l?"#iconEyeoff":"#iconEye"),e.previousElementSibling.setAttribute("type",l?"text":"password")});const t=we.element.querySelector('.b3-form__icona-icon[data-action="toggleEmbeddingPassword"]');t&&t.addEventListener("click",()=>{const l=t.firstElementChild.getAttribute("xlink:href")==="#iconEye";t.firstElementChild.setAttribute("xlink:href",l?"#iconEyeoff":"#iconEye"),t.previousElementSibling.setAttribute("type",l?"text":"password")}),we.element.querySelectorAll("#apiKey, #apiModel, #apiMaxTokens, #apiTemperature, #apiMaxContexts, #apiProxy, #apiTimeout, #apiProvider, #apiBaseURL, #apiVersion, #apiUserAgent").forEach(l=>{l.addEventListener("change",()=>{L("/api/setting/setAI",{openAI:{apiUserAgent:we.element.querySelector("#apiUserAgent").value,apiBaseURL:we.element.querySelector("#apiBaseURL").value,apiVersion:we.element.querySelector("#apiVersion").value,apiKey:we.element.querySelector("#apiKey").value,apiModel:we.element.querySelector("#apiModel").value,apiMaxTokens:parseInt(we.element.querySelector("#apiMaxTokens").value),apiTemperature:parseFloat(we.element.querySelector("#apiTemperature").value),apiMaxContexts:parseInt(we.element.querySelector("#apiMaxContexts").value),apiProxy:we.element.querySelector("#apiProxy").value,apiTimeout:parseInt(we.element.querySelector("#apiTimeout").value),apiProvider:we.element.querySelector("#apiProvider").value}},r=>{window.siyuan.config.ai=r.data})})}),we.element.querySelectorAll("#embeddingProvider, #embeddingApiKey, #embeddingModel, #embeddingApiBaseUrl, #embeddingEncodingFormat, #embeddingTimeout, #embeddingEnabled").forEach(l=>{l.addEventListener("change",()=>{const r={provider:we.element.querySelector("#embeddingProvider").value,apiKey:we.element.querySelector("#embeddingApiKey").value,model:we.element.querySelector("#embeddingModel").value,apiBaseUrl:we.element.querySelector("#embeddingApiBaseUrl").value,encodingFormat:we.element.querySelector("#embeddingEncodingFormat").value,timeout:parseInt(we.element.querySelector("#embeddingTimeout").value),enabled:we.element.querySelector("#embeddingEnabled").checked};L("/api/ai/setEmbeddingConfig",r,d=>{d.code===0?(window.siyuan.config.ai.embedding=d.data.data,we.showMessage("\u5411\u91CF\u5316\u914D\u7F6E\u5DF2\u4FDD\u5B58","success")):we.showMessage("\u4FDD\u5B58\u5931\u8D25: "+d.msg,"error")})})});const n=we.element.querySelector("#testEmbeddingConnection");n&&n.addEventListener("click",()=>{we.showMessage("\u6B63\u5728\u6D4B\u8BD5\u5411\u91CF\u5316\u670D\u52A1\u8FDE\u63A5...","info"),L("/api/ai/testEmbeddingConnection",{},l=>{const r=we.element.querySelector("#aiTestResults");l.code===0?(r.textContent=`\u2705 \u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F!
`+JSON.stringify(l.data,null,2),we.showMessage("\u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F","success")):(r.textContent="\u274C \u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: "+l.msg,we.showMessage("\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25","error"))})});const a=we.element.querySelector("#getEmbeddingModels");a&&a.addEventListener("click",()=>{const l=we.element.querySelector("#embeddingProvider").value;we.showMessage(`\u6B63\u5728\u83B7\u53D6${l}\u7684\u53EF\u7528\u6A21\u578B...`,"info"),L("/api/ai/getEmbeddingModels",{provider:l},r=>{const d=we.element.querySelector("#aiTestResults");r.code===0?(d.textContent=`\u2705 ${l}\u53EF\u7528\u6A21\u578B:
`+JSON.stringify(r.data,null,2),we.showMessage("\u6A21\u578B\u5217\u8868\u83B7\u53D6\u6210\u529F","success")):(d.textContent="\u274C \u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25: "+r.msg,we.showMessage("\u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25","error"))})});const s=we.element.querySelector("#semanticSearchTest");s&&s.addEventListener("click",()=>{const l=we.element.querySelector("#semanticSearchQuery").value;if(!l.trim()){we.showMessage("\u8BF7\u8F93\u5165\u641C\u7D22\u67E5\u8BE2","warning");return}we.showMessage("\u6B63\u5728\u6267\u884C\u8BED\u4E49\u641C\u7D22...","info"),L("/api/ai/semanticSearch",{query:l,limit:10},r=>{const d=we.element.querySelector("#aiTestResults");r.code===0?(d.textContent=`\u2705 \u8BED\u4E49\u641C\u7D22\u7ED3\u679C:
`+JSON.stringify(r.data,null,2),we.showMessage("\u8BED\u4E49\u641C\u7D22\u5B8C\u6210","success")):(d.textContent="\u274C \u8BED\u4E49\u641C\u7D22\u5931\u8D25: "+r.msg,we.showMessage("\u8BED\u4E49\u641C\u7D22\u5931\u8D25","error"))})});const i=we.element.querySelector("#notebookSummaryTest");i&&i.addEventListener("click",()=>{const l=we.element.querySelector("#notebookSummaryId").value;if(!l.trim()){we.showMessage("\u8BF7\u8F93\u5165\u7B14\u8BB0\u672CID","warning");return}we.showMessage("\u6B63\u5728\u751F\u6210\u7B14\u8BB0\u672C\u6458\u8981...","info"),L("/api/ai/generateNotebookSummary",{notebookId:l},r=>{const d=we.element.querySelector("#aiTestResults");r.code===0?(d.textContent=`\u2705 \u7B14\u8BB0\u672C\u6458\u8981:
`+JSON.stringify(r.data,null,2),we.showMessage("\u6458\u8981\u751F\u6210\u5B8C\u6210","success")):(d.textContent="\u274C \u6458\u8981\u751F\u6210\u5931\u8D25: "+r.msg,we.showMessage("\u6458\u8981\u751F\u6210\u5931\u8D25","error"))})});const o=we.element.querySelector("#batchVectorizeTest");o&&o.addEventListener("click",()=>{const l=we.element.querySelector("#batchVectorizeNotebook").value;if(!l.trim()){we.showMessage("\u8BF7\u8F93\u5165\u7B14\u8BB0\u672CID","warning");return}confirm("\u6279\u91CF\u5411\u91CF\u5316\u4F1A\u6D88\u8017API\u989D\u5EA6\uFF0C\u786E\u5B9A\u8981\u7EE7\u7EED\u5417\uFF1F")&&(we.showMessage("\u6B63\u5728\u6267\u884C\u6279\u91CF\u5411\u91CF\u5316\uFF0C\u8BF7\u7A0D\u5019...","info"),L("/api/ai/batchVectorizeNotebook",{notebookId:l},r=>{const d=we.element.querySelector("#aiTestResults");r.code===0?(d.textContent=`\u2705 \u6279\u91CF\u5411\u91CF\u5316\u5B8C\u6210:
`+JSON.stringify(r.data,null,2),we.showMessage("\u6279\u91CF\u5411\u91CF\u5316\u5B8C\u6210","success")):(d.textContent="\u274C \u6279\u91CF\u5411\u91CF\u5316\u5931\u8D25: "+r.msg,we.showMessage("\u6279\u91CF\u5411\u91CF\u5316\u5931\u8D25","error"))}))})},showMessage:(e,t="info")=>{const n=document.createElement("div");n.className=`b3-dialog__message b3-dialog__message--${t}`,n.textContent=e,n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.zIndex="1000",document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},3e3)}},Jm=()=>{nn({title:"AI",icon:"iconSparkles",html:we.genHTML(),bindEvent(e){we.element=e,we.bindEvent()}})},dn={element:void 0,genHTML:()=>{let e=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.reviewMode}
        <div class="b3-label__text">${window.siyuan.languages.reviewModeTip}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="reviewMode">
      <option value="0" ${window.siyuan.config.flashcard.reviewMode===0?"selected":""}>${window.siyuan.languages.reviewMode0}</option>
      <option value="1" ${window.siyuan.config.flashcard.reviewMode===1?"selected":""}>${window.siyuan.languages.reviewMode1}</option>
      <option value="2" ${window.siyuan.config.flashcard.reviewMode===2?"selected":""}>${window.siyuan.languages.reviewMode2}</option>
    </select>    
</div>`;return e=`${e}<div class="b3-label">
    ${window.siyuan.languages.flashcardNewCardLimit}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardReviewCardLimit}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamWeights}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
</div>`,e},bindEvent:()=>{dn.element.querySelectorAll("input, select.b3-select").forEach(e=>{e.addEventListener("change",()=>{L("/api/setting/setFlashcard",{reviewMode:parseInt(dn.element.querySelector("#reviewMode").value),newCardLimit:parseInt(dn.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(dn.element.querySelector("#reviewCardLimit").value),mark:dn.element.querySelector("#mark").checked,list:dn.element.querySelector("#list").checked,superBlock:dn.element.querySelector("#superBlock").checked,heading:dn.element.querySelector("#heading").checked,deck:dn.element.querySelector("#deck").checked,requestRetention:parseFloat(dn.element.querySelector("#requestRetention").value),maximumInterval:parseInt(dn.element.querySelector("#maximumInterval").value),weights:dn.element.querySelector("#weights").value},t=>{window.siyuan.config.flashcard=t.data})})})}},Qm=()=>{nn({title:window.siyuan.languages.riffCard,icon:"iconRiffCard",html:dn.genHTML(),bindEvent(e){dn.element=e,dn.bindEvent()}})};var eb=cn(922),tb=cn.n(eb);const nb=e=>{if(Go({code:2,msg:""}),e===0)document.querySelector("#modelMain").dispatchEvent(new CustomEvent("click",{detail:document.querySelector("#modelMain #refresh")}));else{let t="";switch(e){case-1:t="Invalid cloud region.";break;case-2:t="Server communication failed, need to retry.";break;case-3:t="Non-iOS device.";break;case-4:t="Account not logged in.";break;case-5:t="Account status abnormal.";break;case-6:t="Parameter error.";break;case-7:t="AccountToken verification failed.";break;case-8:t="Transaction verification failed.";break;case-9:t="Unknown product.";break;case-10:t="User canceled the transaction.";break;case-11:t="Purchase transaction was suspended.";break;case-12:t="Purchase failed.";break}se(t,0,"error")}},ab=e=>{window.siyuan.user?L("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},t=>{if(window.siyuan.user.userSiYuanOneTimePayStatus!==t.data.userSiYuanOneTimePayStatus||window.siyuan.user.userSiYuanProExpireTime!==t.data.userSiYuanProExpireTime||window.siyuan.user.userSiYuanSubscriptionPlan!==t.data.userSiYuanSubscriptionPlan||window.siyuan.user.userSiYuanSubscriptionType!==t.data.userSiYuanSubscriptionType||window.siyuan.user.userSiYuanSubscriptionStatus!==t.data.userSiYuanSubscriptionStatus){se(window.siyuan.languages._kernel[19]);return}window.siyuan.user=t.data;let n;window.siyuan.config.cloudRegion===0?n=e==="function"?"china00":"china02":n=e==="function"?"00":"02",window.webkit.messageHandlers.purchase.postMessage(`${n} ${Zn().substring(0,19)}${window.siyuan.config.cloudRegion}00${window.siyuan.user.userId.substring(0,1)}-${window.siyuan.user.userId.substring(1)}`),Go({code:1,msg:""})}):se(window.siyuan.languages.needLogin)},Pu=()=>{var e,t;const n=Rt();let a;n?((e=window.siyuan.user)==null?void 0:e.userSiYuanOneTimePayStatus)===1?a=`<button class="b3-button b3-button--big" data-action="iOSPay" data-type="subscribe">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account4}
</button>`:a=`<button class="b3-button b3-button--big" data-action="iOSPay" data-type="subscribe">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}
</button>
<div class="fn__hr--b"></div>
<button class="b3-button b3-button--success" data-action="iOSPay" data-type="function">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}
</button>`:a=`<a class="b3-button b3-button--big" href="${Hr("pricing.html")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages[((t=window.siyuan.user)==null?void 0:t.userSiYuanOneTimePayStatus)===1?"account4":"account1"]}
</a>`,a+=`<div class="fn__hr--b"></div>
<span class="b3-chip b3-chip--primary b3-chip--hover${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}" id="trialSub">
    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>
    ${window.siyuan.languages.freeSub}
</span>
<div class="fn__hr${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}"></div>
<a href="${Mt("sponsor")}" target="_blank" class="${n?"fn__none ":""}b3-chip b3-chip--pink b3-chip--hover">
    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>
    ${window.siyuan.languages.sponsor}
</a>`;let s="";window.siyuan.user.userTitles.length>0&&(s='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(o=>{s+=`<div class="b3-chip b3-chip--middle b3-chip--primary">${o.icon} ${o.name}</div>`}),s+="</div>");let i="";if(window.siyuan.user.userSiYuanProExpireTime===-1)i=`<div class="b3-chip b3-chip--secondary">${p.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`;else if(window.siyuan.user.userSiYuanProExpireTime>0){const o=`<div class="fn__hr--b"></div>
<div class="ft__on-surface ft__smaller">
    ${window.siyuan.languages.account6} 
    ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-new Date().getTime())/1e3/60/60/24))} 
    ${window.siyuan.languages.day} 
    ${n?`<a href="javascript:void(0)" data-action="iOSPay" data-type="subscribe">${window.siyuan.languages.clickMeToRenew}</a>`:`<a href="${Mt("subscribe/siyuan")}" target="_blank">${window.siyuan.languages.clickMeToRenew}</a>`}
</div>`;window.siyuan.user.userSiYuanOneTimePayStatus===1&&(i=`<div class="b3-chip b3-chip--success"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account7}</div>
<div class="fn__hr--b"></div>`),window.siyuan.user.userSiYuanSubscriptionPlan===2?i+=`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>
${o}<div class="fn__hr--b"></div>`:i+=`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account8}</div>
${o}<div class="fn__hr--b"></div>`,window.siyuan.user.userSiYuanOneTimePayStatus===0&&(i+=n?`<a class="b3-button b3-button--success" href="${Hr("pricing.html")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}
</a>`:`<button class="b3-button b3-button--success" data-action="iOSPay" data-type="function">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}
</button>`)}else window.siyuan.user.userSiYuanOneTimePayStatus===1?i=`<div class="b3-chip b3-chip--success"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account7}</div>
<div class="fn__hr--b"></div>${a}`:i=a;nn({title:window.siyuan.languages.manage,icon:"iconAccount",html:`<div class="fn__flex-column">
<div class="config-account__bg">
    <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
    <a href="${Mt("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
    <div class="config-account__name">
        <div class="fn__hr--b"></div>
        <h1>
            <a target="_blank" class="fn__a" href="${Mt("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
            <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
        </h1>
        <div class="fn__hr--b"></div>
        <div class="fn__hr--b"></div>
        <div>${i}</div>
    </div>
    ${s}
</div>
<div class="config-account__info">
    <div class="fn__flex">
        <a class="b3-button b3-button--text${n?" fn__none":""}" href="${Mt("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
        <span class="fn__space${n?" fn__none":""}"></span>
        <button class="b3-button b3-button--cancel" id="logout">
            ${window.siyuan.languages.logout}
        </button>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--cancel" id="deactivateUser">
            ${window.siyuan.languages.deactivateUser}
        </button>
        <span class="fn__flex-1"></span>
        <button class="b3-button b3-button--cancel" id="refresh">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </button>
    </div>
</div></div>`,bindEvent(o){o.addEventListener("click",l=>{let r=l.target;for(typeof l.detail!="number"&&(r=l.detail);r&&r!==o;){if(r.getAttribute("data-action")==="iOSPay"){ab(r.getAttribute("data-type")),l.preventDefault(),l.stopPropagation();break}else if(r.id==="logout"){L("/api/setting/logoutCloudUser",{},()=>{window.siyuan.user=null,nt(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,jn()}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="deactivateUser"){const d=new ke({title:"\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,width:"92vw",content:Ou(!0)});Ru(d.element.querySelector(".b3-dialog__body"),!0),d.element.setAttribute("data-key",p.DIALOG_DEACTIVATEUSER),l.preventDefault(),l.stopPropagation();break}else if(r.id==="trialSub"){L("/api/account/startFreeTrial",{},()=>{o.dispatchEvent(new CustomEvent("click",{detail:o.querySelector("#refresh")}))}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="refresh"){const d=r.firstElementChild;if(d.classList.contains("fn__rotate"))return;d.classList.add("fn__rotate"),L("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},c=>{window.siyuan.user=c.data,se(window.siyuan.languages.refreshUser,3e3),Pu();const f=document.getElementById("menuAccount");window.siyuan.user?f.innerHTML=`<img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/><span class="b3-menu__label">${window.siyuan.user.userName}</span>`:f.innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,jn()}),l.preventDefault(),l.stopPropagation();break}r=r.parentElement}})}})},Ou=(e=!1)=>{let t;return e?t=`<div class="b3-form__img fn__none">
    <div class="fn__hr--b"></div>
    <img id="captchaImg" class="fn__pointer" style="top: 17px;height: 26px;">
    <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
</div>
<div class="fn__hr--b"></div>
<button id="login" class="b3-button fn__block">${window.siyuan.languages.deactivateUser}</button>`:t=`<div class="b3-form__icon">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconFocus"></use></svg>
    <select class="b3-select b3-form__icon-input fn__block" id="cloudRegion">
        <option value="0"${window.siyuan.config.cloudRegion===0?" selected":""}>${window.siyuan.languages.cloudRegionChina}</option>
        <option value="1"${window.siyuan.config.cloudRegion===1?" selected":""}>${window.siyuan.languages.cloudRegionNorthAmerica}</option>
    </select>
</div>
<div class="b3-form__img fn__none">
    <div class="fn__hr--b"></div>
    <img id="captchaImg" class="fn__pointer" style="top: 17px;height: 26px;">
    <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
</div>
<div class="fn__hr--b"></div>
<label class="ft__smaller ft__on-surface fn__flex">
    <span class="fn__space"></span>
    <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">
    <span class="fn__space"></span>
    <span>${window.siyuan.languages.accountTip}</span>
</label>
<div class="fn__hr--b"></div>
<button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>
<div class="fn__hr--b"></div>
<div class="ft__center">
    <a href="${Mt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
    <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
    <a href="${Mt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>
</div>`,`<div class="b3-form__space" id="form1">
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>
        <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">
    </div>
    <div class="fn__hr--b"></div>
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
        <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">
    </div>
    <div class="fn__hr--b"></div>
    ${t}
</div>
<div class="b3-form__space fn__none" id="form2">
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
        <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">
    </div>
    <div class="fn__hr--b"></div>
    <button id="login2" class="b3-button fn__block">${e?window.siyuan.languages.deactivateUser:window.siyuan.languages.login}</button>
</div>`},qu=(e,t=!1)=>{t?(ae(["dialog"]),Ne("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{L("/api/account/deactivate",{},()=>{window.siyuan.user=null,nt(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,jn()})})):L("/api/setting/getCloudUser",{token:e.data.token},n=>{window.siyuan.user=n.data,nt(),document.getElementById("menuAccount").innerHTML=`<img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/>
<span class="b3-menu__label">${window.siyuan.user.userName}</span>`,jn()})},Ru=(e,t=!1)=>{const n=e.querySelector("#agreeLogin"),a=e.querySelector("#userName"),s=e.querySelector("#userPassword"),i=e.querySelector("#captchaImg"),o=e.querySelector("#captcha"),l=e.querySelector("#twofactorAuthCode"),r=e.querySelector("#login"),d=e.querySelector("#login2");a.focus();let c,f;n&&n.addEventListener("click",()=>{n.checked?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{i.setAttribute("src",Mt("captcha")+`/login?needCaptcha=${f}&t=${new Date().getTime()}`)});const m=e.querySelector("#cloudRegion");m&&m.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(m.value),e.querySelector("#form1").lastElementChild.innerHTML=`<a href="${Mt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
        <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
        <a href="${Mt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),r.addEventListener("click",()=>{L("/api/account/login",{userName:a.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:tb()(s.value),captcha:o.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},u=>{if(u.code===1){if(se(u.msg),u.data.needCaptcha){f=u.data.needCaptcha,o.parentElement.classList.remove("fn__none"),o.previousElementSibling.setAttribute("src",Mt("captcha")+`/login?needCaptcha=${u.data.needCaptcha}`),o.value="";return}return}if(u.code===10){e.querySelector("#form1").classList.add("fn__none"),e.querySelector("#form2").classList.remove("fn__none"),l.focus(),c=u.data.token;return}qu(u,t)})}),d.addEventListener("click",()=>{L("/api/setting/login2faCloudUser",{code:l.value,token:c},u=>{qu(u,t)})})},ib=()=>{nn({title:window.siyuan.languages.login,icon:"iconAccount",html:Ou(),bindEvent(e){Ru(e)}})},sb=()=>{(!window.siyuan.config.localIPs||window.siyuan.config.localIPs.length===0||window.siyuan.config.localIPs.length===1&&window.siyuan.config.localIPs[0]==="")&&(window.siyuan.config.localIPs=["127.0.0.1"]),nn({title:window.siyuan.languages.about,icon:"iconInfo",html:`<div>
<label class="b3-label fn__flex${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</label>
<div class="b3-label">
        ${window.siyuan.languages.about2}
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" readonly value="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}">
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        <div class="fn__hr"></div>
        ${(()=>{const e=[],t=[];for(const n of window.siyuan.config.localIPs){if(!n.trim())break;n.startsWith("[")&&n.endsWith("]")?t.push(`<code class="fn__code">${n}</code>`):e.push(`<code class="fn__code">${n}</code>`)}return`<div class="b3-label__text${e.length?"":" fn__none"}">${e.join(" ")}</div>
                    <div class="b3-label__text${t.length?"":" fn__none"}">${t.join(" ")}</div>`})()}
        <div class="fn__hr"></div>
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly||Be()&&!Rt()&&!Je()&&!Ri()&&!ut()?" fn__none":""}">
    ${window.siyuan.languages.about5}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="authCode">
        <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.dataRepoKey}
    <div class="fn__hr"></div>
    <div class="${window.siyuan.config.repo.key?"fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            ${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="${window.siyuan.config.repo.key?"":"fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="removeKey">
            <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
    <div class="b3-label__text ft__error">${window.siyuan.languages.dataRepoKeyTip2}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.dataRepoPurge}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="purgeRepo">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.dataRepoPurgeTip}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" style="padding-right: 64px;" id="indexRetentionDays" min="1" type="number" class="b3-text-field" value="${window.siyuan.config.repo.indexRetentionDays}">
    <div class="b3-label__text">${window.siyuan.languages.dataRepoAutoPurgeIndexRetentionDays}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" style="padding-right: 64px;" id="retentionIndexesDaily" min="1" type="number" class="b3-text-field" value="${window.siyuan.config.repo.retentionIndexesDaily}">
    <div class="b3-label__text">${window.siyuan.languages.dataRepoAutoPurgeRetentionIndexesDaily}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.vacuumDataIndex}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="vacuumDataIndex">
       <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.vacuumDataIndex}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.vacuumDataIndexTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.rebuildDataIndex}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="rebuildDataIndex">
       <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.rebuildDataIndex}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.rebuildDataIndexTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.systemLog}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportLog">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.export} Data
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportData">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex">
        ${window.siyuan.languages.import} Data
    </div>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg> ${window.siyuan.languages.import}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.exportConf}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportConf">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.exportConfTip}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex">
        ${window.siyuan.languages.importConf}
    </div>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" style="position: relative">
        <input id="importConf" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg> ${window.siyuan.languages.import}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.importConfTip}</div>
</div>
<div class="b3-label${!window.siyuan.config.readonly&&(Je()||Rt()||ut())?"":" fn__none"}">
    ${window.siyuan.languages.workspaceList}
    <div class="fn__hr"></div>
    <button id="openWorkspace" class="b3-button b3-button--outline fn__block">${window.siyuan.languages.openBy}...</button>
    <div class="fn__hr"></div>
    <ul id="workspaceDir" class="b3-list b3-list--background"></ul>
    <div class="fn__hr"></div>
    <button id="creatWorkspace" class="b3-button fn__block">${window.siyuan.languages.new}</button>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.about13}
    <div class="fn__hr"></div>
    <div class="b3-form__icon">
        <input class="b3-text-field fn__block" id="token" style="padding-right: 64px;" value="${window.siyuan.config.api.token}">
        <button class="b3-button b3-button--text" id="tokenCopy" style="position: absolute;right: 0;height: 28px;">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copy}
        </button>
    </div>
    <div class="b3-label__text" id="tokenTip">${window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)}</div>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span class="fn__space"></span>
        <div>
            <span>${window.siyuan.languages.siyuanNote}</span>
            <span class="fn__space"></span>
            <span class="ft__on-surface">v${p.SIYUAN_VERSION}</span>
            <br>
            <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        </div>
    </div>
    <div style="color:var(--b3-theme-surface);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</div>
    ${window.siyuan.languages.about1} ${window.siyuan.config.system.container==="harmony"?" \u2022 "+window.siyuan.languages.feedback+" 845765@qq.com":""}
</div>
</div>`,bindEvent(e){const t=e.querySelector("#workspaceDir");fr(t);const n=e.querySelector("#importKey");e.firstElementChild.addEventListener("click",l=>{let r=l.target;for(;r&&r!==e;){if(r.id==="authCode"){Tf(),l.preventDefault(),l.stopPropagation();break}else if(r.id==="importKey"){const d=new ke({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea spellcheck="false" style="resize: vertical;"  class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"});d.element.setAttribute("data-key",p.DIALOG_PASSWORD);const c=d.element.querySelector("textarea");c.focus();const f=d.element.querySelectorAll(".b3-button");f[0].addEventListener("click",()=>{d.destroy()}),f[1].addEventListener("click",()=>{L("/api/repo/importRepoKey",{key:c.value},m=>{window.siyuan.config.repo.key=m.data.key,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none"),d.destroy()})}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="initKey"){Ne("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{L("/api/repo/initRepoKey",{},d=>{window.siyuan.config.repo.key=d.data.key,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")})}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="initKeyByPW"){Nu(!1,()=>{n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="copyKey"){se(window.siyuan.languages.copied),He(window.siyuan.config.repo.key),l.preventDefault(),l.stopPropagation();break}else if(r.id==="removeKey"){Ne("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{L("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,jn(),n.parentElement.classList.remove("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")})}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="purgeRepo"){Ne("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{L("/api/repo/purgeRepo")}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="tokenCopy"){se(window.siyuan.languages.copied),He(window.siyuan.config.api.token),l.preventDefault(),l.stopPropagation();break}else if(r.id==="exportData"){L("/api/export/exportData",{},d=>{Nt(d.data.zip)}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="exportConf"){L("/api/system/exportConf",{},d=>{Nt(d.data.zip)}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="vacuumDataIndex"){L("/api/system/vacuumDataIndex",{},()=>{}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="rebuildDataIndex"){L("/api/system/rebuildDataIndex",{},()=>{}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="exportLog"){L("/api/system/exportLog",{},d=>{Nt(d.data.zip)}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="openWorkspace"){L("/api/system/getMobileWorkspaces",{},d=>{let c="";d.data.forEach((u,g)=>{c+=`<option value="${u}"${g===0?' selected="selected"':""}>${_e().basename(u)}</option>`});const f=new ke({title:window.siyuan.languages.openBy,content:`<div class="b3-dialog__content">
    <select class="b3-text-field fn__block">${c}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"});f.element.setAttribute("data-key",p.SIYUAN_OPEN_WORKSPACE);const m=f.element.querySelectorAll(".b3-button");m[0].addEventListener("click",()=>{f.destroy()}),m[1].addEventListener("click",()=>{const u=f.element.querySelector("select").value;if(u===window.siyuan.config.system.workspaceDir){f.destroy();return}Ne(window.siyuan.languages.confirm,`${_e().basename(window.siyuan.config.system.workspaceDir)} -> ${_e().basename(u)}?`,()=>{L("/api/system/setWorkspaceDir",{path:u},()=>{za()})})})}),l.preventDefault(),l.stopPropagation();break}else if(r.id==="creatWorkspace"){const d=new ke({title:window.siyuan.languages.new,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"});d.element.setAttribute("data-key",p.DIALOG_CREATEWORKSPACE);const c=d.element.querySelector("input");c.focus();const f=d.element.querySelectorAll(".b3-button");f[0].addEventListener("click",()=>{d.destroy()}),f[1].addEventListener("click",()=>{L("/api/system/createWorkspaceDir",{path:_e().join(_e().dirname(window.siyuan.config.system.workspaceDir),c.value)},()=>{fr(t),d.destroy()})}),l.preventDefault(),l.stopPropagation();break}else if(r.getAttribute("data-type")==="remove"){const d=r.parentElement.getAttribute("data-path");L("/api/system/removeWorkspaceDir",{path:d},()=>{fr(t),Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeWorkspacePhysically.replace("${x}",d),()=>{L("/api/system/removeWorkspaceDirPhysically",{path:d})},void 0,!0)}),l.preventDefault(),l.stopPropagation();break}else if(r.classList.contains("b3-list-item")&&!r.classList.contains("b3-list-item--focus")){Ne(window.siyuan.languages.confirm,`${_e().basename(window.siyuan.config.system.workspaceDir)} -> ${_e().basename(r.getAttribute("data-path"))}?`,()=>{L("/api/system/setWorkspaceDir",{path:r.getAttribute("data-path")},()=>{za()})}),l.preventDefault(),l.stopPropagation();break}r=r.parentElement}}),e.querySelector("#importData").addEventListener("change",l=>{const r=new FormData;r.append("file",l.target.files[0]),L("/api/import/importData",r)}),e.querySelector("#importConf").addEventListener("change",l=>{const r=new FormData;r.append("file",l.target.files[0]),L("/api/system/importConf",r,d=>{if(d.code!==0){se(d.msg);return}za()})});const a=e.querySelector("#networkServe");a.addEventListener("change",()=>{L("/api/system/setNetworkServe",{networkServe:a.checked},()=>{za()})});const s=e.querySelector("#token");s.addEventListener("change",()=>{L("/api/system/setAPIToken",{token:s.value},()=>{window.siyuan.config.api.token=s.value,e.querySelector("#tokenTip").innerHTML=window.siyuan.languages.about14.replace("${token}",window.siyuan.config.api.token)})});const i=e.querySelector("#indexRetentionDays");i.addEventListener("change",()=>{L("/api/repo/setRepoIndexRetentionDays",{days:parseInt(i.value)},()=>{window.siyuan.config.repo.indexRetentionDays=parseInt(i.value)})});const o=e.querySelector("#retentionIndexesDaily");o.addEventListener("change",()=>{L("/api/repo/setRetentionIndexesDaily",{indexes:parseInt(o.value)},()=>{window.siyuan.config.repo.retentionIndexesDaily=parseInt(o.value)})})}})},fr=e=>{L("/api/system/getWorkspaces",{},t=>{let n="";t.data.forEach(a=>{n+=`<li data-path="${a.path}" class="b3-list-item b3-list-item--narrow${window.siyuan.config.system.workspaceDir===a.path?" b3-list-item--focus":""}">
    <span class="b3-list-item__text">${_e().basename(a.path)}</span>
    <span data-type="remove" class="b3-list-item__action">
        <svg><use xlink:href="#iconMin"></use></svg>
    </span>
</li>`}),e.innerHTML=n})},Bu=e=>{let t=parseInt(e.querySelector("#dynamicLoadBlocks").value);48>t&&(t=48,e.querySelector("#dynamicLoadBlocks").value="48"),1024<t&&(t=1024,e.querySelector("#dynamicLoadBlocks").value="1024"),window.siyuan.config.editor.markdown={inlineAsterisk:e.querySelector("#editorMarkdownInlineAsterisk").checked,inlineUnderscore:e.querySelector("#editorMarkdownInlineUnderscore").checked,inlineSup:e.querySelector("#editorMarkdownInlineSup").checked,inlineSub:e.querySelector("#editorMarkdownInlineSub").checked,inlineTag:e.querySelector("#editorMarkdownInlineTag").checked,inlineMath:e.querySelector("#editorMarkdownInlineMath").checked,inlineStrikethrough:e.querySelector("#editorMarkdownInlineStrikethrough").checked,inlineMark:e.querySelector("#editorMarkdownInlineMark").checked},window.siyuan.config.editor.allowHTMLBLockScript=e.querySelector("#allowHTMLBLockScript").checked,window.siyuan.config.editor.dynamicLoadBlocks=t,window.siyuan.config.editor.justify=e.querySelector("#justify").checked,window.siyuan.config.editor.rtl=e.querySelector("#rtl").checked,window.siyuan.config.editor.readOnly=e.querySelector("#readOnly").checked,window.siyuan.config.editor.displayBookmarkIcon=e.querySelector("#displayBookmarkIcon").checked,window.siyuan.config.editor.displayNetImgMark=e.querySelector("#displayNetImgMark").checked,window.siyuan.config.editor.codeSyntaxHighlightLineNum=e.querySelector("#codeSyntaxHighlightLineNum").checked,window.siyuan.config.editor.embedBlockBreadcrumb=e.querySelector("#embedBlockBreadcrumb").checked,window.siyuan.config.editor.headingEmbedMode=parseInt(e.querySelector("#headingEmbedMode").value),window.siyuan.config.editor.listLogicalOutdent=e.querySelector("#listLogicalOutdent").checked,window.siyuan.config.editor.listItemDotNumberClickFocus=e.querySelector("#listItemDotNumberClickFocus").checked,window.siyuan.config.editor.spellcheck=e.querySelector("#spellcheck").checked,window.siyuan.config.editor.onlySearchForDoc=e.querySelector("#onlySearchForDoc").checked,window.siyuan.config.editor.plantUMLServePath=e.querySelector("#plantUMLServePath").value,window.siyuan.config.editor.katexMacros=e.querySelector("#katexMacros").value,window.siyuan.config.editor.codeLineWrap=e.querySelector("#codeLineWrap").checked,window.siyuan.config.editor.virtualBlockRef=e.querySelector("#virtualBlockRef").checked,window.siyuan.config.editor.virtualBlockRefInclude=e.querySelector("#virtualBlockRefInclude").value,window.siyuan.config.editor.virtualBlockRefExclude=e.querySelector("#virtualBlockRefExclude").value,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen=parseInt(e.querySelector("#blockRefDynamicAnchorTextMaxLen").value),window.siyuan.config.editor.backlinkExpandCount=parseInt(e.querySelector("#backlinkExpandCount").value),window.siyuan.config.editor.backmentionExpandCount=parseInt(e.querySelector("#backmentionExpandCount").value),window.siyuan.config.editor.backlinkContainChildren=e.querySelector("#backlinkContainChildren").checked,window.siyuan.config.editor.codeLigatures=e.querySelector("#codeLigatures").checked,window.siyuan.config.editor.codeTabSpaces=parseInt(e.querySelector("#codeTabSpaces").value),window.siyuan.config.editor.fontSize=parseInt(e.querySelector("#fontSize").value),window.siyuan.config.editor.generateHistoryInterval=parseInt(e.querySelector("#generateHistoryInterval").value),window.siyuan.config.editor.historyRetentionDays=parseInt(e.querySelector("#historyRetentionDays").value),L("/api/setting/setEditor",window.siyuan.config.editor,n=>{window.siyuan.config.editor=n.data,la(window.siyuan.mobile.editor.protyle,!1),Wi()})},lb=()=>{let e="";for(let t=9;t<=72;t++)e+=`<option ${window.siyuan.config.editor.fontSize===t?"selected":""} value="${t}">${t}</option>`;nn({title:window.siyuan.languages.editor,icon:"iconEdit",html:`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly}
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.headingEmbedMode}
    <span class="fn__hr"></span>
    <select class="b3-select fn__block" id="headingEmbedMode">
      <option value="0" ${window.siyuan.config.editor.headingEmbedMode===0?"selected":""}>${window.siyuan.languages.showHeadingWithBlocks}</option>
      <option value="1" ${window.siyuan.config.editor.headingEmbedMode===1?"selected":""}>${window.siyuan.languages.showHeadingOnlyTitle}</option>
      <option value="2" ${window.siyuan.config.editor.headingEmbedMode===2?"selected":""}>${window.siyuan.languages.showHeadingOnlyBlocks}</option>
    </select>
    <div class="b3-label__text">${window.siyuan.languages.headingEmbedModeTip}</div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.listItemDotNumberClickFocus}
        <div class="b3-label__text">${window.siyuan.languages.listItemDotNumberClickFocusTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listItemDotNumberClickFocus" type="checkbox"${window.siyuan.config.editor.listItemDotNumberClickFocus?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.md9}
    <span class="fn__hr"></span>
    <textarea class="b3-text-field fn__block" id="virtualBlockRefInclude">${window.siyuan.config.editor.virtualBlockRefInclude}</textarea>
    <div class="b3-label__text">${window.siyuan.languages.md36}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md35}
    <span class="fn__hr"></span>
    <textarea class="b3-text-field fn__block" id="virtualBlockRefExclude">${window.siyuan.config.editor.virtualBlockRefExclude}</textarea>
    <div class="b3-label__text">${window.siyuan.languages.md36}</div>
    <div class="b3-label__text">${window.siyuan.languages.md41}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md39}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
    <div class="b3-label__text">${window.siyuan.languages.md40}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.dynamicLoadBlocks}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="dynamicLoadBlocks" type="number" min="48" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
    <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md37}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
    <div class="b3-label__text">${window.siyuan.languages.md38}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.backlinkExpand}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
    <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.backmentionExpand}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="backmentionExpandCount" type="number" min="-1" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
    <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkContainChildren}
        <div class="b3-label__text">${window.siyuan.languages.backlinkContainChildrenTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="backlinkContainChildren" type="checkbox"${window.siyuan.config.editor.backlinkContainChildren?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.generateHistory}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
    <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.historyRetentionDays} 
    <a href="javascript:void(0)" id="clearHistory">${window.siyuan.languages.clearHistory}</a>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="historyRetentionDays" type="number" min="1" max="3650" value="${window.siyuan.config.editor.historyRetentionDays}"/>
    <div class="b3-label__text">${window.siyuan.languages.historyRetentionDaysTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fontSize} 
    <span class="ft__on-surface">${window.siyuan.config.editor.fontSize}</span>
    <div class="fn__hr"></div>
    <select id="fontSize" class="b3-select fn__block">${e}</select>
    <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.md29} 
    <div class="fn__hr"></div>
    <select id="codeTabSpaces" class="b3-select fn__block">
        <option ${window.siyuan.config.editor.codeTabSpaces===0?"selected":""} value="0">0</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===2?"selected":""} value="2">2</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===4?"selected":""} value="4">4</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===6?"selected":""} value="6">6</option>
        <option ${window.siyuan.config.editor.codeTabSpaces===8?"selected":""} value="8">8</option>
    </select>
    <div class="b3-label__text">${window.siyuan.languages.md30}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.katexMacros}
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="katexMacros">${window.siyuan.config.editor.katexMacros}</textarea>
    <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.allowHTMLBLockScript}
        <div class="b3-label__text">${window.siyuan.languages.allowHTMLBLockScriptTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowHTMLBLockScript" type="checkbox"${window.siyuan.config.editor.allowHTMLBLockScript?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineAsterisk}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineAsteriskTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineAsterisk" type="checkbox"${window.siyuan.config.editor.markdown.inlineAsterisk?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineUnderscore}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineUnderscoreTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineUnderscore" type="checkbox"${window.siyuan.config.editor.markdown.inlineUnderscore?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineSup}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSupTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSup" type="checkbox"${window.siyuan.config.editor.markdown.inlineSup?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineSub}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineSubTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineSub" type="checkbox"${window.siyuan.config.editor.markdown.inlineSub?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineTag}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineTagTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineTag" type="checkbox"${window.siyuan.config.editor.markdown.inlineTag?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineMath}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMathTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMath" type="checkbox"${window.siyuan.config.editor.markdown.inlineMath?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineStrikethrough}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineStrikethroughTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineStrikethrough" type="checkbox"${window.siyuan.config.editor.markdown.inlineStrikethrough?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
       ${window.siyuan.languages.editorMarkdownInlineMark}
        <div class="b3-label__text">${window.siyuan.languages.editorMarkdownInlineMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="editorMarkdownInlineMark" type="checkbox"${window.siyuan.config.editor.markdown.inlineMark?" checked":""}/>
</label>`,bindEvent(t){t.querySelector("#clearHistory").addEventListener("click",()=>{Ne(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{L("/api/history/clearWorkspaceHistory",{})})}),t.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(n=>{n.addEventListener("change",()=>{Bu(t)})}),t.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(n=>{n.addEventListener("blur",()=>{Bu(t)})}),t.querySelectorAll("input.b3-slider").forEach(n=>{n.addEventListener("input",a=>{const s=a.target;s.previousElementSibling.previousElementSibling.textContent=s.value})})}})};class ob extends Ti{constructor(t){super({app:t.app,id:t.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.tab.headElement.classList.add("item--unupdate"),this.headElement=t.tab.headElement,this.element=t.tab.panelElement,this.initProtyle(t),L("/api/storage/updateRecentDocOpenTime",{rootID:t.rootId})}initProtyle(t){this.editor=new Gn(this.app,this.element,{action:t.action||[],blockId:t.blockId,rootId:t.rootId,mode:t.mode,render:{title:!0,background:!0,scroll:!0},typewriterMode:!0,after:n=>{window.siyuan.editorIsFullscreen&&(ro(n.protyle.element),Xc(n.protyle)),Yt([],n.protyle.block.rootID),t.afterInitProtyle&&t.afterInitProtyle(n)}}),this.editor.protyle.model=this}}const gr=e=>{document.getElementById("toolbarFile").dispatchEvent(new CustomEvent("click")),document.querySelector("#sidebar .toolbar--border").dispatchEvent(new CustomEvent("click",{detail:e}))},rb=e=>{window.siyuan.config.editor.readOnly=e,L("/api/setting/setEditor",window.siyuan.config.editor)},Uu=(e,t)=>{switch(e){case"fileTree":return gr("file"),!0;case"outline":case"bookmark":case"tag":case"inbox":return gr(e),!0;case"backlinks":return gr("backlink"),!0;case"mainMenu":return Ja(),!0;case"globalSearch":return Kt(t),!0;case"recentDocs":return Uo(t),!0}switch(e){case"dailyNote":return tu(t),!0;case"dataHistory":return Wo(t),!0;case"editReadonly":return rb(!window.siyuan.config.editor.readOnly),!0;case"lockScreen":return jo(t),!0;case"newFile":return ga({app:t,useSavePath:!0}),!0;case"riffCard":return Lu(t),!0;case"selectOpen1":return selectOpenTab(),!0;case"syncNow":return rr(t),!0}return!1};var db=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const cb=e=>{const t=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0,n=new ke({width:P()?"92vw":"80vw",height:P()?"80vh":"70vh",title:window.siyuan.languages.commandPanel,content:`<div class="fn__flex-column">
    <div class="b3-form__icon search__header" style="border-top: 0;border-bottom: 1px solid var(--b3-theme-surface-lighter);">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-text-field b3-text-field--text" style="padding-left: 32px !important;">
    </div>
    <ul class="b3-list b3-list--background search__list" id="commands"></ul>
    <div class="search__tip">
        <kbd>\u2191/\u2193</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${window.siyuan.languages.enterKey}/${window.siyuan.languages.click}</kbd> ${window.siyuan.languages.confirm}
        <kbd>Esc</kbd> ${window.siyuan.languages.close}
    </div>
</div>`,destroyCallback(){t&&X(t)}});n.element.setAttribute("data-key",p.DIALOG_COMMANDPANEL);const a=n.element.querySelector("#commands");let s="";if(Object.keys(window.siyuan.config.keymap.general).forEach(o=>{let l;l=["addToDatabase","fileTree","outline","bookmark","tag","dailyNote","inbox","backlinks","dataHistory","editReadonly","enter","enterBack","globalSearch","lockScreen","mainMenu","move","newFile","recentDocs","replace","riffCard","search","selectOpen1","syncNow"],l.includes(o)&&(s+=`<li class="b3-list-item" data-command="${o}">
    <span class="b3-list-item__text">${window.siyuan.languages[o]}</span>
    <span class="b3-list-item__meta${P()?" fn__none":""}">${je(window.siyuan.config.keymap.general[o].custom)}</span>
</li>`)}),Object.keys(window.siyuan.config.keymap.editor.general).forEach(o=>{["switchReadonly","switchAdjust"].includes(o)&&(s+=`<li class="b3-list-item" data-command="${o}">
    <span class="b3-list-item__text">${window.siyuan.languages[o]}</span>
    <span class="b3-list-item__meta${P()?" fn__none":""}">${je(window.siyuan.config.keymap.editor.general[o].custom)}</span>
</li>`)}),a.insertAdjacentHTML("beforeend",s),e.plugins.forEach(o=>{o.commands.forEach(l=>{const r=document.createElement("li");r.classList.add("b3-list-item"),r.innerHTML=`<span class="b3-list-item__text">${o.displayName}: ${l.langText||o.i18n[l.langKey]}</span>
<span class="b3-list-item__meta${P()?" fn__none":""}">${je(l.customHotkey)}</span>`,r.addEventListener("click",d=>{l.callback?l.callback():l.globalCallback&&l.globalCallback(),n.destroy(),d.preventDefault(),d.stopPropagation()}),a.insertAdjacentElement("beforeend",r)})}),a.childElementCount===0){const o=document.createElement("li");o.classList.add("b3-list-item","b3-list-item--focus"),o.innerHTML=`<span class="b3-list-item__text" style="-webkit-line-clamp: inherit;">${window.siyuan.languages._kernel[122]}</span>`,o.addEventListener("click",()=>{n.destroy()}),a.insertAdjacentElement("beforeend",o)}else a.firstElementChild.classList.add("b3-list-item--focus");const i=n.element.querySelector(".b3-text-field");i.focus(),a.addEventListener("click",o=>{const l=C(o.target,"b3-list-item");if(l){const r=l.getAttribute("data-command");r&&(pr({command:r,app:e,previousRange:t}),n.destroy(),o.preventDefault(),o.stopPropagation())}}),i.addEventListener("keydown",o=>{if(o.stopPropagation(),!o.isComposing)if(Vt(a,o),o.key==="Enter"){const l=a.querySelector(".b3-list-item--focus");if(l){const r=l.getAttribute("data-command");r?pr({command:r,app:e,previousRange:t}):l.dispatchEvent(new CustomEvent("click"))}n.destroy()}else o.key==="Escape"&&n.destroy()}),i.addEventListener("compositionend",()=>{Fu(i,a)}),i.addEventListener("input",o=>{o.isComposing||(o.stopPropagation(),Fu(i,a))})},Fu=(e,t)=>{var n;const a=e.value.toLowerCase();(n=t.querySelector(".b3-list-item--focus"))==null||n.classList.remove("b3-list-item--focus");let s=!1;Array.from(t.children).forEach(i=>{const o=i.querySelector(".b3-list-item__text").textContent.toLowerCase(),l=i.dataset.command;a.indexOf(o)>-1||o.indexOf(a)>-1||a.indexOf(l)>-1||(l==null?void 0:l.indexOf(a))>-1?(s||i.classList.add("b3-list-item--focus"),s=!0,i.classList.remove("fn__none")):i.classList.add("fn__none")})},pr=e=>db(void 0,null,function*(){var t,n,a;if(Uu(e.command,e.app))return;const s=(t=document.querySelector(".layout__tab--active"))==null?void 0:t.classList.contains("sy__file");let i=e.protyle;i||(i=Ft().protyle,e.previousRange=i.toolbar.range);const o=e.previousRange||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange());let l=e.fileLiElements;if(!s&&!i){o&&window.siyuan.dialogs.find(d=>{if(d.editors&&(Object.keys(d.editors).find(c=>{if(d.editors[c].protyle.element.contains(o.startContainer))return i=d.editors[c].protyle,!0}),i))return!0});const r=getActiveTab();if(!i&&r)r.model instanceof ob?i=r.model.editor.protyle:r.model instanceof Search?r.model.element.querySelector("#searchUnRefPanel").classList.contains("fn__none")?i=r.model.editors.edit.protyle:i=r.model.editors.unRefEdit.protyle:r.model instanceof Custom&&((n=r.model.editors)==null?void 0:n.length)>0&&o&&r.model.editors.find(d=>{if(d.protyle.element.contains(o.startContainer))return i=d.protyle,!0});else if(!i){!i&&o&&window.siyuan.blockPanels.find(c=>{if(c.editors.find(f=>{if(f.protyle.element.contains(o.startContainer))return i=f.protyle,!0}),i)return!0});const d=getAllModels();i||d.backlink.find(c=>{if(c.element.classList.contains("layout__tab--active"))return o&&c.editors.find(f=>{if(f.protyle.element.contains(o.startContainer))return i=f.protyle,!0}),!i&&c.editors.length>0&&(i=c.editors[0].protyle),!0}),i||d.editor.find(c=>{if(c.parent.headElement.classList.contains("item--focus"))return i=c.editor.protyle,!0})}}if(!(!s&&i&&Qo({command:e.command,previousRange:o,protyle:i}))){if(s&&!l){const r=getDockByType("file");if(!r)return!1;const d=r.data.file;l=Array.from(d.element.querySelectorAll(".b3-list-item--focus"))}if(!i&&!s||s&&(!l||l.length===0)||P()&&!document.getElementById("empty").classList.contains("fn__none")){e.command==="replace"?Kt(e.app,{hasReplace:!0,page:1}):e.command==="search"&&Kt(e.app,{hasReplace:!1,page:1});return}switch(e.command){case"replace":if(!s){const r=yield he("/api/filetree/getHPathByPath",{notebook:i.notebookId,path:i.path.endsWith(".sy")?i.path:i.path+".sy"});Kt(e.app,{page:1,hasReplace:!0,hPath:_e().join(en(i.notebookId),r.data),idPath:[_e().join(i.notebookId,i.path)]})}break;case"search":if(!s){const r=yield he("/api/filetree/getHPathByPath",{notebook:i.notebookId,path:i.path.endsWith(".sy")?i.path:i.path+".sy"});Kt(e.app,{page:1,hasReplace:!1,hPath:_e().join(en(i.notebookId),r.data),idPath:[_e().join(i.notebookId,i.path)]})}break;case"addToDatabase":s?ar(l):fl(i,o);break;case"move":if(s){const r=Rl(l);ca((d,c)=>{Bl(r,c[0],d[0])},r)}else{const r=F(o.startContainer);if((a=i.title)!=null&&a.editElement.contains(o.startContainer)||!r||window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TITLE)ca((d,c)=>{Bl([i.path],c[0],d[0])},[i.path],o);else if(r&&o&&i.element.contains(o.startContainer)){let d=Array.from(i.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));d.length===0&&(d=[r]),ca(c=>{Zo(c[0],d,i)})}}break}}}),ub=(e,t)=>{var n;const a=new Fe(p.MENU_BAR_PLUGIN);let s=!1;if(e.plugins.forEach(i=>{const o=i.setting||i.__proto__.hasOwnProperty("openSetting");let l=!1;for(let r=0;r<i.topBarIcons.length;r++){const d=i.topBarIcons[r];if(!document.contains(d)){i.topBarIcons.splice(r,1),r--;continue}const c=window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(d.id),f=[{id:c?"pin":"unpin",icon:c?"iconPin":"iconUnpin",label:c?window.siyuan.languages.pin:window.siyuan.languages.unpin,click(){c?(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].splice(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].indexOf(d.id),1),d.classList.remove("fn__none")):(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].push(d.id),window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN]=Array.from(new Set(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN])),d.classList.add("fn__none")),Te(p.LOCAL_PLUGINTOPUNPIN,window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN])}}];o&&f.push({id:"config",icon:"iconSettings",label:window.siyuan.languages.config,click(){i.openSetting()}});const m=t?d.getAttribute("aria-label"):d.textContent.trim();t||f.push({id:"play",icon:"iconPlay",label:m,click(){return d.dispatchEvent(new CustomEvent("click")),!0}});const u={id:d.id,icon:"iconInfo",label:m,click:t?()=>{d.dispatchEvent(new CustomEvent("click"))}:void 0,type:"submenu",submenu:f};if(d.querySelector("use"))u.icon=d.querySelector("use").getAttribute("xlink:href").replace("#","");else{const g=d.querySelector("svg").cloneNode(!0);g.classList.add("b3-menu__icon"),u.iconHTML=g.outerHTML}a.addItem(u),s=!0,l=!0}!l&&o&&(s=!0,a.addItem({id:i.name,icon:"iconSettings",label:i.displayName,click(){i.openSetting()}}))}),s||(t?(n=window.siyuan.menus.menu.element.querySelector(".b3-menu__separator"))==null||n.remove():a.addItem({id:"emptyContent",iconHTML:"",type:"readonly",label:window.siyuan.languages.emptyContent})),t){let i=t.getBoundingClientRect();i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),a.open({x:i.right,y:i.bottom,isLeft:!0})}else a.fullscreen()},vl=(e,t)=>{let n=`<option value="">${window.siyuan.languages.currentNotebook}</option>`;const a=[];return Object.keys(p.HELP_PATH).forEach(s=>{a.push(p.HELP_PATH[s])}),window.siyuan.notebooks.forEach(s=>{a.includes(s.id)||s.id===t||(n+=`<option value="${s.id}" ${e===s.id?"selected":""}>${pe(s.name)}</option>`)}),n},fb=e=>{const t=`<div class="fn__flex">${pe(e.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small fn__flex-center">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${vl(e.conf.docCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${vl(e.conf.refCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="">
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${e.conf.dailyNoteTemplatePath}">
</div></div>`;if(P())nn({title:t,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){Yu(document.querySelector("#model"),e)}});else{const a=new ke({width:"80vw",title:t,content:n});a.element.setAttribute("data-key",p.DIALOG_NOTEBOOKCONF),Yu(a.element,e)}},Yu=(e,t)=>{e.querySelector(".b3-button--small").addEventListener("click",()=>{He(t.box),se(window.siyuan.languages.copied)});const n=e.querySelector("#dailyNoteSavePath");n.value=t.conf.dailyNoteSavePath;const a=e.querySelector("#docCreateSavePath");a.value=t.conf.docCreateSavePath;const s=e.querySelector("#refCreateSavePath");s.value=t.conf.refCreateSavePath;const i=e.querySelector("#dailyNoteTemplatePath");i.value=t.conf.dailyNoteTemplatePath,e.querySelectorAll("input, select").forEach(o=>{o.addEventListener("change",()=>{L("/api/notebook/setNotebookConf",{notebook:t.box,conf:{refCreateSavePath:s.value,refCreateSaveBox:e.querySelector("#refCreateSaveBox").value,docCreateSaveBox:e.querySelector("#docCreateSaveBox").value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:i.value}})})})},gb=()=>{nn({title:window.siyuan.languages.fileTree,icon:"iconFiles",html:`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree18}
        <div class="b3-label__text">${window.siyuan.languages.fileTree19}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowCreateDeeper" type="checkbox"${window.siyuan.config.fileTree.allowCreateDeeper?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree3}
        <div class="b3-label__text">${window.siyuan.languages.fileTree4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="removeDocWithoutConfirm" type="checkbox"${window.siyuan.config.fileTree.removeDocWithoutConfirm?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree20}
        <div class="b3-label__text">${window.siyuan.languages.fileTree21}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="useSingleLineSave" type="checkbox"${window.siyuan.config.fileTree.useSingleLineSave?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree24}
        <div class="b3-label__text">${window.siyuan.languages.fileTree25}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="createDocAtTop" type="checkbox"${window.siyuan.config.fileTree.createDocAtTop?" checked":""}/>
</label>
<div class="b3-label">
    ${window.siyuan.languages.fileTree22}
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1" id="largeFileWarningSize" type="number" min="2" max="10240" value="${window.siyuan.config.fileTree.largeFileWarningSize}">
        <span class="fn__space"></span>
        <span class="ft__on-surface fn__flex-center">MB</span>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree23}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree16}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="maxListCount" type="number" min="1" max="10240" value="${window.siyuan.config.fileTree.maxListCount}">
    <div class="b3-label__text">${window.siyuan.languages.fileTree17}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree12}
    <span class="fn__hr"></span>
    <select class="b3-select fn__block" id="docCreateSaveBox">${vl(window.siyuan.config.fileTree.docCreateSaveBox)}</select>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="docCreateSavePath" value="">
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree5}
    <span class="fn__hr"></span>
    <select class="b3-select fn__block" id="refCreateSaveBox">${vl(window.siyuan.config.fileTree.refCreateSaveBox)}</select>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
</div>`,bindEvent(e){e.querySelector("#docCreateSavePath").value=window.siyuan.config.fileTree.docCreateSavePath,e.querySelector("#refCreateSavePath").value=window.siyuan.config.fileTree.refCreateSavePath,e.querySelectorAll("input, select").forEach(t=>{t.addEventListener("change",()=>{L("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:e.querySelector("#refCreateSavePath").value,refCreateSaveBox:e.querySelector("#refCreateSaveBox").value,docCreateSavePath:e.querySelector("#docCreateSavePath").value,docCreateSaveBox:e.querySelector("#docCreateSaveBox").value,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,closeTabsOnStart:window.siyuan.config.fileTree.closeTabsOnStart,allowCreateDeeper:e.querySelector("#allowCreateDeeper").checked,removeDocWithoutConfirm:e.querySelector("#removeDocWithoutConfirm").checked,useSingleLineSave:e.querySelector("#useSingleLineSave").checked,createDocAtTop:e.querySelector("#createDocAtTop").checked,largeFileWarningSize:parseInt(e.querySelector("#largeFileWarningSize").value),maxListCount:parseInt(e.querySelector("#maxListCount").value),maxOpenTabCount:window.siyuan.config.fileTree.maxOpenTabCount},n=>{window.siyuan.config.fileTree=n.data})})})}})},Ja=()=>{mn(),document.getElementById("menu").style.transform="translateX(0px)"},pb=e=>{const t=document.getElementById("menu");let n="";window.siyuan.user&&!window.siyuan.config.readonly?n=`<div class="b3-menu__item" id="menuAccount">
    <img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/>
    <span class="b3-menu__label">${window.siyuan.user.userName}</span>
</div>`:window.siyuan.config.readonly||(n=`<div class="b3-menu__item" id="menuAccount">
    <svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>
</div>`);let a=`<div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAI">
        <svg class="b3-menu__icon"><use xlink:href="#iconSparkles"></use></svg><span class="b3-menu__label">AI</span>
    </div>`;(vr()||Er("ai"))&&(a=""),t.innerHTML=`<div class="b3-menu__title">
    <svg class="b3-menu__icon"><use xlink:href="#iconLeft"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.back}</span>
</div>
<div class="b3-menu__items">
    ${n}
    <div id="menuRecent" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg><span class="b3-menu__label">${window.siyuan.languages.recentDocs}</span>
    </div>
    <div id="menuSearch" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconSearch"></use></svg><span class="b3-menu__label">${window.siyuan.languages.search}</span>
    </div>
    <div id="menuCommand" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconTerminal"></use></svg><span class="b3-menu__label">${window.siyuan.languages.commandPanel}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuSyncNow">
        <svg class="b3-menu__icon"><use xlink:href="#iconCloudSucc"></use></svg><span class="b3-menu__label">${window.siyuan.languages.syncNow}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuNewDoc">
        <svg class="b3-menu__icon"><use xlink:href="#iconFile"></use></svg><span class="b3-menu__label">${window.siyuan.languages.newFile}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuNewNotebook">
        <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg><span class="b3-menu__label">${window.siyuan.languages.newNotebook}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div id="menuNewDaily" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconCalendar"></use></svg><span class="b3-menu__label">${window.siyuan.languages.dailyNote}</span>
    </div>
    <div id="menuCard" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-menu__label">${window.siyuan.languages.spaceRepetition}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuLock">
        <svg class="b3-menu__icon"><use xlink:href="#iconLock"></use></svg><span class="b3-menu__label">${window.siyuan.languages.lockScreen}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuHistory">
        <svg class="b3-menu__icon"><use xlink:href="#iconHistory"></use></svg><span class="b3-menu__label">${window.siyuan.languages.dataHistory}</span>
    </div>
    <div class="b3-menu__separator${Je()||Rt()||ut()?"":" fn__none"}"></div>
    <div class="b3-menu__item b3-menu__item--warning${Je()||Rt()||ut()?"":" fn__none"}" id="menuSafeQuit">
        <svg class="b3-menu__icon"><use xlink:href="#iconQuit"></use></svg><span class="b3-menu__label">${window.siyuan.languages.safeQuit}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuEditor">
        <svg class="b3-menu__icon"><use xlink:href="#iconEdit"></use></svg><span class="b3-menu__label">${window.siyuan.languages.editor}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuFileTree">
        <svg class="b3-menu__icon"><use xlink:href="#iconFiles"></use></svg><span class="b3-menu__label">${window.siyuan.languages.fileTree}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuRiffCard">
        <svg class="b3-menu__icon"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-menu__label">${window.siyuan.languages.riffCard}</span>
    </div>
    ${a}
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAssets">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg><span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAppearance">
        <svg class="b3-menu__icon"><use xlink:href="#iconTheme"></use></svg><span class="b3-menu__label">${window.siyuan.languages.appearance}</span>
    </div>
    <div id="menuSync" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconCloud"></use></svg><span class="b3-menu__label">${window.siyuan.languages.cloud}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuPublish">
        <svg class="b3-menu__icon"><use xlink:href="#iconLanguage"></use></svg><span class="b3-menu__label">${window.siyuan.languages.publish}</span>
    </div>
    <div class="b3-menu__item" id="menuAbout">
        <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg><span class="b3-menu__label">${window.siyuan.languages.about}</span>
    </div>
    <div class="b3-menu__item" id="menuPlugin">
        <svg class="b3-menu__icon"><use xlink:href="#iconPlugin"></use></svg><span class="b3-menu__label">${window.siyuan.languages.plugin}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div class="b3-menu__item${_a()||window.siyuan.config.readonly?" fn__none":""}" id="menuHelp">
        <svg class="b3-menu__icon"><use xlink:href="#iconHelp"></use></svg><span class="b3-menu__label">${window.siyuan.languages.userGuide}</span>
    </div>
    <a class="b3-menu__item" href="${window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?"https://ld246.com/article/1649901726096":"https://liuyun.io/article/1686530886208"}" target="_blank">
        <svg class="b3-menu__icon"><use xlink:href="#iconFeedback"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.feedback}</span>
    </a>
</div>`,jn(),e.plugins.forEach(s=>{mr(s)}),t.addEventListener("click",s=>{let i=s.target;for(;i&&!i.isEqualNode(t);){if(i.classList.contains("b3-menu__title")){nt(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuCommand"){nt(),cb(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSearch"){Kt(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuRecent"){Uo(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAppearance"){Km(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAssets"){Zm(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAI"){Jm(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuRiffCard"){Qm(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuEditor"){lb(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuFileTree"){gb(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSafeQuit"){s.preventDefault(),s.stopPropagation(),za();break}else if(i.id==="menuAbout"){sb(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuPlugin"){ub(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuNewDaily"){tu(e),nt(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuCard"){Lu(e),nt(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuNewNotebook"){Bo(),nt(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuNewDoc"){ga({app:e,useSavePath:!0}),nt(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuHelp"){Ro(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuLock"){jo(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSync"){nn({title:window.siyuan.languages.cloud,icon:"iconCloud",html:St.genHTML(),bindEvent(o){St.element=o,St.bindEvent()}}),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuPublish"){nn({title:window.siyuan.languages.publish,icon:"iconLanguage",html:kt.genHTML(),bindEvent(o){kt.element=o,kt.bindEvent()}}),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuSyncNow"){rr(),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuHistory"){Wo(e),s.preventDefault(),s.stopPropagation();break}else if(i.id==="menuAccount"){if(s.preventDefault(),s.stopPropagation(),document.querySelector("#menuAccount img")){Pu();return}ib();break}i=i.parentElement}})},yy=(e,t,n)=>{switch(e){case"filetree":t.innerHTML=fileTree.genHTML(),fileTree.element=t,fileTree.bindEvent();break;case"AI":t.innerHTML=ai.genHTML(),ai.element=t,ai.bindEvent();break;case"card":t.innerHTML=flashcard.genHTML(),flashcard.element=t,flashcard.bindEvent();break;case"image":t.innerHTML=image.genHTML(),image.element=t,image.bindEvent();break;case"export":t.innerHTML=exportConfig.genHTML(),exportConfig.element=t,exportConfig.bindEvent();break;case"appearance":t.innerHTML=appearance.genHTML(),appearance.element=t,appearance.bindEvent();break;case"keymap":t.innerHTML=keymap.genHTML(n),keymap.element=t,keymap.bindEvent(n);break;case"bazaar":bazaar.element=t,t.innerHTML=bazaar.genHTML(),bazaar.bindEvent(n);break;case"account":t.innerHTML=account.genHTML(),account.element=t,account.bindEvent(account.element);break;case"repos":t.innerHTML=repos.genHTML(),repos.element=t,repos.bindEvent();break;case"about":t.innerHTML=about.genHTML(),about.element=t,about.bindEvent();break;case"search":t.innerHTML=query.genHTML(),query.element=t,query.bindEvent();break;case"publish":t.innerHTML=publish.genHTML(),publish.element=t,publish.bindEvent();break;default:break}},mb=e=>{Ja()};var bb=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});let Wu,Vu;Wu=()=>{},Vu=()=>{};const ju=e=>window.siyuan.mobile.docks[e],yb={adaptHotkey:je,confirm:Ne,Constants:p,showMessage:se,hideMessage:tt,fetchPost:L,fetchSyncPost:he,fetchGet:ou,getFrontend:be,getBackend:me,getModelByDockType:ju,openTab:Wu,openWindow:Vu,openMobileFileById:ft,lockScreen:jo,exitSiYuan:za,Protyle:Gn,Plugin:Du,Dialog:ke,Menu:Fe,Setting:Gm,getAllEditor:wa,getActiveEditor:(e=!0)=>{let t;if(t=window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,!(t!=null&&t.protyle.element.classList.contains("fn__none")))return t},platformUtils:it,openSetting:mb,openAttributePanel:e=>{e.data?vn(e.data,e.focusName,e.protyle):ta(e.nodeElement,e.focusName,e.protyle)},saveLayout:e=>{if(window.siyuan.mobile.editor){const t=Ei(window.siyuan.mobile.editor.protyle);e&&t instanceof Promise&&t.then(()=>{e()})}},globalCommand:Uu,expandDocTree:e=>bb(void 0,null,function*(){var t;let n=!1;window.siyuan.notebooks.find(l=>{if(e.id===l.id)return n=!0,!0});let a,s=e.id;const i=ju("file");if(typeof e.isSetCurrent=="undefined"&&(e.isSetCurrent=!0),n)a=(t=i.element.querySelector(`.b3-list[data-url="${e.id}"]`))==null?void 0:t.firstElementChild;else{const l=yield he("api/block/getBlockInfo",{id:e.id});if(l.code===-1)return;s=l.data.box,a=yield i.selectItem(l.data.box,l.data.path,void 0,void 0,e.isSetCurrent)}!a||((e.isSetCurrent||typeof e.isSetCurrent=="undefined")&&i.setCurrent(a),a.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open"))||i.getLeaf(a,s)})},Gu=(e,t,n)=>{e.plugins.find((a,s)=>{var i,o;if(a.name===t){try{a.onunload()}catch(r){console.error(`plugin ${a.name} onunload error:`,r)}if(n){try{a.uninstall()}catch(r){console.error(`plugin ${a.name} uninstall error:`,r)}window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS][a.name]={},Te(p.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[p.LOCAL_PLUGIN_DOCKS])}for(let r=0;r<a.topBarIcons.length;r++)a.topBarIcons[r].remove(),a.topBarIcons.splice(r,1),r--;return Object.keys(a.docks).forEach(r=>{Object.keys(window.siyuan.layout.leftDock.data).includes(r)?window.siyuan.layout.leftDock.remove(r):Object.keys(window.siyuan.layout.rightDock.data).includes(r)?window.siyuan.layout.rightDock.remove(r):Object.keys(window.siyuan.layout.bottomDock.data).includes(r)&&window.siyuan.layout.bottomDock.remove(r)}),Array.from(document.childNodes).find(r=>{if(r.nodeType===8&&r.textContent===t)return r.remove(),!0}),e.plugins.splice(s,1),(i=document.querySelector(`svg[data-name="${a.name}"]`))==null||i.remove(),wa().forEach(r=>{r.protyle.toolbar.update(r.protyle)}),(o=document.getElementById("pluginsStyle"+t))==null||o.remove(),!0}})};var El=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const zu=e=>{var t,n;return(n={siyuan:yb}[e])!=null?n:(t=window.require)==null?void 0:t.call(window,e)};window.require instanceof Function&&(zu.__proto__=window.require);const wb=(e,t)=>window.eval("(function anonymous(require, module, exports){".concat(e,`
})
//# sourceURL=`).concat(t,`
`)),Ku=(e,t)=>El(void 0,null,function*(){const n=yield he("/api/petal/loadPetals",{frontend:be()});let a='<style id="pluginsStyle"></style>';n.data.forEach(i=>{(!t||t&&t.includes(i.name))&&Zu(e,i),i.css&&(a+=`<style id="pluginsStyle${i.name}">${i.css}</style>`)});const s=document.getElementById("pluginsStyle");s?s.insertAdjacentHTML("afterend",a):document.head.insertAdjacentHTML("beforeend",a)}),Zu=(e,t)=>El(void 0,null,function*(){const n={},a={exports:n};try{wb(t.js,"plugin:"+encodeURIComponent(t.name))(zu,a,n)}catch(o){console.error(`plugin ${t.name} run error:`,o);return}const s=(a.exports||n).default||a.exports;if(typeof s!="function"){console.error(`plugin ${t.name} has no export`);return}if(!(s.prototype instanceof Du)){console.error(`plugin ${t.name} does not extends Plugin`);return}const i=new s({app:e,displayName:t.displayName,name:t.name,i18n:t.i18n});e.plugins.push(i);try{yield i.onload()}catch(o){console.error(`plugin ${t.name} onload error:`,o)}return i}),Ey=(e,t)=>El(void 0,null,function*(){const n=yield Zu(e,t);if(t.css){const a=document.createElement("style");a.id="pluginsStyle"+t.name,a.textContent=t.css,document.head.append(a)}return mr(n),saveLayout(),getAllEditor().forEach(a=>{a.protyle.toolbar.update(a.protyle)}),n}),ky=(e,t,n,a)=>{const s=Object.keys(n.docks);e.forEach((i,o)=>{s.includes(i.type)&&(a==="Left"?n.docks[i.type].config.position=t===0?"LeftTop":"LeftBottom":a==="Right"?n.docks[i.type].config.position=t===0?"RightTop":"RightBottom":a==="Bottom"&&(n.docks[i.type].config.position=t===0?"BottomLeft":"BottomRight"),n.docks[i.type].config.index=o,n.docks[i.type].config.show=i.show,n.docks[i.type].config.size=i.size,window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS][n.name]||(window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS][n.name]={}),window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS][n.name][i.type]=n.docks[i.type].config,setStorageVal(Constants.LOCAL_PLUGIN_DOCKS,window.siyuan.storage[Constants.LOCAL_PLUGIN_DOCKS]))})},mr=e=>{try{e.onLayoutReady()}catch(t){console.error(`plugin ${e.name} onLayoutReady error:`,t)}(!re()||P())&&e.topBarIcons.forEach(t=>{document.contains(t)||(P()?window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(t.id)||document.querySelector("#menuAbout").after(t):re()||(window.siyuan.storage[p.LOCAL_PLUGINTOPUNPIN].includes(t.id)&&t.classList.add("fn__none"),document.querySelector("#"+(t.getAttribute("data-location")==="right"?"barPlugins":"drag")).before(t)))}),re()},_b=(e,t)=>El(void 0,null,function*(){t.removePlugins.forEach(n=>{Gu(e,n,!0)}),t.upsertPlugins.forEach(n=>{Gu(e,n,!1)}),Ku(e,t.upsertPlugins).then(()=>{e.plugins.forEach(n=>{t.upsertPlugins.includes(n.name)&&mr(n)})})}),hb=(e,t)=>{var n;if(t)switch(t.cmd){case"setDefRefCount":im(t.data);break;case"reloadTag":(n=window.siyuan.mobile.docks.tag)==null||n.update();break;case"setLocalShorthandCount":Cf();break;case"setRefDynamicText":am(t.data);break;case"reloadPlugin":_b(e,t.data);break;case"reloadEmojiConf":wf();break;case"syncMergeResult":Vo(e,t.data);break;case"setConf":window.siyuan.config=t.data,$r();break;case"reloaddoc":Vo(void 0,{upsertRootIDs:[t.data],removeRootIDs:[]},!1,!1,!0);break;case"readonly":window.siyuan.config.editor.readOnly=t.data;break;case"progress":Go(t);break;case"syncing":jn(t,e.plugins),t.code===1&&document.getElementById("toolbarSync").classList.add("fn__none");break;case"openFileById":ft(e,t.data.id);break;case"txerr":lm();break;case"statusbar":om(t);break}};class vb{constructor(t){this.menu=new Pf}getDir(t){const n=le(t,"UL");if(n)return n.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}var Xu=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});const Ju=(e,t)=>{if(window.siyuan.menus.menu.element.setAttribute("data-from",p.MENU_FROM_DOC_TREE_MORE_ITEMS),!Array.from(e).find(s=>{if(s.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;const a=[];if(e.forEach(s=>{const i=s.getAttribute("data-node-id");i&&a.push(i)}),a.length>0&&window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:oi(a).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){a.forEach(s=>{L("/api/filetree/duplicateDoc",{id:s})})}}])}).element),window.siyuan.menus.menu.append(to(Rl(Array.from(e)))),a.length>0&&window.siyuan.menus.menu.append(new H({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{ar(Array.from(e))}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{ir(Array.from(e))}}).element),a.length===0)return window.siyuan.menus.menu;if(window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){const s=[{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{B(void 0,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{B(void 0,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:a}])}}];window.siyuan.config.flashcard.deck&&s.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{ys(t,a)}}),window.siyuan.menus.menu.append(new H({id:"riffCard",label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:s}).element),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element)}return Pd(t,a),window.siyuan.menus.menu.append(new H({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const s=se(window.siyuan.languages.exporting,-1);L(" /api/export/exportMds",{ids:a},i=>{tt(s),Nt(i.data.zip)})}}]}).element),t.plugins&&tn({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:e,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},Qu=(e,t)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_DOC_TREE_MORE);const n=U(t,"DIV");if(!n)return window.siyuan.menus.menu;t.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(o=>{o.classList.remove("b3-list-item--focus"),o.removeAttribute("select-end"),o.removeAttribute("select-start")}),t.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return Ju(a,e);window.siyuan.menus.menu.element.setAttribute("data-from",p.MENU_FROM_DOC_TREE_MORE_NOTEBOOK);const s=t.parentElement.getAttribute("data-url"),i=en(s);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(Ld({path:"/",notebookId:s,name:i,type:"notebook"})),window.siyuan.menus.menu.append(new H({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{L("/api/notebook/getNotebookConf",{notebook:s},l=>{fb(l.data)})}}).element);const o=nf("notebook",parseInt(t.parentElement.getAttribute("data-sortmode")),l=>(L("/api/notebook/setNotebookConf",{notebook:s,conf:{sortMode:l}},()=>{var r;t.parentElement.setAttribute("data-sortmode",l.toString());let d;d=window.siyuan.mobile.docks.file;const c=t.querySelector(".b3-list-item__arrow--open");c&&(c.classList.remove("b3-list-item__arrow--open"),(r=t.nextElementSibling)==null||r.remove(),d.getLeaf(t,s))}),!0));window.siyuan.menus.menu.append(new H({id:"sort",icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element)}return window.siyuan.config.readonly||window.siyuan.menus.menu.append(new H({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{L("/api/riff/getNotebookRiffDueCards",{notebook:s},o=>{bl(e,o.data,"notebook",s,i)}),nt()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{ms(e,s,i,"Notebook"),nt()}}]}).element),window.siyuan.menus.menu.append(new H({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){Kt(e,{hasReplace:!1,hPath:en(s),idPath:[s],page:1})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new H({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){Kt(e,{hasReplace:!0,hPath:en(s),idPath:[s],page:1})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"close",label:window.siyuan.languages.close,icon:"iconClose",click:()=>{L("/api/notebook/closeNotebook",{notebook:s})}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{ir(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),tf(s,"/"),window.siyuan.menus.menu.append(new H({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const o=se(window.siyuan.languages.exporting,-1);L("/api/export/exportNotebookSY",{id:s},l=>{tt(o),Nt(l.data.zip)})}},{id:"exportMarkdown",label:"Markdown .zip",icon:"iconMarkdown",click:()=>{const o=se(window.siyuan.languages.exporting,-1);L("/api/export/exportNotebookMd",{notebook:s},l=>{tt(o),Nt(l.data.zip)})}}]}).element),e.plugins&&tn({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},ef=(e,t,n,a)=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_DOC_TREE_MORE);const s=U(a,"DIV");if(!s)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(s.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const i=s.querySelectorAll(".b3-list-item--focus");if(i.length>1)return Ju(i,e);const o=a.getAttribute("data-node-id");let l=a.getAttribute("data-name");if(l=vt(l,!1,!0),!window.siyuan.config.readonly){let r,d;const c=le(a,"UL");if((window.siyuan.config.fileTree.sort===6||c&&c.dataset.sortmode==="6")&&(window.siyuan.menus.menu.append(new H({id:"newDocAbove",icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const f=[];Array.from(a.parentElement.children).forEach(m=>{m.tagName==="LI"&&(m===a&&f.push(void 0),f.push(m.getAttribute("data-path")))}),ga({app:e,notebookId:t,currentPath:_e().dirname(n),paths:f,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new H({id:"newDocBelow",icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const f=[];Array.from(a.parentElement.children).forEach(m=>{m.tagName==="LI"&&(f.push(m.getAttribute("data-path")),m===a&&f.push(void 0))}),ga({app:e,notebookId:t,currentPath:_e().dirname(n),paths:f,useSavePath:!1,listDocTree:!0})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:oi([o]).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){L("/api/filetree/duplicateDoc",{id:o})}}])}).element),window.siyuan.menus.menu.append(to(Rl(Array.from(s.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new H({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{ar([a])}}).element),window.siyuan.menus.menu.append(new H({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{ir(Array.from(s.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(Ld({path:n,notebookId:t,name:l,type:"file"})),window.siyuan.menus.menu.append(new H({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",click(){L("/api/block/getDocInfo",{id:o},f=>{vn(f.data.ial)})}}).element),!window.siyuan.config.readonly){const f=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{L("/api/riff/getTreeRiffDueCards",{rootID:o},m=>{bl(e,m.data,"doc",o,l)}),nt()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{L("/api/filetree/getHPathByID",{id:o},m=>{ms(e,o,_e().join(en(t),m.data),"Tree")}),nt()}},{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{B(void 0,[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[o]}],[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[o]}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{B(void 0,[{action:"removeFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[o]}],[{action:"addFlashcards",deckID:p.QUICK_DECK_ID,blockIDs:[o]}])}}];window.siyuan.config.flashcard.deck&&f.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{ys(e,[o])}}),window.siyuan.menus.menu.append(new H({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:f}).element)}window.siyuan.menus.menu.append(new H({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Xu(this,null,function*(){const f=vt(n,!1,!0),m=yield he("/api/filetree/getHPathByPath",{notebook:t,path:f+".sy"});Kt(e,{hasReplace:!1,hPath:_e().join(en(t),m.data),idPath:[_e().join(t,f)],page:1})})}}).element),window.siyuan.menus.menu.append(new H({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return Xu(this,null,function*(){const f=vt(n,!1,!0),m=yield he("/api/filetree/getHPathByPath",{notebook:t,path:f+".sy"});Kt(e,{hasReplace:!0,hPath:_e().join(en(t),m.data),idPath:[_e().join(t,f)],page:1})})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_3",type:"separator"}).element)}return Pd(e,[o],t,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new H({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Cu({app:e,id:o,notebookId:t,pathString:l})}}).element),tf(t,n),window.siyuan.menus.menu.append(Ad(o)),e.plugins&&tn({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:i,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu.element.setAttribute("data-from",p.MENU_FROM_DOC_TREE_MORE_DOC),window.siyuan.menus.menu},tf=(e,t)=>{if(window.siyuan.config.readonly)return;const n=()=>{let a;a=window.siyuan.mobile.docks.file;const s=a.element.querySelector(`[data-path="${t}"]`);s.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),a.getLeaf(s,e,!0),window.siyuan.menus.menu.remove()};window.siyuan.menus.menu.append(new H({id:"import",icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{id:"importSiYuanZip",icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",s=>{const i=new FormData;i.append("file",s.target.files[0]),i.append("notebook",e),i.append("toPath",t),L("/api/import/importSY",i,()=>{n()})})}},{id:"importMarkdownZip",icon:"iconMarkdown",label:'Markdown .zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",s=>{const i=new FormData;i.append("file",s.target.files[0]),i.append("notebook",e),i.append("toPath",t),L("/api/import/importZipMd",i,()=>{n()})})}}]}).element)},nf=(e,t,n)=>{const a=[{id:"fileNameASC",icon:t===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{id:"fileNameDESC",icon:t===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{id:"fileNameNatASC",icon:t===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{id:"fileNameNatDESC",icon:t===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{id:"separator_1",type:"separator"},{id:"createdASC",icon:t===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{id:"createdDESC",icon:t===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{id:"modifiedASC",icon:t===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{id:"modifiedDESC",icon:t===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{id:"separator_2",type:"separator"},{id:"refCountASC",icon:t===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{id:"refCountDESC",icon:t===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{id:"separator_3",type:"separator"},{id:"docSizeASC",icon:t===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{id:"docSizeDESC",icon:t===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{id:"separator_4",type:"separator"},{id:"subDocCountASC",icon:t===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{id:"subDocCountDESC",icon:t===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{id:"separator_5",type:"separator"},{id:"customSort",icon:t===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return e==="notebook"&&a.push({id:"sortByFiletree",icon:t===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a},Eb=e=>{var t;const n=e.target,a=C(n,"protyle-background");if(a&&n.tagName==="IMG"&&a.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none")){const s=C(n,"protyle-content",!0);if(!s)return!1;s.style.overflow="hidden";const i=e.touches[0].clientY,o=n.naturalHeight*n.clientWidth/n.naturalWidth-n.clientHeight;let l=parseFloat(n.style.objectPosition.substring(7))||50;n.style.objectPosition.endsWith("px")&&(l=-parseInt(n.style.objectPosition.substring(7))/o*100);const r=document;return r.ontouchmove=d=>{n.style.objectPosition=`center ${((i-d.touches[0].clientY)/o*100+l).toFixed(2)}%`},r.ontouchend=()=>{s.style.overflow="",r.ontouchmove=null,r.ontouchstart=null,r.ondragstart=null,r.onselectstart=null,r.onselect=null},e.stopImmediatePropagation(),!0}return a?a.classList.contains("protyle-background--enable")&&a.classList.add("protyle-background--mobileshow"):(t=document.querySelector(".protyle-background--mobileshow"))==null||t.classList.remove("protyle-background--mobileshow"),!1},kb=(e,t,n,a)=>{const s=e.target,i=Ri();if(typeof t=="undefined"&&new Date().getTime()-n>900){const o=O(s,"data-type","navigation-root")||O(s,"data-type","navigation-file");if(o){if(!window.siyuan.config.readonly&&o.dataset.type==="navigation-root"){const l=Qu(a,o);if(i){const r=o.getBoundingClientRect();l.popup({x:r.right-52,y:r.bottom,h:r.height}),xn()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(o.dataset.type==="navigation-file"){const l=le(o,"UL");if(l){const r=ef(a,l.dataset.url,o.dataset.path,o);if(i){const d=o.getBoundingClientRect();r.popup({x:d.right-52,y:d.bottom,h:d.height}),xn()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(s.tagName==="SPAN"&&!de(s)){let l;if(C(s,"protyle-wysiwyg",!0)&&(l=Ft()),!l)return!1;const r=(s.getAttribute("data-type")||"").split(" ");if(r.includes("inline-memo")&&l.protyle.toolbar.showRender(l.protyle,s),l.protyle.disabled)return e.stopImmediatePropagation(),e.preventDefault(),!0;if(r.includes("block-ref"))return yo(l.protyle,s),!0;if(r.includes("file-annotation-ref"))return bo(l.protyle,s),!0;if(r.includes("tag"))return ho(l.protyle,s),!0;if(r.includes("a"))return ri(l.protyle,s),!0;const d=O(s,"data-type","inline-math");if(d)return zs(l.protyle,d),!0}}return!1};let vs,Es,Tt,$a,kl,zn,Qa,Dn,Sl,Al=!0;const Ll=(e=!0)=>{e?document.getElementById("toolbarFile").dispatchEvent(new CustomEvent("click")):(mn(),document.getElementById("sidebar").style.transform="translateX(0px)")},Sb=(e,t)=>{if(_a()&&kb(e,$a,kl,t)){e.stopImmediatePropagation(),e.preventDefault();return}Al=!0;const n=e.target;if(!Es||typeof $a=="undefined"||n.tagName==="AUDIO"||C(n,"b3-dialog",!0)||window.siyuan.mobile.editor&&!window.siyuan.mobile.editor.protyle.toolbar.subElement.classList.contains("fn__none")||C(n,"viewer-container")||C(n,"keyboard")||O(n,"id","commonMenu"))return;if(window.siyuan.mobile.editor&&(window.siyuan.mobile.editor.protyle.contentElement.style.overflow=""),vs=null,Sl){nt();return}let a=!1;(new Date().getTime()-kl<1e3||Math.abs(Tt)>window.innerWidth/3)&&(a=!0);const s=Math.abs(Tt)>Math.abs($a);if(O(n,"id","model",!0)){s&&zn==="toRight"&&!Dn&&so();return}if(O(n,"id","menu")){s?zn==="toRight"?Dn?Ja():nt():Dn?nt():Ja():Ja();return}if(O(n,"id","sidebar")){s?zn==="toLeft"?Dn?Ll(!1):nt():Dn?nt():Ll(!1):Ll(!1);return}if(!a||!s){nt();return}Tt>0?Dn?nt():Ja():Dn?nt():Ll()},Ab=e=>{if(0<e.touches.length&&(e.touches[0].target.tagName==="VIDEO"||e.touches[0].target.tagName==="AUDIO")){mn();return}Eb(e)||(zn=null,Tt=void 0,$a=void 0,Dn=void 0,Qa=void 0,_a()||e.touches[0].clientX>8&&e.touches[0].clientX<window.innerWidth-8?(vs=e.touches[0].clientX,Es=e.touches[0].clientY,kl=new Date().getTime()):(vs=null,Es=null,kl=0,e.stopImmediatePropagation()),Al=!0,Sl=!1)};let xl;const br=document.querySelector(".side-mask"),Lb=e=>{const t=e.target;if(!(!vs||!Es||t.tagName==="AUDIO"||C(t,"b3-dialog",!0)||window.siyuan.mobile.editor&&!window.siyuan.mobile.editor.protyle.toolbar.subElement.classList.contains("fn__none")||C(t,"keyboard")||C(t,"viewer-container")||O(t,"id","commonMenu")||Qa==="y")&&document.querySelector("#keyboardToolbar").classList.contains("fn__none")){if(getSelection().rangeCount>0){const n=getSelection().getRangeAt(0);if(n.toString()!==""&&window.siyuan.mobile.editor.protyle.wysiwyg.element.contains(n.startContainer))return}if(Tt=Math.floor(vs-e.touches[0].clientX),$a=Math.floor(Es-e.touches[0].clientY),zn||(zn=Tt>0?"toLeft":"toRight"),Qa||(Math.abs(Tt)>Math.abs($a)?Qa="x":Qa="y",Qa==="x"&&(O(t,"id","menu")&&zn==="toLeft"||O(t,"id","sidebar")&&zn==="toRight")&&(Qa="y",$a=void 0)),xl&&(zn==="toRight"?xl>e.touches[0].clientX?Dn=e.touches[0].clientX:Dn=void 0:zn==="toLeft"&&(xl<e.touches[0].clientX?Dn=e.touches[0].clientX:Dn=void 0)),xl=e.touches[0].clientX,Math.abs(Tt)>Math.abs($a)){if(O(t,"id","model",!0))return;let n=O(t,"data-type","NodeCodeBlock")||O(t,"data-type","NodeAttributeView")||O(t,"data-type","NodeMathBlock")||O(t,"data-type","NodeTable")||ue(t,"list")||ue(t,"protyle-breadcrumb__bar--nowrap");if(n){if(n.classList.contains("table"))n=n.firstElementChild;else if(n.classList.contains("code-block"))n=n.firstElementChild.nextElementSibling;else if(n.classList.contains("av"))n=C(t,"layout-tab-bar")||C(t,"av__scroll");else if(n.dataset.type==="NodeMathBlock")for(n=t;n&&n.dataset.type!=="NodeMathBlock"&&!(n.nodeType===1&&n.scrollLeft>0);)n=n.parentElement;let o=!1;if(n&&n.scrollLeft===0&&(n.scrollLeft=1,n.scrollLeft===0?o=!0:n.scrollLeft=0),!o&&n&&(Tt<0&&n.scrollLeft>0||Tt>0&&n.clientWidth+n.scrollLeft<n.scrollWidth)){Sl=!0;return}if(Sl)return}Al&&(br.style.zIndex=(++window.siyuan.zIndex).toString(),document.getElementById("sidebar").style.zIndex=(++window.siyuan.zIndex).toString(),document.getElementById("menu").style.zIndex=(++window.siyuan.zIndex).toString(),Al=!1);const a=window.innerWidth,s=O(t,"id","menu");if(s){Tt<0?(s.style.transform=`translateX(${-Tt}px)`,Ii(-Tt/a)):(s.style.transform="translateX(0px)",Ii(0));return}const i=O(t,"id","sidebar");if(i){Tt>0?(i.style.transform=`translateX(${-Tt}px)`,Ii(Tt/a)):(i.style.transform="translateX(0px)",Ii(0));return}zn==="toRight"?(document.getElementById("sidebar").style.transform=`translateX(${Math.min(-Tt-a,0)}px)`,Ii((a+Tt)/a)):(document.getElementById("menu").style.transform=`translateX(${Math.max(a-Tt,0)}px)`,Ii((a-Tt)/a)),mn(),window.siyuan.mobile.editor&&(window.siyuan.mobile.editor.protyle.contentElement.style.overflow="hidden")}}},Ii=e=>{br.classList.remove("fn__none"),br.style.opacity=Math.min(1-e,.68).toString()},af=()=>{L("/api/snippet/getSnippet",{type:"all",enabled:2},e=>{e.data.snippets.forEach(t=>{const n=`snippet${t.type==="css"?"CSS":"JS"}${t.id}`;let a=document.getElementById(n);if(!window.siyuan.config.snippet.enabledCSS&&t.type==="css"||!window.siyuan.config.snippet.enabledJS&&t.type==="js"){a&&a.remove();return}if(!t.enabled){a&&a.remove();return}if(a){if(a.innerHTML===t.content)return;a.remove()}t.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${n}">${t.content}</style>`):t.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=t.content,a.id=n,document.head.appendChild(a))})})},Sy=()=>{fetchPost("/api/snippet/getSnippet",{type:"all",enabled:2},e=>{let t="",n="";e.data.snippets.forEach(i=>{i.type==="css"?t+=yr(i):n+=yr(i)});const a=new Dialog({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        <div class="fn__flex">
            <div class="b3-form__icon fn__flex-1">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="css" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input fn__block">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} CSS" id="addCodeSnippetCSS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleCSS" class="b3-switch fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledCSS?" checked":""}>
        </div>
        ${t}
    </div>
    <div class="fn__none">
        <div class="fn__flex">
             <div class="b3-form__icon fn__flex-1">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input data-type="js" data-action="search" type="text" placeholder="${window.siyuan.languages.search}" class="b3-text-field b3-form__icon-input fn__block">
            </div>
            <div class="fn__space"></div>
            <span aria-label="${window.siyuan.languages.addAttr} JS" id="addCodeSnippetJS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleJS" class="b3-switch fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledJS?" checked":""}>
        </div>
        ${n}
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback:i=>{(i==null?void 0:i.cancel)!=="true"&&of(a,e.data.snippets,s,!0)}});e.data.snippets.forEach(i=>{const o=a.element.querySelector(`[data-id="${i.id}"] input`);o.value=i.name;const l=a.element.querySelector(`[data-id="${i.id}"] textarea`);l.textContent=i.content});const s=[];a.element.setAttribute("data-key",Constants.DIALOG_SNIPPETS),a.element.addEventListener("click",i=>{let o=i.target;for(;o&&o!==a.element;){if(o.id==="addCodeSnippetCSS"||o.id==="addCodeSnippetJS"){o.parentElement.insertAdjacentHTML("afterend",yr({type:o.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!0,disabledInPublish:!1})),i.stopPropagation(),i.preventDefault();break}else if(o.classList.contains("b3-button--cancel")){a.destroy({cancel:"true"}),i.stopPropagation(),i.preventDefault();break}else if(o.classList.contains("b3-button--text")){of(a,e.data.snippets,s),i.stopPropagation(),i.preventDefault();break}else if(o.classList.contains("item")){o.getAttribute("data-type")==="css"?(o.classList.add("item--focus"),o.nextElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(o.classList.add("item--focus"),o.previousElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none")),i.stopPropagation(),i.preventDefault();break}else if(o.dataset.action==="remove"){const l=o.parentElement.parentElement;s.push("#snippet"+(l.getAttribute("data-type")==="css"?"CSS":"JS")+l.getAttribute("data-id")),l.remove(),i.stopPropagation(),i.preventDefault();break}o=o.parentElement}}),a.element.querySelectorAll('[data-action="search"]').forEach(i=>{i.addEventListener("input",o=>{o.isComposing||sf(a,i)}),i.addEventListener("compositionend",()=>{sf(a,i)})})})},sf=(e,t)=>{e.element.querySelectorAll(`.fn__flex-1 > div > [data-type="${t.dataset.type}"]`).forEach(n=>{const a=n.querySelector("input").value.toLowerCase(),s=n.querySelector("textarea").value.toLowerCase(),i=t.value.toLowerCase();!i||a&&(i.includes(a)||a.includes(i))||s&&(s.includes(i)||i.includes(s))?n.classList.remove("fn__none"):n.classList.add("fn__none")})},yr=e=>`<div data-id="${e.id||""}" data-type="${e.type}">
    <div class="fn__hr--b"></div>
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__space"></div>
        <label class="fn__flex${window.siyuan.config.publish.enable?"":" fn__none"}">
            <input data-type="disabledInPublish" type="checkbox" class="b3-switch fn__flex-center" ${e.disabledInPublish?"":" checked"}>
            <div class="fn__space"></div>
            <span class="fn__flex-center">${window.siyuan.languages.publishService}</span>
        </label>
        <div class="fn__flex-1"></div>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" data-action="remove" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <div class="fn__space"></div>
        <input data-type="snippet" class="b3-switch fn__flex-center" type="checkbox"${e.enabled?" checked":""}>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
    <div class="fn__hr--b"></div>
</div>`,lf=(e,t,n)=>{fetchPost("/api/snippet/setSnippet",{snippets:t},()=>{n.forEach(a=>{const s=document.querySelector(a);s&&s.remove()}),window.siyuan.config.snippet.enabledCSS=e.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked,window.siyuan.config.snippet.enabledJS=e.element.querySelector('.b3-switch[data-action="toggleJS"]').checked,fetchPost("/api/setting/setSnippet",window.siyuan.config.snippet,()=>{reloadOtherWindow()}),af(),e.destroy({cancel:"true"})})},of=(e,t,n,a=!1)=>{const s=[];e.element.querySelectorAll("[data-id]").forEach(i=>{s.push({disabledInPublish:!i.querySelector('.b3-switch[data-type="disabledInPublish"]').checked,id:i.getAttribute("data-id"),name:i.querySelector("input").value,type:i.getAttribute("data-type"),content:i.querySelector("textarea").value,enabled:i.querySelector('.b3-switch[data-type="snippet"]').checked})}),objEquals(t,s)&&window.siyuan.config.snippet.enabledCSS===e.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked&&window.siyuan.config.snippet.enabledJS===e.element.querySelector('.b3-switch[data-action="toggleJS"]').checked?e.destroy({cancel:"true"}):a?confirmDialog(window.siyuan.languages.save,window.siyuan.languages.snippetsTip,()=>{lf(e,s,n)}):lf(e,s,n)};var rf=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class xb extends Ti{constructor(t){super({app:t,id:Zn(),type:"filetree",msgCallback(a){if(a)switch(a.cmd){case"moveDoc":this.onMove(a.data);break;case"reloadFiletree":ua(()=>{this.init(!1)});break;case"mount":this.onMount(a);break;case"createnotebook":ua(s=>{let i;s.find(o=>{if(!o.closed){if(o.id===a.data.box.id)return i?this.element.querySelector(`.b3-list[data-url="${i}"]`).insertAdjacentHTML("afterend",this.genNotebook(a.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(a.data.box)),!0;i=o.id}})});break;case"unmount":case"removeDoc":this.onRemove(a);break;case"create":a.data.listDocTree?this.selectItem(a.data.box.id,a.data.path):this.updateItemArrow(a.data.box.id,a.data.path);break;case"createdailynote":case"heading2doc":case"li2doc":this.selectItem(a.data.box.id,a.data.path);break;case"renamenotebook":this.element.querySelector(`[data-url="${a.data.box}"] .b3-list-item__text`).innerHTML=a.data.name;break;case"rename":this.onRename(a.data);break}}}),this.genFileHTML=a=>{let s="";return a.count&&a.count>0&&(s=`<span class="counter">${a.count}</span>`),`<li data-node-id="${a.id}" data-name="${Lute.EscapeHTMLStr(a.name)}" data-type="navigation-file" 
class="b3-list-item" data-path="${a.path}">
    <span style="padding-left: ${(a.path.split("/").length-1)*20}px" class="b3-list-item__toggle${a.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon">${ge(a.icon||(a.subFileCount===0?window.siyuan.storage[p.LOCAL_IMAGES].file:window.siyuan.storage[p.LOCAL_IMAGES].folder))}</span>
    <span class="b3-list-item__text">${vt(a.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${s}
</li>`};const n=document.querySelector('#sidebar [data-type="sidebar-file"]');n.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">${window.siyuan.languages.fileTree}</div>
    <div class="fn__flex-1 fn__space"></div>
    <svg data-type="newNotebook" class="toolbar__icon"><use xlink:href="#iconFilesRoot"></use></svg>
    <svg data-type="refresh" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
    <svg data-type="focus" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>
</div>
<div class="fn__flex-1"></div>
<ul class="b3-list b3-list--background fn__flex-column" style="min-height: auto;height:42px;transition: height .2s cubic-bezier(0, 0, .2, 1) 0ms">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
        <span class="counter" style="cursor: auto"></span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=n.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=this.element.nextElementSibling,n.addEventListener("click",a=>{let s=a.target;for(;s&&!s.isEqualNode(this.actionsElement);){s.classList.contains("b3-list-item__icon")&&(s=s.previousElementSibling);const i=s.getAttribute("data-type");if(i==="refresh"){if(!s.getAttribute("disabled")){s.setAttribute("disabled","disabled");const o=[];Array.from(this.element.children).forEach(l=>{o.push(l.getAttribute("data-url"))}),lu(()=>{s.removeAttribute("disabled"),this.init(!1)})}a.preventDefault();break}else if(i==="focus"){window.siyuan.mobile.editor&&this.selectItem(window.siyuan.mobile.editor.protyle.notebookId,window.siyuan.mobile.editor.protyle.path),a.preventDefault();break}else if(i==="newNotebook")Bo();else if(i==="collapse"){Array.from(this.element.children).forEach(o=>{const l=o.firstElementChild,r=l.querySelector(".b3-list-item__arrow");r.classList.contains("b3-list-item__arrow--open")&&(r.classList.remove("b3-list-item__arrow--open"),l.nextElementSibling.remove())}),a.preventDefault();break}else if(i==="sort"){this.genSort(),a.preventDefault(),a.stopPropagation();break}else if(s.classList.contains("b3-list-item__toggle")&&!s.classList.contains("fn__hidden")&&s.parentElement.getAttribute("data-type")!=="toggle"){const o=le(s,"UL");if(o){const l=o.getAttribute("data-url");this.getLeaf(s.parentElement,l),this.setCurrent(s.parentElement),window.siyuan.menus.menu.remove()}a.preventDefault(),a.stopPropagation();break}else if(i==="toggle"){const o=s.querySelector("svg");o.classList.contains("b3-list-item__arrow--open")?(this.closeElement.style.height="42px",o.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",o.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none")),a.stopPropagation(),a.preventDefault();break}else if(i==="open"){L("/api/notebook/openNotebook",{notebook:s.getAttribute("data-url")}),a.stopPropagation(),a.preventDefault();break}else if(s.classList.contains("b3-list-item__action")){const o=s.getAttribute("data-type"),l=s.parentElement.getAttribute("data-path"),r=le(s,"UL");if(r){const d=r.getAttribute("data-url");window.siyuan.config.readonly||(o==="new"?ga({app:t,notebookId:d,currentPath:l,useSavePath:!1,listDocTree:!0}):o==="more-root"?(Qu(t,s.parentElement),window.siyuan.menus.menu.fullscreen("bottom")):o==="addLocal"&&(L("/api/filetree/moveLocalShorthands",{notebook:d}),this.element.querySelectorAll('[data-type="addLocal"]').forEach(c=>{c.remove()}))),o==="more-file"&&(ef(t,d,l,s.parentElement),window.siyuan.menus.menu.fullscreen("bottom"))}a.preventDefault(),a.stopPropagation();break}else if(s.tagName==="LI"){if(this.setCurrent(s),s.getAttribute("data-type")==="navigation-file")ft(t,s.getAttribute("data-node-id"),[p.CB_GET_SCROLL]);else if(s.getAttribute("data-type")==="navigation-root"){const o=le(s,"UL");if(o){const l=o.getAttribute("data-url");this.getLeaf(s,l)}}a.preventDefault();break}s=s.parentElement}}),this.init(),window.siyuan.config.openHelp&&Ro()}genSort(){window.siyuan.menus.menu.remove(),nf("notebooks",window.siyuan.config.fileTree.sort,n=>{window.siyuan.config.fileTree.sort=n,L("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{ua(()=>{this.init(!1)})})}).forEach(n=>{window.siyuan.menus.menu.append(new H(n).element)}),window.siyuan.menus.menu.fullscreen("bottom")}updateItemArrow(t,n){const a=this.element.querySelector(`[data-url="${t}"]`);if(!a)return;let s=n,i;for(;!i;)if(i=a.querySelector(`[data-path="${s}"]`),i){const o=i.querySelector(".fn__hidden");o?o.classList.remove("fn__hidden"):this.getLeaf(i,t,!0);break}else{const o=_e().dirname(s);if(o==="/"){a.firstElementChild.querySelector(".b3-list-item__arrow--open")&&this.getLeaf(a.firstElementChild,t,!0);break}else s=o+".sy"}}genNotebook(t){const n=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${ge(t.icon||window.siyuan.storage[p.LOCAL_IMAGES].note)}</span>`;return t.closed?`<li data-url="${t.id}" class="b3-list-item">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text">${pe(t.name)}</span>
    <span data-type="open" data-url="${t.id}" class="b3-list-item__action${window.siyuan.config.readonly?" fn__none":""}">
        <svg><use xlink:href="#iconOpen"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${t.id}" data-sortmode="${t.sortMode}">
<li class="b3-list-item" data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle${t.closed?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text${t.closed?" ft__on-surface":""}">${pe(t.name)}</span>
    <span data-type="more-root" class="b3-list-item__action${window.siyuan.config.readonly||t.closed?" fn__none":""}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action${window.siyuan.config.readonly||t.closed?" fn__none":""}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(t=!0){let n="",a="",s=0;window.siyuan.notebooks.forEach(l=>{l.closed?(s++,a+=this.genNotebook(l)):n+=this.genNotebook(l)}),this.element.innerHTML=n,this.closeElement.lastElementChild.innerHTML=a;const i=this.closeElement.querySelector(".counter");if(i.textContent=s.toString(),s?this.closeElement.classList.remove("fn__none"):this.closeElement.classList.add("fn__none"),window.siyuan.storage[p.LOCAL_FILESPATHS].forEach(l=>{l.openPaths.forEach(r=>{this.selectItem(l.notebookId,r,void 0,!1,!1)})}),!t)return;const o=this.closeElement.querySelector("svg");n!==""?(this.closeElement.style.height="42px",o.classList.remove("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.add("fn__none")):(this.closeElement.style.height="40%",o.classList.add("b3-list-item__arrow--open"),this.closeElement.lastElementChild.classList.remove("fn__none"))}onMove(t){const n=this.element.querySelector(`ul[data-url="${t.fromNotebook}"] li[data-path="${t.fromPath}"]`);if(n)if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),n.parentElement.childElementCount===1){if(n.parentElement.previousElementSibling){n.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),n.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const s=n.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");s.innerHTML===ge(window.siyuan.storage[p.LOCAL_IMAGES].folder)&&(s.innerHTML=ge(window.siyuan.storage[p.LOCAL_IMAGES].file))}n.parentElement.remove()}else n.remove();else{const s=this.element.querySelector(`ul[data-url="${t.fromNotebook}"] li[data-path="${_e().dirname(t.fromPath)}.sy"]`);s&&s.getAttribute("data-count")==="1"&&(s.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),s.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"))}const a=this.element.querySelector(`[data-url="${t.toNotebook}"] li[data-path="${t.toPath}"]`);if(a){const s=a.querySelector(".b3-list-item__icon");s.innerHTML===ge(window.siyuan.storage[p.LOCAL_IMAGES].file)&&(s.innerHTML=ge(window.siyuan.storage[p.LOCAL_IMAGES].folder)),a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),a.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&a.nextElementSibling.remove(),this.getLeaf(a,t.toNotebook)}}onRemove(t){if(t.cmd==="unmount"){if(ua(n=>{const a=this.element.querySelector(`ul[data-url="${t.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),p.CB_MOUNT_REMOVE!==t.callback)){let s="";n.find(o=>{o.closed&&(s+=this.genNotebook(o))}),this.closeElement.lastElementChild.innerHTML=s;const i=this.closeElement.querySelector(".counter");i.textContent=(parseInt(i.textContent)+1).toString(),this.closeElement.classList.remove("fn__none")}}),p.CB_MOUNT_REMOVE===t.callback){const n=this.closeElement.querySelector(`li[data-url="${t.data.box}"]`);if(n){n.remove();const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&this.closeElement.classList.add("fn__none")}}return}t.data.ids.forEach(n=>{var a;const s=this.element.querySelector(`li.b3-list-item[data-node-id="${n}"]`);if(s){((a=s.nextElementSibling)==null?void 0:a.tagName)==="UL"&&s.nextElementSibling.remove();const i=s.parentElement.previousElementSibling;if(s.parentElement.childElementCount===1){if(i){const o=i.querySelector("svg");o.classList.remove("b3-list-item__arrow--open"),i.dataset.type!=="navigation-root"&&o.parentElement.classList.add("fn__hidden");const l=o.parentElement.nextElementSibling;l.innerHTML===ge(window.siyuan.storage[p.LOCAL_IMAGES].folder)&&(l.innerHTML=ge(window.siyuan.storage[p.LOCAL_IMAGES].file))}s.parentElement.remove()}else s.remove()}})}onRename(t){const n=this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${t.path}"]`);n&&(n.setAttribute("data-name",Lute.EscapeHTMLStr(t.title)),n.querySelector(".b3-list-item__text").innerHTML=pe(t.title))}onMount(t){if(t.data.existed)return;const n=this.closeElement.querySelector(`li[data-url="${t.data.box.id}"]`);if(n){n.remove();const a=this.closeElement.querySelector(".counter");a.textContent=(parseInt(a.textContent)-1).toString(),a.textContent==="0"&&this.closeElement.classList.add("fn__none")}ua(a=>{const s=this.genNotebook(t.data.box);if(this.element.childElementCount===0)this.element.innerHTML=s;else{let i;a.find((o,l)=>{if(o.id===t.data.box.id){for(;l>0;)if(a[l-1].closed)l--;else{i=a[l-1].id;break}return!0}}),i?this.element.querySelector(`[data-url="${i}"]`).insertAdjacentHTML("afterend",s):this.element.insertAdjacentHTML("afterbegin",s)}})}onLsHTML(t){if(t.files.length===0)return;const n=this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${t.path}"]`);if(!n)return;let a="";t.files.forEach(i=>{a+=this.genFileHTML(i)});let s=n.nextElementSibling;if(s&&s.tagName==="UL"){const i=document.createElement("template");i.innerHTML=a,s.querySelectorAll(":scope > .b3-list-item > .b3-list-item__toggle> .b3-list-item__arrow--open").forEach(o=>{const l=C(o,"b3-list-item");if(l){const r=i.content.querySelector(`.b3-list-item[data-node-id="${l.getAttribute("data-node-id")}"]`);r.after(l.nextElementSibling),r.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open")}}),s.innerHTML=i.innerHTML;return}n.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),n.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${a}</ul>`),s=n.nextElementSibling,setTimeout(()=>{s.setAttribute("style",`height:${s.childElementCount*n.clientHeight}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(i=>{i.classList.remove("file-tree__sliderDown"),i.removeAttribute("style")})},120)},2)}onLsSelect(t,n,a,s){return rf(this,null,function*(){let i="";if(t.files.forEach(c=>{i+=this.genFileHTML(c)}),i==="")return;const o=this.element.querySelector(`ul[data-url="${t.box}"] li[data-path="${t.path}"]`);o.nextElementSibling&&o.nextElementSibling.tagName==="UL"&&o.nextElementSibling.remove();const l=o.querySelector(".b3-list-item__arrow");l.classList.add("b3-list-item__arrow--open"),l.parentElement.classList.remove("fn__hidden");const r=o.querySelector(".b3-list-item__icon");r.textContent===ge(window.siyuan.storage[p.LOCAL_IMAGES].file)&&(r.textContent=ge(window.siyuan.storage[p.LOCAL_IMAGES].folder)),o.insertAdjacentHTML("afterend",`<ul>${i}</ul>`);let d;for(let c=0;c<t.files.length;c++){const f=t.files[c];if(n===f.path)d=yield this.selectItem(t.box,n,void 0,a,s);else if(n.startsWith(f.path.replace(".sy",""))){const m=yield he("/api/filetree/listDocsByPath",{notebook:t.box,path:f.path,app:p.SIYUAN_APPID});d=yield this.selectItem(m.data.box,n,m.data,a,s)}}return s&&this.setCurrent(d),d})}setCurrent(t,n=!0){if(t&&(this.element.querySelectorAll("li.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")}),t.classList.add("b3-list-item--focus"),n)){const a=this.element.getBoundingClientRect();this.element.scrollTop=this.element.scrollTop+(t.getBoundingClientRect().top-(a.top+a.height/2))}}getLeaf(t,n,a=!1){var s;const i=t.querySelector(".b3-list-item__arrow");if(i.classList.contains("b3-list-item__arrow--open")&&!a){i.classList.remove("b3-list-item__arrow--open"),(s=t.nextElementSibling)==null||s.remove(),this.getOpenPaths();return}L("/api/filetree/listDocsByPath",{notebook:n,path:t.getAttribute("data-path"),app:p.SIYUAN_APPID},o=>{if(o.data.path==="/"&&o.data.files.length===0){ga({app:this.app,notebookId:n,currentPath:"/",useSavePath:!1,listDocTree:!0});return}this.onLsHTML(o.data),this.getOpenPaths()})}selectItem(t,n,a,s=!0,i=!0){return rf(this,null,function*(){const o=this.element.querySelector(`[data-url="${t}"]`);if(!o)return;let l=n,r;for(;!r;)if(r=o.querySelector(`[data-path="${l}"]`),!r){const d=_e().dirname(l);d==="/"?l=d:l=d+".sy"}if(r.getAttribute("data-path")===n)return s&&this.getOpenPaths(),i&&this.setCurrent(r),r;if(a&&a.path===l)r=yield this.onLsSelect(a,n,s,i);else{const d=yield he("/api/filetree/listDocsByPath",{notebook:t,path:l,app:p.SIYUAN_APPID});r=yield this.onLsSelect(d.data,n,s,i)}return r})}getOpenPaths(){const t=[];this.element.querySelectorAll(".b3-list[data-url]").forEach(n=>{const a={notebookId:n.getAttribute("data-url"),openPaths:[]};if(n.querySelectorAll(".b3-list-item__arrow--open").forEach(s=>{const i=U(s,"LI");i&&a.openPaths.push(i.getAttribute("data-path"))}),a.openPaths.length>0){for(let s=0;s<a.openPaths.length;s++)for(let i=s+1;i<a.openPaths.length;i++)a.openPaths[i].startsWith(a.openPaths[s].replace(".sy",""))&&(a.openPaths.splice(s,1),i--);a.openPaths.forEach((s,i)=>{var o,l,r;const d=(r=(l=(o=this.element.querySelector(`[data-url="${a.notebookId}"] li[data-path="${s}"]`))==null?void 0:o.nextElementSibling)==null?void 0:l.firstElementChild)==null?void 0:r.getAttribute("data-path");d&&(a.openPaths[i]=d)}),t.push(a)}}),window.siyuan.storage[p.LOCAL_FILESPATHS]=t,Te(p.LOCAL_FILESPATHS,t)}}class ks{constructor(t){this.click=t.click,this.ctrlClick=t.ctrlClick,this.altClick=t.altClick,this.shiftClick=t.shiftClick,this.rightClick=t.rightClick,this.toggleClick=t.toggleClick,this.element=t.element,this.blockExtHTML=t.blockExtHTML,this.topExtHTML=t.topExtHTML,this.updateData(t.data),this.bindEvent()}updateData(t){this.data=t,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),jt(this.element))}genHTML(t){let n=`<ul${t[0].depth===0?" class='b3-list b3-list--background'":""}>`;return t.forEach(a=>{let s="",i='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?i='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?i='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(s=` aria-label="${Wt(a.hPath)}"`,i=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${Ln(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(s=` aria-label="${Wt(Lute.BlockDOM2Content(a.name))}"`,i=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}" style="height: 22px;width: 10px;"><use xlink:href="#${Ln(a.nodeType,a.subType)}"></use></svg>`);let o="";a.count&&(o=`<span class="counter">${a.count}</span>`);const l=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";P()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${a.depth*18||4}px;margin-right: 2px`;const d=l||a.type==="backlink"&&!P();n+=`<li class="b3-list-item${P()?"":" b3-list-item--hide-action"}" 
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
style="--file-toggle-width:${a.depth===0?22:(a.depth+1)*18}px" 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${d?" b3-list-item__toggle--hl":""}${d?"":" fn__hidden"}">
        <svg data-id="${a.id||encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${(a.type==="outline"?!a.folded:l)?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${i}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${s}>${a.name}</span>
    ${this.topExtHTML||""}
    ${o}
</li>`,a.children&&a.children.length>0&&(n+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(n+=this.genBlockHTML(a.blocks,a.type==="outline"?!a.folded:!0,a.type)+"</ul>")}),n}genBlockHTML(t,n=!1,a){let s=`<ul class="${n?"":"fn__none"}">`;return t.forEach(i=>{let o="";i.count&&(o=`<span class="counter">${i.count}</span>`);let l;a==="outline"?l=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${i.id}" style="height: 22px;width: 10px;"><use xlink:href="#${Ln(i.type,i.subType)}"></use></svg>`:i.type==="NodeDocument"?l=`<span data-showref="true" class="b3-list-item__graphic popover__block" data-id="${i.id}">${ge(i.ial.icon||window.siyuan.storage[p.LOCAL_IMAGES].file)}</span>`:l=`<svg data-showref="true" class="b3-list-item__graphic popover__block" data-id="${i.id}"><use xlink:href="#${Ln(i.type,i.subType)}"></use></svg>`;let r="";P()?i.depth>0&&(r=`padding-left: ${(i.depth-1)*20+24}px`):r=`padding-left: ${i.depth*18||4}px;margin-right: 2px`,s+=`<li class="b3-list-item${P()?"":" b3-list-item--hide-action"}"  
style="--file-toggle-width:${i.depth===0?22:(i.depth+1)*18}px" 
data-node-id="${i.id}" 
data-ref-text="${encodeURIComponent(i.refText)}" 
data-def-id="${i.defID}" 
data-type="${i.type}" 
data-subtype="${i.subType}" 
data-treetype="${a}" 
data-def-path="${i.defPath}">
    <span style="${r}" class="b3-list-item__toggle${i.children?" b3-list-item__toggle--hl":""}${i.children?"":" fn__hidden"}">
        <svg data-id="${i.id}" class="b3-list-item__arrow${(a==="outline"?!i.folded:n)?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${l}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+Wt(Lute.BlockDOM2Content(i.content))+'"':""}>${i.content}</span>
    ${o}
    ${this.blockExtHTML||""}
</li>`,i.children&&i.children.length>0&&(s+=this.genBlockHTML(i.children,a==="outline"?!i.folded:!1,a)+"</ul>")}),s}toggleBlocks(t){if(this.toggleClick){this.toggleClick(t);return}if(!t.nextElementSibling)return;const n=t.firstElementChild.firstElementChild;n.classList.contains("b3-list-item__arrow--open")?(n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling.classList.add("fn__none"),t.nextElementSibling.nextElementSibling&&t.nextElementSibling.nextElementSibling.tagName==="UL"&&t.nextElementSibling.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none"),t.nextElementSibling.nextElementSibling&&t.nextElementSibling.nextElementSibling.tagName==="UL"&&t.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(t){t.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(n=>{n.classList.remove("b3-list-item--focus")}),t.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",t=>{let n=t.target;for(;n&&!n.isEqualNode(this.element);){if(n.tagName==="LI"&&this.rightClick){this.rightClick(n,t),t.preventDefault(),t.stopPropagation();break}n=n.parentElement}}),this.element.addEventListener("click",t=>{let n=t.target;for(;n&&!n.isEqualNode(this.element);){if(n.classList.contains("b3-list-item__toggle")&&!n.classList.contains("fn__hidden")&&!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed){this.toggleBlocks(n.parentElement),this.setCurrent(n.parentElement),t.preventDefault();break}if(n.classList.contains("b3-list-item__action")&&this.click){const a=U(n,"LI");a&&this.click(a,t),t.preventDefault(),t.stopPropagation();break}else if(n.tagName==="LI"){this.setCurrent(n),n.getAttribute("data-node-id")||n.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(n,t):this.altClick&&window.siyuan.altIsPressed?this.altClick(n,t):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(n):this.click&&this.click(n,t),t.stopPropagation()):this.toggleBlocks(n),t.preventDefault();break}n=n.parentElement}}),this.element.addEventListener("dragstart",t=>{const n=U(t.target,"LI");n&&(t.dataTransfer.setData("text/html",n.outerHTML),n.style.opacity="0.38",window.siyuan.dragElement=n)}),this.element.addEventListener("dragend",t=>{const n=U(t.target,"LI");n&&(n.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(t=>{t.classList.contains("b3-list")||t.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(t=>{t.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(t=>{t.classList.contains("b3-list")||t.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(t=>{t.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const t=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(n=>{t.push(n.getAttribute("data-id"))}),t}setExpandIds(t){!t||t.length===0||this.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{t.includes(n.getAttribute("data-id"))?(n.classList.add("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(n.classList.remove("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.tagName==="UL"&&n.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}class Cb extends Ti{constructor(t){super({app:t.app,id:Zn(),msgCallback(a){if(a)switch(a.cmd){case"savedoc":this.onTransaction(a);break}}}),this.preFilterExpandIds=null,this.isPreview=t.isPreview,this.blockId=t.blockId,this.element=document.querySelector('#sidebar [data-type="sidebar-outline"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.outline}
    </div>
    <div class="fn__flex-1 fn__space"></div>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <svg data-type="search" class="toolbar__icon"><use xlink:href='#iconFilter'></use></svg>
    <svg data-type="keepCurrentExpand" class="toolbar__icon${window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand?" toolbar__icon--active":""}"><use xlink:href="#iconFocus"></use></svg>
    <svg data-type="expandLevel" class="toolbar__icon"><use xlink:href="#iconList"></use></svg>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="fn__flex-1" style="padding: 3px 0 8px"></div>`;const n=this.element.querySelector("input.b3-text-field.search__label");n.addEventListener("blur",()=>{n.classList.add("fn__none");const a=n.nextElementSibling,s=n.value;s?a.classList.add("toolbar__icon--active"):a.classList.remove("toolbar__icon--active"),n.dataset.value!==s&&this.setFilter()}),n.addEventListener("keydown",a=>{!a.isComposing&&a.key==="Enter"&&(n.dataset.value=n.value,this.setFilter())}),this.tree=new ks({element:this.element.lastElementChild,data:null,click:(a,s)=>{if(s&&C(s.target,"b3-list-item__action")){this.showContextMenu(a);return}const i=a.getAttribute("data-node-id");if(this.isPreview){const o=document.getElementById(i);o?o.scrollIntoView():ft(t.app,this.blockId)}else Jn(i,o=>{ft(t.app,i,o?[p.CB_GET_HL,p.CB_GET_ALL,p.CB_GET_HTML,p.CB_GET_OUTLINE]:[p.CB_GET_HL,p.CB_GET_OUTLINE,p.CB_GET_SETID,p.CB_GET_CONTEXT,p.CB_GET_HTML])})},toggleClick:a=>{if(!a.nextElementSibling)return;const s=a.firstElementChild.firstElementChild;s.classList.contains("b3-list-item__arrow--open")?(s.classList.remove("b3-list-item__arrow--open"),a.nextElementSibling.classList.add("fn__none"),a.nextElementSibling.nextElementSibling&&a.nextElementSibling.nextElementSibling.tagName==="UL"&&a.nextElementSibling.nextElementSibling.classList.add("fn__none")):(s.classList.add("b3-list-item__arrow--open"),a.nextElementSibling.classList.remove("fn__none"),a.nextElementSibling.nextElementSibling&&a.nextElementSibling.nextElementSibling.tagName==="UL"&&a.nextElementSibling.nextElementSibling.classList.remove("fn__none")),this.saveExpendIds()},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll(),this.saveExpendIds()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll(),this.saveExpendIds()}),this.element.querySelector('[data-type="keepCurrentExpand"]').addEventListener("click",a=>{var s;const i=C(a.target,"toolbar__icon");if(i){if(i.classList.contains("toolbar__icon--active"))i.classList.remove("toolbar__icon--active"),window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand=!1;else{i.classList.add("toolbar__icon--active"),window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand=!0;let o;const l=F((s=window.siyuan.mobile.editor.protyle.toolbar.range)==null?void 0:s.startContainer);l&&(o=l),o&&this.setCurrent(o)}Te(p.LOCAL_OUTLINE,window.siyuan.storage[p.LOCAL_OUTLINE])}}),this.element.addEventListener("click",a=>{let s=a.target;if(s.tagName!=="INPUT")for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("toolbar__icon")){switch(s.getAttribute("data-type")){case"search":n.classList.remove("fn__none"),n.select();break;case"expandLevel":this.showExpandLevelMenu(),a.preventDefault(),a.stopPropagation();break}break}s=s.parentElement}}),L("/api/outline/getDocOutline",{id:this.blockId,preview:this.isPreview},a=>{this.update(a)})}setCurrent(t){if(t)if(t.getAttribute("data-type")==="NodeHeading")this.setCurrentById(t.getAttribute("data-node-id"));else{let n=We(t);for(;n&&n.getAttribute("data-type")!=="NodeHeading";)n=We(n);n?this.setCurrentById(n.getAttribute("data-node-id")):L("/api/block/getBlockBreadcrumb",{id:t.getAttribute("data-node-id"),excludeTypes:[]},a=>{a.data.reverse().find(s=>{if(s.type==="NodeHeading")return this.setCurrentById(s.id),!0})})}}setCurrentByPreview(t){if(!t)return;let n=t;for(;n&&!n.classList.contains("b3-typography")&&!["H1","H2","H3","H4","H5","H6"].includes(n.tagName);)n=n.previousElementSibling||n.parentElement;n&&n.id&&this.setCurrentById(n.id)}setCurrentById(t){this.element.querySelectorAll(".b3-list-item.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")});let n=this.element.querySelector(`.b3-list-item[data-node-id="${t}"]`);if(window.siyuan.storage[p.LOCAL_OUTLINE].keepCurrentExpand){let a=n.parentElement;for(;a&&!a.classList.contains("b3-list")&&a.tagName==="UL";)a.classList.remove("fn__none"),a.previousElementSibling.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),a=a.parentElement;this.saveExpendIds()}else for(;n&&n.clientHeight===0;)n=n.parentElement.previousElementSibling;if(n){n.classList.add("b3-list-item--focus");const a=this.element.getBoundingClientRect();this.element.scrollTop=this.element.scrollTop+(n.getBoundingClientRect().top-(a.top+a.height/2))}}update(t,n){let a=this.element.querySelector(".b3-list-item--focus"),s;a&&(s=a.getAttribute("data-node-id"));const i=this.element.scrollTop;typeof n!="undefined"&&(this.blockId=n),this.tree.updateData(t.data),this.isPreview?(this.tree.element.querySelectorAll(".popover__block").forEach(o=>{o.classList.remove("popover__block")}),this.element.scrollTop=i):this.blockId&&(this.element.querySelector("input.b3-text-field.search__label").value&&this.setFilter(),this.element.scrollTop=i),s&&(a=this.element.querySelector(`[data-node-id="${s}"]`),a&&a.classList.add("b3-list-item--focus")),this.element.removeAttribute("data-loading")}saveExpendIds(){window.siyuan.config.readonly||window.siyuan.isPublish||this.isPreview||L("/api/storage/setOutlineStorage",{docID:this.blockId,val:{expandIds:this.tree.getExpandIds()}})}setFilter(){this.element.querySelectorAll('li.b3-list-item[style$="display: none;"]').forEach(n=>{n.style.display=""}),this.element.querySelectorAll("ul.fn__none").forEach(n=>{n.previousElementSibling.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden")});const t=this.element.querySelector("input.b3-text-field.search__label").value.toLowerCase();if(t){this.preFilterExpandIds||(this.preFilterExpandIds=this.tree.getExpandIds());const n=a=>{let s=!1,i=!1;return a.querySelectorAll(":scope > li.b3-list-item").forEach(l=>{var r;const d=l.nextElementSibling&&l.nextElementSibling.tagName==="UL"?l.nextElementSibling:void 0;let c={hasMatch:!1,hasChildMatch:!1};d&&(c=n(d));const f=l.querySelector(".b3-list-item__arrow");(((r=l.querySelector(".b3-list-item__text"))==null?void 0:r.textContent)||"").trim().toLowerCase().includes(t)?(l.style.display="",s=!0,d&&(d.classList.remove("fn__none"),c.hasMatch||c.hasChildMatch?(f.classList.add("b3-list-item__arrow--open"),d.classList.remove("fn__none")):(f.classList.remove("b3-list-item__arrow--open"),f.parentElement.classList.add("fn__hidden"),d.classList.add("fn__none")))):c.hasMatch||c.hasChildMatch?(l.style.display="",i=!0,d&&(d.classList.remove("fn__none"),f.classList.add("b3-list-item__arrow--open"))):(l.style.display="none",d&&d.classList.add("fn__none"))}),{hasMatch:s,hasChildMatch:i}};n(this.element.lastElementChild.firstElementChild);return}this.tree.setExpandIds(this.preFilterExpandIds),this.preFilterExpandIds=null}getHeadingLevel(t){var n;return parseInt(((n=t.getAttribute("data-subtype"))==null?void 0:n.replace("h",""))||"0")}expandToLevel(t){t>=6?this.tree.expandAll():this.element.querySelectorAll("li.b3-list-item").forEach(n=>{const a=this.getHeadingLevel(n),s=n.querySelector(".b3-list-item__arrow");n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&s&&(a>0&&a<t?(s.classList.add("b3-list-item__arrow--open"),n.nextElementSibling.classList.remove("fn__none")):a>=t&&(s.classList.remove("b3-list-item__arrow--open"),n.nextElementSibling.classList.add("fn__none")))}),this.saveExpendIds()}showExpandLevelMenu(){window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_OUTLINE_EXPAND_LEVEL);for(let t=1;t<=6;t++)window.siyuan.menus.menu.append(new H({id:`heading${t}`,icon:`iconH${t}`,label:window.siyuan.languages[`heading${t}`],click:()=>this.expandToLevel(t)}).element);return window.siyuan.menus.menu.fullscreen("bottom"),window.siyuan.menus.menu}collapseSameLevel(t,n){this.element.querySelectorAll(`li.b3-list-item[data-subtype="${t.getAttribute("data-subtype")}"]`).forEach(a=>{const s=a.querySelector(".b3-list-item__arrow");if(typeof n=="undefined"&&(n=!t.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")),n){a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&(a.nextElementSibling.classList.remove("fn__none"),s.classList.add("b3-list-item__arrow--open"));let i=a.parentElement;for(;i&&!i.classList.contains("b3-list")&&i.tagName==="UL";)i.classList.remove("fn__none"),i.previousElementSibling.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i=i.parentElement}else a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&(a.nextElementSibling.classList.add("fn__none"),s.classList.remove("b3-list-item__arrow--open"))}),this.saveExpendIds()}collapseChildren(t,n){const a=t.nextElementSibling;if(!a||a.tagName!=="UL")return;const s=t.querySelector(".b3-list-item__arrow");typeof n=="undefined"&&(n=!s.classList.contains("b3-list-item__arrow--open")),n?(s.classList.add("b3-list-item__arrow--open"),a.classList.remove("fn__none"),a.querySelectorAll("ul").forEach(i=>{i.previousElementSibling.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.classList.remove("fn__none")})):(s.classList.remove("b3-list-item__arrow--open"),a.classList.add("fn__none")),this.saveExpendIds()}onTransaction(t){if(t.data.rootID!==this.blockId)return;let n=!1;const a=t.data.sources[0];a.doOperations.find(s=>{if(s.action==="update"&&(this.element.querySelector(`.b3-list-item[data-node-id="${s.id}"]`)||s.data.indexOf('data-type="NodeHeading"')>-1))return n=!0,!0;if(s.action==="insert"&&s.data.indexOf('data-type="NodeHeading"')>-1)return n=!0,!0;if(s.action==="delete"||s.action==="move")return n=!0,!0}),!n&&a.undoOperations&&a.undoOperations.find(s=>{var i;if(s.action==="update"&&((i=s.data)==null?void 0:i.indexOf('data-type="NodeHeading"'))>-1)return n=!0,!0}),n&&L("/api/outline/getDocOutline",{id:this.blockId,preview:this.isPreview},s=>{if(t.data.rootID===this.blockId&&(this.update(s),getSelection().rangeCount>0)){const i=F(getSelection().getRangeAt(0).startContainer);i&&i.getAttribute("data-type")==="NodeHeading"&&this.setCurrent(i)}})}showContextMenu(t){if(this.isPreview)return;const n=this.getHeadingLevel(t);window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_OUTLINE_CONTEXT);const a=t.getAttribute("data-node-id");if(!window.siyuan.config.readonly){n>1&&window.siyuan.menus.menu.append(new H({id:"upgrade",icon:"iconUp",label:window.siyuan.languages.upgrade,click:()=>{const i=this.getProtyleAndBlockElement(t);i&&kn({protyle:i.protyle,selectsElement:[i.blockElement],type:"Blocks2Hs",level:n-1})}}).element),n<6&&window.siyuan.menus.menu.append(new H({id:"downgrade",icon:"iconDown",label:window.siyuan.languages.downgrade,click:()=>{const i=this.getProtyleAndBlockElement(t);i&&kn({protyle:i.protyle,selectsElement:[i.blockElement],type:"Blocks2Hs",level:n+1})}}).element),this.setCurrentById(a);const s=[];n!==1&&s.push(this.genHeadingTransform(a,1)),n!==2&&s.push(this.genHeadingTransform(a,2)),n!==3&&s.push(this.genHeadingTransform(a,3)),n!==4&&s.push(this.genHeadingTransform(a,4)),n!==5&&s.push(this.genHeadingTransform(a,5)),n!==6&&s.push(this.genHeadingTransform(a,6)),s.length>0&&window.siyuan.menus.menu.append(new H({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:s}).element),window.siyuan.menus.menu.append(new H({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"insertSameLevelHeadingBefore",icon:"iconBefore",label:window.siyuan.languages.insertSameLevelHeadingBefore,click:()=>{var i;const o=this.getProtyleAndBlockElement(t),l=Lute.NewNodeID(),r=`<div data-subtype="h${n}" data-node-id="${l}" data-type="NodeHeading" class="h${n}"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;B(o.protyle,[{action:"insert",data:r,id:l,previousID:(i=o.blockElement.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:o.blockElement.parentElement.getAttribute("data-node-id")||o.protyle.block.parentID}],[{action:"delete",id:l}]),o.blockElement.insertAdjacentHTML("beforebegin",r),o.blockElement.previousElementSibling.scrollIntoView(),fe(o.blockElement.previousElementSibling,document.createRange())}}).element),window.siyuan.menus.menu.append(new H({id:"insertSameLevelHeadingAfter",icon:"iconAfter",label:window.siyuan.languages.insertSameLevelHeadingAfter,click:()=>{L("/api/block/getHeadingDeleteTransaction",{id:a},i=>{const o=this.getProtyleAndBlockElement(t),l=i.data.doOperations[i.data.doOperations.length-1].id,r=Lute.NewNodeID(),d=`<div data-subtype="h${n}" data-node-id="${r}" data-type="NodeHeading" class="h${n}"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;B(o.protyle,[{action:"insert",data:d,id:r,previousID:l}],[{action:"delete",id:r}]);const c=o.protyle.wysiwyg.element.querySelector(`[data-node-id="${l}"]`);c&&(c.insertAdjacentHTML("afterend",d),c.nextElementSibling.scrollIntoView(),fe(c.nextElementSibling,document.createRange()))})}}).element),n<6&&window.siyuan.menus.menu.append(new H({id:"addChildHeading",icon:"iconAdd",label:window.siyuan.languages.addChildHeading,click:()=>{L("/api/block/getHeadingDeleteTransaction",{id:a},i=>{let o=i.data.doOperations[i.data.doOperations.length-1].id;i.data.undoOperations.find((f,m)=>{const u=f.data.indexOf(' data-subtype="h');if(u>-1&&u<260&&parseInt(f.data.substring(u+16,u+17))===n+1)return o=i.data.undoOperations[m-1].id,!0});const l=this.getProtyleAndBlockElement(t),r=Lute.NewNodeID(),d=`<div data-subtype="h${n+1}" data-node-id="${r}" data-type="NodeHeading" class="h${n+1}"><div contenteditable="true" spellcheck="false"><wbr></div><div class="protyle-attr" contenteditable="false">${p.ZWSP}</div></div>`;B(l.protyle,[{action:"insert",data:d,id:r,previousID:o}],[{action:"delete",id:r}]);const c=l.protyle.wysiwyg.element.querySelector(`[data-node-id="${o}"]`);c&&(c.insertAdjacentHTML("afterend",d),c.nextElementSibling.scrollIntoView(),fe(c.nextElementSibling,document.createRange()))})}}).element),window.siyuan.menus.menu.append(new H({id:"separator_2",type:"separator"}).element)}window.siyuan.menus.menu.append(new H({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click:()=>{const s=this.getProtyleAndBlockElement(t);L("/api/block/getHeadingChildrenDOM",{id:a,removeFoldAttr:s.blockElement.getAttribute("fold")!=="1"},i=>{Je()?window.JSAndroid.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(i.data).trimEnd(),i.data+p.ZWSP):ut()?window.JSHarmony.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(i.data).trimEnd(),i.data+p.ZWSP):He(i.data+p.ZWSP)})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new H({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click:()=>{const s=this.getProtyleAndBlockElement(t);L("/api/block/getHeadingChildrenDOM",{id:a,removeFoldAttr:s.blockElement.getAttribute("fold")!=="1"},i=>{Je()?window.JSAndroid.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(i.data).trimEnd(),i.data+p.ZWSP):ut()?window.JSHarmony.writeHTMLClipboard(s.protyle.lute.BlockDOM2StdMd(i.data).trimEnd(),i.data+p.ZWSP):He(i.data+p.ZWSP),L("/api/block/getHeadingDeleteTransaction",{id:a},o=>{if(o.data.doOperations.forEach(l=>{s.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${l.id}"]`).forEach(r=>{r.remove()})}),s.protyle.wysiwyg.element.childElementCount===0){const l=Lute.NewNodeID(),r=yn(!1,!1,l);s.protyle.wysiwyg.element.insertAdjacentElement("afterbegin",r),o.data.doOperations.push({action:"insert",data:r.outerHTML,id:l,parentID:s.protyle.block.parentID}),o.data.undoOperations.push({action:"delete",id:l}),te(r)}B(s.protyle,o.data.doOperations,o.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new H({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click:()=>{const s=this.getProtyleAndBlockElement(t);L("/api/block/getHeadingDeleteTransaction",{id:a},i=>{if(i.data.doOperations.forEach(o=>{s.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${o.id}"]`).forEach(l=>{l.remove()})}),s.protyle.wysiwyg.element.childElementCount===0){const o=Lute.NewNodeID(),l=yn(!1,!1,o);s.protyle.wysiwyg.element.insertAdjacentElement("afterbegin",l),i.data.doOperations.push({action:"insert",data:l.outerHTML,id:o,parentID:s.protyle.block.parentID}),i.data.undoOperations.push({action:"delete",id:o}),te(l)}B(s.protyle,i.data.doOperations,i.data.undoOperations)})}}).element)),window.siyuan.menus.menu.append(new H({id:"separator_3",type:"separator"}).element),window.siyuan.menus.menu.append(new H({id:"expandChildHeading",icon:"iconExpand",label:window.siyuan.languages.expandChildHeading,accelerator:"\u2318"+window.siyuan.languages.clickArrow,click:()=>this.collapseChildren(t,!0)}).element),window.siyuan.menus.menu.append(new H({id:"foldChildHeading",icon:"iconContract",label:window.siyuan.languages.foldChildHeading,accelerator:"\u2318"+window.siyuan.languages.clickArrow,click:()=>this.collapseChildren(t,!1)}).element),window.siyuan.menus.menu.append(new H({id:"expandSameLevelHeading",icon:"iconExpand",label:window.siyuan.languages.expandSameLevelHeading,accelerator:"\u2325"+window.siyuan.languages.clickArrow,click:()=>this.collapseSameLevel(t,!0)}).element),window.siyuan.menus.menu.append(new H({id:"foldSameLevelHeading",icon:"iconContract",label:window.siyuan.languages.foldSameLevelHeading,accelerator:"\u2325"+window.siyuan.languages.clickArrow,click:()=>this.collapseSameLevel(t,!1)}).element),window.siyuan.menus.menu.append(new H({id:"expandAll",icon:"iconExpand",label:window.siyuan.languages.expandAll,click:()=>{this.tree.expandAll(),this.saveExpendIds()}}).element),window.siyuan.menus.menu.append(new H({id:"foldAll",icon:"iconContract",label:window.siyuan.languages.foldAll,click:()=>{this.tree.collapseAll(),this.saveExpendIds()}}).element),window.siyuan.menus.menu.fullscreen("bottom")}getProtyleAndBlockElement(t){var n;const a=t.getAttribute("data-node-id");if(!((n=window.siyuan.mobile.editor)!=null&&n.protyle))return;const s=window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${a}"]`);if(s)return{protyle:window.siyuan.mobile.editor.protyle,blockElement:s}}genHeadingTransform(t,n){return{id:"heading"+n,iconHTML:"",icon:"iconHeading"+n,label:window.siyuan.languages["heading"+n],click:()=>{var a;const s=(a=window.siyuan.mobile.editor)==null?void 0:a.protyle;s&&L("/api/block/getHeadingLevelTransaction",{id:t,level:n},i=>{i.data.doOperations.forEach((o,l)=>{if(s.wysiwyg.element.querySelectorAll(`[data-node-id="${o.id}"]`).forEach(r=>{r.outerHTML=o.data}),s.wysiwyg.element.querySelectorAll(`[data-node-id="${o.id}"]`).forEach(r=>{jt(r)}),l===0){const r=s.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);r&&r.scrollIntoView({behavior:"smooth",block:"center"})}}),B(s,i.data.doOperations,i.data.undoOperations)})}}}}class Tb{constructor(t){this.beforeLen=10,this.element=document.querySelector('#sidebar [data-type="sidebar-backlink"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount"></span>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="toolbar">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount"></span>
    <span class="fn__space"></span>
    <svg data-type="mExpand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="mCollapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="layout" class="toolbar__icon"><use xlink:href="#iconDown"></use></svg>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.tree=new ks({element:this.element.querySelector(".backlinkList"),data:null,click(n){ft(t,n.getAttribute("data-node-id"),[p.CB_GET_HL,p.CB_GET_CONTEXT])}}),this.mTree=new ks({element:this.element.querySelector(".backlinkMList"),data:null,click:n=>{ft(t,n.getAttribute("data-node-id"),[p.CB_GET_HL,p.CB_GET_CONTEXT])}}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break;case"mExpand":this.mTree.expandAll();break;case"mCollapse":this.mTree.collapseAll();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")):a.getAttribute("aria-label")===window.siyuan.languages.down?(this.mTree.element.setAttribute("style","flex:none;height:0px"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")),a.setAttribute("data-clicked","true");break}a=a.parentElement}}),this.update()}update(){L("/api/ref/getBacklink",{id:window.siyuan.mobile.editor.protyle.block.id,beforeLen:this.beforeLen,k:"",mk:""},t=>{this.notebookId=t.data.box,this.tree.updateData(t.data.backlinks),this.mTree.updateData(t.data.backmentions);const n=this.element.querySelector(".listCount");t.data.linkRefsCount===0?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=t.data.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");t.data.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=t.data.mentionsCount.toString());const s=this.element.querySelector("[data-type='layout']");if(!s.getAttribute("data-clicked")){if(t.data.mentionsCount===0){this.mTree.element.setAttribute("style","flex:none;height:0px"),s.setAttribute("aria-label",window.siyuan.languages.up),s.querySelector("use").setAttribute("xlink:href","#iconUp");return}t.data.linkRefsCount===0?(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),s.setAttribute("aria-label",window.siyuan.languages.down),s.querySelector("use").setAttribute("xlink:href","#iconDown")):(this.mTree.element.removeAttribute("style"),s.setAttribute("aria-label",window.siyuan.languages.down),s.querySelector("use").setAttribute("xlink:href","#iconDown"))}})}}const Ib=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_BOOKMARK){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=e.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new H({id:"rename",icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const s=e.querySelector(".b3-list-item__text").textContent,i=new ke({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:P()?"92vw":"520px"});i.element.setAttribute("data-key",p.DIALOG_RENAMEBOOKMARK);const o=i.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{i.destroy()});const l=i.element.querySelector("input");i.bindInput(l,()=>{o[1].click()}),l.value=s,l.focus(),l.select(),o[1].addEventListener("click",()=>{L("/api/bookmark/renameBookmark",{oldBookmark:s,newBookmark:l.value},()=>{i.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new H({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:oi([e.getAttribute("data-node-id")],!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new H({id:"remove",icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const s=e.querySelector(".b3-list-item__text").textContent;Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${pe(s)}</b>`),()=>{a?(L("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{n.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(i=>{i.setAttribute("bookmark","");const o=i.querySelector(".protyle-attr--bookmark");o&&o.remove()})):L("/api/bookmark/removeBookmark",{bookmark:s})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_BOOKMARK),window.siyuan.menus.menu.popup({x:t.clientX-11,y:t.clientY+11,h:22,w:12})};class $b{constructor(t){this.element=document.querySelector('#sidebar [data-type="sidebar-bookmark"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="fn__flex-1 bookmarkList"></div>
<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new ks({element:this.element.querySelector(".bookmarkList"),data:null,click:(n,a)=>{const s=n.getAttribute("data-node-id");if(a){const i=C(a.target,"b3-list-item__action");if(i){Ib(i.parentElement,a,this);return}}Jn(s,i=>{ft(t,s,i?[p.CB_GET_HL,p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL])})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break}a=a.parentElement}}),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),L("/api/bookmark/getBookmark",{},t=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(t.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")})}}const Db=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")===p.MENU_TAG){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new H({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{Mr(n)}}).element),window.siyuan.menus.menu.append(new H({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${pe(n)}</b>?`,()=>{L("/api/tag/removeTag",{label:n},()=>{window.siyuan.mobile.docks.tag.update()})},void 0,!0)}}).element),window.siyuan.menus.menu.element.setAttribute("data-name",p.MENU_TAG),window.siyuan.menus.menu.popup({x:t.clientX-11,y:t.clientY+11,h:22,w:12})};class Mb{constructor(t){this.element=document.querySelector('#sidebar [data-type="sidebar-tag"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.tag}
    </div>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>
</div>
<div class="fn__flex-1 tagList"></div>
<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new ks({element:this.element.querySelector(".tagList"),data:null,click:(n,a)=>{const s=n.getAttribute("data-label");if(a){const i=C(a.target,"b3-list-item__action");if(i){Db(i.parentElement,a,s);return}}Kt(t,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${s}#`,r:"",page:1})},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll(),n.preventDefault(),n.stopPropagation();break;case"expand":this.tree.expandAll(),n.preventDefault(),n.stopPropagation();break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new H({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new H({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new H({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new H({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new H({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new H({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}}),this.update(!1)}update(t=!0){this.element.lastElementChild.classList.remove("fn__none"),L("/api/tag/getTag",{sort:window.siyuan.config.tag.sort,app:p.SIYUAN_APPID,ignoreMaxListHint:t},n=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(n.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")})}}var Hb=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Nb extends Ti{constructor(t,n){super({app:t,id:n.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},n instanceof Element?this.element=n:this.element=n.panelElement,this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.inbox}
        <span class="fn__space"></span>
        <span class="inboxSelectCount ft__smaller ft__on-surface"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <svg data-type="selectall" class="toolbar__icon"><use xlink:href="#iconUncheck"></use></svg>
    <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href='#iconLeft'></use></svg>
    <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href='#iconRight'></use></svg>
    <svg data-type="more" class="toolbar__icon"><use xlink:href='#iconMore'></use></svg>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto;background-color: var(--b3-theme-background)"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),s=this.element.querySelector(".inboxDetails"),i=this.element.firstElementChild.querySelector('[data-type="selectall"]');this.element.lastElementChild.addEventListener("contextmenu",o=>{const l=C(o.target,"b3-list-item");l&&this.more(o,l)}),this.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){o.stopPropagation();break}const r=l.getAttribute("data-type");if(r==="min"){getDockByType("inbox").toggleModel("inbox",!1,!0),o.preventDefault();break}else if(r==="selectall"){const d=l.querySelector("use");d.getAttribute("xlink:href")==="#iconUncheck"?(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("use").setAttribute("xlink:href","#iconCheck"),this.selectIds.push(c.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}),d.setAttribute("xlink:href","#iconCheck")):(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("use").setAttribute("xlink:href","#iconUncheck"),this.selectIds.splice(this.selectIds.indexOf(c.getAttribute("data-id")),1)}),d.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="select"){const d=l.querySelector("use");d.getAttribute("xlink:href")==="#iconUncheck"?(this.selectIds.push(l.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)],d.setAttribute("xlink:href","#iconCheck")):(this.selectIds.splice(this.selectIds.indexOf(l.parentElement.getAttribute("data-id")),1),d.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,i.querySelector("use").setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length?"#iconCheck":"#iconUncheck"),window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="previous"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),o.preventDefault();break}else if(r==="next"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),o.preventDefault();break}else if(r==="back"){this.back(),o.preventDefault();break}else if(r==="more"){this.more(o),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")){const d=this.data[l.getAttribute("data-id")];i.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),s.innerHTML=this.genDetail(d),s.setAttribute("data-id",d.oId),s.classList.remove("fn__none"),s.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),o.preventDefault();break}l=l.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector('[data-type="selectall"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(t){let n="";return t.shorthandURL&&(n=`<a href="${t.shorthandURL}" target="_blank">
        <svg class="toolbar__icon" style="float: left"><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="toolbar">
    <svg data-type="back" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
    <span data-type="back" class="toolbar__text fn__flex-1">${t.shorthandTitle}</span>
    ${n}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px">
${t.shorthandContent}
</div>`}genItemHTML(t){return`<li style="padding-left: 0" data-id="${t.oId}" class="b3-list-item">
    <span data-type="select" class="b3-list-item__action">
        <svg><use xlink:href="#icon${this.selectIds.includes(t.oId)?"Check":"Uncheck"}"></use></svg> 
    </span>
    <span class="fn__space--small"></span>
    <span class="b3-list-item__text" title="${t.shorthandTitle}${t.shorthandTitle===t.shorthandDesc?"":`
`+t.shorthandDesc}">${t.shorthandTitle}</span>
    <span class="b3-list-item__meta">${t.hCreated}</span>
</li>`}more(t,n){const a=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new H({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{n?L("/api/inbox/getShorthand",{id:n.dataset.id},i=>{this.data[i.data.oId]=i.data,n.outerHTML=this.genItemHTML(i.data)}):a.classList.contains("fn__none")?(this.currentPage=1,this.update()):L("/api/inbox/getShorthand",{id:a.getAttribute("data-id")},i=>{this.data[i.data.oId]=i.data,a.innerHTML=this.genDetail(i.data),a.scrollTop=0})}}).element);let s=[];n?s=[n.dataset.id]:a.classList.contains("fn__none")?s=this.selectIds:s=[a.getAttribute("data-id")],s.length>0&&(window.siyuan.menus.menu.append(new H({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(s)}}).element),window.siyuan.menus.menu.append(new H({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{let i="";s.forEach((o,l)=>{i+='<code class="fn__code">'+pe(this.data[o].shorthandTitle)+"</code>"+(l===s.length-1?"":", ")}),Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} ${i}?`,()=>{n?this.remove([n.dataset.id]):a.classList.contains("fn__none")?this.remove():this.remove([a.getAttribute("data-id")])},void 0,!0)}}).element)),this.app.plugins&&tn({plugins:this.app.plugins,type:"open-menu-inbox",detail:{ids:s,element:n||a},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:t.clientX,y:t.clientY+16})}remove(t){t||(t=this.selectIds),L("/api/inbox/removeShorthands",{ids:t},()=>{if(t){this.back();for(let n=this.selectIds.length-1;n>=0;n--)t.includes(this.selectIds[n])&&this.selectIds.splice(n,1)}else this.selectIds=[];this.currentPage=1,this.update()})}move(t){ca((n,a)=>Hb(this,null,function*(){for(let s=0;s<t.length;s++){const i=t[s],o=yield he("/api/inbox/getShorthand",{id:i});this.data[o.data.oId]=o.data;let l=o.data.shorthandMd;l===""&&o.data.shorthandContent===""&&o.data.shorthandURL!=""&&(l="["+o.data.shorthandTitle+"]("+o.data.shorthandURL+")"),yield he("/api/filetree/createDoc",{notebook:a[0],path:_e().join(vt(n[0],!1,!0),Lute.NewNodeID()+".sy"),title:gn(o.data.shorthandTitle),md:l,listDocTree:!0})}this.remove(t)}))}update(){const t=this.element.querySelector(".fn__loading");if(fa("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replaceAll("${accountServer}",Mt(""))}
    </li>
</ul>`,t.classList.add("fn__none");return}t.classList.contains("fn__none")&&(t.classList.remove("fn__none"),L("/api/inbox/getShorthands",{page:this.currentPage},n=>{t.classList.add("fn__none");let a="";n.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',n.data.data.shorthands.forEach(l=>{a+=this.genItemHTML(l),this.data[l.oId]=l}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=n.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const s=this.element.querySelector('[data-type="previous"]'),i=this.element.querySelector('[data-type="next"]');n.data.data.pagination.paginationPageCount>this.currentPage?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),this.currentPage===1?s.setAttribute("disabled","disabled"):s.removeAttribute("disabled");const o=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector('[data-type="selectall"] use').setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===o&&o!==0?"#iconCheck":"#iconUncheck"),this.element.lastElementChild.scrollTop=0}))}}let oa;const df=e=>{const t=new Fe(p.MENU_DOCK_MOBILE);t.isOpen||(e.plugins.forEach(n=>{Object.keys(n.docks).forEach(a=>{t.addItem({label:n.docks[a].config.title,icon:n.docks[a].config.icon,click(){(oa==null?void 0:oa.type)!==a&&(oa&&oa.destroy&&oa.destroy(),oa=n.docks[a].mobileModel(document.querySelector('#sidebar [data-type="sidebar-plugin"]')),window.siyuan.mobile.docks[a]=oa)}})})}),t.fullscreen(),t.element.lastElementChild.innerHTML===""&&se(window.siyuan.languages._kernel[122]))},Pb=(e,t)=>{Wi(),af(),yg();const n=document.getElementById("sidebar"),a=n.querySelector(".toolbar--border");if(a.addEventListener("click",s=>{const i=s.target;let o;if(typeof s.detail=="string"?o=a.querySelector(`svg[data-type="sidebar-${s.detail}-tab"]`):o=le(i,"svg"),!o)return;const l=o.getAttribute("data-type");if(o.classList.contains("toolbar__icon--active")){l==="sidebar-plugin-tab"&&df(e);return}if(!l){nt();return}a.querySelectorAll(".toolbar__icon").forEach(r=>{var d;const c=r.getAttribute("data-type");if(!c)return;const f=n.lastElementChild.querySelector(`[data-type="${c.replace("-tab","")}"]`);c===l?(l==="sidebar-outline-tab"?window.siyuan.mobile.docks.outline?L("/api/outline/getDocOutline",{id:window.siyuan.mobile.editor.protyle.block.rootID,preview:window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none")},m=>{window.siyuan.mobile.docks.outline.update(m)}):window.siyuan.mobile.docks.outline=new Cb({app:e,blockId:(d=window.siyuan.mobile.editor)==null?void 0:d.protyle.block.rootID,isPreview:window.siyuan.mobile.editor?!window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none"):!1}):l==="sidebar-backlink-tab"?window.siyuan.mobile.docks.backlink?window.siyuan.mobile.docks.backlink.update():window.siyuan.mobile.docks.backlink=new Tb(e):l==="sidebar-bookmark-tab"?window.siyuan.mobile.docks.bookmark?window.siyuan.mobile.docks.bookmark.update():window.siyuan.mobile.docks.bookmark=new $b(e):l==="sidebar-tag-tab"?window.siyuan.mobile.docks.tag?window.siyuan.mobile.docks.tag.update():window.siyuan.mobile.docks.tag=new Mb(e):l==="sidebar-inbox-tab"&&!window.siyuan.mobile.docks.inbox?window.siyuan.mobile.docks.inbox=new Nb(e,document.querySelector('#sidebar [data-type="sidebar-inbox"]')):l==="sidebar-plugin-tab"&&(oa?oa.update&&oa.update():(f.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,df(e))),o.classList.add("toolbar__icon--active"),f.classList.remove("fn__none")):(r.classList.remove("toolbar__icon--active"),f.classList.add("fn__none"))})}),window.siyuan.mobile.docks.file=new xb(e),document.getElementById("toolbarFile").addEventListener("click",()=>{mn(),n.style.transform="translateX(0px)";const s=n.querySelector(".toolbar--border .toolbar__icon--active").getAttribute("data-type");s==="sidebar-outline-tab"?L("/api/outline/getDocOutline",{id:window.siyuan.mobile.editor.protyle.block.rootID,preview:window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none")},i=>{window.siyuan.mobile.docks.outline.update(i)}):s==="sidebar-backlink-tab"?window.siyuan.mobile.docks.backlink.update():s==="sidebar-bookmark-tab"?window.siyuan.mobile.docks.bookmark.update():s==="sidebar-tag-tab"&&window.siyuan.mobile.docks.tag.update()}),document.getElementById("toolbarMore").addEventListener("click",()=>{Ja()}),document.getElementById("toolbarSync").addEventListener(xs(),()=>{rr(e)}),document.getElementById("modelClose").addEventListener("click",()=>{so()}),Ob(),Ms()>0){if(window.JSAndroid&&window.openFileByURL(window.JSAndroid.getBlockURL()))return;const s=hf();if(s.id){ft(e,s.id,s.isZoomIn?[p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL]);return}if(window.siyuan.config.fileTree.closeTabsOnStart&&t){Li(e);return}const i=window.siyuan.storage[p.LOCAL_DOCINFO];L("/api/block/checkBlockExist",{id:i.id},o=>{o.data?ft(e,i.id,[p.CB_GET_SCROLL]):L("/api/block/getRecentUpdatedBlocks",{},l=>{l.data.length!==0?Jn(l.data[0].id,r=>{ft(e,l.data[0].id,r?[p.CB_GET_ALL]:[p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL])}):Li(e)})});return}Li(e)},Ob=()=>{const e=document.getElementById("toolbarName");e.setAttribute("placeholder",window.siyuan.languages._kernel[16]),e.addEventListener("blur",()=>{if(e.getAttribute("readonly")!=="readonly"){if(!Zi(e.value))return e.value=e.value.substring(0,p.SIZE_TITLE),!1;L("/api/filetree/renameDoc",{notebook:window.siyuan.mobile.editor.protyle.notebookId,path:window.siyuan.mobile.editor.protyle.path,title:e.value}),xi(e.value)}})},qb=()=>{L("/api/system/getChangelog",{},e=>{if(!e.data.show)return;const t=new ke({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:P()?"92vw":"768px",height:P()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${e.data.html}</div>`});t.element.setAttribute("data-key",p.DIALOG_CHANGELOG),Re(t.element)})},Rb=(e,t={scope:"/",type:"classic",updateViaCache:"all"})=>{var n;(n=window.webkit)!=null&&n.messageHandlers||window.JSAndroid||window.JSHarmony||!("serviceWorker"in window.navigator)||!("caches"in window)||!("fetch"in window)||navigator.serviceWorker==null||window.navigator.serviceWorker.register(e,t).then(a=>{a.update()}).catch(a=>{console.debug(`Registration failed with ${a}`)})};var Bb=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});let Le,ei;const Ay=e=>{let t,n;document.addEventListener("mouseover",a=>{var s;if(!window.siyuan.config||!window.siyuan.menus||window.siyuan.dragElement||document.onmousemove){hideTooltip();return}const i=hasClosestByAttribute(a.target,"data-type","a",!0)||hasClosestByClassName(a.target,"ariaLabel")||hasClosestByAttribute(a.target,"data-type","tab-header")||hasClosestByAttribute(a.target,"data-type","inline-memo")||hasClosestByClassName(a.target,"av__calc--ashow")||hasClosestByClassName(a.target,"av__cell");if(i){let o="",l=i.getAttribute("aria-label")||"";if(i.classList.contains("av__cell")&&!i.classList.contains("ariaLabel"))if(i.classList.contains("av__cell--header")){const r=i.querySelector(".av__celltext"),d=i.getAttribute("data-desc");(r.scrollWidth>r.clientWidth+.5||d)&&(d?l=`${getCellText(i)}<div class='ft__on-surface'>${escapeAriaLabel(d)}</div>`:l=getCellText(i))}else((s=i.firstElementChild)==null?void 0:s.getAttribute("data-type"))==="url"&&i.firstElementChild.textContent.indexOf("...")>-1&&(l=Lute.EscapeHTMLStr(i.firstElementChild.getAttribute("data-href")),o="href"),l="",!l&&i.dataset.wrap!=="true"&&a.target.dataset.type!=="block-more"&&!hasClosestByClassName(a.target,"block__icon")&&(i.style.overflow="auto",i.scrollWidth>i.clientWidth+2&&(l=Lute.EscapeHTMLStr(getCellText(i))),i.style.overflow="");else if(i.parentElement.parentElement.classList.contains("av__views")&&i.parentElement.classList.contains("layout-tab-bar")){const r=i.querySelector(".item__text"),d=i.getAttribute("data-desc");(r.scrollWidth>r.clientWidth+.5||d)&&(d?l=`${r.textContent}<div class='ft__on-surface'>${escapeAriaLabel(d)}</div>`:l=r.textContent)}else if(i.classList.contains("av__celltext--url")){const r=i.getAttribute("data-name")||"";l=l?`<span style="word-break: break-all">${l.substring(0,Constants.SIZE_TITLE)}</span>${r?'<div class="fn__hr"></div><span>'+r+"</span>":""}`:r,o="href"}else if(i.classList.contains("av__calc--ashow")&&i.clientWidth+2<i.scrollWidth)l=i.lastChild.textContent+" "+i.firstElementChild.textContent;else if(i.getAttribute("data-type")==="setRelationCell"){const r=i.querySelector(".b3-menu__label");r&&r.clientWidth<r.scrollWidth&&(l=r.textContent)}if(l||(l=i.getAttribute("data-inline-memo-content"),l&&(o="memo")),!l){const r=i.getAttribute("data-href")||"";r&&(l=`<span style="word-break: break-all">${r.substring(0,Constants.SIZE_TITLE)}</span>`,o="href");const d=i.getAttribute("data-title");if(l&&isLocalPath(r)&&!i.classList.contains("b3-tooltips")){let c=l;fetchPost("/api/asset/statAsset",{path:r},f=>{f.code===1?d&&(c+='<div class="fn__hr"></div><span>'+d+"</span>"):c+=` ${f.data.hSize}${d?'<div class="fn__hr"></div><span>'+d+"</span>":""}<br>${window.siyuan.languages.modifiedAt} ${f.data.hUpdated}<br>${window.siyuan.languages.createdAt} ${f.data.hCreated}`,showTooltip(c,i,o)}),l=""}else d&&(l=(l?l+'<div class="fn__hr"></div>':"")+"<span>"+d+"</span>")}if(ei=hasClosestByClassName(a.target,"b3-list-item__text"),ei&&ei.parentElement.getAttribute("data-type")==="navigation-root"&&fetchPost("/api/notebook/getNotebookInfo",{notebook:ei.parentElement.parentElement.getAttribute("data-url")},r=>{const d=r.data.boxInfo,c=`${d.name} <small class='ft__on-surface'>${d.hSize}</small>${d.docCount!==0?window.siyuan.languages.includeSubFile.replace("x",d.docCount):""}<br>${window.siyuan.languages.modifiedAt} ${d.hMtime}<br>${window.siyuan.languages.createdAt} ${d.hCtime}`,f=hasClosestByClassName(a.target,"b3-list-item__text");ei&&f&&ei===f&&showTooltip(c,ei),f&&f.parentElement.getAttribute("data-type")==="navigation-root"&&f.parentElement.parentElement.getAttribute("data-url")===d.id&&f.setAttribute("aria-label",c)}),l&&!i.classList.contains("b3-tooltips")){try{showTooltip(decodeURIComponent(l),i,o)}catch(r){showTooltip(l,i,o)}a.stopPropagation()}else hideTooltip()}else if(!i){const o=hasClosestByAttribute(a.target,"id","tooltip",!0);(!o||o&&o.clientHeight>=o.scrollHeight&&o.clientWidth>=o.scrollWidth)&&hideTooltip()}if(window.siyuan.config.editor.floatWindowMode===1||window.siyuan.shiftIsPressed){if(clearTimeout(n),n=window.setTimeout(()=>{cf(a)},Constants.TIMEOUT_INPUT),!uf(a,i)||a.relatedTarget&&!document.contains(a.relatedTarget))return;window.siyuan.ctrlIsPressed?(clearTimeout(n),Ss(e)):window.siyuan.shiftIsPressed&&(clearTimeout(n),Ss(e,!0));return}clearTimeout(t),clearTimeout(n),n=window.setTimeout(()=>{cf(a)&&!Le&&!i&&clearTimeout(t)},Constants.TIMEOUT_INPUT),t=window.setTimeout(()=>{!uf(a,i)||isTouchDevice()||(clearTimeout(n),Ss(e))},620)})},cf=e=>{var t;const n=isTouchDevice()?document.elementFromPoint(e.clientX,e.clientY):e.target;if(!n||n.id&&n.tagName!=="svg"&&(n.id.startsWith("minder_node")||n.id.startsWith("kity_")||n.id.startsWith("node_"))||n.classList.contains("counter")||n.tagName==="circle")return!1;const a=hasClosestByClassName(n,"av__panel")||hasClosestByClassName(n,"av__mask");if(a){if(window.siyuan.blockPanels.find(o=>{if(o.element.style.zIndex<a.style.zIndex)return!0}))return!1}else{const i=hasClosestByClassName(n,"b3-menu");if(i&&i.getAttribute("data-name")!==Constants.MENU_DOC_TREE_MORE&&window.siyuan.blockPanels.find(l=>{if(l.element.style.zIndex<i.style.zIndex)return!0}))return!1}Le=hasClosestByAttribute(n,"data-type","block-ref")||hasClosestByAttribute(n,"data-type","virtual-block-ref"),Le&&Le.classList.contains("b3-tooltips")&&(Le=void 0),Le||(Le=hasClosestByClassName(n,"popover__block"));const s=hasClosestByAttribute(n,"data-type","a",!0);if(!Le&&s&&((t=s.getAttribute("data-href"))!=null&&t.startsWith("siyuan://blocks"))&&(Le=s),!Le||Le&&window.siyuan.menus.menu.data&&window.siyuan.menus.menu.data===Le){let i=n;!i.parentElement&&e.path&&e.path[1]&&(i=e.path[1]);const o=hasClosestByClassName(i,"block__popover",!0),l={oid:0};window.siyuan.blockPanels.forEach(d=>{if((d.targetElement||typeof d.x=="number")&&d.element.getAttribute("data-pin")==="true"){const c=parseInt(d.element.getAttribute("data-level")),f=d.element.getAttribute("data-oid");l[f]?c>l[f]&&(l[f]=c):l[f]=c}});const r=parseInt(window.siyuan.menus.menu.element.dataset.from);if(o)for(let d=window.siyuan.blockPanels.length-1;d>=0;d--){const c=window.siyuan.blockPanels[d],f=parseInt(c.element.getAttribute("data-level"));if((c.targetElement||typeof c.x=="number")&&f>(l[c.element.getAttribute("data-oid")]||0)&&c.element.getAttribute("data-pin")==="false"&&f>parseInt(o.getAttribute("data-level"))){if(r&&r>=f)break;if(c.editors.find(u=>{if(!u.protyle.toolbar.subElement.classList.contains("fn__none"))return!0}))break;c.destroy()}}else for(let d=window.siyuan.blockPanels.length-1;d>=0;d--){const c=window.siyuan.blockPanels[d],f=parseInt(c.element.getAttribute("data-level"));if((c.targetElement||typeof c.x=="number")&&c.element.getAttribute("data-pin")==="false"){if(r&&r>=f)break;if(c.targetElement&&c.targetElement.classList.contains("protyle-wysiwyg__embed")&&c.targetElement.contains(i))break;if(c.editors.find(u=>{if(!u.protyle.toolbar.subElement.classList.contains("fn__none"))return!0}))break;c.destroy()}}}},uf=(e,t)=>{var n,a;if(window.siyuan.config.editor.floatWindowMode===2||hasClosestByClassName(e.target,"history__repo",!0))return!1;if(Le=hasClosestByAttribute(e.target,"data-type","block-ref")||hasClosestByAttribute(e.target,"data-type","virtual-block-ref"),Le&&Le.classList.contains("b3-tooltips")&&(Le=void 0),Le||(Le=hasClosestByClassName(e.target,"popover__block")),!Le&&t){if((n=t.getAttribute("data-href"))!=null&&n.startsWith("siyuan://blocks")&&t.getAttribute("prevent-popover")!=="true")Le=t;else if(t.classList.contains("av__cell")){const s=t.querySelector(".av__celltext--url");s&&s.dataset.type==="url"&&((a=s.dataset.href)!=null&&a.startsWith("siyuan://blocks"))&&(Le=s)}}if(!Le||window.siyuan.altIsPressed||window.siyuan.config.editor.floatWindowMode===0&&window.siyuan.ctrlIsPressed||Le&&Le.getAttribute("prevent-popover")==="true")return!1;if(Le&&getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);if(s.toString()!==""&&Le.contains(s.startContainer))return!1}return!0},Ss=(e,t=!1)=>Bb(void 0,null,function*(){var n,a;if(!Le||window.siyuan.menus.menu.data&&window.siyuan.menus.menu.data===Le)return;let s=[],i;const o=Le.getAttribute("data-id");if(o)if(t){const r=yield he("/api/block/getRefIDs",{id:o});s=r.data.refDefs,i=r.data.originalRefBlockIDs}else o.startsWith("[")?JSON.parse(o).forEach(r=>{s.push({refID:r})}):s=[{refID:o}];else if(((n=Le.getAttribute("data-type"))==null?void 0:n.indexOf("virtual-block-ref"))>-1){const r=F(Le);r&&(s=(yield he("/api/block/getBlockDefIDsByRefText",{anchor:Le.textContent,excludeIDs:[r.getAttribute("data-node-id")]})).data.refDefs)}else if((a=Le.getAttribute("data-type"))!=null&&a.split(" ").includes("a"))s=[{refID:Ds(Le.getAttribute("data-href"))}];else if(Le.dataset.type==="url")s=[{refID:Ds(Le.textContent.trim())}];else if(Le.dataset.popoverUrl)s=(yield he(Le.dataset.popoverUrl,{avID:Le.dataset.avId})).data.refDefs;else{let r,d="/api/block/getRefIDs";if(Le.classList.contains("protyle-attr--refcount"))r=Le.parentElement.parentElement.getAttribute("data-node-id");else if(Le.classList.contains("pdf__rect")){const c=Le.getAttribute("data-relations");c?(c.split(",").forEach(f=>{s.push({refID:f})}),d=""):(r=Le.getAttribute("data-node-id"),d="/api/block/getRefIDsByFileAnnotationID")}else r||(r=Le.parentElement.getAttribute("data-node-id"));if(d){const c=yield he(d,{id:r});s=c.data.refDefs,i=c.data.originalRefBlockIDs}}if(s.length===0)return;let l=!1;window.siyuan.blockPanels.find(r=>{if((r.targetElement||typeof r.x=="number")&&r.element.getAttribute("data-pin")==="true"&&JSON.stringify(s)===JSON.stringify(r.refDefs))return l=!0,!0}),!l&&Le.parentElement&&Le.parentElement.style.opacity!=="0.38"&&window.siyuan.blockPanels.push(new $u({app:e,targetElement:Le,isBacklink:t||Le.classList.contains("protyle-attr--refcount")||Le.classList.contains("counter"),refDefs:s,originalRefBlockIDs:i}))}),$i=(e,t,n)=>{if(t==="general"){if(!window.siyuan.config.keymap[t])return window.siyuan.config.keymap[t]=e,!1}else{if(!window.siyuan.config.keymap[t])return window.siyuan.config.keymap[t]=JSON.parse(JSON.stringify(p.SIYUAN_KEYMAP.editor)),!1;if(!window.siyuan.config.keymap[t][n])return window.siyuan.config.keymap[t][n]=e,!1}let a=!0;return Object.keys(e).forEach(s=>{t==="general"?(!window.siyuan.config.keymap[t][s]||window.siyuan.config.keymap[t][s].default!==e[s].default)&&(a=!1,window.siyuan.config.keymap[t][s]=e[s]):(!window.siyuan.config.keymap[t][n][s]||window.siyuan.config.keymap[t][n][s].default!==e[s].default)&&(a=!1,window.siyuan.config.keymap[t][n][s]=e[s])}),a},Di=(e,t,n)=>{let a=!0;return t==="editor"?Object.keys(window.siyuan.config.keymap[t][n]).length!==Object.keys(p.SIYUAN_KEYMAP[t][n]).length&&Object.keys(window.siyuan.config.keymap[t][n]).forEach(s=>{p.SIYUAN_KEYMAP[t][n][s]||(a=!1,delete window.siyuan.config.keymap[t][n][s])}):Object.keys(window.siyuan.config.keymap[t]).length!==Object.keys(p.SIYUAN_KEYMAP[t]).length&&Object.keys(window.siyuan.config.keymap[t]).forEach(s=>{p.SIYUAN_KEYMAP[t][s]||(a=!1,delete window.siyuan.config.keymap[t][s])}),a},Ub=e=>{const t=$i(p.SIYUAN_KEYMAP.general,"general"),n=$i(p.SIYUAN_KEYMAP.editor.general,"editor","general"),a=$i(p.SIYUAN_KEYMAP.editor.insert,"editor","insert"),s=$i(p.SIYUAN_KEYMAP.editor.heading,"editor","heading"),i=$i(p.SIYUAN_KEYMAP.editor.list,"editor","list"),o=$i(p.SIYUAN_KEYMAP.editor.table,"editor","table"),l=Di(p.SIYUAN_KEYMAP.general,"general"),r=Di(p.SIYUAN_KEYMAP.editor.general,"editor","general"),d=Di(p.SIYUAN_KEYMAP.editor.insert,"editor","insert"),c=Di(p.SIYUAN_KEYMAP.editor.heading,"editor","heading"),f=Di(p.SIYUAN_KEYMAP.editor.list,"editor","list"),m=Di(p.SIYUAN_KEYMAP.editor.table,"editor","table");!window.siyuan.config.readonly&&(!t||!n||!a||!s||!i||!o||!l||!r||!d||!c||!f||!m)&&L("/api/setting/setKeymap",{data:window.siyuan.config.keymap},()=>{})},Fb=(e,t)=>{if(document.getElementById("progress")||document.getElementById("errorLog")||e.isComposing)return!0;const n=e.target;if(e.isTrusted&&Ze(e)&&!e.shiftKey&&!e.altKey&&!["INPUT","TEXTAREA"].includes(n.tagName)&&["0","1","2","3","4","j","k","l",";","s"," ","p","enter","a","s","d","f","q","x"].includes(e.key.toLowerCase())){let a;if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===p.DIALOG_OPENCARD)return a=s.element,!0}),a||(a=document.querySelector(`.layout__wnd--active div[data-key="${p.DIALOG_OPENCARD}"]:not(.fn__none)`)),a)return e.preventDefault(),a.firstElementChild.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()})),!0}if(Ze(e)&&e.key!=="Escape"&&!e.shiftKey&&!e.altKey&&p.KEYCODELIST[e.keyCode]!=="PageUp"&&p.KEYCODELIST[e.keyCode]!=="PageDown"&&e.key!=="Home"&&e.key!=="End"&&!/^F\d{1,2}$/.test(e.key)&&e.key.indexOf("Arrow")===-1&&e.key!=="Enter"&&e.key!=="Backspace"&&e.key!=="Delete")return!0;!e.altKey&&!e.shiftKey&&Lt(e)&&(($t()?e.key==="Meta":e.key==="Control")||Lt(e)?(window.siyuan.ctrlIsPressed=!0,(e.key==="Meta"||e.key==="Control")&&window.siyuan.config.editor.floatWindowMode===1&&!e.repeat&&Ss(t)):window.siyuan.ctrlIsPressed=!1),!e.altKey&&e.shiftKey&&Ze(e)&&(e.key==="Shift"?(window.siyuan.shiftIsPressed=!0,e.repeat||Ss(t,!0)):window.siyuan.shiftIsPressed=!1),e.altKey&&!e.shiftKey&&Ze(e)&&(e.key==="Alt"?window.siyuan.altIsPressed=!0:window.siyuan.altIsPressed=!1)},Yb=(e,t)=>{if(!t.key||Fb(t,e))return;const n=Ft().protyle;if(Object.keys(window.siyuan.config.keymap.general).find(i=>{if(ne(window.siyuan.config.keymap.general[i].custom,t))return pr({command:i,app:e,protyle:n,previousRange:n.toolbar.range}),!0})){t.preventDefault();return}let s=!1;if(e.plugins.find(i=>{if(i.commands.find(o=>{if(o.callback&&!o.fileTreeCallback&&!o.editorCallback&&!o.dockCallback&&!o.globalCallback&&ne(o.customHotkey,t))return s=!0,o.callback(),!0}),s)return!0}),s)return t.preventDefault(),!0};var Wb=(e,t,n)=>new Promise((a,s)=>{var i=r=>{try{l(n.next(r))}catch(d){s(d)}},o=r=>{try{l(n.throw(r))}catch(d){s(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(i,o);l((n=n.apply(e,t)).next())});class Vb{constructor(){this.plugins=[],Rb(`${p.SERVICE_WORKER_PATH}?v=${p.SIYUAN_VERSION}`),kf(),this.appId=p.SIYUAN_APPID,window.siyuan={zIndex:10,notebooks:[],transactions:[],reqIds:{},backStack:[],dialogs:[],blockPanels:[],mobile:{docks:{outline:null,file:null,bookmark:null,tag:null,backlink:null,inbox:null}},ws:new Ti({app:this,id:Zn(),type:"main",msgCallback:t=>{this.plugins.forEach(n=>{n.eventBus.emit("ws-main",t)}),hb(this,t)}})},window.addEventListener("click",t=>{!window.siyuan.menus.menu.element.contains(t.target)&&!O(t.target,"data-menu","true")&&window.siyuan.menus.menu.remove();const n=ue(t.target,"protyle-action__copy");if(n){let a=n.parentElement.nextElementSibling.textContent.trimEnd();a=a.replace(/\u00A0/g," "),He(a),se(window.siyuan.languages.copied,2e3),t.preventDefault()}}),window.addEventListener("beforeunload",()=>{Ei(window.siyuan.mobile.editor.protyle)},!1),window.addEventListener("pagehide",()=>{Ei(window.siyuan.mobile.editor.protyle)},!1),window.matchMedia("(orientation:portrait)").addEventListener("change",()=>{Su()}),L("/api/system/getConf",{},t=>Wb(this,null,function*(){mt(`${p.PROTYLE_CDN}/js/lute/lute.min.js?v=${p.SIYUAN_VERSION}`,"protyleLuteScript"),Ke(`${p.PROTYLE_CDN}/js/protyle-html.js?v=${p.SIYUAN_VERSION}`,"protyleWcHtmlScript"),window.siyuan.config=t.data.conf,$r(),window.siyuan.isPublish=t.data.isPublish,Ub(Cl),yield Ku(this),xr(()=>{ou(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${p.SIYUAN_VERSION}`,n=>{window.siyuan.languages=n,window.siyuan.menus=new vb(this),document.title=window.siyuan.languages.siyuanNote,rm(),Pr(t.data.conf.appearance),bf(),If(),L("/api/setting/getCloudUser",{},a=>{window.siyuan.user=a.data,L("/api/system/getEmojiConf",{},s=>{window.siyuan.emojis=s.data,ua(()=>{Pb(this,t.data.start),pb(this),qb()})})})})}),document.addEventListener("touchstart",Ab,!1),document.addEventListener("touchmove",Lb,!1),document.addEventListener("touchend",n=>{Sb(n,Cl)},!1),window.addEventListener("keyup",()=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1}),window.addEventListener("keydown",n=>{if(Yb(Cl,n),getSelection().rangeCount>0){const a=getSelection().getRangeAt(0),s=Ft();if(a.toString()===""&&s&&s.protyle.wysiwyg.element.contains(a.startContainer)&&!n.altKey&&(n.key==="Backspace"||n.key==="Delete")){const i=F(a.startContainer);if(i&&It(i)){i.classList.add("protyle-wysiwyg--select"),bn(s.protyle,i,a,n.key),n.stopPropagation(),n.preventDefault();return}}}})}))}}const Cl=new Vb;window.reconnectWebSocket=()=>{var e;window.siyuan.ws.send("ping",{}),window.siyuan.mobile.docks.file.send("ping",{}),window.siyuan.mobile.editor.protyle.ws.send("ping",{}),(e=window.siyuan.mobile.popEditor)==null||e.protyle.ws.send("ping",{})},window.goBack=_g,window.showMessage=se,window.processIOSPurchaseResponse=nb,window.showKeyboardToolbar=e=>{document.getElementById("keyboardToolbar").setAttribute("data-keyboardheight",(e||window.outerHeight/2-42).toString()),Nd()},window.hideKeyboardToolbar=Ys,window.openFileByURL=e=>e&&vf(e)?(ft(Cl,Ds(e),bt("focus",e)==="1"?[p.CB_GET_ALL]:[p.CB_GET_HL,p.CB_GET_CONTEXT,p.CB_GET_ROOTSCROLL]),!0):!1})()})();})();
